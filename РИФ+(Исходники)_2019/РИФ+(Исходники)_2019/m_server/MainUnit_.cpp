//---------------------------------------------------------------------------
#include <vcl.h>
#include <dateutils.hpp>
#include <IniFiles.hpp>
#include <SHFolder.h>
#include <winsock.h>
#include <memory>
#include <dir.h>                                                
#include <assert.h>
#include <mmsystem.h>
#include <mysql.h>
#include <errmsg.h>
#include <stdio.h>
#include <tlhelp32.h>
#pragma hdrstop

#include "MainUnit_.h"
#include "MyApiUnit.h"
#include "AboutDlgUnit.h"
#include "TAdmAuditUnit.h"
#include "WriteFormUnit.h"
#include "RestoreDlgUnit.h"
#include "EseU485IOUnit.h"
#include "usb_uart.h"
#include "MyappErrcode.h"
#include "MsgFormUnit.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "CGAUGES"
#pragma link "frxClass"
#pragma link "frxDBSet"
#pragma link "AdvGrid"
#pragma link "BaseGrid"
#pragma link "CSPIN"
#pragma resource "*.dfm"
#pragma warn -aus
#pragma warn -lvc
TMainForm *MainForm;
#define BazaltCnt 280 
#define BazaltCnt2 1200
#define BazaltCnt3 470 
#define MaxRifBazaltCnt 500 
//---------------------------------------------------------------------------
MYSQL *Con;
MYSQL_RES *Result;
MYSQL_ROW row;
MYSQL_FIELD *field;
//---------------------------------------------------------------------------
__fastcall TMainForm::TMainForm(TComponent* Owner)
   : TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::FormCreate(TObject *Sender)
{
   VersionInfoStr = "r.05.12.2019";

   AnsiString str;

   DemoMode = false;
   str = UpperCase(ParamStr(1));
   if( str.Pos("DEMO") > 0 ) DemoMode = true;

   MainMenu1->OwnerDraw=true;
   PopupMenu1->OwnerDraw=true;
   Screen->MenuFont->Name="Microsoft Sans Serif";
   Screen->MenuFont->Charset=DEFAULT_CHARSET;
 
   AdvStringGrid1->WordWrap = false;
   AdvStringGrid1->Multilinecells = true;
   AdvStringGrid1->DoubleBuffered = true;

   Server2->Active = false;
   iServer->Active = false;

   SsoiAutoDkUse = false;

   UseAsoosd = false;
   AsoosdClientSocket->Active = UseAsoosd;

   ComplexVersion = RifxComplexType;
   GobiFixNewWarning = 0;

   AutoStart = 0;

   MainFormY = MainForm->Top + 50;

   try
   {
      if( !FileExists(ExtractFilePath(Application->ExeName)+"lang1.ini") ) SaveLangConfig(ExtractFilePath(Application->ExeName)+"lang1.ini");
      LoadLangConfig(ExtractFilePath(Application->ExeName)+"lang1.ini");

      std::auto_ptr<TReadForm> pfrm(new TReadForm(this));
      pfrm->Caption = pfrm_Caption;
      pfrm->Label1->Caption = pfrm_Label1_Caption;
      pfrm->Update();

      ActiveOprosChannels = 0;
      RifSys = new TRifSys;
      Rif2Sys = new TRif2Sys;
      GobiSys = new TGobiSys;
      GobiSys2 = new TGobiSys2;
      RastrSys = new TRastrSys;
      SolidSys = new TSolidSys;
      SolidSys->ResetTv();
      A4068Sys = new TAdam4068Sys;
      A4068Sys->ResetDev();
      TabloSys = new TTabloSys;
      TabloSys->Reset();
      STN1 = false;
      GobiTv = false;
      Stn485Tv = false;

      UdpAdress = new TStringList;
      UdpAdress->Clear();

      OprosDate = Now();
      OprosDate = (int)OprosDate;

      SoundType = -1;
      SoundStop = false;

      for( int kan = 0; kan < RifKanCnt; kan++)
      {
         RifTimerInterval[kan] = 50;
         RifScnt[kan] = 0;
      }
      SsoiScnt = 0;
      S3cnt = 0;
      S4cnt = 0;
      S7cnt = 0;
      for(int kan = 0; kan < KanCnt; kan++ ) SsoiMScnt[kan] = 0;

      AlarmFlag = false;
      SoundFlag = 0;

      DiagRif = new TDiagRif;
      DiagRif->Adr = 0;
      DiagRif->Port = 1;
      DiagRif->Reset();

      DiagKonc = new TDiagKonc;
      DiagKonc->Adr = 0;
      DiagKonc->Port = 1;
      DiagKonc->Reset();

      iNetSys = new TiNetSys;

      r485NetSys = new TiNetSys;

      for( int i = 0; i < MonCnt; i++ ) { TvAutoNum[i] = -1; TvAutoCnt[i] = 0; }
      CurMon = 0;
      Monitor = -1;
      Camera = -1;
      TvHand = false;

      for( int cam = 0; cam < 200; cam++ )
      {
         ShowDevLineCam[cam] = false;
         ZeroMemory ( &se1[cam], sizeof (se1[cam]) );
      }

      Adr4068 = 0;

      I1Img = new Graphics::TBitmap;
      I1Img->Transparent = true;
      I2Img = new Graphics::TBitmap;
      I2Img->Transparent = true;
      I3Img = new Graphics::TBitmap;
      I3Img->Transparent = true;
      I4Img = new Graphics::TBitmap;
      I4Img->Transparent = true;
      I5Img = new Graphics::TBitmap;
      I5Img->Transparent = true;
      I6Img = new Graphics::TBitmap;
      I6Img->Transparent = true;
      I7Img = new Graphics::TBitmap;
      I7Img->Transparent = true;
      I8Img = new Graphics::TBitmap;
      I8Img->Transparent = true;
      I9Img = new Graphics::TBitmap;
      I9Img->Transparent = true;

      ImageList2->GetBitmap(0,I1Img);
      ImageList2->GetBitmap(1,I2Img);
      ImageList2->GetBitmap(2,I3Img);
      ImageList2->GetBitmap(3,I4Img);
      ImageList2->GetBitmap(4,I5Img);
      ImageList2->GetBitmap(5,I6Img);
      ImageList2->GetBitmap(6,I7Img);
      ImageList2->GetBitmap(7,I8Img);
      ImageList2->GetBitmap(8,I9Img);

      WImg = new Graphics::TBitmap;
      WImg->Transparent = true;
      AImg = new Graphics::TBitmap;
      AImg->Transparent = true;
      NImg = new Graphics::TBitmap;
      NImg->Transparent = true;
      PImg = new Graphics::TBitmap;
      PImg->Transparent = true;
      HImg = new Graphics::TBitmap;
      HImg->Transparent = true;
      OImg = new Graphics::TBitmap;
      OImg->Transparent = true;
      ImageList1->GetBitmap(18,WImg);
      ImageList1->GetBitmap(19,AImg);
      ImageList1->GetBitmap(17,NImg);
      ImageList1->GetBitmap(20,PImg);
      ImageList1->GetBitmap(21,HImg);
      ImageList1->GetBitmap(22,OImg);

      MainFormLeft = -5;
      MainFormTop = -5;
      MainFormWidth = 0;
      MainFormHeight = 0;

      OpList = new TSysOperatorList();

      if( !FileExists(ExtractFilePath(Application->ExeName)+"rifx.ini") ||
          !LoadGlobalConfig(ExtractFilePath(Application->ExeName)+"rifx.ini") )
      {
         MessageBox (NULL, MsgStr1.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
         Application->Terminate();
         return;
      }

      if( OpList->Use )
      {
          if( OpList->OpCnt <= 0 )
          {
             MessageBox (NULL, MsgStr7.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
             Application->Terminate();
             return;             
          }
          else
          {

             OperatorsDlg = new TOperatorsDlg(this);
             OperatorsDlg->ShowModal();
             delete OperatorsDlg;
          }
      }

      if( OpList->Use && OpFn.Length() == 0 )
      {
         MessageBox (NULL, MsgStr10.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
         Application->Terminate();
         return;
      }
      else
      {

            for( int kan = 0; kan < RifKanCnt; kan++ ) RifIdx[kan] = -1;
            for( int kan = 0; kan < KanCnt; kan++ ) SsoiMIdx[kan] = 0;

            AppDataPath = ExtractFilePath(Application->ExeName) + "AppData\\";
            SoundFilePath = ExtractFilePath(Application->ExeName) + "Icons\\alarm.wav";
            SoundFilePath2 = ExtractFilePath(Application->ExeName) + "Icons\\ringin.wav";
            SoundFilePath3 = ExtractFilePath(Application->ExeName) + "Icons\\alarm2.wav";

            if( !SetCatalog(AppDataPath) )
            {
               MessageBox (NULL,MsgStr3.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
               Application->Terminate();
               return;
            }

            CommentList = new TStringList;
            CommentList2 = new TStringList;

            try
            {
               CommentList->LoadFromFile(ExtractFilePath(Application->ExeName)+"comment.lst");
               CommentList->Sort();
               ComboBox3->Items->Clear();
               for( int i = 0; i < CommentList->Count; i++ )
               {
                  ComboBox3->Items->Add(CommentList->Strings[i]);
               }
            }
            catch(...)
            {
               ;
            }

            try
            {
               CommentList2->LoadFromFile(ExtractFilePath(Application->ExeName)+"comment2.lst");
               CommentList2->Sort();
               ComboBox4->Items->Clear();
               for( int i = 0; i < CommentList2->Count; i++ )
               {
                  ComboBox4->Items->Add(CommentList2->Strings[i]);
               }
            }
            catch(...)
            {
               ;
            }

            try
            {
               Table1->Active = false;
               if( SetTbl1() ) Table1->Active = true;
               else
               {
                  MessageBox (NULL, MsgStr4.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                  Application->Terminate();
                  return;
               }
               Table1->Active = false;
               Table1->Active = true;
            }
            catch(...)
            {
               MessageBox (NULL, MsgStr4.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
               Table1->Active = false;
               Table1->DeleteTable();
               if( SetTbl1() ) Table1->Active = true;
               else
               {
                  MessageBox (NULL, MsgStr4.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                  Application->Terminate();
                  return;
               }
            }

            events_num = 0;
            if( MySQL_use == 1 )
            {
               if( MySQL_dbname == "" )
               {
                  ShowMessage(InfoStr34);
                  Application->Terminate();
                  return;
               }
               else if( MySQL_host == "" )
               {
                  ShowMessage(InfoStr35);
                  Application->Terminate();
                  return;
               }
               else if( MySQL_login == "" )
               {
                  ShowMessage(InfoStr36);
                  Application->Terminate();
                  return;
               }
               else if( MySQL_password == "" )
               {
                  ShowMessage(InfoStr37);
                  Application->Terminate();
                  return;
               }
               else
               {
                    AnsiString err_str;
                    Con = mysql_init(NULL);
                    mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                    int errcode = mysql_errno(Con);
                    if( errcode != 0 && errcode != CR_ALREADY_CONNECTED )
                    {
                       MySQL_use = -1;
                       err_str.sprintf("%s!\n %s:%d\n %s:%s", InfoStr2, InfoStr3, errcode, InfoStr4, mysql_error(Con));
                       ShowMessage(err_str);
                       Application->Terminate();
                       return;
                    }
                    else
                    {
                      AnsiString query;
                      query.sprintf("SELECT * FROM %s.events WHERE event_num=0", MySQL_dbname);
                      mysql_real_query(Con,query.c_str(),query.Length());
                      Result = mysql_store_result(Con);

                      AnsiString fieldname_str[100];
                      int field_type[100];
                      int field_num = 0;
                      do
                      {
                         field = mysql_fetch_field(Result);
                         if( field != NULL )
                         {
                           fieldname_str[field_num] = field->name;
                           field_type[field_num] = field->type;
                           field_num++;
                         }
                      }
                      while(field != NULL);

                      if( field_num != 18 )
                      {
                         MessageBox (NULL, "Ошибка структуры базы данных! Возможно используется база данных предыдущей версии. Необходимо в программе \"Настройка комплекса\" удалить старую базу и создать новую.",ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                         Application->Terminate();
                         return;
                      }

                      bool field_ok = true;
                      AnsiString fieldname_str_ok[18] = {"event_num", "event_dt", "event_code", "event_name", "dev_type",
                                                         "dev_num1", "dev_num2", "dev_num3", "dev_name", "comment1", "comment2",
                                                         "local_operator_fn", "local_operator_n1", "local_operator_n2",
                                                         "client_operator_fn","client_operator_n1", "client_operator_n2",
                                                         "out_dev_type" };
                      int field_type_ok[18] = {3,12,3,253,3,3,3,3,253,253,253,253,253,253,253,253,253,3};

                      for( int fnum = 0; fnum < field_num; fnum++ )
                      {
                         if(fieldname_str[fnum] != fieldname_str_ok[fnum] || field_type[fnum] != field_type_ok[fnum] )
                         {
                           field_ok = false;
                           break;
                         }
                      }

                      if( !field_ok )
                      {
                         MessageBox (NULL, "Ошибка структуры базы данных! Возможно используется база данных предыдущей версии. Необходимо в программе \"Настройка комплекса\" удалить старую базу и создать новую.",ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                         Application->Terminate();
                         return;
                      }

                      query.sprintf("SELECT MAX(event_num) FROM %s.events", MySQL_dbname);
                      mysql_real_query(Con,query.c_str(),query.Length());
                      Result = mysql_store_result(Con);

                      unsigned int num_rows;
                      num_rows = mysql_num_rows(Result);
                      if( num_rows == 0 )
                      {
                         events_num = 0;
                      }
                      else
                      {
                         for( unsigned int i = 0; i < num_rows; i++)
                         {
                            row = mysql_fetch_row(Result);

                            if( row[0] != NULL ) events_num = AnsiString(row[0]).ToInt();
                            else events_num = 0;
                         }
                         events_num = events_num + 1;
                      }
                   }
               }
            }

            for( int i = 0; i < 4; i++ )
            {
               cam1[i] = -1;
               cam2[i] = -1;
            }
            for( int i = 0; i < 18; i++ ) cam485[i] = 0;
            for( int i = 0; i < 6; i++ ) cam485_sn[i] = "";

            if( Server2Use || iServerUse )
            {
               WORD wVersionRequested;
               WSADATA WSAData;
               wVersionRequested = MAKEWORD(1,1);

               try
               {
                  if( WSAStartup(wVersionRequested, &WSAData) )
                  {
                     Server2Use = false;
                     iServerUse = false;
                     MessageBox (NULL,MsgStr5.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
                  }
                  else
                  {
                     hostent *P;
                     char s[128];
                     in_addr in;
                     char *P2;
                     gethostname(s,128);
                     P=gethostbyname(s);
                     Server2Name = P->h_name;
                     iServerHost = P->h_name;
                     in.S_un.S_un_b.s_b1 = P->h_addr_list[0][0];
                     in.S_un.S_un_b.s_b2 = P->h_addr_list[0][1];
                     in.S_un.S_un_b.s_b3 = P->h_addr_list[0][2];
                     in.S_un.S_un_b.s_b4 = P->h_addr_list[0][3];
                     P2 = inet_ntoa(in);

                     Server2->Port = Server2Port;
                     if( Server2Use )
                     {
                        Server2->Active = true;
                        KeepAliveTimer->Enabled = true;
                     }

                     iServer->Port = iServerPort;
                     if( iServerUse )
                     {
                        iServer->Active = true;
                        TreeAndStates = new TStringList();
                        EventsAndStates = new TStringList();
                        KeepAliveTimer->Enabled = true;
                     }
                  }

                  WSACleanup();
               }
               catch(...)
               {
                  Server2Use = false;
                  iServerUse = false;
                  MessageBox (NULL,MsgStr5.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
               }
            }

            AnsiString fn111 = ExtractFileName(Application->ExeName);
            AnsiString fn112 = ExtractFileName(Application->ExeName);
            AnsiString tmps111, tmps112;
            tmps111.sprintf("%s.gs1", fn111);
            tmps112.sprintf("%s.gs2", fn112);
            fn111 = ExtractFilePath(Application->ExeName) + tmps111;
            fn112 = ExtractFilePath(Application->ExeName) + tmps112;
            int gyear1, gmonth1, gday1, ghour1, gmin1, gec1;
            int gyear2, gmonth2, gday2, ghour2, gmin2, gec2;
            TDateTime gdt1, gdt2;
            int grez1 = GoodCloseOpen(fn111, gyear1, gmonth1, gday1, ghour1, gmin1, gec1);
            int grez2 = GoodCloseOpen(fn112, gyear2, gmonth2, gday2, ghour2, gmin2, gec2);

            if( grez1 == 0 && grez2 == 0 ) ;      
            else if( grez1 == 1 || grez2 == 1  ) ; 
            else if( grez1 == -1 && grez2 == -1  ) 
            {
               gdt1 = EncodeDate(gyear1, gmonth1, gday1) + EncodeTime(ghour1, gmin1, gec1, 0);

               gdt2 = EncodeDate(gyear2, gmonth2, gday2) + EncodeTime(ghour2, gmin2, gec2, 0);

               if( gdt1 > gdt2 ) SetSob1( 904, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0, gdt1 );
               else SetSob1( 904, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0, gdt2 );

            }
            else if( grez1 == -1 && grez2 != -1  ) 
            {
               gdt1 = EncodeDate(gyear1, gmonth1, gday1) + EncodeTime(ghour1, gmin1, gec1, 0);
               SetSob1( 904, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0, gdt1 );
            }
            else if( grez1 != -1 && grez2 == -1  ) 
            {
               gdt2 = EncodeDate(gyear2, gmonth2, gday2) + EncodeTime(ghour2, gmin2, gec2, 0);
               SetSob1( 904, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0, gdt2 );
            }
            else if( grez1 == -2 && grez2 == -2  ) 
            {
               SetSob1( 904, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0, Now() );
            }

            ILivedCnt = 0;
            ILivedTimer->Enabled = true;

            if( !DemoMode ) SetSob( 900, 0, 0, 0, 0, SetSobStr02 /*"Модуль"*/, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else SetSob( 907, 0, 0, 0, 0, SetSobStr02 /*"Модуль"*/, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            if( Table1->IsEmpty() ) SetSob( 902, 0, 0, 0, 0, SetSobStr02 /*"Новая смена"*/, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            LoadLocalConfig(ExtractFilePath(Application->ExeName)+"m_server.ini");

            if( FileExists(ExtractFilePath(Application->ExeName)+"m_server.ini") )
            {
               LoadLocalConfig(ExtractFilePath(Application->ExeName)+"m_server.ini");
               MainForm->Left = MainFormLeft;
               MainForm->Top = MainFormTop;
               if( MainFormWidth > 100 ) MainForm->Width = MainFormWidth;
               else MainForm->Width = 100;
               if( MainFormHeight > 100 ) MainForm->Height = MainFormHeight;
               else MainForm->Height = 100;
            }
            else MainForm->WindowState = wsMaximized;

            HANDLE hFile = INVALID_HANDLE_VALUE;
            hMapOpros = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, sizeof(TOprosOutObj), "OprosMappingObject");
            if( hMapOpros != NULL )
            {
              lpMapOpros = MapViewOfFile(hMapOpros, FILE_MAP_WRITE, 0, 0, 0);
              if( lpMapOpros == NULL )
              {
                 Table1->Active = false;
                 MessageBox (NULL, MsgStr6.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                 Application->Terminate();
                 return;
              }
            }
            else
            {
               Table1->Active = false;
               MessageBox (NULL, MsgStr6.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
               Application->Terminate();
               return;
            }

            hMapCfg = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, sizeof(TOutObj), "CfgMappingObject");
            if( hMapCfg != NULL )
            {
              lpMapCfg = MapViewOfFile(hMapCfg, FILE_MAP_WRITE, 0, 0, 0);
              if( lpMapCfg == NULL )
              {
                 MessageBox (NULL,MsgStr6.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
                 Application->Terminate();
                 return;
              }
            }
            else
            {
               MessageBox (NULL,MsgStr6.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
               Application->Terminate();
               return;
            }

            POprosOutObj(lpMapOpros)->OprosMode = true;
            StrCopy( POprosOutObj(lpMapOpros)->PlanPath, PlanPath.c_str() );

            hMapPlan = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, sizeof(TOutObj), "PlanMappingObject");
            if( hMapPlan != NULL )
            {
               lpMapPlan = MapViewOfFile(hMapPlan, FILE_MAP_READ, 0, 0, 0);
               if( lpMapPlan == NULL )
               {
                  MessageBox (NULL,MsgStr6.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
                  Application->Terminate();
                  return;
               }
            }
            else
            {
               MessageBox (NULL,MsgStr6.c_str(),ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
               Application->Terminate();
               return;
            }

            if( ComplexVersion == RifxComplexType )
            {
                for( int kan = 0; kan < RifKanCnt; kan++ )
                {
                    if( RifPortNum[kan] != 0 )
                    {
                       bool iflag = false;
                       int otv = 0;

                       for(;;)
                       {
                           if( !DemoMode )
                           {
                               for( int as = 0; as < 3; as++ )
                               {
                                  if( RifSerial[kan].Open(RifPortNum[kan], RifPortSpeed[kan]) )
                                  {
                                     iflag = true;
                                     break;
                                  }
                                  MyDelay(100);
                               }
                           }
                           else
                           {
                              for( int i = 0; i < RifDevCnt; i++ )
                              {
                                  if( RifSys->Rk[kan][i].Use )
                                  {
                                     for( int j = 0; j < MaxIpBlSdCnt; j++ ) if( RifSys->Rk[kan][i].InUse[j] ) RifSys->Rk[kan][i].Status[j] = 1;
                                     for( int j = MaxIpBlSdCnt; j < MaxInCnt; j++ ) if( RifSys->Rk[kan][i].InUse[j] ) RifSys->Rk[kan][i].Status[j] = 100;

                                     int packet[1000];
                                     memset(packet,0,1000);

                                     bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                                     ShowNewRkStatus(1, i, kan, 0, Tin_IpBl, packet );
                                  }
                              }

                              iflag = true;
                           }

                           if( iflag )
                           {
                              break;
                           }
                           else
                           {
                               str.sprintf("Ошибка открытия порта COM%d, к которому подключен канал РИФ+!\n\n\"Прервать\" - завершить работу и выйти из программы.\n\"Повтор\" - повторить попытку открытия порта COM%d.\n\"Пропустить\" - отменить опрос датчиков порту COM%d", RifPortNum[kan], RifPortNum[kan], RifPortNum[kan]);

                               bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                               for( int i = 0; i < RifDevCnt; i++ )
                               {
                                  if( RifSys->Rk[kan][i].Use )
                                  {
                                     for( int j = 0; j < MaxInCnt; j++ )
                                     if( RifSys->Rk[kan][i].InUse[j] )
                                     {
                                       RifSys->Rk[kan][i].Status[j] = 10;
                                     }

                                     int packet[1000];
                                     memset(packet,0,1000);

                                     ShowNewRkStatus(1, i, kan, 0, Tin_IpBl, packet );
                                  }
                               }

                               if( AutoStart == 0 )
                               {
                                  otv = Application->MessageBox(str.c_str(), WarningMsg.c_str(), MB_ABORTRETRYIGNORE );

                                  if( otv == IDIGNORE	)
                                  {
                                    iflag = false;
                                    break;
                                  }
                                  else if( otv == IDABORT )
                                  {
                                    break;
                                  }
                               }
                               else break;
                           }
                       }

                       if( otv == IDABORT )
                       {
                          pfrm->Visible = false;
                          Table1->Active = false;

                          POprosOutObj(lpMapOpros)->OprosMode = false;

                          Application->Terminate();
                          return;
                       }

                       if( !iflag )
                       {
                          RifSerial[kan].Close();
                          RifPortNum[kan] = 0;
                       }
                       else
                       {
                           int packet[1000];
                           memset(packet,0,1000);
                           int rez = 0;

                           for( int rk = 0; rk < RifDevCnt; rk++ )
                           {
                              if( RifSys->Rk[kan][rk].Use &&
                                  (RifSys->Rk[kan][rk].Type == TochkaMBoIdx || RifSys->Rk[kan][rk].Type == SotaMBoIdx) )
                              {
                                 int bo_mode = 0;
                                 if( RifSys->Rk[kan][rk].Use && RifSys->Rk[kan][rk].Type == SotaMBoIdx ) bo_mode = 1;
                                 int packet[1000];
                                 memset(packet,0,1000);

                                 if( !DemoMode )
                                 {
                                     for( int i = 0; i < 5; i++ )
                                     {
                                        memset(packet,0,1000);
                                        rez = RifSerial[kan].SetCfg8( rk+1, bo_mode, RifSys->Rk[kan][rk].BO_cfg, RifSys->Rk[kan][rk].Uch2StartAdr, RifSys->Rk[kan][rk].Uch4StartAdr, true );
                                        MyDelay(500);
                                        rez = RifSerial[kan].GetPaket( rk+1, packet );
                                        if( rez == 1 && packet[4] == 0x30 ) break;
                                     }

                                     if( rez != 1 )
                                     {
                                        bool tin[MaxIpBlSdCnt];
                                        RifSys->Rk[kan][rk].Status[0] = 10;
                                        ShowNewRkStatus(0, rk, kan, false, tin, packet );
                                        RifSys->Rk[kan][rk].Use = false;
    /*
                                        for( int lll = 0; lll < RifDevCnt; lll++ )
                                        {
                                           if( RifSys->OprosAdr[kan][lll] == rk+1 )
                                           {
                                              for( int lll1 = lll; lll1 < RifDevCnt-1; lll1++ ) RifSys->OprosAdr[kan][lll1] = RifSys->OprosAdr[kan][lll1+1];

                                           }
                                        }
                                        RifSys->OprosCnt[kan] -= 1;
    */

                                        if( RifSys->Rk[kan][rk].Type == TochkaMBoIdx ) str.sprintf("Нет связи с БОД Точка-М/Гарда-М по порту COM%d!", RifPortNum[kan]);
                                        else if( RifSys->Rk[kan][rk].Type == SotaMBoIdx ) str.sprintf("Нет связи с БОД Сота/Сота-М по порту COM%d!", RifPortNum[kan]);

                                        MessageBox (NULL,str.c_str(),"Ошибка",MB_OK|MB_ICONERROR);
                                    }
                                 }
                              }
                           }
                       }
                    }
                    else RifPortNum[kan] = 0;
                }
            }

            if( SsoiVersion < 2 ) CGauge1->MaxValue = BazaltCnt;
            else CGauge1->MaxValue = BazaltCnt2;

            if( SsoiVersion == 1 )  
            {
                if( SsoiM_PortNum[0] != 0 && SsoiScnt > 0 )
                {
                   bool iflag = false;

                   for( int ip = 0; ip < 3; ip++ )
                   {
                      if( SsoiSerial.Open(SsoiM_PortNum[0], GobiPortSpeed) )
                      {
                         iflag = true;
                         break;
                      }
                      else MyDelay(500);
                   }

                   if( !iflag  )
                   {
                      SsoiSerial.Close();
                      MessageBox (NULL, MsgStr8.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                      SsoiM_PortNum[0] = 0;
                   }
                   else
                   {
                      int buff[9];
                      for( int i = 0; i < 9; i++ ) buff[i] = 0;
                      buff[0] = 0xC0;
                      int num = 1;
                      for( int kan = 0; kan < KanCnt; kan++ )
                      {
                         if( GobiSys->Kanal[kan].Use )
                         {
                            GobiSys->Kanal[kan].AutoDkDt = Now();
                            GobiSys->Kanal[kan].AutoDkDt = IncHour( GobiSys->Kanal[kan].AutoDkDt, 4 );

                            for( int bl = 0; bl < BlCnt; bl++ )
                            {
                               if( GobiSys->Kanal[kan].Bl[bl].Use )
                               {
                                  if( bl < 7 ) buff[num] |= (1<<bl+1);
                                  else buff[num+1] |= (1<<(bl-7));
                               }
                            }
                         }
                         num += 2;
                      }
                      SsoiSerial.BS_setup(buff);
                   }
                }

                GobiDkKan1Item->Enabled = GobiSys->Kanal[0].Use;
                GobiDkKan2Item->Enabled = GobiSys->Kanal[1].Use;
                GobiDkKan3Item->Enabled = GobiSys->Kanal[2].Use;
                GobiDkKan4Item->Enabled = GobiSys->Kanal[3].Use;

                if( GobiDkKan1Item->Enabled &&
                    GobiDkKan2Item->Enabled &&
                    GobiDkKan3Item->Enabled &&
                    GobiDkKan4Item->Enabled ) GobiDkKanalsItem->Enabled = true;
                else GobiDkKanalsItem->Enabled = false;
            }
            else if( SsoiVersion == 2 ) 
            {
               for( int kan = 0; kan < KanCnt; kan++ )
               {
                  if( SsoiM_PortNum[kan] != 0 && SsoiMScnt[kan] > 0 )
                  {
                     bool iflag = false;

                     for( int ip = 0; ip < 3; ip++ )
                     {
                           if( SsoiMSerial[kan].Open(SsoiM_PortNum[kan], SsoiM_PortSpeed) )
                           {
                              iflag = true;
                              break;
                           }
                           else MyDelay(500);
                     }

                     if( !iflag  )
                     {
                        SsoiMSerial[kan].Close();
                        MessageBox (NULL, MsgStr8.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                        SsoiM_PortNum[kan] = 0;
                     }
                  }
               }

               if( SsoiM_PortNum[0] != 0 ) GobiDkKan1Item->Enabled = true;
               else GobiDkKan1Item->Enabled = false;

               if( SsoiM_PortNum[1] != 0 ) GobiDkKan2Item->Enabled = true;
               else GobiDkKan2Item->Enabled = false;

               if( SsoiM_PortNum[2] != 0 ) GobiDkKan3Item->Enabled = true;
               else GobiDkKan3Item->Enabled = false;

               if( SsoiM_PortNum[3] != 0 ) GobiDkKan4Item->Enabled = true;
               else GobiDkKan4Item->Enabled = false;
            }
            else
            {
               SsoiM_PortNum[0] = 0;
               SsoiM_PortNum[1] = 0;
               SsoiM_PortNum[2] = 0;
               SsoiM_PortNum[3] = 0;
            }

            if( RastrPortNum != 0 && S3cnt > 0 && (ComplexVersion == RifxComplexType || ComplexVersion == SsoiComplexType) )
            {
               bool iflag = false;

               for( int ip = 0; ip < 3; ip++ )
               {
                  if( Serial3.Open(RastrPortNum, RastrPortSpeed) )
                  {
                     iflag = true;
                     break;
                  }
                  else MyDelay(500);
               }

               if( !iflag )
               {
                  Serial3.Close();
                  if( AutoStart == 0 ) MessageBox (NULL, MsgStr9.c_str(),ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                  RastrPortNum = 0;
               }
            }
            else RastrPortNum = 0;

            SolidTimer->Enabled = false;
            if( SolidPortNum != 0 && S4cnt > 0 && ComplexVersion == RifxComplexType )
            {
               bool iflag = false;

               for( int ip = 0; ip < 3; ip++ )
               {
                  if( Serial4.Open(SolidPortNum, SolidPortSpeed) )
                  {
                     iflag = true;
                     break;
                  }
                  else MyDelay(500);
               }

               if( !iflag )
               {
                  Serial4.Close();
                   if( AutoStart == 0 ) MessageBox (NULL,"Ошибка открытия COM-порта, к которому подключена подсистема СОЛИД. Управление ТВ-камерами производится не будет!","Ошибка",MB_OK|MB_ICONERROR);
                  SolidPortNum = 0;
               }
               else
               {
                  SolidTimer->Interval = SolidAutoTime;
               }
            }
            else SolidPortNum = 0;

            Adam4068Timer->Enabled = false;
            Adam4068Timer->Interval = Adam4068Interval;
            if( Adam4068PortNum != 0 && S7cnt > 0 && ComplexVersion == RifxComplexType )
            {
               bool iflag = false;

               for( int ip = 0; ip < 3; ip++ )
               {
                  if( Serial5.Open(Adam4068PortNum, Adam4068PortSpeed) )
                  {
                     iflag = true;
                     break;
                  }
                  else MyDelay(500);
               }

               if( !iflag )
               {
                  Serial5.Close();
                  if( AutoStart == 0 ) MessageBox (NULL,"Ошибка открытия COM-порта, к которому подключена подсистема АДАМ-4068. Управление ИУ производится не будет!","Ошибка",MB_OK|MB_ICONERROR);
                  Adam4068PortNum = 0;
               }
               else
               {
                  Adam4068Timer->Enabled = true;
               }
            }
            else Adam4068PortNum = 0;

            if( TabloPortNum > 0  )
            {
               if( !Serial6.Open(TabloPortNum, TabloPortSpeed) )
               {
                  Serial6.Close();
                  TabloPortNum = 0;
                  TabloSys->Use = false;
                  TabloTimer->Enabled = false;

                  MessageBox (NULL,"Ошибка открытия COM-порта, к которому подключена подсистема инф.табло. Управление инф. табло производится не будет!","Ошибка",MB_OK|MB_ICONERROR);
               }
               else TabloTimer->Enabled = true;
            }

            if( !TabloSys->Use ) TabloResetItem->Visible = false;

            ShowGlobalConfig();

            AnsiString cmd;
            if( PlanType == 0 ) { cmd = ExtractFilePath(Application->ExeName) + "m_plan.exe"; WinExec(cmd.c_str(), SW_SHOWNA ); }
            else if( PlanType == 1 ){ cmd = ExtractFilePath(Application->ExeName) + "m_graph.exe"; WinExec(cmd.c_str(), SW_SHOWNA ); MyDelay(1500); }


            CurrentDt2 = Now();
            for( int kan = 0; kan < RifKanCnt; kan++) CurrentDtRif[kan] = CurrentDt2;

            if( ComplexVersion == RifxComplexType )
            {
                if( RifSys->Use && !DemoMode )
                {
                    RifTimer = new TTimer *[RifKanCnt];
                    for( int i = 0; i < RifKanCnt; i++)
                    {
                       RifTimer[i] = new TTimer(this);
                       RifTimer[i]->Interval = RifTimerInterval[i];
                       RifTimer[i]->Tag = i;
                       RifTimer[i]->OnTimer = RifOpros;
                       RifTimer[i]->Enabled = false;
                       if( RifPortNum[i] > 0 )
                       {
                         RifTimer[i]->Enabled = true;
                         ActiveOprosChannels += 1;
                       }
                    }
                }

                if( Rif2Sys->Use && UdpAdress->Count > 0  && !DemoMode )
                {
                   RifOprosThread = new TRifOprosThread *[UdpAdress->Count];

                   for( int i = 0; i < UdpAdress->Count; i++ )
                   {
                       RifOprosThread[i] = new TRifOprosThread(true);
                       RifOprosThread[i]->Num = i;
                       RifOprosThread[i]->Priority = tpLower;
                       Application->ProcessMessages();
                   }
                }
            }

            OprosGobiTimer->Enabled = false;
            if( SsoiVersion == 1 )
            {
               if( SsoiM_PortNum[0] > 0 )
               {
                  OprosGobiTimer->Enabled = true;

                  ActiveOprosChannels += 1;
               }
            }
            else if( SsoiVersion == 2 )
            {
               SsoiMTimer = new TTimer *[KanCnt];
               for( int i = 0; i < KanCnt; i++)
               {
                  Ssoi2Cnt[i] = Ssoi2MaxCnt[i];
                  Ssoi2BufCnt[i] = 0;

                  SsoiMTimer[i] = new TTimer(this);
                  SsoiMTimer[i]->Interval = 50;
                  SsoiMTimer[i]->Tag = i;
                  SsoiMTimer[i]->OnTimer = SsoiMOpros;
                  SsoiMTimer[i]->Enabled = false;
                  if( SsoiM_PortNum[i] > 0 )
                  {
                     SsoiMTimer[i]->Enabled = true;
                     ActiveOprosChannels += 1;
                  }
               }
            }
            else if( SsoiVersion == 3 )
            {
               SetupItem->Visible = false;
               DkRifItem->Visible = false;

               DEVICE_ID_PARAMS devID[4];
               PDEVICE_ID_PARAMS pID;
               char sernum[8];
               AnsiString sn = "";
               int flag = -1;
               SsoiM1_devnum = -1;

               for( int dev = 0; dev < ESEU485DevCnt; dev++ )
               {
                  pID=&devID[dev];
                  for( int i = 0; i < 8; i++ ) sernum[i] = 0;

                  for( int i = 0; i < 3; i++ )
                  {
                     Sleep(100);
                     flag = GetDeviceID(dev, pID);
                     if( flag == AppOK )
                     {
                        char sernum[8];
                        sernum[0] = devID[dev].chDeviceSerial[0];
                        sernum[1] = devID[dev].chDeviceSerial[1];
                        sernum[2] = devID[dev].chDeviceSerial[2];
                        sernum[3] = devID[dev].chDeviceSerial[3];
                        sernum[4] = devID[dev].chDeviceSerial[4];
                        sernum[5] = devID[dev].chDeviceSerial[5];
                        sernum[6] = devID[dev].chDeviceSerial[6];
                        sernum[7] = devID[dev].chDeviceSerial[7];

                        sn.sprintf("%02X %02X %02X %02X %02X", sernum[3]&0xFF, sernum[4]&0xFF, sernum[5]&0xFF, sernum[6]&0xFF, sernum[7]&0xFF);

                        if( sn == SsoiM1_sernum )
                        {
                           SsoiM1_devnum = dev;
                           goto metka1;
                        }
                        else
                        {
                           flag = 105;
                           break;
                        }
                     }
                  }
               }

      metka1:  if( SsoiM1_devnum < 0 )
               {

                  str.sprintf("%s %s", MsgStr11, SsoiM1_sernum);
                  MessageBox (NULL, str.c_str(), MsgStr21.c_str(), MB_OK|MB_ICONERROR);
               }
               else
               {
                  SetupItem->Visible = false;
                  N26->Visible = false;
                  DkRifItem->Visible = false;
                  GobiDkItem->Caption = "РАСТР-М-ССОИ";

                  GobiDkKan1Item->Enabled = GobiSys->Kanal[0].Use;
                  GobiDkKan2Item->Enabled = GobiSys->Kanal[1].Use;
                  GobiDkKan3Item->Enabled = GobiSys->Kanal[2].Use;
                  GobiDkKan4Item->Enabled = GobiSys->Kanal[3].Use;

                  for( int ch = 0; ch < KanCnt; ch++ )
                  {
                     flag = SetUartMasterRate(SsoiM1_devnum, ch+1, SsoiM1_speed+2);
                     if( flag != AppOK ) break;

                     flag = SetUartMasterTimeout(SsoiM1_devnum, ch+1, SsoiM1_timeout);
                     if( flag != AppOK ) break;
                  }

                  if( flag == AppOK ) flag = SaveUartSettings(SsoiM1_devnum);

                  if( flag == AppOK )
                  {
                     str.sprintf("Устройство: %s  Скорость: %d  Таймаут: %d", SsoiM1_sernum, 5000000/(SsoiM1_speed+2), SsoiM1_timeout);
                     StatusBar1->Panels->Items[3]->Text = str;

                     if( SsoiM1_timeout >= 50) SsoiM1_BazaltCnt = BazaltCnt3/(SsoiM1_timeout/50);
                     else SsoiM1_BazaltCnt = BazaltCnt3;

                     int t = 0;
                     SsoiM1Timer = new TTimer *[KanCnt];
                     for( int i = 0; i < KanCnt; i++ )
                     {
                        SsoiM1_adr[i] = -1;

                        SsoiM1Timer[i] = new TTimer(this);
                        SsoiM1Timer[i]->Interval = SsoiM1_timeout;
                        SsoiM1Timer[i]->Tag = i;
                        SsoiM1Timer[i]->OnTimer = SsoiM1Opros;
                        SsoiM1Timer[i]->Enabled = GobiSys->Kanal[i].Use;

                        if( SsoiM1Timer[i]->Enabled ) t = t + 1;
                     }

                     SsoiM1_BazaltCnt = SsoiM1_BazaltCnt/t;
                  }
                  else
                  {
                     str = RezToStr(flag);
                     MessageBox (NULL, str.c_str(), ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
                  }
               }
            }

            if( !DemoMode )
            {
               TvTimer->Enabled = true;
               SolidTimer->Enabled = true;
               GobiCamTimer->Enabled = true;
            }
            SoundTimer->Enabled = true;
            CfgTimer->Enabled = true;

            AddPrichina_pdi->Caption = PupStr9;
            DelPrichina_pdi->Caption = PupStr10;
            AddMera_pdi->Caption =  PupStr9;
            DelMera_pdi->Caption = PupStr10;
      }
   }
   catch(...)
   {
      Table1->Active = false;
      OprosGobiTimer->Enabled = false;
      TvTimer->Enabled = false;
      SoundTimer->Enabled = false;
      SolidTimer->Enabled = false;
      GobiCamTimer->Enabled = false;
      CfgTimer->Enabled = false;

      MessageBox (NULL, MsgStr22.c_str(), ErrorMsg.c_str(), MB_OK|MB_ICONERROR);
      Application->Terminate();
      return;
   }

   if( MySQL_use == 0 ) StatusBar1->Panels->Items[0]->Width = 0;
   if( Server2Use == 0 ) StatusBar1->Panels->Items[1]->Width = 0;
   if( iServerUse == 0 ) StatusBar1->Panels->Items[2]->Width = 0;

   str = "";
   if( OpList->Use )
   {
      str.sprintf("%s: %s", MsgStr23, OpFn);
      if( OpN1 != "(null)") str = str + " " + OpN1;
      if( OpN2 != "(null)" ) str = str + " " + OpN2;
      StaticText29->Caption = str;
   }

   Caption = Caption + " - " + VersionInfoStr;
   if( DemoMode ) Caption = Caption + " - ДЕМО-РЕЖИМ!!!";

   ShowPrCnt();

   if( Rif2Sys->Use && UdpAdress->Count > 0 && !DemoMode )
   {
      for( int i = 0; i < UdpAdress->Count; i++ )
      {
        if( RifOprosThread[i]->Suspended ) RifOprosThread[i]->Resume();
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::FormClose(TObject *Sender, TCloseAction &Action)
{
   AlarmResetItemClick(this);

   if( Rif2Sys->Use && UdpAdress->Count > 0 )
   {
      std::auto_ptr<TReadForm> pfrm(new TReadForm(this));
      pfrm->Label1->Caption = "Завершение опроса устройств...";
      pfrm->Update();

      for( int i = 0; i < UdpAdress->Count; i++ )
      {
         RifOprosThread[i]->Terminate();
         RifOprosThread[i]->WaitFor();
         delete RifOprosThread[i];
      }
      pfrm->Close();
   }

   if( P123 )
   {
      Action = caNone;
      MessageBox (NULL,"Есть не обработанные события! Программа не может быть закрыта.",ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
   }
   else
   {
       if( Application->MessageBox(MsgStr12.c_str(), WarningMsg.c_str(), MB_YESNO ) != IDYES )
       {
          if( Rif2Sys->Use && UdpAdress->Count > 0 )
          {
            for( int i = 0; i < UdpAdress->Count; i++ )
            {
              RifOprosThread[i] = new TRifOprosThread(true);
              RifOprosThread[i]->Num = i;
              RifOprosThread[i]->Priority = tpLower;
              RifOprosThread[i]->Resume();
              Application->ProcessMessages();
            }
          }

          Action = caNone;
       }
       else
       {
          for( int i = 0; i < UdpAdress->Count; i++ )
          {
             RifOprosThread[i]->Terminate();
          }

          if( Table1->Active ) SetSob( 901, 0, 0, 0, 0, SetSobStr02 /*"Модуль"*/, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          KeepAliveTimerTimer(this);

          OprosGobiTimer->Enabled = false;
          TvTimer->Enabled = false;
          SoundTimer->Enabled = false;
          SolidTimer->Enabled = false;
          Adam4068Timer->Enabled = false;
          GobiCamTimer->Enabled = false;
          KeepAliveTimer->Enabled = false;
          ILivedTimer->Enabled = false;
          CfgTimer->Enabled = false;

          SaveGlobalConfig(ExtractFilePath(Application->ExeName)+"rifx.ini");

          if( ComplexVersion == RifxComplexType )
          {
            if( RifSys->Use && !DemoMode )
            {
                for( int kan = 0; kan < RifKanCnt; kan++ )
                {
                   delete RifTimer[kan];
                   RifSerial[kan].Close();
                }
            }
          }

          if( SsoiVersion == 2 )
          {
             for( int kan = 0; kan < KanCnt; kan++ )
             {
                delete SsoiMTimer[kan];
                SsoiMSerial[kan].Close();
             }
          }

          SsoiSerial.Close();
          Serial3.Close();
          Serial4.Close();
          Serial5.Close();
          Serial6.Close();

          Table1->Active = false;

          Server2->Active = false;
          iServer->Active = false;

          mysql_close(Con);

          POprosOutObj(lpMapOpros)->OprosMode = false;

          if( lpMapOpros ) UnmapViewOfFile( lpMapOpros );
          lpMapOpros = 0;

          if( hMapOpros ) CloseHandle( hMapOpros );
          hMapOpros = 0;

          if( lpMapCfg ) UnmapViewOfFile( lpMapCfg );
          lpMapCfg = 0;

          if( hMapPlan ) CloseHandle( hMapPlan );
          hMapPlan = 0;

          AnsiString fn111 = ExtractFileName(Application->ExeName);
          AnsiString fn112 = ExtractFileName(Application->ExeName);
          AnsiString tmps111, tmps112;
          tmps111.sprintf("%s.gs1", fn111);
          tmps112.sprintf("%s.gs2", fn112);
          fn111 = ExtractFilePath(Application->ExeName) + tmps111;
          fn112 = ExtractFilePath(Application->ExeName) + tmps112;
          GoodCloseSave(fn111);
          GoodCloseSave(fn112);

          delete RifSys;
          delete Rif2Sys;
          delete DiagKonc;
          delete GobiSys;
          delete GobiSys2;
          delete DiagRif;
          delete RastrSys;
          delete SolidSys;
          delete iNetSys;
          delete r485NetSys;
          delete A4068Sys;
          delete TreeAndStates;
          delete EventsAndStates;
          delete OpList;

          delete I1Img;
          delete I2Img;
          delete I3Img;
          delete I4Img;
          delete I5Img;
          delete I6Img;
          delete I7Img;
          delete I8Img;
          delete I9Img;

          delete WImg;
          delete AImg;
          delete NImg;
          delete PImg;
          delete HImg;
          delete OImg;

          try
          {
             CommentList->SaveToFile(ExtractFilePath(Application->ExeName)+"comment.lst");
             CommentList2->SaveToFile(ExtractFilePath(Application->ExeName)+"comment2.lst");

             MainFormLeft = MainForm->Left;
             MainFormTop = MainForm->Top;
             MainFormWidth = MainForm->Width;
             MainFormHeight = MainForm->Height;

             SaveLocalConfig(ExtractFilePath(Application->ExeName)+"m_server.ini");
          }
          catch(...)
          {
             ;
          }

          delete CommentList;
          delete CommentList2;
       }
   }
}
//---------------------------------------------------------------------------
bool TMainForm::LoadGlobalConfig( AnsiString fp )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   PlanType = ini->ReadInteger( "PARAMS", "PlanType", 2 );

   PlanPath = ini->ReadString( "PARAMS", "PlanPath", "" );

   SoundType = ini->ReadInteger( "PARAMS", "SoundType", 0 );

   Icon1Path = ini->ReadString( "PARAMS", "Icon1Path", "" );
   if( Icon1Path != "" )
   {
      if( !FileExists(Icon1Path) )
      {
         Icon1Path = ExtractFileName(Icon1Path);
         Icon1Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon1Path;
         if( !FileExists(Icon1Path) ) Icon1Path = "";
      }
   }

   Icon2Path = ini->ReadString( "PARAMS", "Icon2Path", "" );
   if( Icon2Path != "" )
   {
      if( !FileExists(Icon2Path) )
      {
         Icon2Path = ExtractFileName(Icon2Path);
         Icon2Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon2Path;
         if( !FileExists(Icon2Path) ) Icon2Path = "";
      }
   }

   Icon3Path = ini->ReadString( "PARAMS", "Icon3Path", "" );
   if( Icon3Path != "" )
   {
      if( !FileExists(Icon3Path) )
      {
         Icon3Path = ExtractFileName(Icon3Path);
         Icon3Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon3Path;
         if( !FileExists(Icon3Path) ) Icon3Path = "";
      }
   }

   Icon4Path = ini->ReadString( "PARAMS", "Icon4Path", "" );
   if( Icon4Path != "" )
   {
      if( !FileExists(Icon4Path) )
      {
         Icon4Path = ExtractFileName(Icon4Path);
         Icon4Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon4Path;
         if( !FileExists(Icon4Path) ) Icon4Path = "";
      }
   }

   Icon5Path = ini->ReadString( "PARAMS", "Icon5Path", "" );
   if( Icon5Path != "" )
   {
      if( !FileExists(Icon5Path) )
      {
         Icon5Path = ExtractFileName(Icon5Path);
         Icon5Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon5Path;
         if( !FileExists(Icon5Path) ) Icon5Path = "";
      }
   }

   Icon6Path = ini->ReadString( "PARAMS", "Icon6Path", "" );
   if( Icon6Path != "" )
   {
      if( !FileExists(Icon6Path) )
      {
         Icon6Path = ExtractFileName(Icon6Path);
         Icon6Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon6Path;
         if( !FileExists(Icon6Path) ) Icon6Path = "";
      }
   }

   Icon7Path = ini->ReadString( "PARAMS", "Icon7Path", "" );
   if( Icon7Path != "" )
   {
      if( !FileExists(Icon7Path) )
      {
         Icon7Path = ExtractFileName(Icon7Path);
         Icon7Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon7Path;
         if( !FileExists(Icon7Path) ) Icon7Path = "";
      }
   }

   Icon8Path = ini->ReadString( "PARAMS", "Icon8Path", "" );
   if( Icon8Path != "" )
   {
      if( !FileExists(Icon8Path) )
      {
         Icon8Path = ExtractFileName(Icon8Path);
         Icon8Path = ExtractFilePath(Application->ExeName) + "Icons\\" + Icon8Path;
         if( !FileExists(Icon8Path) ) Icon8Path = "";
      }
   }

   AutoStart = ini->ReadInteger( "PARAMS", "AutoStart", 0 );

   AnsiString str;
   for( int kan = 0; kan < RifKanCnt; kan++ )
   {
      str.sprintf("RifPortSpeed%d", kan+1);
      RifPortSpeed[kan] = ini->ReadInteger( "RIF", str, 4800 );
      str.sprintf("RifPortInterval%d", kan+1);
      RifTimerInterval[kan] = ini->ReadInteger( "RIF", str, 50 );
      if( RifTimerInterval[kan] < 50 ) RifTimerInterval[kan] = 50;
      RifMaxErrCnt[kan] = 20000/RifTimerInterval[kan];               
   }
   int t1 = ini->ReadInteger( "RIF", "AutoDK", 0 );
   if( t1 == 0 ) RifSys->AutoDk = false;
   else
   {
      RifSys->AutoDk = true;
      RifSys->AutoDkPeriod = double(t1)/24.0; 
   }
   RifSys->Ul = ini->ReadFloat( "RIF", "Ul", 0.0 );
   RifSys->Uh = ini->ReadFloat( "RIF", "Uh", 5.0 );
   TochkaDirectionInterval = ini->ReadInteger( "RIF", "TochkaDirectionInterval", 20 );
   TochkaPauseInterval = ini->ReadInteger( "RIF", "TochkaPauseInterval", 5 );

   SsoiVersion = ini->ReadInteger( "SSOI", "Version", 2 );
   if( ComplexVersion == Rastr_M_SsoiComplexType ) SsoiVersion = 3;

   for( int kan = 0; kan < KanCnt; kan++ )
   {
      str.sprintf("SsoiM_PortNum%d", kan+1);
      SsoiM_PortNum[kan] = ini->ReadInteger( "SSOI", str, 0 );

      str.sprintf("SsoiM_Interval%d", kan+1);
      int t = ini->ReadInteger( "SSOI", str, 1500 );
      Ssoi2MaxCnt[kan] = t/50;
      if( Ssoi2MaxCnt[kan] < 1 ) Ssoi2MaxCnt[kan] = 1;

      str.sprintf("SsoiM_MaxErrCnt%d", kan+1);
      SsoiM_MaxErrCnt[kan] = ini->ReadInteger( "SSOI", str, 2 );
      if(SsoiM_MaxErrCnt[kan] < 1) SsoiM_MaxErrCnt[kan] = 1;
      SsoiM_MaxErrCnt[kan] = SsoiM_MaxErrCnt[kan]*Ssoi2MaxCnt[kan];
   }
   GobiPortSpeed = 19200;
   SsoiM_PortSpeed = ini->ReadInteger( "SSOI", "SsoiM_PortSpeed", 19200 );
   GobiFixNewWarning = ini->ReadInteger( "SSOI", "SsoiFixNewWarning", 0 );
   SsoiAutoDkUse = ini->ReadInteger( "SSOI", "SsoiAutoDkUse", false );

   RastrPortNum = ini->ReadInteger( "RASTR", "Port", 0 );
   RastrPortSpeed = 3125;
   if( RastrPortNum == 0 || RastrPortNum > 4 )
   {
      RastrPortNum = 0;
      GroupBox7->Visible = false;
      GroupBox7->Enabled = false;
   }

   SolidPortNum = ini->ReadInteger( "SOLID", "Port", 0 );
   SolidPortSpeed = 19200;
   if( SolidPortNum <= 0  ) SolidPortNum = 0;
   SolidAutoTime = 250;

   Adam4068PortNum = ini->ReadInteger( "ADAM4068", "Port", 0 );
   Adam4068PortSpeed = ini->ReadInteger( "ADAM4068", "PortSpeed", 9600 );
   Adam4068Interval = ini->ReadInteger( "ADAM4068", "Interval", 100 );

   TabloPortNum = ini->ReadInteger( "TABLO", "Port", 0 );
   TabloPortSpeed = ini->ReadInteger( "TABLO", "PortSpeed", 115200 );
   TabloBlinking = ini->ReadBool( "TABLO", "Blinking", false );

   int s2u = ini->ReadInteger( "RASTRMTV", "Use", 0 );
   if( s2u > 0 ) Server2Use = true;
   Server2Port = ini->ReadInteger( "RASTRMTV", "Port", 1971 );
   r485KeepAlive = ini->ReadInteger( "RASTRMTV", "KeepAliveInterval", 20 );
   if( r485KeepAlive < 20 ) r485KeepAlive = 20;

   iServerUse = ini->ReadBool( "INTEGRATION", "Use", false );
   iServerPort = ini->ReadInteger( "INTEGRATION", "Port", 1973 );
   iKeepAlive = ini->ReadInteger( "INTEGRATION", "KeepAliveInterval", 10 );
   DevLineFilePath = ini->ReadString( "INTEGRATION", "DevLine", "c:\\Program Files\\DevLine\\Line\\observer.exe" );

   MySQL_use = ini->ReadInteger( "MYSQL", "Use", 0 );
   MySQL_host = ini->ReadString( "MYSQL", "Host", "localhost" );
   MySQL_port = ini->ReadInteger( "MYSQL", "Port", 3306 );
   MySQL_login = ini->ReadString( "MYSQL", "Login", "" );
   MySQL_password = ini->ReadString( "MYSQL", "Password", "" );
   MySQL_password = XOR_Crypt(MySQL_password,"start7");
   MySQL_dbname = ini->ReadString( "MYSQL", "DbName", "" );
   P1 = ini->ReadBool( "MYSQL", "P1", false );
   P2 = ini->ReadBool( "MYSQL", "P2", false );
   AutoDbStart = ini->ReadBool( "MYSQL", "AutoDbStart", false );
   AutoDbStartHour = ini->ReadInteger( "MYSQL", "AutoDbStartHour", 0 );
   AutoDbStartMinute = ini->ReadInteger( "MYSQL", "AutoDbStartMinute", 0 );
   if( AutoDbStart )
   {
      AutoDbStartDt = Date();
      AutoDbStartDt = AutoDbStartDt + EncodeTime(AutoDbStartHour, AutoDbStartMinute, 0, 0);
      if( Now() > AutoDbStartDt ) AutoDbStartDt = IncDay(AutoDbStartDt, 1);
   }

   SsoiM1_sernum = ini->ReadString(  "RASTRMSSOI", "SerNum", "" );
   SsoiM1_speed = ini->ReadInteger( "RASTRMSSOI", "Speed", 0 );
   SsoiM1_timeout = ini->ReadInteger( "RASTRMSSOI", "Timeout", 50 );

   UseAsoosd = ini->ReadInteger( "ASOOSD", "Use", 0 );
   AsoosdClientSocket->Host = ini->ReadString( "ASOOSD", "Host", "" );
   AsoosdClientSocket->Port = ini->ReadInteger( "ASOOSD", "Port", 1975);

   BackupPath = ini->ReadString( "BACKUP", "BackupPath", ExtractFilePath(Application->ExeName) + "\Backup" );
   MaxBdStringCnt = 1000000 * (ini->ReadInteger( "BACKUP", "MaxBdStringCnt", 0 ) + 1 );

   OpList->Reset();
   if( ini->ReadInteger("OPERATORS", "Use", 0 ) == 1 ) OpList->Use = true;
   if( OpList->Use )
   {
       OpList->OpCnt = ini->ReadInteger("OPERATORS", "Count", 0 );
       if( OpList->OpCnt > 0 )
       {
          for( int i = 0; i < OpList->OpCnt; i++ )
          {
             str.sprintf("Operator_%d", i);
             OpList->Op[i].FamilyName = ini->ReadString( str.c_str(), "FN", "" );
             OpList->Op[i].FirstName = ini->ReadString( str.c_str(), "N1", "" );
             OpList->Op[i].SecondName = ini->ReadString( str.c_str(), "N2", "" );
             OpList->Op[i].Password = ini->ReadString( str.c_str(), "PW", "" );
          }
       }
   }

   ObjTree->Items->BeginUpdate();
   ObjTree->Items->Clear();

   PCfgObj  OprosObj;
   OprosObj = new TCfgObj;
   OprosObj->Name = MsgStr25;

   TTreeNode* tempNode;
   tempNode = ObjTree->Items->AddObject( ObjTree->Selected, OprosObj->Name, OprosObj );
   tempNode->SelectedIndex = 15;
   tempNode->ImageIndex = 15;
   tempNode->Selected = true;

   int Cnt = ini->ReadInteger( "TREE", "Count", 0 );
   if( Cnt > 0 )
   {
      int newflang1 = 1;
      int newflang3 = 3;

      int temp = 0;

      for( int i = 1; i <= Cnt; i++ )
      {
         str.sprintf("Obj_%d", i);
         temp = ini->ReadInteger( str.c_str(), "Type", 0 );

         if( temp == NetDevIdx && PlanType != 1 )
         {
         ;
         }
         else
         {
             OprosObj = new TCfgObj;
             OprosObj->Type = ini->ReadInteger( str.c_str(), "Type", 0 );
             OprosObj->Num1 = ini->ReadInteger( str.c_str(), "Num1", 0 );
             OprosObj->Num2 = ini->ReadInteger( str.c_str(), "Num2", 0 );
             OprosObj->Num3 = ini->ReadInteger( str.c_str(), "Num3", 0 );
             OprosObj->Level = ini->ReadInteger( str.c_str(), "Level", 0 );
             OprosObj->Name = ini->ReadString( str.c_str(), "Name", "" );
             OprosObj->IconVisible = ini->ReadBool( str.c_str(), "IconVisible", false );
             OprosObj->X = ini->ReadInteger( str.c_str(), "X", 0 );
             OprosObj->Y = ini->ReadInteger( str.c_str(), "Y", 0 );
             OprosObj->Icon1Path = ini->ReadString( str.c_str(), "Icon1Path", "" );

             if( OprosObj->Icon1Path != "" )
             {
                if( OprosObj->Type != Stn485Type && OprosObj->Type != StrazhIpType && OprosObj->Type != OnvifTvType && OprosObj->Type != NetDevIdx )
                {
                   if( !FileExists(OprosObj->Icon1Path) )
                   {
                      OprosObj->Icon1Path = ExtractFileName(OprosObj->Icon1Path);
                      OprosObj->Icon1Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon1Path;
                      if( !FileExists(OprosObj->Icon1Path) ) OprosObj->Icon1Path = "";
                   }
                }
                if( OprosObj->Type == Stn485Type )
                {
                  int t = ReadStn485Channel(ExtractFilePath(Application->ExeName)+"rastrmtv_cfg.ini", OprosObj->Icon1Path);
                  if( t > 0 ) OprosObj->Num2 = t;
                }
             }

             OprosObj->Icon2Path = ini->ReadString( str.c_str(), "Icon2Path", "" );
             if( OprosObj->Icon2Path != "" )
             {
                if( OprosObj->Type != Stn485Type && OprosObj->Type != StrazhIpType && OprosObj->Type != OnvifTvType )
                {
                    if( !FileExists(OprosObj->Icon2Path) )
                    {
                       OprosObj->Icon2Path = ExtractFileName(OprosObj->Icon2Path);
                       OprosObj->Icon2Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon2Path;
                       if( !FileExists(OprosObj->Icon2Path) ) OprosObj->Icon2Path = "";
                    }
                }
             }
             OprosObj->Icon3Path = ini->ReadString( str.c_str(), "Icon3Path", "" );
             if( OprosObj->Icon3Path != "" )
             {
                if( OprosObj->Type != StrazhIpType && OprosObj->Type != OnvifTvType )
                {
                   if( !FileExists(OprosObj->Icon3Path) )
                   {
                      OprosObj->Icon3Path = ExtractFileName(OprosObj->Icon3Path);
                      OprosObj->Icon3Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon3Path;
                      if( !FileExists(OprosObj->Icon3Path) ) OprosObj->Icon3Path = "";
                   }
                }
             }
             OprosObj->Icon4Path = ini->ReadString( str.c_str(), "Icon4Path", ""  );
             if( OprosObj->Icon4Path != "" )
             {
                if( OprosObj->Type != Stn485Type && OprosObj->Type != StrazhIpType && OprosObj->Type != OnvifTvType )
                {
                   if( !FileExists(OprosObj->Icon4Path) )
                   {
                      OprosObj->Icon4Path = ExtractFileName(OprosObj->Icon4Path);
                      OprosObj->Icon4Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon4Path;
                      if( !FileExists(OprosObj->Icon4Path) ) OprosObj->Icon4Path = "";
                   }
                }
             }
             OprosObj->Icon5Path = ini->ReadString( str.c_str(), "Icon5Path", "" );
             if( OprosObj->Icon5Path != "" )
             {
                if( !FileExists(OprosObj->Icon5Path) )
                {
                   OprosObj->Icon5Path = ExtractFileName(OprosObj->Icon5Path);
                   OprosObj->Icon5Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon5Path;
                   if( !FileExists(OprosObj->Icon5Path) ) OprosObj->Icon5Path = "";
                }
             }
             OprosObj->Icon6Path = ini->ReadString( str.c_str(), "Icon6Path", "" );
             if( OprosObj->Icon6Path != "" )
             {
                if( !FileExists(OprosObj->Icon6Path) )
                {
                   OprosObj->Icon6Path = ExtractFileName(OprosObj->Icon6Path);
                   OprosObj->Icon6Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon6Path;
                   if( !FileExists(OprosObj->Icon6Path) ) OprosObj->Icon6Path = "";
                }
             }
             OprosObj->Icon7Path = ini->ReadString( str.c_str(), "Icon7Path", "" );
             if( OprosObj->Icon7Path != "" )
             {
                if( !FileExists(OprosObj->Icon7Path) )
                {
                   OprosObj->Icon7Path = ExtractFileName(OprosObj->Icon7Path);
                   OprosObj->Icon7Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon7Path;
                   if( !FileExists(OprosObj->Icon7Path) ) OprosObj->Icon7Path = "";
                }
             }
             OprosObj->Icon8Path = ini->ReadString( str.c_str(), "Icon8Path", "" );
             if( OprosObj->Icon8Path != "" )
             {
                if( !FileExists(OprosObj->Icon8Path) )
                {
                   OprosObj->Icon8Path = ExtractFileName(OprosObj->Icon8Path);
                   OprosObj->Icon8Path = ExtractFilePath(Application->ExeName) + "Icons\\" + OprosObj->Icon8Path;
                   if( !FileExists(OprosObj->Icon8Path) ) OprosObj->Icon8Path = "";
                }
             }
             OprosObj->Dk = ini->ReadBool( str.c_str(), "DK", true );
             OprosObj->Bazalt = ini->ReadBool( str.c_str(), "Bazalt", false );
             OprosObj->Razriv = ini->ReadBool(str.c_str(), "Razriv", false);
             OprosObj->Metka = ini->ReadBool( str.c_str(), "Metka", false );
             if( OprosObj->Metka )
             {
                OprosObj->Metka1Time_0 = ini->ReadInteger( str.c_str(), "Metka1Time_0", 0 );
                OprosObj->Metka1Time_1 = ini->ReadInteger( str.c_str(), "Metka1Time_1", 0 );
                OprosObj->Metka2Time_0 = ini->ReadInteger( str.c_str(), "Metka2Time_0", 0 );
                OprosObj->Metka2Time_1 = ini->ReadInteger( str.c_str(), "Metka2Time_1", 0 );
                OprosObj->Metka3Time_0 = ini->ReadInteger( str.c_str(), "Metka3Time_0", 0 );
                OprosObj->Metka3Time_1 = ini->ReadInteger( str.c_str(), "Metka3Time_1", 0 );
                OprosObj->Metka4Time_0 = ini->ReadInteger( str.c_str(), "Metka4Time_0", 0 );
                OprosObj->Metka4Time_1 = ini->ReadInteger( str.c_str(), "Metka4Time_1", 0 );
                OprosObj->MetkaDopuskTime_0 = ini->ReadInteger( str.c_str(), "MetkaDopuskTime_0", 0 );
                OprosObj->MetkaDopuskTime_1 = ini->ReadInteger( str.c_str(), "MetkaDopuskTime_1", 1 );
             }

             OprosObj->AdamOff = ini->ReadInteger( str.c_str(), "AdamOff", 0 );
             OprosObj->AlarmMsgOn = ini->ReadBool( str.c_str(), "AlarmMsgOn", false );
             OprosObj->ConnectBlock = ini->ReadBool( str.c_str(), "ConnectBlock", false );
             OprosObj->OutType = ini->ReadInteger( str.c_str(), "OutType", 0 );
             OprosObj->asoosd_kk = ini->ReadInteger( str.c_str(), "asoosd_kk", 0 );
             OprosObj->asoosd_nn = ini->ReadInteger( str.c_str(), "asoosd_nn", 0 );
             OprosObj->description = ini->ReadString( str.c_str(), "Description", "" );
             OprosObj->lan = ini->ReadFloat( str.c_str(), "lan", 0.0 );
             OprosObj->lon = ini->ReadFloat( str.c_str(), "lon", 0.0 );
             OprosObj->UdpUse = ini->ReadBool( str.c_str(), "UdpUse", false );
             OprosObj->UdpAdress = ini->ReadString( str.c_str(), "UdpAdress", "" );
             OprosObj->UpdPort = ini->ReadInteger( str.c_str(), "UpdPort", 0 );

             if( OprosObj->Bazalt || OprosObj->ConnectBlock ) OprosObj->Dk = false;

             tempNode = ObjTree->Selected;

             if( OprosObj->Level == tempNode->Level )
             {
                tempNode = ObjTree->Items->AddObject( ObjTree->Selected, OprosObj->Name, OprosObj );
             }
             else if( OprosObj->Level > tempNode->Level )
             {
                if( POprosObj(tempNode->Data)->Type == GroupType )
                {
                   tempNode->SelectedIndex = 16;
                   tempNode->ImageIndex = 16;
                }

                tempNode = ObjTree->Items->AddChildObject( ObjTree->Selected, OprosObj->Name, OprosObj );
             }
             else
             {
                do
                {
                   tempNode = tempNode->Parent;
                   tempNode->Selected = true;
                }while( OprosObj->Level != tempNode->Level );
                tempNode = ObjTree->Items->AddObject( ObjTree->Selected, OprosObj->Name, OprosObj );
             }

             if( OprosObj->Type == GroupType )
             {
                tempNode->SelectedIndex = 15;
                tempNode->ImageIndex = 15;
             }
             else
             {
               if( OprosObj->Type == RifType || OprosObj->Type == SdConcType || OprosObj->Type == RazrivBoType ||
                   OprosObj->Type == TorosType || OprosObj->Type == NastType ||
                   OprosObj->Type == RadarType || OprosObj->Type == TochkaType || OprosObj->Type == RifRlmSType )
               {
                  if( !OprosObj->UdpUse ) RifScnt[OprosObj->Num3-1] += 1;

                     tempNode->SelectedIndex = 6;
                     tempNode->ImageIndex = 6;
               }
               else if( OprosObj->Type == SdIpBlType || OprosObj->Type == IuIpBlType )
               {
                  if( !OprosObj->UdpUse ) RifScnt[OprosObj->Num3-1] += 1;

                  tempNode->SelectedIndex = 6;
                  tempNode->ImageIndex = 6;
               }
               else if( OprosObj->Type == TochkaMBoIdx || OprosObj->Type == SotaMBoIdx )
               {
                  if( !OprosObj->UdpUse ) RifScnt[OprosObj->Num3-1] += 1;

                  tempNode->SelectedIndex = 6;
                  tempNode->ImageIndex = 6;
               }
               else if( OprosObj->Type == TochkaMUchIdx || OprosObj->Type == SotaMUchIdx )
               {
                  tempNode->SelectedIndex = 6;
                  tempNode->ImageIndex = 6;
               }
               else if( OprosObj->Type == TochkaMDdIdx || OprosObj->Type == SotaMDdIdx )
               {
                  tempNode->SelectedIndex = 6;
                  tempNode->ImageIndex = 6;
               }
               else if( OprosObj->Type == SdType || OprosObj->Type == IuType )
               {
                  if( SsoiVersion < 2 )
                  {
                      SsoiScnt += 1;

                      if( SsoiM_PortNum[0] == 0 )
                      {
                         tempNode->SelectedIndex = 5;
                         tempNode->ImageIndex = 5;
                      }
                      else
                      {
                         tempNode->SelectedIndex = 6;
                         tempNode->ImageIndex = 6;
                      }
                  }
                  else if( SsoiVersion == 2 )
                  {
                     SsoiMScnt[OprosObj->Num1-1] += 1;
                     if( OprosObj->Type == SdType ) OprosObj->Type = SsoiMSdType;
                     if( OprosObj->Type == IuType ) OprosObj->Type = SsoiMIuType;

                     if( OprosObj->Num1 == 1 )
                     {
                        if( SsoiM_PortNum[0] == 0 )
                        {
                           tempNode->SelectedIndex = 5;
                           tempNode->ImageIndex = 5;
                        }
                        else
                        {
                           tempNode->SelectedIndex = 6;
                           tempNode->ImageIndex = 6;
                        }
                     }
                     else if( OprosObj->Num1 == 2 )
                     {
                        if( SsoiM_PortNum[1] == 0 )
                        {
                           tempNode->SelectedIndex = 5;
                           tempNode->ImageIndex = 5;
                        }
                        else
                        {
                           tempNode->SelectedIndex = 6;
                           tempNode->ImageIndex = 6;
                        }
                     }
                     else if( OprosObj->Num1 == 3 )
                     {
                        if( SsoiM_PortNum[2] == 0 )
                        {
                           tempNode->SelectedIndex = 5;
                           tempNode->ImageIndex = 5;
                        }
                        else
                        {
                           tempNode->SelectedIndex = 6;
                           tempNode->ImageIndex = 6;
                        }
                     }
                     else if( OprosObj->Num1 == 4 )
                     {
                        if( SsoiM_PortNum[3] == 0 )
                        {
                           tempNode->SelectedIndex = 5;
                           tempNode->ImageIndex = 5;
                        }
                        else
                        {
                           tempNode->SelectedIndex = 6;
                           tempNode->ImageIndex = 6;
                        }
                     }
                  }
                  else if( SsoiVersion == 3 )
                  {
                      SsoiScnt += 1;

                      tempNode->SelectedIndex = 6;
                      tempNode->ImageIndex = 6;
                  }
               }
               else if( OprosObj->Type == SsoiType )
               {
                  GobiTv = true;
                  SsoiScnt += 1;
                  if( SsoiM_PortNum[0] == 0 )
                  {
                     tempNode->SelectedIndex = 25;
                     tempNode->ImageIndex = 25;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 26;
                     tempNode->ImageIndex = 26;
                  }
               }
               else if( OprosObj->Type == Stn485Type )
               {
                  Stn485Tv = true;
                  tempNode->SelectedIndex = 33;
                  tempNode->ImageIndex = 33;
               }
               else if( OprosObj->Type == RastrOldType )
               {
                  S3cnt += 1;

                  if( RastrPortNum == 0 )
                  {
                     tempNode->SelectedIndex = 25;
                     tempNode->ImageIndex = 25;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 26;
                     tempNode->ImageIndex = 26;
                  }
               }
               else if( OprosObj->Type == RastrType || OprosObj->Type == 52 )
               {
                  STN1 = true;

                  if( Server2Use == 0 )
                  {
                     tempNode->SelectedIndex = 25;
                     tempNode->ImageIndex = 25;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 26;
                     tempNode->ImageIndex = 26;
                  }
               }
               else if( OprosObj->Type == SolidType )
               {
                  S4cnt += 1;

                  if( SolidPortNum == 0 )
                  {
                     tempNode->SelectedIndex = 25;
                     tempNode->ImageIndex = 25;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 26;
                     tempNode->ImageIndex = 26;
                  }
               }
               else if( OprosObj->Type == Adam4068Type )
               {
                  S7cnt += 1;

                  A4068Sys->Dev[OprosObj->Num1-1].TreeIdx[OprosObj->Num2] = tempNode->AbsoluteIndex;

                  if( Adam4068PortNum == 0 )
                  {
                     tempNode->SelectedIndex = 5;
                     tempNode->ImageIndex = 5;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 6;
                     tempNode->ImageIndex = 6;
                  }
               }
               else if( OprosObj->Type == TabloType )
               {
                  TabloSys->Use = true;

                  if( TabloPortNum == 0 )
                  {
                     tempNode->SelectedIndex = 5;
                     tempNode->ImageIndex = 5;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 45;
                     tempNode->ImageIndex = 45;
                  }
               }
               else if( OprosObj->Type == StrazhIpType )
               {
                  tempNode->SelectedIndex = 33;
                  tempNode->ImageIndex = 33;
               }
               else if( OprosObj->Type == OnvifTvType )
               {
                  tempNode->SelectedIndex = 33;
                  tempNode->ImageIndex = 33;
               }
               else if( OprosObj->Type == DevLineIdx )
               {
                  tempNode->SelectedIndex = 33;
                  tempNode->ImageIndex = 33;
               }
               else if( OprosObj->Type == NetDevIdx )
               {
                  tempNode->SelectedIndex = 46;
                  tempNode->ImageIndex = 46;
               }
             }
             tempNode->Selected = true;

             if( OprosObj->Type == RifType || OprosObj->Type == RifRlmSType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    if( OprosObj->Type == RifType ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 0;
                    else if( OprosObj->Type == RifRlmSType ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = RifRlmSType;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[0] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Name[0] = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].AlarmMsgOn[0] = OprosObj->AlarmMsgOn;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[0] = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[0] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[0] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[0] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == SdConcType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 1;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[OprosObj->Num2-1] = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[OprosObj->Num2-1] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].DkUse[OprosObj->Num2-1] = POprosObj(tempNode->Data)->Dk;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[OprosObj->Num2-1] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[OprosObj->Num2-1] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[OprosObj->Num2-1] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == RazrivBoType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 6;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[OprosObj->Num2-1] = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[OprosObj->Num2-1] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].DkUse[OprosObj->Num2-1] = POprosObj(tempNode->Data)->Dk;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[OprosObj->Num2-1] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[OprosObj->Num2-1] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[OprosObj->Num2-1] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == TorosType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 2;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[0] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[0] = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[0] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[0] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[0] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == NastType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[0] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[0] = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[0] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[0] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[0] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == RadarType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 5;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[0] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[0] = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[0] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[0] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[0] = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == TochkaType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = 7;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[OprosObj->Num2-1] = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[OprosObj->Num2-1] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Direction[OprosObj->Num2-1] = OprosObj->Metka;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Name[OprosObj->Num2-1] = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].AlarmMsgOn[OprosObj->Num2-1] = OprosObj->AlarmMsgOn;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[OprosObj->Num2-1] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[OprosObj->Num2-1] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[OprosObj->Num2-1] = OprosObj->lon;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   Rif2Sys->Use = true;

                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   if( pos == -1 )
                   {
                     UdpAdress->Add(OprosObj->UdpAdress);
                     pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   }

                   Rif2Sys->Ch[pos].Use = true;
                   Rif2Sys->Ch[pos].Ip = OprosObj->UdpAdress;
                   Rif2Sys->Ch[pos].Port = OprosObj->UpdPort;

                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Type = Tochka_Type;

                   for( int dev = 0; dev < MaxRif2SysDevSize; dev++ )
                   {
                      if( Rif2Sys->Ch[pos].OprosStack[dev] == (OprosObj->Num1-1) ) break;

                      if( Rif2Sys->Ch[pos].OprosStack[dev] < 0  )
                      {
                         Rif2Sys->Ch[pos].OprosStack[dev] = OprosObj->Num1-1;
                         Rif2Sys->Ch[pos].OprosStackCnt += 1;
                         break;
                      }
                   }

                   if(Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd == NULL ) Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd = new TAlarmUnit[MaxTochkaSize];
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd[OprosObj->Num2-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd[OprosObj->Num2-1].TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd[OprosObj->Num2-1].DkUse = OprosObj->Dk;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd[OprosObj->Num2-1].Name = OprosObj->Name;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd[OprosObj->Num2-1].AlarmMsgOn = OprosObj->AlarmMsgOn;
                }
             }
             else if( OprosObj->Type == SdType && ComplexVersion != Rastr_M_SsoiComplexType )
             {
                GobiSys->Kanal[OprosObj->Num1-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].TreeIdx = tempNode->AbsoluteIndex;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Dk = POprosObj(tempNode->Data)->Dk;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Bazalt = POprosObj(tempNode->Data)->Bazalt;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Razriv = POprosObj(tempNode->Data)->Razriv;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Name = OprosObj->Name;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].ConnectBlock = POprosObj(tempNode->Data)->ConnectBlock;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].AlarmMsgOn = OprosObj->AlarmMsgOn;
                if( GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].AlarmMsgOn ) GobiSys->AlarmMsgOn = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].asoosd_kk = OprosObj->asoosd_kk;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].asoosd_nn = OprosObj->asoosd_nn;

                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].description = OprosObj->description;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].lan = OprosObj->lan;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].lon = OprosObj->lon;

                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Metka = POprosObj(tempNode->Data)->Metka;

                TTime dt;

                if( POprosObj(tempNode->Data)->Metka1Time_0 != 0 )
                {
                   dt = EncodeTime((Word)(POprosObj(tempNode->Data)->Metka1Time_0-1), (Word)POprosObj(tempNode->Data)->Metka1Time_1, 0, 0);
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Metka1Time = dt;
                }
                if( POprosObj(tempNode->Data)->Metka2Time_0 != 0 )
                {
                   dt = EncodeTime((Word)(POprosObj(tempNode->Data)->Metka2Time_0-1), (Word)POprosObj(tempNode->Data)->Metka2Time_1, 0, 0);
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Metka2Time = dt;
                }
                if( POprosObj(tempNode->Data)->Metka3Time_0 != 0 )
                {
                   dt = EncodeTime((Word)(POprosObj(tempNode->Data)->Metka3Time_0-1), (Word)POprosObj(tempNode->Data)->Metka3Time_1, 0, 0);
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Metka3Time = dt;
                }
                if( POprosObj(tempNode->Data)->Metka4Time_0 != 0 )
                {
                   dt = EncodeTime((Word)(POprosObj(tempNode->Data)->Metka4Time_0-1), (Word)POprosObj(tempNode->Data)->Metka4Time_1, 0, 0);
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Metka4Time = dt;
                }
                dt = EncodeTime((Word)(POprosObj(tempNode->Data)->MetkaDopuskTime_0), (Word)POprosObj(tempNode->Data)->MetkaDopuskTime_1, 0, 0);
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].MetkaDopuskTime = dt;

                if( GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Bazalt &&
                    OprosObj->Num3 < 4 )
                {
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].Use = true;
                }

                if( GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].ConnectBlock &&
                    OprosObj->Num3 >= 4 && OprosObj->Num3 < 7 )
                {
                   GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-4].Use = true;
                }
             }
             else if( OprosObj->Type == SdType && ComplexVersion == Rastr_M_SsoiComplexType )
             {
                GobiSys->Kanal[OprosObj->Num1-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].TreeIdx = tempNode->AbsoluteIndex;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Dk = POprosObj(tempNode->Data)->Dk;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Bazalt = POprosObj(tempNode->Data)->Bazalt;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Sd[OprosObj->Num3-1].Name = OprosObj->Name;
             }
             else if( OprosObj->Type == SsoiMSdType )
             {
                if( !GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Use )
                {
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].AutoDkDt = Now();
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].AutoDkDt = IncMinute( GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].AutoDkDt, (OprosObj->Num1-1)*10 + OprosObj->Num2 );
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].AutoDkDt = IncHour( GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].AutoDkDt, 4 );
                }
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Use = true;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].Use = true;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].TreeIdx = tempNode->AbsoluteIndex;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].Dk = POprosObj(tempNode->Data)->Dk;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].Bazalt = POprosObj(tempNode->Data)->Bazalt;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].ConnectBlock = POprosObj(tempNode->Data)->ConnectBlock;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].Name = OprosObj->Name;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].asoosd_kk = OprosObj->asoosd_kk;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].asoosd_nn = OprosObj->asoosd_nn;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].AlarmMsgOn = OprosObj->AlarmMsgOn;

                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].description = OprosObj->description;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].lan = OprosObj->lan;
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].lon = OprosObj->lon;

                if( GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Sd[OprosObj->Num3-1].Bazalt )
                {
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].Use = true;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].GobiCam = false;
                }
             }
             else if( OprosObj->Type == IuType )
             {
                GobiSys->Kanal[OprosObj->Num1-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].GobiCam = false;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].TreeIdx = tempNode->AbsoluteIndex;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].Name = OprosObj->Name;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].AutoOff = OprosObj->AdamOff;
             }
             else if( OprosObj->Type == SsoiMIuType )
             {
                GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Use = true;

                if( OprosObj->Num3 < 4 )
                {
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].Use = true;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].GobiCam = false;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].TreeIdx = tempNode->AbsoluteIndex;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].Name = OprosObj->Name;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Iu[OprosObj->Num3-1].AutoOff = OprosObj->AdamOff;
                }
                else
                {
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Vk[OprosObj->Num3-4].Use = true;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Vk[OprosObj->Num3-4].GobiCam = false;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Vk[OprosObj->Num3-4].TreeIdx = tempNode->AbsoluteIndex;
                   GobiSys2->Bl[OprosObj->Num1-1][OprosObj->Num2-1].Vk[OprosObj->Num3-4].Name = OprosObj->Name;
                }
             }
             else if( OprosObj->Type == 41 )
             {
                GobiSys->Kanal[OprosObj->Num1-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].Use = true;
                GobiSys->Kanal[OprosObj->Num1-1].Bl[OprosObj->Num2-1].Iu[OprosObj->Num3-1].GobiCam = true;
             }
             else if( OprosObj->Type == RastrOldType )
             {
                RastrSys->Mon[OprosObj->Num1-1].Use = true;
                RastrSys->Mon[OprosObj->Num1-1].Tv[OprosObj->Num2-1].Use = true;
             }
             else if( OprosObj->Type == Adam4068Type )
             {
                A4068Sys->Dev[OprosObj->Num1-1].Use[OprosObj->Num2] = true;
                A4068Sys->Dev[OprosObj->Num1-1].AdamOff[OprosObj->Num2] = POprosObj(tempNode->Data)->AdamOff;
             }
             else if( OprosObj->Type == SdIpBlType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Type = SdIpBlType;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].InUse[OprosObj->Num2-1] = true;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].TreeIdx[OprosObj->Num2-1] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Name[OprosObj->Num2-1] = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Bazalt[OprosObj->Num2-1] = OprosObj->Bazalt;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].DkUse[OprosObj->Num2-1] = OprosObj->Dk;
                    if( RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Bazalt[OprosObj->Num2-1] )
                    {
                       RifSys->Rk[OprosObj->Num3-1][IpBlIdx].InUse[OprosObj->Num2-1+MaxIpBlSdCnt] = true;
                       RifSys->Rk[OprosObj->Num3-1][IpBlIdx].DkUse[OprosObj->Num2-1] = false;
                    }
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].AlarmMsgOn[OprosObj->Num2-1] = OprosObj->AlarmMsgOn;

                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].description[OprosObj->Num2-1] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].lan[OprosObj->Num2-1] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].lon[OprosObj->Num2-1] = OprosObj->lon;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   Rif2Sys->Use = true;

                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   if( pos == -1 )
                   {
                     UdpAdress->Add(OprosObj->UdpAdress);
                     pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   }

                   Rif2Sys->Ch[pos].Use = true;
                   Rif2Sys->Ch[pos].Ip = OprosObj->UdpAdress;
                   Rif2Sys->Ch[pos].Port = OprosObj->UpdPort;

                   Rif2Sys->Ch[pos].Dev[100].Use = true;
                   Rif2Sys->Ch[pos].Dev[100].Type = BlIp_Type;

                   for( int dev = 0; dev < MaxRif2SysDevSize; dev++ )
                   {
                      if( Rif2Sys->Ch[pos].OprosStack[dev] == 100 ) break;

                      if( Rif2Sys->Ch[pos].OprosStack[dev] < 0  )
                      {
                         Rif2Sys->Ch[pos].OprosStack[dev] = 100;
                         Rif2Sys->Ch[pos].OprosStackCnt += 1;
                         break;
                      }
                   }

                   if(Rif2Sys->Ch[pos].Dev[100].Sd == NULL ) Rif2Sys->Ch[pos].Dev[100].Sd = new TAlarmUnit[MaxBlIpSdSize];
                   if(Rif2Sys->Ch[pos].Dev[100].Iu == NULL ) Rif2Sys->Ch[pos].Dev[100].Iu = new TAlarmUnit[MaxBlIpSdSize];
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].DkUse = OprosObj->Dk;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].Uz = OprosObj->Bazalt;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].Name = OprosObj->Name;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].AlarmMsgOn = OprosObj->AlarmMsgOn;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].description = OprosObj->description;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].lan = OprosObj->lan;
                   Rif2Sys->Ch[pos].Dev[100].Sd[OprosObj->Num2-1].lon = OprosObj->lon;
                }
             }
             else if( OprosObj->Type == IuIpBlType )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Type = SdIpBlType;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].InUse[OprosObj->Num2-1+MaxIpBlSdCnt] = true;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].TreeIdx[OprosObj->Num2-1+MaxIpBlSdCnt] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].Name[OprosObj->Num2-1+MaxIpBlSdCnt] = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][IpBlIdx].AutoOff[OprosObj->Num2-1+MaxIpBlSdCnt] = OprosObj->AdamOff;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   Rif2Sys->Use = true;

                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   if( pos == -1 )
                   {
                     UdpAdress->Add(OprosObj->UdpAdress);
                     pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   }

                   Rif2Sys->Ch[pos].Use = true;
                   Rif2Sys->Ch[pos].Ip = OprosObj->UdpAdress;
                   Rif2Sys->Ch[pos].Port = OprosObj->UpdPort;

                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[100].Type = BlIp_Type;

                   for( int dev = 0; dev < MaxRif2SysDevSize; dev++ )
                   {
                      if( Rif2Sys->Ch[pos].OprosStack[dev] == 100 ) break;

                      if( Rif2Sys->Ch[pos].OprosStack[dev] < 0  )
                      {
                         Rif2Sys->Ch[pos].OprosStack[dev] = 100;
                         Rif2Sys->Ch[pos].OprosStackCnt += 1;
                         break;
                      }
                   }

                   if(Rif2Sys->Ch[pos].Dev[100].Sd == NULL ) Rif2Sys->Ch[pos].Dev[100].Sd = new TAlarmUnit[MaxBlIpSdSize];
                   if(Rif2Sys->Ch[pos].Dev[100].Iu == NULL ) Rif2Sys->Ch[pos].Dev[100].Iu = new TAlarmUnit[MaxBlIpSdSize];
                   Rif2Sys->Ch[pos].Dev[100].Iu[OprosObj->Num2-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[100].Iu[OprosObj->Num2-1].TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[100].Iu[OprosObj->Num2-1].Name = OprosObj->Name;
                   Rif2Sys->Ch[pos].Dev[100].Iu[OprosObj->Num2-1].AlarmMsgOn = OprosObj->AlarmMsgOn;
                }
             }
             else if( OprosObj->Type == TochkaMBoIdx || OprosObj->Type == SotaMBoIdx )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Use = true;
                    if( OprosObj->Type == TochkaMBoIdx ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = TochkaMBoIdx;
                    else RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Type = SotaMBoIdx;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Port = OprosObj->Num3;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].TreeIdx[0] = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Name[0] = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].AlarmMsgOn[0] = OprosObj->AlarmMsgOn;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].InUse[0] = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].AlarmFix[0] = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].description[0] = OprosObj->description;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lan[0] = OprosObj->lan;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].lon[0] = OprosObj->lon;

                    RifMaxErrCnt[OprosObj->Num3-1] = 25;              

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch = new TDd[MaxTochkaMUchCnt];
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd = new TDd[MaxTochkaMDdCnt];
                    for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch[uch].Reset();
                    for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].Reset();

                    newflang1 = 1;
                    newflang3 = 3;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   Rif2Sys->Use = true;

                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   if( pos == -1 )
                   {
                     UdpAdress->Add(OprosObj->UdpAdress);
                     pos = UdpAdress->IndexOf(OprosObj->UdpAdress);
                   }

                   Rif2Sys->Ch[pos].Use = true;
                   Rif2Sys->Ch[pos].Ip = OprosObj->UdpAdress;
                   Rif2Sys->Ch[pos].Port = OprosObj->UpdPort;

                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Use = true;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Type = TochkaMBo_Type;

                   for( int dev = 0; dev < MaxRif2SysDevSize; dev++ )
                   {
                      if( Rif2Sys->Ch[pos].OprosStack[dev] == (OprosObj->Num1-1) ) break;

                      if( Rif2Sys->Ch[pos].OprosStack[dev] < 0  )
                      {
                         Rif2Sys->Ch[pos].OprosStack[dev] = OprosObj->Num1-1;
                         Rif2Sys->Ch[pos].OprosStackCnt += 1;
                         break;
                      }
                   }

                   if(Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd == NULL ) Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd = new TAlarmUnit();
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd->TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Sd->Name = OprosObj->Name;
                }
             }
             else if( OprosObj->Type == TochkaMUchIdx || OprosObj->Type == SotaMUchIdx )
             {
                if( !OprosObj->UdpUse )
                {
                    int flang = OprosObj->Num2/100-1;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch[flang].TreeIdx = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch[flang].Name = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch[flang].AlarmFix = true;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);

                   if(Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch == NULL ) Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch = new TAlarmUnit[MaxTochkaMUchSize];

                   int flang = OprosObj->Num2/100-1;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch[flang].Use = true;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch[flang].TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch[flang].Name = OprosObj->Name;
                }
             }
             else if( OprosObj->Type == TochkaMDdIdx || OprosObj->Type == SotaMDdIdx )
             {
                if( !OprosObj->UdpUse )
                {
                    RifSys->Use = true;

                    int flang = OprosObj->Num2/100;
                    int dd = OprosObj->Num2%100;

                    if( flang >= 3 )
                    {
                       if( OprosObj->Type == TochkaMDdIdx ) dd += 26;
                       else dd += 100;
                    }

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch[flang-1].Use = true;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].FlangNum = flang;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].TreeIdx = tempNode->AbsoluteIndex;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].Name = OprosObj->Name;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].Use = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].AlarmFix = true;
                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Dd[dd].AlarmMsgOn = OprosObj->AlarmMsgOn;

                    if( newflang1 == 1 && flang == 2 )
                    {
                       RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch2StartAdr = dd+1;
                       newflang1 = 2;
                    }

                    if( newflang3 == 3 && flang == 4 )
                    {
                       if( OprosObj->Type == TochkaMDdIdx ) RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch4StartAdr = (dd-26)+1;
                       else RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].Uch4StartAdr = (dd-100)+1;
                       newflang3 = 4;
                    }

                    int num31 = dd%8;
                    if( OprosObj->Type == TochkaMDdIdx && OprosObj->Num2 >= 300 ) num31 = (dd+6)%8;
                    if( OprosObj->Type == SotaMDdIdx && OprosObj->Num2 >= 300 ) num31 = (dd+4)%8;
                    int num41 = dd/8;
                    if( OprosObj->Type == TochkaMDdIdx && OprosObj->Num2 >= 300 ) num41 = (dd+6)/8;
                    if( OprosObj->Type == SotaMDdIdx && OprosObj->Num2 >= 300 ) num41 = (dd+4)/8;
                    int num51 = 1<<num31;

                    RifSys->Rk[OprosObj->Num3-1][OprosObj->Num1-1].BO_cfg[num41] |= num51;
                }
                else if( OprosObj->UdpAdress != "" && OprosObj->UpdPort > 0 )
                {
                   int pos = UdpAdress->IndexOf(OprosObj->UdpAdress);

                   if(Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Dd == NULL ) Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Dd = new TAlarmUnit[MaxTochkaMDdSize];

                   int flang = OprosObj->Num2/100;
                   int dd = OprosObj->Num2%100;

                   if( flang >= 3 )
                   {
                     if( OprosObj->Type == TochkaMDdIdx ) dd += 26;
                     else dd += 100;
                   }

                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Dd[dd].Use = true;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Dd[dd].TreeIdx = tempNode->AbsoluteIndex;
                   Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Dd[dd].Name = OprosObj->Name;

                   if( newflang1 == 1 && flang == 2 )
                   {
                     Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch2StartAdr = dd+1;
                     newflang1 = 2;
                   }

                    if( newflang3 == 3 && flang == 4 )
                    {
                       if( OprosObj->Type == TochkaMDdIdx ) Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch4StartAdr = (dd-26)+1;
                       else Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].Uch4StartAdr = (dd-100)+1;
                       newflang3 = 4;
                    }

                    int num31 = dd%8;
                    if( OprosObj->Type == TochkaMDdIdx && OprosObj->Num2 >= 300 ) num31 = (dd+6)%8;
                    if( OprosObj->Type == SotaMDdIdx && OprosObj->Num2 >= 300 ) num31 = (dd+4)%8;
                    int num41 = dd/8;
                    if( OprosObj->Type == TochkaMDdIdx && OprosObj->Num2 >= 300 ) num41 = (dd+6)/8;
                    if( OprosObj->Type == SotaMDdIdx && OprosObj->Num2 >= 300 ) num41 = (dd+4)/8;
                    int num51 = 1<<num31;

                    Rif2Sys->Ch[pos].Dev[OprosObj->Num1-1].BO_cfg[num41] |= num51;

                }
             }
         }
      }
   }

   for( int kan = 0; kan < RifKanCnt; kan++ )
   {
      for( int i = 0; i < RifDevCnt; i++ )
      {
         if( RifSys->Rk[kan][i].Use )
         {
            RifPortNum[kan] = RifSys->Rk[kan][i].Port;

            RifSys->OprosAdr[kan][RifSys->OprosCnt[kan]] = i+1;
            RifSys->OprosCnt[kan] += 1;
            RifSys->Opros[kan] = true;
         }
      }
      if( RifSys->OprosCnt[kan] > 0 ) RifBazaltCnt[kan] = MaxRifBazaltCnt/(RifSys->OprosCnt[kan]);

      if( RifScnt[kan] > 0 ) RifMaxErrCnt[kan] = RifMaxErrCnt[kan]/RifSys->OprosCnt[kan];
      if( RifMaxErrCnt[kan] < MaxErrCnt ) RifMaxErrCnt[kan] = MaxErrCnt;
   }

   int k = 0;
   for( int kan = 0; kan < KanCnt; kan++ )
   {
       k = 0;
       for( int i = 0; i < BlCnt; i++ )
       {
          if( GobiSys2->Bl[kan][i].Use )
          {
             GobiSys2->OprosAdr[kan][k] = i+1;
             k += 1;
          }
       }
   }

   for( int kan = 0; kan < KanCnt; kan++ )
   {
       k = 0;
       for( int bl = 0; bl < BlCnt; bl++ )
       {
          if( GobiSys->Kanal[kan].Bl[bl].Use )
          {
             GobiSys->OprosAdr[kan][k] = bl;
             k += 1;
          }
       }
   }

   for( int i = 0; i < DevCnt4068; i++ )
   {
      for( int j = 0; j < OutCnt4068; j++ )
      {
         if( A4068Sys->Dev[i].Use[j] )
         {
            A4068Sys->Use[k] = i+1;
            k = k + 1;
            break;
         }
      }
   }

   tempNode = ObjTree->TopItem;
   tempNode->Selected = true;
   ObjTree->Items->EndUpdate();

   if( RastrPortNum != 0 && S3cnt > 0 )
   {
      PRastrObj  RastrObj;
      RastrTree->Items->BeginUpdate();
      RastrTree->Items->Clear();
      for( int mon = 0; mon < MonCnt; mon++ )
      {
         if( RastrSys->Mon[mon].Use )
         {
            RastrObj = new TRastrObj;
            RastrObj->Type = 0;
            RastrObj->Num1 = mon+1;
            RastrObj->Num2 = 0;
            str.sprintf("Монитор %d", RastrObj->Num1);

            tempNode = RastrTree->Selected;
            if( tempNode != NULL )
               if( tempNode->Level != 0 ) tempNode = tempNode->Parent;
            tempNode = RastrTree->Items->AddObject( RastrTree->Selected, str, RastrObj );
            if( RastrPortNum == 0 )
            {
               tempNode->SelectedIndex = 27;
               tempNode->ImageIndex = 27;
            }
            else
            {
               tempNode->SelectedIndex = 28;
               tempNode->ImageIndex = 28;
            }
            tempNode->Selected = true;

            for( int tv = 0; tv < TvCnt; tv++ )
            {
               if( RastrSys->Mon[mon].Tv[tv].Use )
               {
                  RastrObj = new TRastrObj;
                  RastrObj->Type = 1;
                  RastrObj->Num1 = mon+1;
                  RastrObj->Num2 = tv+1;
                  str.sprintf("Камера %d", (RastrObj->Num2-1));

                  tempNode = RastrTree->Items->AddChildObject( RastrTree->Selected, str, RastrObj );
                  if( RastrPortNum == 0 )
                  {
                     tempNode->SelectedIndex = 25;
                     tempNode->ImageIndex = 25;
                  }
                  else
                  {
                     tempNode->SelectedIndex = 26;
                     tempNode->ImageIndex = 26;
                  }
               }
            }
         }
      }
      RastrTree->Items->EndUpdate();
   }
   else
   {
      GroupBox7->Visible = false;
      GroupBox7->Enabled = false;
   }

   delete ini;

   ObjTree->FullCollapse();

   return true;
}
//---------------------------------------------------------------------------
bool TMainForm::SaveLangConfig( AnsiString fp )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   ini->WriteString( "OWINDOWS", "pfrm_Caption", "Подождите" );
   ini->WriteString( "OWINDOWS", "pfrm_Label1_Caption", "Загрузка данных..." );

   ini->WriteString( "OWINDOWS", "RestoreDlg_Caption", "Восстановление из резервной копии..." );
   ini->WriteString( "OWINDOWS", "RestoreDlg_Label1_Caption", "Файл архива" );
   ini->WriteString( "OWINDOWS", "RestoreDlg_Button1_Caption", "Найти" );
   ini->WriteString( "OWINDOWS", "RestoreDlg_OKBtn_Caption", "OK" );
   ini->WriteString( "OWINDOWS", "RestoreDlg_CancelBtn_Caption", "Отмена" );

   ini->WriteString( "MAINFORM", "CAPTION", "Сервер" );

   ini->WriteString( "MAINFORM", "ZhurnalItemsCaption", "Журнал" );
   ini->WriteString( "MAINFORM", "ZhurnalToDbItemCaption", "Новая смена" );
   ini->WriteString( "MAINFORM", "ZhurnalToDbItemHint", "Начать новую смену" );
   ini->WriteString( "MAINFORM", "ZhurnalPrintItemCaption", "Печать" );
   ini->WriteString( "MAINFORM", "ZhurnalPrintItemHint", "Вывод на печать журнала событий" );
   ini->WriteString( "MAINFORM", "ZhurnalPrintViewItemCaption", "Предварительный просмотр" );
   ini->WriteString( "MAINFORM", "ZhurnalPrintViewItemHint", "Предварительный просмотр журнала событий" );
   ini->WriteString( "MAINFORM", "SpoolerClearItemCaption", "Очистить очередь печати" );
   ini->WriteString( "MAINFORM", "SpoolerClearItemHint", "Очистить очередь печати" );
   ini->WriteString( "MAINFORM", "DbItemCaption", "База данных" );
   ini->WriteString( "MAINFORM", "DbItemHint", "Просмотр базы данных" );
   ini->WriteString( "MAINFORM", "N20Caption", "Размер шрифта в журнале" );
   ini->WriteString( "MAINFORM", "N18Caption", "Увеличить" );
   ini->WriteString( "MAINFORM", "N19Caption", "Уменьшить" );
   ini->WriteString( "MAINFORM", "ExitItemCaption", "Выход" );
   ini->WriteString( "MAINFORM", "ExitItemHint", "Завершение работы и выход из программы" );

   ini->WriteString( "MAINFORM", "AlarmItemsCaption", "Сигнализация" );
   ini->WriteString( "MAINFORM", "SoundResetItemCaption", "Сброс звука" );
   ini->WriteString( "MAINFORM", "SoundResetItemHint", "Сброс звуковой сигнализации" );
   ini->WriteString( "MAINFORM", "AlarmResetItemCaption", "Сброс тревог" );
   ini->WriteString( "MAINFORM", "AlarmResetItemHint", "Сброс тревожной сигнализации" );
   ini->WriteString( "MAINFORM", "SoundSetupItemCaption", "Звук" );
   ini->WriteString( "MAINFORM", "SoundSetupItemHint", "Выбор звукового устройства" );
   ini->WriteString( "MAINFORM", "ScItemCaption", "Звуковая карта" );
   ini->WriteString( "MAINFORM", "SdItemCaption", "Системный динамик" );

   ini->WriteString( "MAINFORM", "ControlItems", "Управление" );
   ini->WriteString( "MAINFORM", "ControlItemCaption", "Контроль" );
   ini->WriteString( "MAINFORM", "ControlItemHint", "Снять с контроля/поставить под контроль объект" );
   ini->WriteString( "MAINFORM", "DkItemCaption", "ДК" );
   ini->WriteString( "MAINFORM", "DkItemHint", "Выполнить команду ДК" );
   ini->WriteString( "MAINFORM", "GobiDkItemCaption", "ССОИ" );
   ini->WriteString( "MAINFORM", "GobiDkItemHint", "Выполнить команду ДК для подсистемы ССОИ" );
   ini->WriteString( "MAINFORM", "GobiDkKanalsItem", "Все каналы" );
   ini->WriteString( "MAINFORM", "GobiDkKan1Item", "Канал 1" );
   ini->WriteString( "MAINFORM", "GobiDkKan2Item", "Канал 2" );
   ini->WriteString( "MAINFORM", "GobiDkKan3Item", "Канал 3" );
   ini->WriteString( "MAINFORM", "GobiDkKan4Item", "Канал 4" );

   ini->WriteString( "MAINFORM", "HelpItemsCaption", "Помощь" );
   ini->WriteString( "MAINFORM", "HelpItemCaption", "Справка" );
   ini->WriteString( "MAINFORM", "HelpItemHint", "Вызов справки" );
   ini->WriteString( "MAINFORM", "AboutItemCaption", "О программе..." );

   ini->WriteString( "MAINFORM", "GroupBox1Caption", "Дерево объектов" );
   ini->WriteString( "MAINFORM", "GroupBox5Caption", "Выполнение команды УЗ Монолит" );

   ini->WriteString( "MAINFORM", "GroupBox7Caption", "РАСТР" );

   ini->WriteString( "MAINFORM", "GroupBox3Caption", "Журнал событий" );

   ini->WriteString( "MAINFORM", "DBGrid1Columns1TitleCaption", "Дата, время" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns2TitleCaption", "Событие" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns3TitleCaption", "Объект" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns4TitleCaption", "Причина" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns5TitleCaption", "Принятые меры" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns6TitleCaption", "Оператор" );
   ini->WriteString( "MAINFORM", "DBGrid1Columns7TitleCaption", "Клиент" );

   ini->WriteString( "MAINFORM", "GroupBox6Caption", "Причины и принятые меры" );
   ini->WriteString( "MAINFORM", "Label10Caption", "Причины" );
   ini->WriteString( "MAINFORM", "Label13Caption", "Принятые меры" );

   ini->WriteString( "MSGSTRING", "ErrorMsg", "Ошибка" );
   ini->WriteString( "MSGSTRING", "WarningMsg", "Предупреждение" );
   ini->WriteString( "MSGSTRING", "MsgStr1", "Ошибка загрузки конфигурации!" );
   ini->WriteString( "MSGSTRING", "MsgStr2", "Ошибка загрузки плана!" );
   ini->WriteString( "MSGSTRING", "MsgStr3", "Отсутствует рабочий каталог программы!" );
   ini->WriteString( "MSGSTRING", "MsgStr4", "Ошибка создания баз данных!" );
   ini->WriteString( "MSGSTRING", "MsgStr5", "Ошибка определения сетевых параметров. Запуск сервера невозможен!" );
   ini->WriteString( "MSGSTRING", "MsgStr6", "Ошибка выделения памяти для данных обмена!" );
   ini->WriteString( "MSGSTRING", "MsgStr7", "В файле конфигурации отсутствует информация об операторах комплекса!" );
   ini->WriteString( "MSGSTRING", "MsgStr8", "Ошибка открытия COM-порта, к которому подключена подсистема ССОИ. Опрос датчиков по этому порту производится не будет!" );
   ini->WriteString( "MSGSTRING", "MsgStr9", "Ошибка открытия COM-порта, к которому подключена подсистема РАСТР. Управление ТВ-камерами производится не будет!" );
   ini->WriteString( "MSGSTRING", "MsgStr10", "Ошибка выбора оператора комплекса!" );
   ini->WriteString( "MSGSTRING", "MsgStr11", "Не найдено устройство ESE-U485 с серийным номером:" );
   ini->WriteString( "MSGSTRING", "MsgStr12", "Завершить работу и выйти из программы?" );
   ini->WriteString( "MSGSTRING", "MsgStr13", "Вставьте ключ администратора и нажмите OK." );
   ini->WriteString( "MSGSTRING", "MsgStr14", "Ключ администратора не найден!" );
   ini->WriteString( "MSGSTRING", "MsgStr15", "Убрать контроль?" );
   ini->WriteString( "MSGSTRING", "MsgStr16", "Восстановить контроль?" );
   ini->WriteString( "MSGSTRING", "MsgStr17", "Начать новую смену?" );
   ini->WriteString( "MSGSTRING", "MsgStr18", "Ошибка открытия БД. Закройте модуль База данных!" );
   ini->WriteString( "MSGSTRING", "MsgStr19", "Причина не задана!" );
   ini->WriteString( "MSGSTRING", "MsgStr20", "Принятые меры не заданы!" );
   ini->WriteString( "MSGSTRING", "MsgStr21", "Поиск устройств ESE-U485" );
   ini->WriteString( "MSGSTRING", "MsgStr22", "Ошибка при запуске программы. Восстановите конфигурацию!" );
   ini->WriteString( "MSGSTRING", "MsgStr23", "Оператор" );
   ini->WriteString( "MSGSTRING", "MsgStr24", "Не заполнены все обязательные поля в базе данных!" );
   ini->WriteString( "MSGSTRING", "MsgStr25", "Система" );
   ini->WriteString( "MSGSTRING", "MsgStr26", "Группа" );
   ini->WriteString( "MSGSTRING", "MsgStr27", "Канал" );
   ini->WriteString( "MSGSTRING", "MsgStr28", "БЛ" );
   ini->WriteString( "MSGSTRING", "MsgStr29", "СД" );
   ini->WriteString( "MSGSTRING", "MsgStr30", "ИУ" );
   ini->WriteString( "MSGSTRING", "MsgStr31", "ВК" );
   ini->WriteString( "MSGSTRING", "MsgStr32", "Вскрытие" );
   ini->WriteString( "MSGSTRING", "MsgStr33", "ТВ-камера" );
   ini->WriteString( "MSGSTRING", "MsgStr34", "Монитор" );
   ini->WriteString( "MSGSTRING", "MsgStr35", "РАСТР" );
   ini->WriteString( "MSGSTRING", "MsgStr36", "РАСТР-М-ТВ" );
   ini->WriteString( "MSGSTRING", "MsgStr37", "РАСТР (аналогов.)" );
   ini->WriteString( "MSGSTRING", "MsgStr38", "Инф. табло" );

   ini->WriteString( "TABLE1STRINGS", "Table1Str1", "Неопр. сост." );
   ini->WriteString( "TABLE1STRINGS", "Table1Str2", "Норма" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str3", "Ком. ДК выполнена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str4", "Ком. упр. выполнена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str5", "Нет связи" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str6", "Ком. ДК не выполнена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str7", "Ком. упр. не выполнена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str8", "Тревога-СРАБОТКА" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str9", "Тревога-ВСКРЫТИЕ" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str10", "Тревога-КОНФ. ИЗМ." );
   ini->WriteString( "TABLE1STRINGS", "Table1Str11", "Выкл" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str12", "Вкл" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str13", "Закрыто" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str14", "Открыто" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str15", "Послана ком. Вкл" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str16", "Послана ком. Выкл" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str17", "Послана ком. ДК" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str18", "Послана ком. Сброс тревог" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str19", "Контроль выкл." );
   ini->WriteString( "TABLE1STRINGS", "Table1Str20", "Контроль вкл." );
   ini->WriteString( "TABLE1STRINGS", "Table1Str21", "Послана ком. Вкл все" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str22", "Послана ком. Выкл все" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str23", "Послана ком. Открыть" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str24", "Послана ком. Закрыть" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str25", "Программа запущена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str26", "Программа остановлена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str27", "Начата новая смена" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str28", "Закрыто ключом" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str29", "Открыто ключом" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str30", "Исходящий вызов" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str32", "Входящий вызов" );
   ini->WriteString( "TABLE1STRINGS", "Table1Str33", "Аварийное завершение" );

   ini->WriteString( "SETSOBSTRINGS", "SetSobStr01", "Новая смена" );
   ini->WriteString( "SETSOBSTRINGS", "SetSobStr02", "Оператор" );
   ini->WriteString( "SETSOBSTRINGS", "SetSobStr03", "Система ССОИ" );
   ini->WriteString( "SETSOBSTRINGS", "SetSobStr04", "Канал" );
   ini->WriteString( "SETSOBSTRINGS", "SetSobStr05", "БЛ" );
   ini->WriteString( "SETSOBSTRINGS", "SetSobStr06", "Выполнен сброс тревог" );

   ini->WriteString( "POPUPMENU1", "PupStr1", "Включить/Выключить" );
   ini->WriteString( "POPUPMENU1", "PupStr2", "Включить" );
   ini->WriteString( "POPUPMENU1", "PupStr3", "Выключить" );
   ini->WriteString( "POPUPMENU1", "PupStr4", "Открыть" );
   ini->WriteString( "POPUPMENU1", "PupStr5", "Закрыть" );
   ini->WriteString( "POPUPMENU1", "PupStr6", "ДК" );
   ini->WriteString( "POPUPMENU1", "PupStr7", "Выключить все" );
   ini->WriteString( "POPUPMENU1", "PupStr8", "Контроль" );

   ini->WriteString( "POPUPMENU2", "PupStr9", "Добавить" );
   ini->WriteString( "POPUPMENU2", "PupStr10", "Удалить" );

   ini->WriteString( "PLAN", "PlanCaption", "План" );
   ini->WriteString( "PLAN", "PlanWarning", "Файл плана не загружен!" );
   ini->WriteString( "PLAN", "PlanStr1", "Размер плана:" );
   ini->WriteString( "PLAN", "PlanStr2", "Файл плана:" );

   ini->WriteString( "DB", "MainCaption", "База данных" );
   ini->WriteString( "DB", "FileItemsCaption", "Файл" );
   ini->WriteString( "DB", "MySQLConnectItemCaption", "Подключение к БД" );
   ini->WriteString( "DB", "ExitItemCaption", "Выход" );

   ini->WriteString( "DB", "GroupBox1Caption", "Выбор данных" );
   ini->WriteString( "DB", "Label1Caption", "Тип данных" );
   ini->WriteString( "DB", "InfoStr7", "Все смены" );
   ini->WriteString( "DB", "InfoStr8", "По параметрам" );
   ini->WriteString( "DB", "Label4Caption", "Период с" );
   ini->WriteString( "DB", "Label5Caption", "по" );
   ini->WriteString( "DB", "Label6Caption", "Объект" );
   ini->WriteString( "DB", "InfoStr9", "Все" );
   ini->WriteString( "DB", "InfoStr10", "СД" );
   ini->WriteString( "DB", "InfoStr11", "ИУ" );
   ini->WriteString( "DB", "InfoStr12", "РИФ-РЛМ(КРЛ), Трасса" );
   ini->WriteString( "DB", "InfoStr13", "СД концентратора" );
   ini->WriteString( "DB", "InfoStr14", "Торос" );
   ini->WriteString( "DB", "InfoStr15", "Наст" );
   ini->WriteString( "DB", "InfoStr16", "Радар" );
   ini->WriteString( "DB", "InfoStr17", "Разрыв БО" );
   ini->WriteString( "DB", "InfoStr18", "Точка/Гарда" );
   ini->WriteString( "DB", "InfoStr19", "Адам-406x/4168" );
   ini->WriteString( "DB", "InfoStr20", "СД БЛ-IP" );
   ini->WriteString( "DB", "InfoStr21", "ИУ БЛ-IP" );
   ini->WriteString( "DB", "Label7Caption", "Событие" );
   ini->WriteString( "DB", "InfoStr22", "Тревоги" );
   ini->WriteString( "DB", "InfoStr23", "Неисправности" );
   ini->WriteString( "DB", "InfoStr24", "Команды" );
   ini->WriteString( "DB", "Button1Caption", "Выбрать" );
   ini->WriteString( "DB", "Button2Caption", "Предварительный просмотр" );
   ini->WriteString( "DB", "Button3Caption", "Печать" );
   ini->WriteString( "DB", "Label2Caption", "Причины" );
   ini->WriteString( "DB", "Label3Caption", "Принятые меры" );
   ini->WriteString( "DB", "InfoStr1", "Соединение с сервером баз данных MySQL успешно!" );
   ini->WriteString( "DB", "InfoStr2", "Ошибка соединения с сервером баз данных MySQL!" );
   ini->WriteString( "DB", "InfoStr3", "Код ошибки" );
   ini->WriteString( "DB", "InfoStr4", "Cообщение" );
   ini->WriteString( "DB", "InfoStr5", "Данные с заданными параметрами не найдены!" );
   ini->WriteString( "DB", "InfoStr6", "Ошибка записи в таблицу" );
   ini->WriteString( "DB", "InfoStr25", "Сервер БД" );
   ini->WriteString( "DB", "InfoStr26", "Порт" );
   ini->WriteString( "DB", "InfoStr27", "База данных" );
   ini->WriteString( "DB", "InfoStr28", "Логин" );
   ini->WriteString( "DB", "InfoStr29", "Пароль" );
   ini->WriteString( "DB", "InfoStr29", "Пароль" );
   ini->WriteString( "DB", "InfoStr30", "Отчет" );
   ini->WriteString( "DB", "InfoStr31", "подпись" );
   ini->WriteString( "DB", "InfoStr32", "ФИО" );
   ini->WriteString( "DB", "InfoStr33", "дата,время создания" );
   ini->WriteString( "DB", "InfoStr34", "В файле RIFX.INI не задано имя базы данных!" );
   ini->WriteString( "DB", "InfoStr35", "В файле RIFX.INI не задано имя сервера!" );
   ini->WriteString( "DB", "InfoStr36", "В файле RIFX.INI не задан логин!" );
   ini->WriteString( "DB", "InfoStr37", "В файле RIFX.INI не задан пароль!" );

   ini->WriteString( "ABOUTDLG", "AboutDlgStr1", "Комплекс сигнализационный КС-205К" );
   ini->WriteString( "ABOUTDLG", "AboutDlgStr2", "Комплекс РАСТР-М-ССОИ" );
   ini->WriteString( "ABOUTDLG", "AboutDlgStr3", "РИФ+" );

   ini->WriteString( "OPERATORSDLG", "OperatorsDlgCaption", "Выбор оператора комплекса" );
   ini->WriteString( "OPERATORSDLG", "OperatorsDlgLabel1Caption", "ФИО оператора" );
   ini->WriteString( "OPERATORSDLG", "OperatorsDlgLabel2Caption", "Пароль" );

   ini->WriteString( "MCFG", "Caption", "Настройка комплекса" );
   ini->WriteString( "MCFG", "FileItemsCaption", "Файл" );
   ini->WriteString( "MCFG", "FileNewCaption", "Создать" );
   ini->WriteString( "MCFG", "FileOpenCaption", "Открыть" );
   ini->WriteString( "MCFG", "FileSaveCaption", "Сохранить" );

   ini->WriteString( "MCFG", "PlanGroupBoxCaption", "План и звук" );
   ini->WriteString( "MCFG", "SpeedButton7Hint", "Открыть файл плана"  );
   ini->WriteString( "MCFG", "SpeedButton8Hint", "Закрыть файл плана" );
   ini->WriteString( "MCFG", "Label65Caption", "Источник звук. сигнализации" );
   ini->WriteString( "MCFG", "MCFGInfoStr1", "Звуковая карта" );
   ini->WriteString( "MCFG", "MCFGInfoStr2", "Системный динамик" );
   ini->WriteString( "MCFG", "MCFGInfoStr3", "Без звука" );

   ini->WriteString( "MCFG", "ObjGroupBoxCaption", "Объект" );
   ini->WriteString( "MCFG", "GroupBox2Caption", "Параметры" );
   ini->WriteString( "MCFG", "Label36Caption", "Тип" );
   ini->WriteString( "MCFG", "Label1Caption", "Имя" );
   ini->WriteString( "MCFG", "BitBtn1Caption", "Добавить" );
   ini->WriteString( "MCFG", "BitBtn2Caption", "Удалить" );
   ini->WriteString( "MCFG", "BitBtn3Caption", "Найти" );
   ini->WriteString( "MCFG", "BitBtn10Caption", "Переименовать" );
   ini->WriteString( "MCFG", "BitBtn4Caption", "Вверх" );
   ini->WriteString( "MCFG", "BitBtn5Caption", "Вниз" );

   ini->WriteString( "MCFG", "GroupBox24Caption", "Список операторов" );
   ini->WriteString( "MCFG", "Label48Caption", "Режим" );
   ini->WriteString( "MCFG", "MCFGInfoStr17", "С операторами" );
   ini->WriteString( "MCFG", "MCFGInfoStr18", "Без операторов" );
   ini->WriteString( "MCFG", "MCFGInfoStr19", "Фамилия" );
   ini->WriteString( "MCFG", "MCFGInfoStr20", "Имя" );
   ini->WriteString( "MCFG", "MCFGInfoStr21", "Отчество" );
   ini->WriteString( "MCFG", "MCFGInfoStr22", "Пароль" );
   ini->WriteString( "MCFG", "Button5Caption", "Изменить" );

   ini->WriteString( "MCFG", "GroupBox3Caption", "Иконки событий" );
   ini->WriteString( "MCFG", "MCFGInfoStr26", "Сработка" );
   ini->WriteString( "MCFG", "MCFGInfoStr27", "Вскрытие" );
   ini->WriteString( "MCFG", "MCFGInfoStr28", "Нет связи" );
   ini->WriteString( "MCFG", "MCFGInfoStr29", "Ошибка ДК" );
   ini->WriteString( "MCFG", "MCFGInfoStr62", "Неисправность линии" );

   ini->WriteString( "MCFG", "GroupBox10Caption", "ССОИ" );
   ini->WriteString( "MCFG", "MCFGInfoStr31", "ССОИ-М" );
   ini->WriteString( "MCFG", "MCFGInfoStr30", "ССОИ" );
   ini->WriteString( "MCFG", "Label63Caption", "Скорость обмена" );
   ini->WriteString( "MCFG", "MCFGInfoStr63", "Порт" );
   ini->WriteString( "MCFG", "Label53Caption", "Интервал опроса, мсек"  );
   ini->WriteString( "MCFG", "Label54Caption", "Кол-во запросов" );

   ini->WriteString( "MCFG", "GroupBox1Caption", "Фиксация новых событий (только для ССОИ)" );
   ini->WriteString( "MCFG", "RadioButton1Caption", "Всегда" );
   ini->WriteString( "MCFG", "RadioButton2aption", "Только после Сброса тревог" );

   ini->WriteString( "MCFG", "RadioButton2aption", "Только после \"Сброса тревог\"" );
   ini->WriteString( "MCFG", "Label34Caption", "Сервер" );
   ini->WriteString( "MCFG", "BitBtn11Caption", "Определить" );
   ini->WriteString( "MCFG", "Label47Caption", "Интервал \"Я жив\", сек" );

   ini->WriteString( "MCFG", "GroupBox14Caption", "Интеграция с внешним ПО" );

   ini->WriteString( "MCFG", "GroupBox12Caption", "Сервер MySQL" );
   ini->WriteString( "MCFG", "MCFGInfoStr64", "Логин" );
   ini->WriteString( "MCFG", "Button1Caption", "Подключиться" );
   ini->WriteString( "MCFG", "Label15Caption", "Режим работы клиента" );
   ini->WriteString( "MCFG", "ComboBox11Item0", "Без управления" );
   ini->WriteString( "MCFG", "ComboBox11Item1", "С управлением" );
   ini->WriteString( "MCFG", "CheckBox2Caption", "Обязательное заполнение причин" );
   ini->WriteString( "MCFG", "CheckBox3Caption", "Обязательное заполнение принятых мер" );

   ini->WriteString( "MCFG", "GroupBox4Caption", "Резервное копирование" );
   ini->WriteString( "MCFG", "Label24Caption", "Путь к резервной копии" );
   ini->WriteString( "MCFG", "Label25Caption", "Макс. кол-во записей" );

   ini->WriteString( "MCFG", "Dk_pdiCaption", "Выполнять команду ДК" );
   ini->WriteString( "MCFG", "Bazalt_pdiCaption", "УЗ Монолит" );
   ini->WriteString( "MCFG", "Razriv11_pdiCaption", "Разрыв - Датчик №1 первого фланга" );
   ini->WriteString( "MCFG", "Razriv12_pdiCaption", "Разрыв - Датчик №2 первого фланга" );
   ini->WriteString( "MCFG", "Razriv21_pdiCaption", "Разрыв - Датчик №1 второго фланга" );
   ini->WriteString( "MCFG", "Razriv22_pdiCaption", "Разрыв - Датчик №2 второго фланга" );

   ini->WriteString(  "MCFG", "OpenPictureDialog1Title", "Открыть файл иконки" );
   ini->WriteString(  "MCFG", "OpenPictureDialog2Title", "Открыть файл плана" );
   ini->WriteString(  "MCFG", "OpenDialog1Title", "Открыть файл настроек" );
   ini->WriteString(  "MCFG", "OpenDialog2Title", "Открыть файл настроек \"РАСТР-М-ТВ\"" );
   ini->WriteString(  "MCFG", "SaveDialog1Title", "Сохранить файл настроек" );

   ini->WriteString(  "MCFG", "MCFGInfoStr55", "Отображение иконки на плане" );
   ini->WriteString(  "MCFG", "MCFGInfoStr67", "Пользователь БД" );
   ini->WriteString(  "MCFG", "MCFGInfoStr68", "Доступ" );
   ini->WriteString(  "MCFG", "MCFGInfoStr69", "Использовать" );
   ini->WriteString(  "MCFG", "MCFGInfoStr70", "Клиент" );
   ini->WriteString(  "MCFG", "MCFGInfoStr71", "Сетевой" );
   ini->WriteString(  "MCFG", "MCFGInfoStr72", "Локальный" );
   ini->WriteString(  "MCFG", "MCFGInfoStr73", "Пользователя root изменить или удалить нельзя!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr74", "Ошибка создания базы данных" );
   ini->WriteString(  "MCFG", "MCFGInfoStr75", "База данных создана!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr76", "База данных будет удалена и все данные утеряны. Удалить базу данных?" );
   ini->WriteString(  "MCFG", "MCFGInfoStr77", "Ошибка удаления базы данных" );
   ini->WriteString(  "MCFG", "MCFGInfoStr78", "База данных удалена!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr79", "Не задана фамилия оператора!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr80", "Не задан пароль оператора!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr81", "Такой оператор уже существует!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr82", "Повторный ввод" );
   ini->WriteString(  "MCFG", "MCFGInfoStr83", "Ошибка задания пароля!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr84", "Пароль пользователя задан!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr85", "Ошибка создания нового пользователя БД!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr86", "Новый пользователь БД создан!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr87", "Не задан логин!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr88", "Ошибка удаления пользователя БД!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr89", "Пользователь БД удален!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr90", "Не задано имя ТВ-камеры!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr91", "Такой объект уже существует!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr92", "Не определено устройство!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr93", "Этот порт уже используется!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr94", "Не задано имя объекта!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr95", "Объект не найден!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr96", "Ошибка определения сетевых параметров. Запуск сервера невозможен!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr97", "Файл rastrmtv_cfg.ini не найден!" );
   ini->WriteString(  "MCFG", "MCFGInfoStr98", "ТВ" );
   ini->WriteString(  "MCFG", "MCFGInfoStr99", "Каталог не найден" );
   ini->WriteString(  "MCFG", "MCFGInfoStr100", "Устройство" );
   ini->WriteString(  "MCFG", "MCFGInfoStr101", "Не определено" );

   ini->WriteString( "MR", "Caption", "Восстановление" );
   ini->WriteString( "MR", "GroupBox1Caption", "Конфигурация" );
   ini->WriteString( "MR", "Label1Caption", "Путь к рабочему каталогу программы" );
   ini->WriteString( "MR", "Label2Caption", "Файл резервной копии" );
   ini->WriteString( "MR", "Button1Caption", "Выбрать" );
   ini->WriteString( "MR", "BitBtn1Caption", "Восстановить" );
   ini->WriteString( "MR", "GroupBox2Caption", "База данных MySQL" );
   ini->WriteString( "MR", "Label3Caption", "Файл резервной копии БД" );
   ini->WriteString( "MR", "MRInfoStr1", "Выбрать каталог" );
   ini->WriteString( "MR", "MRInfoStr2", "Каталог не найден" );
   ini->WriteString( "MR", "MRInfoStr3", "Не выбран файл резервной копии!" );
   ini->WriteString( "MR", "MRInfoStr4", "Не выбран рабочий каталог программы!" );
   ini->WriteString( "MR", "MRInfoStr5", "Ошибка выполнения восстановления данных!" );
   ini->WriteString( "MR", "MRInfoStr6", "Ошибка - Время ожидания превышено!" );
   ini->WriteString( "MR", "MRInfoStr7", "Восстановление завершено!" );
   ini->WriteString( "MR", "MRInfoStr8", "Продолжить ожидание?" );
   ini->WriteString( "MR", "MRInfoStr9", "Не выбран файл резервной копии БД!" );

   ini->WriteString( "APP", "MsgStr1", "Программа уже запущена!" );
   ini->WriteString( "APP", "MsgStr2", "Для работы программы необходимо завершить работу модуля \"Клиент\"!" );
   ini->WriteString( "APP", "MsgStr3", "Для работы программы необходимо завершить работу модуля \"Сервер\"!" );
   ini->WriteString( "APP", "MsgStr4", "Для работы программы необходимо завершить работу модуля \"Настройка\"!" );

   ini->UpdateFile();
   delete ini;

   return true;
}
//---------------------------------------------------------------------------
bool TMainForm::LoadLangConfig( AnsiString fp )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   pfrm_Caption = ini->ReadString( "OWINDOWS", "pfrm_Caption", "Подождите" );
   pfrm_Label1_Caption = ini->ReadString( "OWINDOWS", "pfrm_Label1_Caption", "Загрузка данных..." );

   RestoreDlg_Caption = ini->ReadString( "OWINDOWS", "RestoreDlg_Caption", "Восстановление из резервной копии..." );
   RestoreDlg_Label1_Caption = ini->ReadString( "OWINDOWS", "RestoreDlg_Label1_Caption", "Файл архива" );
   RestoreDlg_Button1_Caption = ini->ReadString( "OWINDOWS", "RestoreDlg_Button1_Caption", "Найти" );
   RestoreDlg_OKBtn_Caption = ini->ReadString( "OWINDOWS", "RestoreDlg_OKBtn_Caption", "OK" );
   RestoreDlg_CancelBtn_Caption = ini->ReadString( "OWINDOWS", "RestoreDlg_CancelBtn_Caption", "Отмена" );

   MainForm->Caption = ini->ReadString( "MAINFORM", "CAPTION", "Сервер" );

   ZhurnalItems->Caption = ini->ReadString( "MAINFORM", "ZhurnalItemsCaption", "Журнал" );
   ZhurnalToDbItem->Caption = ini->ReadString( "MAINFORM", "ZhurnalToDbItemCaption", "Новая смена" );
   ZhurnalToDbItem->Hint = ini->ReadString( "MAINFORM", "ZhurnalToDbItemHint", "Начать новую смену" );
   ZhurnalPrintItem->Caption = ini->ReadString( "MAINFORM", "ZhurnalPrintItemCaption", "Печать" );
   ZhurnalPrintItem->Hint = ini->ReadString( "MAINFORM", "ZhurnalPrintItemHint", "Вывод на печать журнала событий" );
   ZhurnalPrintViewItem->Caption = ini->ReadString( "MAINFORM", "ZhurnalPrintViewItemCaption", "Предварительный просмотр" );
   ZhurnalPrintViewItem->Hint = ini->ReadString( "MAINFORM", "ZhurnalPrintViewItemHint", "Предварительный просмотр журнала событий" );
   SpoolerClearItem->Caption = ini->ReadString( "MAINFORM", "SpoolerClearItemCaption", "Очистить очередь печати" );
   SpoolerClearItem->Hint = ini->ReadString( "MAINFORM", "SpoolerClearItemHint", "Очистить очередь печати" );
   DbItem->Caption = ini->ReadString( "MAINFORM", "DbItemCaption", "База данных" );
   DbItem->Hint = ini->ReadString( "MAINFORM", "DbItemHint", "Просмотр базы данных" );
   N20->Caption = ini->ReadString( "MAINFORM", "N20Caption", "Размер шрифта в журнале" );
   N18->Caption = ini->ReadString( "MAINFORM", "N18Caption", "Увеличить" );
   N19->Caption = ini->ReadString( "MAINFORM", "N19Caption", "Уменьшить" );
   ExitItem->Caption = ini->ReadString( "MAINFORM", "ExitItemCaption", "Выход" );
   ExitItem->Hint = ini->ReadString( "MAINFORM", "ExitItemHint", "Завершение работы и выход из программы" );

   AlarmItems->Caption = ini->ReadString( "MAINFORM", "AlarmItemsCaption", "Сигнализация" );
   SoundResetItem->Caption = ini->ReadString( "MAINFORM", "SoundResetItemCaption", "Сброс звука" );
   SoundResetItem->Hint = ini->ReadString( "MAINFORM", "SoundResetItemHint", "Сброс звуковой сигнализации" );
   AlarmResetItem->Caption = ini->ReadString( "MAINFORM", "AlarmResetItemCaption", "Сброс тревог" );
   AlarmResetItem->Hint = ini->ReadString( "MAINFORM", "AlarmResetItemHint", "Сброс тревожной сигнализации" );

   ControlItems->Caption = ini->ReadString( "MAINFORM", "ControlItems", "Управление" );
   ControlItem->Caption = ini->ReadString( "MAINFORM", "ControlItemCaption", "Контроль" );
   ControlItem->Hint = ini->ReadString( "MAINFORM", "ControlItemHint", "Снять с контроля/поставить под контроль объект" );
   DkItem->Caption = ini->ReadString( "MAINFORM", "DkItemCaption", "ДК" );
   DkItem->Hint = ini->ReadString( "MAINFORM", "DkItemHint", "Выполнить команду ДК" );
   GobiDkItem->Caption = ini->ReadString( "MAINFORM", "GobiDkItemCaption", "ССОИ" );
   GobiDkItem->Hint = ini->ReadString( "MAINFORM", "GobiDkItemHint", "Выполнить команду ДК для подсистемы ССОИ" );
   GobiDkKanalsItem->Caption = ini->ReadString( "MAINFORM", "GobiDkKanalsItem", "Все каналы" );
   GobiDkKan1Item->Caption = ini->ReadString( "MAINFORM", "GobiDkKan1Item", "Канал 1" );
   GobiDkKan2Item->Caption = ini->ReadString( "MAINFORM", "GobiDkKan2Item", "Канал 2" );
   GobiDkKan3Item->Caption = ini->ReadString( "MAINFORM", "GobiDkKan3Item", "Канал 3" );
   GobiDkKan4Item->Caption = ini->ReadString( "MAINFORM", "GobiDkKan4Item", "Канал 4" );
   DiagItem->Caption = ini->ReadString( "MAINFORM", "DiagItem", "Диагностика" );
   SetupItem->Caption = ini->ReadString( "MAINFORM", "SetupItem", "Настройка" );
   Control_pdi->Caption = ControlItem->Caption;

   HelpItems->Caption = ini->ReadString( "MAINFORM", "HelpItemsCaption", "Помощь" );
   AboutItem->Caption = ini->ReadString( "MAINFORM", "AboutItemCaption", "О программе..." );

   ToolButton1->Caption = SoundResetItem->Caption;
   ToolButton1->Hint = SoundResetItem->Hint;
   ToolButton2->Caption = AlarmResetItem->Caption;
   ToolButton2->Hint = AlarmResetItem->Hint;

   GroupBox1->Caption = ini->ReadString( "MAINFORM", "GroupBox1Caption", "Дерево объектов" );
   GroupBox5->Caption = ini->ReadString( "MAINFORM", "GroupBox5Caption", "Выполнение команды УЗ Монолит" );

   GroupBox7->Caption = ini->ReadString( "MAINFORM", "GroupBox7Caption", "РАСТР" );

   GroupBox3->Caption = ini->ReadString( "MAINFORM", "GroupBox3Caption", "Журнал событий" );

   DBGrid1->Columns->Items[1]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns1TitleCaption", "Дата, время" );
   DBGrid1->Columns->Items[2]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns2TitleCaption", "Событие" );
   DBGrid1->Columns->Items[3]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns3TitleCaption", "Объект" );
   DBGrid1->Columns->Items[4]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns4TitleCaption", "Причина" );
   DBGrid1->Columns->Items[5]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns5TitleCaption", "Принятые меры" );
   DBGrid1->Columns->Items[6]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns6TitleCaption", "Оператор" );
   DBGrid1->Columns->Items[7]->Title->Caption = ini->ReadString( "MAINFORM", "DBGrid1Columns7TitleCaption", "Клиент" );
   DBGrid1->Columns->Items[7]->Visible = false;

   GroupBox6->Caption = ini->ReadString( "MAINFORM", "GroupBox6Caption", "Причины и принятые меры" );
   Label10->Caption = ini->ReadString( "MAINFORM", "Label10Caption", "Причины" );
   Label13->Caption = ini->ReadString( "MAINFORM", "Label13Caption", "Принятые меры" );

   ErrorMsg = ini->ReadString( "MSGSTRING", "ErrorMsg", "Ошибка" );
   WarningMsg = ini->ReadString( "MSGSTRING", "WarningMsg", "Предупреждение" );
   MsgStr1 = ini->ReadString( "MSGSTRING", "MsgStr1", "Ошибка загрузки конфигурации!" );
   MsgStr2 = ini->ReadString( "MSGSTRING", "MsgStr2", "Ошибка загрузки плана!" );
   MsgStr3 = ini->ReadString( "MSGSTRING", "MsgStr3", "Отсутствует рабочий каталог программы!" );
   MsgStr4 = ini->ReadString( "MSGSTRING", "MsgStr4", "Ошибка создания баз данных!" );
   MsgStr5 = ini->ReadString( "MSGSTRING", "MsgStr5", "Ошибка определения сетевых параметров. Запуск сервера невозможен!" );
   MsgStr6 = ini->ReadString( "MSGSTRING", "MsgStr6", "Ошибка выделения памяти для данных обмена!" );
   MsgStr7 = ini->ReadString( "MSGSTRING", "MsgStr7", "В файле конфигурации отсутствует информация об операторах комплекса!" );
   MsgStr8 = ini->ReadString( "MSGSTRING", "MsgStr8", "Ошибка открытия COM-порта, к которому подключена подсистема ССОИ. Опрос датчиков по этому порту производится не будет!" );
   MsgStr9 = ini->ReadString( "MSGSTRING", "MsgStr9", "Ошибка открытия COM-порта, к которому подключена подсистема РАСТР. Управление ТВ-камерами производится не будет!" );
   MsgStr10 = ini->ReadString( "MSGSTRING", "MsgStr10", "Ошибка выбора оператора комплекса!" );
   MsgStr11 = ini->ReadString( "MSGSTRING", "MsgStr11", "Не найдено устройство ESE-U485 с серийным номером:" );
   MsgStr12 = ini->ReadString( "MSGSTRING", "MsgStr12", "Завершить работу и выйти из программы?" );
   MsgStr13 = ini->ReadString( "MSGSTRING", "MsgStr13", "Вставьте ключ администратора и нажмите OK." );
   MsgStr14 = ini->ReadString( "MSGSTRING", "MsgStr14", "Ключ администратора не найден!" );
   MsgStr15 = ini->ReadString( "MSGSTRING", "MsgStr15", "Убрать контроль?" );
   MsgStr16 = ini->ReadString( "MSGSTRING", "MsgStr16", "Восстановить контроль?" );
   MsgStr17 = ini->ReadString( "MSGSTRING", "MsgStr17", "Начать новую смену?" );
   MsgStr18 = ini->ReadString( "MSGSTRING", "MsgStr18", "Ошибка открытия БД. Закройте модуль База данных!" );
   MsgStr19 = ini->ReadString( "MSGSTRING", "MsgStr19", "Причина не задана!" );
   MsgStr20 = ini->ReadString( "MSGSTRING", "MsgStr20", "Принятые меры не заданы!" );
   MsgStr21 = ini->ReadString( "MSGSTRING", "MsgStr21", "Поиск устройств ESE-U485" );
   MsgStr22 = ini->ReadString( "MSGSTRING", "MsgStr22", "Ошибка при запуске программы. Восстановите конфигурацию!" );
   MsgStr23 = ini->ReadString( "MSGSTRING", "MsgStr23", "Оператор" );
   MsgStr24 = ini->ReadString( "MSGSTRING", "MsgStr24", "Не заполнены все обязательные поля в базе данных!" );
   MsgStr25 = ini->ReadString( "MSGSTRING", "MsgStr25", "Система" );
   MsgStr26 = ini->ReadString( "MSGSTRING", "MsgStr26", "Группа" );
   MsgStr27 = ini->ReadString( "MSGSTRING", "MsgStr27", "Канал" );
   MsgStr28 = ini->ReadString( "MSGSTRING", "MsgStr28", "БЛ" );
   MsgStr29 = ini->ReadString( "MSGSTRING", "MsgStr29", "СД" );
   MsgStr30 = ini->ReadString( "MSGSTRING", "MsgStr30", "ИУ" );
   MsgStr31 = ini->ReadString( "MSGSTRING", "MsgStr31", "ВК" );
   MsgStr32 = ini->ReadString( "MSGSTRING", "MsgStr32", "Вскрытие" );
   MsgStr33 = ini->ReadString( "MSGSTRING", "MsgStr33", "ТВ-камера" );
   MsgStr34 = ini->ReadString( "MSGSTRING", "MsgStr34", "Монитор" );
   MsgStr35 = ini->ReadString( "MSGSTRING", "MsgStr35", "РАСТР" );
   MsgStr36 = ini->ReadString( "MSGSTRING", "MsgStr36", "РАСТР-М-ТВ" );
   MsgStr37 = ini->ReadString( "MSGSTRING", "MsgStr37", "РАСТР (аналоговая)" );

   Table1Str1 = ini->ReadString( "TABLE1STRINGS", "Table1Str1", "Неопр. сост." );
   Table1Str2 = ini->ReadString( "TABLE1STRINGS", "Table1Str2", "Норма" );
   Table1Str3 = ini->ReadString( "TABLE1STRINGS", "Table1Str3", "Ком. ДК выполнена" );
   Table1Str4 = ini->ReadString( "TABLE1STRINGS", "Table1Str4", "Ком. упр. выполнена" );
   Table1Str5 = ini->ReadString( "TABLE1STRINGS", "Table1Str5", "Нет связи" );
   Table1Str6 = ini->ReadString( "TABLE1STRINGS", "Table1Str6", "Ком. ДК не выполнена" );
   Table1Str7 = ini->ReadString( "TABLE1STRINGS", "Table1Str7", "Ком. упр. не выполнена" );
   Table1Str8 = ini->ReadString( "TABLE1STRINGS", "Table1Str8", "Тревога - СРАБОТКА" );
   Table1Str9 = ini->ReadString( "TABLE1STRINGS", "Table1Str9", "Тревога - ВСКРЫТИЕ" );
   Table1Str10 = ini->ReadString( "TABLE1STRINGS", "Table1Str10", "Тревога - КОНФ. ИЗМ." );
   Table1Str11 = ini->ReadString( "TABLE1STRINGS", "Table1Str11", "Выкл" );
   Table1Str12 = ini->ReadString( "TABLE1STRINGS", "Table1Str12", "Вкл" );
   Table1Str13 = ini->ReadString( "TABLE1STRINGS", "Table1Str13", "Закрыто" );
   Table1Str14 = ini->ReadString( "TABLE1STRINGS", "Table1Str14", "Открыто" );
   Table1Str15 = ini->ReadString( "TABLE1STRINGS", "Table1Str15", "Послана ком. Вкл" );
   Table1Str16 = ini->ReadString( "TABLE1STRINGS", "Table1Str16", "Послана ком. Выкл" );
   Table1Str17 = ini->ReadString( "TABLE1STRINGS", "Table1Str17", "Послана ком. ДК" );
   Table1Str18 = ini->ReadString( "TABLE1STRINGS", "Table1Str18", "Послана ком. Сброс тревог" );
   Table1Str19 = ini->ReadString( "TABLE1STRINGS", "Table1Str19", "Контроль выкл." );
   Table1Str20 = ini->ReadString( "TABLE1STRINGS", "Table1Str20", "Контроль вкл." );
   Table1Str21 = ini->ReadString( "TABLE1STRINGS", "Table1Str21", "Послана ком. Вкл все" );
   Table1Str22 = ini->ReadString( "TABLE1STRINGS", "Table1Str22", "Послана ком. Выкл все" );
   Table1Str23 = ini->ReadString( "TABLE1STRINGS", "Table1Str23", "Послана ком. Открыть" );
   Table1Str24 = ini->ReadString( "TABLE1STRINGS", "Table1Str24", "Послана ком. Закрыть" );
   Table1Str25 = ini->ReadString( "TABLE1STRINGS", "Table1Str25", "Модуль запущен" );
   Table1Str26 = ini->ReadString( "TABLE1STRINGS", "Table1Str26", "Модуль остановлен" );
   Table1Str27 = ini->ReadString( "TABLE1STRINGS", "Table1Str27", "Начата новая смена" );
   Table1Str28 = ini->ReadString( "TABLE1STRINGS", "Table1Str28", "Закрыто ключом" );
   Table1Str29 = ini->ReadString( "TABLE1STRINGS", "Table1Str29", "Открыто ключом" );
   Table1Str30 = ini->ReadString( "TABLE1STRINGS", "Table1Str30", "Исходящий вызов" );
   Table1Str32 = ini->ReadString( "TABLE1STRINGS", "Table1Str32", "Входящий вызов" );
   Table1Str33 = ini->ReadString( "TABLE1STRINGS", "Table1Str33", "Аварийное завершение работы программы" );

   SetSobStr01 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr01", "Новая смена" );
   SetSobStr02 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr02", "Модуль" );
   SetSobStr03 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr03", "Система ССОИ" );
   SetSobStr04 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr04", "Канал" );
   SetSobStr05 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr05", "БЛ" );
   SetSobStr06 = ini->ReadString( "SETSOBSTRINGS", "SetSobStr06", "Выполнен сброс тревог" );
  
   PupStr1 = ini->ReadString( "POPUPMENU1", "PupStr1", "Включить/Выключить" );
   PupStr2 = ini->ReadString( "POPUPMENU1", "PupStr2", "Включить" );
   PupStr3 = ini->ReadString( "POPUPMENU1", "PupStr3", "Выключить" );
   PupStr4 = ini->ReadString( "POPUPMENU1", "PupStr4", "Открыть" );
   PupStr5 = ini->ReadString( "POPUPMENU1", "PupStr5", "Закрыть" );
   PupStr6 = ini->ReadString( "POPUPMENU1", "PupStr6", "ДК" );
   PupStr7 = ini->ReadString( "POPUPMENU1", "PupStr7", "Выключить все" );
   PupStr8 = ini->ReadString( "POPUPMENU1", "PupStr8", "Контроль" );

   PupStr9 = ini->ReadString( "POPUPMENU2", "PupStr9", "Добавить" );
   PupStr10 = ini->ReadString( "POPUPMENU2", "PupStr10", "Удалить" );

   AboutDlgStr1 = ini->ReadString( "ABOUTDLG", "AboutDlgStr1", "Комплекс сигнализационный КС-205К" );
   AboutDlgStr2 = ini->ReadString( "ABOUTDLG", "AboutDlgStr2", "Комплекс РАСТР-М-ССОИ" );
   AboutDlgStr3 = ini->ReadString( "ABOUTDLG", "AboutDlgStr3", "РИФ+" );

   OperatorsDlgCaption = ini->ReadString( "OPERATORSDLG", "OperatorsDlgCaption", "Выбор оператора комплекса" );
   OperatorsDlgLabel1Caption = ini->ReadString( "OPERATORSDLG", "OperatorsDlgLabel1Caption", "ФИО оператора" );
   OperatorsDlgLabel2Caption = ini->ReadString( "OPERATORSDLG", "OperatorsDlgLabel2Caption", "Пароль" );

   InfoStr2 = ini->ReadString( "DB", "InfoStr2", "Ошибка соединения с сервером баз данных MySQL!" );
   InfoStr3 = ini->ReadString( "DB", "InfoStr3", "Код ошибки" );
   InfoStr4 = ini->ReadString( "DB", "InfoStr4", "Cообщение" );
   InfoStr6 = ini->ReadString( "DB", "InfoStr6", "Ошибка записи в таблицу" );
   InfoStr34 = ini->ReadString( "DB", "InfoStr34", "В файле RIFX.INI не задано имя базы данных!" );
   InfoStr35 = ini->ReadString( "DB", "InfoStr35", "В файле RIFX.INI не задано имя сервера!" );
   InfoStr36 = ini->ReadString( "DB", "InfoStr36", "В файле RIFX.INI не задан логин!" );
   InfoStr37 = ini->ReadString( "DB", "InfoStr37", "В файле RIFX.INI не задан пароль!" );

   delete ini;

   return true;
}
//---------------------------------------------------------------------------
void TMainForm::ShowGlobalConfig()
{
   AnsiString str = "RIF1: ";

   str = "MySQL: ";
   if( MySQL_use == 1 ) str = "MySQL:" + MySQL_host + ":" + IntToStr(MySQL_port);
   else if( MySQL_use == -1 ) str = "MySQL:" + MySQL_host + ":" + IntToStr(MySQL_port) + " - Ошибка подключения!";
   else str = str + "-";
   StatusBar1->Panels->Items[0]->Text = str;

   str = "RASTR-M-TV: ";
   if( Server2Use )
   {
      str = Server2Name + ":" + IntToStr(Server2Port) +
            " Клиентов: " + Server2->Socket->ActiveConnections;
      if( !Server2->Active ) str = "Ошибка!";
   }
   else str = str + "-";
   StatusBar1->Panels->Items[1]->Text = str;

   str = "iServer: ";
   if( iServerUse )
   {
      str = iServerHost + ":" + IntToStr(iServerPort) +
            " Клиентов: " + iServer->Socket->ActiveConnections;
      if( !iServer->Active ) str = "Ошибка!";
   }
   else str = str + "-";
   StatusBar1->Panels->Items[2]->Text = str;

   if( ComplexVersion == SsoiComplexType )
   {
      DkRifItem->Enabled = false;
      DkRifItem->Visible = false;

      if( SsoiVersion < 2 )
      {
         DiagItem->Enabled = false;
         DiagItem->Visible = false;
      }

      N16->Enabled = false;
      N16->Visible = false;

      SetupItem->Enabled = false;
      SetupItem->Visible = false;

      N26->Enabled = false;
      N26->Visible = false;
   }
}
//---------------------------------------------------------------------------
bool TMainForm::LoadLocalConfig( AnsiString fp )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   MainFormLeft = ini->ReadInteger( "MAINFORM", "MainFormLeft", -10 );
   MainFormTop = ini->ReadInteger( "MAINFORM", "MainFormTop", -10 );
   MainFormWidth = ini->ReadInteger( "MAINFORM", "MainFormWidth", 0 );
   MainFormHeight = ini->ReadInteger( "MAINFORM", "MainFormHeight", 0 );

   Panel1->Width = ini->ReadInteger( "SIZES", "Panel1_Width", 260 );
   if( Panel1->Width < 250 ) Panel1->Width = 250;

   DBGrid1->Font->Size = ini->ReadInteger( "SIZES", "Font", 8 );
   ObjTree->Font->Size = ini->ReadInteger( "SIZES", "Font", 8 );

   DBGrid1->Columns->Items[0]->Width = ini->ReadInteger( "SIZES", "Col1_Width", 50 );
   DBGrid1->Columns->Items[1]->Width = ini->ReadInteger( "SIZES", "Col2_Width", 115 );
   DBGrid1->Columns->Items[2]->Width = ini->ReadInteger( "SIZES", "Col3_Width", 150 );
   DBGrid1->Columns->Items[3]->Width = ini->ReadInteger( "SIZES", "Col4_Width", 150 );
   DBGrid1->Columns->Items[4]->Width = ini->ReadInteger( "SIZES", "Col5_Width", 150 );
   DBGrid1->Columns->Items[5]->Width = ini->ReadInteger( "SIZES", "Col6_Width", 150 );
   DBGrid1->Columns->Items[6]->Width = ini->ReadInteger( "SIZES", "Col7_Width", 150 );
   DBGrid1->Columns->Items[7]->Width = ini->ReadInteger( "SIZES", "Col8_Width", 150 );

//   SoundType = ini->ReadInteger( "MAINFORM", "SoundType", 0 );
   delete ini;

   return true;
}
//---------------------------------------------------------------------------
bool TMainForm::SaveLocalConfig( AnsiString fp )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   ini->WriteInteger( "MAINFORM", "MainFormLeft", MainFormLeft );
   ini->WriteInteger( "MAINFORM", "MainFormTop", MainFormTop );
   ini->WriteInteger( "MAINFORM", "MainFormWidth", MainFormWidth );
   ini->WriteInteger( "MAINFORM", "MainFormHeight", MainFormHeight );

   ini->WriteInteger( "SIZES", "Panel1_Width", Panel1->Width );

   ini->WriteInteger( "SIZES", "Font", DBGrid1->Font->Size );

   ini->WriteInteger( "SIZES", "Col1_Width", DBGrid1->Columns->Items[0]->Width );
   ini->WriteInteger( "SIZES", "Col2_Width", DBGrid1->Columns->Items[1]->Width );
   ini->WriteInteger( "SIZES", "Col3_Width", DBGrid1->Columns->Items[2]->Width );
   ini->WriteInteger( "SIZES", "Col4_Width", DBGrid1->Columns->Items[3]->Width );
   ini->WriteInteger( "SIZES", "Col5_Width", DBGrid1->Columns->Items[4]->Width );
   ini->WriteInteger( "SIZES", "Col6_Width", DBGrid1->Columns->Items[5]->Width );
   ini->WriteInteger( "SIZES", "Col7_Width", DBGrid1->Columns->Items[6]->Width );
   ini->WriteInteger( "SIZES", "Col8_Width", DBGrid1->Columns->Items[7]->Width );

   ini->UpdateFile();
   delete ini;

   return true;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ObjTreeClick(TObject *Sender)
{
   ObjTree->Items->EndUpdate();

   AnsiString str, str1;
   DiagRif->Adr = 0;
   DiagRif->Port = 1;
   DiagRif->Reset();
   DiagKonc->Adr = 0;
   DiagKonc->Port = 1;
   DiagKonc->Reset();

   ComboBox8->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka1Time_0;
   ComboBox9->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka1Time_1;
   ComboBox10->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka2Time_0;
   ComboBox11->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka2Time_1;
   ComboBox12->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka3Time_0;
   ComboBox13->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka3Time_1;
   ComboBox16->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka4Time_0;
   ComboBox17->ItemIndex = POprosObj(ObjTree->Selected->Data)->Metka4Time_1;
   ComboBox14->ItemIndex = POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_0;
   ComboBox15->ItemIndex = POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_1;

   ResetDiagInfo(0);
   GroupBox5->Visible = false;

   if( !POprosObj(ObjTree->Selected->Data)->Metka ) GroupBox9->Visible = false;

   if( ScrollBox2->Visible ) ShowSetupInfo( POprosObj(ObjTree->Selected->Data)->Type );

   if( POprosObj(ObjTree->Selected->Data)->Type == GroupType )
   {
      str.sprintf("%s: \"%s\"", MsgStr26, POprosObj(ObjTree->Selected->Data)->Name);

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible ) { GroupBox10->Visible = false; ResetDiagInfo2(0, 0);}
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RifType )
   {
      if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 0 )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("РИФ-РЛМ:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("РИФ-РЛМ:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
      }
      else if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 1 )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("РИФ-РЛМ24:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("РИФ-РЛМ24:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
      }
      else if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 2 )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("РИФ-РЛМ(Б):%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("РИФ-РЛМ(Б):%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
      }
       else if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 3 )
       {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("РИФ-КРЛ:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("РИФ-КРЛ:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
       }
       else if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 4 )
       {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Разрыв:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("Разрыв:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
       }
       else if( PCfgObj(ObjTree->Selected->Data)->AdamOff == 5 )
       {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Трасса-1л:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("Трасса-1л:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
       }
       else
       {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("РИФ-РЛМ:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->Num3);
         else
            str.sprintf("РИФ-РЛМ:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
               PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);
       }

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible )
      {
         DiagInfoType = 0;
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo2(1, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
         str.sprintf("РИФ-РЛМ-С:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num3);
      else
         str.sprintf("РИФ-РЛМ-С:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible )
      {
         DiagInfoType = 0;
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo2(RifRlmSType, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TorosType )
   {
      str.sprintf("Торос:%d Кан:%d", POprosObj(ObjTree->Selected->Data)->Num1,
                  POprosObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      DiagInfoType = 0;
      if( GroupBox4->Visible && DiagInfoType == 0 )
      {
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo(8);
         ShowDiagRifInfo(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == NastType )
   {
      str.sprintf("Наст:%d Кан:%d", POprosObj(ObjTree->Selected->Data)->Num1,
                  POprosObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      DiagInfoType = 0;
      if( GroupBox4->Visible && DiagInfoType == 0 )
      {
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo(9);
         ShowDiagRifInfo(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RadarType )
   {
      str.sprintf("Радар:%d Кан:%d", POprosObj(ObjTree->Selected->Data)->Num1,
                  POprosObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      DiagInfoType = 0;
      if( GroupBox4->Visible && DiagInfoType == 0 )
      {
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo(91);
         ShowDiagRifInfo(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SdConcType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
         str.sprintf("Концентратор:%d СД:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2, PCfgObj(ObjTree->Selected->Data)->Num3);
      else
         str.sprintf("Концентратор:%d СД:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2,
            PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      DiagInfoType = 1;
      if( GroupBox4->Visible && DiagInfoType == 1 )
      {
         DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo(2);
         ShowDiagKoncInfo(0, 0, 0, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RazrivBoType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
         str.sprintf("Разрыв БО:%d СД:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2, PCfgObj(ObjTree->Selected->Data)->Num3);
      else
         str.sprintf("Разрыв БО:%d СД:%d Кан:%s::%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2,
            PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      DiagInfoType = 1;
      if( GroupBox4->Visible && DiagInfoType == 1 )
      {
         DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo(6);
         ShowDiagKoncInfo2(0, 0, 0, 0);
      }
   }
   else if( PCfgObj(ObjTree->Selected->Data)->Type == TochkaType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
         str.sprintf("Точка/Гарда:%d ЧЭ:%d Кан:%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2, PCfgObj(ObjTree->Selected->Data)->Num3);
      else
         str.sprintf("Точка/Гарда:%d ЧЭ:%d Кан:%s::%d", POprosObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2,
            PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort);

      DiagInfoType = 1;

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible && DiagInfoType == 1 )
      {
         DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
            ResetDiagInfo2(10, POprosObj(ObjTree->Selected->Data)->Num2);

         BitBtn1Click(this);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SdType && ComplexVersion != Rastr_M_SsoiComplexType )
   {
      if( PCfgObj(ObjTree->Selected->Data)->Num3 < 9 )
      {
         if( POprosObj(ObjTree->Selected->Data)->Bazalt )
         {
            str.sprintf("%s:%d %s:%d %s:%d + %s:%d", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr29, PCfgObj(ObjTree->Selected->Data)->Num3, MsgStr30,
               PCfgObj(ObjTree->Selected->Data)->Num3 );
         }
         else if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
         {
            str.sprintf("%s:%d %s:%d %s:%d + %s:%d", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr29, PCfgObj(ObjTree->Selected->Data)->Num3, MsgStr30,
               PCfgObj(ObjTree->Selected->Data)->Num3-3 );
         }
         else
         {
            switch( POprosObj(ObjTree->Selected->Data)->OutType )
            {
               case 1: str1 = "РИФ-РЛМ"; break;
               case 2: str1 = "РИФ-КРЛ"; break;
               case 3: str1 = "РИФ-КРЛМ"; break;
               case 4: str1 = "РИФ-РЛМ-С"; break;
               case 5: str1 = "Трасса"; break;
               case 6: str1 = "Точка/Гарда"; break;
               case 7: str1 = "Разряд"; break;
               default: str1 = " "; break;
            }

            str.sprintf("%s:%d %s:%d %s:%d %s", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               POprosObj(ObjTree->Selected->Data)->Num2, MsgStr29, POprosObj(ObjTree->Selected->Data)->Num3, str1);
         }
      }
      else
         str.sprintf("%s:%d %s:%d %s", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
            PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr32);


      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      if( GobiSys->Kanal[POprosObj(ObjTree->Selected->Data)->Num1-1].Bl[POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].Bazalt )
      {
          if( GobiSys->Kanal[POprosObj(ObjTree->Selected->Data)->Num1-1].Bl[POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt != 0 &&
              GobiSys->Kanal[POprosObj(ObjTree->Selected->Data)->Num1-1].Bl[POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt != -1 )
          {
             CGauge1->Progress = BazaltCnt-GobiSys->Kanal[POprosObj(ObjTree->Selected->Data)->Num1-1].Bl[POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt;
             GroupBox5->Visible = true;
          }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SdType && ComplexVersion == Rastr_M_SsoiComplexType )
   {
      if( POprosObj(ObjTree->Selected->Data)->Num3 != 5 )
         str.sprintf("%s:%d %s:%d %s:%d", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
            POprosObj(ObjTree->Selected->Data)->Num2, MsgStr29, POprosObj(ObjTree->Selected->Data)->Num3);
      else
         str.sprintf("%s:%d %s:%d %s",  MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
            POprosObj(ObjTree->Selected->Data)->Num2, MsgStr32 );

      if( GroupBox10->Visible ) ResetSsoiM1Info();
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SsoiMSdType )
   {
      if( PCfgObj(ObjTree->Selected->Data)->Num3 < 9 )
      {
         if( POprosObj(ObjTree->Selected->Data)->Bazalt )
         {
            str.sprintf("%s:%d %s:%d %s:%d + %s:%d", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr29, PCfgObj(ObjTree->Selected->Data)->Num3, MsgStr30,
               PCfgObj(ObjTree->Selected->Data)->Num3 );

          if( GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt  > 0 )
          {
             CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt;
             GroupBox5->Visible = true;
          }

         }
         else if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
         {
            str.sprintf("%s:%d %s:%d %s:%d + %s:%d", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr29, PCfgObj(ObjTree->Selected->Data)->Num3, MsgStr30,
               PCfgObj(ObjTree->Selected->Data)->Num3-3 );
         }
         else
         {
             switch( POprosObj(ObjTree->Selected->Data)->OutType )
             {
                case 1: str1 = "РИФ-РЛМ"; break;
                case 2: str1 = "РИФ-КРЛ"; break;
                case 3: str1 = "РИФ-КРЛМ"; break;
                case 4: str1 = "РИФ-РЛМ-С"; break;
                case 5: str1 = "Трасса"; break;
                case 6: str1 = "Точка/Гарда"; break;
                case 7: str1 = "Разряд"; break;
                default: str1 = " "; break;
             }

             str.sprintf("%s:%d %s:%d %s:%d %s", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
                POprosObj(ObjTree->Selected->Data)->Num2, MsgStr29, POprosObj(ObjTree->Selected->Data)->Num3, str1);
         }
      }
      else
         str.sprintf("%s:%d %s:%d %s", MsgStr27, PCfgObj(ObjTree->Selected->Data)->Num1, MsgStr28,
            PCfgObj(ObjTree->Selected->Data)->Num2, MsgStr32);

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if(GroupBox10->Visible) ResetDiagInfo2(33, 0);

      if( GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].Bazalt )
      {
          if( GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt != 0 &&
              GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt != -1 )
          {
             CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[POprosObj(ObjTree->Selected->Data)->Num1-1][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].OnOffCnt;
             GroupBox5->Visible = true;
          }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == IuType && ComplexVersion != Rastr_M_SsoiComplexType )
   {
      str.sprintf("%s:%d %s:%d %s:%d", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
         POprosObj(ObjTree->Selected->Data)->Num2, MsgStr30, POprosObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == IuType && ComplexVersion == Rastr_M_SsoiComplexType )
   {
      str.sprintf("%s:%d %s:%d %s:%d", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
         POprosObj(ObjTree->Selected->Data)->Num2, MsgStr30, POprosObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible ) ResetSsoiM1Info();
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SsoiMIuType )
   {
      if( POprosObj(ObjTree->Selected->Data)->Num3 < 4 ) str.sprintf("%s:%d %s:%d %s:%d", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1,
                                                                     MsgStr28, POprosObj(ObjTree->Selected->Data)->Num2,
                                                                     MsgStr30, POprosObj(ObjTree->Selected->Data)->Num3);
      else str.sprintf("%s:%d %s:%d %s:%d", MsgStr27, POprosObj(ObjTree->Selected->Data)->Num1, MsgStr28,
               POprosObj(ObjTree->Selected->Data)->Num2, MsgStr31, (POprosObj(ObjTree->Selected->Data)->Num3-3));

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if(GroupBox10->Visible) ResetDiagInfo2(33, 0);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 41 )
   {
      str.sprintf("%s:%d-%02d-%d", MsgStr33, PCfgObj(ObjTree->Selected->Data)->Num1,
         PCfgObj(ObjTree->Selected->Data)->Num2, PCfgObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);
   }
   else if( PCfgObj(ObjTree->Selected->Data)->Type == Stn485Type )
   {
      str.sprintf("%s:\n%s(%s)\n-%03d", MsgStr33, PCfgObj(ObjTree->Selected->Data)->Icon2Path,
         PCfgObj(ObjTree->Selected->Data)->Icon1Path, PCfgObj(ObjTree->Selected->Data)->Num3);

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RastrOldType )
   {
      if( GroupBox4->Visible) ResetDiagInfo(0);

      if( RastrPortNum != 0 )
      {
         Monitor = POprosObj(ObjTree->Selected->Data)->Num1;
         Camera = POprosObj(ObjTree->Selected->Data)->Num2;
         str.sprintf("%s:%d %s:%d", MsgStr34, Monitor, MsgStr33, (Camera-1) );

         if( RastrSys->Mon[Monitor-1].Auto )
         {
            TvAutoNum[Monitor-1] = 0;
            TvAutoCnt[Monitor-1] = 0;
            for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
            RastrSys->Mon[Monitor-1].Auto = false;
         }

         if( RastrPortNum != 0 ) Serial3.TvOn(Monitor-1, Camera-1);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RastrType )
   {
      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      Monitor = POprosObj(ObjTree->Selected->Data)->Num1;
      Camera = POprosObj(ObjTree->Selected->Data)->Num2;
      str.sprintf("%s:%d %s:%d", MsgStr34, Monitor, MsgStr33, Camera );
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 52 )
   {
      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      Camera = POprosObj(ObjTree->Selected->Data)->Num1;
      str.sprintf("%s:%d", MsgStr33, Camera );
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SolidType )
   {
      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);
      
      if( SolidPortNum != 0 )
      {
         str.sprintf("%s:%d", MsgStr33, POprosObj(ObjTree->Selected->Data)->Num1 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == Adam4068Type )
   {
      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      if( Adam4068PortNum != 0 )
      {
         str.sprintf("Адам-406x/4168:%03d-%d", PCfgObj(ObjTree->Selected->Data)->Num1,
            PCfgObj(ObjTree->Selected->Data)->Num2);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TabloType )
   {
      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      str.sprintf("Инф.табло:%d %s", TabloPortNum, PCfgObj(ObjTree->Selected->Data)->Name);
   }
   else if( PCfgObj(ObjTree->Selected->Data)->Type == SdIpBlType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
      {
         if( POprosObj(ObjTree->Selected->Data)->Bazalt )
         {
            str.sprintf("БЛ-IP Кан:%d СД:%d + ИУ:%d", PCfgObj(ObjTree->Selected->Data)->Num3,
                                                      PCfgObj(ObjTree->Selected->Data)->Num2,
                                                      PCfgObj(ObjTree->Selected->Data)->Num2 );
         }
         else if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
         {
            str.sprintf("БЛ-IP Кан:%d СД:%d + ИУ:%d", PCfgObj(ObjTree->Selected->Data)->Num3,
                                                      PCfgObj(ObjTree->Selected->Data)->Num2,
                                                      PCfgObj(ObjTree->Selected->Data)->Num2-3 );
         }
         else str.sprintf("БЛ-IP Кан:%d СД:%d", PCfgObj(ObjTree->Selected->Data)->Num3,
                                                PCfgObj(ObjTree->Selected->Data)->Num2 );
      }
      else
      {
         if( POprosObj(ObjTree->Selected->Data)->Bazalt )
         {
            str.sprintf("БЛ-IP Кан:%s::%d СД:%d + ИУ:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress,
                                                           PCfgObj(ObjTree->Selected->Data)->UpdPort,
                                                           PCfgObj(ObjTree->Selected->Data)->Num2,
                                                           PCfgObj(ObjTree->Selected->Data)->Num2 );
         }
         else if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
         {
            str.sprintf("БЛ-IP Кан:%s::%d СД:%d + ИУ:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress,
                                                           PCfgObj(ObjTree->Selected->Data)->UpdPort,
                                                           PCfgObj(ObjTree->Selected->Data)->Num2,
                                                           PCfgObj(ObjTree->Selected->Data)->Num2-3 );
         }
         else str.sprintf("БЛ-IP Кан:%s::%d СД:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress,
                     PCfgObj(ObjTree->Selected->Data)->UpdPort, POprosObj(ObjTree->Selected->Data)->Num2 );
      }

      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible )
      {
         DiagInfoType = 0;
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo2(SdIpBlType, 0);
      }
   }
   else if( PCfgObj(ObjTree->Selected->Data)->Type == IuIpBlType )
   {
      if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
         str.sprintf("БЛ-IP Кан:%d ИУ:%d", PCfgObj(ObjTree->Selected->Data)->Num3,
            PCfgObj(ObjTree->Selected->Data)->Num2 );
      else
         str.sprintf("БЛ-IP Кан:%s::%d ИУ:%d ", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
            POprosObj(ObjTree->Selected->Data)->Num2);

      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible )
      {
         DiagInfoType = 0;
         DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
         DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
         ResetDiagInfo2(SdIpBlType, 0);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == StrazhIpType )
   {
      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      str.sprintf("Страж-IP:%s; %s", PCfgObj(ObjTree->Selected->Data)->Icon1Path, PCfgObj(ObjTree->Selected->Data)->Icon4Path);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == OnvifTvType )
   {
      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      str.sprintf("ONVIF-камера:%s", PCfgObj(ObjTree->Selected->Data)->Icon1Path);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == NetDevIdx )
   {
      if( GroupBox10->Visible )
      {
         ScrollBox1->Visible = true;
         GroupBox4->Visible = true;
         GroupBox10->Visible = false;
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      str.sprintf("Сетевое устр-во:%s", PCfgObj(ObjTree->Selected->Data)->Icon1Path);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx )
   {
      if( PCfgObj(ObjTree->Selected->Data)->Type == 26 )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Точка-М/Гарда-М Кан:%d БОД:%d", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1);
         else
            str.sprintf("Точка-М/Гарда-М Кан:%s::%d БОД:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
               POprosObj(ObjTree->Selected->Data)->Num1);
      }
      else
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Сота/Сота-М Кан:%d БОД:%d", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1);
         else
            str.sprintf("Сота/Сота-М Кан:%s::%d БОД:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
                     POprosObj(ObjTree->Selected->Data)->Num1);
      }

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
      if( GroupBox10->Visible )
      {
        if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ) ResetTochkaMDiagInfo( TochkaMBoIdx, 0 );
        else ResetTochkaMDiagInfo( SotaMBoIdx, 0 );
      }

      ScrollBox2->Visible = false;

      GroupBox9->Visible = false;
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
   {
      int flangnum = PCfgObj(ObjTree->Selected->Data)->Num2/100;
      if( PCfgObj(ObjTree->Selected->Data)->Type == 27  )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Точка-М/Гарда-М Кан:%d БОД:%d Участок:%d", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1, flangnum);
         else
            str.sprintf("Точка-М/Гарда-М Кан:%s::%d БОД:%d Участок:%d ", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
               POprosObj(ObjTree->Selected->Data)->Num1, flangnum);
      }
      else
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Сота/Сота-М Кан:%d БОД:%d Участок:%d", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1, flangnum );
         else
            str.sprintf("Сота/Сота-М Кан:%s::%d БОД:%d Участок:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
                  POprosObj(ObjTree->Selected->Data)->Num1, flangnum);
      }

      if( GroupBox10->Visible )
      {
         if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ) ResetTochkaMDiagInfo( TochkaMBoIdx, 0 );
         else ResetTochkaMDiagInfo( SotaMBoIdx, 0 );
      }

      if( GroupBox4->Visible) ResetDiagInfo(0);

      ScrollBox2->Visible = false;
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
   {
      int flangnum = PCfgObj(ObjTree->Selected->Data)->Num2/100;
      int dvnum = PCfgObj(ObjTree->Selected->Data)->Num2%100;

      if( PCfgObj(ObjTree->Selected->Data)->Type == 28  )
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Точка-М/Гарда-М  Кан:%d БОД:%d Участок:%d ДД:%d", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1, flangnum, (dvnum+1));
         else
            str.sprintf("Точка-М/Гарда-М Кан:%s::%d БОД:%d Участок:%d ДД:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
               PCfgObj(ObjTree->Selected->Data)->Num1, flangnum, (dvnum+1));
      }
      else
      {
         if( !PCfgObj(ObjTree->Selected->Data)->UdpUse )
            str.sprintf("Сота/Сота-М Кан:%d БОД:%d Участок:%d ДД:%d ", PCfgObj(ObjTree->Selected->Data)->Num3, PCfgObj(ObjTree->Selected->Data)->Num1, flangnum, (dvnum+1));
         else
            str.sprintf("Сота/Сота-М Кан:%s::%d БОД:%d Участок:%d ДД:%d", PCfgObj(ObjTree->Selected->Data)->UdpAdress, PCfgObj(ObjTree->Selected->Data)->UpdPort,
               PCfgObj(ObjTree->Selected->Data)->Num1, flangnum, (dvnum+1));
      }

      if( GroupBox4->Visible )
      {
         ScrollBox1->Visible = false;
         GroupBox4->Visible = false;
         GroupBox10->Visible = true;
      }

      if( GroupBox10->Visible )
      {                                                                 
         if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ResetTochkaMDiagInfo( TochkaMDdIdx, dvnum );
         else ResetTochkaMDiagInfo( SotaMDdIdx, dvnum );
      }

      if( ScrollBox2->Visible )
      {
         ComboBox1->ItemIndex = 0;
         ComboBox2->ItemIndex = 0;
         BitBtn1Click(this);
      }
      GroupBox9->Visible = false;

      POprosObj(ObjTree->Selected->Data)->IconVisible = false;
   }
   else if( PCfgObj(ObjTree->Selected->Data)->Type == DevLineIdx )
   {
      str.sprintf("DevLine-камера:%d Поток:%d", PCfgObj(ObjTree->Selected->Data)->Num1, PCfgObj(ObjTree->Selected->Data)->OutType);
   }

   StaticText1->Caption = str;


      int type = POprosObj(ObjTree->Selected->Data)->Type;
      int num3 =  POprosObj(ObjTree->Selected->Data)->Num3;

      if( type == SsoiMIuType && POprosObj(ObjTree->Selected->Data)->Num3 >= 4 ) { type = 44; num3 -= 3; }

      str.sprintf("img_%d_%d_%d_%d", type,
                                     POprosObj(ObjTree->Selected->Data)->Num1, POprosObj(ObjTree->Selected->Data)->Num2,
                                     num3);
      StrCopy(POutObj(lpMapCfg)->ImgName, str.c_str());
      POutObj(lpMapCfg)->IconVisible = POprosObj(ObjTree->Selected->Data)->IconVisible;

      if( POprosObj(ObjTree->Selected->Data)->Type > 0 )
         str1 = POprosObj(ObjTree->Selected->Data)->Name + " (" + StaticText1->Caption + ")";
      else str1 = POprosObj(ObjTree->Selected->Data)->Name;

      StrCopy(POutObj(lpMapCfg)->ObjName, str1.c_str());
      POutObj(lpMapCfg)->ImgOperationId = 1;

      oldName = str;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ObjTreeKeyUp(TObject *Sender, WORD &Key,
      TShiftState Shift)
{
   ObjTreeClick(this);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::PopupMenu1Popup(TObject *Sender)
{
   ChangeStatus_pdi->Visible = false;

   N6->Visible = false;
   N21->Visible = false;
   if( ObjTree->Selected->AbsoluteIndex == 0 )
   {
      N6->Visible = true;
      N21->Visible = true;
   }

   OnOff_pdi->Caption = PupStr1;
   Off_pdi->Caption = PupStr5;
   Dk_pdi->Caption = PupStr6;
   OnOffAll_pdi->Caption = PupStr7;

   Control_pdi->Visible = false;
   N11->Visible = false;
   OnOff_pdi->Visible = false;
   N8->Visible = false;
   Dk_pdi->Visible = false;
   N9->Visible = false;
   Pult_pdi->Visible = false;
   OnOffAll_pdi->Visible = false;
   N24->Visible = false;
   PultOff_pdi->Visible = false;
   Off_pdi->Visible = false;
   Metka_pdi->Visible = false;
   ConnectBlock_pdi->Visible = false;
   OnOff2_pdi->Visible = false;

   int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
   int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
   int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

   switch( POprosObj(ObjTree->Selected->Data)->Type )
   {
      case RifType:
      case RifRlmSType:
              if( RifSys->Rk[num3-1][num1-1].Status[0] == 100 )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3;

              Control_pdi->Visible = true;
              N11->Visible = true;
              OnOff_pdi->Visible = true;
              N8->Visible = true;
              Dk_pdi->Visible = true;
              break;
      case SdConcType:
              if( RifSys->Rk[num3-1][num1-1].Status[num2-1] == 100 )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3;

              Control_pdi->Visible = true;
              N11->Visible = true;
              OnOff_pdi->Visible = true;
              N8->Visible = true;

              Dk_pdi->Visible = RifSys->Rk[num3-1][num1-1].DkUse[num2-1];

              N9->Visible = true;
              break;
      case SdType:
              if( GobiSys->Kanal[num1-1].Bl[num2-1].Sd[num3-1].OnOffCnt <= 0 )
              {
                 if( !GobiSys->Kanal[num1-1].Bl[num2-1].Sd[num3-1].ConnectBlock ) Control_pdi->Visible = true;

                 if( ComplexVersion != Rastr_M_SsoiComplexType )
                 {
                     if( POprosObj(ObjTree->Selected->Data)->Bazalt && POprosObj(ObjTree->Selected->Data)->Num3 < 4 )
                     {
                        if( GobiSys->Kanal[num1-1].Bl[num2-1].Sd[num3-1].Status != 10 )
                        {
                            if( GobiSys->Kanal[num1-1].Bl[num2-1].Sd[num3-1].Status == 1  )
                            {
                               OnOff_pdi->Caption = PupStr4; 
                               OnOff_pdi->Visible = true;
                            }
                            else
                            {
                               Off_pdi->Caption = PupStr5;
                               Off_pdi->Visible = true;
                            }
                        }
                        Control_pdi->Visible = false;
                     }
                     else
                     {
                        if( SsoiVersion != 1 )
                        {
                           N11->Visible = true;
                           Dk_pdi->Visible = true;
                        }

                        if( POprosObj(ObjTree->Selected->Data)->Metka ) Metka_pdi->Visible = true;

                        if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
                        {
                           if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[num3-4].Status == 2 ) ConnectBlock_pdi->Caption = "Послать исходящий вызов";
                           else ConnectBlock_pdi->Caption = "Завершить исходящий вызов";
                           ConnectBlock_pdi->Visible = true;
                           Dk_pdi->Visible = false;
                        }
                     }
                 }
                 else
                 {
                     if( POprosObj(ObjTree->Selected->Data)->Bazalt && POprosObj(ObjTree->Selected->Data)->Num3 == 1 )
                     {
                        if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[0].Status == 101 && GobiSys->Kanal[num1-1].Bl[num2-1].Sd[0].Sin == 0 )
                        {
                           OnOff_pdi->Caption = PupStr4; 
                           OnOff_pdi->Visible = true;
                        }
                        else if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[0].Status == 101 && GobiSys->Kanal[num1-1].Bl[num2-1].Sd[0].Sin == 1 )
                        {
                           Off_pdi->Visible = true;
                        }
                        else if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[0].Status == 100 && GobiSys->Kanal[num1-1].Bl[num2-1].Sd[0].Sin == 0 )
                        {
                           OnOff_pdi->Caption = PupStr4; 
                           OnOff_pdi->Visible = true;
                        }
                        else if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[0].Status == 100 && GobiSys->Kanal[num1-1].Bl[num2-1].Sd[0].Sin == 1 )
                        {
                           Off_pdi->Visible = true;
                        }
                     }
                 }
              }
              break;
      case SsoiMSdType:
              if( GobiSys2->Bl[num1-1][num2-1].Sd[num3-1].OnOffCnt <= 0 )
              {
                 Control_pdi->Visible = true;
                 if( POprosObj(ObjTree->Selected->Data)->Bazalt && POprosObj(ObjTree->Selected->Data)->Num3 < 4 )
                 {
                    if( !GobiSys2->Bl[num1-1][num2-1].Sd[num3-1].Sin )
                    {
                       OnOff_pdi->Caption = PupStr4; 
                       OnOff_pdi->Visible = true;
                    }
                    else Off_pdi->Visible = true;
                    Control_pdi->Visible = false;
                 }
                 else
                 {
                    if( num3 <= 8 )
                    {
                        if( POprosObj(ObjTree->Selected->Data)->Dk )
                        {
                           N11->Visible = true;
                           Dk_pdi->Visible = true;
                        }
                    }
                    if( POprosObj(ObjTree->Selected->Data)->Metka ) Metka_pdi->Visible = true;

                    if( POprosObj(ObjTree->Selected->Data)->ConnectBlock )
                    {
                       if( GobiSys2->Bl[num1-1][num2-1].Iu[num3-4].Status == 2 ) ConnectBlock_pdi->Caption = "Послать исходящий вызов";
                       else ConnectBlock_pdi->Caption = "Завершить исходящий вызов";
                       ConnectBlock_pdi->Visible = true;
                       Dk_pdi->Visible = false;
                       Control_pdi->Visible = false;
                    }
                 }
              }
              break;
      case IuType:
              if( ComplexVersion != Rastr_M_SsoiComplexType )
              {
                 if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[num3-1].StatusOld == 1 )
                     OnOff_pdi->Caption = PupStr3;
                 else OnOff_pdi->Caption = PupStr2;
                     OnOff_pdi->Visible = true;
              }
              else
              {
                 if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[num3-1].StatusOld == 101 )
                     OnOff_pdi->Caption = PupStr3;
                 else OnOff_pdi->Caption = PupStr2;
                     OnOff_pdi->Visible = true;
              }
              break;
      case SsoiMIuType:
              if( num3 < 4 )
              {
                 if( GobiSys2->Bl[num1-1][num2-1].Iu[num3-1].StatusOld == 1 )
                    OnOff_pdi->Caption = PupStr3;
                 else OnOff_pdi->Caption = PupStr2;
                 OnOff_pdi->Visible = true;
                 N8 ->Visible = true;
              }
              else
              {
                 if( GobiSys2->Bl[num1-1][num2-1].Vk[num3-4].StatusOld == 1 )
                    OnOff_pdi->Caption = PupStr3;
                 else OnOff_pdi->Caption = PupStr2;
                 OnOff_pdi->Visible = true;
                 N8 ->Visible = true;
              }
              break;
      case 41: if( GobiSys->Kanal[num1-1].Bl[num2-1].Iu[num3-1].StatusOld == 1 )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3; 
              OnOff_pdi->Visible = true;
              break;
      case SolidType:
              if( !SolidSys->GetTv(POprosObj(ObjTree->Selected->Data)->Num1) )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3;
              OnOff_pdi->Visible = true;
              break;
      case Adam4068Type:
              if( A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].Out[POprosObj(ObjTree->Selected->Data)->Num2] == 100 )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3;
              OnOff_pdi->Visible = true;
              break;
      case TorosType:
              if( RifSys->Rk[num3-1][num1-1].Status[0] == 100 )
                 OnOff_pdi->Caption = PupStr2;
              else OnOff_pdi->Caption = PupStr3;

              Control_pdi->Visible = true;
              N11->Visible = true;
              OnOff_pdi->Visible = true;
              N8->Visible = true;
              Dk_pdi->Visible = true;
              break;
      case NastType:
              Control_pdi->Visible = true;
              N11->Visible = true;
              Dk_pdi->Visible = true;
              break;
      case RadarType:
              Control_pdi->Visible = true;
              N11->Visible = true;
              Dk_pdi->Visible = true;
              break;
      case RazrivBoType:
              Control_pdi->Visible = true;
              break;
      case TochkaType:
              Control_pdi->Visible = true;
              N11->Visible = true;
              Dk_pdi->Visible = true;
              break;
      case IuIpBlType:
              if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
              {
                 if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] != 10 )
                 {
                    if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 101 )
                         OnOff_pdi->Caption = PupStr3;
                    else OnOff_pdi->Caption = PupStr2;
                         OnOff_pdi->Visible = true;
                 }
              }
              else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
              {
                  int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
                  if( pos >= 0  )
                  {
                      num1 = 101;
                      if( !Rif2Sys->Ch[pos].Dev[num1-1].ErrFlag[0] )
                      {
                         if( Rif2Sys->Ch[pos].Dev[num1-1].Iu[num2-1].Siu[0] == 0 )
                         {
                            OnOff_pdi->Caption = PupStr2;
                         }
                         else
                         {
                            OnOff_pdi->Caption = PupStr3;
                         }
                         OnOff_pdi->Visible = true;
                      }

                      OnOffAll_pdi->Visible = true;
                  }
               }
              break;
      case SdIpBlType:
              if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
              {
                  ChangeStatus_pdi->Visible = DemoMode;
                  num1 = 101;
                  if( RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] != 10 )
                  {
                      if( RifSys->Rk[num3-1][IpBlIdx].Bazalt[num2-1] )
                      {
                         ChangeStatus_pdi->Visible = false;
                         if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] == 100 )
                         {
                             OnOff2_pdi->Caption = PupStr2;
                             OnOff2_pdi->Visible = true;
                         }
                         else
                         {
                             int sd = RifSys->Rk[num3-1][IpBlIdx].Tin[num2-1];
                             int iu = RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt];

                             if( iu == 101 && sd == 0 )
                             {
                                OnOff_pdi->Caption = PupStr4;
                                OnOff_pdi->Visible = true;
                             }
                             else if( iu == 101 && sd == 1 )
                             {
                                Off_pdi->Visible = true;
                             }
                             else if( iu == 100 && sd == 0 )
                             {
                                OnOff_pdi->Caption = PupStr4; 
                                OnOff_pdi->Visible = true;
                             }
                             else if( iu == 100 && sd == 1 )
                             {
                                Off_pdi->Visible = true;
                             }

                             OnOff2_pdi->Caption = PupStr3;
                         }
                      }
                      else
                      {
                         if(RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] == 100 )
                            OnOff_pdi->Caption = PupStr2;
                         else OnOff_pdi->Caption = PupStr3;
                         OnOff_pdi->Visible = true;
                         Dk_pdi->Visible = POprosObj(ObjTree->Selected->Data)->Dk;
                      }
                  }
                  if( !RifSys->Rk[num3-1][IpBlIdx].Bazalt[num2-1] ) Control_pdi->Visible = true;
              }
              else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
              {
                  int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
                  if( pos >= 0  )
                  {
                      num1 = 101;
                      if( !Rif2Sys->Ch[pos].Dev[num1-1].ErrFlag[0] )
                      {
                         if( Rif2Sys->Ch[pos].Dev[num1-1].Sd[num2-1].Uz )
                         {
                            int sd = Rif2Sys->Ch[pos].Dev[num1-1].Sd[num2-1].St[0];
                            int iu = MainForm->Rif2Sys->Ch[pos].Dev[num1-1].Iu[num2-1].Siu[0];

                            if( iu == 0 && sd == 0 )
                            {
                               OnOff_pdi->Caption = PupStr4;
                               OnOff_pdi->Visible = true;
                            }
                            else if( iu == 1 && sd == 0 )
                            {
                               OnOff_pdi->Caption = PupStr4; 
                               OnOff_pdi->Visible = true;
                            }
                            else if( iu == 0 && sd == 1 )
                            {
                               Off_pdi->Visible = true;
                            }
                            else if( iu == 1 && sd == 1 )
                            {
                               Off_pdi->Visible = true;
                            }
                         }
                         else
                         {
                           if( Rif2Sys->Ch[pos].Dev[num1-1].Sd[num2-1].Active[0] == 0 )
                           {
                              OnOff_pdi->Caption = PupStr2;
                           }
                           else
                           {
                              OnOff_pdi->Caption = PupStr3;
                              Dk_pdi->Visible = POprosObj(ObjTree->Selected->Data)->Dk;
                              Control_pdi->Visible = true;
                           }
                           OnOff_pdi->Visible = true;
                         }
                      }
                  }
              }
              break;
      case TochkaMBoIdx:
      case TochkaMUchIdx:
      case TochkaMDdIdx:
      case SotaMBoIdx:
      case SotaMUchIdx:
      case SotaMDdIdx:
              Control_pdi->Visible = true;
              if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ||
                  POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx )
              {
                 N11->Visible = true;
                 Dk_pdi->Visible = true;
              }
              break;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::OprosGobiTimerTimer(TObject *Sender)
{
   if( SsoiM_PortNum[0] != 0 && SsoiScnt > 0 )
   {
      char buf[128];
      for( int i = 0; i < 128; i++ ) buf[i] = 0xFF;

      for( int kan = 0; kan < KanCnt; kan++ )
      {
         if( GobiSys->Kanal[kan].Use )
         {
            for( int bl = 0; bl < BlCnt; bl++ )
            {
               if( GobiSys->Kanal[kan].Bl[bl].Use )
               {
                  for( int iu = 0; iu < IuCnt; iu++ )
                  {
                     if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt > 1 )
                     {
                        GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt - 1;

                        if( POprosObj(ObjTree->Selected->Data)->Num1-1 == kan &&
                            POprosObj(ObjTree->Selected->Data)->Num2-1 == bl &&
                            POprosObj(ObjTree->Selected->Data)->Num3-1 == iu )
                        {
                           CGauge1->Progress = BazaltCnt - GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
                           GroupBox5->Visible = true;
                        }
                     }
                     else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt == 1 )
                     {
                        if( POprosObj(ObjTree->Selected->Data)->Num1-1 == kan &&
                            POprosObj(ObjTree->Selected->Data)->Num2-1 == bl &&
                            POprosObj(ObjTree->Selected->Data)->Num3-1 == iu )
                        {
                           if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 )
                           {
                              if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 21 )
                              {
                                 if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1  )
                                 {
                                    GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                                    GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                                 }
                              }
                              else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 )
                              {
                                 if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 )
                                 {
                                    GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                                    GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
                                 }
                              }

                              GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = BazaltCnt;

                              CGauge1->Progress = BazaltCnt-GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
                              GroupBox5->Visible = true;
                           }
                           else
                           {
                               CGauge1->Progress = BazaltCnt;
                               GroupBox5->Visible = false;
                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status = 13;
                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].status1 = 13;
                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].StatusOld = 13;
                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = 0;
                           }
                        }
                     }
                  }
               }
            }
         }
      }

      int flag = SsoiSerial.ReadDataWaiting();
      if( flag == 128 )
      {
         flag = SsoiSerial.ReadData(buf, 128);
         GobiSys->ErrCnt = 0;

         if( GobiSys->Status != 1 )
         {
/*
            int buff[9];
            for( int i = 0; i < 9; i++ ) buff[i] = 0;
            buff[0] = 0xC0;
            int num = 1;
            for( int kan = 0; kan < KanCnt; kan++ )
            {
               if( GobiSys->Kanal[kan].Use )
               {
                  for( int bl = 0; bl < BlCnt; bl++ )
                  {
                     if( GobiSys->Kanal[kan].Bl[bl].Use )
                     {
                        if( bl < 7 ) buff[num] |= (1<<bl+1);
                        else buff[num+1] |= (1<<(bl-7));
                     }
                  }
               }
               num += 2;
            }

            flag = SsoiSerial.BS_setup(buff);
*/
         }
         else
         {
            int blnum = 0;
            int priznak = 0;
            int priznak1 = 0;
            int priznak2 = 0;
            int status = 0;

            for( int kan = 0; kan < KanCnt; kan++ )
            {
               if( GobiSys->Kanal[kan].Use )
               {
                  if( GobiSys->Kanal[kan].hCmd == 1 )
                  {
                     for( int i = 0; i < BlCnt; i++ )
                     for( int j = 0; j < SdCnt; j++ )
                        GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk = false;

                     SsoiSerial.Dk(kan+1, true);
                     GobiSys->Kanal[kan].hCmd = 3;
                     DkDtOn = Now();
                  }
                  else
                  {
                     if( GobiSys->Kanal[kan].hCmd == 3 )
                     {
                        TTime DkDtOff1 = Now();
                        if( DkDtOff1 - DkDtOn >= GobiSys->DkDtTime1 )
                        {
                           SsoiSerial.Dk(kan+1, false);
                           GobiSys->Kanal[kan].hCmd = 4;
                        }
                     }

                     for( int bl = 0; bl < BlCnt; bl++ )
                     {
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        {
                           blnum = (kan*32+2) + bl*2;
                           priznak1 = 0; 
                           priznak2 = 0; 

                           status = 0;
                           status = buf[blnum]&0xFF;
                           priznak1 = status & 0x80;

                           status = 0;
                           status = buf[blnum+1]&0xFF;
                           priznak2 = status & 0x80;

                           int tv = 0;
                           tv = buf[blnum+1]&0x10;
                           if( tv == 0x10 ) GobiSys->Kanal[kan].Bl[bl].Tv = true;
                           else GobiSys->Kanal[kan].Bl[bl].Tv = false;

                           if( priznak1 == 0x80 && priznak2 == 0x80 )
                           {
                              GobiSys->Kanal[kan].Bl[bl].ErrCnt = 0;

                              for( int sd = 0; sd < SdCnt-1; sd++ )
                              {
                                 status = 0;

                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use)
                                 {
                                    if( sd > 3 ) status = buf[blnum+1]&0xFF;
                                    else status = buf[blnum]&0xFF;

                                    int sdvig = sd%4;
                                    status = status >> sdvig;
                                    status = status & 1;
                                    if( status == 1 )
                                    {
                                       if( GobiSys->Kanal[kan].hCmd == 0 )
                                       {
                                          if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                                          {
                                             GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 20; 
                                          }
                                          else
                                          {
                                             if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 13 )
                                                GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 21; 
                                          }
                                       }
                                       else
                                       {
                                          if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                                          {
                                             if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 20 &&
                                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld != 20 &&
                                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 != 20 )
                                             if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].DkOk )
                                             {
                                               GobiSys->Kanal[kan].Bl[bl].Sd[sd].DkOk = true; 
                                             }
                                          }
                                       }
                                    }
                                    else
                                    {
                                       if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 13 )
                                       {
                                          GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;
                                       }
                                    }
                                 }
                              }

                              if( GobiSys->Kanal[kan].Bl[bl].Sd[0].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[0].Status == 20 &&
                                  GobiSys->Kanal[kan].Bl[bl].Sd[1].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[1].Status == 20 &&
                                  GobiSys->Kanal[kan].Bl[bl].Sd[2].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[2].Status == 20 &&
                                  GobiSys->Kanal[kan].Bl[bl].Sd[3].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[3].Status == 20 )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].Sd[0].Status = 21; 
                                 GobiSys->Kanal[kan].Bl[bl].Sd[1].Status = 21;  
                                 GobiSys->Kanal[kan].Bl[bl].Sd[2].Status = 21;  
                                 GobiSys->Kanal[kan].Bl[bl].Sd[3].Status = 21;  
                              }
                              else
                              {
                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[0].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[0].Status == 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[1].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[1].Status == 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[2].Status != 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[3].Status != 20 )
                                 {
                                    GobiSys->Kanal[kan].Bl[bl].Sd[0].Status = 17;  
                                    GobiSys->Kanal[kan].Bl[bl].Sd[0].status1 = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[0].StatusOld = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[1].Status = 17;  
                                    GobiSys->Kanal[kan].Bl[bl].Sd[1].status1 = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[1].StatusOld = 17;
                                 }
                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[2].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[2].Status == 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[3].Razriv && GobiSys->Kanal[kan].Bl[bl].Sd[3].Status == 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[0].Status != 20 &&
                                     GobiSys->Kanal[kan].Bl[bl].Sd[1].Status != 20 )
                                 {
                                    GobiSys->Kanal[kan].Bl[bl].Sd[2].Status = 17;  
                                    GobiSys->Kanal[kan].Bl[bl].Sd[2].status1 = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[2].StatusOld = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[3].Status = 17;  
                                    GobiSys->Kanal[kan].Bl[bl].Sd[3].status1 = 17;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[3].StatusOld = 17;
                                 }
                              }


                              for( int iu = 0; iu < IuCnt; iu++ )
                              {
                                 status = 0;

                                 if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Use )
                                 {
                                    status = buf[blnum]&0xFF;

                                    status = status >> (4+iu);
                                    status = status & 1;
                                    if( status == 1 )
                                    {
                                       GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status = 1; 

                                       if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].AutoOff && !GobiSys->Kanal[kan].Bl[bl].Sd[iu].Bazalt && !GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                                       {
                                          if( Now() > GobiSys->Kanal[kan].Bl[bl].Iu[iu].OffDt )
                                          {
                                             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                                             GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;
                                             GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;
                                             GobiSys->Kanal[kan].Bl[bl].Iu[iu].OffDt = Now() + EncodeTime(0,0,5,0);
                                          }
                                       }
                                    }
                                    else
                                    {
                                       GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status = 2; 
                                    }

                                    if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd != 0 )
                                    {
                                       int cmd1 = 0;
                                       int cmd2 = 0;
                                       int cmd3 = 0;

                                          if( iu == 0 )
                                          {
                                             cmd1 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu+1].StatusOld == 1 ) cmd2 = 2;
                                             else cmd2 = 1;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu+2].StatusOld == 1 ) cmd3 = 2;
                                             else cmd3 = 1;
                                          }
                                          else if( iu == 1 )
                                          {
                                             cmd2 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu-1].StatusOld == 1 ) cmd1 = 2;
                                             else cmd1 = 1;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu+1].StatusOld == 1 ) cmd3 = 2;
                                             else cmd3 = 1;
                                          }
                                          else
                                          {
                                             cmd3 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu-2].StatusOld == 1 ) cmd1 = 2;
                                             else cmd1 = 1;
                                             if( GobiSys->Kanal[kan].Bl[bl].Iu[iu-1].StatusOld == 1 ) cmd2 = 2;
                                             else cmd2 = 1;
                                          }


                                          if( SsoiSerial.IuCmd( kan+1, bl+1, cmd1, cmd2, cmd3 ) == 1 )
                                          {
                                             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 0;
                                          }
                                    }
                                 }
                              }
                           }
                           else
                           {
                              if( GobiSys->Kanal[kan].Bl[bl].ErrCnt < MaxErrCnt1 )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].ErrCnt += 1;
                              }
                              else
                              {
                                 for( int sd = 0; sd < SdCnt; sd++ )
                                 {
                                    if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use)
                                    {
                                       if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 13 )
                                          GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 10; 
                                    }
                                 }
                                 for( int iu = 0; iu < IuCnt; iu++ )
                                 {
                                    if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Use)
                                    {
                                       GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status = 10; 
                                    }
                                 }
                              }
                           }
                        }
                     }

                     if( GobiSys->Kanal[kan].hCmd == 4 )
                     {
                       TTime DkDtOff2 = Now();
                       if( DkDtOff2 - DkDtOn >= GobiSys->DkDtTime2 + GobiSys->DkDtTime1 )
                       {
                          GobiSys->Kanal[kan].hCmd = 0;
                          for( int i = 0; i < BlCnt; i++ )
                          for( int j = 0; j < SdCnt; j++ )
                          {
                            if( GobiSys->Kanal[kan].Bl[i].Sd[j].Use && !GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk && GobiSys->Kanal[kan].Bl[i].Sd[j].Dk )
                            {
                              GobiSys->Kanal[kan].Bl[i].Sd[j].Status = 11;
                              GobiSys->Kanal[kan].Bl[i].Sd[j].status1 = 11;
                              GobiSys->Kanal[kan].Bl[i].Sd[j].StatusOld = 11;
                            }
                            else if( GobiSys->Kanal[kan].Bl[i].Sd[j].Use && GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk && GobiSys->Kanal[kan].Bl[i].Sd[j].Dk && GobiSys->Kanal[kan].Bl[i].Sd[j].AutoDk == 0 )
                            {
                                GobiSys->Kanal[kan].Bl[i].Sd[j].Status = 3;
                                GobiSys->Kanal[kan].Bl[i].Sd[j].status1 = 3;
                                GobiSys->Kanal[kan].Bl[i].Sd[j].StatusOld = 3;
                            }
                            GobiSys->Kanal[kan].Bl[i].Sd[j].status1 = GobiSys->Kanal[kan].Bl[i].Sd[j].Status;
                            GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk = false;
                            GobiSys->Kanal[kan].Bl[i].Sd[j].AutoDk = 0;
                          }
                          GobiSys->Kanal[kan].hCmd = 0;
                       }
                     }
                  }
               }
            }
         }
         GobiSys->Status = 1;
         ShowNewGobiStatus();

         if( SsoiAutoDkUse )
         {
               TDateTime autoDT = Now();
               for( int kan = 0; kan < KanCnt; kan++ )
               {
                  if( GobiSys->Kanal[kan].Use )
                  {
                     if( autoDT > GobiSys->Kanal[kan].AutoDkDt )
                     {
                        if( GobiSys->Kanal[kan].Use && GobiSys->Kanal[kan].hCmd == 0 )
                        {
                           GobiSys->Kanal[kan].hCmd = 1;
                           for( int bl = 0; bl < BlCnt; bl++ )
                           {
                              if( GobiSys->Kanal[kan].Bl[bl].Use )
                              {
                                 for( int sd = 0; sd < SdCnt; sd++ )
                                 {
                                    if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Dk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                                    {
                                       GobiSys->Kanal[kan].Bl[bl].Sd[sd].AutoDk = 1;
                                    }
                                    else GobiSys->Kanal[kan].Bl[bl].Sd[sd].AutoDk = 0;
                                 }
                              }
                           }

                           GobiSys->Kanal[kan].AutoDkDt = IncHour( GobiSys->Kanal[kan].AutoDkDt, 4 );
                        }
                     }
                  }
               }
         }
      }
      else if( flag > 128 )
      {
         GobiSys->Status = 1;
         int cnt = flag/128;
         for( int i = 0; i < cnt+1; i++ ) flag = SsoiSerial.ReadData(buf, 128);
      }
      else if( flag < 128 )
      {
         if( GobiSys->ErrCnt < MaxErrCnt1 ) GobiSys->ErrCnt += 1;
         else
         {
            GobiSys->Status = 200;
            GobiSys->ErrCnt = 0;
            ShowNewGobiStatus();
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowNewRkStatus( int flag, int adr, int pn, bool vs, bool tin[MaxIpBlSdCnt], int packet[1000] )
{
   int kn = pn;
   AnsiString sob_str = "";

   if( RifSys->Rk[kn][adr].Type == 0 || RifSys->Rk[kn][adr].Type == 2 || RifSys->Rk[kn][adr].Type == 3 ||
       RifSys->Rk[kn][adr].Type == 5 || RifSys->Rk[kn][adr].Type == RifRlmSType ) /* Датчик РИФ/Торос/Наст/Радар */
   {
      if( RifSys->Rk[kn][adr].StatusOld[0] != RifSys->Rk[kn][adr].Status[0] )
      {
         int n = 6;

         switch( RifSys->Rk[kn][adr].Status[0] )
         {
            case   1: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            case   2: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            case   3: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            case   4: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            case  10: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 8; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 13;
                      break;
            case  11: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  17: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  12: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  13: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  14: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  15: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 32;
                      break;
            case  20: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/ }
                      else n = 14;
                      break;
            case  21: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 14;
                      break;
            case  22: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/ }
                      else n = 14;
                      break;
            case  23: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 14;
                      break;
            case  24: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 14;
                      break;
            case  27: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/}
                      else n = 14;
                      break;
            case  30: n = 10;
                      break;
            case  31: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            case 100: n = 11;
                      break;
            case 101: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                      else n = 12;
                      break;
            default:  n = 6;
                      break;
         }

         ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
         ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;

         if( RifSys->Rk[kn][adr].AlarmFix[0] )
         {
            if( RifSys->Rk[kn][adr].Status[0] == 3 && RifSys->Rk[kn][adr].AutoDk ) RifSys->Rk[kn][adr].AutoDk = false;
            else if( RifSys->Rk[kn][adr].Status[0] == 1 && RifSys->Rk[kn][adr].AutoDk ) RifSys->Rk[kn][adr].AutoDk = false;
            else
            {
               if( RifSys->Rk[kn][adr].Status[0] >= 10 && RifSys->Rk[kn][adr].Status[0] < 30 )
               {
                  AlarmFlag = true;

                  if( RifSys->Rk[kn][adr].Status[0] >= 10 && RifSys->Rk[kn][adr].Status[0] < 20 ) SoundFlag = 3;
                  else SoundFlag = 1;
                  POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                  SetSob4( RifSys->Rk[kn][adr].Status[0],
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Type,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num1,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num2,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num3,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", RifSys->Rk[kn][adr].AlarmMsgOn[0], 0 );
               }
               else
               {
                  SetSob4( RifSys->Rk[kn][adr].Status[0],
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Type,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num1,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num2,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num3,
                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
               }

               if( RifSys->Rk[kn][adr].AutoDk ) RifSys->Rk[kn][adr].AutoDk = false;
            }

            if( ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->HasChildren &&
               RifSys->Rk[kn][adr].Status[0] >= 10 && RifSys->Rk[kn][adr].Status[0] < 30 )
            {
               int num1 = 0, num2 = 0, num3 = 0;
               int k[MonCnt] = {0,0,0,0};

               TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]];
               TTreeNode *Node2 = Node1->getFirstChild();

               while( Node2 )
               {
                  num1 = POprosObj(Node2->Data)->Num1;
                  num2 = POprosObj(Node2->Data)->Num2;
                  num3 = POprosObj(Node2->Data)->Num3;
                  AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                  if( POprosObj(Node2->Data)->Type == IuIpBlType )
                  {
                     if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                         RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                     RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                     RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                  }
                  else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                  {
                     int n1 = POprosObj(Node2->Data)->Num1 - 1;

                     if( !ShowDevLineCam[n1] )
                     {
                         RifSys->Rk[kn][adr].StatusOld[0] = RifSys->Rk[kn][adr].Status[0];         

                         ShowDevLineCam[n1] = true;

                         int n2 = POprosObj(Node2->Data)->Num2;
                         int n3 = POprosObj(Node2->Data)->Num3;
                         int n4 = POprosObj(Node2->Data)->X;
                         int n5 = POprosObj(Node2->Data)->Y;
                         int n6 = POprosObj(Node2->Data)->OutType;

                         if( n4 < n2 ) n4 = n2 + 640;
                         if( n5 < n3 ) n5 = n3 + 480;
                         if( n6 != 0 ) n6 = 1;

                         DWORD rc, exitcode;
                         AnsiString tmp_str1, tmp_str2;
                         tmp_str1  = DevLineFilePath;
                         tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                         ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                         se1[n1].cbSize = sizeof (se1[n1]);
                         se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                         se1[n1].lpFile = tmp_str1.c_str();
                         se1[n1].lpParameters =  tmp_str2.c_str();
                         se1[n1].nShow = SW_NORMAL;
                         ShellExecuteEx (&se1[n1]);
                    }
                  }
                  else if( POprosObj(Node2->Data)->Type == 51 )
                  {
                     int mon = POprosObj(Node2->Data)->Num1-1;
                     int tv = POprosObj(Node2->Data)->Num2;

                     if( mon == 0 )
                     {
                        if( cam1[0] == -1 ) cam1[0] = tv;
                        else
                        {
                           if( cam1[1] == -1 ) cam1[1] = tv;
                           else
                           {
                              if( cam1[2] == -1 ) cam1[2] = tv;
                              else
                              {
                                 if( cam1[3] == -1 ) cam1[3] = tv;
                                 else
                                 {
                                    cam1[0] = cam1[1];
                                    cam1[1] = cam1[2];
                                    cam1[2] = cam1[3];
                                    cam1[3] = tv;
                                 }
                              }
                           }
                        }
                     }
                     if( mon == 1 )
                     {
                        if( cam2[0] == -1 ) cam2[0] = tv;
                        else
                        {
                           if( cam2[1] == -1 ) cam2[1] = tv;
                           else
                           {
                              if( cam2[2] == -1 ) cam2[2] = tv;
                              else
                              {
                                 if( cam2[3] == -1 ) cam2[3] = tv;
                                 else
                                 {
                                    cam2[0] = cam2[1];
                                    cam2[1] = cam2[2];
                                    cam2[2] = cam2[3];
                                    cam2[3] = tv;
                                 }
                              }
                           }
                        }
                     }
                  }
                  else if( POprosObj(Node2->Data)->Type == Stn485Type )
                  {
                     if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                     {
                        cam485[0] = num1;
                        cam485[1] = num2;
                        cam485[2] = num3;
                        cam485_sn[0] = sn;
                     }
                     else
                     {
                        if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                        {
                           cam485[3] = num1;
                           cam485[4] = num2;
                           cam485[5] = num3;
                           cam485_sn[1] = sn;
                        }
                        else
                        {
                           if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                           {
                              cam485[6] = num1;
                              cam485[7] = num2;
                              cam485[8] = num3;
                              cam485_sn[2] = sn;
                           }
                           else
                           {
                              if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                              {
                                 cam485[9] = num1;
                                 cam485[10] = num2;
                                 cam485[11] = num3;
                                 cam485_sn[3] = sn;
                              }
                              else
                              {
                                 if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                 {
                                    cam485[12] = num1;
                                    cam485[13] = num2;
                                    cam485[14] = num3;
                                    cam485_sn[4] = sn;
                                 }
                                 else
                                 {
                                    if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                    {
                                       cam485[15] = num1;
                                       cam485[16] = num2;
                                       cam485[17] = num3;
                                       cam485_sn[5] = sn;
                                    }
                                 }
                              }
                           }
                        }
                     }
                  }
                  else if( POprosObj(Node2->Data)->Type == 52 )
                  {
                     int tv = POprosObj(Node2->Data)->Num1;

                     if( cam1[0] == -1 ) cam1[0] = tv;
                     else
                     {
                        if( cam1[1] == -1 ) cam1[1] = tv;
                        else
                        {
                           if( cam1[2] == -1 ) cam1[2] = tv;
                           else
                           {
                              cam1[0] = cam1[1];
                              cam1[1] = cam1[2];
                              cam1[2] = tv;
                           }
                        }
                     }
                  }
                  else if( POprosObj(Node2->Data)->Type == 5 )
                  {
                     int mon = POprosObj(Node2->Data)->Num1-1;
                     int tv = POprosObj(Node2->Data)->Num2-1;

                     if( RastrSys->Mon[mon].Tv[tv].Use )
                     {
                        TvAutoNum[mon] = 0;
                        TvAutoCnt[mon] = 0;
                        RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                        RastrSys->Mon[mon].Auto = true;
                        k[mon] += 1;
                     }
                  }
                  else if( POprosObj(Node2->Data)->Type == 6 )
                  {
                     SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                  }
                  else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                  {
                     if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                     {
                        A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                        if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                        {
                           TDateTime adt = Now();
                           int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                           switch( t )
                           {
                              case 1: adt = adt + EncodeTime(0,0,5,0);
                                      break;
                              case 2: adt = adt + EncodeTime(0,0,10,0);
                                      break;
                              case 3: adt = adt + EncodeTime(0,0,30,0);
                                      break;
                              case 4: adt = adt + EncodeTime(0,1,0,0);
                                      break;
                              case 5: adt = adt + EncodeTime(0,5,0,0);
                                      break;
                              case 6: adt = adt + EncodeTime(0,10,0,0);
                                      break;
                              case 7: adt = adt + EncodeTime(0,20,0,0);
                                      break;
                              case 8: adt = adt + EncodeTime(0,30,0,0);
                                      break;
                              case 9: adt = adt + EncodeTime(1,0,0,0);
                                      break;
                              default: adt = adt + EncodeTime(0,0,5,0);
                                      break;
                           }
                           A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                        }
                     }
                  }

                  Node2 = Node1->GetNextChild(Node2);
               }
            }
         }

         RifSys->Rk[kn][adr].StatusOld[0] = RifSys->Rk[kn][adr].Status[0];
         RifSys->Rk[kn][adr].Tin[0] = tin[0];
      }

      if( RifSys->Rk[kn][adr].AlarmFix[0] ) POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = RifSys->Rk[kn][adr].Status[0];
      else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = 136;
   }
   else if( RifSys->Rk[kn][adr].Type == SdIpBlType ) 
   {
      sob_str = "";

      for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
      {
         int n = 6;
         if( RifSys->Rk[kn][adr].InUse[sd] )
         {
            if( RifSys->Rk[kn][adr].OnOffCnt[sd] > 1 )
            {
               RifSys->Rk[kn][adr].OnOffCnt[sd] = RifSys->Rk[kn][adr].OnOffCnt[sd] - 1;
            }
            else if( RifSys->Rk[kn][adr].OnOffCnt[sd] == 1 )
            {
               if( RifSys->Rk[kn][adr].Key[sd] == 1 )
               {
                  RifSys->Rk[kn][adr].Cmd = 0x23;
                  RifSys->Rk[kn][adr].CmdCnt = 3;

                  RifSys->Rk[kn][adr].OnOffCnt[sd] = RifBazaltCnt[kn];
               }
               else
               {
                  RifSys->Rk[kn][adr].Status[sd] = 11;
                  n = 10;

                  RifSys->Rk[kn][adr].OnOffCnt[sd] = 0;
               }
            }

            if((RifSys->Rk[kn][adr].Status[sd] != RifSys->Rk[kn][adr].StatusOld[sd]) ||
               (RifSys->Rk[kn][adr].Tin[sd] != tin[sd] && flag > 0) )
            {
               bool sob_correct = true;

               switch( RifSys->Rk[kn][adr].Status[sd] )
               {
                  case   1: 
                  case   3:
                  case 101:
                             if( !tin[sd] )
                             {
                                if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                else n = 12;
                             }
                             else
                             {
                                if( (packet[6]&0x40) == 0x40 )
                                {
                                   if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                   else n = 12;
                                }
                                else
                                {
                                    if( RifSys->Rk[kn][adr].Status[sd] != 3 )
                                    {
                                       if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                       else n = 14;
                                    }
                                    else
                                    {
                                       if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                       else n = 12;
                                    }
                                }
                             }
                             break;
                  case 100: n = 11;
                            break;
                  case  10: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 8; /*AlarmFlag = true; SoundFlag = 1;*/}
                            else n = 13;
                            break;
                  case  11: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 10; /*AlarmFlag = true; SoundFlag = 1;*/}
                            else n = 32;
                            break;
                  case  20: if( RifSys->Rk[kn][adr].AlarmFix[sd] )
                            {
                               n = 9;
                               AlarmFlag = true;
                               POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                               if( !RifSys->Rk[kn][adr].Bazalt[sd] ) SoundFlag = 1;
                               else
                               {
                                 if( RifSys->Rk[kn][adr].Status[sd+8] == 100 ) SoundFlag = 0;
                                 else SoundFlag = 1;
                               }
                            }
                            else n = 14;
                            break;
                  default:  n = 6;
                            sob_correct = false;
                            break;
               }

               if( RifSys->Rk[kn][adr].Bazalt[sd] )
               {
                  int st = RifSys->Rk[kn][adr].Status[sd];
                  if( RifSys->Rk[kn][adr].Status[sd] == 10 )
                  {
                     RifSys->Rk[kn][adr].OnOffCnt[sd] = 0;
                     RifSys->Rk[kn][adr].Key[sd] = 0;

                     sob_str += SetSob2( 10,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                         false, 0 );

                     RifSys->Rk[kn][adr].Tin[sd] = tin[sd]; 
                  }
                  else if( RifSys->Rk[kn][adr].Status[sd] == 11 )
                  {
                     RifSys->Rk[kn][adr].Key[sd] = 0;
                     sob_str += SetSob2( 13,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                         false, 0 );
                  }
                  else
                  {
                     RifSys->Rk[kn][adr].Tin[sd] = tin[sd];

                     if( RifSys->Rk[kn][adr].Status[sd] == 1 )
                     {
                        if( RifSys->Rk[kn][adr].Tin[sd] && RifSys->Rk[kn][adr].Status[sd+MaxIpBlSdCnt] == 100 ) 
                        {
                           n = 38;
                           RifSys->Rk[kn][adr].Key[sd] = 0;
                           RifSys->Rk[kn][adr].OnOffCnt[sd] = 0;
                           st = 21;

                           if( RifSys->Rk[kn][adr].StatusOld[sd] == 20 ||  RifSys->Rk[kn][adr].StatusOld[sd] == 0 ||  RifSys->Rk[kn][adr].StatusOld[sd] == 10 )
                              sob_str += SetSob2( 111,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                               false, 0 );
                        }
                        else if( RifSys->Rk[kn][adr].Tin[sd] && RifSys->Rk[kn][adr].Status[sd+MaxIpBlSdCnt] == 101 ) 
                        {
                           n = 38;
                           RifSys->Rk[kn][adr].Key[sd] = 2;
                           st = 21;

                           if( RifSys->Rk[kn][adr].StatusOld[sd] == 11 )
                           {
                              sob_str += SetSob2( 111,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                  false, 0 );
                           }
                           else if( RifSys->Rk[kn][adr].StatusOld[sd] == 20 ||  RifSys->Rk[kn][adr].StatusOld[sd] == 0 )
                           {
                              sob_str += SetSob2( 113,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                  POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                  false, 0 );
                           }
                        }
                        else if( !RifSys->Rk[kn][adr].Tin[sd] && RifSys->Rk[kn][adr].Status[sd+MaxIpBlSdCnt] == 101 ) 
                        {
                           n = 37;
                           RifSys->Rk[kn][adr].Key[sd] = 0;
                           RifSys->Rk[kn][adr].OnOffCnt[sd] = 0;

                           sob_str += SetSob2( 110,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                               false, 0 );
                        }
                        else if( !RifSys->Rk[kn][adr].Tin[sd] && RifSys->Rk[kn][adr].Status[sd+MaxIpBlSdCnt] == 100 ) 
                        {
                           n = 37;
                           RifSys->Rk[kn][adr].Key[sd] = 2;
                           if( RifSys->Rk[kn][adr].StatusOld[sd] == 11 )
                           {
                               sob_str += SetSob2( 110,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                   false, 0 );
                           }
                           else
                           {
                               sob_str += SetSob2( 112,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                   false, 0 );
                           }
                        }
                     }
                  }
               }
               else
               {
                  if( RifSys->Rk[kn][adr].AlarmFix[sd] && (RifSys->Rk[kn][adr].Status[sd] == RifSys->Rk[kn][adr].StatusOld[sd]) && RifSys->Rk[kn][adr].Status[sd] == 1 )
                  {
                     if( !tin[sd] && RifSys->Rk[kn][adr].Tin[sd] && sob_correct && flag > 0 )
                     {
                        sob_str += SetSob2( RifSys->Rk[kn][adr].Status[sd],
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                            false, 0 );
                     }
                  }
                  else if( RifSys->Rk[kn][adr].AlarmFix[sd] && (RifSys->Rk[kn][adr].Status[sd] != RifSys->Rk[kn][adr].StatusOld[sd]) && RifSys->Rk[kn][adr].Status[sd] == 1 )
                  {
                      if( RifSys->Rk[kn][adr].Tin[sd] )
                        SetSob3( RifSys->Rk[kn][adr].Status[sd],
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                            false, 0 );
                  }

                  RifSys->Rk[kn][adr].Tin[sd] = tin[sd];
               }

               ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->ImageIndex = n;
               ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->SelectedIndex = n;

               if( RifSys->Rk[kn][adr].AlarmFix[sd] && (RifSys->Rk[kn][adr].Status[sd] != RifSys->Rk[kn][adr].StatusOld[sd]) )
               {
                  if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 30 )
                  {
                     AlarmFlag = true;

                     if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 20 ) SoundFlag = 3;
                     else if( !RifSys->Rk[kn][adr].Bazalt[sd] ) SoundFlag = 1;

                     POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                  }

                  if( RifSys->Rk[kn][adr].Status[sd] == 1 && !RifSys->Rk[kn][adr].Bazalt[sd] && RifSys->Rk[kn][adr].StatusOld[sd] != 3  )
                  {
                     if( !vs && !tin[sd] )
                     {
                        sob_str += SetSob2( RifSys->Rk[kn][adr].Status[sd],
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                            false, 0 );
                     }
                  }
                  else
                  {
                     if( sob_correct && !RifSys->Rk[kn][adr].Bazalt[sd] && RifSys->Rk[kn][adr].StatusOld[sd] != 3 )
                     {
                        if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 30 )
                        {
                            AlarmFlag = true;
                            if(RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 20) SoundFlag = 3;
                            else SoundFlag = 1;
                            POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                            sob_str += SetSob2( RifSys->Rk[kn][adr].Status[sd],
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                RifSys->Rk[kn][adr].AlarmMsgOn[sd], 0 );
                        }
                        else
                        {
                            if( RifSys->Rk[kn][adr].Status[sd] == 3 && RifSys->Rk[kn][adr].AutoDk ) RifSys->Rk[kn][adr].Status[sd] = 1;
                            else
                               sob_str += SetSob2( RifSys->Rk[kn][adr].Status[sd],
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                false, 0 );
                        }
                     }
                  }

                  if( !RifSys->Rk[kn][adr].Bazalt[sd] &&
                      ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->HasChildren &&
                      RifSys->Rk[kn][adr].Status[sd] >= 20 && RifSys->Rk[kn][adr].Status[sd] < 30 )
                  {
                     int num1 = 0, num2 = 0, num3 = 0;
                     int k[MonCnt] = {0,0,0,0};

                     TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]];
                     TTreeNode *Node2 = Node1->getFirstChild();

                     while( Node2 )
                     {
                        num1 = POprosObj(Node2->Data)->Num1;
                        num2 = POprosObj(Node2->Data)->Num2;
                        num3 = POprosObj(Node2->Data)->Num3;
                        AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                        if( POprosObj(Node2->Data)->Type == IuIpBlType )
                        {
                           if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )  RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                           RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                           RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                        }
                        else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                        {
                           int n1 = POprosObj(Node2->Data)->Num1 - 1;

                           if( !ShowDevLineCam[n1] )
                           {
                              ShowDevLineCam[n1] = true;

                              RifSys->Rk[kn][adr].StatusOld[sd] = RifSys->Rk[kn][adr].Status[sd];     

                              int n2 = POprosObj(Node2->Data)->Num2;
                              int n3 = POprosObj(Node2->Data)->Num3;
                              int n4 = POprosObj(Node2->Data)->X;
                              int n5 = POprosObj(Node2->Data)->Y;
                              int n6 = POprosObj(Node2->Data)->OutType;

                              if( n4 < n2 ) n4 = n2 + 640;
                              if( n5 < n3 ) n5 = n3 + 480;
                              if( n6 != 0 ) n6 = 1;

                               DWORD rc, exitcode;
                               AnsiString tmp_str1, tmp_str2;
                               tmp_str1  = DevLineFilePath;
                               tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                               ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                               se1[n1].cbSize = sizeof (se1[n1]);
                               se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                               se1[n1].lpFile = tmp_str1.c_str();
                               se1[n1].lpParameters =  tmp_str2.c_str();
                               se1[n1].nShow = SW_NORMAL;
                               ShellExecuteEx (&se1[n1]);
                           }
                        }
                        else if( POprosObj(Node2->Data)->Type == 51 )
                        {
                           int mon = POprosObj(Node2->Data)->Num1-1;
                           int tv = POprosObj(Node2->Data)->Num2;

                           if( mon == 0 )
                           {
                              if( cam1[0] == -1 ) cam1[0] = tv;
                              else
                              {
                                 if( cam1[1] == -1 ) cam1[1] = tv;
                                 else
                                 {
                                    if( cam1[2] == -1 ) cam1[2] = tv;
                                    else
                                    {
                                       if( cam1[3] == -1 ) cam1[3] = tv;
                                       else
                                       {
                                          cam1[0] = cam1[1];
                                          cam1[1] = cam1[2];
                                          cam1[2] = cam1[3];
                                          cam1[3] = tv;
                                       }
                                    }
                                 }
                              }
                           }
                           if( mon == 1 )
                           {
                              if( cam2[0] == -1 ) cam2[0] = tv;
                              else
                              {
                                 if( cam2[1] == -1 ) cam2[1] = tv;
                                 else
                                 {
                                    if( cam2[2] == -1 ) cam2[2] = tv;
                                    else
                                    {
                                       if( cam2[3] == -1 ) cam2[3] = tv;
                                       else
                                       {
                                          cam2[0] = cam2[1];
                                          cam2[1] = cam2[2];
                                          cam2[2] = cam2[3];
                                          cam2[3] = tv;
                                       }
                                    }
                                 }
                              }
                           }
                        }
                        else if( POprosObj(Node2->Data)->Type == Stn485Type )
                        {
                           if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                           {
                              cam485[0] = num1;
                              cam485[1] = num2;
                              cam485[2] = num3;
                              cam485_sn[0] = sn;
                           }
                           else
                           {
                              if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                              {
                                 cam485[3] = num1;
                                 cam485[4] = num2;
                                 cam485[5] = num3;
                                 cam485_sn[1] = sn;
                              }
                              else
                              {
                                 if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                 {
                                    cam485[6] = num1;
                                    cam485[7] = num2;
                                    cam485[8] = num3;
                                    cam485_sn[2] = sn;
                                 }
                                 else
                                 {
                                    if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                    {
                                       cam485[9] = num1;
                                       cam485[10] = num2;
                                       cam485[11] = num3;
                                       cam485_sn[3] = sn;
                                    }
                                    else
                                    {
                                       if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                       {
                                          cam485[12] = num1;
                                          cam485[13] = num2;
                                          cam485[14] = num3;
                                          cam485_sn[4] = sn;
                                       }
                                       else
                                       {
                                          if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                          {
                                             cam485[15] = num1;
                                             cam485[16] = num2;
                                             cam485[17] = num3;
                                             cam485_sn[5] = sn;
                                          }
                                       }
                                    }
                                 }
                              }
                           }
                        }
                        else if( POprosObj(Node2->Data)->Type == 52 )
                        {
                           int tv = POprosObj(Node2->Data)->Num1;

                           if( cam1[0] == -1 ) cam1[0] = tv;
                           else
                           {
                              if( cam1[1] == -1 ) cam1[1] = tv;
                              else
                              {
                                 if( cam1[2] == -1 ) cam1[2] = tv;
                                 else
                                 {
                                    cam1[0] = cam1[1];
                                    cam1[1] = cam1[2];
                                    cam1[2] = tv;
                                 }
                              }
                           }
                        }
                        else if( POprosObj(Node2->Data)->Type == 5 )
                        {
                           int mon = POprosObj(Node2->Data)->Num1-1;
                           int tv = POprosObj(Node2->Data)->Num2-1;

                           if( RastrSys->Mon[mon].Tv[tv].Use )
                           {
                              TvAutoNum[mon] = 0;
                              TvAutoCnt[mon] = 0;
                              RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                              RastrSys->Mon[mon].Auto = true;
                              k[mon] += 1;
                           }
                        }
                        else if( POprosObj(Node2->Data)->Type == 6 )
                        {
                           SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                        }
                        else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                        {
                           if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                           {
                              A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                              if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                              {
                                 TDateTime adt = Now();
                                 int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                                 switch( t )
                                 {
                                    case 1: adt = adt + EncodeTime(0,0,5,0);
                                            break;
                                    case 2: adt = adt + EncodeTime(0,0,10,0);
                                            break;
                                    case 3: adt = adt + EncodeTime(0,0,30,0);
                                            break;
                                    case 4: adt = adt + EncodeTime(0,1,0,0);
                                            break;
                                    case 5: adt = adt + EncodeTime(0,5,0,0);
                                            break;
                                    case 6: adt = adt + EncodeTime(0,10,0,0);
                                            break;
                                    case 7: adt = adt + EncodeTime(0,20,0,0);
                                            break;
                                    case 8: adt = adt + EncodeTime(0,30,0,0);
                                            break;
                                    case 9: adt = adt + EncodeTime(1,0,0,0);
                                            break;
                                    default: adt = adt + EncodeTime(0,0,5,0);
                                            break;
                                 }
                                 A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                              }
                           }
                        }

                        Node2 = Node1->GetNextChild(Node2);
                     }
                  }
               }
            }
            RifSys->Rk[kn][adr].StatusOld[sd] = RifSys->Rk[kn][adr].Status[sd];
         }
      }

      for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
      {
         if( RifSys->Rk[kn][adr].InUse[iu+MaxIpBlSdCnt] )
         {
            if( RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt] != RifSys->Rk[kn][adr].StatusOld[iu+MaxIpBlSdCnt] )
            {
               int n = 6;

               switch( RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt] )
               {
                  case 101: n = 23;
                            break;
                  case 100: n = 24;
                            break;
                  case  10: if( RifSys->Rk[kn][adr].AlarmFix[iu+MaxIpBlSdCnt] ) { n = 8; /*AlarmFlag = true; SoundFlag = 1;*/}
                            else n = 13;
                            break;
                  default:  n = 6;
                            break;
               }

               int kan = RifSys->Rk[kn][adr].Port;
               int bl = 255;
               for( int i = 1; i < ObjTree->Items->Count; i++ )
               {
                  if( POprosObj(ObjTree->Items->Item[i]->Data)->Type == IuIpBlType  &&
                      kan == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num3) &&
                      bl == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num1) &&
                     (iu+1) == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num2) )
                  {
                     ObjTree->Items->Item[i]->ImageIndex = n;
                     ObjTree->Items->Item[i]->SelectedIndex = n;
                  }
               }

               if( RifSys->Rk[kn][adr].AlarmFix[iu+MaxIpBlSdCnt] && !RifSys->Rk[kn][adr].Bazalt[iu] )
               {
                  if( RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt] == 10 )
                  {
                     AlarmFlag = true; SoundFlag = 3;
                     POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                     sob_str += SetSob2( RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt],
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                         RifSys->Rk[kn][adr].AlarmMsgOn[iu+MaxIpBlSdCnt], 0 );
                  }
                  else
                  {
                     sob_str += SetSob2( RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt],
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[iu+MaxIpBlSdCnt]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                  }
               }
            }
            RifSys->Rk[kn][adr].StatusOld[iu+MaxIpBlSdCnt] = RifSys->Rk[kn][adr].Status[iu+MaxIpBlSdCnt];
         }
      }

      if( sob_str.Length() > 0 )
      {
         if( sob_str.Length() > 0 )
         {
            Table1->FlushBuffers();
            ShowPrCnt();
         }

         if( MySQL_use > 0 )
         {
             AnsiString query, err_str;
             int err_code = 0;

             if( sob_str.Length() > 0 )
             {
                sob_str.Delete(sob_str.Length(),1);
                sob_str.Insert(";", sob_str.Length()+1);

                query = "";
                query.sprintf("INSERT INTO %s.events VALUES%s", MySQL_dbname, sob_str);
                mysql_real_query(Con,query.c_str(),query.Length());
                int err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
             }
         }
      }

      for( int sd = 0; sd < MaxInCnt; sd++ )
      {
         if( RifSys->Rk[kn][adr].Bazalt[sd] )
         {
            POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd+MaxIpBlSdCnt] = RifSys->Rk[kn][adr].Status[sd+MaxIpBlSdCnt];
         }

         if( RifSys->Rk[kn][adr].AlarmFix[sd] )
         {
            if( RifSys->Rk[kn][adr].Status[sd] == 1 && RifSys->Rk[kn][adr].Tin[sd] )
               POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd] = 20;
            else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd] = RifSys->Rk[kn][adr].Status[sd];
         }
         else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd] = 136;
      }
   }
   else if( RifSys->Rk[kn][adr].Type == TochkaMBoIdx || RifSys->Rk[kn][adr].Type == TochkaMDdIdx ) /* Точка-М */
   {
      int n = 6;
      int sob_type = -1;

      sob_str = "";

      bool Bod_Ok = false;
      if( (packet[6]&0x01) == 0x01 && RifSys->Rk[kn][adr].Status[0] != 10 ) Bod_Ok = true;

      for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
      {
         sob_type = -1;
         n = 6;

         if( RifSys->Rk[kn][adr].Dd[dd].Use )
         {
            if( RifSys->Rk[kn][adr].Status[0] == 10 )
            {
                if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 8;
                else n = 13;

                sob_type = 10;

                ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->ImageIndex = n;
                ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->SelectedIndex = n;
                RifSys->Rk[kn][adr].Dd[dd].sob_type = sob_type;
            }
            else
            {
                if( Bod_Ok )
                {
                    if( RifSys->Rk[kn][adr].Dd[dd].T1[0] != RifSys->Rk[kn][adr].Dd[dd].T1[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].T2[0] != RifSys->Rk[kn][adr].Dd[dd].T2[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].N1[0] != RifSys->Rk[kn][adr].Dd[dd].N1[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].N2[0] != RifSys->Rk[kn][adr].Dd[dd].N2[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].S[0] != RifSys->Rk[kn][adr].Dd[dd].S[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].Ss[0] != RifSys->Rk[kn][adr].Dd[dd].Ss[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].V[0] != RifSys->Rk[kn][adr].Dd[dd].V[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].Sv[0] != RifSys->Rk[kn][adr].Dd[dd].Sv[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].StatusChE1[0] != RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] ||
                        RifSys->Rk[kn][adr].Dd[dd].StatusChE2[0] != RifSys->Rk[kn][adr].Dd[dd].StatusChE2[1] ||
                        RifSys->Rk[kn][adr].Status[0] != RifSys->Rk[kn][adr].StatusOld[0] )
                    {
                       /* Норма */
                       if( !RifSys->Rk[kn][adr].Dd[dd].T1[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].T2[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].N1[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].N2[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].S[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].Ss[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].V[0] &&
                           !RifSys->Rk[kn][adr].Dd[dd].Sv[0] )
                       {
                          if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 7;
                          else n = 12;

                          sob_type = 1;

                          if( (RifSys->Rk[kn][adr].Dd[dd].StatusChE1[0] == 1 && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] != 1) ||
                              (RifSys->Rk[kn][adr].Dd[dd].StatusChE2[0] == 1 && RifSys->Rk[kn][adr].Dd[dd].StatusChE2[1] != 1) )
                          {
                             if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                             {
                                sob_str += SetSob2( 1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                    false, 0 );
                             }
                          }

                          RifSys->Rk[kn][adr].Dd[dd].T1[1] = RifSys->Rk[kn][adr].Dd[dd].T1[0];
                          RifSys->Rk[kn][adr].Dd[dd].T2[1] = RifSys->Rk[kn][adr].Dd[dd].T2[0];
                          RifSys->Rk[kn][adr].Dd[dd].N1[1] = RifSys->Rk[kn][adr].Dd[dd].N1[0];
                          RifSys->Rk[kn][adr].Dd[dd].N2[1] = RifSys->Rk[kn][adr].Dd[dd].N2[0];
                          RifSys->Rk[kn][adr].Dd[dd].S[1] = RifSys->Rk[kn][adr].Dd[dd].S[0];
                          RifSys->Rk[kn][adr].Dd[dd].Ss[1] = RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                          RifSys->Rk[kn][adr].Dd[dd].V[1] = RifSys->Rk[kn][adr].Dd[dd].V[0];
                          RifSys->Rk[kn][adr].Dd[dd].Sv[1] = RifSys->Rk[kn][adr].Dd[dd].Sv[0];
                       }
                       else
                       {
                          if( RifSys->Rk[kn][adr].Dd[dd].V[0] || RifSys->Rk[kn][adr].Dd[dd].Sv[0] )
                          {
                             if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                             {
                                n = 9;

                                if( RifSys->Rk[kn][adr].Dd[dd].V[0] && !RifSys->Rk[kn][adr].Dd[dd].V[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                                {
                                   AlarmFlag = true; SoundFlag = 1;
                                   POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                   sob_str += SetSob2( 21,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                       RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                }
                                else if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].V[0] && RifSys->Rk[kn][adr].Dd[dd].V[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                                {
                                   SetSob3( 21,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                            RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                }
                             }
                             else n = 14;

                             sob_type = 21;
                          }

                          RifSys->Rk[kn][adr].Dd[dd].V[1] = RifSys->Rk[kn][adr].Dd[dd].V[0];
                          RifSys->Rk[kn][adr].Dd[dd].Sv[1] = RifSys->Rk[kn][adr].Dd[dd].Sv[0];

                          if( RifSys->Rk[kn][adr].Dd[dd].T1[0] )
                          {
                             if( sob_type != 21 )
                             {
                                if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 9;
                                else n = 14;

                                sob_type = 20;
                             }

                             if( RifSys->Rk[kn][adr].Dd[dd].T1[0] && !RifSys->Rk[kn][adr].Dd[dd].T1[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                             {
                                AlarmFlag = true; SoundFlag = 1;
                                POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                sob_str += SetSob2( 22,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                    RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                             }
                             else if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].T1[0] && RifSys->Rk[kn][adr].Dd[dd].T1[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                             {
                               SetSob3( 22,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                        RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                            }
                          }
                          RifSys->Rk[kn][adr].Dd[dd].T1[1] = RifSys->Rk[kn][adr].Dd[dd].T1[0];

                          if( RifSys->Rk[kn][adr].Dd[dd].T2[0] )
                          {
                             if( sob_type != 21 )
                             {
                                if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 9;
                                else n = 14;

                                sob_type = 20;
                             }

                             if( RifSys->Rk[kn][adr].Dd[dd].T2[0] && !RifSys->Rk[kn][adr].Dd[dd].T2[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                             {
                                AlarmFlag = true; SoundFlag = 1;
                                POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                sob_str += SetSob2( 23,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                    RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                             }
                             else if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].T2[0] && RifSys->Rk[kn][adr].Dd[dd].T2[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                             {
                                SetSob3( 23,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                        RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                             }
                          }
                          RifSys->Rk[kn][adr].Dd[dd].T2[1] = RifSys->Rk[kn][adr].Dd[dd].T2[0];

                          if( RifSys->Rk[kn][adr].Dd[dd].N1[0] )
                          {
                             if( sob_type < 20   )
                             {
                                if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 10;
                                else n = 32;

                                sob_type = 11;
                             }

                             if( RifSys->Rk[kn][adr].Dd[dd].S[0] || RifSys->Rk[kn][adr].Dd[dd].Ss[0] );
                             else
                             {
                                 if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].N1[0] && !RifSys->Rk[kn][adr].Dd[dd].N1[1] )
                                 {
                                    AlarmFlag = true; SoundFlag = 1;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                    sob_str += SetSob2( 12,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                        RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                 }
                                 else if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].N1[0] && RifSys->Rk[kn][adr].Dd[dd].N1[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                                 {
                                    SetSob3( 12,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                            POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                            RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                 }
                             }
                          }
                          RifSys->Rk[kn][adr].Dd[dd].N1[1] = RifSys->Rk[kn][adr].Dd[dd].N1[0];

                          if( RifSys->Rk[kn][adr].Dd[dd].N2[0] )
                          {
                             if( sob_type < 20 )
                             {
                                if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 10;
                                else n = 32;

                                sob_type = 11;
                             }

                             if( RifSys->Rk[kn][adr].Dd[dd].S[0] || RifSys->Rk[kn][adr].Dd[dd].Ss[0] );
                             else
                             {
                                 if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].N2[0] && !RifSys->Rk[kn][adr].Dd[dd].N2[1] )
                                 {
                                    AlarmFlag = true; SoundFlag = 1;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                    sob_str += SetSob2( 13,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                        RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                 }
                                 else if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix && RifSys->Rk[kn][adr].Dd[dd].N2[0] && RifSys->Rk[kn][adr].Dd[dd].N2[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                                 {
                                    SetSob3( 13,
                                             POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                             POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                             POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                             POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                             POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                             RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                 }
                             }
                          }
                          RifSys->Rk[kn][adr].Dd[dd].N2[1] = RifSys->Rk[kn][adr].Dd[dd].N2[0];

                          if( RifSys->Rk[kn][adr].Dd[dd].S[0] || RifSys->Rk[kn][adr].Dd[dd].Ss[0] )
                          {
                             RifSys->Rk[kn][adr].Dd[dd].N1[1] = 0;
                             RifSys->Rk[kn][adr].Dd[dd].N2[1] = 0;

                             if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                             {
                                n = 8;

                                if( RifSys->Rk[kn][adr].Dd[dd].S[0] && !RifSys->Rk[kn][adr].Dd[dd].S[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                                {
                                   AlarmFlag = true; SoundFlag = 1;
                                   POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                   sob_str += SetSob2( 10,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                       POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                       RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                }
                                else
                                {
                                   if( RifSys->Rk[kn][adr].Dd[dd].Ss[0] && !RifSys->Rk[kn][adr].Dd[dd].Ss[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                                   {
                                     AlarmFlag = true; SoundFlag = 1;
                                     POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                     sob_str += SetSob2( 10,
                                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                         RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                   }
                                   else if( RifSys->Rk[kn][adr].Dd[dd].Ss[0] && RifSys->Rk[kn][adr].Dd[dd].Ss[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                                   {
                                     SetSob3( 10,
                                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                              RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                   }
                                }
                             }
                             else n = 13;

                             sob_type = 10;
                          }
                          RifSys->Rk[kn][adr].Dd[dd].S[1] = RifSys->Rk[kn][adr].Dd[dd].S[0];
                          RifSys->Rk[kn][adr].Dd[dd].Ss[1] = RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                       }

                       RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] = RifSys->Rk[kn][adr].Dd[dd].StatusChE1[0];
                       RifSys->Rk[kn][adr].Dd[dd].StatusChE2[1] = RifSys->Rk[kn][adr].Dd[dd].StatusChE2[0];

                       ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->ImageIndex = n;
                       ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->SelectedIndex = n;
                       RifSys->Rk[kn][adr].Dd[dd].sob_type = sob_type;
                    }
                }
                else
                {
                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->ImageIndex = n;
                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->SelectedIndex = n;
                }
            }
         }
      }

      n = 6;
      for( int uch = 0; uch < MaxTochkaMUchCnt; uch++)
      {
         if( RifSys->Rk[kn][adr].Uch[uch].Use )
         {
            if( RifSys->Rk[kn][adr].Status[0] == 10 )
            {
               RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] = 10;
               if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];
               else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 136;

               if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 8;
               else n = 13;

               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
            }
            else
            {
                if( Bod_Ok )
                {
                    if( tin[uch] )
                    {
                        if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                        else n = 14;

                       ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
                       ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
                    }

                    if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] > RifSys->Rk[kn][adr].Uch[uch].StatusUch[1] )
                    {
                          switch( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] )
                          {
                             case   1: if( tin[uch] )
                                       {
                                          if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                                          else n = 14;
                                       }
                                       else
                                       {
                                          if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 7;
                                          else n = 12;
                                       }
                                       break;
                             case  10: if(RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                       else n = 10;
                                       break;
                             case  11: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                       else n = 14;
                                       break;
                             case  12: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                       else n = 14;
                                       break;
                             case  20: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                       else n = 14;
                                       break;
                             case  21: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                       else n = 14;
                                       break;
                             default:  n = 6;
                                       break;
                          }

                          ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
                          ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;

                          RifSys->Rk[kn][adr].Uch[uch].StatusUch[1] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];

                          if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix )
                          {
                            if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] == 10 && RifSys->Rk[kn][adr].Status[0] != 10 ) POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 20;
                            else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];
                          }
                          else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 136;

                          if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] >= 20  && RifSys->Rk[kn][adr].Uch[uch].AlarmFix )
                          {
                             POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                if( ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->HasChildren )
                                {
                                   int num1 = 0, num2 = 0, num3 = 0;
                                   int k[MonCnt] = {0,0,0,0};

                                   TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx];
                                   TTreeNode *Node2 = Node1->getFirstChild();

                                   while( Node2 )
                                   {
                                      num1 = POprosObj(Node2->Data)->Num1;
                                      num2 = POprosObj(Node2->Data)->Num2;
                                      num3 = POprosObj(Node2->Data)->Num3;
                                      AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                                      if( POprosObj(Node2->Data)->Type == IuIpBlType )
                                      {
                                         if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                                             RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                                         RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                                         RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                                      }
                                      else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                                      {
                                         int n1 = POprosObj(Node2->Data)->Num1 - 1;

                                         if( !ShowDevLineCam[n1] )
                                         {
                                             ShowDevLineCam[n1] = true;

                                             int n2 = POprosObj(Node2->Data)->Num2;
                                             int n3 = POprosObj(Node2->Data)->Num3;
                                             int n4 = POprosObj(Node2->Data)->X;
                                             int n5 = POprosObj(Node2->Data)->Y;
                                             int n6 = POprosObj(Node2->Data)->OutType;

                                             if( n4 < n2 ) n4 = n2 + 640;
                                             if( n5 < n3 ) n5 = n3 + 480;
                                             if( n6 != 0 ) n6 = 1;

                                            DWORD rc, exitcode;
                                             AnsiString tmp_str1, tmp_str2;
                                             tmp_str1  = DevLineFilePath;
                                             tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                                             ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                                             se1[n1].cbSize = sizeof (se1[n1]);
                                             se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                                             se1[n1].lpFile = tmp_str1.c_str();
                                             se1[n1].lpParameters =  tmp_str2.c_str();
                                             se1[n1].nShow = SW_NORMAL;
                                             ShellExecuteEx (&se1[n1]);

                                        }
                                      }
                                      else if( POprosObj(Node2->Data)->Type == 51 )
                                      {
                                         int mon = POprosObj(Node2->Data)->Num1-1;
                                         int tv = POprosObj(Node2->Data)->Num2;

                                         if( mon == 0 )
                                         {
                                            if( cam1[0] == -1 ) cam1[0] = tv;
                                            else
                                            {
                                               if( cam1[1] == -1 ) cam1[1] = tv;
                                               else
                                               {
                                                  if( cam1[2] == -1 ) cam1[2] = tv;
                                                  else
                                                  {
                                                     if( cam1[3] == -1 ) cam1[3] = tv;
                                                     else
                                                     {
                                                        cam1[0] = cam1[1];
                                                        cam1[1] = cam1[2];
                                                        cam1[2] = cam1[3];
                                                        cam1[3] = tv;
                                                     }
                                                  }
                                               }
                                            }
                                         }
                                         if( mon == 1 )
                                         {
                                            if( cam2[0] == -1 ) cam2[0] = tv;
                                            else
                                            {
                                               if( cam2[1] == -1 ) cam2[1] = tv;
                                               else
                                               {
                                                  if( cam2[2] == -1 ) cam2[2] = tv;
                                                  else
                                                  {
                                                     if( cam2[3] == -1 ) cam2[3] = tv;
                                                     else
                                                     {
                                                        cam2[0] = cam2[1];
                                                        cam2[1] = cam2[2];
                                                        cam2[2] = cam2[3];
                                                        cam2[3] = tv;
                                                     }
                                                  }
                                               }
                                            }
                                         }
                                      }
                                      else if( POprosObj(Node2->Data)->Type == Stn485Type )
                                      {
                                         if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                                         {
                                            cam485[0] = num1;
                                            cam485[1] = num2;
                                            cam485[2] = num3;
                                            cam485_sn[0] = sn;
                                         }
                                         else
                                         {
                                            if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                                            {
                                               cam485[3] = num1;
                                               cam485[4] = num2;
                                               cam485[5] = num3;
                                               cam485_sn[1] = sn;
                                            }
                                            else
                                            {
                                               if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                               {
                                                  cam485[6] = num1;
                                                  cam485[7] = num2;
                                                  cam485[8] = num3;
                                                  cam485_sn[2] = sn;
                                               }
                                               else
                                               {
                                                  if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                                  {
                                                     cam485[9] = num1;
                                                     cam485[10] = num2;
                                                     cam485[11] = num3;
                                                     cam485_sn[3] = sn;
                                                  }
                                                  else
                                                  {
                                                     if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                                     {
                                                        cam485[12] = num1;
                                                        cam485[13] = num2;
                                                        cam485[14] = num3;
                                                        cam485_sn[4] = sn;
                                                     }
                                                     else
                                                     {
                                                        if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                                        {
                                                           cam485[15] = num1;
                                                           cam485[16] = num2;
                                                           cam485[17] = num3;
                                                           cam485_sn[5] = sn;
                                                        }
                                                     }
                                                  }
                                               }
                                            }
                                         }
                                      }
                                      else if( POprosObj(Node2->Data)->Type == 52 )
                                      {
                                         int tv = POprosObj(Node2->Data)->Num1;

                                         if( cam1[0] == -1 ) cam1[0] = tv;
                                         else
                                         {
                                            if( cam1[1] == -1 ) cam1[1] = tv;
                                            else
                                            {
                                               if( cam1[2] == -1 ) cam1[2] = tv;
                                               else
                                               {
                                                  cam1[0] = cam1[1];
                                                  cam1[1] = cam1[2];
                                                  cam1[2] = tv;
                                               }
                                            }
                                         }
                                      }
                                      else if( POprosObj(Node2->Data)->Type == 5 )
                                      {
                                         int mon = POprosObj(Node2->Data)->Num1-1;
                                         int tv = POprosObj(Node2->Data)->Num2-1;

                                         if( RastrSys->Mon[mon].Tv[tv].Use )
                                         {
                                            TvAutoNum[mon] = 0;
                                            TvAutoCnt[mon] = 0;
                                            RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                                            RastrSys->Mon[mon].Auto = true;
                                            k[mon] += 1;
                                         }
                                      }
                                      else if( POprosObj(Node2->Data)->Type == 6 )
                                      {
                                         SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                                      }
                                      else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                                      {
                                         if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                                         {
                                            A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                                            if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                                            {
                                               TDateTime adt = Now();
                                               int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                                               switch( t )
                                               {
                                                  case 1: adt = adt + EncodeTime(0,0,5,0);
                                                          break;
                                                  case 2: adt = adt + EncodeTime(0,0,10,0);
                                                          break;
                                                  case 3: adt = adt + EncodeTime(0,0,30,0);
                                                          break;
                                                  case 4: adt = adt + EncodeTime(0,1,0,0);
                                                          break;
                                                  case 5: adt = adt + EncodeTime(0,5,0,0);
                                                          break;
                                                  case 6: adt = adt + EncodeTime(0,10,0,0);
                                                          break;
                                                  case 7: adt = adt + EncodeTime(0,20,0,0);
                                                          break;
                                                  case 8: adt = adt + EncodeTime(0,30,0,0);
                                                          break;
                                                  case 9: adt = adt + EncodeTime(1,0,0,0);
                                                          break;
                                                  default: adt = adt + EncodeTime(0,0,5,0);
                                                          break;
                                               }
                                               A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                                            }
                                         }
                                      }
                                      Node2 = Node1->GetNextChild(Node2);
                                   }
                                }
                          }
                    }
                }
                else
                {
                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
                }
            }
         }
      }

      n = 6;
      if( (RifSys->Rk[kn][adr].StatusBO[0] > RifSys->Rk[kn][adr].StatusBO[1] || RifSys->Rk[kn][adr].StatusBO[0] == 10) && RifSys->Rk[kn][adr].Status[0] != 10 )
      {
         switch( RifSys->Rk[kn][adr].StatusBO[0] )
         {
            case   1: if( vs )
                      {
                        if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                        else n = 14;
                      }
                      else
                      {
                        if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                        else n = 12;
                      }
                      break;
            case  10:
            case  11:
            case  12:
            case  20:
            case  21: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                      else n = 14;
                      break;
            default:  n = 6;
                      break;
          }

          ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
          ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;

          RifSys->Rk[kn][adr].StatusBO[1] = RifSys->Rk[kn][adr].StatusBO[0];
      }

      if( vs )
      {
          if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
          else n = 14;

          ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
          ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;
      }

      if( RifSys->Rk[kn][adr].Status[0] != RifSys->Rk[kn][adr].StatusOld[0]  )
      {
         if( RifSys->Rk[kn][adr].Status[0] >= RifSys->Rk[kn][adr].StatusBO[0] || RifSys->Rk[kn][adr].Status[0] == 10 || RifSys->Rk[kn][adr].StatusOld[0] == 10  )
         {
            switch( RifSys->Rk[kn][adr].Status[0] )
            {
                   case   1:
                   case   3: if( !vs )
                             {
                               if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                               else n = 12;
                             }
                             else
                             {
                               if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                               else n = 14;
                             }
                             break;
                   case  10: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 8; AlarmFlag = true; if(RifSys->Rk[kn][adr].StatusOld[0] != -2 ) SoundFlag = 3; POprosOutObj(lpMapOpros)->AlarmResetFlag = false;}
                             else n = 13;
                             break;
                   case  11: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 10; AlarmFlag = true; if(RifSys->Rk[kn][adr].StatusOld[0] != -2 ) SoundFlag = 3; POprosOutObj(lpMapOpros)->AlarmResetFlag = false;}
                             else n = 32;
                             break;
                   case  20: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; AlarmFlag = true; if(RifSys->Rk[kn][adr].StatusOld[0] != -2 ) SoundFlag = 1;}
                             else n = 14;
                             break;
                   case  21: if( RifSys->Rk[kn][adr].AlarmFix[0] ) { n = 9; AlarmFlag = true; if(RifSys->Rk[kn][adr].StatusOld[0] != -2 ) SoundFlag = 1;}
                             else n = 14;
                             break;
                   default:  n = 6;
                             break;
            }

            ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
            ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;
         }

         if( RifSys->Rk[kn][adr].StatusOld[0] != -2 && RifSys->Rk[kn][adr].AlarmFix[0] )
         {
            bool f = false;
            if( RifSys->Rk[kn][adr].Status[0] >= 10 && RifSys->Rk[kn][adr].Status[0] < 30) f = RifSys->Rk[kn][adr].AlarmMsgOn[0];

            if( RifSys->Rk[kn][adr].StatusOld[0] == 10 )
            {
               for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
               {
                  if( RifSys->Rk[kn][adr].Dd[dd].Use )
                  {
                     RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] = -1;
                     RifSys->Rk[kn][adr].Dd[dd].StatusChE2[1] = -1;
                     RifSys->Rk[kn][adr].Dd[dd].T1[1] = !RifSys->Rk[kn][adr].Dd[dd].T1[0];
                     RifSys->Rk[kn][adr].Dd[dd].T2[1] = !RifSys->Rk[kn][adr].Dd[dd].T2[0];
                     RifSys->Rk[kn][adr].Dd[dd].N1[1] = !RifSys->Rk[kn][adr].Dd[dd].N1[0];
                     RifSys->Rk[kn][adr].Dd[dd].N2[1] = !RifSys->Rk[kn][adr].Dd[dd].N2[0];
                     RifSys->Rk[kn][adr].Dd[dd].S[1] = !RifSys->Rk[kn][adr].Dd[dd].S[0];
                     RifSys->Rk[kn][adr].Dd[dd].Ss[1] = !RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                     RifSys->Rk[kn][adr].Dd[dd].V[1] = !RifSys->Rk[kn][adr].Dd[dd].V[0];
                     RifSys->Rk[kn][adr].Dd[dd].Sv[1] = !RifSys->Rk[kn][adr].Dd[dd].Sv[0];
                  }
               }
            }

               sob_str += SetSob2( RifSys->Rk[kn][adr].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", f, 0 );

         }

         RifSys->Rk[kn][adr].StatusOld[0] = RifSys->Rk[kn][adr].Status[0];
      }

          if( RifSys->Rk[kn][adr].AlarmFix[0] )
          {
             if( (RifSys->Rk[kn][adr].StatusBO[0] > RifSys->Rk[kn][adr].Status[0]) && RifSys->Rk[kn][adr].Status[0] != 10 )
             {
                if( RifSys->Rk[kn][adr].StatusBO[0] == 10 || RifSys->Rk[kn][adr].StatusBO[0] == 11 ||
                    RifSys->Rk[kn][adr].StatusBO[0] == 12 ) POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = 20;
                else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = RifSys->Rk[kn][adr].StatusBO[0];
             }
             else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = RifSys->Rk[kn][adr].Status[0];
          }
          else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = 136;

          if( RifSys->Rk[kn][adr].Status[0] >= 20 || RifSys->Rk[kn][adr].StatusBO[0] >= 20)
          {
             POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

             if( ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->HasChildren )
             {
                 int num1 = 0, num2 = 0, num3 = 0;
                 int k[MonCnt] = {0,0,0,0};

                 TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]];
                 TTreeNode *Node2 = Node1->getFirstChild();

                 while( Node2 )
                 {
                    num1 = POprosObj(Node2->Data)->Num1;
                    num2 = POprosObj(Node2->Data)->Num2;
                    num3 = POprosObj(Node2->Data)->Num3;
                    AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                    if( POprosObj(Node2->Data)->Type == IuIpBlType )
                    {
                       if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                           RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                       RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                       RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                    }
                    else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                    {
                       int n1 = POprosObj(Node2->Data)->Num1 - 1;

                       if( !ShowDevLineCam[n1] )
                       {
                           ShowDevLineCam[n1] = true;

                           int n2 = POprosObj(Node2->Data)->Num2;
                           int n3 = POprosObj(Node2->Data)->Num3;
                           int n4 = POprosObj(Node2->Data)->X;
                           int n5 = POprosObj(Node2->Data)->Y;
                           int n6 = POprosObj(Node2->Data)->OutType;

                           if( n4 < n2 ) n4 = n2 + 640;
                           if( n5 < n3 ) n5 = n3 + 480;
                           if( n6 != 0 ) n6 = 1;

                           DWORD rc, exitcode;
                           AnsiString tmp_str1, tmp_str2;
                           tmp_str1  = DevLineFilePath;
                           tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                           ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                           se1[n1].cbSize = sizeof (se1[n1]);
                           se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                           se1[n1].lpFile = tmp_str1.c_str();
                           se1[n1].lpParameters =  tmp_str2.c_str();
                           se1[n1].nShow = SW_NORMAL;
                           ShellExecuteEx (&se1[n1]);
                      }
                    }
                    else if( POprosObj(Node2->Data)->Type == 51 )
                    {
                       int mon = POprosObj(Node2->Data)->Num1-1;
                       int tv = POprosObj(Node2->Data)->Num2;

                       if( mon == 0 )
                       {
                          if( cam1[0] == -1 ) cam1[0] = tv;
                          else
                          {
                             if( cam1[1] == -1 ) cam1[1] = tv;
                             else
                             {
                                if( cam1[2] == -1 ) cam1[2] = tv;
                                else
                                {
                                   if( cam1[3] == -1 ) cam1[3] = tv;
                                   else
                                   {
                                      cam1[0] = cam1[1];
                                      cam1[1] = cam1[2];
                                      cam1[2] = cam1[3];
                                      cam1[3] = tv;
                                   }
                                }
                             }
                          }
                       }
                       if( mon == 1 )
                       {
                          if( cam2[0] == -1 ) cam2[0] = tv;
                          else
                          {
                             if( cam2[1] == -1 ) cam2[1] = tv;
                             else
                             {
                                if( cam2[2] == -1 ) cam2[2] = tv;
                                else
                                {
                                   if( cam2[3] == -1 ) cam2[3] = tv;
                                   else
                                   {
                                      cam2[0] = cam2[1];
                                      cam2[1] = cam2[2];
                                      cam2[2] = cam2[3];
                                      cam2[3] = tv;
                                   }
                                }
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == Stn485Type )
                    {
                       if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                       {
                          cam485[0] = num1;
                          cam485[1] = num2;
                          cam485[2] = num3;
                          cam485_sn[0] = sn;
                       }
                       else
                       {
                          if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                          {
                             cam485[3] = num1;
                             cam485[4] = num2;
                             cam485[5] = num3;
                             cam485_sn[1] = sn;
                          }
                          else
                          {
                             if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                             {
                                cam485[6] = num1;
                                cam485[7] = num2;
                                cam485[8] = num3;
                                cam485_sn[2] = sn;
                             }
                             else
                             {
                                if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                {
                                   cam485[9] = num1;
                                   cam485[10] = num2;
                                   cam485[11] = num3;
                                   cam485_sn[3] = sn;
                                }
                                else
                                {
                                   if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                   {
                                      cam485[12] = num1;
                                      cam485[13] = num2;
                                      cam485[14] = num3;
                                      cam485_sn[4] = sn;
                                   }
                                   else
                                   {
                                      if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                      {
                                         cam485[15] = num1;
                                         cam485[16] = num2;
                                         cam485[17] = num3;
                                         cam485_sn[5] = sn;
                                      }
                                   }
                                }
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 52 )
                    {
                       int tv = POprosObj(Node2->Data)->Num1;

                       if( cam1[0] == -1 ) cam1[0] = tv;
                       else
                       {
                          if( cam1[1] == -1 ) cam1[1] = tv;
                          else
                          {
                             if( cam1[2] == -1 ) cam1[2] = tv;
                             else
                             {
                                cam1[0] = cam1[1];
                                cam1[1] = cam1[2];
                                cam1[2] = tv;
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 5 )
                    {
                       int mon = POprosObj(Node2->Data)->Num1-1;
                       int tv = POprosObj(Node2->Data)->Num2-1;

                       if( RastrSys->Mon[mon].Tv[tv].Use )
                       {
                          TvAutoNum[mon] = 0;
                          TvAutoCnt[mon] = 0;
                          RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                          RastrSys->Mon[mon].Auto = true;
                          k[mon] += 1;
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 6 )
                    {
                       SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                    }
                    else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                    {
                       if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                       {
                          A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                          if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                          {
                             TDateTime adt = Now();
                             int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                             switch( t )
                             {
                                case 1: adt = adt + EncodeTime(0,0,5,0);
                                        break;
                                case 2: adt = adt + EncodeTime(0,0,10,0);
                                        break;
                                case 3: adt = adt + EncodeTime(0,0,30,0);
                                        break;
                                case 4: adt = adt + EncodeTime(0,1,0,0);
                                        break;
                                case 5: adt = adt + EncodeTime(0,5,0,0);
                                        break;
                                case 6: adt = adt + EncodeTime(0,10,0,0);
                                        break;
                                case 7: adt = adt + EncodeTime(0,20,0,0);
                                        break;
                                case 8: adt = adt + EncodeTime(0,30,0,0);
                                        break;
                                case 9: adt = adt + EncodeTime(1,0,0,0);
                                        break;
                                default: adt = adt + EncodeTime(0,0,5,0);
                                        break;
                             }
                             A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                          }
                       }
                    }
                    Node2 = Node1->GetNextChild(Node2);
                 }
             }
      }

      if( sob_str.Length() > 0 )
      {
         if( sob_str.Length() > 0 )
         {
            Table1->FlushBuffers();
            ShowPrCnt();
         }

         if( MySQL_use > 0 )
         {
             AnsiString query, err_str;
             int err_code = 0;

             if( sob_str.Length() > 0 )
             {
                sob_str.Delete(sob_str.Length(),1);
                sob_str.Insert(";", sob_str.Length()+1);

                query = "";
                query.sprintf("INSERT INTO %s.events VALUES%s", MySQL_dbname, sob_str);
                mysql_real_query(Con,query.c_str(),query.Length());
                err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
             }
         }
      }
   }
   else if( RifSys->Rk[kn][adr].Type == SotaMBoIdx || RifSys->Rk[kn][adr].Type == SotaMDdIdx ) /* Сота-М */
   {
      int n = 6;
      int sob_type = -1;

      sob_str = "";

      bool Bod_Ok = false;
      if( (packet[6]&0x01) == 0x01 ) Bod_Ok = true;

      for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
      {
         sob_type = -1;
         n = 6;

         if( RifSys->Rk[kn][adr].Dd[dd].Use )
         {
            if( RifSys->Rk[kn][adr].Status[0] == 10 )
            {
               if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 8;
               else n = 13;

               sob_type = 10;
            }
            else
            {
               if( Bod_Ok )
               {
                   if( !RifSys->Rk[kn][adr].Dd[dd].T1[0] &&
                       !RifSys->Rk[kn][adr].Dd[dd].S[0] &&
                       !RifSys->Rk[kn][adr].Dd[dd].N1[0] &&
                       !RifSys->Rk[kn][adr].Dd[dd].Ss[0] )
                   {
                      if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) n = 7;
                      else n = 12;

                      sob_type = 1;

                      if( RifSys->Rk[kn][adr].Dd[dd].StatusChE1[0] == 1 && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] != 1 )
                      {
                         if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                         {
                            sob_str += SetSob2( 1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                         }
                      }

                      RifSys->Rk[kn][adr].Dd[dd].T1[1] = RifSys->Rk[kn][adr].Dd[dd].T1[0];
                      RifSys->Rk[kn][adr].Dd[dd].S[1] = RifSys->Rk[kn][adr].Dd[dd].S[0];
                      RifSys->Rk[kn][adr].Dd[dd].Ss[1] = RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                      RifSys->Rk[kn][adr].Dd[dd].N1[1] = RifSys->Rk[kn][adr].Dd[dd].N1[0];
                   }
                   else
                   {
                      if( RifSys->Rk[kn][adr].Dd[dd].T1[0] )
                      {
                         if( sob_type != 21 )
                         {
                            if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix ) { n = 9; /*AlarmFlag = true; SoundFlag = 1;*/ }
                            else n = 14;

                            sob_type = 20;
                         }

                         if( RifSys->Rk[kn][adr].Dd[dd].T1[0] && !RifSys->Rk[kn][adr].Dd[dd].T1[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix  )
                         {
                            AlarmFlag = true; SoundFlag = 1;
                            POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                            sob_str += SetSob2( 20,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                         }
                      }
                      RifSys->Rk[kn][adr].Dd[dd].T1[1] = RifSys->Rk[kn][adr].Dd[dd].T1[0];

                      if( RifSys->Rk[kn][adr].Dd[dd].N1[0] )
                      {
                         if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                         {
                            n = 10;

                            if( RifSys->Rk[kn][adr].Dd[dd].S[0] || RifSys->Rk[kn][adr].Dd[dd].Ss[0] );
                            else
                            {
                                if( RifSys->Rk[kn][adr].Dd[dd].N1[0] && !RifSys->Rk[kn][adr].Dd[dd].N1[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                                {
                                    AlarmFlag = true; SoundFlag = 3;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                    sob_str += SetSob2( 12,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                        POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                        RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                                }
                            }
                         }
                         else n = 32;

                         sob_type = 12;
                      }
                      RifSys->Rk[kn][adr].Dd[dd].N1[1] = RifSys->Rk[kn][adr].Dd[dd].N1[0];

                      if( RifSys->Rk[kn][adr].Dd[dd].S[0] || RifSys->Rk[kn][adr].Dd[dd].Ss[0] )
                      {
                         RifSys->Rk[kn][adr].Dd[dd].N1[1] = 0;

                         if( RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                         {
                            n = 8;

                            if( RifSys->Rk[kn][adr].Dd[dd].S[0] && !RifSys->Rk[kn][adr].Dd[dd].S[1] && RifSys->Rk[kn][adr].Dd[dd].AlarmFix )
                            {
                                AlarmFlag = true; SoundFlag = 3;
                                POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                sob_str += SetSob2( 10,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                    RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                            }
                            else
                            {
                               if( RifSys->Rk[kn][adr].Dd[dd].Ss[0] && !RifSys->Rk[kn][adr].Dd[dd].Ss[1] && RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] == -1 )
                               {
                                   AlarmFlag = true; SoundFlag = 3;
                                   POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                   sob_str += SetSob2( 10,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Type,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num1,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num2,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Num3,
                                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "",
                                                    RifSys->Rk[kn][adr].Dd[dd].AlarmMsgOn, 0 );
                               }
                            }
                         }
                         else n = 13;

                         sob_type = 10;
                      }
                      RifSys->Rk[kn][adr].Dd[dd].S[1] = RifSys->Rk[kn][adr].Dd[dd].S[0];
                      RifSys->Rk[kn][adr].Dd[dd].Ss[1] = RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                   }

                   RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] = RifSys->Rk[kn][adr].Dd[dd].StatusChE1[0];
               }
            }

            ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->ImageIndex = n;
            ObjTree->Items->Item[RifSys->Rk[kn][adr].Dd[dd].TreeIdx]->SelectedIndex = n;
            RifSys->Rk[kn][adr].Dd[dd].sob_type = sob_type;
         }
      }

      n = 6;
      for( int uch = 0; uch < MaxTochkaMUchCnt; uch++)
      {
         if( RifSys->Rk[kn][adr].Uch[uch].Use )
         {
            if( RifSys->Rk[kn][adr].Status[0] == 10 )
            {
               RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] = 10;

               if(RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 8;
               else n = 13;

               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
            }

            if( Bod_Ok )
            {
                if( tin[uch] )
                {
                    if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                    else n = 14;

                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
                   ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
                }

                if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] > RifSys->Rk[kn][adr].Uch[uch].StatusUch[1] )
                {
                      switch( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] )
                      {
                         case   1: if( tin[uch] )
                                   {
                                      if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                                      else n = 14;
                                   }
                                   else
                                   {
                                      if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 7;
                                      else n = 12;
                                   }
                                   break;
                         case  10: if(RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                   else n = 14;
                                   break;
                         case  11: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                   else n = 14;
                                   break;
                         case  12: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                   else n = 14;
                                   break;
                         case  20: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                   else n = 14;
                                   break;
                         case  21: if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) n = 9;
                                   else n = 14;
                                   break;
                         default:  n = 6;
                                   break;
                }

                ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
                ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;

                RifSys->Rk[kn][adr].Uch[uch].StatusUch[1] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];

                if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix )
                {
                  if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] == 10 && RifSys->Rk[kn][adr].Status[0] != 10  ) POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 20;
                  else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];
                }
                else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 136;

                if( RifSys->Rk[kn][adr].Uch[uch].StatusUch[0] >= 20  && RifSys->Rk[kn][adr].Uch[uch].AlarmFix )
                {
                   POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                      if( ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->HasChildren )
                      {
                           int num1 = 0, num2 = 0, num3 = 0;
                           int k[MonCnt] = {0,0,0,0};

                           TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx];
                           TTreeNode *Node2 = Node1->getFirstChild();

                           while( Node2 )
                           {
                              num1 = POprosObj(Node2->Data)->Num1;
                              num2 = POprosObj(Node2->Data)->Num2;
                              num3 = POprosObj(Node2->Data)->Num3;
                              AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                              if( POprosObj(Node2->Data)->Type == IuIpBlType )
                              {
                                 if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                                     RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                                 RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                                 RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                              }
                              else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                              {
                                 int n1 = POprosObj(Node2->Data)->Num1 - 1;

                                 if( !ShowDevLineCam[n1] )
                                 {
                                     ShowDevLineCam[n1] = true;

                                     int n2 = POprosObj(Node2->Data)->Num2;
                                     int n3 = POprosObj(Node2->Data)->Num3;
                                     int n4 = POprosObj(Node2->Data)->X;
                                     int n5 = POprosObj(Node2->Data)->Y;
                                     int n6 = POprosObj(Node2->Data)->OutType;

                                     if( n4 < n2 ) n4 = n2 + 640;
                                     if( n5 < n3 ) n5 = n3 + 480;
                                     if( n6 != 0 ) n6 = 1;

                                   DWORD rc, exitcode;
                                   AnsiString tmp_str1, tmp_str2;
                                   tmp_str1  = DevLineFilePath;
                                   tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                                   ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                                   se1[n1].cbSize = sizeof (se1[n1]);
                                   se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                                   se1[n1].lpFile = tmp_str1.c_str();
                                   se1[n1].lpParameters =  tmp_str2.c_str();
                                   se1[n1].nShow = SW_NORMAL;
                                   ShellExecuteEx (&se1[n1]);
                                }
                              }
                              else if( POprosObj(Node2->Data)->Type == 51 )
                              {
                                 int mon = POprosObj(Node2->Data)->Num1-1;
                                 int tv = POprosObj(Node2->Data)->Num2;

                                 if( mon == 0 )
                                 {
                                    if( cam1[0] == -1 ) cam1[0] = tv;
                                    else
                                    {
                                       if( cam1[1] == -1 ) cam1[1] = tv;
                                       else
                                       {
                                          if( cam1[2] == -1 ) cam1[2] = tv;
                                          else
                                          {
                                             if( cam1[3] == -1 ) cam1[3] = tv;
                                             else
                                             {
                                                cam1[0] = cam1[1];
                                                cam1[1] = cam1[2];
                                                cam1[2] = cam1[3];
                                                cam1[3] = tv;
                                             }
                                          }
                                       }
                                    }
                                 }
                                 if( mon == 1 )
                                 {
                                    if( cam2[0] == -1 ) cam2[0] = tv;
                                    else
                                    {
                                       if( cam2[1] == -1 ) cam2[1] = tv;
                                       else
                                       {
                                          if( cam2[2] == -1 ) cam2[2] = tv;
                                          else
                                          {
                                             if( cam2[3] == -1 ) cam2[3] = tv;
                                             else
                                             {
                                                cam2[0] = cam2[1];
                                                cam2[1] = cam2[2];
                                                cam2[2] = cam2[3];
                                                cam2[3] = tv;
                                             }
                                          }
                                       }
                                    }
                                 }
                              }
                              else if( POprosObj(Node2->Data)->Type == Stn485Type )
                              {
                                 if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                                 {
                                    cam485[0] = num1;
                                    cam485[1] = num2;
                                    cam485[2] = num3;
                                    cam485_sn[0] = sn;
                                 }
                                 else
                                 {
                                    if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                                    {
                                       cam485[3] = num1;
                                       cam485[4] = num2;
                                       cam485[5] = num3;
                                       cam485_sn[1] = sn;
                                    }
                                    else
                                    {
                                       if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                       {
                                          cam485[6] = num1;
                                          cam485[7] = num2;
                                          cam485[8] = num3;
                                          cam485_sn[2] = sn;
                                       }
                                       else
                                       {
                                          if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                          {
                                             cam485[9] = num1;
                                             cam485[10] = num2;
                                             cam485[11] = num3;
                                             cam485_sn[3] = sn;
                                          }
                                          else
                                          {
                                             if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                             {
                                                cam485[12] = num1;
                                                cam485[13] = num2;
                                                cam485[14] = num3;
                                                cam485_sn[4] = sn;
                                             }
                                             else
                                             {
                                                if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                                {
                                                   cam485[15] = num1;
                                                   cam485[16] = num2;
                                                   cam485[17] = num3;
                                                   cam485_sn[5] = sn;
                                                }
                                             }
                                          }
                                       }
                                    }
                                 }
                              }
                              else if( POprosObj(Node2->Data)->Type == 52 )
                              {
                                 int tv = POprosObj(Node2->Data)->Num1;

                                 if( cam1[0] == -1 ) cam1[0] = tv;
                                 else
                                 {
                                    if( cam1[1] == -1 ) cam1[1] = tv;
                                    else
                                    {
                                       if( cam1[2] == -1 ) cam1[2] = tv;
                                       else
                                       {
                                          cam1[0] = cam1[1];
                                          cam1[1] = cam1[2];
                                          cam1[2] = tv;
                                       }
                                    }
                                 }
                              }
                              else if( POprosObj(Node2->Data)->Type == 5 )
                              {
                                 int mon = POprosObj(Node2->Data)->Num1-1;
                                 int tv = POprosObj(Node2->Data)->Num2-1;

                                 if( RastrSys->Mon[mon].Tv[tv].Use )
                                 {
                                    TvAutoNum[mon] = 0;
                                    TvAutoCnt[mon] = 0;
                                    RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                                    RastrSys->Mon[mon].Auto = true;
                                    k[mon] += 1;
                                 }
                              }
                              else if( POprosObj(Node2->Data)->Type == 6 )
                              {
                                 SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                              }
                              else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                              {
                                 if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                                 {
                                    A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                                    if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                                    {
                                       TDateTime adt = Now();
                                       int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                                       switch( t )
                                       {
                                          case 1: adt = adt + EncodeTime(0,0,5,0);
                                                  break;
                                          case 2: adt = adt + EncodeTime(0,0,10,0);
                                                  break;
                                          case 3: adt = adt + EncodeTime(0,0,30,0);
                                                  break;
                                          case 4: adt = adt + EncodeTime(0,1,0,0);
                                                  break;
                                          case 5: adt = adt + EncodeTime(0,5,0,0);
                                                  break;
                                          case 6: adt = adt + EncodeTime(0,10,0,0);
                                                  break;
                                          case 7: adt = adt + EncodeTime(0,20,0,0);
                                                  break;
                                          case 8: adt = adt + EncodeTime(0,30,0,0);
                                                  break;
                                          case 9: adt = adt + EncodeTime(1,0,0,0);
                                                  break;
                                          default: adt = adt + EncodeTime(0,0,5,0);
                                                  break;
                                       }
                                       A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                                    }
                                 }
                              }
                              Node2 = Node1->GetNextChild(Node2);
                           }
                      }
                   }
                }
            }
            else
            {
               if( RifSys->Rk[kn][adr].Uch[uch].AlarmFix ) POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = RifSys->Rk[kn][adr].Uch[uch].StatusUch[0];
               else POprosOutObj(lpMapOpros)->TochkaM[kn][uch] = 136;

               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->ImageIndex = n;
               ObjTree->Items->Item[RifSys->Rk[kn][adr].Uch[uch].TreeIdx]->SelectedIndex = n;
            }
         }
      }

      n = 6;
      if( (RifSys->Rk[kn][adr].StatusBO[0] > RifSys->Rk[kn][adr].StatusBO[1] || RifSys->Rk[kn][adr].StatusBO[0] == 10) && RifSys->Rk[kn][adr].Status[0] != 10 )
      {
             switch( RifSys->Rk[kn][adr].StatusBO[0]  )
             {
                case   1: if( vs )
                          {
                            if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                            else n = 14;
                          }
                          else
                          {
                            if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                            else n = 12;
                          }
                          break;
                case  10:
                case  11:
                case  12:
                case  20:
                case  21: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                          else n = 14;
                          break;
                default:  n = 6;
                          break;
              }

              ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
              ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;

              RifSys->Rk[kn][adr].StatusBO[1] = RifSys->Rk[kn][adr].StatusBO[0];
          }

          if( vs )
          {
              if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
              else n = 14;

              ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
              ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;
          }

          if( RifSys->Rk[kn][adr].Status[0] != RifSys->Rk[kn][adr].StatusOld[0]  )
          {
             if( RifSys->Rk[kn][adr].Status[0] >= RifSys->Rk[kn][adr].StatusBO[0] || RifSys->Rk[kn][adr].Status[0] == 10 || RifSys->Rk[kn][adr].StatusOld[0] == 10  )
             {
                switch( RifSys->Rk[kn][adr].Status[0] )
                {
                   case   1:
                   case   3: if( !vs )
                             {
                               if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                               else n = 12;
                             }
                             else
                             {
                               if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 9;
                               else n = 14;
                             }
                             break;
                   case  10: if( RifSys->Rk[kn][adr].AlarmFix[0] )
                             {
                                 n = 8;
                                 AlarmFlag = true;
                                 if(RifSys->Rk[kn][adr].StatusOld[0] != -2 )
                                 {
                                    SoundFlag = 3;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                 }
                             }
                             else n = 13;
                             break;
                   case  11: if( RifSys->Rk[kn][adr].AlarmFix[0] )
                             {
                                 n = 10;
                                 AlarmFlag = true;
                                 if(RifSys->Rk[kn][adr].StatusOld[0] != -2 )
                                 {
                                    SoundFlag = 3;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                 }
                             }
                             else n = 32;
                             break;
                   case  20: if( RifSys->Rk[kn][adr].AlarmFix[0] )
                             {
                                 n = 9;
                                 AlarmFlag = true;
                                 if(RifSys->Rk[kn][adr].StatusOld[0] != -2 )
                                 {
                                    SoundFlag = 1;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                 }
                             }
                             else n = 14;
                             break;
                   case  21: if( RifSys->Rk[kn][adr].AlarmFix[0] )
                             {
                                 n = 9;
                                 AlarmFlag = true;
                                 if(RifSys->Rk[kn][adr].StatusOld[0] != -2 )
                                 {
                                    SoundFlag = 1;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                 }
                             }
                             else n = 14;
                             break;
                   default:  n = 6;
                             break;
                }

                ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->ImageIndex = n;
                ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->SelectedIndex = n;
             }

             if( RifSys->Rk[kn][adr].StatusOld[0] != -2 && RifSys->Rk[kn][adr].AlarmFix[0] )
             {
                bool f = false;
                if( RifSys->Rk[kn][adr].Status[0] >= 10 && RifSys->Rk[kn][adr].Status[0] < 30) f = RifSys->Rk[kn][adr].AlarmMsgOn[0];

                if( RifSys->Rk[kn][adr].StatusOld[0] == 10 )
                {
                  for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
                  {
                      if( RifSys->Rk[kn][adr].Dd[dd].Use )
                      {
                         RifSys->Rk[kn][adr].Dd[dd].StatusChE1[1] = -1;
                         RifSys->Rk[kn][adr].Dd[dd].T1[1] = !RifSys->Rk[kn][adr].Dd[dd].T1[0];
                         RifSys->Rk[kn][adr].Dd[dd].S[1] = !RifSys->Rk[kn][adr].Dd[dd].S[0];
                         RifSys->Rk[kn][adr].Dd[dd].Ss[1] = !RifSys->Rk[kn][adr].Dd[dd].Ss[0];
                         RifSys->Rk[kn][adr].Dd[dd].N1[1] = !RifSys->Rk[kn][adr].Dd[dd].N1[0];
                      }
                  }
                }

                   sob_str += SetSob2( RifSys->Rk[kn][adr].Status[0],
                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Type,
                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num1,
                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num2,
                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Num3,
                                    POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", f, 0 );
             }

             RifSys->Rk[kn][adr].StatusOld[0] = RifSys->Rk[kn][adr].Status[0];
          }

          if( RifSys->Rk[kn][adr].AlarmFix[0] )
          {
             if( RifSys->Rk[kn][adr].StatusBO[0] > RifSys->Rk[kn][adr].Status[0] )
             {
                if( RifSys->Rk[kn][adr].StatusBO[0] == 10 || RifSys->Rk[kn][adr].StatusBO[0] == 11 ||
                    RifSys->Rk[kn][adr].StatusBO[0] == 12 ) POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = 20;
                else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = RifSys->Rk[kn][adr].StatusBO[0];
             }
             else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = RifSys->Rk[kn][adr].Status[0];
          }
          else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt] = 136;

          if( RifSys->Rk[kn][adr].Status[0] >= 10 || RifSys->Rk[kn][adr].StatusBO[0] >= 20)
          {
             if( ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]]->HasChildren )
             {
                 int num1 = 0, num2 = 0, num3 = 0;
                 int k[MonCnt] = {0,0,0,0};

                 TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[0]];
                 TTreeNode *Node2 = Node1->getFirstChild();

                 while( Node2 )
                 {
                    num1 = POprosObj(Node2->Data)->Num1;
                    num2 = POprosObj(Node2->Data)->Num2;
                    num3 = POprosObj(Node2->Data)->Num3;
                    AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                    if( POprosObj(Node2->Data)->Type == IuIpBlType )
                    {
                       if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                           RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                       RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                       RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                    }
                    else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                    {
                       int n1 = POprosObj(Node2->Data)->Num1 - 1;

                       if( !ShowDevLineCam[n1] )
                       {
                           ShowDevLineCam[n1] = true;

                           int n2 = POprosObj(Node2->Data)->Num2;
                           int n3 = POprosObj(Node2->Data)->Num3;
                           int n4 = POprosObj(Node2->Data)->X;
                           int n5 = POprosObj(Node2->Data)->Y;
                           int n6 = POprosObj(Node2->Data)->OutType;

                           if( n4 < n2 ) n4 = n2 + 640;
                           if( n5 < n3 ) n5 = n3 + 480;
                           if( n6 != 0 ) n6 = 1;

                           DWORD rc, exitcode;
                           AnsiString tmp_str1, tmp_str2;
                           tmp_str1  = DevLineFilePath;
                           tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                           ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                           se1[n1].cbSize = sizeof (se1[n1]);
                           se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                           se1[n1].lpFile = tmp_str1.c_str();
                           se1[n1].lpParameters =  tmp_str2.c_str();
                           se1[n1].nShow = SW_NORMAL;
                           ShellExecuteEx (&se1[n1]);
                      }
                    }
                    else if( POprosObj(Node2->Data)->Type == 51 )
                    {
                       int mon = POprosObj(Node2->Data)->Num1-1;
                       int tv = POprosObj(Node2->Data)->Num2;

                       if( mon == 0 )
                       {
                          if( cam1[0] == -1 ) cam1[0] = tv;
                          else
                          {
                             if( cam1[1] == -1 ) cam1[1] = tv;
                             else
                             {
                                if( cam1[2] == -1 ) cam1[2] = tv;
                                else
                                {
                                   if( cam1[3] == -1 ) cam1[3] = tv;
                                   else
                                   {
                                      cam1[0] = cam1[1];
                                      cam1[1] = cam1[2];
                                      cam1[2] = cam1[3];
                                      cam1[3] = tv;
                                   }
                                }
                             }
                          }
                       }
                       if( mon == 1 )
                       {
                          if( cam2[0] == -1 ) cam2[0] = tv;
                          else
                          {
                             if( cam2[1] == -1 ) cam2[1] = tv;
                             else
                             {
                                if( cam2[2] == -1 ) cam2[2] = tv;
                                else
                                {
                                   if( cam2[3] == -1 ) cam2[3] = tv;
                                   else
                                   {
                                      cam2[0] = cam2[1];
                                      cam2[1] = cam2[2];
                                      cam2[2] = cam2[3];
                                      cam2[3] = tv;
                                   }
                                }
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == Stn485Type )
                    {
                       if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                       {
                          cam485[0] = num1;
                          cam485[1] = num2;
                          cam485[2] = num3;
                          cam485_sn[0] = sn;
                       }
                       else
                       {
                          if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                          {
                             cam485[3] = num1;
                             cam485[4] = num2;
                             cam485[5] = num3;
                             cam485_sn[1] = sn;
                          }
                          else
                          {
                             if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                             {
                                cam485[6] = num1;
                                cam485[7] = num2;
                                cam485[8] = num3;
                                cam485_sn[2] = sn;
                             }
                             else
                             {
                                if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                {
                                   cam485[9] = num1;
                                   cam485[10] = num2;
                                   cam485[11] = num3;
                                   cam485_sn[3] = sn;
                                }
                                else
                                {
                                   if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                   {
                                      cam485[12] = num1;
                                      cam485[13] = num2;
                                      cam485[14] = num3;
                                      cam485_sn[4] = sn;
                                   }
                                   else
                                   {
                                      if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                      {
                                         cam485[15] = num1;
                                         cam485[16] = num2;
                                         cam485[17] = num3;
                                         cam485_sn[5] = sn;
                                      }
                                   }
                                }
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 52 )
                    {
                       int tv = POprosObj(Node2->Data)->Num1;

                       if( cam1[0] == -1 ) cam1[0] = tv;
                       else
                       {
                          if( cam1[1] == -1 ) cam1[1] = tv;
                          else
                          {
                             if( cam1[2] == -1 ) cam1[2] = tv;
                             else
                             {
                                cam1[0] = cam1[1];
                                cam1[1] = cam1[2];
                                cam1[2] = tv;
                             }
                          }
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 5 )
                    {
                       int mon = POprosObj(Node2->Data)->Num1-1;
                       int tv = POprosObj(Node2->Data)->Num2-1;

                       if( RastrSys->Mon[mon].Tv[tv].Use )
                       {
                          TvAutoNum[mon] = 0;
                          TvAutoCnt[mon] = 0;
                          RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                          RastrSys->Mon[mon].Auto = true;
                          k[mon] += 1;
                       }
                    }
                    else if( POprosObj(Node2->Data)->Type == 6 )
                    {
                       SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                    }
                    else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                    {
                       if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                       {
                          A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                          if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                          {
                             TDateTime adt = Now();
                             int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                             switch( t )
                             {
                                case 1: adt = adt + EncodeTime(0,0,5,0);
                                        break;
                                case 2: adt = adt + EncodeTime(0,0,10,0);
                                        break;
                                case 3: adt = adt + EncodeTime(0,0,30,0);
                                        break;
                                case 4: adt = adt + EncodeTime(0,1,0,0);
                                        break;
                                case 5: adt = adt + EncodeTime(0,5,0,0);
                                        break;
                                case 6: adt = adt + EncodeTime(0,10,0,0);
                                        break;
                                case 7: adt = adt + EncodeTime(0,20,0,0);
                                        break;
                                case 8: adt = adt + EncodeTime(0,30,0,0);
                                        break;
                                case 9: adt = adt + EncodeTime(1,0,0,0);
                                        break;
                                default: adt = adt + EncodeTime(0,0,5,0);
                                        break;
                             }
                             A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                          }
                       }
                    }
                    Node2 = Node1->GetNextChild(Node2);
                 }
             }
      }

      if( sob_str.Length() > 0 )
      {
         if( sob_str.Length() > 0 )
         {
            Table1->FlushBuffers();
            ShowPrCnt();
         }

         if( MySQL_use > 0 )
         {
             AnsiString query, err_str;
             int err_code = 0;

             if( sob_str.Length() > 0 )
             {
                sob_str.Delete(sob_str.Length(),1);
                sob_str.Insert(";", sob_str.Length()+1);

                query = "";
                query.sprintf("INSERT INTO %s.events VALUES%s", MySQL_dbname, sob_str);
                mysql_real_query(Con,query.c_str(),query.Length());
                err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
             }
         }
      }
   }
   else  
   {
      for( int sd = 0; sd < MaxInCnt; sd++)
      {
         if( RifSys->Rk[kn][adr].InUse[sd] )
         {
             if( RifSys->Rk[kn][adr].StatusOld[sd] != RifSys->Rk[kn][adr].Status[sd] )
             {
                 int n = 6;
                 switch( RifSys->Rk[kn][adr].Status[sd] )
                 {
                    case  1: if( !vs && !tin[sd] )
                             {
                                if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                else n = 12;
                             }
                             else
                             {
                                if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                else n = 14;
                             }
                             break;
                    case  2: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                             else n = 12;
                             break;
                    case  3: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                             else n = 12;
                             break;
                    case  4: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                             else n = 12;
                             break;
                    case 10: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 8;  POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 13;
                             break;
                    case 11: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 10; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 32;
                             break;
                    case 18: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 10; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 32;
                             break;
                    case 20: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 9; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 14;
                             break;
                    case 21: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 9; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 14;
                             break;
                    case 23: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 9; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 14;
                             break;
                    case 24: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) { n = 9; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; }
                             else n = 14;
                             break;
                   case 100: n = 11;
                             break;
                   case 101: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                             else n = 12;
                             break;
                    default:
                             n = 6;
                             break;
                 }
                 ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->ImageIndex = n;
                 ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->SelectedIndex = n;

                if( RifSys->Rk[kn][adr].AlarmFix[sd] )
                {
                   if( RifSys->Rk[kn][adr].Status[sd] == 3 && RifSys->Rk[kn][adr].AutoDk );
                   else if( RifSys->Rk[kn][adr].Status[sd] == 1 && RifSys->Rk[kn][adr].AutoDk );
                   else
                   {
                      if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 30 )
                      {
                         AlarmFlag = true;

                         if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 20 ) SoundFlag = 3;
                         else SoundFlag = 1;

                         SetSob4(RifSys->Rk[kn][adr].Status[sd],
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", RifSys->Rk[kn][adr].AlarmMsgOn[sd], 0 );
                      }
                      else
                      {
                         if( !vs && !tin[sd] )
                         SetSob4(RifSys->Rk[kn][adr].Status[sd],
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                              POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                      }

                      if( RifSys->Rk[kn][adr].AutoDk ) RifSys->Rk[kn][adr].AutoDk = false;
                   }

                   if( ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->HasChildren &&
                       RifSys->Rk[kn][adr].Status[sd] >= 20 && RifSys->Rk[kn][adr].Status[sd] < 30 )
                   {
                       int num1 = 0, num2 = 0, num3 = 0;
                       int k[MonCnt] = {0,0,0,0};

                       TTreeNode *Node1 = ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]];
                       TTreeNode *Node2 = Node1->getFirstChild();

                       while( Node2 )
                       {
                          num1 = POprosObj(Node2->Data)->Num1;
                          num2 = POprosObj(Node2->Data)->Num2;
                          num3 = POprosObj(Node2->Data)->Num3;
                          AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

                          if( POprosObj(Node2->Data)->Type == IuIpBlType )
                          {
                             if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 100 )
                                 RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                             RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                             RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                          }
                          else if( POprosObj(Node2->Data)->Type == DevLineIdx )
                          {
                             int n1 = POprosObj(Node2->Data)->Num1 - 1;

                             if( !ShowDevLineCam[n1] )
                             {
                                 ShowDevLineCam[n1] = true;

                                 int n2 = POprosObj(Node2->Data)->Num2;
                                 int n3 = POprosObj(Node2->Data)->Num3;
                                 int n4 = POprosObj(Node2->Data)->X;
                                 int n5 = POprosObj(Node2->Data)->Y;
                                 int n6 = POprosObj(Node2->Data)->OutType;

                                 if( n4 < n2 ) n4 = n2 + 640;
                                 if( n5 < n3 ) n5 = n3 + 480;
                                 if( n6 != 0 ) n6 = 1;

                               DWORD rc, exitcode;
                               AnsiString tmp_str1, tmp_str2;
                               tmp_str1  = DevLineFilePath;
                               tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

                               ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
                               se1[n1].cbSize = sizeof (se1[n1]);
                               se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
                               se1[n1].lpFile = tmp_str1.c_str();
                               se1[n1].lpParameters =  tmp_str2.c_str();
                               se1[n1].nShow = SW_NORMAL;
                               ShellExecuteEx (&se1[n1]);
                            }
                          }
                          else if( POprosObj(Node2->Data)->Type == 51 )
                          {
                             int mon = POprosObj(Node2->Data)->Num1-1;
                             int tv = POprosObj(Node2->Data)->Num2;

                             if( mon == 0 )
                             {
                                if( cam1[0] == -1 ) cam1[0] = tv;
                                else
                                {
                                   if( cam1[1] == -1 ) cam1[1] = tv;
                                   else
                                   {
                                      if( cam1[2] == -1 ) cam1[2] = tv;
                                      else
                                      {
                                         if( cam1[3] == -1 ) cam1[3] = tv;
                                         else
                                         {
                                            cam1[0] = cam1[1];
                                            cam1[1] = cam1[2];
                                            cam1[2] = cam1[3];
                                            cam1[3] = tv;
                                         }
                                      }
                                   }
                                }
                             }
                             if( mon == 1 )
                             {
                                if( cam2[0] == -1 ) cam2[0] = tv;
                                else
                                {
                                   if( cam2[1] == -1 ) cam2[1] = tv;
                                   else
                                   {
                                      if( cam2[2] == -1 ) cam2[2] = tv;
                                      else
                                      {
                                         if( cam2[3] == -1 ) cam2[3] = tv;
                                         else
                                         {
                                            cam2[0] = cam2[1];
                                            cam2[1] = cam2[2];
                                            cam2[2] = cam2[3];
                                            cam2[3] = tv;
                                         }
                                      }
                                   }
                                }
                             }
                          }
                          else if( POprosObj(Node2->Data)->Type == Stn485Type )
                          {
                             if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                             {
                                cam485[0] = num1;
                                cam485[1] = num2;
                                cam485[2] = num3;
                                cam485_sn[0] = sn;
                             }
                             else
                             {
                                if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                                {
                                   cam485[3] = num1;
                                   cam485[4] = num2;
                                   cam485[5] = num3;
                                   cam485_sn[1] = sn;
                                }
                                else
                                {
                                   if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                   {
                                      cam485[6] = num1;
                                      cam485[7] = num2;
                                      cam485[8] = num3;
                                      cam485_sn[2] = sn;
                                   }
                                   else
                                   {
                                      if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                      {
                                         cam485[9] = num1;
                                         cam485[10] = num2;
                                         cam485[11] = num3;
                                         cam485_sn[3] = sn;
                                      }
                                      else
                                      {
                                         if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                         {
                                            cam485[12] = num1;
                                            cam485[13] = num2;
                                            cam485[14] = num3;
                                            cam485_sn[4] = sn;
                                         }
                                         else
                                         {
                                            if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                            {
                                               cam485[15] = num1;
                                               cam485[16] = num2;
                                               cam485[17] = num3;
                                               cam485_sn[5] = sn;
                                            }
                                         }
                                      }
                                   }
                                }
                             }
                          }
                          else if( POprosObj(Node2->Data)->Type == 52 )
                          {
                             int tv = POprosObj(Node2->Data)->Num1;

                             if( cam1[0] == -1 ) cam1[0] = tv;
                             else
                             {
                                if( cam1[1] == -1 ) cam1[1] = tv;
                                else
                                {
                                   if( cam1[2] == -1 ) cam1[2] = tv;
                                   else
                                   {
                                      cam1[0] = cam1[1];
                                      cam1[1] = cam1[2];
                                      cam1[2] = tv;
                                   }
                                }
                             }
                          }
                          else if( POprosObj(Node2->Data)->Type == 5 )
                          {
                             int mon = POprosObj(Node2->Data)->Num1-1;
                             int tv = POprosObj(Node2->Data)->Num2-1;

                             if( RastrSys->Mon[mon].Tv[tv].Use )
                             {
                                TvAutoNum[mon] = 0;
                                TvAutoCnt[mon] = 0;
                                RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                                RastrSys->Mon[mon].Auto = true;
                                k[mon] += 1;
                             }
                          }
                          else if( POprosObj(Node2->Data)->Type == 6 )
                          {
                             SolidSys->SetTv(POprosObj(Node2->Data)->Num1, true);
                          }
                          else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
                          {
                             if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
                             {
                                A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                                if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                                {
                                   TDateTime adt = Now();
                                   int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                                   switch( t )
                                   {
                                      case 1: adt = adt + EncodeTime(0,0,5,0);
                                              break;
                                      case 2: adt = adt + EncodeTime(0,0,10,0);
                                              break;
                                      case 3: adt = adt + EncodeTime(0,0,30,0);
                                              break;
                                      case 4: adt = adt + EncodeTime(0,1,0,0);
                                              break;
                                      case 5: adt = adt + EncodeTime(0,5,0,0);
                                              break;
                                      case 6: adt = adt + EncodeTime(0,10,0,0);
                                              break;
                                      case 7: adt = adt + EncodeTime(0,20,0,0);
                                              break;
                                      case 8: adt = adt + EncodeTime(0,30,0,0);
                                              break;
                                      case 9: adt = adt + EncodeTime(1,0,0,0);
                                              break;
                                      default: adt = adt + EncodeTime(0,0,5,0);
                                              break;
                                   }
                                   A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                                }
                             }
                          }
                          Node2 = Node1->GetNextChild(Node2);
                       }



                   }
                 }
                 RifSys->Rk[kn][adr].StatusOld[sd] = RifSys->Rk[kn][adr].Status[sd];
             }

             if( vs != RifSys->Rk[kn][adr].Sv[sd]  && RifSys->Rk[kn][adr].Status[sd] != 0 && RifSys->Rk[kn][adr].ErrCnt == 0 )
             {
                int n = 6;

                if( vs )
                {
                   if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                   else n = 14;
                }
                else
                {
                     switch( RifSys->Rk[kn][adr].Status[sd] )
                     {
                        case  1: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                 else n = 12;
                                 break;
                        case  2: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                 else n = 12;
                                 break;
                        case  3: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                 else n = 12;
                                 break;
                         case 4: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 7;
                                 else n = 12;
                                 break;
                        case 10: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 8;
                                 else n = 13;
                                 break;
                        case 11: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 10;
                                 else n = 32;
                                 break;
                        case 18: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 10;
                                 else n = 32;
                                 break;
                        case 20: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                 else n = 14;
                                 break;
                        case 21: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                 else n = 14;
                                 break;
                        case 23: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                 else n = 14;
                                 break;
                        case 24: if( RifSys->Rk[kn][adr].AlarmFix[sd] ) n = 9;
                                 else n = 14;
                                 break;
                       case 100: n = 11;
                                 break;
                       case 101: if( RifSys->Rk[kn][adr].AlarmFix[0] ) n = 7;
                                 else n = 12;
                                 break;
                        default:
                                 n = 6;
                                 break;
                     }

                     if( RifSys->Rk[kn][adr].Status[sd] == 3 && RifSys->Rk[kn][adr].AutoDk );
                     else if( RifSys->Rk[kn][adr].Status[sd] == 1 && RifSys->Rk[kn][adr].AutoDk );
                     else
                     {
                       if( RifSys->Rk[kn][adr].Status[sd] >= 10 && RifSys->Rk[kn][adr].Status[sd] < 30 && RifSys->Rk[kn][adr].AlarmFix[sd] )
                          SetSob4( RifSys->Rk[kn][adr].Status[sd],
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", RifSys->Rk[kn][adr].AlarmMsgOn[sd], 0 );
                       else
                       {
                          if( !vs && !tin[sd] && RifSys->Rk[kn][adr].AlarmFix[sd] )
                          SetSob4( RifSys->Rk[kn][adr].Status[sd],
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Type,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                       }
                     }
                }
                ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->ImageIndex = n;
                ObjTree->Items->Item[RifSys->Rk[kn][adr].TreeIdx[sd]]->SelectedIndex = n;

                RifSys->Rk[kn][adr].Sv[sd] = vs;
             }

             if( RifSys->Rk[kn][adr].AlarmFix[sd] ) POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd] = RifSys->Rk[kn][adr].Status[sd];
             else POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+sd] = 136;
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowNewGobiStatus()
{
   if( GobiSys->Status != GobiSys->StatusOld )
   {
      if( GobiSys->Status == 200 )
      {
         SetSob( GobiSys->Status,
                 0,
                 0,
                 0,
                 0,
                 SetSobStr03 , OpFn, OpN1, OpN2, "", "", "", GobiSys->AlarmMsgOn, 0 );

         for( int kan = 0; kan < KanCnt; kan++ )
         {
            if( GobiSys->Kanal[kan].Use )
            {
               for( int bl = 0; bl < BlCnt; bl++ )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Use )
                  {
                     for( int sd = 0; sd < SdCnt; sd++ )
                     {
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use )
                        {
                           GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 10;
                           GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 10;
                           GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 10;
                        }
                     }

                     for( int iu = 0; iu < IuCnt; iu++ )
                     {
                        if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Use )
                        {
                           GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status = 10;
                           GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = 10;
                           GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld = 10;
                        }
                     }
                  }
               }
            }
         }
      }
      GobiSys->StatusOld = GobiSys->Status;
   }

   for( int kan = 0; kan < KanCnt; kan++ )
   {
      if( GobiSys->Kanal[kan].Use )
      {
         for( int bl = 0; bl < BlCnt; bl++ )
         {
            if( GobiSys->Kanal[kan].Bl[bl].Use )
            {
               if( SsoiVersion == 1 )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Tv ) GobiSys->Kanal[kan].Bl[bl].Sd[8].Status = 25;
                  else
                  {
                     if( GobiSys->Kanal[kan].Bl[bl].ErrCnt == 0 && GobiSys->Status != 200 )
                        GobiSys->Kanal[kan].Bl[bl].Sd[8].Status = 1;
                  }
               }

               for( int sd = 0; sd < SdCnt; sd++ )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use )
                  {
                     TDateTime dtMetka = Now();
                     TDate dtDate = (int)dtMetka;
                     TTime dtTime = dtMetka - (int)dtMetka;

                     if( dtDate != OprosDate )
                     {
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok = false;
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok = false;
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok = false;
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok = false;
                        OprosDate = dtDate;
                     }

                     if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka )
                     {
                        TTime dt1, dt2, dt3, dt4;
                        if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Time != 0.0 )
                           dt1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Time + GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                        if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Time != 0.0 )
                           dt2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Time + GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                        if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Time != 0.0 )
                           dt3 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Time + GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                        if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Time != 0.0 )
                           dt4 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Time + GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;

                        if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok )
                        {
                           if( dtTime >= dt1 && (double)dt1 != 0.0 )
                           {
                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok &&
                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok = true;
                              }
                           }
                        }

                        if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok )
                        {
                           if( dtTime >= dt2 && (double)dt2 != 0 )
                           {
                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok &&
                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok = true;
                              }
                           }
                        }

                        if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok )
                        {
                           if( dtTime >= dt3 && (double)dt3 != 0 )
                           {
                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok &&
                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok = true;
                              }
                           }
                        }

                        if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok )
                        {
                           if( dtTime >= dt4 && (double)dt4 != 0 )
                           {
                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok &&
                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                              {
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 26;
                                 GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok = true;
                              }
                           }
                        }
                     }

                     if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 )
                     {
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                     }
                     else
                     {
                         if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld )
                         {
                           if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 11 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld == 11 )
                           {
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk = true;
                           }
                           else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 3 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld == 3 )
                           {
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk = true;
                           }
                           else GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk = false;

                           GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                         }
                         else
                         {
/*
                           if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 2 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                           {
                              SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status+1,
                                      3, (kan+1),(bl+1),(sd+1),
                                      POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name);
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                           }
*/
                           if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use &&
                               GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 &&
                               GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld2 &&
                               GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 2 )
                           {
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;

                              if( GobiFixNewWarning == 1 )
                              {
                                  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix >= 10 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix < 30 )
                                  {
                                      if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status >= 10 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status < 30 )
                                      {
                                          if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix )
                                          {
                                             if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt ) goto m321;
                                          }
                                          else GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                                      }
                                      else
                                      {
                                          if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt ) goto m321;
                                      }
                                  }
                                  else GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                              }

                              int n = 6;
                              bool auto_on = false;
                              switch( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status )
                              {
                                 case  10: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) { n = 8; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 3 ) SoundFlag = 3;}
                                           else n = 13;
                                           break;
                                 case   1: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                                           {
                                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt ) n = 7;
                                              else  n = 37; 

                                              if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].ConnectBlock )
                                              {
                                                 if( GobiSys->Kanal[kan].Bl[bl].Iu[sd-3].Status == 1 ) n = 44;
                                                 else n = 43;
                                              }
                                           }
                                           else n = 12;
                                           break;
                                 case  20: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                                           {
                                             n = 9;
                                             if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn )
                                             {
                                                auto_on = true; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].ConnectBlock ) SoundFlag = 1;
                                                else { SoundFlag = 2; n = 44; }
                                             }
                                           }
                                           else n = 14;
                                           break;
                                 case  26: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) { n = 9; auto_on = true; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1;}
                                           else n = 14;
                                           break;
                                 case  21: {
                                              if( GobiSys->Kanal[kan].Bl[bl].Iu[sd].Status != 1 )
                                              {
                                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                                                 {
                                                    if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                                                    {
                                                      n = 9; 
                                                      if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn )
                                                      {
                                                         auto_on = true; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1;
                                                      }
                                                    }
                                                    else
                                                    {
                                                      n = 38;
                                                      if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn )
                                                      { auto_on = true; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1; }
                                                    }
                                                 }
                                                 else n = 14;
                                              }
                                              else
                                              {
                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt ) n = 23;
                                                else n = 38;
//                                                GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;
                                              }
                                           }
                                           break;
                                 case 25:  if( SsoiVersion == 1 )
                                           {
                                              if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                                              {
                                                n = 9;

                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn )
                                                {   auto_on = true; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1; }
                                              }
                                              else n = 14;
                                           }
                                           break;
                                 case  11: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) { n = 10; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 1 ) SoundFlag = 3;}
                                           else n = 32;
                                           break;
                                 case  17: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) { n = 9; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 1 ) SoundFlag = 3;}
                                           else n = 14;
                                           break;
                                 case  13: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) { n = 10; AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 1 ) SoundFlag = 3;}
                                           else n = 32;
                                           break;
                              }

                              ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->ImageIndex = n;
                              ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->SelectedIndex = n;

                              handCamstr = POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name;

                              if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                              {
                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 10 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 11 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 17 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 20 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 26 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 21 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 25 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 13 ||
                                     GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 3 )
                                 {
                                    if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 10 && GobiSys->Status != 200 )
                                    {
                                       SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                               3, (kan+1),(bl+1),(sd+1),
                                               POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                               POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                    }

                                    if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 10 && GobiSys->Status != 200  )
                                    {
                                       if( (GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 || GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 21) && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                                       {
                                          int ius = 100;
                                          switch( GobiSys->Kanal[kan].Bl[bl].Iu[sd].Status )
                                          {
                                             case   1: ius = 101;
                                                       break;
                                             case   2: ius = 100;
                                                       break;
                                          }

                                          if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 && ius == 101 ) 
                                              SetSob( 112, 3, (kan+1),(bl+1),(sd+1), POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                                                      POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                          else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 21 && ius == 101 ) 
                                             SetSob( 111, 3, (kan+1),(bl+1),(sd+1), POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                                                      POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                          else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 && ius == 100 ) 
                                             SetSob( 110, 3, (kan+1),(bl+1),(sd+1), POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                                                      POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                          else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 21 && ius == 100 ) 
                                             SetSob( 113, 3, (kan+1),(bl+1),(sd+1), POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                                                      POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                       }
                                       else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 20 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].ConnectBlock )
                                       {
                                          if( GobiSys->Kanal[kan].Bl[bl].Iu[sd-3].Status != 1 )
                                          {
                                             SetSob( 145,
                                                     3, (kan+1),(bl+1),(sd+1),
                                                     POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                     POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                          }
                                          else
                                          {
                                             SetSob( 144,
                                                     3, (kan+1),(bl+1),(sd+1),
                                                     POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                     POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );

                                             GobiSys->Kanal[kan].Bl[bl].Iu[sd-3].hCmd = 1;

                                             GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;
                                             GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 1;
                                             GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 1;
                                             GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld2 = 1;
                                          }
                                       }
                                       else if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 20 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka )
                                       {
                                         
                                          GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;
                                          TTime dt1, dt2;

                                          if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Time != 0.0 )
                                          {
                                             dt1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Time -
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             dt2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Time +
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             if( dtTime >= dt1 && dtTime <= dt2 )
                                             {
                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok )
                                                {
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 5;
                                                   SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                           3, (kan+1),(bl+1),(sd+1),
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka1Ok = true;
                                                   if( SoundFlag != 1 ) SoundFlag = 2;
                                                }
                                             }
                                          }

                                          if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Time != 0.0 )
                                          {
                                             dt1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Time -
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             dt2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Time +
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             if( dtTime >= dt1 && dtTime <= dt2 )
                                             {
                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok )
                                                {
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 5;
                                                   SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                           3, (kan+1),(bl+1),(sd+1),
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka2Ok = true;
                                                   if( SoundFlag != 1 ) SoundFlag = 2;
                                                }
                                             }
                                          }

                                          if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Time != 0.0 )
                                          {
                                             dt1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Time -
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             dt2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Time +
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             if( dtTime >= dt1 && dtTime <= dt2 )
                                             {
                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok )
                                                {
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 5;
                                                   SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                           3, (kan+1),(bl+1),(sd+1),
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka3Ok = true;
                                                   if( SoundFlag != 1 ) SoundFlag = 2;
                                                }
                                             }
                                          }

                                          if( (double)GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Time != 0.0 )
                                          {
                                             dt1 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Time -
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             dt2 = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Time +
                                                         GobiSys->Kanal[kan].Bl[bl].Sd[sd].MetkaDopuskTime;
                                             if( dtTime >= dt1 && dtTime <= dt2 )
                                             {
                                                if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok )
                                                {
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 5;
                                                   SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                           3, (kan+1),(bl+1),(sd+1),
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                                   GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka4Ok = true;
                                                   if( SoundFlag != 1 ) SoundFlag = 2;
                                                }
                                             }
                                          }
                                       }
                                       else
                                       {
                                          if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Metka && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 );
                                          else
                                          {
//                                             if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk )
                                             {
                                                if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status >= 10 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status < 30 )
                                                {
                                                   if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk && !GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn )
                                                   {
                                                      SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                              3, (kan+1),(bl+1),(sd+1),
                                                              POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                              POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );

                                                   }
                                                   else
                                                   {
                                                      SetSob3( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                              3, (kan+1),(bl+1),(sd+1),
                                                              POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmMsgOn,
                                                              POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );

                                                   }

                                                }
                                                else
                                                   SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status,
                                                           3, (kan+1),(bl+1),(sd+1),
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                                                           POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->OutType );
                                             }
                                          }
                                       }
                                    }

                                    GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleDk = false;
                                    GobiSys->Kanal[kan].Bl[bl].Sd[sd].PervoeSobytiePosleControlOn = false;
                                 }

                                 if( sd < 3 ) POprosOutObj(lpMapOpros)->GobiIu[kan*BlCnt*IuCnt + bl*IuCnt + sd] = GobiSys->Kanal[kan].Bl[bl].Iu[sd].Status;
                                 POprosOutObj(lpMapOpros)->GobiSd[kan*BlCnt*SdCnt + bl*SdCnt + sd] = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;

                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 13 )
                                 {
                                       GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 0;
                                       GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 0;
                                       GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 0;
                                 }

                              }
                              else POprosOutObj(lpMapOpros)->GobiSd[kan*BlCnt*SdCnt + bl*SdCnt + sd] = 136;

                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].OnOffCnt = 0;
                              GroupBox5->Visible = false;

                              if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix && auto_on &&
                                  ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->HasChildren )
                              {
                                 int idx = 0, k1 = 0, b1 = 0, i1 = 0;
                                 int k[MonCnt] = {0,0,0,0};
                                 for( int i = 0; i < ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Count; i++ )
                                 {
                                    idx = ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->AbsoluteIndex+i+1;
                                    if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 4 )
                                    {
                                       k1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                                       b1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2-1;
                                       i1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3-1;

                                       if( GobiSys->Kanal[k1].Bl[b1].Iu[i1].Status == 2 &&
                                           GobiSys->Kanal[k1].Bl[b1].Iu[i1].hCmd == 0 )
                                       {
                                          if( GobiSys->Kanal[k1].Bl[b1].Iu[i1].AutoOff > 0 )
                                          {
                                             TDateTime adt = Now();
                                             int t = GobiSys->Kanal[k1].Bl[b1].Iu[i1].AutoOff;
                                             switch( t )
                                             {
                                                case 1: adt = adt + EncodeTime(0,0,5,0);
                                                        break;
                                                case 2: adt = adt + EncodeTime(0,0,10,0);
                                                        break;
                                                case 3: adt = adt + EncodeTime(0,0,30,0);
                                                        break;
                                                case 4: adt = adt + EncodeTime(0,1,0,0);
                                                        break;
                                                case 5: adt = adt + EncodeTime(0,5,0,0);
                                                        break;
                                                case 6: adt = adt + EncodeTime(0,10,0,0);
                                                        break;
                                                case 7: adt = adt + EncodeTime(0,20,0,0);
                                                        break;
                                                case 8: adt = adt + EncodeTime(0,30,0,0);
                                                        break;
                                                case 9: adt = adt + EncodeTime(1,0,0,0);
                                                        break;
                                                default: adt = adt + EncodeTime(0,0,5,0);
                                                         break;
                                             }
                                             GobiSys->Kanal[k1].Bl[b1].Iu[i1].OffDt = adt;
                                          }

                                          GobiSys->Kanal[k1].Bl[b1].Iu[i1].hCmd = 2;
                                          GobiSys->Kanal[k1].Bl[b1].Iu[i1].status1 = GobiSys->Kanal[k1].Bl[b1].Iu[i1].Status;
                                          GobiSys->Kanal[k1].Bl[b1].Iu[i1].StatusOld = GobiSys->Kanal[k1].Bl[b1].Iu[i1].Status;
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 41 )
                                    {
                                       k1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                                       b1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2-1;
                                       i1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3-1;

                                       HandCam.k = -1;
                                       HandCam.bl = -1;
                                       HandCam.iu = -1;
                                       HandCam.hcmd = -1;

                                       GobiSys->GobiCam[0].k = GobiSys->GobiCam[1].k;
                                       GobiSys->GobiCam[0].bl = GobiSys->GobiCam[1].bl;
                                       GobiSys->GobiCam[0].iu = GobiSys->GobiCam[1].iu;
                                       GobiSys->GobiCam2[0].k = GobiSys->GobiCam[1].k;
                                       GobiSys->GobiCam2[0].bl = GobiSys->GobiCam[1].bl;
                                       GobiSys->GobiCam2[0].iu = GobiSys->GobiCam[1].iu;

                                       GobiSys->GobiCam[1].k = GobiSys->GobiCam[2].k;
                                       GobiSys->GobiCam[1].bl = GobiSys->GobiCam[2].bl;
                                       GobiSys->GobiCam[1].iu = GobiSys->GobiCam[2].iu;
                                       GobiSys->GobiCam2[1].k = GobiSys->GobiCam[2].k;
                                       GobiSys->GobiCam2[1].bl = GobiSys->GobiCam[2].bl;
                                       GobiSys->GobiCam2[1].iu = GobiSys->GobiCam[2].iu;

                                       GobiSys->GobiCam[2].k = GobiSys->GobiCam[3].k;
                                       GobiSys->GobiCam[2].bl = GobiSys->GobiCam[3].bl;
                                       GobiSys->GobiCam[2].iu = GobiSys->GobiCam[3].iu;
                                       GobiSys->GobiCam2[2].k = GobiSys->GobiCam[3].k;
                                       GobiSys->GobiCam2[2].bl = GobiSys->GobiCam[3].bl;
                                       GobiSys->GobiCam2[2].iu = GobiSys->GobiCam[3].iu;

                                       GobiSys->GobiCam[3].k = k1;
                                       GobiSys->GobiCam[3].bl = b1;
                                       GobiSys->GobiCam[3].iu = i1;
                                       GobiSys->GobiCam2[3].k = k1;
                                       GobiSys->GobiCam2[3].bl = b1;
                                       GobiSys->GobiCam2[3].iu = i1;
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 5 && RastrPortNum != 0 )
                                    {
                                       int mon = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                                       int tv = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2-1;

                                       TvAutoNum[mon] = 0;
                                       TvAutoCnt[mon] = 0;
                                       if( RastrSys->Mon[mon].Tv[tv].Use )
                                       {
                                          RastrSys->Mon[mon].AutoTv[k[mon]] = tv+1;
                                          RastrSys->Mon[mon].Auto = true;
                                          k[mon] += 1;
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 51 )
                                    {
                                       int mon = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                                       int tv = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;

                                       if( mon == 0 )
                                       {
                                          if( cam1[0] == -1 ) cam1[0] = tv;
                                          else
                                          {
                                             if( cam1[1] == -1 ) cam1[1] = tv;
                                             else
                                             {
                                                if( cam1[2] == -1 ) cam1[2] = tv;
                                                else
                                                {
                                                   if( cam1[3] == -1 ) cam1[3] = tv;
                                                   else
                                                   {
                                                      cam1[0] = cam1[1];
                                                      cam1[1] = cam1[2];
                                                      cam1[2] = cam1[3];
                                                      cam1[3] = tv;
                                                   }
                                                }
                                             }
                                          }
                                       }
                                       if( mon == 1 )
                                       {
                                          if( cam2[0] == -1 ) cam2[0] = tv;
                                          else
                                          {
                                             if( cam2[1] == -1 ) cam2[1] = tv;
                                             else
                                             {
                                                if( cam2[2] == -1 ) cam2[2] = tv;
                                                else
                                                {
                                                   if( cam2[3] == -1 ) cam2[3] = tv;
                                                   else
                                                   {
                                                      cam2[0] = cam2[1];
                                                      cam2[1] = cam2[2];
                                                      cam2[2] = cam2[3];
                                                      cam2[3] = tv;
                                                   }
                                                }
                                             }
                                          }
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == Stn485Type )
                                    {
                                       int num1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1;
                                       int num2 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;
                                       int num3 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3;
                                       AnsiString sn = POprosObj(ObjTree->Items->Item[idx]->Data)->Icon1Path;

                                       if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                                       {
                                          cam485[0] = num1;
                                          cam485[1] = num2;
                                          cam485[2] = num3;
                                          cam485_sn[0] = sn;
                                       }
                                       else
                                       {
                                          if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                                          {
                                             cam485[3] = num1;
                                             cam485[4] = num2;
                                             cam485[5] = num3;
                                             cam485_sn[1] = sn;
                                          }
                                          else
                                          {
                                             if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                             {
                                                cam485[6] = num1;
                                                cam485[7] = num2;
                                                cam485[8] = num3;
                                                cam485_sn[2] = sn;
                                             }
                                             else
                                             {
                                                if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                                {
                                                   cam485[9] = num1;
                                                   cam485[10] = num2;
                                                   cam485[11] = num3;
                                                   cam485_sn[3] = sn;
                                                }
                                                else
                                                {
                                                   if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                                   {
                                                      cam485[12] = num1;
                                                      cam485[13] = num2;
                                                      cam485[14] = num3;
                                                      cam485_sn[4] = sn;
                                                   }
                                                   else
                                                   {
                                                      if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                                      {
                                                         cam485[15] = num1;
                                                         cam485[16] = num2;
                                                         cam485[17] = num3;
                                                         cam485_sn[5] = sn;
                                                      }
                                                   }
                                                }
                                             }
                                          }
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 52 )
                                    {
                                       int tv = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1;

                                       if( cam1[0] == -1 ) cam1[0] = tv;
                                       else
                                       {
                                          if( cam1[1] == -1 ) cam1[1] = tv;
                                          else
                                          {
                                             if( cam1[2] == -1 ) cam1[2] = tv;
                                             else
                                             {
                                                cam1[0] = cam1[1];
                                                cam1[1] = cam1[2];
                                                cam1[2] = tv;
                                             }
                                          }
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 6 && SolidPortNum != 0 )
                                    {
                                       SolidSys->SetTv(POprosObj(ObjTree->Items->Item[idx]->Data)->Num1, true);
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 7 && Adam4068PortNum != 0 )
                                    {
                                       if( A4068Sys->Dev[POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1].Out[POprosObj(ObjTree->Items->Item[idx]->Data)->Num2] != 101 )
                                       {
                                          A4068Sys->Dev[POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1].Cmd[POprosObj(ObjTree->Items->Item[idx]->Data)->Num2] = 101;

                                          if( A4068Sys->Dev[POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1].AdamOff[POprosObj(ObjTree->Items->Item[idx]->Data)->Num2] > 0 )
                                          {
                                             /* Настройка автовыключения */
                                             TDateTime adt = Now();
                                             int t = A4068Sys->Dev[POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1].AdamOff[POprosObj(ObjTree->Items->Item[idx]->Data)->Num2];
                                             switch( t )
                                             {
                                                case 1: adt = adt + EncodeTime(0,0,5,0);
                                                        break;
                                                case 2: adt = adt + EncodeTime(0,0,10,0);
                                                        break;
                                                case 3: adt = adt + EncodeTime(0,0,30,0);
                                                        break;
                                                case 4: adt = adt + EncodeTime(0,1,0,0);
                                                        break;
                                                case 5: adt = adt + EncodeTime(0,5,0,0);
                                                        break;
                                                case 6: adt = adt + EncodeTime(0,10,0,0);
                                                        break;
                                                case 7: adt = adt + EncodeTime(0,20,0,0);
                                                        break;
                                                case 8: adt = adt + EncodeTime(0,30,0,0);
                                                        break;
                                                case 9: adt = adt + EncodeTime(1,0,0,0);
                                                        break;
                                                default: adt = adt + EncodeTime(0,0,5,0);
                                                        break;
                                             }
                                             A4068Sys->Dev[POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1].OffDt[POprosObj(ObjTree->Items->Item[idx]->Data)->Num2] = adt;
                                          }
                                       }
                                    }
                                    else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == TabloType && TabloPortNum != 0 )
                                    {
                                       int freenum = -1;
                                       bool numexist = false;
                                       for( int tablonum = 0; tablonum < TabloDevCnt; tablonum++ )
                                       {
                                          if( TabloSys->Dev[tablonum].Num == 0 && freenum == -1 ) freenum = tablonum;

                                          if( TabloSys->Dev[tablonum].Num == POprosObj(ObjTree->Items->Item[idx]->Data)->Num2 ) numexist = true;
                                       }

                                       if( !numexist && freenum != -1 )
                                          TabloSys->Dev[freenum].Num = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;
                                    }
                                 }
                              }
                           }
                        }
                     }
                   }
m321:;
               }
               for( int iu = 0; iu < IuCnt; iu++ )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Use )
                  {
                     if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status != GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 )
                        GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;
                     else
                     {
                        if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status != GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld )
                           GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;
                        else
                        {
                           if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld2 != GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status )
                           {
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld2 = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 0;

                              int n = 6;
                              int ius = 0;
                              switch( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status )
                              {
                                 case  10: n = 8; ius = 10;
                                           break;
                                 case  25: n = 9; ius = 25;
                                           break;
                                 case   1: if( !GobiSys->Kanal[kan].Bl[bl].Iu[iu].GobiCam) {n = 23; ius = 101;}
                                           else { n = 26; ius = 100; }

                                           if( GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                                           {
                                             n = 44;

                                             ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].TreeIdx]->ImageIndex = n;
                                             ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].TreeIdx]->SelectedIndex = n;

                                             POprosOutObj(lpMapOpros)->GobiSd[kan*BlCnt*SdCnt + bl*SdCnt + iu+3] = 21;
                                             POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                           }

                                           break;
                                 case   2: if( !GobiSys->Kanal[kan].Bl[bl].Iu[iu].GobiCam) {n = 24; ius = 100;}
                                           else { n = 26; ius = 101; }

                                           if( GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                                           {
                                             n = 43;

                                             ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].TreeIdx]->ImageIndex = n;
                                             ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].TreeIdx]->SelectedIndex = n;

                                             POprosOutObj(lpMapOpros)->GobiSd[kan*BlCnt*SdCnt + bl*SdCnt + iu+3] = 1;
                                           }
                                           break;
                              }
                              POprosOutObj(lpMapOpros)->GobiIu[kan*BlCnt*IuCnt + bl*IuCnt + iu] = GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status;

                              AnsiString iustr;
                              for( int i = 1; i < ObjTree->Items->Count; i++ )
                              {
                                 if( (POprosObj(ObjTree->Items->Item[i]->Data)->Type == 4 ||
                                      POprosObj(ObjTree->Items->Item[i]->Data)->Type == 41 ) &&
                                     kan == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num1-1) &&
                                     bl == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num2-1) &&
                                     iu == (PCfgObj(ObjTree->Items->Item[i]->Data)->Num3-1) )
                                 {
                                    ObjTree->Items->Item[i]->ImageIndex = n;
                                    ObjTree->Items->Item[i]->SelectedIndex = n;
                                    iustr = POprosObj(ObjTree->Items->Item[i]->Data)->Name;
                                 }
                              }

                              if( GobiSys->Status != 200 &&
                                  (GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1 ||
                                   GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 ||
                                   GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 10 ||
                                   GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 25) )
                              {
                                 if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Bazalt && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status != 10 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status != 25)
                                 {
                                       if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1  )
                                       {
                                           if( !GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 )
                                           {
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].status1 = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].StatusOld = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].StatusOld2 = 0;
                                           }
                                           else
                                           {
                                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                                           }
                                       }
                                    }
                                    else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 &&
                                        GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt > 0 )
                                    {
/*                                       if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 )
                                       {
                                           if( !GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 )
                                           {
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].status1 = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].StatusOld = 0;
                                               GobiSys->Kanal[kan].Bl[bl].Sd[iu].StatusOld2 = 0;
                                           }
                                           else
                                           {
                                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
                                           }
                                       }
                                    }
*/
                                 }
                                 else
                                 {
                                    if( !GobiSys->Kanal[kan].Bl[bl].Sd[iu].Bazalt && !GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                                       SetSob( ius, 4, (kan+1),(bl+1),(iu+1), iustr,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
//                                    if( !GobiSys->Kanal[kan].Bl[bl].Sd[iu].Bazalt && GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
//                                       SetSob( 4, 4, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].Name,  OpFn, OpN1, OpN2, "", "", "", false );
                                 }
                              }
                           }
                        }
                     }
                  }
               }
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::OnOff_pdiClick(TObject *Sender)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3-1;

   if( POprosObj(ObjTree->Selected->Data)->Type == 1 || POprosObj(ObjTree->Selected->Data)->Type == 8 || POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( MessageBox (NULL,MsgStr13.c_str(), WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
         {
            if( Audit() )
            {
               if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100 )
               {
                  if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AlarmFix[0] )
                  SetSob( 130,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x26;
               }
               else if( MessageBox (NULL,"Вы действительно ходите отключить устройство?","Предупреждение",MB_YESNO ) == IDYES )
               {
                  if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AlarmFix[0] )
                  SetSob( 131,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x25;
               }
            }
            else MessageBox (NULL, MsgStr14.c_str(), ErrorMsg.c_str() ,MB_OK|MB_ICONERROR);
         }

         RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 2 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( MessageBox (NULL,MsgStr13.c_str(), WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
         {
            if( Audit() )
            {
               if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] == 100 )
               {
                  if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Selected->Data)->Num2-1] )
                  SetSob( 130,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  for( int i = 0; i < MaxInCnt; i++ )
                  {
                     if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[i] == 100 )
                        RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[i] = false;
                     else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[i] = true;
                  }

                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[POprosObj(ObjTree->Selected->Data)->Num2-1] = true;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x20;
               }
               else
               {
                  if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Selected->Data)->Num2-1] )
                  SetSob( 131,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  for( int i = 0; i < MaxInCnt; i++ )
                  {
                     if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[i] == 100 )
                        RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[i] = false;
                     else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[i] = true;
                  }

                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].On[POprosObj(ObjTree->Selected->Data)->Num2-1] = false;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x20;
               }
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
            }
            else MessageBox (NULL, MsgStr14.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 4 && SsoiM_PortNum[0] != 0 && ComplexVersion != Rastr_M_SsoiComplexType )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld == 1 )
      {
         SetSob( 131, 4, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
      }
      else
      {
         SetSob( 130, 4, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;

         if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].AutoOff > 0 )
         {
            TDateTime adt = Now();
            int t = GobiSys->Kanal[kan].Bl[bl].Iu[iu].AutoOff;
            switch( t )
            {
               case 1: adt = adt + EncodeTime(0,0,5,0);
                       break;
               case 2: adt = adt + EncodeTime(0,0,10,0);
                       break;
               case 3: adt = adt + EncodeTime(0,0,30,0);
                       break;
               case 4: adt = adt + EncodeTime(0,1,0,0);
                       break;
               case 5: adt = adt + EncodeTime(0,5,0,0);
                       break;
               case 6: adt = adt + EncodeTime(0,10,0,0);
                       break;
               case 7: adt = adt + EncodeTime(0,20,0,0);
                       break;
               case 8: adt = adt + EncodeTime(0,30,0,0);
                       break;
               case 9: adt = adt + EncodeTime(1,0,0,0);
                       break;
               default: adt = adt + EncodeTime(0,0,5,0);
                        break;
            }
            GobiSys->Kanal[kan].Bl[bl].Iu[iu].OffDt = adt;
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 4 && ComplexVersion == Rastr_M_SsoiComplexType )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld == 101 )
      {
         SetSob( 131, 4, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
      }
      else
      {
         SetSob( 130, 4, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 43 && SsoiM_PortNum[POprosObj(ObjTree->Selected->Data)->Num1-1] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      if( iu < 3 )
      {
         if( GobiSys2->Bl[kan][bl].Iu[iu].StatusOld == 2 )
         {
            if( GobiSys2->Bl[kan][bl].Iu[iu].AutoOff > 0 )
            {
               TDateTime adt = Now();
               int t = GobiSys2->Bl[kan][bl].Iu[iu].AutoOff;
               switch( t )
               {
                  case 1: adt = adt + EncodeTime(0,0,5,0);
                          break;
                  case 2: adt = adt + EncodeTime(0,0,10,0);
                          break;
                  case 3: adt = adt + EncodeTime(0,0,30,0);
                          break;
                  case 4: adt = adt + EncodeTime(0,1,0,0);
                          break;
                  case 5: adt = adt + EncodeTime(0,5,0,0);
                          break;
                  case 6: adt = adt + EncodeTime(0,10,0,0);
                          break;
                  case 7: adt = adt + EncodeTime(0,20,0,0);
                          break;
                  case 8: adt = adt + EncodeTime(0,30,0,0);
                          break;
                  case 9: adt = adt + EncodeTime(1,0,0,0);
                          break;
                  default: adt = adt + EncodeTime(0,0,5,0);
                          break;
               }
               GobiSys2->Bl[kan][bl].Iu[iu].OffDt = adt;
            }

            SetSob( 130, 43, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;
            GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         }
         else
         {
            SetSob( 131, 43, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
            GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         }
      }
      else
      {
         iu = iu - 3;
         if( GobiSys2->Bl[kan][bl].Vk[iu].StatusOld == 2 )
         {
            SetSob( 130, 43, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            GobiSys2->Bl[kan][bl].Vk[iu].hCmd = 1;
            GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         }
         else
         {
            SetSob( 131, 43, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            GobiSys2->Bl[kan][bl].Vk[iu].hCmd = 2;
            GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 41 && SsoiM_PortNum[0] != 0 )
   {
      for( int i = 0; i < MaxGobiCamCnt; i++ )
      {
         GobiSys->GobiCam[i].k = -1;
         GobiSys->GobiCam[i].bl = -1;
         GobiSys->GobiCam[i].iu = -1;
         GobiSys->GobiCam2[i].k = -1;
         GobiSys->GobiCam2[i].bl = -1;
         GobiSys->GobiCam2[i].iu = -1;
      }

      if( Server2->Socket->ActiveConnections != 0 && GobiTv  )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " off" + " finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }

      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      HandCam.k = kan;
      HandCam.bl = bl;
      HandCam.iu = iu;
      if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld == 1 )
      {
         HandCam.hcmd = 1;
      }
      else
      {
         HandCam.hcmd = 2;
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 3 && SsoiM_PortNum[0] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      SetSob( 150, 3, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false,
              POprosObj(ObjTree->Selected->Data)->OutType );

      if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1 ) 
      {
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = true;
      }
      else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 ) 
      {
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
      }

      GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = BazaltCnt;

      CGauge1->Progress = BazaltCnt-GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
      GroupBox5->Visible = true;
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 3 && ComplexVersion == Rastr_M_SsoiComplexType )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      SetSob( 150, 3, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false,
              POprosObj(ObjTree->Selected->Data)->OutType );
      if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
      {
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = 1;
      }
      else if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 )
      {
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = 0;
      }
      CGauge1->MaxValue = SsoiM1_BazaltCnt;
      CGauge1->Progress = 0;
      GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = 0;
      GroupBox5->Visible = true;
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 33 && SsoiM_PortNum[POprosObj(ObjTree->Selected->Data)->Num1-1] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      SetSob( 150, 33, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

      GobiSys2->Bl[kan][bl].Sd[iu].BazaltCmd2 = false;
      if( GobiSys2->Bl[kan][bl].Iu[iu].Status == 1 && !GobiSys2->Bl[kan][bl].Sd[iu].Sin )
      {
         GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
         GobiSys2->Bl[kan][bl].Sd[iu].BazaltCmd2 = true;
      }
      else GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;

      GobiSys2->Bl[kan][bl].Cmd = 0xF2;

      GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = BazaltCnt2;

      CGauge1->MaxValue = BazaltCnt2;
      CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt;
      GroupBox5->Visible = true;
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 6 )
   {
      if( !SolidSys->GetTv(POprosObj(ObjTree->Selected->Data)->Num1) )
         SolidSys->SetTv(POprosObj(ObjTree->Selected->Data)->Num1, true);
      else
         SolidSys->SetTv(POprosObj(ObjTree->Selected->Data)->Num1, false);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 7 )
   {
      if( A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].Out[POprosObj(ObjTree->Selected->Data)->Num2] == 100 )
      {
         A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd[POprosObj(ObjTree->Selected->Data)->Num2] = 101;
         SetSob( 130,
                 POprosObj(ObjTree->Selected->Data)->Type,
                 POprosObj(ObjTree->Selected->Data)->Num1,
                 POprosObj(ObjTree->Selected->Data)->Num2,
                 POprosObj(ObjTree->Selected->Data)->Num3,
                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

         if( A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].AdamOff[POprosObj(ObjTree->Selected->Data)->Num2] > 0 )
         {
            TDateTime adt = Now();
            int t = A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].AdamOff[POprosObj(ObjTree->Selected->Data)->Num2];
            switch( t )
            {
               case 1: adt = adt + EncodeTime(0,0,5,0);
                       break;
               case 2: adt = adt + EncodeTime(0,0,10,0);
                       break;
               case 3: adt = adt + EncodeTime(0,0,30,0);
                       break;
               case 4: adt = adt + EncodeTime(0,1,0,0);
                       break;
               case 5: adt = adt + EncodeTime(0,5,0,0);
                       break;
               case 6: adt = adt + EncodeTime(0,10,0,0);
                       break;
               case 7: adt = adt + EncodeTime(0,20,0,0);
                       break;
               case 8: adt = adt + EncodeTime(0,30,0,0);
                       break;
               case 9: adt = adt + EncodeTime(1,0,0,0);
                       break;
               default: adt = adt + EncodeTime(0,0,5,0);
                       break;
            }
            A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].OffDt[POprosObj(ObjTree->Selected->Data)->Num2] = adt;
         }
      }
      else
      {
         A4068Sys->Dev[POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd[POprosObj(ObjTree->Selected->Data)->Num2] = 100;
         SetSob( 131,
                 POprosObj(ObjTree->Selected->Data)->Type,
                 POprosObj(ObjTree->Selected->Data)->Num1,
                 POprosObj(ObjTree->Selected->Data)->Num2,
                 POprosObj(ObjTree->Selected->Data)->Num3,
                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == IuIpBlType )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
      {
          if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1+MaxIpBlSdCnt] == 101 )
          {
             SetSob( 131, IuIpBlType, num1,num2,num3, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

             if( !DemoMode ) RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 100;
             else
             {
                int packet[1000];
                memset(packet,0,1000);

                bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 100;
                ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
             }
          }
          else
          {
             SetSob( 130, IuIpBlType, num1,num2,num3, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
             if( !DemoMode )
             {
                RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                 if( RifSys->Rk[num3-1][IpBlIdx].AutoOff[num2-1+MaxIpBlSdCnt] > 0 )
                 {
                    TDateTime adt = Now();
                    int t = RifSys->Rk[num3-1][IpBlIdx].AutoOff[num2-1+MaxIpBlSdCnt];
                    switch( t )
                    {
                       case 1: adt = adt + EncodeTime(0,0,5,0);
                               break;
                       case 2: adt = adt + EncodeTime(0,0,10,0);
                               break;
                       case 3: adt = adt + EncodeTime(0,0,30,0);
                               break;
                       case 4: adt = adt + EncodeTime(0,1,0,0);
                               break;
                       case 5: adt = adt + EncodeTime(0,5,0,0);
                               break;
                       case 6: adt = adt + EncodeTime(0,10,0,0);
                               break;
                       case 7: adt = adt + EncodeTime(0,20,0,0);
                               break;
                       case 8: adt = adt + EncodeTime(0,30,0,0);
                               break;
                       case 9: adt = adt + EncodeTime(1,0,0,0);
                               break;
                       default: adt = adt + EncodeTime(0,0,5,0);
                                break;
                    }
                    RifSys->Rk[num3-1][IpBlIdx].OffDt[num2-1+MaxIpBlSdCnt] = adt;
                 }
             }
             else
             {
                    int packet[1000];
                    memset(packet,0,1000);

                    bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                    RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 101;
                    ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
             }
         }
          RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
          RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
      }
      else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
      {
         int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
         if( pos >= 0  )
         {
             if( Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Siu[0] == 1 )
             {
                SetSob( 131, IuIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 1;
                Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
             }
             else
             {
                SetSob( 130, IuIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 2;
                Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
             }
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
      {
          if( POprosObj(ObjTree->Selected->Data)->Bazalt )
          {
             SetSob( 150, SdIpBlType, num1, num2, num3, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

             if( !DemoMode )
             {
                RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 100;

                RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = RifBazaltCnt[num3-1];
             }
             else RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = 10;

             CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
             CGauge1->Progress = 0;
             GroupBox5->Caption = "Выполнение команды УЗ \"Монолит\"";
             GroupBox5->Visible = true;

             if( DemoMode )
             {
                for( int progr = 0; progr < CGauge1->MaxValue; progr++ )
                {
                   MyDelay(50);
                   CGauge1->Progress = progr;
                }
                RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 1;
                RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 100;
                RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] = 0;

                int packet[1000];
                memset(packet,0,1000);

                bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                Tin_IpBl[num2-1] = true;

                ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                GroupBox5->Visible = false;
             }
          }
          else
          {
              if( MessageBox (NULL,MsgStr13.c_str(), WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
              {
                 if( Audit() )
                 {
                    if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] == 100 )
                    {
                       SetSob( 130, IuIpBlType, num3,num1,num2, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                       if( !DemoMode ) RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1] = 100;
                       else
                       {
                          int packet[1000];
                          memset(packet,0,1000);

                          bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                          RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 1;
                          ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                       }
                    }
                    else
                    {
                       SetSob( 131, IuIpBlType, num3,num1,num2, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                       if( !DemoMode ) RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1] = 100;
                       else
                       {
                          int packet[1000];
                          memset(packet,0,1000);

                          bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                          RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 100;
                          ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                       }
                    }
                    RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x20;
                    RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                 }
                 else MessageBox (NULL, MsgStr14.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
              }
          }
      }
      else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
      {
         int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
         if( pos >= 0  )
         {
             if( POprosObj(ObjTree->Selected->Data)->Bazalt )
             {
                TDateTime dt = Now();

                if( Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Siu[0] == 1 )
                {
                   SetSob( 150, IuIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart = dt + 60.0*1.157407E-05;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzCnt = 1;
                }
                else
                {
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 2;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart = dt + 60.0*1.157407E-05;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzCnt = 2;
                }


                double t = Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart - dt;
                t = t * 100000.0;
                CGauge1->MaxValue = t;
                CGauge1->Progress = 0;
                GroupBox5->Visible = true;
             }
             else
             {
                if( Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].Active[0] == 1 )
                {
                   SetSob( 131, SdIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                }
                else
                {
                   SetSob( 130, SdIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].Cmd = 2;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                }
             }
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Off_pdiClick(TObject *Sender)
{
   if( ComplexVersion != Rastr_M_SsoiComplexType )
   {
       if( POprosObj(ObjTree->Selected->Data)->Type == 3 && SsoiM_PortNum[0] != 0 )
       {
          int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
          int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
          int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

          SetSob( 151, 3, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false,
                  POprosObj(ObjTree->Selected->Data)->OutType );

          if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 21 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1 )
          {
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
          }
          else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 21 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 ) 
          {
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
             GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = true;
          }

          GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = BazaltCnt;

          CGauge1->Progress = BazaltCnt-GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
          GroupBox5->Visible = true;
       }
       else if( POprosObj(ObjTree->Selected->Data)->Type == 33 && SsoiM_PortNum[POprosObj(ObjTree->Selected->Data)->Num1-1] != 0 )
       {
          int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
          int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
          int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

          SetSob( 151, 33, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

          GobiSys2->Bl[kan][bl].Sd[iu].BazaltCmd2 = false;
          if( GobiSys2->Bl[kan][bl].Iu[iu].Status == 2 && GobiSys2->Bl[kan][bl].Sd[iu].Sin )
          {
            GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;
            GobiSys2->Bl[kan][bl].Sd[iu].BazaltCmd2 = true;
          }
          else GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;

          GobiSys2->Bl[kan][bl].Cmd = 0xF2;
          GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = BazaltCnt2;

          CGauge1->MaxValue = BazaltCnt2;
          CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt;
          GroupBox5->Visible = true;
       }
       else if( POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType )
       {
         int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
         int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
         int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

         if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
         {
             SetSob( 151, SdIpBlType, num1, num2, num3, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

             if( !DemoMode )
             {
                RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;

                RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = RifBazaltCnt[num3-1];
             }
             else RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = 10;

             CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
             CGauge1->Progress = 0;
             GroupBox5->Visible = true;
         }
         else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
         {
            int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
            if( pos >= 0  )
            {
                TDateTime dt = Now();

                if( Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Siu[0] == 1 )
                {
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzCnt = 2;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart = dt + 60.0*1.157407E-05;
                }
                else
                {
                   SetSob( 151, IuIpBlType, num1,num2,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[num2-1].Cmd = 2;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzCnt = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart = dt + 60.0*1.157407E-05;
                }

                double t = Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[num2-1].UzStart - dt;
                t = t * 100000.0;
                CGauge1->MaxValue = t;
                CGauge1->Progress = 0;
                MainForm->GroupBox5->Caption = "Выполнение команды УЗ \"Монолит\"";
                GroupBox5->Visible = true;
            }
         }

         if( DemoMode )
         {
            for( int progr = 0; progr < CGauge1->MaxValue; progr++ )
            {
               MyDelay(50);
               CGauge1->Progress = progr;
            }
            RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 1;
            RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 101;
            RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] = 0;

            int packet[1000];
            memset(packet,0,1000);

            bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
            Tin_IpBl[num2-1] = false;

            ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
            GroupBox5->Visible = false;
         }
       }
   }
   else
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-1;

      SetSob( 151, 3, (kan+1),(bl+1),(iu+1), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
      if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
      {
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = 0;
      }
      else if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 )
      {
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].status1 = 1;
      }
      CGauge1->MaxValue = SsoiM1_BazaltCnt;
      CGauge1->Progress = 0;
      GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = 0;
      GroupBox5->Visible = true;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::OnOffAll_pdiClick(TObject *Sender)
{
   if( POprosObj(ObjTree->Selected->Data)->Type == 6 )
   {
      SolidSys->ResetTv();
      SetSob( 141,
              POprosObj(ObjTree->Selected->Data)->Type,
              POprosObj(ObjTree->Selected->Data)->Num1,
              POprosObj(ObjTree->Selected->Data)->Num2,
              POprosObj(ObjTree->Selected->Data)->Num3,
              "ТВ-камеры \"СОЛИД\"",  OpFn, OpN1, OpN2, "", "", "", false, 0 );
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 7  )
   {
      for( int num1 = 0; num1 < DevCnt4068; num1++ )
         for( int num2 = 0; num2 < OutCnt4068; num2++ )
         {
            A4068Sys->Dev[num1].Cmd[num2] = 100;
         }
      SetSob( 141,
              POprosObj(ObjTree->Selected->Data)->Type,
              POprosObj(ObjTree->Selected->Data)->Num1,
              POprosObj(ObjTree->Selected->Data)->Num2,
              POprosObj(ObjTree->Selected->Data)->Num3,
              "Адам-4068(9)/4168",  OpFn, OpN1, OpN2, "", "", "", false, 0 );
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 43 && SsoiM_PortNum[POprosObj(ObjTree->Selected->Data)->Num1-1] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1 - 1;

      if( POprosObj(ObjTree->Selected->Data)->Num3 < 4 )
      {
         for( int bl = 0; bl < BlCnt; bl++ )
         for( int iu = 0; iu < IuCnt; iu++ )
         {
            if( GobiSys2->Bl[kan][bl].Iu[iu].Use )
            {
               if( GobiSys2->Bl[kan][bl].Iu[iu].StatusOld == 1 )
               {
                  GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
                  GobiSys2->Bl[kan][bl].Cmd = 0xF2;
               }
            }
         }
         SetSob( 141, 43, (kan+1),0,0, "ИУ ССОИ",  OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
      else
      {
         for( int bl = 0; bl < BlCnt; bl++ )
         for( int iu = 0; iu < IuCnt; iu++ )
         {
            if( GobiSys2->Bl[kan][bl].Vk[iu].Use )
            {
               if( GobiSys2->Bl[kan][bl].Vk[iu].StatusOld == 1 )
               {
                  GobiSys2->Bl[kan][bl].Vk[iu].hCmd = 2;
                  GobiSys2->Bl[kan][bl].Cmd = 0xF2;
               }
            }
         }
         SetSob( 141, 43, (kan+1),0,0, "ВК ССОИ",  OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == IuIpBlType )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
      {
          for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
          {
             if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[iu+MaxIpBlSdCnt] == 101 && !RifSys->Rk[num3-1][IpBlIdx].Bazalt[num2-1] )
             {
                SetSob( 131, IuIpBlType, num1,num2,num3, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                RifSys->Rk[num3-1][IpBlIdx].hCmd[iu+MaxIpBlSdCnt] = 100;
             }
          }

          RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
          RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
      }
      else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
      {
         int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
         if( pos >= 0  )
         {
             for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
             {
                if( Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[iu].Siu[0] == 1 && !Rif2Sys->Ch[pos].Dev[IpBlIdx].Sd[iu].Uz )
                {
                   SetSob( 131, IuIpBlType, num1,iu,pos+1, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Iu[iu].Cmd = 1;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 4;
                   Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
                }
             }
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Pult_pdiClick(TObject *Sender)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3-1;

   if( POprosObj(ObjTree->Selected->Data)->Type == 1 || POprosObj(ObjTree->Selected->Data)->Type == 8 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30 )
         {
            if( MessageBox (NULL,"Вставьте ключ администратора и нажмите OK.","Предупреждение",MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
            {
               if( Audit() )
               {
                  SetSob( 132,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x27;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
               }
               else MessageBox (NULL,"Ключ администратора не найден!","Ошибка",MB_OK|MB_ICONERROR);
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Dk_pdiClick(TObject *Sender)
{
   Dk_Dev( false );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Setup_pdiClick(TObject *Sender)
{
   ComboBox1->ItemIndex = 0;
   ComboBox2->ItemIndex = 0;

   ScrollBox2->Visible = !ScrollBox2->Visible;
}
//---------------------------------------------------------------------------
bool TMainForm::SetTbl1()
{
   bool flag = false;

   Table1->Active = false;
   Table1->DatabaseName = AppDataPath;
   Table1->TableType = ttParadox;
   Table1->TableName = "Today.Db";

   if( Table1->Exists ) flag = true;
   else
   {
      if( CreateTbl1() ) flag = true;
      else flag = false;
   }

   return flag;
}
//---------------------------------------------------------------------------
bool TMainForm::CreateTbl1()
{
   bool flag = false;

   try
   {
      Table1->Active = false;

      Table1->FieldDefs->Clear();
      Table1->FieldDefs->Add( "Cnt", ftAutoInc, 0, true );    
      Table1->FieldDefs->Add( "Dt", ftDateTime, 0, false );   
      Table1->FieldDefs->Add( "Type", ftInteger, 0, false );   
      Table1->FieldDefs->Add( "Name", ftString, 25, false );  
      Table1->FieldDefs->Add( "Flag", ftBoolean, 0, false );   
      Table1->FieldDefs->Add( "Dtype", ftInteger, 0, false );  
      Table1->FieldDefs->Add( "Dnum1", ftInteger, 0, false );
      Table1->FieldDefs->Add( "Dnum2", ftInteger, 0, false );
      Table1->FieldDefs->Add( "Dnum3", ftInteger, 0, false );
      Table1->FieldDefs->Add( "Comment", ftString, 25, false ); 
      Table1->FieldDefs->Add( "Comment2", ftString, 25, false );
      Table1->FieldDefs->Add( "OpFn", ftString, 15, false );   
      Table1->FieldDefs->Add( "OpN1", ftString, 15, false );    
      Table1->FieldDefs->Add( "OpN2", ftString, 15, false );    
      Table1->FieldDefs->Add( "ClFn", ftString, 15, false );    
      Table1->FieldDefs->Add( "ClN1", ftString, 15, false );    
      Table1->FieldDefs->Add( "ClN2", ftString, 15, false );    
      Table1->FieldDefs->Add( "OutType", ftInteger, 0, false );

      Table1->IndexDefs->Clear();
      Table1->IndexDefs->Add("","Cnt", TIndexOptions()<<ixPrimary<< ixUnique);
      Table1->IndexDefs->Add("PosIdx","Cnt", TIndexOptions()<< ixCaseInsensitive);

      Table1->CreateTable();

      flag = true;
   }
   catch(...)
   {
      flag = false;
   }

   return flag;
}
//---------------------------------------------------------------------------
void TMainForm::SetSob1( int stype, int otype, int onum1, int onum2, int onum3, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype, TDateTime dtsob )
{
   AnsiString str;

   Table1->Insert();
   if( stype != 904 ) Table1Dt->AsDateTime = Now();
   else  Table1Dt->AsDateTime = dtsob;

   Table1Type->AsInteger = stype;
   Table1Name->AsString = name;
   Table1Flag->AsBoolean = false;
   Table1Dtype->AsInteger = otype;
   Table1Dnum1->AsInteger = onum1;
   Table1Dnum2->AsInteger = onum2;
   Table1Dnum3->AsInteger = onum3;
   Table1OpFn->AsString = ofn;
   Table1OpN1->AsString = on1;
   Table1OpN2->AsString = on2;
   Table1ClFn->AsString = cfn;
   Table1ClN1->AsString = cn1;
   Table1ClN2->AsString = cn2;
   Table1OutType->AsInteger = outtype;
   Table1->Post();
   Table1->FlushBuffers();

   ShowPrCnt();

   if( Msg )
   {
      TMsgForm *mfrm = new TMsgForm(this);
      mfrm->Left = MainForm->Left + MainForm->Width - mfrm->Width - 50;
      int y1 = MainFormY + mfrm->Height;
      int y2 = MainForm->Top + MainForm->Height - 100;
      if( y1 < y2 )
      {
         mfrm->Top = MainFormY + 50;
         MainFormY = mfrm->Top;
      }
      else
      {
         MainFormY = MainForm->Top + 50;
         mfrm->Top = MainFormY;
      }

      mfrm->StaticText2->Caption = Table1Name->AsString;
      mfrm->StaticText1->Caption = Table1Type2Str->AsString;
      mfrm->Show();
   }

   if( MySQL_use > 0 )
   {
      AnsiString query, err_str;
      AnsiString d_t;
      d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", Table1Dt->AsDateTime);

      query.sprintf("INSERT INTO %s.events VALUES(%d, \'%s\', %d, \'%s\', %d, %d, %d, %d, \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', %d)",
                               MySQL_dbname,
                               events_num,                        
                               d_t,                               
                               Table1Type->AsInteger,             
                               Table1Type2Str->AsString,          
                               Table1Dtype->AsInteger,            
                               Table1Dnum1->AsInteger,            
                               Table1Dnum2->AsInteger,            
                               Table1Dnum3->AsInteger,            
                               Table1Name->AsString,              
                               "",
                               "",
                               Table1OpFn->AsString,
                               Table1OpN1->AsString,
                               Table1OpN2->AsString,
                               Table1ClFn->AsString,
                               Table1ClN1->AsString,
                               Table1ClN2->AsString,
                               Table1OutType->AsInteger );
      mysql_real_query(Con,query.c_str(),query.Length());
      int err_code = mysql_errno(Con);
      if( err_code != 0 )
      {
         mysql_close(Con);

         Con = mysql_init(NULL);
         mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
         err_code = mysql_errno(Con);
         if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
         {
            MySQL_use = -1;

            err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
            ShowMessage(err_str);
         }
         else
         {
            mysql_real_query(Con,query.c_str(),query.Length());
            err_code = mysql_errno(Con);
            if( err_code != 0 )
            {
               MySQL_use = -1;

               err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
               ShowMessage(err_str);
            }
            else events_num = events_num + 1;
         }
      }
      else events_num = events_num + 1;
   }

   if( Server2Use && !Stn485Tv && !STN1 )
   {
      if( Server2->Socket->ActiveConnections != 0 )
      {
         str = "[start] ";
         str = str + AnsiString(Table1Dt->AsDateTime) + " ";
         str = str + AnsiString(Table1Type->AsInteger) + " ";
         str = str + "\"" + Table1Name->AsString + "\" ";
         str = str + AnsiString(Table1Dtype->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum1->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum2->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum3->AsInteger) + " ";

         str = str + " [stop]";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;
      AnsiString sTable1Type2Str = Table1Type2Str->AsString;

      switch( otype )
      {
         case 0: 
                 break;
         case 1: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 break;
         case 4: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 10: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 break;
         case 11: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 0 ) { stype = 2; sTable1Type2Str = Table1Str1; }
                 else if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 10 ) { stype = 17; sTable1Type2Str = Table1Str5; }
                 break;
         case 12: /
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 21: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 break;
         case 41: 
                 break;
         case 42: 
                 break;
         case 51: 
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 28:/
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, name );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Table1Dt->AsDateTime);
      str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>",
                  stype, dt_str, sTable1Type2Str );
      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);
   }

   if( UseAsoosd )
   {
      if( otype == SdType || stype == 200 )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 200 || stype == 1 || stype == 136 || stype == 137 )
         {
            AnsiString d_t;

UseAsoosd_label:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 200: stype2 = 43; break;
                     case 11: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                     case 136: stype2 = -1; break;
                     case 137: stype2 = 0; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);
                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label;
            }
         }
      }
      else if( otype == SsoiMSdType )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 13 || stype == 1  )
         {
            AnsiString d_t;

UseAsoosd_label2:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 11: stype2 = 44; break;
                     case 13: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);

                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label2;
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::SetSob( int stype, int otype, int onum1, int onum2, int onum3, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype )
{
   AnsiString str;

   Table1->Insert();
   Table1Dt->AsDateTime = Now();
   Table1Type->AsInteger = stype;
   Table1Name->AsString = name;
   Table1Flag->AsBoolean = false;
   Table1Dtype->AsInteger = otype;
   Table1Dnum1->AsInteger = onum1;
   Table1Dnum2->AsInteger = onum2;
   Table1Dnum3->AsInteger = onum3;
   Table1OpFn->AsString = ofn;
   Table1OpN1->AsString = on1;
   Table1OpN2->AsString = on2;
   Table1ClFn->AsString = cfn;
   Table1ClN1->AsString = cn1;
   Table1ClN2->AsString = cn2;
   Table1OutType->AsInteger = outtype;
   Table1->Post();
   Table1->FlushBuffers();

   ShowPrCnt();

   if( Msg )
   {
      TMsgForm *mfrm = new TMsgForm(this);
      mfrm->Left = MainForm->Left + MainForm->Width - mfrm->Width - 50;
      int y1 = MainFormY + mfrm->Height;
      int y2 = MainForm->Top + MainForm->Height - 100;
      if( y1 < y2 )
      {
         mfrm->Top = MainFormY + 50;
         MainFormY = mfrm->Top;
      }
      else
      {
         MainFormY = MainForm->Top + 50;
         mfrm->Top = MainFormY;
      }

      mfrm->StaticText2->Caption = Table1Name->AsString;
      mfrm->StaticText1->Caption = Table1Type2Str->AsString;
      mfrm->Show();
   }

   if( MySQL_use > 0 )
   {
/*
      int errcode = mysql_ping(Con);
      if( errcode != 0 && errcode != CR_ALREADY_CONNECTED )
      {
         mysql_close(Con);

         Con = mysql_init(NULL);
         mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
         errcode = mysql_errno(Con);
         if( errcode != 0 && errcode != CR_ALREADY_CONNECTED )
         {
            MySQL_use = -1;

            AnsiString err_str;
            err_str.sprintf("%s!\n %s:%d\n %s:%s", InfoStr2, InfoStr3, errcode, InfoStr4, mysql_error(Con));
            ShowMessage(err_str);
         }
      }
*/
      if( MySQL_use > 0 )
      {
          AnsiString query, err_str;
          AnsiString d_t;
          d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", Table1Dt->AsDateTime);

          query.sprintf("INSERT INTO %s.events VALUES(%d, \'%s\', %d, \'%s\', %d, %d, %d, %d, \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', %d)",
                                   MySQL_dbname,
                                   events_num,                        // event_num
                                   d_t,                               // event_dt
                                   Table1Type->AsInteger,             // event_code
                                   Table1Type2Str->AsString,          // event_name
                                   Table1Dtype->AsInteger,            // dev_type
                                   Table1Dnum1->AsInteger,            // dev_num1
                                   Table1Dnum2->AsInteger,            // dev_num2
                                   Table1Dnum3->AsInteger,            // dev_num2
                                   Table1Name->AsString,              // dev_name
                                   "",
                                   "",
                                   Table1OpFn->AsString,
                                   Table1OpN1->AsString,
                                   Table1OpN2->AsString,
                                   Table1ClFn->AsString,
                                   Table1ClN1->AsString,
                                   Table1ClN2->AsString,
                                   Table1OutType->AsInteger );
          mysql_real_query(Con,query.c_str(),query.Length());
          int err_code = mysql_errno(Con);
          if( err_code != 0 )
          {
             mysql_close(Con);

             Con = mysql_init(NULL);
             mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
             err_code = mysql_errno(Con);
             if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
             {
                MySQL_use = -1;

                err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                ShowMessage(err_str);
             }
             else
             {
                mysql_real_query(Con,query.c_str(),query.Length());
                err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   MySQL_use = -1;

                   err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                   ShowMessage(err_str);
                }
                else events_num = events_num + 1;
             }
          }
          else events_num = events_num + 1;
      }
   }

   if( Server2Use && !Stn485Tv && !STN1 )
   {
      if( Server2->Socket->ActiveConnections != 0 )
      {
         str = "[start] ";
         str = str + AnsiString(Table1Dt->AsDateTime) + " ";
         str = str + AnsiString(Table1Type->AsInteger) + " ";
         str = str + "\"" + Table1Name->AsString + "\" ";
         str = str + AnsiString(Table1Dtype->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum1->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum2->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum3->AsInteger) + " ";

         str = str + " [stop]";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;
      AnsiString sTable1Type2Str = Table1Type2Str->AsString;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      bool alarmfix = true;

      switch( otype )
      {
         case 0: 
                 break;
         case 1: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lon;
                 description = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].AlarmFix;

                 if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 33: 
                 id = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lon;
                 description = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].AlarmFix;

                 if( GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if( GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 2 ) stype = 143;
                        else stype = 146;
                     }
                     else if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 4: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 43: 
                 if( onum3 < 4 ) id = GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-1].TreeIdx;
                 else { id = GobiSys2->Bl[onum1-1][onum2-1].Vk[onum3-4].TreeIdx; }
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 10:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2-1];
                 break;
         case 11: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][IpBlIdx].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][IpBlIdx].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][IpBlIdx].description[onum2-1];
                 if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 0 ) { stype = 2; sTable1Type2Str = Table1Str1; }
                 else if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 10 ) { stype = 17; sTable1Type2Str = Table1Str5; }
                 alarmfix = RifSys->Rk[onum3-1][IpBlIdx].AlarmFix[onum2-1];
                 break;
         case 12: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 21: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 41:
                 break;
         case 42: 
                 break;
         case 51:
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, name, lan, lon, description );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Table1Dt->AsDateTime);

      if( alarmfix )
      {
         str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", stype, dt_str, sTable1Type2Str );
      }
      else
      {
         str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"Контроль выкл\"/>", dt_str );
      }

      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);
   }

   if( UseAsoosd )
   {
      if( otype == SdType || stype == 200 )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 200 || stype == 1 || stype == 136 || stype == 137 )
         {
            AnsiString d_t;

UseAsoosd_label:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 200: stype2 = 43; break;
                     case 11: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                     case 136: stype2 = -1; break;
                     case 137: stype2 = 0; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);
                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label;
            }
         }
      }
      else if( otype == SsoiMSdType )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 13 || stype == 1  )
         {
            AnsiString d_t;

UseAsoosd_label2:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 11: stype2 = 44; break;
                     case 13: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);

                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label2;
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
AnsiString TMainForm::SetSob2( int stype, int otype, int onum1, int onum2, int onum3, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype )
{
   AnsiString str, query;

   Table1->Insert();
   Table1Dt->AsDateTime = Now();
   Table1Type->AsInteger = stype;
   Table1Name->AsString = name;
   Table1Flag->AsBoolean = false;
   Table1Dtype->AsInteger = otype;
   Table1Dnum1->AsInteger = onum1;
   Table1Dnum2->AsInteger = onum2;
   Table1Dnum3->AsInteger = onum3;
   Table1OpFn->AsString = ofn;
   Table1OpN1->AsString = on1;
   Table1OpN2->AsString = on2;
   Table1ClFn->AsString = cfn;
   Table1ClN1->AsString = cn1;
   Table1ClN2->AsString = cn2;
   Table1OutType->AsInteger = outtype;
   Table1->Post();
//   Table1->FlushBuffers();

//   ShowPrCnt();

   if( Msg )
   {
      TMsgForm *mfrm = new TMsgForm(this);
      mfrm->Left = MainForm->Left + MainForm->Width - mfrm->Width - 50;
      int y1 = MainFormY + mfrm->Height;
      int y2 = MainForm->Top + MainForm->Height - 100;
      if( y1 < y2 )
      {
         mfrm->Top = MainFormY + 50;
         MainFormY = mfrm->Top;
      }
      else
      {
         MainFormY = MainForm->Top + 50;
         mfrm->Top = MainFormY;
      }

      mfrm->StaticText2->Caption = Table1Name->AsString;
      mfrm->StaticText1->Caption = Table1Type2Str->AsString;
      mfrm->Show();
   }

   if( MySQL_use > 0 )
   {
      AnsiString d_t;
      d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", Table1Dt->AsDateTime);

      query.sprintf("(%d, \'%s\', %d, \'%s\', %d, %d, %d, %d, \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', %d),",
                               events_num,                        
                               d_t,                               
                               Table1Type->AsInteger,             
                               Table1Type2Str->AsString,          
                               Table1Dtype->AsInteger,            
                               Table1Dnum1->AsInteger,            
                               Table1Dnum2->AsInteger,            
                               Table1Dnum3->AsInteger,            
                               Table1Name->AsString,              
                               "",
                               "",
                               Table1OpFn->AsString,
                               Table1OpN1->AsString,
                               Table1OpN2->AsString,
                               Table1ClFn->AsString,
                               Table1ClN1->AsString,
                               Table1ClN2->AsString,
                               Table1OutType->AsInteger );
      events_num = events_num + 1;
   }

   if( Server2Use && !Stn485Tv && !STN1 )
   {
      if( Server2->Socket->ActiveConnections != 0 )
      {
         str = "[start] ";
         str = str + AnsiString(Table1Dt->AsDateTime) + " ";
         str = str + AnsiString(Table1Type->AsInteger) + " ";
         str = str + "\"" + Table1Name->AsString + "\" ";
         str = str + AnsiString(Table1Dtype->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum1->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum2->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum3->AsInteger) + " ";

         str = str + " [stop]";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      bool alarmfix = true;

      switch( otype )
      {
         case 0: 
                 break;
         case 1: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lon;
                 description = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].AlarmFix;
                 if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 33: 
                 id = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lon;
                 description = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].AlarmFix;
                 if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 4: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 10: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2-1];
                 break;
         case 11: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][IpBlIdx].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][IpBlIdx].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][IpBlIdx].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][IpBlIdx].AlarmFix[onum2-1];
                 break;
         case 12:
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 21:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 41:
                 break;
         case 42: 
                 break;
         case 51: 
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, name, lan, lon, description );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Table1Dt->AsDateTime);
      if( alarmfix ) str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", stype, dt_str, Table1Type2Str->AsString );
      else str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"%s\"/>", dt_str, "Контроль выкл" );
      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);
   }

   if( UseAsoosd )
   {
      if( otype == SdType || stype == 200 )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 200 || stype == 1 || stype == 136 || stype == 137 )
         {
            AnsiString d_t;

UseAsoosd_label:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 200: stype2 = 43; break;
                     case 11: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                     case 136: stype2 = -1; break;
                     case 137: stype2 = 0; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);
                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label;
            }
         }
      }
      else if( otype == SsoiMSdType )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 13 || stype == 1  )
         {
            AnsiString d_t;

UseAsoosd_label2:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 11: stype2 = 44; break;
                     case 13: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);

                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label2;
            }
         }
      }
   }

   return query;
}
//---------------------------------------------------------------------------
AnsiString TMainForm::SetSob22( int stype, int otype, int onum1, int onum2, int onum3, AnsiString udpadress, int udpport, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype )
{
   AnsiString str, query;

   Table1->Insert();
   Table1Dt->AsDateTime = Now();
   Table1Type->AsInteger = stype;
   Table1Name->AsString = name;
   Table1Flag->AsBoolean = false;
   Table1Dtype->AsInteger = otype;
   Table1Dnum1->AsInteger = onum1;
   Table1Dnum2->AsInteger = onum2;
   Table1Dnum3->AsInteger = onum3;
   Table1OpFn->AsString = ofn;
   Table1OpN1->AsString = on1;
   Table1OpN2->AsString = on2;
   Table1ClFn->AsString = cfn;
   Table1ClN1->AsString = cn1;
   Table1ClN2->AsString = cn2;
   Table1OutType->AsInteger = outtype;
   Table1->Post();

   if( Msg )
   {
      TMsgForm *mfrm = new TMsgForm(this);
      mfrm->Left = MainForm->Left + MainForm->Width - mfrm->Width - 50;
      int y1 = MainFormY + mfrm->Height;
      int y2 = MainForm->Top + MainForm->Height - 100;
      if( y1 < y2 )
      {
         mfrm->Top = MainFormY + 50;
         MainFormY = mfrm->Top;
      }
      else
      {
         MainFormY = MainForm->Top + 50;
         mfrm->Top = MainFormY;
      }

      mfrm->StaticText2->Caption = Table1Name->AsString;
      mfrm->StaticText1->Caption = Table1Type2Str->AsString;
      mfrm->Show();
   }

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      bool alarmfix = true;

      switch( otype )
      {
         case 0: 
                 break;
         case 1: 
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].AlarmFix;
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].AlarmFix;
                 break;
         case 10: 
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].AlarmFix;
                 break;
         case 11: 
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[onum2].AlarmFix;
                 break;
         case 12: 
                 id =  Rif2Sys->Ch[onum3].Dev[100].Iu[onum2].TreeIdx;
                 break;
         case 26:
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].AlarmFix;
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].AlarmFix;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].AlarmFix;
                 break;
         case 29:
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Sd[0].AlarmFix;
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Uch[num21].AlarmFix;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].TreeIdx;
                 lan = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].lan;
                 lon = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].lon;
                 description = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].description;
                 alarmfix = Rif2Sys->Ch[onum3].Dev[onum1].Dd[num21].AlarmFix;
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\" udp_adress=\"%s\" udp_port=\"%d\">",
                  id, level, otype, onum1, onum2, onum3, name, lan, lon, description, Rif2Sys->Ch[onum3].Ip, Rif2Sys->Ch[onum3].Port );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Table1Dt->AsDateTime);
      if( alarmfix ) str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", stype, dt_str, Table1Type2Str->AsString );
      else str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"%s\"/>", dt_str, "Контроль выкл" );
      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);
   }

   return query;
}
//---------------------------------------------------------------------------
void TMainForm::SetSob3( int stype, int otype, int onum1, int onum2, int onum3, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype )
{
   AnsiString str;

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      bool alarmfix = true;

      switch( otype )
      {
         case 0: 
                 break;
         case 1: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lon;
                 description = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].AlarmFix;
                 if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 33: 
                 id = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lon;
                 description = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].AlarmFix;
                 if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 4: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 10: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2-1];
                 break;
         case 11:
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][IpBlIdx].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][IpBlIdx].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][IpBlIdx].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][IpBlIdx].AlarmFix[onum2-1];

                 if( !RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] )
                     if( stype == 1 && RifSys->Rk[onum3-1][IpBlIdx].Tin[onum2-1] ) stype = 20;
                 break;
         case 12: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 21:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 41: 
                 break;
         case 42:
                 break;
         case 51: 
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
      }

      AnsiString sname;
      switch( stype )
      {
          case   0: sname = Table1Str1; 
                    break;
          case   1: sname = Table1Str2;
                    break;
          case   2: if( otype == SdIpBlType &&
                        RifSys->Rk[onum3-1][onum1-1].Bazalt[onum2-1] ) sname = Table1Str1;
                    else sname = "Конф. изм. (пульт)";
                    break;
          case   3: sname = Table1Str3; 
                    break;
          case   4: sname = Table1Str4; 
                    break;
          case   5: sname = "Отметка пройдена"; 
                    break;
          case   6: sname = "Определение направления включено";
                    break;
          case   7: sname = "Определение направления выключено";
                    break;
          case  10: sname = Table1Str5; 
                    break;
          case  11: sname = Table1Str6; 
                    break;
          case  12: if( otype == SdType || otype == IuType ) sname = "Нет связи с ESE-U485";
                    else if( otype == TochkaMDdIdx ) sname = "Неисправность по ЧЭ1";
                    else if( otype == SotaMDdIdx ) sname = "Неисправность ДД";
                    else sname = "Неисправность";
                    break;
          case  13: if( otype == TochkaMDdIdx ) sname = "Неисправность по ЧЭ2";
                    else sname = Table1Str7; 
                    break;
          case  15: sname = "Перевод в режим \"Раб. с пультом\"";
                    break;
          case  16: sname = "Отсутствует синхронизация";
                    break;
          case  17: if( otype == SdIpBlType &&
                        RifSys->Rk[onum3-1][onum1-1].Bazalt[onum2-1] ) sname = Table1Str5;
                    else sname = "Неисправность линии";
                    break;
          case  18: sname = "Неисправность ЧЭ";
                    break;
          case  20: sname = Table1Str8; 
                    break;
          case  21: sname = Table1Str9;
                    break;
          case  22: if( otype == TochkaMDdIdx ) sname = "Тревога - СРАБОТКА по ЧЭ1";
                    else sname = Table1Str10; 
                    break;
          case  23: if( otype == 9 ) sname = "Тревога-СРАБОТКА(Луч чужой)";
                    else if( otype == 91 ) sname = "Тревога-СРАБОТКА(Зона 1)";
                    else if( otype == 21 ) sname = "Тревога-НЕИСПРАВНОСТЬ";
                    else if( otype == 10 )
                    {
                       AnsiString s;
                       s.sprintf("Тревога - Сработка от ЧЭ%d", Table1Dnum2->AsInteger);
                       sname = s;
                    }
                    else if( otype == TochkaMDdIdx ) sname = "Тревога - СРАБОТКА по ЧЭ2";
                    else sname = "Тревога - СРАБОТКА(Луч 1)";
                    break;
          case  24: if( otype == 9 ) sname = "Тревога - СРАБОТКА(Луч свой)";
                    else if( otype == 91 ) sname = "Тревога - СРАБОТКА(Зона 2)";
                    else sname = "Тревога-СРАБОТКА(Луч 2)";
                    break;
          case  25: if( otype == 9 != RifRlmSType ) sname = Table1Str9; 
                    else sname = "Тревога - СИНХР.ИЗМ.";
                    break;
          case  26: sname = "Тревога - Отсутствие часового"; 
                    break;
          case  27: sname = "Тревога - СРАБОТКА(Зона 3)";
                    break;
          case  30: sname = "Раб. с пультом";
                    break;
          case  31: name = "Раб. с пультом заверш.";
                    break;
          case 100: sname = Table1Str11; 
                    break;
          case 101: sname = Table1Str12; 
                    break;
          case 110: sname = Table1Str13; 
                    break;
          case 111: sname = Table1Str14; 
                    break;
          case 112: sname = Table1Str28; 
                    break;
          case 113: sname = Table1Str29; 
                    break;
          case 130: sname = Table1Str15; 
                    break;
          case 131: sname = Table1Str16; 
                    break;
          case 132: sname = "Послана ком. \"Раб. с пультом\"";
                    break;
          case 138: sname = "Послана ком. \"Завершение раб. с пультом\"";
                    break;
          case 133: sname = Table1Str17; 
                    break;
          case 134: sname = "Запись настройки";
                    break;
          case 135: sname = Table1Str18; 
                    break;
          case 136: sname = Table1Str19; 
                    break;
          case 137: sname = Table1Str20; 
                    break;
          case 140: sname = Table1Str21; 
                    break;
          case 141: sname = Table1Str22; 
                    break;
          case 142: sname = "Синхронизация восстановлена";
                    break;
          case 143: sname = Table1Str30; 
                    break;
          case 144: sname  = "Вызов завершен по кан. связи";
                    break;
          case 145: sname = Table1Str32; 
                    break;
          case 150: sname = Table1Str23; 
                    break;
          case 151: sname = Table1Str24; 
                    break;
          case 160: sname = "ДК не выполнена (все зоны отключены)";
                    break;
          case 170: sname = "Зона1 отключена";
                    break;
          case 171: sname = "Зона1 включена";
                    break;
          case 172: sname = "Зона2 отключена";
                    break;
          case 173: sname = "Зона2 включена";
                    break;
          case 174: sname = "Зона3 отключена";
                    break;
          case 175: sname = "Зона3 включена";
                    break;
          case 200: sname = Table1Str5; 
                    break;
      }

      if( !alarmfix )

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, name, lan, lon, description );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Now());
      if( alarmfix ) str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", stype, dt_str, sname );
      else str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"%s\"/>", dt_str, sname, "Контроль выкл" );
      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);
   }
}
//---------------------------------------------------------------------------
void TMainForm::SetSob4( int stype, int otype, int onum1, int onum2, int onum3, AnsiString name, AnsiString ofn, AnsiString on1, AnsiString on2, AnsiString cfn, AnsiString cn1, AnsiString cn2, bool Msg, int outtype )
{
   AnsiString str;

   Table1->Insert();
   Table1Dt->AsDateTime = Now();
   Table1Type->AsInteger = stype;
   Table1Name->AsString = name;
   Table1Flag->AsBoolean = false;
   Table1Dtype->AsInteger = otype;
   Table1Dnum1->AsInteger = onum1;
   Table1Dnum2->AsInteger = onum2;
   Table1Dnum3->AsInteger = onum3;
   Table1OpFn->AsString = ofn;
   Table1OpN1->AsString = on1;
   Table1OpN2->AsString = on2;
   Table1ClFn->AsString = cfn;
   Table1ClN1->AsString = cn1;
   Table1ClN2->AsString = cn2;
   Table1OutType->AsInteger = outtype;
   Table1->Post();
   Table1->FlushBuffers();

   ShowPrCnt();

   if( Msg )
   {
      TMsgForm *mfrm = new TMsgForm(this);
      mfrm->Left = MainForm->Left + MainForm->Width - mfrm->Width - 50;
      int y1 = MainFormY + mfrm->Height;
      int y2 = MainForm->Top + MainForm->Height - 100;
      if( y1 < y2 )
      {
         mfrm->Top = MainFormY + 50;
         MainFormY = mfrm->Top;
      }
      else
      {
         MainFormY = MainForm->Top + 50;
         mfrm->Top = MainFormY;
      }

      mfrm->StaticText2->Caption = Table1Name->AsString;
      mfrm->StaticText1->Caption = Table1Type2Str->AsString;
      mfrm->Show();
   }

   if( MySQL_use > 0 )
   {
      AnsiString query, err_str;
      AnsiString d_t;
      d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", Table1Dt->AsDateTime);

      query.sprintf("INSERT INTO %s.events VALUES(%d, \'%s\', %d, \'%s\', %d, %d, %d, %d, \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', \'%s\', %d)",
                               MySQL_dbname,
                               events_num,                        
                               d_t,                               
                               Table1Type->AsInteger,            
                               Table1Type2Str->AsString,          
                               Table1Dtype->AsInteger,           
                               Table1Dnum1->AsInteger,           
                               Table1Dnum2->AsInteger,           
                               Table1Dnum3->AsInteger,           
                               Table1Name->AsString,             
                               "",
                               "",
                               Table1OpFn->AsString,
                               Table1OpN1->AsString,
                               Table1OpN2->AsString,
                               Table1ClFn->AsString,
                               Table1ClN1->AsString,
                               Table1ClN2->AsString,
                               Table1OutType->AsInteger );
      mysql_real_query(Con,query.c_str(),query.Length());
      int err_code = mysql_errno(Con);
      if( err_code != 0 )
      {
         mysql_close(Con);

         Con = mysql_init(NULL);
         mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
         err_code = mysql_errno(Con);
         if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
         {
            MySQL_use = -1;

            err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
            ShowMessage(err_str);
         }
         else
         {
            mysql_real_query(Con,query.c_str(),query.Length());
            err_code = mysql_errno(Con);
            if( err_code != 0 )
            {
               MySQL_use = -1;

               err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
               ShowMessage(err_str);
            }
            else events_num = events_num + 1;
         }
      }
      else events_num = events_num + 1;
   }

   if( Server2Use && !Stn485Tv && !STN1 )
   {
      if( Server2->Socket->ActiveConnections != 0 )
      {
         str = "[start] ";
         str = str + AnsiString(Table1Dt->AsDateTime) + " ";
         str = str + AnsiString(Table1Type->AsInteger) + " ";
         str = str + "\"" + Table1Name->AsString + "\" ";
         str = str + AnsiString(Table1Dtype->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum1->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum2->AsInteger) + " ";
         str = str + AnsiString(Table1Dnum3->AsInteger) + " ";

         str = str + " [stop]";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }

   if( iServerUse )
   {
      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;
      AnsiString sTable1Type2Str = Table1Type2Str->AsString;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      bool alarmfix = true;

      switch( otype )
      {
         case 0: 
                 break;
         case 1:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lon;
                 description = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].AlarmFix;

                 if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 143;
                     }
                     else if(  GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 33: 
                 id = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lon;
                 description = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].description;
                 alarmfix = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].AlarmFix;

                 if( GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].ConnectBlock )
                 {
                     if( GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 1 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 2 ) stype = 143;
                        else stype = 146;
                     }
                     else if(  GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].Status == 20 )
                     {
                        if( GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-4].Status == 1 ) stype = 144;
                        else stype = 145;
                     }
                 }
                 break;
         case 4: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 43: 
                 if( onum3 < 4 ) id = GobiSys2->Bl[onum1-1][onum2-1].Iu[onum3-1].TreeIdx;
                 else { id = GobiSys2->Bl[onum1-1][onum2-1].Vk[onum3-4].TreeIdx; }
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 10:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2-1];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2-1];
                 break;
         case 11:
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][IpBlIdx].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][IpBlIdx].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][IpBlIdx].description[onum2-1];
                 if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 0 ) { stype = 2; sTable1Type2Str = Table1Str1; }
                 else if( RifSys->Rk[onum3-1][IpBlIdx].Bazalt[onum2-1] && stype == 10 ) { stype = 17; sTable1Type2Str = Table1Str5; }
                 alarmfix = RifSys->Rk[onum3-1][IpBlIdx].AlarmFix[onum2-1];
                 break;
         case 12: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Uch[num21].AlarmFix;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 100;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].Dd[num21].AlarmFix;
                 break;
         case 21: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[onum2];
                 break;
         case 41: 
                 break;
         case 42: 
                 break;
         case 51: 
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 alarmfix = RifSys->Rk[onum3-1][onum1-1].AlarmFix[0];
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      TStringList *es_list;
      es_list = new TStringList();
      es_list->Clear();
      es_list->Insert(0, "<RIFPlusPacket type=\"EventsAndStates\">");
      es_list->Insert(1, "<devices>");


      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, name, lan, lon, description );
      es_list->Add(str);
      str.sprintf("<states>");
      es_list->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss", Table1Dt->AsDateTime);

      if( alarmfix )
      {
         str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", stype, dt_str, sTable1Type2Str );
      }
      else
      {
         str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"Контроль выкл\"/>", dt_str );
      }

      es_list->Add(str);

      str.sprintf("</states>");
      es_list->Add(str);

      str.sprintf("</device>");
      es_list->Add(str);

      es_list->Add("</devices>");
      es_list->Add("</RIFPlusPacket>");

      if( iServer->Active )
      {
          for( int i = 0; i < iServer->Socket->ActiveConnections; i++ )
          for( int j = 0; j < NetClientMaxCnt; j++ )
          {
             if( iNetSys->iNetClient[j].IsExist(iServer->Socket->Connections[i]->SocketHandle) )
             {
                if( iNetSys->iNetClient[j].KeepAliveCnt < (iKeepAlive-1) )
                {
                   if( iNetSys->iNetClient[j].EventsAndStates )
                   {
                      iServer->Socket->Connections[i]->SendBuf(es_list->Text.c_str(),es_list->Text.Length());
                   }
                }
             }
          }
      }
      es_list->Clear();
      delete es_list;
   }

   if( UseAsoosd )
   {
      if( otype == SdType || stype == 200 )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 200 || stype == 1 || stype == 136 || stype == 137 )
         {
            AnsiString d_t;

UseAsoosd_label:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 200: stype2 = 43; break;
                     case 11: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                     case 136: stype2 = -1; break;
                     case 137: stype2 = 0; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);
                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label;
            }
         }
      }
      else if( otype == SsoiMSdType )
      {
         if( stype == 20 || stype == 21 || stype == 10 || stype == 11 || stype == 13 || stype == 1  )
         {
            AnsiString d_t;

UseAsoosd_label2:

            bool fl = false;
            for( int i = 0; i < 100; i++ )
            {
               if( Asoosd_str[i].Length() == 0 )
               {
                  fl = true;
                  Asoosd_str[i] = 0;

                  d_t = FormatDateTime("ddmmyyyy,hhnnss", Table1Dt->AsDateTime);
                  int stype2 = 0;
                  switch( stype )
                  {
                     case 1:  stype2 = 45; break;
                     case 10: stype2 = 42; break;
                     case 11: stype2 = 44; break;
                     case 13: stype2 = 44; break;
                     case 20: stype2 = 40; break;
                     case 21: stype2 = 41; break;
                  }

                  Asoosd_str[i].sprintf("%d,%d,0,%02d%02d%02d,%s,0.0,0.0,%d",
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_kk,
                                         GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].asoosd_nn,
                                         onum1,onum2,onum3,
                                         d_t,
                                         stype2);

                  break;
               }
            }

            if( !fl )
            {
               for( int i = 0; i < 100; i++ ) Asoosd_str[i] = "";
               goto UseAsoosd_label2;
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagRifInfoNew( int type, int status, int sb, double u, double u2, int d1, int d2 )
{
   AnsiString str;
   if( DiagRif->Adr == 0 && DiagKonc->Adr == 0 )
   {
      ResetDiagInfo2(type, 1);
   }
   else
   {
      if( type == 0 || type == 2 )
      {
         if( status != 10 )
         {
            bool On = false;  

            bool Dk = false;  
            bool T = false;   
            bool Tv = false;  
            bool Ts = false;  

            bool St = false;  
            bool Sv = false;  
            bool Sdk = false; 

            if( (sb&0x01) == 0x01 ) On = true;
            if( (sb&0x02) == 0x02 ) Ts = true;
            if( (sb&0x04) == 0x04 ) St = true;
            if( (sb&0x08) == 0x08 ) T = true;
            if( (sb&0x10) == 0x10 ) Sdk = true;
            if( (sb&0x20) == 0x20 ) Dk = true;
            if( (sb&0x40) == 0x40 ) Sv = true;
            if( (sb&0x80) == 0x80 ) Tv = true;

            if( On ) AdvStringGrid1->Cells[1][1]="Вкл [1]";
            else AdvStringGrid1->Cells[1][1]="Выкл [0]";

            if( T ) AdvStringGrid1->Cells[1][2]="Да [1]";
            else AdvStringGrid1->Cells[1][2]="Нет [0]";

            if( St ) AdvStringGrid1->Cells[3][2]="Да [1]";
            else AdvStringGrid1->Cells[3][2]="Нет [0]";

            if( Ts ) AdvStringGrid1->Cells[1][3]="Да [1]";
            else AdvStringGrid1->Cells[1][3]="Нет [0]";

            if( Tv ) AdvStringGrid1->Cells[1][4]="Да [1]";
            else AdvStringGrid1->Cells[1][4]="Нет [0]";

            if( Sv ) AdvStringGrid1->Cells[3][4]="Да [1]";
            else AdvStringGrid1->Cells[3][4]="Нет [0]";

            if( Dk ) AdvStringGrid1->Cells[1][5]="Есть [1]";
            else AdvStringGrid1->Cells[1][5]="Нет [0]";

            if( Sdk ) AdvStringGrid1->Cells[3][5]="Есть [1]";
            else AdvStringGrid1->Cells[3][5]="Нет [0]";

            str.sprintf("%4.2f", u);
            AdvStringGrid1->Cells[1][6]=str;
         }
         else
         {
            AdvStringGrid1->Cells[1][1]="Нет связи!";
            AdvStringGrid1->Cells[1][2]="Нет связи!";
            AdvStringGrid1->Cells[3][2]="Нет связи!";
            AdvStringGrid1->Cells[1][3]="Нет связи!";
            AdvStringGrid1->Cells[1][4]="Нет связи!";
            AdvStringGrid1->Cells[3][4]="Нет связи!";
            AdvStringGrid1->Cells[1][5]="Нет связи!";
            AdvStringGrid1->Cells[3][5]="Нет связи!";
            AdvStringGrid1->Cells[1][6]="Нет связи!";
         }
      }
      else if( type == RifRlmSType )
      {
         if( status != 10 )
         {
            bool On = false; 
            bool Ts = false; 
            bool St = false; 
            bool T = false;  
            bool Sdk = false;
            bool Dk = false; 

            bool Synchro = false; 
            bool Slow = false;    

            if( (sb&0x01) == 0x01 ) On = true;
            if( (sb&0x02) == 0x02 ) Ts = true;
            if( (sb&0x04) == 0x04 ) St = true;
            if( (sb&0x08) == 0x08 ) T = true;
            if( (sb&0x10) == 0x10 ) Sdk = true;
            if( (sb&0x20) == 0x20 ) Dk = true;
            if( (sb&0x40) == 0x40 ) Synchro = true;
            if( (sb&0x80) == 0x80 ) Slow = true;

            if( On ) AdvStringGrid1->Cells[1][1]="Вкл [1]";
            else AdvStringGrid1->Cells[1][1]="Выкл [0]";

            if( T ) AdvStringGrid1->Cells[1][2]="Да [1]";
            else AdvStringGrid1->Cells[1][2]="Нет [0]";

            if( St ) AdvStringGrid1->Cells[3][2]="Да [1]";
            else AdvStringGrid1->Cells[3][2]="Нет [0]";

            if( Ts ) AdvStringGrid1->Cells[1][3]="Да [1]";
            else AdvStringGrid1->Cells[1][3]="Нет [0]";

            if( Dk ) AdvStringGrid1->Cells[1][4]="Есть [1]";
            else AdvStringGrid1->Cells[1][4]="Нет [0]";

            if( Sdk ) AdvStringGrid1->Cells[3][4]="Есть [1]";
            else AdvStringGrid1->Cells[3][4]="Нет [0]";

            if( Synchro ) AdvStringGrid1->Cells[1][5]="Внешняя";
            else AdvStringGrid1->Cells[1][5]="Внутренняя";

            if( Slow ) AdvStringGrid1->Cells[1][6]="Да <1>";
            else AdvStringGrid1->Cells[1][6]="Нет [0]";

            str.sprintf("%4.2f", u);
            AdvStringGrid1->Cells[1][7]=str;

            int porogi = d1 & 0x0F;
            switch( porogi )
            {
               case 0: str = "10 (чувств.)"; break;
               case 1: str = "09"; break;
               case 2: str = "08"; break;
               case 3: str = "07"; break;
               case 4: str = "06"; break;
               case 5: str = "05"; break;
               case 6: str = "04"; break;
               case 7: str = "03"; break;
               case 8: str = "02"; break;
               case 9: str = "01 (груб.)"; break;
               case 10: str = ".6"; break;
               case 11: str = ".5"; break;
               case 12: str = ".4"; break;
               case 13: str = ".3"; break;
               case 14: str = ".2"; break;
               case 15: str = ".1 (самый груб.)"; break;
            }
            AdvStringGrid1->Cells[1][8]=str;

            int takt = (d1 & 0x10)>>4;
            int takt1 = (d1 & 0x20)>>4;
            int takt2 = (d1 & 0x40)>>4;
            takt = takt | takt1 | takt2;
            str.sprintf("Такт %d", takt+1);
            AdvStringGrid1->Cells[1][9]=str;

            int rezhim = d2 & 0x03;
            switch( rezhim )
            {
               case 0: str = "Основной"; break;
               case 1: str = "Дополнительный"; break;
               case 2: str = "Ползущий (Плз)"; break;
               case 3: str = "2-й ярус (2Яр)"; break;
            }
            AdvStringGrid1->Cells[1][10]=str;
         }
         else
         {
            AdvStringGrid1->Cells[1][1]="Нет связи!";
            AdvStringGrid1->Cells[1][2]="Нет связи!";
            AdvStringGrid1->Cells[3][2]="Нет связи!";
            AdvStringGrid1->Cells[1][3]="Нет связи!";
            AdvStringGrid1->Cells[1][4]="Нет связи!";
            AdvStringGrid1->Cells[3][4]="Нет связи!";
            AdvStringGrid1->Cells[1][5]="Нет связи!";
            AdvStringGrid1->Cells[1][6]="Нет связи!";
            AdvStringGrid1->Cells[1][7]="Нет связи!";
            AdvStringGrid1->Cells[1][8]="Нет связи!";
            AdvStringGrid1->Cells[1][9]="Нет связи!";
            AdvStringGrid1->Cells[1][10]="Нет связи!";
         }
      }
      else if( type == 10 )
      {
         if( status == 10 )
         {
            AdvStringGrid1->Cells[1][1]="Нет связи!";
            AdvStringGrid1->Cells[3][1]="Нет связи!";
            AdvStringGrid1->Cells[1][2]="Нет связи!";
            AdvStringGrid1->Cells[3][2]="Нет связи!";
            AdvStringGrid1->Cells[1][3]="Нет связи!";
            AdvStringGrid1->Cells[3][3]="Нет связи!";
            AdvStringGrid1->Cells[1][4]="Нет связи!";
            AdvStringGrid1->Cells[3][4]="Нет связи!";
            AdvStringGrid1->Cells[1][5]="Нет связи!";
            AdvStringGrid1->Cells[3][5]="Нет связи!";
            AdvStringGrid1->Cells[1][6]="Нет связи!";
            AdvStringGrid1->Cells[3][6]="Нет связи!";

            AdvStringGrid1->Cells[5][1]="Нет связи!";
            AdvStringGrid1->Cells[5][2]="Нет связи!";
            AdvStringGrid1->Cells[5][3]="Нет связи!";
            AdvStringGrid1->Cells[5][4]="Нет связи!";

            AdvStringGrid1->Cells[1][7]="Нет связи!";

            AdvStringGrid1->Cells[1][8]="Нет связи!";
            AdvStringGrid1->Cells[3][8]="Нет связи!";
            AdvStringGrid1->Cells[5][8]="Нет связи!";
//            AdvStringGrid1->Cells[7][8]="Нет связи!";
            AdvStringGrid1->Cells[1][9]="Нет связи!";
            AdvStringGrid1->Cells[3][9]="Нет связи!";
            AdvStringGrid1->Cells[5][9]="Нет связи!";
//            AdvStringGrid1->Cells[7][9]="Нет связи!";
            AdvStringGrid1->Cells[1][10]="Нет связи!";
            AdvStringGrid1->Cells[3][10]="Нет связи!";
            AdvStringGrid1->Cells[5][10]="Нет связи!";
//            AdvStringGrid1->Cells[7][10]="Нет связи!";

            AdvStringGrid1->Cells[1][11]="Нет связи!";

            AdvStringGrid1->Cells[1][12]="Нет связи!";
            AdvStringGrid1->Cells[3][12]="Нет связи!";
            AdvStringGrid1->Cells[5][12]="Нет связи!";
//            AdvStringGrid1->Cells[7][12]="Нет связи!";
            AdvStringGrid1->Cells[1][13]="Нет связи!";
            AdvStringGrid1->Cells[3][13]="Нет связи!";
            AdvStringGrid1->Cells[5][13]="Нет связи!";
//            AdvStringGrid1->Cells[7][13]="Нет связи!";
            AdvStringGrid1->Cells[1][14]="Нет связи!";
            AdvStringGrid1->Cells[3][14]="Нет связи!";
            AdvStringGrid1->Cells[5][14]="Нет связи!";
//            AdvStringGrid1->Cells[7][14]="Нет связи!";
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagRifInfo( int type, int status, int sb, double u, double u2, int d1, int d2 )
{
   ShowDiagRifInfoNew(type,status,sb,u,u2,d1,d2 );

   AnsiString str;
   if( DiagRif->Adr == 0 )
   {
      ResetDiagInfo(type);
   }
   else
   {
      if( type == 0 || type == 2 )
      {
         if( status != 10 )
         {
            bool On = false;  

            bool Dk = false;  
            bool T = false;   
            bool Tv = false;  
            bool Ts = false;  

            bool St = false;  
            bool Sv = false;  
            bool Sdk = false; 

            if( (sb&0x01) == 0x01 ) On = true;
            if( (sb&0x02) == 0x02 ) Ts = true;
            if( (sb&0x04) == 0x04 ) St = true;
            if( (sb&0x08) == 0x08 ) T = true;
            if( (sb&0x10) == 0x10 ) Sdk = true;
            if( (sb&0x20) == 0x20 ) Dk = true;
            if( (sb&0x40) == 0x40 ) Sv = true;
            if( (sb&0x80) == 0x80 ) Tv = true;

            if( On != DiagRif->On || status != DiagRif->Status )
            {
               if( !On )
               {
                  Image1->Picture->Bitmap = I6Img;
                  StaticText2->Caption = "ВЫКЛ";
               }
               else
               {
                  Image1->Picture->Bitmap = I3Img;
                  StaticText2->Caption = "ВКЛ";
               }
            }
            DiagRif->On = On;

            if( Ts != DiagRif->Ts || status != DiagRif->Status )
            {
               if( !Ts )
               {
                  Image6->Picture->Bitmap = I2Img;
                  StaticText7->Caption = "НЕТ";
               }
               else
               {
                  Image6->Picture->Bitmap = I5Img;
                  StaticText7->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts = Ts;

            if( St != DiagRif->St || status != DiagRif->Status )
            {
               if( !St )
               {
                  if( type == 0) { Image5->Picture->Bitmap = I7Img; StaticText6->Caption = "НЕТ"; }
                  else if( type == 2 ) { Image7->Picture->Bitmap = I7Img; StaticText8->Caption = "НЕТ"; }
               }
               else
               {
                  if( type == 0) { Image5->Picture->Bitmap = I8Img; StaticText6->Caption = "ЕСТЬ"; }
                  else if( type == 2 ) { Image7->Picture->Bitmap = I8Img; StaticText8->Caption = "ЕСТЬ"; }

               }
            }
            DiagRif->St = St;

            if( T != DiagRif->T || status != DiagRif->Status  )
            {
               if( !T )
               {
                  Image4->Picture->Bitmap = I2Img;
                  StaticText5->Caption = "НЕТ";
               }
               else
               {
                  Image4->Picture->Bitmap = I5Img;
                  StaticText5->Caption = "ЕСТЬ";
               }
            }
            DiagRif->T = T;

            if( Sdk != DiagRif->Sdk || status != DiagRif->Status  )
            {
               if( !Sdk )
               {
                  if( type == 0) { Image3->Picture->Bitmap = I7Img; StaticText4->Caption = "НЕТ"; }
                  else if( type == 2) { Image8->Picture->Bitmap = I7Img; StaticText9->Caption = "НЕТ"; }
               }
               else
               {
                  if( type == 0) { Image3->Picture->Bitmap = I9Img; StaticText4->Caption = "ЕСТЬ"; }
                  else if( type == 2) { Image8->Picture->Bitmap = I8Img; StaticText9->Caption = "ЕСТЬ"; }

               }
            }
            DiagRif->Sdk = Sdk;

            if( Dk != DiagRif->Dk || status != DiagRif->Status  )
            {
               if( !Dk )
               {
                  Image2->Picture->Bitmap = I2Img;
                  StaticText3->Caption = "НЕТ";
               }
               else
               {
                  Image2->Picture->Bitmap = I4Img;
                  StaticText3->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Dk = Dk;

            if( Sv != DiagRif->Sv || status != DiagRif->Status  )
            {
               if( !Sv )
               {
                  if( type == 0) { Image8->Picture->Bitmap = I7Img; StaticText9->Caption = "НЕТ";}
                  else if( type == 2) { Image5->Picture->Bitmap = I2Img; StaticText6->Caption = "НЕТ"; }
               }
               else
               {
                  if( type == 0) { Image8->Picture->Bitmap = I8Img; StaticText9->Caption = "ЕСТЬ"; }
                  else if( type == 2) { Image5->Picture->Bitmap = I5Img; StaticText6->Caption = "ЕСТЬ"; }
               }
            }
            DiagRif->Sv = Sv;

            if( Tv != DiagRif->Tv || status != DiagRif->Status  )
            {
               if( !Tv )
               {
                  if( type == 0) { Image7->Picture->Bitmap = I2Img; StaticText8->Caption = "НЕТ"; }
                  else if( type == 2) { Image3->Picture->Bitmap = I2Img; StaticText4->Caption = "НЕТ"; }
               }
               else
               {
                  if( type == 0) { Image7->Picture->Bitmap = I5Img; StaticText8->Caption = "ЕСТЬ"; }
                  else if( type == 2) { Image3->Picture->Bitmap = I5Img; StaticText4->Caption = "ЕСТЬ"; }
               }
            }
            DiagRif->Tv = Tv;

            str.sprintf("%4.2f", u);
            StaticText10->Caption = str;
            DiagRif->U = u;
         }
         else
         {
            if( status != DiagRif->Status )
            {
               ResetDiagInfo(1);
            }
         }
         DiagRif->Status = status;
      }
      else if( type == 3 )
      {
         if( status != 10 )
         {
            bool Dk = false;  
            bool T = false;   
            bool Ts = false;  
            bool Ts1 = false; 
            bool Ts2 = false; 
            bool Pult = false;
            bool S = false;   
            bool St = false;  
            bool Luch1 = false;
            bool Luch2 = false;

            if( (sb&0x01) == 0x01 ) Pult = true;
            if( (sb&0x02) == 0x02 ) Ts = true;
            if( (sb&0x04) == 0x04 ) St = true;
            if( (sb&0x08) == 0x08 ) T = true;
            if( (sb&0x10) == 0x10 ) Ts2 = true;
            if( (sb&0x20) == 0x20 ) Dk = true;
            if( (sb&0x40) == 0x40 ) Ts1 = true;
            if( (sb&0x80) == 0x80 ) S = true;

            int t = (d1 & 0x30)>>4;
            if( t == 0 ) Luch1 = true;

            t = (d2 & 0x30)>>4;
            if( t == 0 ) Luch2 = true;

            if( Pult != DiagRif->Pult || status != DiagRif->Status )
            {
               if( !Pult )
               {
                  Image51->Picture->Bitmap = I6Img;
                  StaticText51->Caption = "ВЫКЛ";
               }
               else
               {
                  Image51->Picture->Bitmap = I3Img;
                  StaticText51->Caption = "ВКЛ";
               }
            }
            DiagRif->Pult = Pult;

            if( Ts != DiagRif->Ts || status != DiagRif->Status )
            {
               if( !Ts )
               {
                  Image6->Picture->Bitmap = I2Img;
                  StaticText7->Caption = "НЕТ";
               }
               else
               {
                  Image6->Picture->Bitmap = I5Img;
                  StaticText7->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts = Ts;

            if( St != DiagRif->St || status != DiagRif->Status )
            {
               if( !St )
               {
                  Image5->Picture->Bitmap = I7Img;
                  StaticText6->Caption = "НЕТ";
               }
               else
               {
                  Image5->Picture->Bitmap = I8Img;
                  StaticText6->Caption = "ЕСТЬ";
               }
            }
            DiagRif->St = St;

            if( T != DiagRif->T || status != DiagRif->Status  )
            {
               if( !T )
               {
                  Image4->Picture->Bitmap = I2Img;
                  StaticText5->Caption = "НЕТ";
               }
               else
               {
                  Image4->Picture->Bitmap = I5Img;
                  StaticText5->Caption = "ЕСТЬ";
               }
            }
            DiagRif->T = T;

            if( Luch1 != DiagRif->Luch1 )
            {
               if( !Luch1 )
               {
                  Image8->Picture->Bitmap = I6Img;
                  StaticText9->Caption = "ВЫКЛ";
               }
               DiagRif->Ts1 = !Ts1;
            }
            else if( Luch1 )
            {
               if( (Ts1 != DiagRif->Ts1 || status != DiagRif->Status) )
               {
                  if( !Ts1 )
                  {
                     Image8->Picture->Bitmap = I2Img;
                     StaticText9->Caption = "НЕТ";
                  }
                  else
                  {
                     Image8->Picture->Bitmap = I5Img;
                     StaticText9->Caption = "ЕСТЬ";
                  }
               }
               DiagRif->Ts1 = Ts1;
            }
            DiagRif->Luch1 = Luch1;

            if( Ts2 != DiagRif->Ts2 || status != DiagRif->Status  )
            {
               if( !Ts2 )
               {
                  Image3->Picture->Bitmap = I2Img;
                  StaticText4->Caption = "НЕТ";
               }
               else
               {
                  Image3->Picture->Bitmap = I5Img;
                  StaticText4->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts2 = Ts2;

            if( Dk != DiagRif->Dk || status != DiagRif->Status  )
            {
               if( !Dk )
               {
                  Image2->Picture->Bitmap = I2Img;
                  StaticText3->Caption = "НЕТ";
               }
               else
               {
                  Image2->Picture->Bitmap = I4Img;
                  StaticText3->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Dk = Dk;

            if( S != DiagRif->S || status != DiagRif->Status  )
            {
               if( !S )
               {
                  Image52->Picture->Bitmap = I2Img;
                  StaticText52->Caption = "НЕТ";
               }
               else
               {
                  Image52->Picture->Bitmap = I3Img;
                  StaticText52->Caption = "ЕСТЬ";
               }
            }
            DiagRif->S = S;

            if( Luch1 )
            {
               str.sprintf("%4.2f", u);
               StaticText53->Caption = str;
               DiagRif->U = u;
            }
            else
            {
               str = "ВЫКЛ";
               StaticText53->Caption = str;
               DiagRif->U = 0.0;
            }

            str.sprintf("%4.2f", u2);
            StaticText54->Caption = str;
            DiagRif->U2 = u2;
         }
         else
         {
            if( status != DiagRif->Status )
            {
               ResetDiagInfo(9);
            }
         }
         DiagRif->Status = status;
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagRifInfo2( int type, int status, int sb, double u, double u2, double u3, int d1, int d2, int sb2 )
{
   AnsiString str;
   if( DiagRif->Adr == 0 )
   {
      ResetDiagInfo(type);
   }
   else
   {
      if( type == 5 )
      {
         if( status != 10 )
         {
            bool Sdk = false; 
            bool Dk = false;  
            bool T = false;   
            bool Ts = false;  
            bool Ts1 = false; 
            bool Ts2 = false; 
            bool Ts3 = false; 
            bool St = false;  

            if( (sb&0x01) == 0x01 ) Sdk = true;
            if( (sb&0x02) == 0x02 ) Ts = true;
            if( (sb&0x04) == 0x04 ) St = true;
            if( (sb&0x08) == 0x08 ) T = true;
            if( (sb&0x10) == 0x10 ) Ts2 = true;
            if( (sb&0x20) == 0x20 ) Dk = true;
            if( (sb&0x40) == 0x40 ) Ts3 = true;
            if( (sb&0x80) == 0x80 ) Ts1 = true;

            bool T1 = false;  
            bool T2 = false;  
            bool T3 = false;  

            int porogi3 = d1 & 0x0F;
            int porogi2 = (d1 & 0xF0)>>4;
            int porogi1 = d2 & 0x0F;

            if( (sb2&0x10) == 0x10 ) T2 = true;
            if( (sb2&0x40) == 0x40 ) T3 = true;
            if( (sb2&0x80) == 0x80 ) T1 = true;

//            if( Sdk != DiagRif->Sdk )
            {
               if( !Sdk )
               {
                  Image3->Picture->Bitmap = I2Img;
                  StaticText4->Caption = "НЕТ";
               }
               else
               {
                  Image3->Picture->Bitmap = I5Img;
                  StaticText4->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Sdk = Sdk;

            if( Ts != DiagRif->Ts || status != DiagRif->Status )
            {
               if( !Ts )
               {
                  Image6->Picture->Bitmap = I2Img;
                  StaticText7->Caption = "НЕТ";
               }
               else
               {
                  Image6->Picture->Bitmap = I5Img;
                  StaticText7->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts = Ts;

            if( St != DiagRif->St || status != DiagRif->Status )
            {
               if( !St )
               {
                  Image5->Picture->Bitmap = I7Img;
                  StaticText6->Caption = "НЕТ";
               }
               else
               {
                  Image5->Picture->Bitmap = I8Img;
                  StaticText6->Caption = "ЕСТЬ";
               }
            }
            DiagRif->St = St;

            if( T != DiagRif->T || status != DiagRif->Status )
            {
               if( !T )
               {
                  Image4->Picture->Bitmap = I2Img;
                  StaticText5->Caption = "НЕТ";
               }
               else
               {
                  Image4->Picture->Bitmap = I5Img;
                  StaticText5->Caption = "ЕСТЬ";
               }
            }
            DiagRif->T = T;

            if( Dk != DiagRif->Dk || status != DiagRif->Status )
            {
               if( !Dk )
               {
                  Image2->Picture->Bitmap = I2Img;
                  StaticText3->Caption = "НЕТ";
               }
               else
               {
                  Image2->Picture->Bitmap = I4Img;
                  StaticText3->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Dk = Dk;

            if( Ts1 != DiagRif->Ts1 || status != DiagRif->Status )
            {
               if( !Ts1 )
               {
                  Image55->Picture->Bitmap = I2Img;
                  StaticText55->Caption = "НЕТ";
               }
               else
               {
                  Image55->Picture->Bitmap = I5Img;
                  StaticText55->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts1 = Ts1;

            if( Ts2 != DiagRif->Ts2 || status != DiagRif->Status )
            {
               if( !Ts2 )
               {
                  Image56->Picture->Bitmap = I2Img;
                  StaticText56->Caption = "НЕТ";
               }
               else
               {
                  Image56->Picture->Bitmap = I5Img;
                  StaticText56->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts2 = Ts2;

            if( Ts3 != DiagRif->Ts3 || status != DiagRif->Status )
            {
               if( !Ts3 )
               {
                  Image57->Picture->Bitmap = I2Img;
                  StaticText57->Caption = "НЕТ";
               }
               else
               {
                  Image57->Picture->Bitmap = I5Img;
                  StaticText57->Caption = "ЕСТЬ";
               }
            }
            DiagRif->Ts3 = Ts3;

            if( !T1 )
            {
               Image59->Picture->Bitmap = I2Img;
               StaticText59->Caption = "НЕТ";
            }
            else
            {
               Image59->Picture->Bitmap = I5Img;
               StaticText59->Caption = "ЕСТЬ";
            }
            if( !T2 )
            {
               Image60->Picture->Bitmap = I2Img;
               StaticText60->Caption = "НЕТ";
            }
            else
            {
               Image60->Picture->Bitmap = I5Img;
               StaticText60->Caption = "ЕСТЬ";
            }
            if( !T3 )
            {
               Image61->Picture->Bitmap = I2Img;
               StaticText61->Caption = "НЕТ";
            }
            else
            {
               Image61->Picture->Bitmap = I5Img;
               StaticText61->Caption = "ЕСТЬ";
            }

            if( porogi1 == 9 )
            {
//               Image69->Picture->Bitmap = I2Img;
               StaticText69->Caption = "ВЫКЛ";
            }
            else
            {
//               Image69->Picture->Bitmap = I5Img;
               StaticText69->Caption = "ВКЛ";
            }
            if( porogi2 == 9 )
            {
//               Image69->Picture->Bitmap = I2Img;
               StaticText70->Caption = "ВЫКЛ";
            }
            else
            {
//               Image69->Picture->Bitmap = I5Img;
               StaticText70->Caption = "ВКЛ";
            }
            if( porogi3 == 9 )
            {
//               Image69->Picture->Bitmap = I2Img;
               StaticText71->Caption = "ВЫКЛ";
            }
            else
            {
//               Image69->Picture->Bitmap = I5Img;
               StaticText71->Caption = "ВКЛ";
            }

            str.sprintf("%4.2f", u);
            StaticText52->Caption = str;
            DiagRif->U = u;

            str.sprintf("%4.2f", u2);
            StaticText53->Caption = str;
            DiagRif->U2 = u2;

            str.sprintf("%4.2f", u3);
            StaticText54->Caption = str;
            DiagRif->U3 = u3;
         }
         else
         {
            if( status != DiagRif->Status )
            {
               ResetDiagInfo(91 );
            }
         }
         DiagRif->Status = status;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::BitBtn1Click(TObject *Sender)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3 - 1;

   if( POprosObj(ObjTree->Selected->Data)->Type == 1 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            ComboBox1->ItemIndex = 16 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi;
            ComboBox2->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim+1;
            ComboBox5->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Takt+1;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            ComboBox1->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi+1;
            ComboBox2->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim+1;
            ComboBox5->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Takt+1;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 8 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            ComboBox1->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi1;
            ComboBox2->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi2;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 9 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            ComboBox1->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi1;
            ComboBox6->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi2;
            ComboBox2->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim1+1;
            ComboBox7->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim2+1;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 91 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            ComboBox1->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi1;
            ComboBox2->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi2;
            ComboBox6->ItemIndex = 10 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi3;
            ComboBox7->ItemIndex = 8 - RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 10 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)  )
         {
            RifTimer[kn]->Enabled = false;

            MyDelay(RifTimerInterval[kn]);

            int flag = 0;
            int packet[1000];
            int temp = 0, t1 = 0;
            int adress = POprosObj(ObjTree->Selected->Data)->Num1;

            for( int i = 0; i < 5; i++ )
            {
               flag = RifSerial[kn].SetCmd2( adress, 0x2C, true );
               MyDelay(RifTimerInterval[kn]*TochkaMux);
               flag = RifSerial[kn].GetPaket( adress, packet );
               if( flag == 1 && packet[4] == 0x34 ) break;
            }

            RifTimer[kn]->Enabled = true;

            if( flag == 1 && packet[4] == 0x34 )
            {
               temp = 0;
               t1 = 0;
               temp = packet[5]&0xFF;
               t1 = temp&4;
               if( t1 == 4 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][0] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][0] = 0;

               t1 = temp&8;
               if( t1 == 8 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][1] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][1] = 0;

               t1 = temp&16;
               if( t1 == 16 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][2] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[0][2] = 0;

               temp = (packet[6]&0xFF)<<8;
               temp = temp + (packet[7]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][0] = temp;

               temp = (packet[8]&0xFF)<<8;
               temp = temp + (packet[9]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][1] = temp;

               temp = (packet[10]&0xFF)<<8;
               temp = temp + (packet[11]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][2] = temp;

               temp = 0;
               t1 = 0;
               temp = packet[12]&0xFF;
               t1 = temp&4;
               if( t1 == 4 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][0] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][0] = 0;

               t1 = temp&8;
               if( t1 == 8 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][1] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][1] = 0;

               t1 = temp&16;
               if( t1 == 16 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][2] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[1][2] = 0;

               temp = (packet[13]&0xFF)<<8;
               temp = temp + (packet[14]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][0] = temp;

               temp = (packet[15]&0xFF)<<8;
               temp = temp + (packet[16]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][1] = temp;

               temp = (packet[17]&0xFF)<<8;
               temp = temp + (packet[18]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][2] = temp;

               temp = 0;
               t1 = 0;
               temp = packet[19]&0xFF;
               t1 = temp&4;
               if( t1 == 4 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][0] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][0] = 0;

               t1 = temp&8;
               if( t1 == 8 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][1] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][1] = 0;

               t1 = temp&16;
               if( t1 == 16 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][2] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[2][2] = 0;

               temp = (packet[20]&0xFF)<<8;
               temp = temp + (packet[21]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][0] = temp;

               temp = (packet[22]&0xFF)<<8;
               temp = temp + (packet[23]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][1] = temp;

               temp = (packet[24]&0xFF)<<8;
               temp = temp + (packet[25]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][2] = temp;

               temp = 0;
               t1 = 0;
               temp = packet[26]&0xFF;
               t1 = temp&4;
               if( t1 == 4 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][0] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][0] = 0;

               t1 = temp&8;
               if( t1 == 8 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][1] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][1] = 0;

               t1 = temp&16;
               if( t1 == 16 ) RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][2] = 1;
               else RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[3][2] = 0;

               temp = (packet[27]&0xFF)<<8;
               temp = temp + (packet[28]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][0] = temp;

               temp = (packet[29]&0xFF)<<8;
               temp = temp + (packet[30]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][1] = temp;

               temp = (packet[31]&0xFF)<<8;
               temp = temp + (packet[32]&0xFF);
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][2] = temp;

               ShowTochkaSettings();
            }
            else
            {
               ShowSetupInfo(POprosObj(ObjTree->Selected->Data)->Type);
               MessageBox (NULL,"Ошибка чтения параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)  )
         {
            RifTimer[kn]->Enabled = false;

            MyDelay(RifTimerInterval[kn]);

            int flag = 0;
            int packet2[1000];
            int temp = 0, t1 = 0;
            int adress = POprosObj(ObjTree->Selected->Data)->Num1;
            int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
            int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100;
            if( uchnum == 1 || uchnum == 2 ) uchnum = 0;
            else if( uchnum == 3 || uchnum == 4 ) uchnum = 1;
            uchnum = uchnum<<7;
            ddnum = uchnum + ddnum;

            RifSerial[kn].GetPaket( adress, packet2 );

            for( int i = 0; i < 5; i++ )
            {
               flag = RifSerial[kn].SetCmd4( adress, 0x2C, ddnum+1, true );
               MyDelay(1000);
               flag = RifSerial[kn].GetPaket( adress, packet2 );
               if( flag == 1 && packet2[4] == 0x34 ) break;
            }

            RifTimer[kn]->Enabled = true;

            if( flag == 1 && packet2[4] == 0x34 )
            {
               temp = 0;
               temp = packet2[6]&0x80;
               if( temp == 0x80 ) ComboBox1->ItemIndex = 1;
               else ComboBox1->ItemIndex = 0;

               temp = 0;
               temp = packet2[6]&0x40;
               if( temp == 0x40 ) ComboBox2->ItemIndex = 1;
               else ComboBox2->ItemIndex = 0;

               temp = 0;
               temp = packet2[6]&0x0F;
               ComboBox31->ItemIndex = temp;

               temp = 0;
               temp = packet2[7]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[8]&0xFF;
               temp = temp + t1;
               CSpinEdit4->Value = temp;

               temp = 0;
               temp = packet2[9]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[10]&0xFF;
               temp = temp + t1;
               CSpinEdit5->Value = temp;

               temp = 0;
               temp = packet2[11]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox21->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[12]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox22->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[13]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox23->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[14]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox24->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[15]&0xFF;
               CSpinEdit6->Value = temp;

               temp = 0;
               temp = packet2[16]&0xFF;
               CSpinEdit7->Value = temp;

               temp = 0;
               temp = packet2[17]&0x80;
               if( temp == 0x80 ) ComboBox25->ItemIndex = 1;
               else ComboBox25->ItemIndex = 0;

               temp = 0;
               temp = packet2[17]&0x40;
               if( temp == 0x40 ) ComboBox26->ItemIndex = 1;
               else ComboBox2->ItemIndex = 0;

               temp = 0;
               temp = packet2[17]&0x0F;
               ComboBox32->ItemIndex = temp;

               temp = 0;
               temp = packet2[18]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[19]&0xFF;
               temp = temp + t1;
               CSpinEdit8->Value = temp;

               temp = 0;
               temp = packet2[20]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[21]&0xFF;
               temp = temp + t1;
               CSpinEdit9->Value = temp;

               temp = 0;
               temp = packet2[22]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox27->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[23]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox28->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[24]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox29->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[25]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox30->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[26]&0xFF;
               CSpinEdit10->Value = temp;

               temp = 0;
               temp = packet2[27]&0xFF;
               CSpinEdit11->Value = temp;
            }
            else
            {
               ShowSetupInfo(POprosObj(ObjTree->Selected->Data)->Type);
               MessageBox (NULL,"Параметры датчика не прочитаны. Повторите процедуру чтения параметров","Ошибка",MB_OK|MB_ICONERROR);
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)  )
         {
            RifTimer[kn]->Enabled = false;

            MyDelay(RifTimerInterval[kn]);

            int flag = 0;
            int packet2[1000];
            int temp = 0, t1 = 0;
            int adress = POprosObj(ObjTree->Selected->Data)->Num1;
            int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
            int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100;
            if( uchnum == 1 || uchnum == 2 ) uchnum = 0;
            else if( uchnum == 3 || uchnum == 4 ) uchnum = 1;
            uchnum = uchnum<<7;
            ddnum = uchnum + ddnum;

            RifSerial[kn].GetPaket( adress, packet2 );
            for( int i = 0; i < 5; i++ )
            {
               flag = RifSerial[kn].SetCmd4( adress, 0x2C, ddnum+1, true );
               MyDelay(1000);
               flag = RifSerial[kn].GetPaket( adress, packet2 );
               if( flag == 1 && packet2[4] == 0x34 ) break;
            }

            if( flag == 1 && packet2[4] == 0x34 )
            {
               temp = 0;
               temp = packet2[6]&0x80;
               if( temp == 0x80 ) ComboBox1->ItemIndex = 1;
               else ComboBox1->ItemIndex = 0;

               temp = 0;
               temp = packet2[6]&0x40;
               if( temp == 0x40 ) ComboBox2->ItemIndex = 1;
               else ComboBox2->ItemIndex = 0;

               temp = 0;
               temp = packet2[7]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[8]&0xFF;
               temp = temp + t1;
               CSpinEdit4->Value = temp;

               temp = 0;
               temp = packet2[9]&0xFF;
               temp = temp<<8;

               t1 = 0;
               t1 = packet2[10]&0xFF;
               temp = temp + t1;
               CSpinEdit5->Value = temp;

               temp = 0;
               temp = packet2[11]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox21->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[12]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox22->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[13]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox23->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[14]&0xFF;
               if( temp < 1 ) temp = 1;
               ComboBox24->ItemIndex = temp-1;

               temp = 0;
               temp = packet2[15]&0xFF;
               CSpinEdit6->Value = temp;

               temp = 0;
               temp = packet2[16]&0xFF;
               CSpinEdit7->Value = temp;
            }
            else
            {
               ShowSetupInfo(POprosObj(ObjTree->Selected->Data)->Type);
               MessageBox (NULL,"Параметры датчика не прочитаны. Повторите процедуру чтения параметров","Ошибка",MB_OK|MB_ICONERROR);
            }

            RifTimer[kn]->Enabled = true;
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowTochkaSettings2(int ch)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3 - 1;
   {
      AnsiString str;

      if( ch == 1 || ch == 2 )
      {
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][0] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][0]);
          }
          AdvStringGrid1->Cells[5][8]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][0],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][8]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][1] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][1]);
          }
          AdvStringGrid1->Cells[5][9]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][1],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][9]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][2] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][2]);
          }
          AdvStringGrid1->Cells[5][10]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[0][2],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][10]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][0] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][0]);
          }
          AdvStringGrid1->Cells[5][12]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][0],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][12]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][1] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][1]);
          }
          AdvStringGrid1->Cells[5][13]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][1],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][13]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][2] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][2]);
          }
          AdvStringGrid1->Cells[5][14]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[1][2],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][14]=str;
*/
      }
      else
      {
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][0] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][0]);
          }
          AdvStringGrid1->Cells[5][8]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][0],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][8]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][1] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][1]);
          }
          AdvStringGrid1->Cells[5][9]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][1],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][9]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][2] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][2]);
          }
          AdvStringGrid1->Cells[5][10]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[2][2],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][10]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][0] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][0]);
          }
          AdvStringGrid1->Cells[5][12]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][0],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][12]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][1] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][1]);
          }
          AdvStringGrid1->Cells[5][13]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][1],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][13]=str;
*/

          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][2] != -1 )
          {
             str.sprintf("%d", RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][2]);
          }
          AdvStringGrid1->Cells[5][14]=str;

/*
          str = "";
          if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef != -1 )
          {
             t = CalcRealPorog(RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[3][2],
                               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tempKoef);
             str.sprintf("%03d", t);
          }
          AdvStringGrid1->Cells[7][14]=str;
*/
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowTochkaSettings()
{
   int idx = ComboBox1->ItemIndex;
   idx = POprosObj(ObjTree->Selected->Data)->Num2-1;

   int kn =  POprosObj(ObjTree->Selected->Data)->Num3 - 1;
//   {
      CheckBox1->Checked = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[idx][0];
      CheckBox2->Checked = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[idx][1];
      CheckBox3->Checked = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].tF[idx][2];
//      ComboBox18->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][0]-1;
//      ComboBox19->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][1]-1;
//      ComboBox20->ItemIndex = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][2]-1;
      CSpinEdit1->Value = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][0];
      CSpinEdit2->Value = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][1];
      CSpinEdit3->Value = RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].nominPorog[idx][2];

      Label11->Visible = true;
      ComboBox1->Visible = true;
      CheckBox1->Visible = true;
      CheckBox2->Visible = true;
      CheckBox3->Visible = true;
//      ComboBox18->Visible = true;
//      ComboBox19->Visible = true;
//      ComboBox20->Visible = true;
      CSpinEdit1->Visible = true;
      CSpinEdit2->Visible = true;
      CSpinEdit3->Visible = true;
//   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::BitBtn2Click(TObject *Sender)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3 - 1;

   if( POprosObj(ObjTree->Selected->Data)->Type == 1 || POprosObj(ObjTree->Selected->Data)->Type == 8 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            if( ComboBox1->ItemIndex == 0 || ComboBox2->ItemIndex == 0 )
            {
               MessageBox (NULL,"Не заданы новые значения!","Ошибка",MB_OK|MB_ICONERROR);
            }
            else
            {
               Porogi = 16 - ComboBox1->ItemIndex;

               Rezhim = ComboBox2->ItemIndex-1;
               Takt = ComboBox5->ItemIndex-1;

               RifTimer[kn]->Enabled = false;
               MyDelay(RifTimerInterval[kn]);

               int flag = 0;
               int packet[1000];
               int adress = POprosObj(ObjTree->Selected->Data)->Num1;

               for( int i = 0; i < 5; i++ )
               {
                  flag = RifSerial[kn].SetCfg( adress, Porogi, Rezhim, Takt, true );
                  MyDelay(RifTimerInterval[kn]);
                  flag = RifSerial[kn].GetPaket( adress, packet );
                  if( flag == 1 && packet[4] == 0x30 ) break;
               }

               if( flag == 1 && packet[4] == 0x30 )
               {
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim = Rezhim;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi = Porogi;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Takt = Takt;
               }

               MyDelay(RifTimerInterval[kn]);
               RifTimer[kn]->Enabled = true;

               if( flag == 1 && packet[4] == 0x30 )
               {
                  SetSob( 134,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  MessageBox (NULL,"Параметры датчика записаны успешно!","Инфо",MB_OK|MB_ICONINFORMATION);
               }
               else MessageBox (NULL,"Ошибка записи параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            if( ComboBox1->ItemIndex == 0 || ComboBox2->ItemIndex == 0 || ComboBox5->ItemIndex == 0 )
            {
               MessageBox (NULL,"Не заданы новые значения!","Ошибка",MB_OK|MB_ICONERROR);
            }
            else
            {
               Porogi = ComboBox1->ItemIndex-1;
               Rezhim = ComboBox2->ItemIndex-1;
               Takt = ComboBox5->ItemIndex-1;

               RifTimer[kn]->Enabled = false;
               MyDelay(RifTimerInterval[kn]);

               int flag = 0;
               int packet[1000];
               int adress = POprosObj(ObjTree->Selected->Data)->Num1;

               for( int i = 0; i < 5; i++ )
               {
                  flag = RifSerial[kn].SetCfg6( adress, Porogi, Rezhim, Takt, true );
                  MyDelay(RifTimerInterval[kn]);
                  flag = RifSerial[kn].GetPaket( adress, packet );
                  if( flag == 1 && packet[4] == 0x30 ) break;
               }

               if( flag == 1 && packet[4] == 0x30 )
               {
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Rezhim = Rezhim;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Porogi = Porogi;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Takt = Takt;
               }

               MyDelay(RifTimerInterval[kn]);
               RifTimer[kn]->Enabled = true;

               if( flag == 1 && packet[4] == 0x30 )
               {
                  SetSob( 134,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  MessageBox (NULL,"Параметры датчика записаны успешно!","Инфо",MB_OK|MB_ICONINFORMATION);
               }
               else MessageBox (NULL,"Ошибка записи параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 9 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            if( ComboBox1->ItemIndex == 0 || ComboBox2->ItemIndex == 0 || ComboBox6->ItemIndex == 0 )
            {
               MessageBox (NULL,"Не заданы новые значения!","Ошибка",MB_OK|MB_ICONERROR);
            }
            else
            {
               int n1 = POprosObj(ObjTree->Selected->Data)->Num1;
               n1 = n1%2;
               if( n1 == 0 && ComboBox2->ItemIndex == 2 )
               {
                  MessageBox (NULL,"\"Чужой\" луч нельзя отключить на датчиках с четными адресами!","Ошибка",MB_OK|MB_ICONERROR);
               }
               else
               {
                  SetSob( 134,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  Porogi1 = 10 - ComboBox1->ItemIndex;
                  Porogi2 = 10 - ComboBox6->ItemIndex;
                  Rezhim = ComboBox2->ItemIndex-1;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x2F;
                  RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
               }
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 91 )
   {
      if( RifPortNum[kn] != 0 )
      {
         if( (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] > 0) &&
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 10)&&
              (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] != 30) ||
             (RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 100) )
         {
            if( ComboBox1->ItemIndex == 0 || ComboBox2->ItemIndex == 0 || ComboBox6->ItemIndex == 0 || ComboBox7->ItemIndex == 0 )
            {
               MessageBox (NULL,"Не заданы новые значения!","Ошибка",MB_OK|MB_ICONERROR);
            }
            else
            {
               SetSob( 134,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

               Porogi1 = 10 - ComboBox1->ItemIndex;
               Porogi2 = 10 - ComboBox2->ItemIndex;
               Porogi3 = 10 - ComboBox6->ItemIndex;
               Rezhim = 8 - ComboBox7->ItemIndex;
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x20;
               RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
            }
         }
         else MessageBox (NULL,"Нельзя выполнить операцию. Отсутствует связь с датчиком!","Ошибка",MB_OK|MB_ICONERROR);
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 10 )
   {
      int tF[3] = {0,0,0};
      int num = ComboBox1->ItemIndex;

//      if( !POprosObj(ObjTree->Selected->Data)->Bazalt )
//      {
//         if( POprosObj(ObjTree->Selected->Data)->Num2 == 2 ) num = num + 2;
//      }
//      else num = POprosObj(ObjTree->Selected->Data)->Num2 - 1;
      num = POprosObj(ObjTree->Selected->Data)->Num2 - 1;

      int tSettings[4] = {0, 0, 0, 0};

      if( RifPortNum[kn] != 0 )
      {
         tF[0] = CheckBox1->Checked;
         tF[1] = CheckBox2->Checked;
         tF[2] = CheckBox3->Checked;

         tSettings[0] = num | (tF[0]<<2) | (tF[1]<<3) | (tF[2]<<4);

         tSettings[1] = CSpinEdit1->Value;
         tSettings[2] = CSpinEdit2->Value;
         tSettings[3] = CSpinEdit3->Value;

         RifTimer[kn]->Enabled = false;
         MyDelay(RifTimerInterval[kn]);

         int flag = 0;
         int packet[1000];
         int adress = POprosObj(ObjTree->Selected->Data)->Num1;

         for( int i = 0; i < 5; i++ )
         {
            flag = RifSerial[kn].SetCfg5( adress, tSettings, true );
            MyDelay(RifTimerInterval[kn]*TochkaMux);
            flag = RifSerial[kn].GetPaket( adress, packet );
            if( flag == 1 && packet[4] == 0x30 ) break;
         }

         MyDelay(2000); 
         RifTimer[kn]->Enabled = true;

         if( flag == 1 && packet[4] == 0x30 )
         {
            SetSob( 134,
                    POprosObj(ObjTree->Selected->Data)->Type,
                    POprosObj(ObjTree->Selected->Data)->Num1,
                    POprosObj(ObjTree->Selected->Data)->Num2,
                    POprosObj(ObjTree->Selected->Data)->Num3,
                    POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            MessageBox (NULL,"Параметры датчика записаны успешно!","Инфо",MB_OK|MB_ICONINFORMATION);
         }
         else MessageBox (NULL,"Ошибка записи параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
      }

      BitBtn1Click(this);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx )
   {
      if( RifPortNum[kn] != 0 )
      {
         RifTimer[kn]->Enabled = false;
         MyDelay(RifTimerInterval[kn]*2);

         int flag = 0;
         int packet[1000];
         int adress = POprosObj(ObjTree->Selected->Data)->Num1;
         int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
         int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100;
         if( uchnum == 1 || uchnum == 2 ) uchnum = 0;
         else if( uchnum == 3 || uchnum == 4 ) uchnum = 1;
         uchnum = uchnum<<7;
         ddnum = uchnum + ddnum;

         int f12_che1 = 0;
         int por_f1che1 = 0;
         int por_f2che1 = 0;
         int tv_f1che1 = 0;
         int tv_f2che1 = 0;
         int cnt_f1che1 = 0;
         int cnt_f2che1 = 0;
         int tp_f1che1 = 0;
         int tp_f2che1 = 0;
         int f12_che2 = 0;
         int por_f1che2 = 0;
         int por_f2che2 = 0;
         int tv_f1che2 = 0;
         int tv_f2che2 = 0;
         int cnt_f1che2 = 0;
         int cnt_f2che2 = 0;
         int tp_f1che2 = 0;
         int tp_f2che2 = 0;

         if( ComboBox1->ItemIndex == 1 ) f12_che1 += 0x80;
         if( ComboBox2->ItemIndex == 1 ) f12_che1 += 0x40;

         f12_che1 += ComboBox31->ItemIndex;

         por_f1che1 = CSpinEdit4->Value;
         por_f2che1 = CSpinEdit5->Value;

         tv_f1che1 = ComboBox21->ItemIndex + 1;
         tv_f2che1 = ComboBox22->ItemIndex + 1;

         cnt_f1che1 = ComboBox23->ItemIndex + 1;
         cnt_f2che1 = ComboBox24->ItemIndex + 1;

         tp_f1che1 = CSpinEdit6->Value;
         tp_f2che1 = CSpinEdit7->Value;

         if( ComboBox25->ItemIndex == 1 ) f12_che2 += 0x80;
         if( ComboBox26->ItemIndex == 1 ) f12_che2 += 0x40;

         f12_che2 += ComboBox32->ItemIndex;

         por_f1che2 = CSpinEdit8->Value;
         por_f2che2 = CSpinEdit9->Value;

         tv_f1che2 = ComboBox27->ItemIndex + 1;
         tv_f2che2 = ComboBox28->ItemIndex + 1;

         cnt_f1che2 = ComboBox29->ItemIndex + 1;
         cnt_f2che2 = ComboBox30->ItemIndex + 1;

         tp_f1che2 = CSpinEdit10->Value;
         tp_f2che2 = CSpinEdit11->Value;

         RifSerial[kn].GetPaket( adress, packet );
         for( int i = 0; i < 5; i++ )
         {
            flag = RifSerial[kn].SetCfg7( adress, ddnum+1,
                                          f12_che1, por_f1che1, por_f2che1, tv_f1che1, tv_f2che1, cnt_f1che1, cnt_f2che1, tp_f1che1, tp_f2che1,
                                          f12_che2, por_f1che2, por_f2che2, tv_f1che2, tv_f2che2, cnt_f1che2, cnt_f2che2, tp_f1che2, tp_f2che2, true );
            MyDelay(1000);
            flag = RifSerial[kn].GetPaket( adress, packet );
            if( flag == 1 && packet[4] == 0x30 ) break;
         }

         MyDelay(2000);
         RifTimer[kn]->Enabled = true;

         if( flag == 1 && packet[4] == 0x30 )
         {
            SetSob( 134,
                    POprosObj(ObjTree->Selected->Data)->Type,
                    POprosObj(ObjTree->Selected->Data)->Num1,
                    POprosObj(ObjTree->Selected->Data)->Num2,
                    POprosObj(ObjTree->Selected->Data)->Num3,
                    POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            MessageBox (NULL,"Параметры датчика записаны успешно!","Инфо",MB_OK|MB_ICONINFORMATION);
         }
         else MessageBox (NULL,"Ошибка записи параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
      }

      BitBtn1Click(this);
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
   {
      if( RifPortNum[kn] != 0 )
      {
         RifTimer[kn]->Enabled = false;
         MyDelay(RifTimerInterval[kn]*2);

         int flag = 0;
         int packet[1000];
         int adress = POprosObj(ObjTree->Selected->Data)->Num1;
         int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
         int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100;
         if( uchnum == 1 || uchnum == 2 ) uchnum = 0;
         else if( uchnum == 3 || uchnum == 4 ) uchnum = 1;
         uchnum = uchnum<<7;
         ddnum = uchnum + ddnum;

         int f12_che1 = 0;
         int por_f1che1 = 0;
         int por_f2che1 = 0;
         int tv_f1che1 = 0;
         int tv_f2che1 = 0;
         int cnt_f1che1 = 0;
         int cnt_f2che1 = 0;
         int tp_f1che1 = 0;
         int tp_f2che1 = 0;

         if( ComboBox1->ItemIndex == 1 ) f12_che1 += 0x80;
         if( ComboBox2->ItemIndex == 1 ) f12_che1 += 0x40;

         por_f1che1 = CSpinEdit4->Value;
         por_f2che1 = CSpinEdit5->Value;

         tv_f1che1 = ComboBox21->ItemIndex + 1;
         tv_f2che1 = ComboBox22->ItemIndex + 1;

         cnt_f1che1 = ComboBox23->ItemIndex + 1;
         cnt_f2che1 = ComboBox24->ItemIndex + 1;

         tp_f1che1 = CSpinEdit6->Value;
         tp_f2che1 = CSpinEdit7->Value;

         RifSerial[kn].GetPaket( adress, packet );
         for( int i = 0; i < 5; i++ )
         {
            flag = RifSerial[kn].SetCfg9( adress, ddnum+1,
                                          f12_che1, por_f1che1, por_f2che1, tv_f1che1, tv_f2che1, cnt_f1che1, cnt_f2che1, tp_f1che1, tp_f2che1, true );
            MyDelay(1000);
            flag = RifSerial[kn].GetPaket( adress, packet );
            if( flag == 1 && packet[4] == 0x30 ) break;
         }

         MyDelay(2000);
         RifTimer[kn]->Enabled = true;

         if( flag == 1 && packet[4] == 0x30 )
         {
            SetSob( 134,
                    POprosObj(ObjTree->Selected->Data)->Type,
                    POprosObj(ObjTree->Selected->Data)->Num1,
                    POprosObj(ObjTree->Selected->Data)->Num2,
                    POprosObj(ObjTree->Selected->Data)->Num3,
                    POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            MessageBox (NULL,"Параметры датчика записаны успешно!","Инфо",MB_OK|MB_ICONINFORMATION);
         }
         else MessageBox (NULL,"Ошибка записи параметров датчика!","Ошибка",MB_OK|MB_ICONERROR);
      }

      BitBtn1Click(this);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ControlItemClick(TObject *Sender)
{
   Control_Dev(false);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::RifsDkItemClick(TObject *Sender)
{

   SetSob( 133,
           0,
           0,
           0,
           0,
           "РИФ-РЛМ(КРЛ), Трасса-1л", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   for( int i = 0; i < RifDevCnt; i++ )
   {
      if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[0] == 1 && RifPortNum[kn]!= 0 )
      {
         if( RifSys->Rk[kn][i].Type == 0 && RifSys->Rk[kn][i].Cmd == 0x22 )
         {
            RifSys->Rk[kn][i].Cmd = 0x21;
            RifSys->Rk[kn][i].CmdCnt = 0;
            RifSys->Rk[kn][i].AutoDk = false;
            RifSys->Rk[kn][i].AutoDkCnt = 0;
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SoundResetItemClick(TObject *Sender)
{
   ToolButton1->Down = true;
   SoundFlag = 0;
   PlaySound(0,0, SND_PURGE);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SoundTimerTimer(TObject *Sender)
{
   if( SoundFlag == 1 )
   {
      if( SoundType == 0 ) 
      {
         if( !SoundStop ) PlaySound(SoundFilePath.c_str(), 0, SND_ASYNC|SND_LOOP|SND_NOSTOP);
      }
      else if( SoundType == 1 ) Beep(1000,200);
   }
   else if( SoundFlag == 2 )
   {
      if( SoundType == 0 ) 
      {
         if( !SoundStop ) PlaySound(SoundFilePath2.c_str(), 0, SND_ASYNC|SND_LOOP|SND_NOSTOP);
      }
      else if( SoundType == 1 ) Beep(100,200);
   }
   else if( SoundFlag == 3 )
   {
      if( SoundType == 0 )
      {
         if( !SoundStop ) PlaySound(SoundFilePath3.c_str(), 0, SND_ASYNC|SND_LOOP|SND_NOSTOP);
      }
      else if( SoundType == 1 ) Beep(100,200);
   }

   if( ToolButton1->Down ) ToolButton1->Down = false;
   if( ToolButton2->Down ) ToolButton2->Down = false;

   if( POutObj(lpMapOpros)->AlarmResetFlag )
   {
      POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
   }

   if( UseAsoosd )
   {
      bool fl = false;
      for( int i = 0; i < 100; i++ )
      {
         if( Asoosd_str[i].Length() > 0 )
         {
            fl = true;
            break;
         }
      }

      if( fl )
      {
         if( !AsoosdClientSocket->Active ) AsoosdClientSocket->Active = true;
      }
   }

   if( AutoDbStart )
   {
      TDateTime dt = Now();
      if( dt > AutoDbStartDt )
      {
         AutoDbStartDt = Date();
         AutoDbStartDt = IncDay(AutoDbStartDt, 1);
         AutoDbStartDt = AutoDbStartDt + EncodeTime(AutoDbStartHour, AutoDbStartMinute, 0, 0);

         DbStart(false, true);
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Control_pdiClick(TObject *Sender)
{
   ControlItemClick(this);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DBGrid1DrawColumnCell(TObject *Sender,
      const TRect &Rect, int DataCol, TColumn *Column,
      TGridDrawState State)
{
   if( State.Contains(gdSelected) || DBGrid1->SelectedRows->CurrentRowSelected )
   {
      DBGrid1->Canvas->Brush->Color=clSkyBlue;
      DBGrid1->Canvas->Font->Color=clWindowText;
//      if( !Table1Flag->AsBoolean && !Table1->IsEmpty() &&
//          Table1Type->AsInteger > 10 ) DBGrid1->Canvas->Font->Color=clRed;
      DBGrid1->Canvas->FillRect(Rect);
      DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
   }

   if( !Table1Flag->AsBoolean && !Table1->IsEmpty() )
   {
      if( Table1Type->AsInteger >= 20 && Table1Type->AsInteger < 30 ||
          Table1Type->AsInteger == 145 || Table1Type->AsInteger == 904 ||
          Table1Type->AsInteger == 905 || Table1Type->AsInteger == 1007 )
      {
         DBGrid1->Canvas->Font->Color=clRed;
         DBGrid1->Canvas->FillRect(Rect);
         DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
      }
      else if( Table1Type->AsInteger > 200 && Table1Type->AsInteger < 300 )
      {
         DBGrid1->Canvas->Font->Color=clRed;
         DBGrid1->Canvas->FillRect(Rect);
         DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
      }
      else if(  Table1Type->AsInteger == 5 ||
                Table1Type->AsInteger == 3 ||
                Table1Type->AsInteger == 4 ||
                Table1Type->AsInteger == 130 ||
                Table1Type->AsInteger == 131 ||
                Table1Type->AsInteger == 133 ||
                Table1Type->AsInteger == 134 ||
                Table1Type->AsInteger == 135 ||
                Table1Type->AsInteger == 136 ||
                Table1Type->AsInteger == 137 ||
                Table1Type->AsInteger == 138 ||
                Table1Type->AsInteger == 140 ||
                Table1Type->AsInteger == 141 ||
                Table1Type->AsInteger == 142 ||
                Table1Type->AsInteger == 143 ||
                Table1Type->AsInteger == 144 ||
                Table1Type->AsInteger == 146 ||
                Table1Type->AsInteger == 150 ||
                Table1Type->AsInteger == 151 ||
                Table1Type->AsInteger == 160 ||
                Table1Type->AsInteger == 161 ||
                Table1Type->AsInteger == 170 ||
                Table1Type->AsInteger == 171 ||
                Table1Type->AsInteger == 172 ||
                Table1Type->AsInteger == 173 ||
                Table1Type->AsInteger == 174 ||
                Table1Type->AsInteger == 175 ||
                Table1Type->AsInteger == 900 ||
                Table1Type->AsInteger == 901 ||
                Table1Type->AsInteger == 903 ||
                Table1Type->AsInteger == 906 ||
                Table1Type->AsInteger == 1000 ||
                Table1Type->AsInteger == 1001 ||
                Table1Type->AsInteger == 1002 ||
                Table1Type->AsInteger == 1003 ||
                Table1Type->AsInteger == 1004 ||
                Table1Type->AsInteger == 1005 ||
                Table1Type->AsInteger == 1005 ||
                Table1Type->AsInteger == 1006 ||
                Table1Type->AsInteger == 1133 ||
                Table1Type->AsInteger == 1136 ||
                Table1Type->AsInteger == 1137 ||
                Table1Type->AsInteger == 1143 ||
                Table1Type->AsInteger == 1146 ||
                Table1Type->AsInteger == 1902 ||
                Table1Type->AsInteger == 1903 )
      {
         DBGrid1->Canvas->Font->Color=clGreen;
         DBGrid1->Canvas->FillRect(Rect);
         DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
      }
      else if( (Table1Type->AsInteger == 11 && Table1Dtype->AsInteger != 14 && Table1Dtype->AsInteger != 17) ||
                Table1Type->AsInteger == 12 ||
                Table1Type->AsInteger == 13 ||
                Table1Type->AsInteger == 15 ||
                Table1Type->AsInteger == 16 ||
                Table1Type->AsInteger == 18 ||
                Table1Type->AsInteger == 30 ||
                Table1Type->AsInteger == 31 ||
                Table1Type->AsInteger == 201 ||
                Table1Type->AsInteger == 202 ||
                Table1Type->AsInteger == 203 ||
                Table1Type->AsInteger == 204 ||
                Table1Type->AsInteger == 211 ||
                Table1Type->AsInteger == 212 ||
                Table1Type->AsInteger == 213 ||
                Table1Type->AsInteger == 214 ||
                Table1Type->AsInteger == 221 ||
                Table1Type->AsInteger == 222 ||
                Table1Type->AsInteger == 223 ||
                Table1Type->AsInteger == 224 ||
                Table1Type->AsInteger == 231 ||
                Table1Type->AsInteger == 232 ||
                Table1Type->AsInteger == 241 ||
                Table1Type->AsInteger == 242 ||
                Table1Type->AsInteger == 251 ||
                Table1Type->AsInteger == 252 )
      {
         DBGrid1->Canvas->Font->Color=clBlue;
         DBGrid1->Canvas->FillRect(Rect);
         DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
      }
      else if( Table1Type->AsInteger == 10 || Table1Type->AsInteger == 200 )
      {
         DBGrid1->Canvas->Font->Color=(TColor)RGB(255,93,0);
         DBGrid1->Canvas->FillRect(Rect);
         DBGrid1->DefaultDrawColumnCell(Rect, DataCol, Column, State);
      }

      if( Column->FieldName == "Cnt" )
      {
         if( !Table1Flag->AsBoolean )
         {
            switch( Table1Type->AsInteger )
            {
               case   1: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case   2: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case   3: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case   4: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case   5: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case   6: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case   7: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case 142: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case  10: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,WImg);
                         break;
               case  11: if( Table1Dtype->AsInteger == 14 || Table1Dtype->AsInteger == 17 )
                            DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         else
                            DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  12: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  13: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  15: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  16: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  17: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  18: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case 200: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,WImg);
                         break;
               case  20: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  21: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  22: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  23: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  24: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  25: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  26: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  27: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case  30: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case  31: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case 100: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,OImg);
                         break;
               case 101: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case 110: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,OImg);
                         break;
               case 111: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,OImg);
                         break;
               case 112: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,OImg);
                         break;
               case 113: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,OImg);
                         break;
               case 130: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 131: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 132: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 133: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 134: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 135: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 136: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 137: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 138: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 140: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 141: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 143: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case 144: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case 145: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case 146: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,NImg);
                         break;
               case 150: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 151: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 160: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 170: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 171: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 172: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 173: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 174: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 175: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 201:
               case 202:
               case 203:
               case 204:
               case 211:
               case 212:
               case 213:
               case 214:
               case 221:
               case 222:
               case 223:
               case 224:
               case 231:
               case 232:
               case 241:
               case 242:
               case 251:
               case 252:
                         DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,PImg);
                         break;
               case 900: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 901: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 903: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 904: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case 905: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case 1000: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1001: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1002: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1003: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1004: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1005: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1006: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1007: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,AImg);
                         break;
               case 1133: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1136: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1137: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1143: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1146: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
               case 1903: DBGrid1->Canvas->Draw(Rect.Left/2,Rect.Top,HImg);
                         break;
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AlarmResetItemClick(TObject *Sender)
{
   AlarmsReset(false);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ZhurnalToDbItemClick(TObject *Sender)
{
   DbStart(false, false);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ExitItemClick(TObject *Sender)
{
   Close();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::PopupMenu2Popup(TObject *Sender)
{
   DelPrichina_pdi->Visible = false;
   if( Table1->IsEmpty() )
   {
      AddPrichina_pdi->Visible = false;
      N10->Visible = false;
      DelPrichina_pdi->Visible = false;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::PopupMenu3Popup(TObject *Sender)
{
   DelMera_pdi->Visible = false;
   if( Table1->IsEmpty() )
   {
      AddMera_pdi->Visible = false;
      N14->Visible = false;
      DelMera_pdi->Visible = false;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AddPrichina_pdiClick(TObject *Sender)
{
   if( ComboBox3->Text == "" )
      MessageBox (NULL,MsgStr19.c_str(), ErrorMsg.c_str()/*"Причина не задана!","Ошибка"*/,MB_OK|MB_ICONERROR);
   else
   {
      if( !Table1->IsEmpty() && DBGrid1->SelectedRows->Count > 0 )
      {
         TDataSet *pDS = DBGrid1->DataSource->DataSet;
         for( int i=0; i < DBGrid1->SelectedRows->Count; i++)
         {
            pDS->GotoBookmark((void *)DBGrid1->SelectedRows->Items[i].c_str());

            AnsiString str;
            str = pDS->Fields->Fields[9]->AsString;
            if( str.Length() == 0 )
            {
               Table1->Edit();
               pDS->Fields->Fields[9]->AsString = ComboBox3->Text;
               Table1->Post();
            }
            Table1->FlushBuffers();


            if( MySQL_use > 0 )
            {
               AnsiString query, err_str;

               AnsiString d_t;
               d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", pDS->Fields->Fields[1]->AsDateTime);

//               query.sprintf("UPDATE %s.events SET comment1=\'%s\' WHERE event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
               query.sprintf("UPDATE %s.events SET comment1=\'%s\', client_operator_fn=\'new\' WHERE comment1=\'\' AND event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
                                          MySQL_dbname,
                                          pDS->Fields->Fields[9]->AsString,
                                          d_t,                                  // event_dt
                                          pDS->Fields->Fields[2]->AsInteger,    // event_code
                                          pDS->Fields->Fields[5]->AsInteger,    // dev_type
                                          pDS->Fields->Fields[6]->AsInteger,    // dev_num1
                                          pDS->Fields->Fields[7]->AsInteger,    // dev_num2
                                          pDS->Fields->Fields[8]->AsInteger);   // dev_num3

                mysql_real_query(Con,query.c_str(),query.Length());
                int err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
            }
         }
      }

      if( CommentList->IndexOf(ComboBox3->Text) == -1 )
      {
         CommentList->Add(ComboBox3->Text);
         CommentList->Sort();

         ComboBox3->Items->Clear();

         for( int i = 0; i < CommentList->Count; i++ )
            ComboBox3->Items->Add(CommentList->Strings[i]);
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DelPrichina_pdiClick(TObject *Sender)
{
   if( !Table1->IsEmpty() && DBGrid1->SelectedRows->Count > 0 )
   {
      TDataSet *pDS = DBGrid1->DataSource->DataSet;
      for( int i=0; i < DBGrid1->SelectedRows->Count; i++)
      {
         pDS->GotoBookmark((void *)DBGrid1->SelectedRows->Items[i].c_str());
         Table1->Edit();
         pDS->Fields->Fields[9]->AsString = "";
         Table1->Post();
         Table1->FlushBuffers();

            if( MySQL_use > 0 )
            {
               AnsiString query, err_str;

               AnsiString d_t;
               d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", pDS->Fields->Fields[1]->AsDateTime);

               query.sprintf("UPDATE %s.events SET comment1=\'%s\' WHERE event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
                                          MySQL_dbname,
                                          "",
                                          d_t,                                  // event_dt
                                          pDS->Fields->Fields[2]->AsInteger,    // event_code
                                          pDS->Fields->Fields[5]->AsInteger,    // dev_type
                                          pDS->Fields->Fields[6]->AsInteger,    // dev_num1
                                          pDS->Fields->Fields[7]->AsInteger,    // dev_num2
                                          pDS->Fields->Fields[8]->AsInteger);   // dev_num3

                mysql_real_query(Con,query.c_str(),query.Length());
                int err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
            }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AddMera_pdiClick(TObject *Sender)
{
   if( ComboBox4->Text == "" )
      MessageBox (NULL,MsgStr20.c_str(), ErrorMsg.c_str()/*"Принятые меры не заданы!","Ошибка"*/,MB_OK|MB_ICONERROR);
   else
   {
      if( !Table1->IsEmpty() && DBGrid1->SelectedRows->Count > 0 )
      {
         TDataSet *pDS = DBGrid1->DataSource->DataSet;
         for( int i=0; i < DBGrid1->SelectedRows->Count; i++)
         {
            pDS->GotoBookmark((void *)DBGrid1->SelectedRows->Items[i].c_str());

            AnsiString str;
            str = pDS->Fields->Fields[10]->AsString;
            if( str.Length() == 0 )
            {
               Table1->Edit();
               pDS->Fields->Fields[10]->AsString = ComboBox4->Text;
               Table1->Post();
            }
            Table1->FlushBuffers();

            if( MySQL_use > 0 )
            {
               AnsiString query, err_str;

               AnsiString d_t;
               d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", pDS->Fields->Fields[1]->AsDateTime);

//               query.sprintf("UPDATE %s.events SET comment2=\'%s\' WHERE event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
               query.sprintf("UPDATE %s.events SET comment2=\'%s\', client_operator_fn=\'new\' WHERE comment2=\'\' AND event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
                                          MySQL_dbname,
                                          pDS->Fields->Fields[10]->AsString,
                                          d_t,                                  // event_dt
                                          pDS->Fields->Fields[2]->AsInteger,    // event_code
                                          pDS->Fields->Fields[5]->AsInteger,    // dev_type
                                          pDS->Fields->Fields[6]->AsInteger,    // dev_num1
                                          pDS->Fields->Fields[7]->AsInteger,    // dev_num2
                                          pDS->Fields->Fields[8]->AsInteger);   // dev_num3

               mysql_real_query(Con,query.c_str(),query.Length());
                int err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
            }
         }
      }

      if( CommentList2->IndexOf(ComboBox4->Text) == -1 )
      {
         CommentList2->Add(ComboBox4->Text);
         CommentList2->Sort();

         ComboBox4->Items->Clear();

         for( int i = 0; i < CommentList2->Count; i++ )
            ComboBox4->Items->Add(CommentList2->Strings[i]);
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DelMera_pdiClick(TObject *Sender)
{
   if( !Table1->IsEmpty() && DBGrid1->SelectedRows->Count > 0 )
   {
      TDataSet *pDS = DBGrid1->DataSource->DataSet;
      for( int i=0; i < DBGrid1->SelectedRows->Count; i++)
      {
         pDS->GotoBookmark((void *)DBGrid1->SelectedRows->Items[i].c_str());
         Table1->Edit();
         pDS->Fields->Fields[10]->AsString = "";
         Table1->Post();
         Table1->FlushBuffers();

            if( MySQL_use > 0 )
            {
               AnsiString query, err_str;

               AnsiString d_t;
               d_t = FormatDateTime("yyyy-mm-dd hh:nn:ss", pDS->Fields->Fields[1]->AsDateTime);

               query.sprintf("UPDATE %s.events SET comment2=\'%s\' WHERE event_dt=\'%s\' AND event_code=%d AND dev_type=%d AND dev_num1=%d AND dev_num2=%d AND dev_num3=%d",
                                          MySQL_dbname,
                                          "",
                                          d_t,                                  // event_dt
                                          pDS->Fields->Fields[2]->AsInteger,    // event_code
                                          pDS->Fields->Fields[5]->AsInteger,    // dev_type
                                          pDS->Fields->Fields[6]->AsInteger,    // dev_num1
                                          pDS->Fields->Fields[7]->AsInteger,    // dev_num2
                                          pDS->Fields->Fields[8]->AsInteger);   // dev_num3
               mysql_real_query(Con,query.c_str(),query.Length());
                int err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   mysql_close(Con);

                   Con = mysql_init(NULL);
                   mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
                   err_code = mysql_errno(Con);
                   if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
                   {
                      MySQL_use = -1;

                      err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                      ShowMessage(err_str);
                   }
                   else
                   {
                      mysql_real_query(Con,query.c_str(),query.Length());
                      err_code = mysql_errno(Con);
                      if( err_code != 0 )
                      {
                         MySQL_use = -1;

                         err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                         ShowMessage(err_str);
                      }
                   }
                }
            }
      }
   }
}
//---------------------------------------------------------------------------
bool TMainForm::Audit()
{
   bool flag = false;

   TStringList *DrList;
   DrList = new TStringList;

   char pwchar[255];
   for( int i = 0; i < 255; i++ ) pwchar[i] = 0;
   char dr[10];

   GetLogicalDriveStrings(255,pwchar);
   for( int i = 0; i < 255; i++ )
   {
      if( pwchar[i] == ':' )
      dr[0] = pwchar[i-1];
      dr[1] = pwchar[i];
      dr[2] = pwchar[i+1];
      dr[3] = pwchar[i+2];

//      AnsiString str = dr;

      if( GetDriveType(dr) == DRIVE_REMOVABLE ) DrList->Add(dr);
   }

   TAdmAudit *AdmAud;
   AdmAud = new TAdmAudit;

   unsigned int errmode = SetErrorMode ( SEM_FAILCRITICALERRORS );

   for( int i = 0; i < DrList->Count; i++ )
   {
      AnsiString str = DrList->Strings[i];
      if( DirectoryExists(str) )
      {
         str = str + "auidit.adm";

         if( AdmAud->Load(str) )
         {
            double crc = AdmAud->Version + AdmAud->CreateDt;
            if( crc == AdmAud->Crc ) { flag = true; break; }
         }
      }
   }

   SetErrorMode ( errmode );

   delete AdmAud;
   delete DrList;

   return flag;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ApplicationEvents1Message(tagMSG &Msg,
      bool &Handled)
{
   if( Msg.message == WM_MOUSEWHEEL )
   {
      Msg.message = WM_KEYDOWN;
      Msg.lParam = 0;
      Msg.wParam = ((signed long)Msg.wParam > 0 ? VK_UP:VK_DOWN);
      Handled = false;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::TvTimerTimer(TObject *Sender)
{
   if( RastrPortNum != 0 )
   {
      if( RastrSys->Mon[CurMon].Use && RastrSys->Mon[CurMon].Auto )
      {
         int t = RastrSys->AutoTime*1000.0/double(TvTimer->Interval*4);
         if( TvAutoCnt[CurMon] <= t) TvAutoCnt[CurMon] += 1;
         else
         {
            if( TvAutoNum[CurMon] < TvCnt-1 )
            {
               if( RastrSys->Mon[CurMon].AutoTv[TvAutoNum[CurMon]+1] != 0 )
               {
                  TvAutoNum[CurMon] = TvAutoNum[CurMon]+1;
                  TvAutoCnt[CurMon] = 0;
               }
               else
               {
                  TvAutoNum[CurMon] = 0;
                  TvAutoCnt[CurMon] = 0;
                  for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[CurMon].AutoTv[i] = 0;
                  RastrSys->Mon[CurMon].Auto = false;
               }
            }
         }

         Serial3.TvOn(CurMon, RastrSys->Mon[CurMon].AutoTv[TvAutoNum[CurMon]]-1);
      }

      CurMon = (CurMon+1)%4;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::RastrTreeClick(TObject *Sender)
{
   AnsiString str;
   Monitor = PRastrObj(RastrTree->Selected->Data)->Num1;
   Camera = PRastrObj(RastrTree->Selected->Data)->Num2;

   if( PRastrObj(RastrTree->Selected->Data)->Type == 1 )
   {
      str.sprintf("Монитор:%d Камера:%d", Monitor, (Camera-1) );
      StaticText15->Caption = str;

      if( RastrSys->Mon[Monitor-1].Auto )
      {
         TvAutoNum[Monitor-1] = 0;
         TvAutoCnt[Monitor-1] = 0;
         for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
         RastrSys->Mon[Monitor-1].Auto = false;
      }

      if( RastrPortNum != 0 ) Serial3.TvOn(Monitor-1, Camera-1);
   }
   else
   {
      str.sprintf("Монитор:%d", Monitor );
      StaticText15->Caption = str;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::RastrTreeKeyUp(TObject *Sender, WORD &Key,
      TShiftState Shift)
{
   RastrTreeClick(this);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::FormKeyDown(TObject *Sender, WORD &Key,
      TShiftState Shift)
{
   /* Свойство MainForm->KeyPreview установить в true */
   if( Shift.Contains(ssCtrl) && RastrPortNum != 0 &&
       Monitor != -1 && Camera != -1 )
   {
      switch( Key )
      {
         case VK_LEFT:  
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvLeft(Monitor-1);
                        break;
         case VK_RIGHT: 
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvRight(Monitor-1);
                        break;
         case VK_DOWN:  
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvDn(Monitor-1);
                        break;
         case VK_UP:    
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvUp(Monitor-1);
                        break;
         case VK_HOME:  
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvUv(Monitor-1);
                        break;
         case VK_END:   
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvUm(Monitor-1);
                        break;
         case VK_PRIOR: 
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvFUp(Monitor-1);
                        break;
         case VK_NEXT:  
                        TvAutoNum[Monitor-1] = 0;
                        TvAutoCnt[Monitor-1] = 0;
                        for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
                        RastrSys->Mon[Monitor-1].Auto = false;
                        TvHand = true;

                        Serial3.TvFDn(Monitor-1);
                        break;
         default:       TvHand = false;
                        break;

      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::FormKeyUp(TObject *Sender, WORD &Key,
      TShiftState Shift)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton1MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvLeft(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton1MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton2MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvRight(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton2MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton3MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvUp(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton3MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton4MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvDn(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton4MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton5MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvUv(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton5MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton6MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvUm(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton6MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton7MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvFUp(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton7MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton8MouseDown(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( RastrPortNum != 0 && Monitor != -1 && Camera != -1 )
   {
      TvAutoNum[Monitor-1] = 0;
      TvAutoCnt[Monitor-1] = 0;
      for( int i = 0; i < TvCnt; i++ ) RastrSys->Mon[Monitor-1].AutoTv[i] = 0;
      RastrSys->Mon[Monitor-1].Auto = false;
      TvHand = true;

      Serial3.TvFDn(Monitor-1);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton8MouseUp(TObject *Sender,
      TMouseButton Button, TShiftState Shift, int X, int Y)
{
   if( TvHand && RastrPortNum != 0 )
      Serial3.TvOn(Monitor-1, Camera-1);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton9Click(TObject *Sender)
{
   AddPrichina_pdiClick(this);
   ShowPrCnt();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton10Click(TObject *Sender)
{
   DelPrichina_pdiClick(this);
   ShowPrCnt();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton11Click(TObject *Sender)
{
   AddMera_pdiClick(this);
   ShowPrCnt();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpeedButton12Click(TObject *Sender)
{
   DelMera_pdiClick(this);
   ShowPrCnt();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ZhurnalPrintItemClick(TObject *Sender)
{
   Table1->DisableControls();
   if( frxReport1->PrepareReport() ) frxReport1->Print();
   Table1->EnableControls();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ZhurnalPrintViewItemClick(TObject *Sender)
{
   Table1->DisableControls();
   frxReport1->ShowReport();
   Table1->EnableControls();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DbItemClick(TObject *Sender)
{
   AnsiString str;

   if( ComplexVersion == SsoiComplexType ) str = ExtractFilePath(Application->ExeName) + "m_db_ssoi.exe";
   else if( ComplexVersion == Rastr_M_SsoiComplexType ) str = ExtractFilePath(Application->ExeName) + "m_db_rastrmssoi.exe";
   else str = ExtractFilePath(Application->ExeName) + "m_db.exe";

   if( FileExists(str) ) WinExec(str.c_str(), SW_SHOW	);  
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SolidTimerTimer(TObject *Sender)
{
   if( SolidPortNum != 0 )
   {
      Serial4.TvS(SolidSys->OutStatus);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ConcDkItemClick(TObject *Sender)
{
   SetSob( 133,
           0,
           0,
           0,
           0,
           "Концентраторы", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   for( int i = 0; i < RifDevCnt; i++ )
   {
      for( int j = 0; j < MaxInCnt; j++ )
      {
         if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[j] == 1 && RifPortNum[kn] != 0 &&
             RifSys->Rk[kn][i].DkUse[j] )
         {
            if( RifSys->Rk[kn][i].Type == 1 && RifSys->Rk[kn][i].Cmd == 0x22 )
            {
               RifSys->Rk[kn][i].Cmd = 0x21;
               RifSys->Rk[kn][i].CmdCnt = 0;
               RifSys->Rk[kn][i].AutoDk = false;
               RifSys->Rk[kn][i].AutoDkCnt = 0;
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagKoncInfo( int status, int d1, int d2, int d3 )
{
   AnsiString str;
   if( DiagKonc->Adr == 0 )
   {
      ResetDiagInfo(2);
   }
   else
   {
      if( status != 10 )
      {
         bool TIn[MaxInCnt] = {false, false, false, false};
         bool VIn = false;
         bool TOut[MaxInCnt]= {false, false, false, false};
         bool OnIn[MaxInCnt]= {false, false, false, false};
         bool TsIn[MaxInCnt]= {false, false, false, false};
         bool Ts = false;
         bool T = false;
         bool Dk = false;
         bool Tv = false;
         bool DkOut = false;

         int temp = 0;
         temp = d1 & 1;
         if( temp == 1 ) TIn[0] = true;

         temp = 0;
         temp = d1 & 2;
         if( temp == 2 ) TIn[1] = true;

         temp = 0;
         temp = d1 & 4;
         if( temp == 4 ) TIn[2] = true;

         temp = 0;
         temp = d1 & 8;
         if( temp == 8 ) TIn[3] = true;

         temp = 0;
         temp = d1 & 16;
         if( temp == 16 ) DkOut = true;

         temp = 0;
         temp = d1 & 32;
         if( temp == 32 ) VIn = true;

         temp = 0;
         temp = d2 & 1;
         if( temp == 1 ) TOut[0] = true;

         temp = 0;
         temp = d2 & 2;
         if( temp == 2 ) TOut[1] = true;

         temp = 0;
         temp = d2 & 4;
         if( temp == 4 ) TOut[2] = true;

         temp = 0;
         temp = d2 & 8;
         if( temp == 8 ) TOut[3] = true;

         temp = 0;
         temp = d2 & 16;
         if( temp == 16 ) OnIn[0] = true;

         temp = 0;
         temp = d2 & 32;
         if( temp == 32 ) OnIn[1] = true;

         temp = 0;
         temp = d2 & 64;
         if( temp == 64 ) OnIn[2] = true;

         temp = 0;
         temp = d2 & 128;
         if( temp == 128 ) OnIn[3] = true;

         temp = 0;
         temp = d3 & 1;
         if( temp == 1 ) TsIn[0] = true;

         temp = 0;
         temp = d3 & 2;
         if( temp == 2 ) TsIn[1] = true;

         temp = 0;
         temp = d3 & 4;
         if( temp == 4 ) TsIn[2] = true;

         temp = 0;
         temp = d3 & 8;
         if( temp == 8 ) TsIn[3] = true;

         temp = 0;
         temp = d3 & 16;
         if( temp == 16 ) Ts = true;

         temp = 0;
         temp = d3 & 32;
         if( temp == 32 ) T = true;

         temp = 0;
         temp = d3 & 64;
         if( temp == 64 ) Dk = true;

         temp = 0;
         temp = d3 & 128;
         if( temp == 128 ) Tv = true;

         if( TIn[0] != DiagKonc->TIn[0] || status != DiagKonc->Status )
         {
            if( !TIn[0] )
            {
               Image59->Picture->Bitmap = I7Img;
               StaticText59->Caption = "НЕТ";
            }
            else
            {
               Image59->Picture->Bitmap = I8Img;
               StaticText59->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[0] = TIn[0];

         if( TIn[1] != DiagKonc->TIn[1] || status != DiagKonc->Status )
         {
            if( !TIn[1] )
            {
               Image60->Picture->Bitmap = I7Img;
               StaticText60->Caption = "НЕТ";
            }
            else
            {
               Image60->Picture->Bitmap = I8Img;
               StaticText60->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[1] = TIn[1];

         if( TIn[2] != DiagKonc->TIn[2] || status != DiagKonc->Status )
         {
            if( !TIn[2] )
            {
               Image61->Picture->Bitmap = I7Img;
               StaticText61->Caption = "НЕТ";
            }
            else
            {
               Image61->Picture->Bitmap = I8Img;
               StaticText61->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[2] = TIn[2];

         if( TIn[3] != DiagKonc->TIn[3] || status != DiagKonc->Status )
         {
            if( !TIn[3] )
            {
               Image62->Picture->Bitmap = I7Img;
               StaticText62->Caption = "НЕТ";
            }
            else
            {
               Image62->Picture->Bitmap = I8Img;
               StaticText62->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[3] = TIn[3];

         if( TOut[0] != DiagKonc->TOut[0] || status != DiagKonc->Status )
         {
            if( TOut[0] )
            {
               Image69->Picture->Bitmap = I7Img;
               StaticText69->Caption = "НЕТ";
            }
            else
            {
               Image69->Picture->Bitmap = I8Img;
               StaticText69->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[0] = TOut[0];

         if( TOut[1] != DiagKonc->TOut[1] || status != DiagKonc->Status )
         {
            if( TOut[1] )
            {
               Image70->Picture->Bitmap = I7Img;
               StaticText70->Caption = "НЕТ";
            }
            else
            {
               Image70->Picture->Bitmap = I8Img;
               StaticText70->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[1] = TOut[1];

         if( TOut[2] != DiagKonc->TOut[2] || status != DiagKonc->Status )
         {
            if( TOut[2] )
            {
               Image71->Picture->Bitmap = I7Img;
               StaticText71->Caption = "НЕТ";
            }
            else
            {
               Image71->Picture->Bitmap = I8Img;
               StaticText71->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[2] = TOut[2];

         if( TOut[3] != DiagKonc->TOut[3] || status != DiagKonc->Status )
         {
            if( TOut[3] )
            {
               Image72->Picture->Bitmap = I7Img;
               StaticText72->Caption = "НЕТ";
            }
            else
            {
               Image72->Picture->Bitmap = I8Img;
               StaticText72->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[3] = TOut[3];

         if( VIn != DiagKonc->VIn || status != DiagKonc->Status )
         {
            if( !VIn )
            {
               Image8->Picture->Bitmap = I7Img;
               StaticText9->Caption = "НЕТ";
            }
            else
            {
               Image8->Picture->Bitmap = I8Img;
               StaticText9->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->VIn = VIn;

         if( OnIn[0] != DiagKonc->OnIn[0] || status != DiagKonc->Status )
         {
            if( OnIn[0] )
            {
               Image51->Picture->Bitmap = I3Img;
               StaticText51->Caption = "ВКЛ";
            }
            else
            {
               Image51->Picture->Bitmap = I6Img;
               StaticText51->Caption = "ВЫКЛ";
            }
         }
         DiagKonc->OnIn[0] = OnIn[0];

         if( OnIn[1] != DiagKonc->OnIn[1] || status != DiagKonc->Status )
         {
            if( OnIn[1] )
            {
               Image52->Picture->Bitmap = I3Img;
               StaticText52->Caption = "ВКЛ";
            }
            else
            {
               Image52->Picture->Bitmap = I6Img;
               StaticText52->Caption = "ВЫКЛ";
            }
         }
         DiagKonc->OnIn[1] = OnIn[1];

         if( OnIn[2] != DiagKonc->OnIn[2] || status != DiagKonc->Status )
         {
            if( OnIn[2] )
            {
               Image53->Picture->Bitmap = I3Img;
               StaticText53->Caption = "ВКЛ";
            }
            else
            {
               Image53->Picture->Bitmap = I6Img;
               StaticText53->Caption = "ВЫКЛ";
            }
         }
         DiagKonc->OnIn[2] = OnIn[2];

         if( OnIn[3] != DiagKonc->OnIn[3] || status != DiagKonc->Status )
         {
            if( OnIn[3] )
            {
               Image54->Picture->Bitmap = I3Img;
               StaticText54->Caption = "ВКЛ";
            }
            else
            {
               Image54->Picture->Bitmap = I6Img;
               StaticText54->Caption = "ВЫКЛ";
            }
         }
         DiagKonc->OnIn[3] = OnIn[3];

         if( TsIn[0] != DiagKonc->TsIn[0] || status != DiagKonc->Status )
         {
            if( TsIn[0] )
            {
               Image55->Picture->Bitmap = I5Img;
               StaticText55->Caption = "ЕСТЬ";
            }
            else
            {
               Image55->Picture->Bitmap = I2Img;
               StaticText55->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[0] = TsIn[0];

         if( TsIn[1] != DiagKonc->TsIn[1] || status != DiagKonc->Status )
         {
            if( TsIn[1] )
            {
               Image56->Picture->Bitmap = I5Img;
               StaticText56->Caption = "ЕСТЬ";
            }
            else
            {
               Image56->Picture->Bitmap = I2Img;
               StaticText56->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[1] = TsIn[1];

         if( TsIn[2] != DiagKonc->TsIn[2] || status != DiagKonc->Status )
         {
            if( TsIn[2] )
            {
               Image57->Picture->Bitmap = I5Img;
               StaticText57->Caption = "ЕСТЬ";
            }
            else
            {
               Image57->Picture->Bitmap = I2Img;
               StaticText57->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[2] = TsIn[2];

         if( TsIn[3] != DiagKonc->TsIn[3] || status != DiagKonc->Status )
         {
            if( TsIn[3] )
            {
               Image58->Picture->Bitmap = I5Img;
               StaticText58->Caption = "ЕСТЬ";
            }
            else
            {
               Image58->Picture->Bitmap = I2Img;
               StaticText58->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[3] = TsIn[3];

         if( Ts != DiagKonc->Ts || status != DiagKonc->Status )
         {
            if( Ts )
            {
               Image6->Picture->Bitmap = I5Img;
               StaticText7->Caption = "ЕСТЬ";
            }
            else
            {
               Image6->Picture->Bitmap = I2Img;
               StaticText7->Caption = "НЕТ";
            }
         }
         DiagKonc->Ts = Ts;

         if( T != DiagKonc->T || status != DiagKonc->Status )
         {
            if( T )
            {
               Image4->Picture->Bitmap = I5Img;
               StaticText5->Caption = "ЕСТЬ";
            }
            else
            {
               Image4->Picture->Bitmap = I2Img;
               StaticText5->Caption = "НЕТ";
            }
         }
         DiagKonc->T = T;

         if( Dk != DiagKonc->Dk || status != DiagKonc->Status )
         {
            if( Dk )
            {
               Image2->Picture->Bitmap = I4Img;
               StaticText3->Caption = "ЕСТЬ";
            }
            else
            {
               Image2->Picture->Bitmap = I2Img;
               StaticText3->Caption = "НЕТ";
            }
         }
         DiagKonc->Dk = Dk;

         if( DkOut != DiagKonc->DkOut || status != DiagKonc->Status )
         {
            if( DkOut )
            {
               Image3->Picture->Bitmap = I8Img;
               StaticText4->Caption = "ЕСТЬ";
            }
            else
            {
               Image3->Picture->Bitmap = I7Img;
               StaticText4->Caption = "НЕТ";
            }
         }
         DiagKonc->DkOut = DkOut;

         if( Tv != DiagKonc->T || status != DiagKonc->Status )
         {
            if( Tv )
            {
               Image7->Picture->Bitmap = I5Img;
               StaticText8->Caption = "ЕСТЬ";
            }
            else
            {
               Image7->Picture->Bitmap = I2Img;
               StaticText8->Caption = "НЕТ";
            }
         }
         DiagKonc->Tv = Tv;
      }
      else
      {
         if( status != DiagKonc->Status )
         {
            ResetDiagInfo(2);
         }
      }
      DiagRif->Status = status;
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagKoncInfo2( int status, int d1, int d2, int d3 )
{
   AnsiString str;
   if( DiagKonc->Adr == 0 )
   {
      ResetDiagInfo(6);
   }
   else
   {
      if( status != 10 )
      {
         bool TIn[MaxInCnt] = {false, false, false, false};
         bool VIn = false;
         bool TOut[MaxInCnt]= {false, false, false, false};
         bool OnIn[MaxInCnt]= {false, false, false, false};
         bool TsIn[MaxInCnt]= {false, false, false, false};
         bool Ts = false;
         bool T = false;
         bool Dk = false;
         bool Tv = false;
         bool DkOut = false;
         int DK_Var = 0;
         int Conf = 0;

         int temp = 0;
         temp = d1 & 1;
         if( temp == 1 ) TIn[0] = true;

         temp = 0;
         temp = d1 & 2;
         if( temp == 2 ) TIn[1] = true;

         temp = 0;
         temp = d1 & 4;
         if( temp == 4 ) TIn[2] = true;

         temp = 0;
         temp = d1 & 8;
         if( temp == 8 ) TIn[3] = true;

         temp = 0;
         temp = d1 & 16;
         if( temp == 16 ) DkOut = true;

         temp = 0;
         temp = d1 & 32;
         if( temp == 32 ) VIn = true;

         temp = 0;
         temp = d1 & 64;
         if( temp == 64 ) DK_Var = 1;

         temp = 0;
         temp = d1 & 128;
         if( temp == 128 ) Conf = 1;

         temp = 0;
         temp = d2 & 1;
         if( DK_Var == 0 && temp == 0 ) TOut[0] = true;
         else if( DK_Var == 1 && temp == 1 ) TOut[0] = true;

         temp = 0;
         temp = d2 & 2;
         if( DK_Var == 0 && temp == 0 ) TOut[1] = true;
         else if( DK_Var == 1 && temp == 2 ) TOut[1] = true;

         temp = 0;
         temp = d2 & 4;
         if( DK_Var == 0 && temp == 0 ) TOut[2] = true;
         else if( DK_Var == 1 && temp == 4 ) TOut[2] = true;

         temp = 0;
         temp = d2 & 8;
         if( DK_Var == 0 && temp == 0 ) TOut[3] = true;
         else if( DK_Var == 1 && temp == 8 ) TOut[3] = true;

         temp = 0;
         temp = d2 & 16;
         if( temp == 16 ) OnIn[0] = true;

         temp = 0;
         temp = d2 & 32;
         if( temp == 32 ) OnIn[1] = true;

         temp = 0;
         temp = d2 & 64;
         if( temp == 64 ) OnIn[2] = true;

         temp = 0;
         temp = d2 & 128;
         if( temp == 128 ) OnIn[3] = true;

         temp = 0;
         temp = d3 & 1;
         if( temp == 1 ) TsIn[0] = true;

         temp = 0;
         temp = d3 & 2;
         if( temp == 2 ) TsIn[1] = true;

         temp = 0;
         temp = d3 & 4;
         if( temp == 4 ) TsIn[2] = true;

         temp = 0;
         temp = d3 & 8;
         if( temp == 8 ) TsIn[3] = true;

         temp = 0;
         temp = d3 & 16;
         if( temp == 16 ) Ts = true;

         temp = 0;
         temp = d3 & 32;
         if( temp == 32 ) T = true;

         temp = 0;
         temp = d3 & 64;
         if( temp == 64 ) Dk = true;

         temp = 0;
         temp = d3 & 128;
         if( temp == 128 ) Tv = true;

         if( TIn[0] != DiagKonc->TIn[0] || status != DiagKonc->Status )
         {
            if( !TIn[0] )
            {
               Image59->Picture->Bitmap = I7Img;
               StaticText59->Caption = "НЕТ";
            }
            else
            {
               Image59->Picture->Bitmap = I8Img;
               StaticText59->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[0] = TIn[0];

         if( TIn[1] != DiagKonc->TIn[1] || status != DiagKonc->Status )
         {
            if( !TIn[1] )
            {
               Image60->Picture->Bitmap = I7Img;
               StaticText60->Caption = "НЕТ";
            }
            else
            {
               Image60->Picture->Bitmap = I8Img;
               StaticText60->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[1] = TIn[1];

         if( TIn[2] != DiagKonc->TIn[2] || status != DiagKonc->Status )
         {
            if( !TIn[2] )
            {
               Image61->Picture->Bitmap = I7Img;
               StaticText61->Caption = "НЕТ";
            }
            else
            {
               Image61->Picture->Bitmap = I8Img;
               StaticText61->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[2] = TIn[2];

         if( TIn[3] != DiagKonc->TIn[3] || status != DiagKonc->Status )
         {
            if( !TIn[3] )
            {
               Image62->Picture->Bitmap = I7Img;
               StaticText62->Caption = "НЕТ";
            }
            else
            {
               Image62->Picture->Bitmap = I8Img;
               StaticText62->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TIn[3] = TIn[3];

         if( TOut[0] != DiagKonc->TOut[0] || status != DiagKonc->Status )
         {
            if( !TOut[0] )
            {
               Image69->Picture->Bitmap = I7Img;
               StaticText69->Caption = "НЕТ";
            }
            else
            {
               Image69->Picture->Bitmap = I8Img;
               StaticText69->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[0] = TOut[0];

         if( TOut[1] != DiagKonc->TOut[1] || status != DiagKonc->Status )
         {
            if( !TOut[1] )
            {
               Image70->Picture->Bitmap = I7Img;
               StaticText70->Caption = "НЕТ";
            }
            else
            {
               Image70->Picture->Bitmap = I8Img;
               StaticText70->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[1] = TOut[1];

         if( TOut[2] != DiagKonc->TOut[2] || status != DiagKonc->Status )
         {
            if( !TOut[2] )
            {
               Image71->Picture->Bitmap = I7Img;
               StaticText71->Caption = "НЕТ";
            }
            else
            {
               Image71->Picture->Bitmap = I8Img;
               StaticText71->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[2] = TOut[2];

         if( TOut[3] != DiagKonc->TOut[3] || status != DiagKonc->Status )
         {
            if( !TOut[3] )
            {
               Image72->Picture->Bitmap = I7Img;
               StaticText72->Caption = "НЕТ";
            }
            else
            {
               Image72->Picture->Bitmap = I8Img;
               StaticText72->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->TOut[3] = TOut[3];

         if( VIn != DiagKonc->VIn || status != DiagKonc->Status )
         {
            if( !VIn )
            {
               Image8->Picture->Bitmap = I7Img;
               StaticText9->Caption = "НЕТ";
            }
            else
            {
               Image8->Picture->Bitmap = I8Img;
               StaticText9->Caption = "ЕСТЬ";
            }
         }
         DiagKonc->VIn = VIn;

         if( DK_Var == 0 ) StaticText11->Caption = "Тревога \"0\"";
         else StaticText11->Caption = "Тревога \"1\"";

         if( Conf == 0 ) StaticText2->Caption = "ВЫКЛ";
         else StaticText2->Caption = "ВКЛ";

         if( OnIn[0] != DiagKonc->OnIn[0] || status != DiagKonc->Status )
         {
            if( OnIn[0] )
            {
               Image51->Picture->Bitmap = I8Img;
               StaticText51->Caption = "ЕСТЬ";
            }
            else
            {
               Image51->Picture->Bitmap = I7Img;
               StaticText51->Caption = "НЕТ";
            }
         }
         DiagKonc->OnIn[0] = OnIn[0];

         if( OnIn[1] != DiagKonc->OnIn[1] || status != DiagKonc->Status )
         {
            if( OnIn[1] )
            {
               Image52->Picture->Bitmap = I8Img;
               StaticText52->Caption = "ЕСТЬ";
            }
            else
            {
               Image52->Picture->Bitmap = I7Img;
               StaticText52->Caption = "НЕТ";
            }
         }
         DiagKonc->OnIn[1] = OnIn[1];

         if( OnIn[2] != DiagKonc->OnIn[2] || status != DiagKonc->Status )
         {
            if( OnIn[2] )
            {
               Image53->Picture->Bitmap = I8Img;
               StaticText53->Caption = "ЕСТЬ";
            }
            else
            {
               Image53->Picture->Bitmap = I7Img;
               StaticText53->Caption = "НЕТ";
            }
         }
         DiagKonc->OnIn[2] = OnIn[2];

         if( OnIn[3] != DiagKonc->OnIn[3] || status != DiagKonc->Status )
         {
            if( OnIn[3] )
            {
               Image54->Picture->Bitmap = I8Img;
               StaticText54->Caption = "ЕСТЬ";
            }
            else
            {
               Image54->Picture->Bitmap = I7Img;
               StaticText54->Caption = "НЕТ";
            }
         }
         DiagKonc->OnIn[3] = OnIn[3];

         if( TsIn[0] != DiagKonc->TsIn[0] || status != DiagKonc->Status )
         {
            if( TsIn[0] )
            {
               Image55->Picture->Bitmap = I5Img;
               StaticText55->Caption = "ЕСТЬ";
            }
            else
            {
               Image55->Picture->Bitmap = I2Img;
               StaticText55->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[0] = TsIn[0];

         if( TsIn[1] != DiagKonc->TsIn[1] || status != DiagKonc->Status )
         {
            if( TsIn[1] )
            {
               Image56->Picture->Bitmap = I5Img;
               StaticText56->Caption = "ЕСТЬ";
            }
            else
            {
               Image56->Picture->Bitmap = I2Img;
               StaticText56->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[1] = TsIn[1];

         if( TsIn[2] != DiagKonc->TsIn[2] || status != DiagKonc->Status )
         {
            if( TsIn[2] )
            {
               Image57->Picture->Bitmap = I5Img;
               StaticText57->Caption = "ЕСТЬ";
            }
            else
            {
               Image57->Picture->Bitmap = I2Img;
               StaticText57->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[2] = TsIn[2];

         if( TsIn[3] != DiagKonc->TsIn[3] || status != DiagKonc->Status )
         {
            if( TsIn[3] )
            {
               Image58->Picture->Bitmap = I5Img;
               StaticText58->Caption = "ЕСТЬ";
            }
            else
            {
               Image58->Picture->Bitmap = I2Img;
               StaticText58->Caption = "НЕТ";
            }
         }
         DiagKonc->TsIn[3] = TsIn[3];

         if( Ts != DiagKonc->Ts || status != DiagKonc->Status )
         {
            if( Ts )
            {
               Image6->Picture->Bitmap = I5Img;
               StaticText7->Caption = "ЕСТЬ";
            }
            else
            {
               Image6->Picture->Bitmap = I2Img;
               StaticText7->Caption = "НЕТ";
            }
         }
         DiagKonc->Ts = Ts;

         if( T != DiagKonc->T || status != DiagKonc->Status )
         {
            if( T )
            {
               Image4->Picture->Bitmap = I5Img;
               StaticText5->Caption = "ЕСТЬ";
            }
            else
            {
               Image4->Picture->Bitmap = I2Img;
               StaticText5->Caption = "НЕТ";
            }
         }
         DiagKonc->T = T;

         if( Dk != DiagKonc->Dk || status != DiagKonc->Status )
         {
            if( Dk )
            {
               Image2->Picture->Bitmap = I4Img;
               StaticText3->Caption = "ЕСТЬ";
            }
            else
            {
               Image2->Picture->Bitmap = I2Img;
               StaticText3->Caption = "НЕТ";
            }
         }
         DiagKonc->Dk = Dk;

         if( DkOut != DiagKonc->DkOut || status != DiagKonc->Status )
         {
            if( DkOut )
            {
               Image3->Picture->Bitmap = I8Img;
               StaticText4->Caption = "ЕСТЬ";
            }
            else
            {
               Image3->Picture->Bitmap = I7Img;
               StaticText4->Caption = "НЕТ";
            }
         }
         DiagKonc->DkOut = DkOut;

         if( Tv != DiagKonc->T || status != DiagKonc->Status )
         {
            if( Tv )
            {
               Image7->Picture->Bitmap = I5Img;
               StaticText8->Caption = "ЕСТЬ";
            }
            else
            {
               Image7->Picture->Bitmap = I2Img;
               StaticText8->Caption = "НЕТ";
            }
         }
         DiagKonc->Tv = Tv;
      }
      else
      {
         if( status != DiagKonc->Status )
         {
            ResetDiagInfo(6);
         }
      }
      DiagRif->Status = status;
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagTochkaInfoNew( int packet[1000], int tF[4][3], int ch )
{
   AnsiString str;
   if( DiagKonc->Adr == 0 ) ResetDiagInfo2(10, ch);
   else
   {
      int Urov[4] = {0,0,0,0};

      bool bit = false;
      if( (packet[5]&0x01) == 0x01 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][1]="Да [1]";
      else AdvStringGrid1->Cells[3][1]="Нет [0]";

      bit = false;
      if( (packet[5]&0x02) == 0x02 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][1]="Да [1]";
      else AdvStringGrid1->Cells[1][1]="Нет [0]";

      bit = false;
      if( (packet[5]&0x04) == 0x04 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][2]="Да [1]";
      else AdvStringGrid1->Cells[3][2]="Нет [0]";

      bit = false;
      if( (packet[5]&0x08) == 0x08 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][2]="Да [1]";
      else AdvStringGrid1->Cells[1][2]="Нет [0]";

      bit = false;
      if( (packet[6]&0x10) == 0x10 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][3]="Да [1]";
      else AdvStringGrid1->Cells[3][3]="Нет [0]";

      bit = false;
      if( (packet[6]&0x20) == 0x20 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][3]="Да [1]";
      else AdvStringGrid1->Cells[1][3]="Нет [0]";

      bit = false;
      if( (packet[6]&0x40) == 0x40 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][4]="Да [1]";
      else AdvStringGrid1->Cells[3][4]="Нет [0]";

      bit = false;
      if( (packet[6]&0x80) == 0x80 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][4]="Да [1]";
      else AdvStringGrid1->Cells[1][4]="Нет [0]";

      bit = false;
      if( (packet[7]&0x01) == 0x01 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[5][1]="Да [1]";
      else AdvStringGrid1->Cells[5][1]="Нет [0]";

      bit = false;
      if( (packet[7]&0x02) == 0x02 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[5][2]="Да [1]";
      else AdvStringGrid1->Cells[5][2]="Нет [0]";

      bit = false;
      if( (packet[7]&0x04) == 0x04 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[5][3]="Да [1]";
      else AdvStringGrid1->Cells[5][3]="Нет [0]";

      bit = false;
      if( (packet[7]&0x08) == 0x08 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[5][4]="Да [1]";
      else AdvStringGrid1->Cells[5][4]="Нет [0]";

      bit = false;
      if( (packet[5]&0x10) == 0x10 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][5]="Есть [1]";
      else AdvStringGrid1->Cells[3][5]="Нет [0]";

      bit = false;
      if( (packet[5]&0x20) == 0x20 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][5]="Есть [1]";
      else AdvStringGrid1->Cells[1][5]="Нет [0]";

      bit = false;
      if( (packet[5]&0x40) == 0x40 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[3][6]="Да [1]";
      else AdvStringGrid1->Cells[3][6]="Нет [0]";

      bit = false;
      if( (packet[5]&0x80) == 0x80 ) bit = true; 
      if( bit ) AdvStringGrid1->Cells[1][6]="Да [1]";
      else AdvStringGrid1->Cells[1][6]="Нет [0]";

      int bit0 = 0;
      int bit1 = 0;
      int Ur = 0;

      int n = 8;

      if( ch == 1 || ch == 2 )
      {
          bit0 = packet[n]&0x00FF;
          bit1 = packet[n+1]&0x00FF;
          Ur = bit0<<8;
          Ur = Ur + bit1;
          Urov[0] = Ur;

          if( Ur == 50000 )
          {
            AdvStringGrid1->Cells[3][8]="-";
            AdvStringGrid1->Cells[3][9]="-";
            AdvStringGrid1->Cells[3][10]="-";
          }
          else if( Ur == 50001 )
          {
            AdvStringGrid1->Cells[3][8]="-";
            AdvStringGrid1->Cells[3][9]="-";
            AdvStringGrid1->Cells[3][10]="-";
          }
          else
          {
            AdvStringGrid1->Cells[3][8]=Ur;
            AdvStringGrid1->Cells[3][9]=Ur;
            AdvStringGrid1->Cells[3][10]=Ur;
          }

          bit = false;
          if( (packet[n+8]&0x01) == 0x01 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][8]="Да [1]";
          else AdvStringGrid1->Cells[1][8]="Нет [0]";

          bit = false;
          if( (packet[n+8]&0x02) == 0x02 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][9]="Да [1]";
          else AdvStringGrid1->Cells[1][9]="Нет [0]";

          bit = false;
          if( (packet[n+8]&0x04) == 0x04 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][10]="Да [1]";
          else AdvStringGrid1->Cells[1][10]="Нет [0]";

          bit0 = 0;
          bit0 = packet[n+2]&0x00FF;
          bit1 = 0;
          bit1 = packet[n+3]&0x00FF;
          Ur = 0;
          Ur = bit0<<8;
          Ur = Ur + bit1;
          Urov[1] = Ur;

          if( Ur == 50000 )
          {
            AdvStringGrid1->Cells[3][12]="-";
            AdvStringGrid1->Cells[3][13]="-";
            AdvStringGrid1->Cells[3][14]="-";
          }
          else if( Ur == 50001 )
          {
            AdvStringGrid1->Cells[3][12]="-";
            AdvStringGrid1->Cells[3][13]="-";
            AdvStringGrid1->Cells[3][14]="-";
          }
          else
          {
            AdvStringGrid1->Cells[3][12]=Ur;
            AdvStringGrid1->Cells[3][13]=Ur;
            AdvStringGrid1->Cells[3][14]=Ur;
          }

          bit = false;
          if( (packet[n+8]&0x08) == 0x08 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][12]="Да [1]";
          else AdvStringGrid1->Cells[1][12]="Нет [0]";

          bit = false;
          if( (packet[n+8]&0x10) == 0x10 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][13]="Да [1]";
          else AdvStringGrid1->Cells[1][13]="Нет [0]";

          bit = false;
          if( (packet[n+8]&0x20) == 0x20 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][14]="Да [1]";
          else AdvStringGrid1->Cells[1][14]="Нет [0]";
      }
      else
      {
          bit0 = packet[n+4]&0x00FF;
          bit1 = packet[n+5]&0x00FF;
          Ur = bit0<<8;
          Ur = Ur + bit1;
          Urov[2] = Ur;

          if( Ur == 50000 )
          {
            AdvStringGrid1->Cells[3][8]="-";
            AdvStringGrid1->Cells[3][9]="-";
            AdvStringGrid1->Cells[3][10]="-";
          }
          else if( Ur == 50001 )
          {
            AdvStringGrid1->Cells[3][8]="-";
            AdvStringGrid1->Cells[3][9]="-";
            AdvStringGrid1->Cells[3][10]="-";
          }
          else
          {
            AdvStringGrid1->Cells[3][8]=Ur;
            AdvStringGrid1->Cells[3][9]=Ur;
            AdvStringGrid1->Cells[3][10]=Ur;
          }

          bit = false;
          if( (packet[n+9]&0x01) == 0x01 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][8]="Да [1]";
          else  AdvStringGrid1->Cells[1][8]="Нет [0]";

          bit = false;
          if( (packet[n+9]&0x02) == 0x02 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][9]="Да [1]";
          else  AdvStringGrid1->Cells[1][9]="Нет [0]";

          bit = false;
          if( (packet[n+9]&0x04) == 0x04 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][10]="Да [1]";
          else AdvStringGrid1->Cells[1][10]="Нет [0]";

          bit0 = 0;
          bit0 = packet[n+6]&0x00FF;
          bit1 = 0;
          bit1 = packet[n+7]&0x00FF;
          Ur = 0;
          Ur = bit0<<8;
          Ur = Ur + bit1;
          Urov[3] = Ur;

          if( Ur == 50000 )
          {
            AdvStringGrid1->Cells[3][12]="-";
            AdvStringGrid1->Cells[3][13]="-";
            AdvStringGrid1->Cells[3][14]="-";
          }
          else if( Ur == 50001 )
          {
            AdvStringGrid1->Cells[3][12]="-";
            AdvStringGrid1->Cells[3][13]="-";
            AdvStringGrid1->Cells[3][14]="-";
          }
          else
          {
            AdvStringGrid1->Cells[3][12]=Ur;
            AdvStringGrid1->Cells[3][13]=Ur;
            AdvStringGrid1->Cells[3][14]=Ur;
          }

          bit = false;
          if( (packet[n+9]&0x08) == 0x08 ) bit = true; 
          if( bit )  AdvStringGrid1->Cells[1][12]="Да [1]";
          else AdvStringGrid1->Cells[1][12]="Нет [0]";

          bit = false;
          if( (packet[n+9]&0x10) == 0x10 ) bit = true;
          if( bit ) AdvStringGrid1->Cells[1][13]="Да [1]";
          else AdvStringGrid1->Cells[1][13]="Нет [0]";

          bit = false;
          if( (packet[n+9]&0x20) == 0x20 ) bit = true; 
          if( bit ) AdvStringGrid1->Cells[1][14]="Да [1]";
          else AdvStringGrid1->Cells[1][14]="Нет [0]";
      }

      if( ch == 1 || ch == 2 )
      {
          /* ЧЭ1 */
          if( (tF[0][0]==0) && (tF[0][1]==0) && (tF[0][2]==0) ) AdvStringGrid1->Cells[1][7]="Выкл";
          else
          {
             if( Urov[0] == 50000 ) AdvStringGrid1->Cells[1][7]="Замыкание кабеля";
             else if( Urov[0] == 50001 ) AdvStringGrid1->Cells[1][7]="Обрыв кабеля";
             else AdvStringGrid1->Cells[1][7]="Норма";
          }

          /* ЧЭ2 */
          if( (tF[1][0]==0) && (tF[1][1]==0) && (tF[1][2]==0) ) AdvStringGrid1->Cells[1][11]="Выкл";
          else
          {
             if( Urov[1] == 50000 ) AdvStringGrid1->Cells[1][11]="Замыкание кабеля";
             else if( Urov[1] == 50001 ) AdvStringGrid1->Cells[1][11]="Обрыв кабеля";
             else AdvStringGrid1->Cells[1][11]="Норма";
         }
      }
      else
      {
          /* ЧЭ3 */
          if( (tF[2][0]==0) && (tF[2][1]==0) && (tF[2][2]==0) ) AdvStringGrid1->Cells[1][7]="Выкл";
          else
          {
             if( Urov[2] == 50000 ) AdvStringGrid1->Cells[1][7]="Замыкание кабеля";
             else if( Urov[2] == 50001 ) AdvStringGrid1->Cells[1][7]="Обрыв кабеля";
             else AdvStringGrid1->Cells[1][7]="Норма";
          }

          /* ЧЭ4 */
          if( (tF[3][0]==0) && (tF[3][1]==0) && (tF[3][2]==0) ) AdvStringGrid1->Cells[1][11]="Выкл";
          else
          {
             if( Urov[3] == 50000 ) AdvStringGrid1->Cells[1][11]="Замыкание кабеля";
             else if( Urov[3] == 50001 ) AdvStringGrid1->Cells[1][11]="Обрыв кабеля";
             else AdvStringGrid1->Cells[1][11]="Норма";
          }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ResetDiagInfo2(int type, int ch)
{
   GroupBox10->Caption = "Диагностика";
   GroupBox10->Height = 368;

   AdvStringGrid1->ColCount = 4;
   AdvStringGrid1->DefaultColWidth = 150;
   AdvStringGrid1->ColWidths[1] = 100;
   AdvStringGrid1->ColWidths[3] = 100;

   AdvStringGrid1->DefaultRowHeight = 21;
//   AdvStringGrid1->RowHeights[0] = 21;

   AdvStringGrid1->Cells[0][0]="Параметр";
   AdvStringGrid1->Cells[1][0]="Значение";
   AdvStringGrid1->Cells[2][0]="Параметр";
   AdvStringGrid1->Cells[3][0]="Значение";

   AdvStringGrid1->RowCount = 2;
   AdvStringGrid1->ClearRows(1,1);

   if( type == 1 )
   {
     GroupBox10->Caption = "Диагностика: РИФ-РЛМ(КРЛ),Трасса";

      AdvStringGrid1->RowCount = 7;
      AdvStringGrid1->ClearRows(1,6);

      AdvStringGrid1->Cells[0][1]="Состояние";
      AdvStringGrid1->Cells[0][2]="Тревога";
      AdvStringGrid1->Cells[2][2]="Выход \"Тревога\"";
      AdvStringGrid1->Cells[0][3]="Сработка";
      AdvStringGrid1->Cells[0][4]="Вскрытие";
      AdvStringGrid1->Cells[2][4]="Вход \"Вскрытие\"";
      AdvStringGrid1->Cells[0][5]="ДК";
      AdvStringGrid1->Cells[2][5]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][6]="Уровень";
   }
   else if( type == RifRlmSType )
   {
      GroupBox10->Caption = "Диагностика: РИФ-РЛМ-С";

      AdvStringGrid1->RowCount = 11;
      AdvStringGrid1->ClearRows(1,10);

      AdvStringGrid1->Cells[0][1]="Состояние";
      AdvStringGrid1->Cells[0][2]="Тревога";
      AdvStringGrid1->Cells[2][2]="Выход \"Тревога\"";
      AdvStringGrid1->Cells[0][3]="Сработка";
      AdvStringGrid1->Cells[0][4]="ДК";
      AdvStringGrid1->Cells[2][4]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][5]="Синхронизация";
      AdvStringGrid1->Cells[0][6]="Низкий уровень";

      AdvStringGrid1->Cells[0][7]="Уровень";

      AdvStringGrid1->Cells[0][8]="Пороги";
      AdvStringGrid1->Cells[0][9]="Период тактир-я";

      AdvStringGrid1->Cells[0][10]="Режим обработки";
   }
   else if( type == 10 )
   {
      GroupBox10->Caption = "Диагностика: Точка/Гарда";

      AdvStringGrid1->ColCount = 6;
      AdvStringGrid1->ColWidths[1] = 100;
      AdvStringGrid1->ColWidths[3] = 100;
      AdvStringGrid1->ColWidths[5] = 100;
//      AdvStringGrid1->ColWidths[7] = 100;

      AdvStringGrid1->RowCount = 15;
      AdvStringGrid1->ClearRows(1,14);

      AdvStringGrid1->Cells[0][0]="Параметр";
      AdvStringGrid1->Cells[1][0]="Значение";
      AdvStringGrid1->Cells[2][0]="Параметр";
      AdvStringGrid1->Cells[3][0]="Значение";
      AdvStringGrid1->Cells[4][0]="Параметр";
      AdvStringGrid1->Cells[5][0]="Значение";
//      AdvStringGrid1->Cells[6][0]="Параметр";
//      AdvStringGrid1->Cells[7][0]="Значение";

      AdvStringGrid1->Cells[0][1]="Сработка ЧЭ1";
      AdvStringGrid1->Cells[2][1]="Выход \"Тревога ЧЭ1\"";
      AdvStringGrid1->Cells[4][1]="Сработка со стороны ЧЭ1";
      AdvStringGrid1->Cells[0][2]="Сработка ЧЭ2";
      AdvStringGrid1->Cells[2][2]="Выход \"Тревога ЧЭ2\"";
      AdvStringGrid1->Cells[4][2]="Сработка со стороны ЧЭ2";
      AdvStringGrid1->Cells[0][3]="Сработка ЧЭ3";
      AdvStringGrid1->Cells[2][3]="Выход \"Тревога ЧЭ3\"";
      AdvStringGrid1->Cells[4][3]="Сработка со стороны ЧЭ3";
      AdvStringGrid1->Cells[0][4]="Сработка ЧЭ4";
      AdvStringGrid1->Cells[2][4]="Выход \"Тревога ЧЭ4\"";
      AdvStringGrid1->Cells[4][4]="Сработка со стороны ЧЭ4";
      AdvStringGrid1->Cells[0][5]="ДК";
      AdvStringGrid1->Cells[2][5]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][6]="Вскрытие";
      AdvStringGrid1->Cells[2][6]="Вход \"Вскрытие\"";

      if( ch == 1 || ch == 2 )
      {
         AdvStringGrid1->Cells[0][7]="ЧЭ1";
         AdvStringGrid1->Cells[0][11]="ЧЭ2";
      }
      else
      {
         AdvStringGrid1->Cells[0][7]="ЧЭ3";
         AdvStringGrid1->Cells[0][11]="ЧЭ4";
      }

      AdvStringGrid1->Cells[0][8]="Фильтр1: Сработка";
      AdvStringGrid1->Cells[2][8]="Уровень";
      AdvStringGrid1->Cells[4][8]="Порог";
//      AdvStringGrid1->Cells[6][8]="Порог реал.";
      AdvStringGrid1->Cells[0][9]="Фильтр2: Сработка";
      AdvStringGrid1->Cells[2][9]="Уровень";
      AdvStringGrid1->Cells[4][9]="Порог";
//      AdvStringGrid1->Cells[6][9]="Порог реал.";
      AdvStringGrid1->Cells[0][10]="Фильтр3: Сработка";
      AdvStringGrid1->Cells[2][10]="Уровень";
      AdvStringGrid1->Cells[4][10]="Порог";
//      AdvStringGrid1->Cells[6][10]="Порог реал.";

      AdvStringGrid1->Cells[0][12]="Фильтр1: Сработка";
      AdvStringGrid1->Cells[2][12]="Уровень";
      AdvStringGrid1->Cells[4][12]="Порог";
//      AdvStringGrid1->Cells[6][12]="Порог реал.";
      AdvStringGrid1->Cells[0][13]="Фильтр2: Сработка";
      AdvStringGrid1->Cells[2][13]="Уровень";
      AdvStringGrid1->Cells[4][13]="Порог";
//      AdvStringGrid1->Cells[6][13]="Порог реал.";
      AdvStringGrid1->Cells[0][14]="Фильтр3: Сработка";
      AdvStringGrid1->Cells[2][14]="Уровень";
      AdvStringGrid1->Cells[4][14]="Порог";
//      AdvStringGrid1->Cells[6][14]="Порог реал.";
   }
   else if( type == 33 )
   {
      GroupBox10->Caption = "Диагностика: ССОИ(интерфейсн.)";

      AdvStringGrid1->ColCount = 6;
      AdvStringGrid1->ColWidths[1] = 100;
      AdvStringGrid1->ColWidths[3] = 100;
      AdvStringGrid1->ColWidths[5] = 100;

      AdvStringGrid1->RowCount = 14;
      AdvStringGrid1->ClearRows(1,13);

      AdvStringGrid1->Cells[0][0]="Параметр";
      AdvStringGrid1->Cells[1][0]="Значение";
      AdvStringGrid1->Cells[2][0]="Параметр";
      AdvStringGrid1->Cells[3][0]="Значение";
      AdvStringGrid1->Cells[4][0]="Параметр";
      AdvStringGrid1->Cells[5][0]="Значение";

      AdvStringGrid1->Cells[0][1]="Тревога";
      AdvStringGrid1->Cells[0][2]="Вскрытие";
      AdvStringGrid1->Cells[2][2]="Вход \"Вскрытие\"";
      AdvStringGrid1->Cells[0][3]="ДК";
      AdvStringGrid1->Cells[2][3]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][4]="ИУ1";
      AdvStringGrid1->Cells[2][4]="ИУ2";
      AdvStringGrid1->Cells[4][4]="ИУ3";
      AdvStringGrid1->Cells[0][5]="ВК1";
      AdvStringGrid1->Cells[2][5]="ВК2";
      AdvStringGrid1->Cells[4][5]="ВК3";

      AdvStringGrid1->Cells[0][6]="Вход \"Сработка1\"";
      AdvStringGrid1->Cells[2][6]="Вход \"Тревога1\"";
      AdvStringGrid1->Cells[0][7]="Вход \"Сработка2\"";
      AdvStringGrid1->Cells[2][7]="Вход \"Тревога2\"";
      AdvStringGrid1->Cells[0][8]="Вход \"Сработка3\"";
      AdvStringGrid1->Cells[2][8]="Вход \"Тревога3\"";
      AdvStringGrid1->Cells[0][9]="Вход \"Сработка4\"";
      AdvStringGrid1->Cells[2][9]="Вход \"Тревога4\"";
      AdvStringGrid1->Cells[0][10]="Вход \"Сработка5\"";
      AdvStringGrid1->Cells[2][10]="Вход \"Тревога5\"";
      AdvStringGrid1->Cells[0][11]="Вход \"Сработка6\"";
      AdvStringGrid1->Cells[2][11]="Вход \"Тревога6\"";
      AdvStringGrid1->Cells[0][12]="Вход \"Сработка7\"";
      AdvStringGrid1->Cells[2][12]="Вход \"Тревога7\"";
      AdvStringGrid1->Cells[0][13]="Вход \"Сработка8\"";
      AdvStringGrid1->Cells[2][13]="Вход \"Тревога8\"";
   }
   else if( type == SdIpBlType || type == IuIpBlType )
   {
      GroupBox10->Caption = "Диагностика: БЛ-IP";

      AdvStringGrid1->ColCount = 3;
      AdvStringGrid1->ColWidths[0] = 60;
      AdvStringGrid1->ColWidths[1] = 150;
      AdvStringGrid1->ColWidths[2] = 150;

      AdvStringGrid1->RowCount = 15;
      AdvStringGrid1->ClearRows(1,14);

      AdvStringGrid1->Cells[1][0]="Вход";
      AdvStringGrid1->Cells[2][0]="Статус";

      AdvStringGrid1->Cells[0][1]="СД1";
      AdvStringGrid1->Cells[0][2]="СД2";
      AdvStringGrid1->Cells[0][3]="СД3";
      AdvStringGrid1->Cells[0][4]="СД4";
      AdvStringGrid1->Cells[0][5]="СД5";
      AdvStringGrid1->Cells[0][6]="СД6";
      AdvStringGrid1->Cells[0][7]="СД7";
      AdvStringGrid1->Cells[0][8]="СД8";

      AdvStringGrid1->Cells[1][9]="Выход";
      AdvStringGrid1->Cells[2][9]="Статус";

      AdvStringGrid1->Cells[0][10]="ДК";

      AdvStringGrid1->Cells[0][11]="ИУ1";
      AdvStringGrid1->Cells[0][12]="ИУ2";
      AdvStringGrid1->Cells[0][13]="ИУ3";
      AdvStringGrid1->Cells[0][14]="ИУ4";
   }
}
//---------------------------------------------------------------------------
void TMainForm::ResetDiagInfo( int type )
{
   ResetDiagInfo2( type, 1 );

   GroupBox4->Caption = "Диагностика";

   Label1->Visible = false;
   Label2->Visible = false;
   Label3->Visible = false;
   Label4->Visible = false;
   Label5->Visible = false;
   Label6->Visible = false;
   Label7->Visible = false;
   Label8->Visible = false;
   Label9->Visible = false;
   Label34->Visible = false;
   Label35->Visible = false;
   Label36->Visible = false;
   Label43->Visible = false;
   Label44->Visible = false;
   Label45->Visible = false;
   Label46->Visible = false;
   Label47->Visible = false;
   Label48->Visible = false;
   Label49->Visible = false;
   Label50->Visible = false;
   Label51->Visible = false;
   Label52->Visible = false;
   Label53->Visible = false;
   Label54->Visible = false;
   Label55->Visible = false;
   Label56->Visible = false;
   Label57->Visible = false;
   Label58->Visible = false;
   Label59->Visible = false;
   Label60->Visible = false;
   Label61->Visible = false;
   Label62->Visible = false;
   Label63->Visible = false;
   Label64->Visible = false;
   Label65->Visible = false;
   Label66->Visible = false;
   Label67->Visible = false;
   Label68->Visible = false;
   Label69->Visible = false;
   Label70->Visible = false;
   Label71->Visible = false;
   Label72->Visible = false;
   Label73->Visible = false;
   Label74->Visible = false;
   Label77->Visible = false;
   Label78->Visible = false;
   Label79->Visible = false;
   Label80->Visible = false;
   Label81->Visible = false;
   Label82->Visible = false;
   Label83->Visible = false;
   Label84->Visible = false;
   Label85->Visible = false;
   Label86->Visible = false;
   Label87->Visible = false;
   Label88->Visible = false;
   Label89->Visible = false;
   Label90->Visible = false;
   Label91->Visible = false;
   Label92->Visible = false;
   Label95->Visible = false;
   Label96->Visible = false;
   Label97->Visible = false;
   Label98->Visible = false;
   Label99->Visible = false;
   Label100->Visible = false;
   Label101->Visible = false;
   Label102->Visible = false;
   Label103->Visible = false;
   Label292->Visible = false;
   Label293->Visible = false;
   Label294->Visible = false;
   Label295->Visible = false;
   Label296->Visible = false;
   Label297->Visible = false;
   Label298->Visible = false;
   Label299->Visible = false;
   Label300->Visible = false;
   Label301->Visible = false;
   Label302->Visible = false;
   Label303->Visible = false;
   Label304->Visible = false;
   Label305->Visible = false;
   Label306->Visible = false;
   Label307->Visible = false;

   Image1->Visible = false;
   Image2->Visible = false;
   Image3->Visible = false;
   Image4->Visible = false;
   Image5->Visible = false;
   Image6->Visible = false;
   Image7->Visible = false;
   Image8->Visible = false;
   Image13->Visible = false;
   Image51->Visible = false;
   Image52->Visible = false;
   Image53->Visible = false;
   Image54->Visible = false;
   Image55->Visible = false;
   Image56->Visible = false;
   Image57->Visible = false;
   Image58->Visible = false;
   Image59->Visible = false;
   Image60->Visible = false;
   Image61->Visible = false;
   Image62->Visible = false;
   Image69->Visible = false;
   Image70->Visible = false;
   Image71->Visible = false;
   Image72->Visible = false;
   Image75->Visible = false;
   Image76->Visible = false;
   Image77->Visible = false;
   Image78->Visible = false;
   Image79->Visible = false;
   Image80->Visible = false;
   Image81->Visible = false;
   Image82->Visible = false;
   Image83->Visible = false;
   Image84->Visible = false;
   Image293->Visible = false;
   Image294->Visible = false;
   Image297->Visible = false;
   Image298->Visible = false;
   Image301->Visible = false;
   Image302->Visible = false;
   Image305->Visible = false;
   Image306->Visible = false;

   StaticText2->Visible = false;
   StaticText3->Visible = false;
   StaticText4->Visible = false;
   StaticText5->Visible = false;
   StaticText6->Visible = false;
   StaticText7->Visible = false;
   StaticText8->Visible = false;
   StaticText9->Visible = false;
   StaticText10->Visible = false;
   StaticText12->Visible = false;
   StaticText13->Visible = false;
   StaticText14->Visible = false;
   StaticText17->Visible = false;
   StaticText18->Visible = false;
   StaticText19->Visible = false;
   StaticText20->Visible = false;
   StaticText21->Visible = false;
   StaticText22->Visible = false;
   StaticText23->Visible = false;
   StaticText24->Visible = false;
   StaticText25->Visible = false;
   StaticText26->Visible = false;
   StaticText27->Visible = false;
   StaticText28->Visible = false;
   StaticText51->Visible = false;
   StaticText52->Visible = false;
   StaticText53->Visible = false;
   StaticText54->Visible = false;
   StaticText55->Visible = false;
   StaticText56->Visible = false;
   StaticText57->Visible = false;
   StaticText58->Visible = false;
   StaticText59->Visible = false;
   StaticText60->Visible = false;
   StaticText61->Visible = false;
   StaticText62->Visible = false;
   StaticText69->Visible = false;
   StaticText70->Visible = false;
   StaticText71->Visible = false;
   StaticText72->Visible = false;
   StaticText11->Visible = false;
   StaticText75->Visible = false;
   StaticText76->Visible = false;
   StaticText77->Visible = false;
   StaticText78->Visible = false;
   StaticText79->Visible = false;
   StaticText80->Visible = false;
   StaticText81->Visible = false;
   StaticText82->Visible = false;
   StaticText83->Visible = false;
   StaticText84->Visible = false;
   StaticText95->Visible = false;
   StaticText96->Visible = false;
   StaticText97->Visible = false;
   StaticText98->Visible = false;
   StaticText99->Visible = false;
   StaticText100->Visible = false;
   StaticText101->Visible = false;
   StaticText102->Visible = false;
   StaticText103->Visible = false;
   StaticText293->Visible = false;
   StaticText294->Visible = false;
   StaticText295->Visible = false;
   StaticText297->Visible = false;
   StaticText298->Visible = false;
   StaticText299->Visible = false;
   StaticText301->Visible = false;
   StaticText302->Visible = false;
   StaticText303->Visible = false;
   StaticText305->Visible = false;
   StaticText306->Visible = false;
   StaticText307->Visible = false;

   Image1->Picture->Bitmap = I1Img;
   Image2->Picture->Bitmap = I1Img;
   Image3->Picture->Bitmap = I1Img;
   Image4->Picture->Bitmap = I1Img;
   Image5->Picture->Bitmap = I1Img;
   Image6->Picture->Bitmap = I1Img;
   Image7->Picture->Bitmap = I1Img;
   Image8->Picture->Bitmap = I1Img;
   Image13->Picture->Bitmap = I1Img;
   Image51->Picture->Bitmap = I1Img;
   Image52->Picture->Bitmap = I1Img;
   Image53->Picture->Bitmap = I1Img;
   Image54->Picture->Bitmap = I1Img;
   Image55->Picture->Bitmap = I1Img;
   Image56->Picture->Bitmap = I1Img;
   Image57->Picture->Bitmap = I1Img;
   Image58->Picture->Bitmap = I1Img;
   Image59->Picture->Bitmap = I1Img;
   Image60->Picture->Bitmap = I1Img;
   Image61->Picture->Bitmap = I1Img;
   Image62->Picture->Bitmap = I1Img;
   Image69->Picture->Bitmap = I1Img;
   Image70->Picture->Bitmap = I1Img;
   Image71->Picture->Bitmap = I1Img;
   Image72->Picture->Bitmap = I1Img;
   Image75->Picture->Bitmap = I1Img;
   Image76->Picture->Bitmap = I1Img;
   Image77->Picture->Bitmap = I1Img;
   Image78->Picture->Bitmap = I1Img;
   Image79->Picture->Bitmap = I1Img;
   Image80->Picture->Bitmap = I1Img;
   Image81->Picture->Bitmap = I1Img;
   Image82->Picture->Bitmap = I1Img;
   Image83->Picture->Bitmap = I1Img;
   Image84->Picture->Bitmap = I1Img;
   Image293->Picture->Bitmap = I1Img;
   Image294->Picture->Bitmap = I1Img;
   Image297->Picture->Bitmap = I1Img;
   Image298->Picture->Bitmap = I1Img;
   Image301->Picture->Bitmap = I1Img;
   Image302->Picture->Bitmap = I1Img;
   Image305->Picture->Bitmap = I1Img;
   Image306->Picture->Bitmap = I1Img;

   StaticText2->Caption = "???";
   StaticText3->Caption = "???";
   StaticText4->Caption = "???";
   StaticText5->Caption = "???";
   StaticText6->Caption = "???";
   StaticText7->Caption = "???";
   StaticText8->Caption = "???";
   StaticText9->Caption = "???";
   StaticText10->Caption = "???";
   StaticText12->Caption = "???";
   StaticText13->Caption = "???";
   StaticText14->Caption = "???";
   StaticText17->Caption = "???";
   StaticText18->Caption = "???";
   StaticText19->Caption = "???";
   StaticText20->Caption = "???";
   StaticText21->Caption = "???";
   StaticText22->Caption = "???";
   StaticText23->Caption = "???";
   StaticText24->Caption = "???";
   StaticText25->Caption = "???";
   StaticText26->Caption = "???";
   StaticText27->Caption = "???";
   StaticText28->Caption = "???";
   StaticText51->Caption = "???";
   StaticText52->Caption = "???";
   StaticText53->Caption = "???";
   StaticText54->Caption = "???";
   StaticText55->Caption = "???";
   StaticText56->Caption = "???";
   StaticText57->Caption = "???";
   StaticText58->Caption = "???";
   StaticText59->Caption = "???";
   StaticText60->Caption = "???";
   StaticText61->Caption = "???";
   StaticText62->Caption = "???";
   StaticText69->Caption = "???";
   StaticText70->Caption = "???";
   StaticText71->Caption = "???";
   StaticText72->Caption = "???";
   StaticText75->Caption = "???";
   StaticText76->Caption = "???";
   StaticText77->Caption = "???";
   StaticText78->Caption = "???";
   StaticText79->Caption = "???";
   StaticText80->Caption = "???";
   StaticText81->Caption = "???";
   StaticText82->Caption = "???";
   StaticText83->Caption = "???";
   StaticText84->Caption = "???";
   StaticText95->Caption = "???";
   StaticText96->Caption = "???";
   StaticText97->Caption = "???";
   StaticText98->Caption = "???";
   StaticText99->Caption = "???";
   StaticText100->Caption = "???";
   StaticText101->Caption = "???";
   StaticText102->Caption = "???";
   StaticText293->Caption = "???";
   StaticText294->Caption = "???";
   StaticText295->Caption = "???";
   StaticText297->Caption = "???";
   StaticText298->Caption = "???";
   StaticText299->Caption = "???";
   StaticText301->Caption = "???";
   StaticText302->Caption = "???";
   StaticText303->Caption = "???";
   StaticText305->Caption = "???";
   StaticText306->Caption = "???";
   StaticText307->Caption = "???";

   Bevel1->Visible = false;
   Bevel2->Visible = false;
   Bevel3->Visible = false;
   Bevel4->Visible = false;

   if( type == 1 )
   {
      GroupBox4->Caption = "Диагностика-РИФ-РЛМ(КРЛ),Трасса";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Состояние";
      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label7->Left = 8; Label7->Top = 121;
      Label7->Caption = "Вскрытие";
      Label2->Left = 8; Label2->Top = 153;
      Label2->Caption = "ДК";
      Label9->Left = 8; Label9->Top = 185;
      Label9->Caption = "Уровень";
      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Выход \"Тревога\"";
      Label8->Left = 168; Label8->Top = 121;
      Label8->Caption = "Вход \"Вскрытие\"";
      Label3->Left = 168; Label3->Top = 153;
      Label3->Caption = "Вход \"ДК\"";

      Label1->Visible = true;
      Label2->Visible = true;
      Label3->Visible = true;
      Label4->Visible = true;
      Label5->Visible = true;
      Label6->Visible = true;
      Label7->Visible = true;
      Label8->Visible = true;
      Label9->Visible = true;

      Image1->Left = 88; Image1->Top = 24;
      Image4->Left = 88; Image4->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image7->Left = 88; Image7->Top = 120;
      Image2->Left = 88; Image2->Top = 152;
      Image5->Left = 264; Image5->Top = 56;
      Image8->Left = 264; Image8->Top = 120;
      Image3->Left = 264; Image3->Top = 152;

      Image1->Visible = true;
      Image2->Visible = true;
      Image3->Visible = true;
      Image4->Visible = true;
      Image5->Visible = true;
      Image6->Visible = true;
      Image7->Visible = true;
      Image8->Visible = true;

      StaticText2->Left = 112; StaticText2->Top = 24;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText8->Left = 112; StaticText8->Top = 120;
      StaticText3->Left = 112; StaticText3->Top = 152;
      StaticText10->Left = 112; StaticText10->Top = 184;
      StaticText6->Left = 288; StaticText6->Top = 56;
      StaticText9->Left = 288; StaticText9->Top = 120;
      StaticText4->Left = 288; StaticText4->Top = 152;

      StaticText2->Visible = true;
      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText5->Visible = true;
      StaticText6->Visible = true;
      StaticText7->Visible = true;
      StaticText8->Visible = true;
      StaticText9->Visible = true;
      StaticText10->Visible = true;
   }
   else if( type == 8 )
   {
      GroupBox4->Caption = "Диагностика-Торос";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Состояние";
      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label5->Left = 8; Label5->Top = 121;
      Label5->Caption = "Сработка-1";
      Label3->Left = 8; Label3->Top = 153;
      Label3->Caption = "Сработка-2";
      Label7->Left = 168; Label7->Top = 57;
      Label7->Caption = "Выход \"Тревога-1\"";
      Label2->Left = 8; Label2->Top = 185;
      Label2->Caption = "ДК";
      Label9->Left = 8; Label9->Top = 217;
      Label9->Caption = "Уровень";
      Label8->Left = 344; Label8->Top = 57;
      Label8->Caption = "Выход \"Тревога-2\"";

      Label1->Visible = true;
      Label2->Visible = true;
      Label3->Visible = true;
      Label4->Visible = true;
      Label5->Visible = true;
      Label6->Visible = true;
      Label7->Visible = true;
      Label8->Visible = true;
      Label9->Visible = true;

      Image1->Left = 88; Image1->Top = 24;
      Image4->Left = 88; Image4->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image5->Left = 88; Image5->Top = 120;
      Image3->Left = 88; Image3->Top = 152;
      Image7->Left = 264; Image7->Top = 56;
      Image2->Left = 88; Image2->Top = 184;
      Image8->Left = 448; Image8->Top = 56;

      Image1->Visible = true;
      Image2->Visible = true;
      Image3->Visible = true;
      Image4->Visible = true;
      Image5->Visible = true;
      Image6->Visible = true;
      Image7->Visible = true;
      Image8->Visible = true;

      StaticText2->Left = 112; StaticText2->Top = 24;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText6->Left = 112; StaticText6->Top = 120;
      StaticText4->Left = 112; StaticText4->Top = 152;
      StaticText8->Left = 288; StaticText8->Top = 56;
      StaticText3->Left = 112; StaticText3->Top = 184;
      StaticText10->Left = 112; StaticText10->Top = 216;
      StaticText9->Left = 472; StaticText9->Top = 56;

      StaticText2->Visible = true;
      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText5->Visible = true;
      StaticText6->Visible = true;
      StaticText7->Visible = true;
      StaticText8->Visible = true;
      StaticText9->Visible = true;
      StaticText10->Visible = true;
   }
   else if( type == 9 )
   {
      GroupBox4->Caption = "Диагностика-Наст";

      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label8->Left = 8; Label8->Top = 121;
      Label8->Caption = "Сраб. \"чужой\"";
      Label3->Left = 8; Label3->Top = 153;
      Label3->Caption = "Сраб. \"свой\"";
      Label2->Left = 8; Label2->Top = 185;
      Label2->Caption = "ДК";
      Label51->Left = 8; Label51->Top = 217;
      Label51->Caption = "Раб. с пультом";
      Label52->Left = 8; Label52->Top = 249;
      Label52->Caption = "Синхронизация";
      Label53->Left = 8; Label53->Top = 281;
      Label53->Caption = "Уров. \"чужой\"";
      Label54->Left = 8; Label54->Top = 321;
      Label54->Caption = "Уров. \"свой\"";
      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Выход \"Тревога\"";

      Label2->Visible = true;
      Label3->Visible = true;
      Label4->Visible = true;
      Label5->Visible = true;
      Label8->Visible = true;
      Label6->Visible = true;
      Label51->Visible = true;
      Label52->Visible = true;
      Label53->Visible = true;
      Label54->Visible = true;

      Image4->Left = 88; Image4->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image8->Left = 88; Image8->Top = 120;
      Image3->Left = 88; Image3->Top = 152;
      Image2->Left = 88; Image2->Top = 184;
      Image51->Left = 88; Image51->Top = 216;
      Image52->Left = 88; Image52->Top = 248;
      Image5->Left = 264; Image5->Top = 56;

      Image2->Visible = true;
      Image3->Visible = true;
      Image4->Visible = true;
      Image5->Visible = true;
      Image8->Visible = true;
      Image6->Visible = true;
      Image51->Visible = true;
      Image52->Visible = true;

      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText9->Left = 112; StaticText9->Top = 120;
      StaticText4->Left = 112; StaticText4->Top = 152;
      StaticText3->Left = 112; StaticText3->Top = 184;
      StaticText51->Left = 112; StaticText51->Top = 216;
      StaticText52->Left = 112; StaticText52->Top = 248;
      StaticText53->Left = 112; StaticText53->Top = 280;
      StaticText54->Left = 112; StaticText54->Top = 320;
      StaticText6->Left = 288; StaticText6->Top = 56;

      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText5->Visible = true;
      StaticText6->Visible = true;
      StaticText7->Visible = true;
      StaticText8->Visible = true;
      StaticText9->Visible = true;
      StaticText51->Visible = true;
      StaticText52->Visible = true;
      StaticText53->Visible = true;
      StaticText54->Visible = true;
   }
   else if( type == 91 )
   {
      GroupBox4->Caption = "Диагностика-Радар";

      Label3->Left = 168; Label3->Top = 185;
      Label3->Caption = "Вход \"ДК\"";
      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label2->Left = 8; Label2->Top = 185;
      Label2->Caption = "ДК";
      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Выход \"Тревога\"";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label55->Left = 8; Label55->Top = 321;
      Label55->Caption = "Сработка-1";
      Label56->Left = 8; Label56->Top = 353;
      Label56->Caption = "Сработка-2";
      Label57->Left = 8; Label57->Top = 385;
      Label57->Caption = "Сработка-3";
      Label52->Left = 8; Label52->Top = 217;
      Label52->Caption = "Уровень-1";
      Label53->Left = 8; Label53->Top = 249;
      Label53->Caption = "Уровень-2";
      Label54->Left = 8; Label54->Top = 281;
      Label54->Caption = "Уровень-3";
      Label59->Left = 168; Label59->Top = 321;
      Label59->Caption = "Тревога-1";
      Label60->Left = 168; Label60->Top = 353;
      Label60->Caption = "Тревога-2";
      Label61->Left = 168; Label61->Top = 385;
      Label61->Caption = "Тревога-3";
      Label69->Left = 408; Label69->Top = 321;
      Label69->Caption = "Зона-1";
      Label70->Left = 408; Label70->Top = 353;
      Label70->Caption = "Зона-2";
      Label71->Left = 408; Label71->Top = 385;
      Label71->Caption = "Зона-3";

      Label2->Visible = true;
      Label3->Visible = true;
      Label4->Visible = true;
      Label5->Visible = true;
      Label6->Visible = true;
      Label52->Visible = true;
      Label53->Visible = true;
      Label54->Visible = true;
      Label55->Visible = true;
      Label56->Visible = true;
      Label57->Visible = true;
      Label59->Visible = true;
      Label60->Visible = true;
      Label61->Visible = true;
      Label69->Visible = true;
      Label70->Visible = true;
      Label71->Visible = true;

      Image2->Left = 88; Image2->Top = 184;
      Image3->Left = 264; Image3->Top = 184;
      Image4->Left = 88; Image4->Top = 56;
      Image5->Left = 264; Image5->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image55->Left = 88; Image55->Top = 320;
      Image56->Left = 88; Image56->Top = 352;
      Image57->Left = 88; Image57->Top = 384;
      Image59->Left = 264; Image59->Top = 320;
      Image60->Left = 264; Image60->Top = 352;
      Image61->Left = 264; Image61->Top = 384;
//      Image69->Left = 448; Image69->Top = 321;
//      Image70->Left = 448; Image70->Top = 352;
//      Image71->Left = 448; Image71->Top = 384;

      Image2->Visible = true;
      Image3->Visible = true;
      Image4->Visible = true;
      Image5->Visible = true;
      Image6->Visible = true;
      Image55->Visible = true;
      Image56->Visible = true;
      Image57->Visible = true;
      Image59->Visible = true;
      Image60->Visible = true;
      Image61->Visible = true;
//      Image69->Visible = true;
//      Image70->Visible = true;
//      Image71->Visible = true;

      StaticText3->Left = 112; StaticText3->Top = 184;
      StaticText4->Left = 288; StaticText4->Top = 184;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText6->Left = 288; StaticText6->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText52->Left = 112; StaticText52->Top = 216;
      StaticText53->Left = 112; StaticText53->Top = 248;
      StaticText54->Left = 112; StaticText54->Top = 280;
      StaticText55->Left = 112; StaticText55->Top = 320;
      StaticText56->Left = 112; StaticText56->Top = 352;
      StaticText57->Left = 112; StaticText57->Top = 384;
      StaticText59->Left = 288; StaticText59->Top = 320;
      StaticText60->Left = 288; StaticText60->Top = 352;
      StaticText61->Left = 288; StaticText61->Top = 384;
      StaticText69->Left = 472; StaticText69->Top = 320;
      StaticText70->Left = 472; StaticText70->Top = 352;
      StaticText71->Left = 472; StaticText71->Top = 384;

      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText5->Visible = true;
      StaticText6->Visible = true;
      StaticText7->Visible = true;
      StaticText52->Visible = true;
      StaticText53->Visible = true;
      StaticText54->Visible = true;
      StaticText55->Visible = true;
      StaticText56->Visible = true;
      StaticText57->Visible = true;
      StaticText59->Visible = true;
      StaticText60->Visible = true;
      StaticText61->Visible = true;
      StaticText69->Visible = true;
      StaticText70->Visible = true;
      StaticText71->Visible = true;
   }
   else if( type == 2 )
   {
      GroupBox4->Caption = "Диагностика-Концентратор";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Состояние";
      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label7->Left = 8; Label7->Top = 121;
      Label7->Caption = "Вскрытие";
      Label2->Left = 8; Label2->Top = 153;
      Label2->Caption = "ДК";
      Label9->Left = 8; Label9->Top = 185;
      Label9->Caption = "Уровень АРУ";
      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Выход \"Тревога\"";
      Label8->Left = 168; Label8->Top = 121;
      Label8->Caption = "Вход \"Вскрытие\"";
      Label3->Left = 168; Label3->Top = 153;
      Label3->Caption = "Выход \"ДК\"";
      Label51->Left = 8; Label51->Top = 185;
      Label51->Caption = "Охрана-1";
      Label52->Left = 8; Label52->Top = 217;
      Label52->Caption = "Охрана-2";
      Label53->Left = 8; Label53->Top = 249;
      Label53->Caption = "Охрана-3";
      Label54->Left = 8; Label54->Top = 281;
      Label54->Caption = "Охрана-4";
      Label55->Left = 8; Label55->Top = 321;
      Label55->Caption = "Сработка-1";
      Label56->Left = 8; Label56->Top = 353;
      Label56->Caption = "Сработка-2";
      Label57->Left = 8; Label57->Top = 385;
      Label57->Caption = "Сработка-3";
      Label58->Left = 8; Label58->Top = 417;
      Label58->Caption = "Сработка-4";
      Label59->Left = 168; Label59->Top = 321;
      Label59->Caption = "Вход 1 \"Тревога\"";
      Label60->Left = 168; Label60->Top = 353;
      Label60->Caption = "Вход 2 \"Тревога\"";
      Label61->Left = 168; Label61->Top = 385;
      Label61->Caption = "Вход 3 \"Тревога\"";
      Label62->Left = 168; Label62->Top = 417;
      Label62->Caption = "Вход 4 \"Тревога\"";
      Label69->Left = 344; Label69->Top = 321;
      Label69->Caption = "Выход 1 \"Тревога\"";
      Label70->Left = 344; Label70->Top = 353;
      Label70->Caption = "Выход 2 \"Тревога\"";
      Label71->Left = 344; Label71->Top = 385;
      Label71->Caption = "Выход 3 \"Тревога\"";
      Label72->Left = 344; Label72->Top = 417;
      Label72->Caption = "Выход 4 \"Тревога\"";

      Label4->Visible = true;
      Label6->Visible = true;
      Label7->Visible = true;
      Label8->Visible = true;
      Label2->Visible = true;
      Label3->Visible = true;
      Label51->Visible = true;
      Label52->Visible = true;
      Label53->Visible = true;
      Label54->Visible = true;
      Label55->Visible = true;
      Label56->Visible = true;
      Label57->Visible = true;
      Label58->Visible = true;
      Label59->Visible = true;
      Label60->Visible = true;
      Label61->Visible = true;
      Label62->Visible = true;
      Label69->Visible = true;
      Label70->Visible = true;
      Label71->Visible = true;
      Label72->Visible = true;

      Image1->Left = 88; Image1->Top = 24;
      Image4->Left = 88; Image4->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image7->Left = 88; Image7->Top = 120;
      Image2->Left = 88; Image2->Top = 152;
      Image5->Left = 264; Image5->Top = 56;
      Image8->Left = 264; Image8->Top = 120;
      Image3->Left = 264; Image3->Top = 152;
      Image51->Left = 88; Image51->Top = 184;
      Image52->Left = 88; Image52->Top = 216;
      Image53->Left = 88; Image53->Top = 248;
      Image54->Left = 88; Image54->Top = 280;
      Image55->Left = 88; Image55->Top = 320;
      Image56->Left = 88; Image56->Top = 352;
      Image57->Left = 88; Image57->Top = 384;
      Image58->Left = 88; Image58->Top = 416;
      Image59->Left = 264; Image59->Top = 320;
      Image60->Left = 264; Image60->Top = 352;
      Image61->Left = 264; Image61->Top = 384;
      Image62->Left = 264; Image62->Top = 416;
      Image69->Left = 448; Image69->Top = 321;
      Image70->Left = 448; Image70->Top = 352;
      Image71->Left = 448; Image71->Top = 384;
      Image72->Left = 448; Image72->Top = 416;

      Image4->Visible = true;
      Image6->Visible = true;
      Image7->Visible = true;
      Image8->Visible = true;
      Image2->Visible = true;
      Image3->Visible = true;
      Image51->Visible = true;
      Image52->Visible = true;
      Image53->Visible = true;
      Image54->Visible = true;
      Image55->Visible = true;
      Image56->Visible = true;
      Image57->Visible = true;
      Image58->Visible = true;
      Image59->Visible = true;
      Image60->Visible = true;
      Image61->Visible = true;
      Image62->Visible = true;
      Image69->Visible = true;
      Image70->Visible = true;
      Image71->Visible = true;
      Image72->Visible = true;

      StaticText2->Left = 112; StaticText2->Top = 24;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText8->Left = 112; StaticText8->Top = 120;
      StaticText3->Left = 112; StaticText3->Top = 152;
      StaticText10->Left = 112; StaticText10->Top = 184;
      StaticText6->Left = 288; StaticText6->Top = 56;
      StaticText9->Left = 288; StaticText9->Top = 120;
      StaticText4->Left = 288; StaticText4->Top = 152;
      StaticText51->Left = 112; StaticText51->Top = 184;
      StaticText52->Left = 112; StaticText52->Top = 216;
      StaticText53->Left = 112; StaticText53->Top = 248;
      StaticText54->Left = 112; StaticText54->Top = 280;
      StaticText55->Left = 112; StaticText55->Top = 320;
      StaticText56->Left = 112; StaticText56->Top = 352;
      StaticText57->Left = 112; StaticText57->Top = 384;
      StaticText58->Left = 112; StaticText58->Top = 416;
      StaticText59->Left = 288; StaticText59->Top = 320;
      StaticText60->Left = 288; StaticText60->Top = 352;
      StaticText61->Left = 288; StaticText61->Top = 384;
      StaticText62->Left = 288; StaticText62->Top = 416;
      StaticText69->Left = 472; StaticText69->Top = 320;
      StaticText70->Left = 472; StaticText70->Top = 352;
      StaticText71->Left = 472; StaticText71->Top = 384;
      StaticText72->Left = 472; StaticText72->Top = 416;

      StaticText5->Visible = true;
      StaticText7->Visible = true;
      StaticText8->Visible = true;
      StaticText9->Visible = true;
      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText51->Visible = true;
      StaticText52->Visible = true;
      StaticText53->Visible = true;
      StaticText54->Visible = true;
      StaticText55->Visible = true;
      StaticText56->Visible = true;
      StaticText57->Visible = true;
      StaticText58->Visible = true;
      StaticText59->Visible = true;
      StaticText60->Visible = true;
      StaticText61->Visible = true;
      StaticText62->Visible = true;
      StaticText69->Visible = true;
      StaticText70->Visible = true;
      StaticText71->Visible = true;
      StaticText72->Visible = true;
   }
   else if( type == 6 )
   {
      GroupBox4->Caption = "Диагностика-Разрыв БО";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Определение направления";

      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Тревога";
      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "Сработка";
      Label7->Left = 8; Label7->Top = 121;
      Label7->Caption = "Вскрытие";
      Label2->Left = 8; Label2->Top = 153;
      Label2->Caption = "ДК";
      Label8->Left = 168; Label8->Top = 121;
      Label8->Caption = "Вход \"Вскрытие\"";
      Label3->Left = 168; Label3->Top = 153;
      Label3->Caption = "Вход \"ДК\"";

      Label51->Left = 8; Label51->Top = 185;
      Label51->Caption = "Неиспр-1";
      Label52->Left = 8; Label52->Top = 217;
      Label52->Caption = "Неиспр-2";
      Label53->Left = 8; Label53->Top = 249;
      Label53->Caption = "Неиспр-3";
      Label54->Left = 8; Label54->Top = 281;
      Label54->Caption = "Неиспр-4";
      Label55->Left = 8; Label55->Top = 321;
      Label55->Caption = "Сработка-1";
      Label56->Left = 8; Label56->Top = 353;
      Label56->Caption = "Сработка-2";
      Label57->Left = 8; Label57->Top = 385;
      Label57->Caption = "Сработка-3";
      Label58->Left = 8; Label58->Top = 417;
      Label58->Caption = "Сработка-4";
      Label59->Left = 168; Label59->Top = 321;
      Label59->Caption = "Вход 1 \"Тревога\"";
      Label60->Left = 168; Label60->Top = 353;
      Label60->Caption = "Вход 2 \"Тревога\"";
      Label61->Left = 168; Label61->Top = 385;
      Label61->Caption = "Вход 3 \"Тревога\"";
      Label62->Left = 168; Label62->Top = 417;
      Label62->Caption = "Вход 4 \"Тревога\"";
      Label69->Left = 344; Label69->Top = 321;
      Label69->Caption = "Выход 1 \"Тревога\"";
      Label70->Left = 344; Label70->Top = 353;
      Label70->Caption = "Выход 2 \"Тревога\"";
      Label71->Left = 344; Label71->Top = 385;
      Label71->Caption = "Выход 3 \"Тревога\"";
      Label72->Left = 344; Label72->Top = 417;
      Label72->Caption = "Выход 4 \"Тревога\"";

      Label1->Visible = true;
      Label4->Visible = true;
      Label6->Visible = true;
      Label7->Visible = true;
      Label8->Visible = true;
      Label2->Visible = true;
      Label3->Visible = true;
      Label51->Visible = true;
      Label52->Visible = true;
      Label53->Visible = true;
      Label54->Visible = true;
      Label55->Visible = true;
      Label56->Visible = true;
      Label57->Visible = true;
      Label58->Visible = true;
      Label59->Visible = true;
      Label60->Visible = true;
      Label61->Visible = true;
      Label62->Visible = true;
      Label69->Visible = true;
      Label70->Visible = true;
      Label71->Visible = true;
      Label72->Visible = true;
      Label34->Visible = true;

      Image4->Left = 88; Image4->Top = 56;
      Image6->Left = 88; Image6->Top = 88;
      Image7->Left = 88; Image7->Top = 120;
      Image2->Left = 88; Image2->Top = 152;
      Image5->Left = 264; Image5->Top = 56;
      Image8->Left = 264; Image8->Top = 120;
      Image3->Left = 264; Image3->Top = 152;
      Image51->Left = 88; Image51->Top = 184;
      Image52->Left = 88; Image52->Top = 216;
      Image53->Left = 88; Image53->Top = 248;
      Image54->Left = 88; Image54->Top = 280;
      Image55->Left = 88; Image55->Top = 320;
      Image56->Left = 88; Image56->Top = 352;
      Image57->Left = 88; Image57->Top = 384;
      Image58->Left = 88; Image58->Top = 416;
      Image59->Left = 264; Image59->Top = 320;
      Image60->Left = 264; Image60->Top = 352;
      Image61->Left = 264; Image61->Top = 384;
      Image62->Left = 264; Image62->Top = 416;
      Image69->Left = 448; Image69->Top = 321;
      Image70->Left = 448; Image70->Top = 352;
      Image71->Left = 448; Image71->Top = 384;
      Image72->Left = 448; Image72->Top = 416;

      Image4->Visible = true;
      Image6->Visible = true;
      Image7->Visible = true;
      Image8->Visible = true;
      Image2->Visible = true;
      Image3->Visible = true;
      Image51->Visible = true;
      Image52->Visible = true;
      Image53->Visible = true;
      Image54->Visible = true;
      Image55->Visible = true;
      Image56->Visible = true;
      Image57->Visible = true;
      Image58->Visible = true;
      Image59->Visible = true;
      Image60->Visible = true;
      Image61->Visible = true;
      Image62->Visible = true;
      Image69->Visible = true;
      Image70->Visible = true;
      Image71->Visible = true;
      Image72->Visible = true;

      StaticText2->Left = 200; StaticText2->Top = 24;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText8->Left = 112; StaticText8->Top = 120;
      StaticText3->Left = 112; StaticText3->Top = 152;
      StaticText10->Left = 112; StaticText10->Top = 184;
      StaticText6->Left = 288; StaticText6->Top = 56;
      StaticText9->Left = 288; StaticText9->Top = 120;
      StaticText4->Left = 288; StaticText4->Top = 152;
      StaticText51->Left = 112; StaticText51->Top = 184;
      StaticText52->Left = 112; StaticText52->Top = 216;
      StaticText53->Left = 112; StaticText53->Top = 248;
      StaticText54->Left = 112; StaticText54->Top = 280;
      StaticText55->Left = 112; StaticText55->Top = 320;
      StaticText56->Left = 112; StaticText56->Top = 352;
      StaticText57->Left = 112; StaticText57->Top = 384;
      StaticText58->Left = 112; StaticText58->Top = 416;
      StaticText59->Left = 288; StaticText59->Top = 320;
      StaticText60->Left = 288; StaticText60->Top = 352;
      StaticText61->Left = 288; StaticText61->Top = 384;
      StaticText62->Left = 288; StaticText62->Top = 416;
      StaticText69->Left = 472; StaticText69->Top = 320;
      StaticText70->Left = 472; StaticText70->Top = 352;
      StaticText71->Left = 472; StaticText71->Top = 384;
      StaticText72->Left = 472; StaticText72->Top = 416;

      StaticText2->Visible = true;
      StaticText5->Visible = true;
      StaticText7->Visible = true;
      StaticText8->Visible = true;
      StaticText9->Visible = true;
      StaticText3->Visible = true;
      StaticText4->Visible = true;
      StaticText51->Visible = true;
      StaticText52->Visible = true;
      StaticText53->Visible = true;
      StaticText54->Visible = true;
      StaticText55->Visible = true;
      StaticText56->Visible = true;
      StaticText57->Visible = true;
      StaticText58->Visible = true;
      StaticText59->Visible = true;
      StaticText60->Visible = true;
      StaticText61->Visible = true;
      StaticText62->Visible = true;
      StaticText69->Visible = true;
      StaticText70->Visible = true;
      StaticText71->Visible = true;
      StaticText72->Visible = true;
      StaticText11->Visible = true;
   }
   else if( type == 10 )
   {
      GroupBox4->Caption = "Диагностика-Точка/Гарда";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Сработка-Уч1";
      Label1->Visible = true;
      Image1->Left = 88; Image1->Top = 24;
      Image1->Visible = true;
      StaticText2->Left = 112; StaticText2->Top = 24;
      StaticText2->Visible = true;

      Label35->Left = 168; Label35->Top = 25;
      Label35->Caption = "Выход \"Тревога-Уч1\"";
      Label35->Visible = true;
      Image75->Left = 296; Image75->Top = 24;
      Image75->Visible = true;
      StaticText75->Left = 320; StaticText75->Top = 24;
      StaticText75->Visible = true;

      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Сработка-Уч2";
      Label4->Visible = true;
      Image4->Left = 88; Image4->Top = 56;
      Image4->Visible = true;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText5->Visible = true;

      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Выход \"Тревога-Уч2\"";
      Label5->Visible = true;
      Image5->Left = 296; Image5->Top = 56;
      Image5->Visible = true;
      StaticText6->Left = 320; StaticText6->Top = 56;
      StaticText6->Visible = true;

      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "ДК";
      Label6->Visible = true;
      Image6->Left = 88; Image6->Top = 88;
      Image6->Visible = true;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText7->Visible = true;

      Label36->Left = 168; Label36->Top = 89;
      Label36->Caption = "Вход \"ДК\"";
      Label36->Visible = true;
      Image76->Left = 296; Image76->Top = 88;
      Image76->Visible = true;
      StaticText76->Left = 320; StaticText76->Top = 88;
      StaticText76->Visible = true;

      Label7->Left = 8; Label7->Top = 121;
      Label7->Caption = "Вскрытие";
      Label7->Visible = true;
      Image7->Left = 88; Image7->Top = 120;
      Image7->Visible = true;
      StaticText8->Left = 112; StaticText8->Top = 120;
      StaticText8->Visible = true;

      Label8->Left = 168; Label8->Top = 121;
      Label8->Caption = "Вход \"Вскрытие\"";
      Label8->Visible = true;
      Image8->Left = 296; Image8->Top = 120;
      Image8->Visible = true;
      StaticText9->Left = 320; StaticText9->Top = 120;
      StaticText9->Visible = true;

      Bevel1->Top = 160;
      Bevel1->Width = 684;
      Bevel1->Visible = true;

      Label85->Left = 8; Label85->Top = 185;
      Label85->Caption = "ЧЭ1";
      Label85->Visible = true;
      Image77->Left = 8; Image77->Top = 210;
      Image77->Visible = true;
      StaticText25->Left = 8; StaticText25->Top = 270;
      StaticText25->Visible = true;

      Label43->Left = 40; Label43->Top = 185;
      Label43->Caption = "Фильтр1";
      Label43->Visible = true;

      Label51->Left = 100; Label51->Top = 185;
      Label51->Caption = "Сработка";
      Label51->Visible = true;
      Image51->Left = 155; Image51->Top = 184;
      Image51->Visible = true;
      StaticText51->Left = 175; StaticText51->Top = 184;
      StaticText51->Visible = true;

      Label95->Left = 230; Label95->Top = 185;
      Label95->Caption = "Уровень";
      Label95->Visible = true;
      StaticText95->Left = 280; StaticText95->Top = 184;
      StaticText95->Visible = true;

      Label77->Left = 365; Label77->Top = 185;
      Label77->Caption = "Порог Ном";
      Label77->Visible = true;
      StaticText77->Left = 430; StaticText77->Top = 184;
      StaticText77->Visible = true;

      Label44->Left = 515; Label44->Top = 185;
      Label44->Caption = "Порог Реал";
      Label44->Visible = true;
      StaticText12->Left = 583; StaticText12->Top = 184;
      StaticText12->Visible = true;

      Label86->Left = 40; Label86->Top = 217;
      Label86->Caption = "Фильтр2";
      Label86->Visible = true;

      Label52->Left = 100; Label52->Top = 217;
      Label52->Caption = "Сработка";
      Label52->Visible = true;
      Image52->Left = 155; Image52->Top = 216;
      Image52->Visible = true;
      StaticText52->Left = 175; StaticText52->Top = 216;
      StaticText52->Visible = true;

      Label96->Left = 230; Label96->Top = 217;
      Label96->Caption = "Уровень";
      Label96->Visible = true;
      StaticText96->Left = 280; StaticText96->Top = 216;
      StaticText96->Visible = true;

      Label78->Left = 365; Label78->Top = 217;
      Label78->Caption = "Порог Ном";
      Label78->Visible = true;
      StaticText78->Left = 430; StaticText78->Top = 216;
      StaticText78->Visible = true;

      Label45->Left = 515; Label45->Top = 217;
      Label45->Caption = "Порог Реал";
      Label45->Visible = true;
      StaticText13->Left = 583; StaticText13->Top = 216;
      StaticText13->Visible = true;

      Label87->Left = 40; Label87->Top = 249;
      Label87->Caption = "Фильтр3";
      Label87->Visible = true;

      Label53->Left = 100; Label53->Top = 249;
      Label53->Caption = "Сработка";
      Label53->Visible = true;
      Image53->Left = 155; Image53->Top = 248;
      Image53->Visible = true;
      StaticText53->Left = 175; StaticText53->Top = 248;
      StaticText53->Visible = true;

      Label97->Left = 230; Label97->Top = 249;
      Label97->Caption = "Уровень";
      Label97->Visible = true;
      StaticText97->Left = 280; StaticText97->Top = 248;
      StaticText97->Visible = true;

      Label79->Left = 365; Label79->Top = 249;
      Label79->Caption = "Порог Ном";
      Label79->Visible = true;
      StaticText79->Left = 430; StaticText79->Top = 248;
      StaticText79->Visible = true;

      Label46->Left = 515; Label46->Top = 249;
      Label46->Caption = "Порог Реал";
      Label46->Visible = true;
      StaticText14->Left = 583; StaticText14->Top = 248;
      StaticText14->Visible = true;

      Bevel2->Top = 290;
      Bevel2->Width = 684;
      Bevel2->Visible = true;

      Label88->Left = 8; Label88->Top = 315;
      Label88->Caption = "ЧЭ2";
      Label88->Visible = true;
      StaticText26->Left = 8; StaticText26->Top = 400;
      StaticText26->Visible = true;

      Label47->Left = 40; Label47->Top = 315;
      Label47->Caption = "Фильтр1";
      Label47->Visible = true;

      Label48->Left = 40; Label48->Top = 347;
      Label48->Caption = "Фильтр2";
      Label48->Visible = true;

      Label49->Left = 40; Label49->Top = 379;
      Label49->Caption = "Фильтр3";
      Label49->Visible = true;

      Label54->Left = 100; Label54->Top = 315;
      Label54->Caption = "Сработка";
      Label54->Visible = true;
      Image54->Left = 155; Image54->Top = 314;
      Image54->Visible = true;
      StaticText54->Left = 175; StaticText54->Top = 314;
      StaticText54->Visible = true;

      Label55->Left = 100; Label55->Top = 347;
      Label55->Caption = "Сработка";
      Label55->Visible = true;
      Image55->Left = 155; Image55->Top = 346;
      Image55->Visible = true;
      StaticText55->Left = 175; StaticText55->Top = 346;
      StaticText55->Visible = true;

      Label56->Left = 100; Label56->Top = 379;
      Label56->Caption = "Сработка";
      Label56->Visible = true;
      Image56->Left = 155; Image56->Top = 378;
      Image56->Visible = true;
      StaticText56->Left = 175; StaticText56->Top = 378;
      StaticText56->Visible = true;

      Image80->Left = 8; Image80->Top = 340;
      Image80->Visible = true;

      Label98->Left = 230; Label98->Top = 315;
      Label98->Caption = "Уровень";
      Label98->Visible = true;
      StaticText98->Left = 280; StaticText98->Top = 314;
      StaticText98->Visible = true;

      Label99->Left = 230; Label99->Top = 347;
      Label99->Caption = "Уровень";
      Label99->Visible = true;
      StaticText99->Left = 280; StaticText99->Top = 346;
      StaticText99->Visible = true;

      Label100->Left = 230; Label100->Top = 379;
      Label100->Caption = "Уровень";
      Label100->Visible = true;
      StaticText100->Left = 280; StaticText100->Top = 378;
      StaticText100->Visible = true;

      Label80->Left = 365; Label80->Top = 315;
      Label80->Caption = "Порог Ном";
      Label80->Visible = true;
      StaticText80->Left = 430; StaticText80->Top = 314;
      StaticText80->Visible = true;

      Label81->Left = 365; Label81->Top = 347;
      Label81->Caption = "Порог Ном";
      Label81->Visible = true;
      StaticText81->Left = 430; StaticText81->Top = 346;
      StaticText81->Visible = true;

      Label82->Left = 365; Label82->Top = 379;
      Label82->Caption = "Порог Ном";
      Label82->Visible = true;
      StaticText82->Left = 430; StaticText82->Top = 378;
      StaticText82->Visible = true;

      Label50->Left = 515; Label50->Top = 315;
      Label50->Caption = "Порог Реал";
      Label50->Visible = true;
      StaticText17->Left = 583; StaticText17->Top = 314;
      StaticText17->Visible = true;

      Label63->Left = 515; Label63->Top = 347;
      Label63->Caption = "Порог Реал";
      Label63->Visible = true;
      StaticText18->Left = 583; StaticText18->Top = 346;
      StaticText18->Visible = true;

      Label64->Left = 515; Label64->Top = 379;
      Label64->Caption = "Порог Реал";
      Label64->Visible = true;
      StaticText19->Left = 583; StaticText19->Top = 378;
      StaticText19->Visible = true;

      Bevel3->Top = 420;
      Bevel3->Width = 684;
      Bevel3->Visible = true;

      Label89->Left = 8; Label89->Top = 445;
      Label89->Caption = "ЧЭ3";
      Label89->Visible = true;
      StaticText27->Left = 8; StaticText27->Top = 530;
      StaticText27->Visible = true;

      Label65->Left = 40; Label65->Top = 445;
      Label65->Caption = "Фильтр1";
      Label65->Visible = true;

      Label66->Left = 40; Label66->Top = 477;
      Label66->Caption = "Фильтр2";
      Label66->Visible = true;

      Label67->Left = 40; Label67->Top = 509;
      Label67->Caption = "Фильтр3";
      Label67->Visible = true;

      Image83->Left = 8; Image83->Top = 470;
      Image83->Visible = true;

      Label57->Left = 100; Label57->Top = 445;
      Label57->Caption = "Сработка";
      Label57->Visible = true;
      Image57->Left = 155; Image57->Top = 444;
      Image57->Visible = true;
      StaticText57->Left = 175; StaticText57->Top = 444;
      StaticText57->Visible = true;

      Label58->Left = 100; Label58->Top = 477;
      Label58->Caption = "Сработка";
      Label58->Visible = true;
      Image58->Left = 155; Image58->Top = 476;
      Image58->Visible = true;
      StaticText58->Left = 175; StaticText58->Top = 476;
      StaticText58->Visible = true;

      Label59->Left = 100; Label59->Top = 509;
      Label59->Caption = "Сработка";
      Label59->Visible = true;
      Image59->Left = 155; Image59->Top = 508;
      Image59->Visible = true;
      StaticText59->Left = 175; StaticText59->Top = 508;
      StaticText59->Visible = true;

      Label101->Left = 230; Label101->Top = 445;
      Label101->Caption = "Уровень";
      Label101->Visible = true;
      StaticText101->Left = 280; StaticText101->Top = 444;
      StaticText101->Visible = true;

      Label102->Left = 230; Label102->Top = 477;
      Label102->Caption = "Уровень";
      Label102->Visible = true;
      StaticText102->Left = 280; StaticText102->Top = 476;
      StaticText102->Visible = true;

      Label103->Left = 230; Label103->Top = 509;
      Label103->Caption = "Уровень";
      Label103->Visible = true;
      StaticText103->Left = 280; StaticText103->Top = 508;
      StaticText103->Visible = true;

      Label83->Left = 365; Label83->Top = 445;
      Label83->Caption = "Порог Ном";
      Label83->Visible = true;
      StaticText83->Left = 430; StaticText83->Top = 444;
      StaticText83->Visible = true;

      Label84->Left = 365; Label84->Top = 477;
      Label84->Caption = "Порог Ном";
      Label84->Visible = true;
      StaticText84->Left = 430; StaticText84->Top = 476;
      StaticText84->Visible = true;

      Label294->Left = 365; Label294->Top = 509;
      Label294->Caption = "Порог Ном";
      Label294->Visible = true;
      StaticText294->Left = 430; StaticText294->Top = 508;
      StaticText294->Visible = true;

      Label68->Left = 515; Label68->Top = 445;
      Label68->Caption = "Порог Реал";
      Label68->Visible = true;
      StaticText20->Left = 583; StaticText20->Top = 444;
      StaticText20->Visible = true;

      Label73->Left = 515; Label73->Top = 477;
      Label73->Caption = "Порог Реал";
      Label73->Visible = true;
      StaticText21->Left = 583; StaticText21->Top = 476;
      StaticText21->Visible = true;

      Label74->Left = 515; Label74->Top = 509;
      Label74->Caption = "Порог Реал";
      Label74->Visible = true;
      StaticText22->Left = 583; StaticText22->Top = 508;
      StaticText22->Visible = true;

      Bevel4->Top = 550;
      Bevel4->Width = 684;
      Bevel4->Visible = true;

      Label90->Left = 8; Label90->Top = 575;
      Label90->Caption = "ЧЭ4";
      Label90->Visible = true;
      StaticText28->Left = 8; StaticText28->Top = 660;
      StaticText28->Visible = true;

      Image305->Left = 8; Image305->Top = 600;
      Image305->Visible = true;

      Label91->Left = 40; Label91->Top = 575;
      Label91->Caption = "Фильтр1";
      Label91->Visible = true;

      Label92->Left = 40; Label92->Top = 607;
      Label92->Caption = "Фильтр2";
      Label92->Visible = true;

      Label292->Left = 40; Label292->Top = 639;
      Label292->Caption = "Фильтр3";
      Label292->Visible = true;

      Label293->Left = 100; Label293->Top = 575;
      Label293->Caption = "Сработка";
      Label293->Visible = true;
      Image293->Left = 155; Image293->Top = 574;
      Image293->Visible = true;
      StaticText293->Left = 175; StaticText293->Top = 574;
      StaticText293->Visible = true;

      Label297->Left = 100; Label297->Top = 607;
      Label297->Caption = "Сработка";
      Label297->Visible = true;
      Image297->Left = 155; Image297->Top = 606;
      Image297->Visible = true;
      StaticText297->Left = 175; StaticText297->Top = 606;
      StaticText297->Visible = true;

      Label301->Left = 100; Label301->Top = 639;
      Label301->Caption = "Сработка";
      Label301->Visible = true;
      Image301->Left = 155; Image301->Top = 638;
      Image301->Visible = true;
      StaticText301->Left = 175; StaticText301->Top = 638;
      StaticText301->Visible = true;

      Label299->Left = 230; Label299->Top = 575;
      Label299->Caption = "Уровень";
      Label299->Visible = true;
      StaticText299->Left = 280; StaticText299->Top = 574;
      StaticText299->Visible = true;

      Label303->Left = 230; Label303->Top = 607;
      Label303->Caption = "Уровень";
      Label303->Visible = true;
      StaticText303->Left = 280; StaticText303->Top = 606;
      StaticText303->Visible = true;

      Label307->Left = 230; Label307->Top = 639;
      Label307->Caption = "Уровень";
      Label307->Visible = true;
      StaticText307->Left = 280; StaticText307->Top = 638;
      StaticText307->Visible = true;

      Label298->Left = 365; Label298->Top = 575;
      Label298->Caption = "Порог Ном";
      Label298->Visible = true;
      StaticText298->Left = 430; StaticText298->Top = 574;
      StaticText298->Visible = true;

      Label302->Left = 365; Label302->Top = 607;
      Label302->Caption = "Порог Ном";
      Label302->Visible = true;
      StaticText302->Left = 430; StaticText302->Top = 606;
      StaticText302->Visible = true;

      Label306->Left = 365; Label306->Top = 639;
      Label306->Caption = "Порог Ном";
      Label306->Visible = true;
      StaticText306->Left = 430; StaticText306->Top = 638;
      StaticText306->Visible = true;

      Label296->Left = 515; Label296->Top = 575;
      Label296->Caption = "Порог Реал";
      Label296->Visible = true;
      StaticText23->Left = 583; StaticText23->Top = 574;
      StaticText23->Visible = true;

      Label300->Left = 515; Label300->Top = 607;
      Label300->Caption = "Порог Реал";
      Label300->Visible = true;
      StaticText24->Left = 583; StaticText24->Top = 606;
      StaticText24->Visible = true;

      Label305->Left = 515; Label305->Top = 639;
      Label305->Caption = "Порог Реал";
      Label305->Visible = true;
      StaticText305->Left = 583; StaticText305->Top = 638;
      StaticText305->Visible = true;
   }
   else if( type == 33 )
   {
      GroupBox4->Caption = "Диагностика-ССОИ";

      Label1->Left = 8; Label1->Top = 25;
      Label1->Caption = "Тревога";
      Label1->Visible = true;
      Image1->Left = 88; Image1->Top = 24;
      Image1->Visible = true;
      StaticText2->Left = 112; StaticText2->Top = 24;
      StaticText2->Visible = true;

      Label4->Left = 8; Label4->Top = 57;
      Label4->Caption = "Вскрытие";
      Label4->Visible = true;
      Image4->Left = 88; Image4->Top = 56;
      Image4->Visible = true;
      StaticText5->Left = 112; StaticText5->Top = 56;
      StaticText5->Visible = true;

      Label5->Left = 168; Label5->Top = 57;
      Label5->Caption = "Вход \"Вскрытие\"";
      Label5->Visible = true;
      Image5->Left = 270; Image5->Top = 56;
      Image5->Visible = true;
      StaticText6->Left = 294; StaticText6->Top = 56;
      StaticText6->Visible = true;

      Label6->Left = 8; Label6->Top = 89;
      Label6->Caption = "ДК";
      Label6->Visible = true;
      Image6->Left = 88; Image6->Top = 88;
      Image6->Visible = true;
      StaticText7->Left = 112; StaticText7->Top = 88;
      StaticText7->Visible = true;

      Label3->Left = 168; Label3->Top = 89;
      Label3->Caption = "Выход \"ДК\"";
      Label3->Visible = true;
      Image3->Left = 270; Image3->Top = 88;
      Image3->Visible = true;
      StaticText4->Left = 294; StaticText4->Top = 88;
      StaticText4->Visible = true;

      Label7->Left = 8; Label7->Top = 121;
      Label7->Caption = "ИУ1";
      Label7->Visible = true;
      Image7->Left = 88; Image7->Top = 120;
      Image7->Visible = true;
      StaticText8->Left = 112; StaticText8->Top = 120;
      StaticText8->Visible = true;

      Label8->Left = 200; Label8->Top = 121;
      Label8->Caption = "ИУ2";
      Label8->Visible = true;
      Image8->Left = 270; Image8->Top = 120;
      Image8->Visible = true;
      StaticText9->Left = 294; StaticText9->Top = 120;
      StaticText9->Visible = true;

      Label2->Left = 400; Label2->Top = 121;
      Label2->Caption = "ИУ3";
      Label2->Visible = true;
      Image2->Left = 452; Image2->Top = 120;
      Image2->Visible = true;
      StaticText3->Left = 476; StaticText3->Top = 120;
      StaticText3->Visible = true;

      Label60->Left = 8; Label60->Top = 153;
      Label60->Caption = "ВК1";
      Label60->Visible = true;
      Image60->Left = 88; Image60->Top = 152;
      Image60->Visible = true;
      StaticText60->Left = 112; StaticText60->Top = 152;
      StaticText60->Visible = true;

      Label61->Left = 200; Label61->Top = 153;
      Label61->Caption = "ВК2";
      Label61->Visible = true;
      Image61->Left = 270; Image61->Top = 152;
      Image61->Visible = true;
      StaticText61->Left = 294; StaticText61->Top = 152;
      StaticText61->Visible = true;

      Label62->Left = 400; Label62->Top = 153;
      Label62->Caption = "ВК3";
      Label62->Visible = true;
      Image62->Left = 452; Image62->Top = 152;
      Image62->Visible = true;
      StaticText62->Left = 476; StaticText62->Top = 152;
      StaticText62->Visible = true;

      Label51->Left = 8; Label51->Top = 185;
      Label51->Caption = "Вх. Сработка-1";
      Label51->Visible = true;
      Image51->Left = 88; Image51->Top = 184;
      Image51->Visible = true;
      StaticText51->Left = 112; StaticText51->Top = 184;
      StaticText51->Visible = true;

      Label52->Left = 8; Label52->Top = 217;
      Label52->Caption = "Вх. Сработка-2";
      Label52->Visible = true;
      Image52->Left = 88; Image52->Top = 216;
      Image52->Visible = true;
      StaticText52->Left = 112; StaticText52->Top = 216;
      StaticText52->Visible = true;

      Label53->Left = 8; Label53->Top = 249;
      Label53->Caption = "Вх. Сработка-3";
      Label53->Visible = true;
      Image53->Left = 88; Image53->Top = 248;
      Image53->Visible = true;
      StaticText53->Left = 112; StaticText53->Top = 248;
      StaticText53->Visible = true;

      Label54->Left = 8; Label54->Top = 281;
      Label54->Caption = "Вх. Сработка-4";
      Label54->Visible = true;
      Image54->Left = 88; Image54->Top = 280;
      Image54->Visible = true;
      StaticText54->Left = 112; StaticText54->Top = 280;
      StaticText54->Visible = true;

      Label55->Left = 8; Label55->Top = 321;
      Label55->Caption = "Вх. Сработка-5";
      Label55->Visible = true;
      Image55->Left = 88; Image55->Top = 320;
      Image55->Visible = true;
      StaticText55->Left = 112; StaticText55->Top = 320;
      StaticText55->Visible = true;

      Label56->Left = 8; Label56->Top = 353;
      Label56->Caption = "Вх. Сработка-6";
      Label56->Visible = true;
      Image56->Left = 88; Image56->Top = 352;
      Image56->Visible = true;
      StaticText56->Left = 112; StaticText56->Top = 352;
      StaticText56->Visible = true;

      Label57->Left = 8; Label57->Top = 385;
      Label57->Caption = "Вх. Сработка-7";
      Label57->Visible = true;
      Image57->Left = 88; Image57->Top = 384;
      Image57->Visible = true;
      StaticText57->Left = 112; StaticText57->Top = 384;
      StaticText57->Visible = true;

      Label58->Left = 8; Label58->Top = 417;
      Label58->Caption = "Сработка-8";
      Label58->Visible = true;
      Image58->Left = 88; Image58->Top = 416;
      Image58->Visible = true;
      StaticText58->Left = 112; StaticText58->Top = 416;
      StaticText58->Visible = true;

      Label77->Left = 168; Label77->Top = 185;
      Label77->Caption = "Вх. Тревога-1";
      Label77->Visible = true;
      Image71->Left = 264; Image71->Top = 184;
      Image71->Visible = true;
      StaticText77->Left = 296; StaticText77->Top = 184;
      StaticText77->Visible = true;

      Label78->Left = 168; Label78->Top = 217;
      Label78->Caption = "Вх. Тревога-2";
      Label78->Visible = true;
      Image78->Left = 264; Image78->Top = 216;
      Image78->Visible = true;
      StaticText78->Left = 296; StaticText78->Top = 216;
      StaticText78->Visible = true;

      Label79->Left = 168; Label79->Top = 249;
      Label79->Caption = "Вх. Тревога-3";
      Label79->Visible = true;
      Image79->Left = 264; Image79->Top = 248;
      Image79->Visible = true;
      StaticText79->Left = 296; StaticText79->Top = 248;
      StaticText79->Visible = true;

      Label80->Left = 168; Label80->Top = 281;
      Label80->Caption = "Вх. Тревога-4";
      Label80->Visible = true;
      Image72->Left = 264; Image72->Top = 280;
      Image72->Visible = true;
      StaticText80->Left = 296; StaticText80->Top = 280;
      StaticText80->Visible = true;

      Label81->Left = 168; Label81->Top = 321;
      Label81->Caption = "Вх. Тревога-5";
      Label81->Visible = true;
      Image81->Left = 264; Image81->Top = 320;
      Image81->Visible = true;
      StaticText81->Left = 296; StaticText81->Top = 320;
      StaticText81->Visible = true;

      Label82->Left = 168; Label82->Top = 353;
      Label82->Caption = "Вх. Тревога-6";
      Label82->Visible = true;
      Image82->Left = 264; Image82->Top = 352;
      Image82->Visible = true;
      StaticText82->Left = 296; StaticText82->Top = 352;
      StaticText82->Visible = true;

      Label83->Left = 168; Label83->Top = 385;
      Label83->Caption = "Вх. Тревога-7";
      Label83->Visible = true;
      Image75->Left = 264; Image75->Top = 384;
      Image75->Visible = true;
      StaticText83->Left = 296; StaticText83->Top = 384;
      StaticText83->Visible = true;

      Label84->Left = 168; Label84->Top = 417;
      Label84->Caption = "Вх. Тревога-8";
      Label84->Visible = true;
      Image84->Left = 264; Image84->Top = 416;
      Image84->Visible = true;
      StaticText84->Left = 296; StaticText84->Top = 416;
      StaticText84->Visible = true;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Adam4068TimerTimer(TObject *Sender)
{
   TDateTime adt = Now();

   if( Adam4068PortNum != 0 && S7cnt > 0 )
   {
      int flag = 0;
      char packet[100];

      flag = Serial5.GetPaketA4068(packet);
      if( flag != 1 )
      {
         if( A4068Sys->ErrCnt[A4068Sys->Use[Adr4068]-1] <= ErrCnt4068 )
         {
            A4068Sys->ErrCnt[A4068Sys->Use[Adr4068]-1] += 1;
         }
         else 
         {
            for( int i = 0; i < OutCnt4068; i++ )
            {
               if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Use[i] )
               {
                  A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out[i] = 10; /* Нет связи */
               }
            }
         }
      }
      else
      {
         A4068Sys->ErrCnt[A4068Sys->Use[Adr4068]-1] = 0;

         if( packet[0] == '!' && packet[7] == '\r' )
         {
            int t1 = Char2Hex(packet[1]);
            t1 = t1<<4;
            int t4 = Char2Hex(packet[2]);
            t1 = t1 | t4;

            for( int i = 0; i < OutCnt4068; i++ )
            {
               if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Use[i] )
               {
                  int t2 = 1<<i;
                  t2 = t1 & t2;
                  int t3 = 1<<i;
                  if( t2 == t3 )
                  {
                     A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out2[i] = 101; /* Вкл */
                     if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].AdamOff[i] > 0 )
                     {
                        if( adt > A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].OffDt[i] )
                           A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Cmd[i] = 100;
                     }
                  }
                  else
                  {
                     A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out2[i] = 100; /* Выкл */
                  }

                  if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out2[i] != A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out3[i] )
                     A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out3[i] = A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out2[i];
                  else A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out[i] = A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out2[i];
               }
            }
         }
      }

      int t3[8] = {0,0,0,0,0,0,0,0};
      if( Adr4068 < DevCnt4068-1 )
      {
         if( A4068Sys->Use[Adr4068+1] != 0 ) Adr4068 += 1;
         else
         {
            Serial5.SetCmdA4068( 0, 5, t3 );
            Adr4068 = 0;
         }
      }

      int wrcmd = 1;
      for( int i = 0; i < OutCnt4068; i++ )
      {
         if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Cmd[i] == 101 )
         {
            t3[i] = 101;
            wrcmd = 3;
         }
         else if( A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Cmd[i] == 100 )
         {
            t3[i] = 100;
            wrcmd = 3;
         }
         else
         {
            t3[i] = A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Out[i];
         }
         A4068Sys->Dev[A4068Sys->Use[Adr4068]-1].Cmd[i] = 0;
      }

      Serial5.SetCmdA4068( A4068Sys->Use[Adr4068], wrcmd, t3 );

      ShowNewA4068Status();
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowNewA4068Status()
{
   for( int idx = 0; idx < ObjTree->Items->Count; idx++ )
   {
      if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 7 )
      {
         int k = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
         int d = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;

//         if( A4068Sys->Dev[k].Out[d] != A4068Sys->Dev[k].OutOld[d] )
         {
            int n = 6;
            switch( A4068Sys->Dev[k].Out[d] )
            {
               case 101: n = 23; break;
               case 100: n = 24; break;
               case 10: n = 8; break;
            }

            ObjTree->Items->Item[idx]->ImageIndex = n;
            ObjTree->Items->Item[idx]->SelectedIndex = n;

            if( A4068Sys->Dev[k].Out[d] != A4068Sys->Dev[k].OutOld[d] && A4068Sys->Dev[k].OutOld[d] != -1 )
            {
                SetSob( A4068Sys->Dev[k].Out[d], POprosObj(ObjTree->Items->Item[idx]->Data)->Type,
                        POprosObj(ObjTree->Items->Item[idx]->Data)->Num1,
                        POprosObj(ObjTree->Items->Item[idx]->Data)->Num2,
                        POprosObj(ObjTree->Items->Item[idx]->Data)->Num3,
                        POprosObj(ObjTree->Items->Item[idx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            }
            A4068Sys->Dev[k].OutOld[d] = A4068Sys->Dev[k].Out[d];
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::TorosDkItemClick(TObject *Sender)
{
   SetSob( 133,
           0,
           0,
           0,
           0,
           "Торос, Трасса-2л", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   for( int i = 0; i < RifDevCnt; i++ )
   {
      if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[0] == 1 && RifPortNum[kn] != 0 )
      {
         if( RifSys->Rk[kn][i].Type == 2 && RifSys->Rk[kn][i].Cmd == 0x22 )
         {
            RifSys->Rk[kn][i].Cmd = 0x21;
            RifSys->Rk[kn][i].CmdCnt = 0;
            RifSys->Rk[kn][i].AutoDk = false;
            RifSys->Rk[kn][i].AutoDkCnt = 0;
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::NastDkItemClick(TObject *Sender)
{
   SetSob( 133,
           0,
           0,
           0,
           0,
           "Наст", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   for( int i = 0; i < RifDevCnt; i++ )
   {
      if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[0] == 1 && RifPortNum[kn]!= 0 )
      {
         if( RifSys->Rk[kn][i].Type == 3 && RifSys->Rk[kn][i].Cmd == 0x22 )
         {
            RifSys->Rk[kn][i].Cmd = 0x21;
            RifSys->Rk[kn][i].CmdCnt = 0;
            RifSys->Rk[kn][i].AutoDk = false;
            RifSys->Rk[kn][i].AutoDkCnt = 0;
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::PultOff_pdiClick(TObject *Sender)
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3 - 1;
   if( POprosObj(ObjTree->Selected->Data)->Type == 9 )
   {
      if( RifPortNum[kn] != 0 )
      {
         SetSob( 138,
                 POprosObj(ObjTree->Selected->Data)->Type,
                 POprosObj(ObjTree->Selected->Data)->Num1,
                 POprosObj(ObjTree->Selected->Data)->Num2,
                 POprosObj(ObjTree->Selected->Data)->Num3,
                 POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

         RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x23;
         RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DiagItemClick(TObject *Sender)
{
   if( POprosObj(ObjTree->Selected->Data)->Name == "Система" )
   {
      MessageBox (NULL, "Не выбран объект!",WarningMsg.c_str(),MB_OK|MB_ICONERROR);
   }
   else
   {
       if( ScrollBox1->Visible || GroupBox10->Visible )
       {
          ScrollBox1->Visible = false;
          GroupBox4->Visible = false;
          GroupBox10->Visible = false;
       }
       else
       {
          GroupBox10->Visible = false;
          GroupBox4->Visible = false;
          if( ComplexVersion != Rastr_M_SsoiComplexType )
          {
//              if( MessageBox (NULL,"Вставьте ключ администратора и нажмите OK.","Предупреждение",MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
              {
//                  if( Audit() )
                  {
                     DiagRif->Adr = 0;
                     DiagRif->Port = 1;
                     DiagRif->Reset();
                     DiagKonc->Adr = 0;
                     DiagKonc->Port = 1;
                     DiagKonc->Reset();

                     ResetDiagInfo(0);

                     GroupBox4->Visible = false;
                     ScrollBox1->Visible = false;
                     GroupBox10->Visible = false;

                     if( POprosObj(ObjTree->Selected->Data)->Type == 1 )
                     {
                        GroupBox10->Visible = true;

                        ResetDiagInfo2(1, 1);

                        DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
                     {
                        GroupBox10->Visible = true;

                        ResetDiagInfo2(RifRlmSType, 1);

                        DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 8 )
                     {
                        GroupBox4->Visible = true;
                        ScrollBox1->Visible = true;

                        DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo(8);
                        ShowDiagRifInfo(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 9 )
                     {
                        GroupBox4->Visible = true;
                        ScrollBox1->Visible = true;

                        DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo(9);
                        ShowDiagRifInfo(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 91 )
                     {
                        GroupBox4->Visible = true;
                        ScrollBox1->Visible = true;

                        DiagRif->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagRif->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo(91);
                        ShowDiagRifInfo2(POprosObj(ObjTree->Selected->Data)->Type, 0, 0, 0.0, 0.0, 0.0, 0, 0, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 2 )
                     {
                        GroupBox4->Visible = true;
                        ScrollBox1->Visible = true;

                        DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo(2);
                        ShowDiagKoncInfo(0, 0, 0, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 21 )
                     {
                        GroupBox4->Visible = true;
                        ScrollBox1->Visible = true;

                        DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo(6);
                        ShowDiagKoncInfo(0, 0, 0, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 10 )
                     {
                        GroupBox10->Visible = true;

                        DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo2(10, POprosObj(ObjTree->Selected->Data)->Num2);

                        ObjTreeClick(this);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 33 )
                     {
                        GroupBox10->Visible = true;

                        ResetDiagInfo2(33,0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == 43 )
                     {
                        GroupBox10->Visible = true;

                        ResetDiagInfo(33);

                        int temp[30];
                        for(int i = 0; i < 30; i++) temp[i] = 0;
                        ShowDiagSsoi2Info(temp);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType ||
                              POprosObj(ObjTree->Selected->Data)->Type == IuIpBlType )
                     {
                        GroupBox10->Visible = true;

                        DiagKonc->Adr = POprosObj(ObjTree->Selected->Data)->Num1;
                        DiagKonc->Port = POprosObj(ObjTree->Selected->Data)->Num3;
                        ResetDiagInfo2(SdIpBlType, 0);

                        int temp[1000];
                        for(int i = 0; i < 1000; i++) temp[i] = -1;
                        ShowDiagIpBlInfo(temp);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(TochkaMBoIdx, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(TochkaMBoIdx, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(TochkaMDdIdx, POprosObj(ObjTree->Selected->Data)->Num2);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(SotaMBoIdx, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(SotaMBoIdx, 0);
                     }
                     else if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
                     {
                        GroupBox10->Visible = true;

                        ResetTochkaMDiagInfo(SotaMDdIdx, POprosObj(ObjTree->Selected->Data)->Num2);
                     }
                  }
              }
          }
          else
          {
             if( POprosObj(ObjTree->Selected->Data)->Type == 3 || POprosObj(ObjTree->Selected->Data)->Type == 4 )
             {
                GroupBox4->Visible = false;
                ScrollBox1->Visible = false;
                GroupBox10->Visible = true;

                ResetSsoiM1Info();
             }
          }
       }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SetupItemClick(TObject *Sender)
{
   if( PCfgObj(ObjTree->Selected->Data)->Type == SdIpBlType || PCfgObj(ObjTree->Selected->Data)->Type == IuIpBlType )
   {
      if( ScrollBox2->Visible ) ScrollBox2->Visible = false;
   }
   else
   {
       if( ScrollBox2->Visible ) ScrollBox2->Visible = false;
       else if( MessageBox (NULL,"Вставьте ключ администратора и нажмите OK.","Предупреждение",MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
       {
          if( Audit() )
          {
             ScrollBox2->Visible = true;
             ShowSetupInfo(PCfgObj(ObjTree->Selected->Data)->Type);

             if( (PCfgObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ||
                 PCfgObj(ObjTree->Selected->Data)->Type == SotaMDdIdx) && ScrollBox2->Visible )
             {
               BitBtn1Click(this);
             }
          }
          else MessageBox (NULL,"Ключ администратора не найден!","Ошибка",MB_OK|MB_ICONERROR);
       }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowSetupInfo( int type )
{
   GroupBox2->Caption = "Настройка";
   ScrollBox2->Height = 196;
   GroupBox2->Height = 196;
   Label11->Visible = false;
   Label11->Top = 16;
   Label12->Visible = false;
   Label12->Top = 16;
   Label14->Visible = false;
   Label14->Top = 64;
   Label15->Visible = false;
   Label15->Top = 64;
   Label16->Visible = false;
   Label16->Top = 64;
   Label37->Visible = false;
   Label37->Top = 72;
   Label38->Visible = false;
   Label38->Top = 104;
   Label39->Visible = false;
   Label39->Top = 136;
   Label40->Visible = false;
   Label40->Top = 72;
   Label41->Visible = false;
   Label41->Top = 104;
   Label42->Visible = false;
   Label42->Top = 136;
   Label93->Visible = false;
   Label94->Visible = false;
   Label104->Visible = false;
   Label105->Visible = false;
   Label106->Visible = false;
   Label107->Visible = false;
   Label108->Visible = false;
   Label109->Visible = false;
   Label110->Visible = false;
   Label111->Visible = false;
   Label112->Visible = false;
   Label113->Visible = false;
   Label114->Visible = false;
   Label115->Visible = false;
   Label116->Visible = false;
   Label117->Visible = false;

   ComboBox1->Visible = false;
   ComboBox1->Top = 32;
   ComboBox2->Visible = false;
   ComboBox2->Top = 32;
   ComboBox5->Visible = false;
   ComboBox5->Top = 80;
   ComboBox6->Visible = false;
   ComboBox6->Top = 80;
   ComboBox7->Visible = false;
   ComboBox7->Top = 80;
   ComboBox18->Visible = false;
   ComboBox18->Top = 64;
   ComboBox19->Visible = false;
   ComboBox19->Top = 96;
   ComboBox20->Visible = false;
   ComboBox20->Top = 128;
   ComboBox21->Visible = false;
   ComboBox22->Visible = false;
   ComboBox23->Visible = false;
   ComboBox24->Visible = false;
   ComboBox25->Visible = false;
   ComboBox26->Visible = false;
   ComboBox27->Visible = false;
   ComboBox28->Visible = false;
   ComboBox29->Visible = false;
   ComboBox30->Visible = false;
   ComboBox31->Visible = false;
   ComboBox32->Visible = false;

   BitBtn1->Visible = false;
   BitBtn1->Top = 160;
   BitBtn2->Visible = false;
   BitBtn2->Top = 160;

   CheckBox1->Visible = false;
   CheckBox1->Top = 72;
   CheckBox2->Visible = false;
   CheckBox2->Top = 104;
   CheckBox3->Visible = false;
   CheckBox3->Top = 136;

   CSpinEdit1->Visible = false;
   CSpinEdit1->Top = 64;
   CSpinEdit2->Visible = false;
   CSpinEdit2->Top = 96;
   CSpinEdit3->Visible = false;
   CSpinEdit3->Top = 128;
   CSpinEdit4->Visible = false;
   CSpinEdit4->Top = 80;
   CSpinEdit5->Visible = false;
   CSpinEdit5->Top = 80;
   CSpinEdit6->Visible = false;
   CSpinEdit7->Visible = false;
   CSpinEdit8->Visible = false;
   CSpinEdit9->Visible = false;
   CSpinEdit10->Visible = false;
   CSpinEdit11->Visible = false;

   if( type != 10 )
   {
      ScrollBox2->Height = 156;
      GroupBox2->Height = 156;
      BitBtn1->Top = 112;
      BitBtn2->Top = 112;
   }
   else
   {
      ScrollBox2->Height = 208;
      GroupBox2->Height = 208;
      BitBtn1->Top = 168;
      BitBtn2->Top = 168;
   }

   if( type == 1 )
   {
      if( POprosObj(ObjTree->Selected->Data)->AdamOff == 0 ) GroupBox2->Caption = "Настройка-РИФ-РЛМ";
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 1 ) GroupBox2->Caption = "Настройка-РИФ-РЛМ24";
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 2 ) GroupBox2->Caption = "Настройка-РИФ-РЛМ(Б)";
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 3 ) GroupBox2->Caption = "Настройка-РИФ-КРЛ";
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 4 ) GroupBox2->Caption = "Настройка-Разрыв";
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 5 ) GroupBox2->Caption = "Настройка-Трасса-1л";
      else GroupBox2->Caption = "Настройка-РИФ-РЛМ";

      Label11->Caption = "Пороги";
      Label11->Visible = true;

      Label12->Caption = "Условие сработки";
      Label12->Visible = true;

      Label14->Visible = true;

      ComboBox1->Items->Clear();
      ComboBox1->Items->Add("Не определено");
      if( POprosObj(ObjTree->Selected->Data)->AdamOff == 3 )
      {
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("1 (груб.)(Линейный");
          ComboBox1->Items->Add("2 (Линейный");
          ComboBox1->Items->Add("3 (Линейный");
          ComboBox1->Items->Add("4 (Линейный");
          ComboBox1->Items->Add("5 (Линейный");
          ComboBox1->Items->Add("6 (Объёмный");
          ComboBox1->Items->Add("7 (Объёмный");
          ComboBox1->Items->Add("8 (Объёмный");
          ComboBox1->Items->Add("9 (Объёмный");
          ComboBox1->Items->Add("10(чувств.)(Объёмный");
      }
      else
      {
          if( POprosObj(ObjTree->Selected->Data)->AdamOff == 1 )
          {
             ComboBox1->Items->Add(".1 (самый грубый)");
             ComboBox1->Items->Add(".2");
             ComboBox1->Items->Add(".3");
             ComboBox1->Items->Add(".4");
             ComboBox1->Items->Add(".5");
             ComboBox1->Items->Add(".6");
          }
          else
          {
             ComboBox1->Items->Add("1 (грубый)");
             ComboBox1->Items->Add("1 (грубый)");
             ComboBox1->Items->Add("1 (грубый)");
             ComboBox1->Items->Add("1 (грубый)");
             ComboBox1->Items->Add("1 (грубый)");
             ComboBox1->Items->Add("1 (грубый)");
          }
          ComboBox1->Items->Add("1 (грубый)");
          ComboBox1->Items->Add("2");
          ComboBox1->Items->Add("3");
          ComboBox1->Items->Add("4");
          ComboBox1->Items->Add("5");
          ComboBox1->Items->Add("6");
          ComboBox1->Items->Add("7");
          ComboBox1->Items->Add("8");
          ComboBox1->Items->Add("9");
          ComboBox1->Items->Add("10 (чувств)");
      }
      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;
      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;

      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Неопределено");

      if( POprosObj(ObjTree->Selected->Data)->AdamOff == 3 )
      {
         ComboBox2->Items->Add("Нормальный");
         ComboBox2->Items->Add("Помехозащищенный");
      }
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 4 )
      {
         ComboBox2->Items->Add("Настройка");
         ComboBox2->Items->Add("Работа");
      }
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 5 )
      {
         ComboBox2->Items->Add("Медленный");
         ComboBox2->Items->Add("Быстрый");
      }
      else
      {
         ComboBox2->Items->Add("Основной");
         ComboBox2->Items->Add("Дополнительный");
      }
      ComboBox2->ItemIndex = 0;
      ComboBox2->Visible = true;

      ComboBox5->Items->Clear();
      ComboBox5->Items->Add("Неопределено");
      if( POprosObj(ObjTree->Selected->Data)->AdamOff == 2 )
      {
         ComboBox5->Items->Add("Такт 1");
         ComboBox5->Items->Add("Такт 2");
      }
      else if( POprosObj(ObjTree->Selected->Data)->AdamOff == 4 )
      {
         ComboBox5->Items->Add("УШ 1");
         ComboBox5->Items->Add("УШ 2");
         ComboBox5->Items->Add("УШ 3");
         ComboBox5->Items->Add("УШ 4");
      }
      else
      {
         ComboBox5->Items->Add("Такт 1");
         ComboBox5->Items->Add("Такт 2");
         ComboBox5->Items->Add("Такт 3");
         ComboBox5->Items->Add("Такт 4");
      }
      ComboBox5->ItemIndex = 0;
      ComboBox5->Visible = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == RifRlmSType )
   {
      GroupBox2->Caption = "Настройка-РИФ-РЛМ-С";

      Label11->Caption = "Пороги";
      Label11->Visible = true;

      Label12->Caption = "Условие сработки";
      Label12->Visible = true;

      Label14->Visible = true;

      ComboBox1->Items->Clear();
      ComboBox1->Items->Add("Не определено");
      ComboBox1->Items->Add("10 (чувствит.)");
      ComboBox1->Items->Add("09");
      ComboBox1->Items->Add("08");
      ComboBox1->Items->Add("07");
      ComboBox1->Items->Add("06");
      ComboBox1->Items->Add("05");
      ComboBox1->Items->Add("04");
      ComboBox1->Items->Add("03");
      ComboBox1->Items->Add("02");
      ComboBox1->Items->Add("01 (груб.)");
      ComboBox1->Items->Add(".6");
      ComboBox1->Items->Add(".5");
      ComboBox1->Items->Add(".4");
      ComboBox1->Items->Add(".3");
      ComboBox1->Items->Add(".2");
      ComboBox1->Items->Add(".1 (самый груб.)");
      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;
      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;

      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Неопределено");
      ComboBox2->Items->Add("Основной");
      ComboBox2->Items->Add("Дополнительный");
      ComboBox2->Items->Add("Ползущий (Плз)");
      ComboBox2->Items->Add("2-й ярус (2Яр)");
      ComboBox2->ItemIndex = 0;
      ComboBox2->Visible = true;

      ComboBox5->Items->Clear();
      ComboBox5->Items->Add("Неопределено");
      ComboBox5->Items->Add("Такт 1");
      ComboBox5->Items->Add("Такт 2");
      ComboBox5->Items->Add("Такт 3");
      ComboBox5->Items->Add("Такт 4");
      ComboBox5->Items->Add("Такт 5");
      ComboBox5->ItemIndex = 0;
      ComboBox5->Visible = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == 8 )
   {
      GroupBox2->Caption = "Настройка-Торос, Трасса-2л";

      Label11->Caption = "Пороги (луч 1)";
      Label11->Visible = true;

      Label12->Caption = "Пороги (луч 2)";
      Label12->Visible = true;

      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;

      ComboBox2->Items->Clear();
      ComboBox2->Items = ComboBox1->Items;
      ComboBox2->ItemIndex = 0;
      ComboBox2->Visible = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == 9 )
   {
      GroupBox2->Caption = "Настройка-Наст";

      Label11->Caption = "Пороги \"чужой\"";
      Label11->Visible = true;

      Label15->Caption = "Пороги \"свой\"";
      Label15->Visible = true;

      Label12->Caption = "Режим работы \"чужой\"";
      Label12->Visible = true;

      Label16->Caption = "Режим работы \"свой\"";
      Label16->Visible = true;

      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;

      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Неопределено");
      ComboBox2->Items->Add("Луч используется");
      ComboBox2->Items->Add("Луч не используется");
      ComboBox2->ItemIndex = 0;
      ComboBox2->Visible = true;

      ComboBox6->Items->Clear();
      ComboBox6->Items = ComboBox1->Items;
      ComboBox6->ItemIndex = 0;
      ComboBox6->Visible = true;

      ComboBox7->Items->Clear();
      ComboBox7->Items = ComboBox2->Items;
      ComboBox7->ItemIndex = 0;
      ComboBox7->Visible = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == 91 )
   {
      GroupBox2->Caption = "Настройка-Радар";

      Label11->Caption = "Пороги (зона 1)";
      Label11->Visible = true;

      Label12->Caption = "Пороги (зона 2)";
      Label12->Visible = true;

      Label14->Caption = "Пороги (зона 3)";
      Label14->Visible = true;

      Label16->Caption = "Дальность";
      Label16->Visible = true;

      ComboBox1->Items->Clear();
      ComboBox1->Items->Add("Не определено");
      ComboBox1->Items->Add("Откл");
      ComboBox1->Items->Add("2 (грубый)");
      ComboBox1->Items->Add("3");
      ComboBox1->Items->Add("4");
      ComboBox1->Items->Add("5");
      ComboBox1->Items->Add("6");
      ComboBox1->Items->Add("7");
      ComboBox1->Items->Add("8");
      ComboBox1->Items->Add("9");
      ComboBox1->Items->Add("10 (чувств)");
      ComboBox1->ItemIndex = 0;
      ComboBox1->Visible = true;

      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Не определено");
      ComboBox2->Items->Add("Откл");
      ComboBox2->Items->Add("2 (грубый)");
      ComboBox2->Items->Add("3");
      ComboBox2->Items->Add("4");
      ComboBox2->Items->Add("5");
      ComboBox2->Items->Add("6");
      ComboBox2->Items->Add("7");
      ComboBox2->Items->Add("8");
      ComboBox2->Items->Add("9");
      ComboBox2->Items->Add("10 (чувств)");
      ComboBox2->ItemIndex = 0;
      ComboBox2->Visible = true;

      ComboBox6->Items->Clear();
      ComboBox6->Items->Add("Не определено");
      ComboBox6->Items->Add("Откл");
      ComboBox6->Items->Add("2 (грубый)");
      ComboBox6->Items->Add("3");
      ComboBox6->Items->Add("4");
      ComboBox6->Items->Add("5");
      ComboBox6->Items->Add("6");
      ComboBox6->Items->Add("7");
      ComboBox6->Items->Add("8");
      ComboBox6->Items->Add("9");
      ComboBox6->Items->Add("10 (чувств)");
      ComboBox6->ItemIndex = 0;
      ComboBox6->Visible = true;

      ComboBox7->Items->Clear();
      ComboBox7->Items->Add("Не определено");
      ComboBox7->Items->Add("1 (min)");
      ComboBox7->Items->Add("2");
      ComboBox7->Items->Add("3");
      ComboBox7->Items->Add("4");
      ComboBox7->Items->Add("5");
      ComboBox7->Items->Add("6");
      ComboBox7->Items->Add("7");
      ComboBox7->Items->Add("8 (max)");
      ComboBox7->ItemIndex = 0;
      ComboBox7->Visible = true;
      ComboBox7->Enabled = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == 10 )  
   {
      Label11->Caption = "Вход ЧЭ";
      Label11->Visible = !POprosObj(ObjTree->Selected->Data)->Bazalt;
      ComboBox1->Items->Clear();

//      if( POprosObj(ObjTree->Selected->Data)->Num2 == 1 )
      {
         ComboBox1->Items->Add("1");
         ComboBox1->Items->Add("2");
      }
//      else
      {
         ComboBox1->Items->Add("3");
         ComboBox1->Items->Add("4");
      }
      ComboBox1->ItemIndex = POprosObj(ObjTree->Selected->Data)->Num2-1;
      ComboBox1->Enabled = false;
      ComboBox1->Visible = true;

      Label37->Visible = true;
      CheckBox1->Checked = false;
      CheckBox1->Visible = true;

      Label38->Visible = true;
      CheckBox2->Checked = false;
      CheckBox2->Visible = true;

      Label39->Visible = true;
      CheckBox3->Checked = false;
      CheckBox3->Visible = true;

      Label40->Caption = "Порог";
      Label40->Visible = true;
//      CSpinEdit1->Visible = true;
//      CSpinEdit1->Enabled = true;
//      ComboBox18->Items->Clear();
//      for( int i = 1; i <= 199; i++ ) ComboBox18->Items->Add(IntToStr(i*5));
//      for( int i = 1; i <= 49999; i++ ) ComboBox18->Items->Add(IntToStr(i));
//      ComboBox18->ItemIndex = 0;
//     ComboBox18->Enabled = true;


      Label41->Caption = "Порог";
      Label41->Visible = true;
//      CSpinEdit2->Visible = true;
//      CSpinEdit2->Enabled = true;
//      ComboBox19->Items->Clear();
//      for( int i = 1; i <= 199; i++ ) ComboBox19->Items->Add(IntToStr(i*5));
//      for( int i = 1; i <= 49999; i++ ) ComboBox19->Items->Add(IntToStr(i));
//      ComboBox19->ItemIndex = 0;
//      ComboBox19->Enabled = true;

      Label42->Caption = "Порог";
      Label42->Visible = true;
//      CSpinEdit3->Visible = true;
//      CSpinEdit3->Enabled = true;
//      ComboBox20->Items->Clear();
//      for( int i = 1; i <= 199; i++ ) ComboBox20->Items->Add(IntToStr(i*5));
//      for( int i = 1; i <= 49999; i++ ) ComboBox20->Items->Add(IntToStr(i));
//      ComboBox20->ItemIndex = 0;
//      ComboBox20->Enabled = true;

      BitBtn1->Visible = true;
      BitBtn2->Visible = true;
   }
   else if( type == TochkaMDdIdx )
   {
      AnsiString str;

      ScrollBox2->Height = 400;
      GroupBox2->Height = 650;

      Label11->Caption = "Ф1ЧЭ1";
      Label11->Visible = true;
      ComboBox1->Items->Clear();
      ComboBox1->Items->Add("Выкл");
      ComboBox1->Items->Add("Вкл");
      ComboBox1->ItemIndex = 0;
      ComboBox1->Enabled = true;
      ComboBox1->Visible = true;

      Label12->Caption = "Ф2ЧЭ1";
      Label12->Visible = true;
      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Выкл");
      ComboBox2->Items->Add("Вкл");
      ComboBox2->ItemIndex = 0;
      ComboBox2->Enabled = true;
      ComboBox2->Visible = true;

      Label15->Caption = "Порог Ф1ЧЭ1";
      Label15->Visible = true;
      CSpinEdit4->MaxValue = 65535;
      CSpinEdit4->MinValue = 1;
      CSpinEdit4->Value = 1;
      CSpinEdit4->Increment = 1;
      CSpinEdit4->Visible = true;

      Label16->Caption = "Порог Ф2ЧЭ1";
      Label16->Visible = true;
      CSpinEdit5->MaxValue = 65535;
      CSpinEdit5->MinValue = 1;
      CSpinEdit5->Value = 1;
      CSpinEdit5->Increment = 1;
      CSpinEdit5->Visible = true;

      Label93->Caption = "Время возд. Ф1ЧЭ1";
      Label93->Visible = true;
      ComboBox21->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox21->Items->Add(str);
      }
      ComboBox21->ItemIndex = 0;
      ComboBox21->Enabled = true;
      ComboBox21->Visible = true;

      Label94->Caption = "Время возд. Ф2ЧЭ1";
      Label94->Visible = true;
      ComboBox22->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox22->Items->Add(str);
      }
      ComboBox22->ItemIndex = 0;
      ComboBox22->Enabled = true;
      ComboBox22->Visible = true;

      Label104->Caption = "Число возд. Ф1ЧЭ1";
      Label104->Top = Label94->Top + 48;
      Label104->Visible = true;
      ComboBox23->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox23->Items->Add(str);
      }
      ComboBox23->ItemIndex = 0;
      ComboBox23->Enabled = true;
      ComboBox23->Top = ComboBox22->Top + 48;
      ComboBox23->Visible = true;

      Label105->Caption = "Число возд. Ф2ЧЭ1";
      Label105->Top = Label94->Top + 48;
      Label105->Visible = true;
      ComboBox24->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox24->Items->Add(str);
      }
      ComboBox24->ItemIndex = 0;
      ComboBox24->Enabled = true;
      ComboBox24->Top = ComboBox22->Top + 48;
      ComboBox24->Visible = true;

      Label106->Caption = "Длит. преод. Ф1ЧЭ1";
      Label106->Top = Label104->Top + 48;
      Label106->Visible = true;
      CSpinEdit6->MaxValue = 100;
      CSpinEdit6->MinValue = 1;
      CSpinEdit6->Value = 1;
      CSpinEdit6->Increment = 1;
      CSpinEdit6->Top = ComboBox23->Top + 48;
      CSpinEdit6->Visible = true;

      Label107->Caption = "Длит. преод. Ф2ЧЭ1";
      Label107->Top = Label105->Top + 48;
      Label107->Visible = true;
      CSpinEdit7->MaxValue = 100;
      CSpinEdit7->MinValue = 1;
      CSpinEdit7->Value = 1;
      CSpinEdit7->Increment = 1;
      CSpinEdit7->Top = ComboBox24->Top + 48;
      CSpinEdit7->Visible = true;

      Label118->Caption = "Ослабление ЧЭ1";
      Label118->Top = Label106->Top + 48;
      Label118->Visible = true;
      ComboBox31->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox31->Items->Add(str);
      }
      ComboBox31->ItemIndex = 0;
      ComboBox31->Enabled = true;
      ComboBox31->Top = CSpinEdit6->Top + 48;
      ComboBox31->Width = 2*CSpinEdit7->Width + 14;
      ComboBox31->Visible = true;

      Label108->Caption = "Ф1ЧЭ2";
      Label108->Top = Label118->Top + 48;
      Label108->Visible = true;
      ComboBox25->Items->Clear();
      ComboBox25->Items->Add("Выкл");
      ComboBox25->Items->Add("Вкл");
      ComboBox25->ItemIndex = 0;
      ComboBox25->Enabled = true;
      ComboBox25->Top = ComboBox31->Top + 48;
      ComboBox25->Visible = true;

      Label109->Caption = "Ф2ЧЭ2";
      Label109->Visible = true;
      Label109->Top = Label118->Top + 48;
      ComboBox26->Items->Clear();
      ComboBox26->Items->Add("Выкл");
      ComboBox26->Items->Add("Вкл");
      ComboBox26->ItemIndex = 0;
      ComboBox26->Enabled = true;
      ComboBox26->Top = ComboBox31->Top + 48;
      ComboBox26->Visible = true;

      Label110->Caption = "Порог Ф1ЧЭ2";
      Label110->Top = Label108->Top + 48;
      Label110->Visible = true;
      CSpinEdit8->MaxValue = 65535;
      CSpinEdit8->MinValue = 1;
      CSpinEdit8->Value = 1;
      CSpinEdit8->Increment = 1;
      CSpinEdit8->Top = ComboBox26->Top + 48;
      CSpinEdit8->Visible = true;

      Label111->Caption = "Порог Ф2ЧЭ2";
      Label111->Top = Label108->Top + 48;
      Label111->Visible = true;
      CSpinEdit9->MaxValue = 65535;
      CSpinEdit9->MinValue = 1;
      CSpinEdit9->Value = 1;
      CSpinEdit9->Increment = 1;
      CSpinEdit9->Top = ComboBox26->Top + 48;
      CSpinEdit9->Visible = true;

      Label112->Caption = "Время возд. Ф1ЧЭ2";
      Label112->Top = Label111->Top + 48;
      Label112->Visible = true;
      ComboBox27->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox27->Items->Add(str);
      }
      ComboBox27->ItemIndex = 0;
      ComboBox27->Enabled = true;
      ComboBox27->Top = CSpinEdit9->Top + 48;
      ComboBox27->Visible = true;

      Label113->Caption = "Время возд. Ф2ЧЭ2";
      Label113->Top = Label111->Top + 48;
      Label113->Visible = true;
      ComboBox28->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox28->Items->Add(str);
      }
      ComboBox28->ItemIndex = 0;
      ComboBox28->Enabled = true;
      ComboBox28->Top = CSpinEdit9->Top + 48;
      ComboBox28->Visible = true;

      Label114->Caption = "Число возд. Ф1ЧЭ2";
      Label114->Top = Label113->Top + 48;
      Label114->Visible = true;
      ComboBox29->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox29->Items->Add(str);
      }
      ComboBox29->ItemIndex = 0;
      ComboBox29->Enabled = true;
      ComboBox29->Top = ComboBox28->Top + 48;
      ComboBox29->Visible = true;

      Label115->Caption = "Число возд. Ф2ЧЭ2";
      Label115->Top = Label113->Top + 48;
      Label115->Visible = true;
      ComboBox30->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox30->Items->Add(str);
      }
      ComboBox30->ItemIndex = 0;
      ComboBox30->Enabled = true;
      ComboBox30->Top = ComboBox28->Top + 48;
      ComboBox30->Visible = true;

      Label116->Caption = "Длит. преод. Ф1ЧЭ2";
      Label116->Top = Label115->Top + 48;
      Label116->Visible = true;
      CSpinEdit10->MaxValue = 100;
      CSpinEdit10->MinValue = 1;
      CSpinEdit10->Value = 1;
      CSpinEdit10->Increment = 1;
      CSpinEdit10->Top = ComboBox30->Top + 48;
      CSpinEdit10->Visible = true;

      Label117->Caption = "Длит. преод. Ф2ЧЭ2";
      Label117->Top = Label115->Top + 48;
      Label117->Visible = true;
      CSpinEdit11->MaxValue = 100;
      CSpinEdit11->MinValue = 1;
      CSpinEdit11->Value = 1;
      CSpinEdit11->Increment = 1;
      CSpinEdit11->Top = ComboBox30->Top + 48;
      CSpinEdit11->Visible = true;

      Label119->Caption = "Ослабление ЧЭ2";
      Label119->Top = Label117->Top + 48;
      Label119->Left = Label118->Left;
      Label119->Visible = true;
      ComboBox32->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox32->Items->Add(str);
      }
      ComboBox32->ItemIndex = 0;
      ComboBox32->Enabled = true;
      ComboBox32->Top = CSpinEdit11->Top + 48;
      ComboBox32->Width = 2*CSpinEdit7->Width + 14;
      ComboBox32->Left = ComboBox31->Left;
      ComboBox32->Visible = true;

      BitBtn1->Top = ComboBox32->Top + 32;
      BitBtn1->Visible = true;
      BitBtn2->Top = ComboBox32->Top + 32;
      BitBtn2->Visible = true;
   }
   else if( type == SotaMDdIdx )
   {
      AnsiString str;

      ScrollBox2->Height = 300;
      GroupBox2->Height = 300;

      Label11->Caption = "Ф1";
      Label11->Visible = true;
      ComboBox1->Items->Clear();
      ComboBox1->Items->Add("Выкл");
      ComboBox1->Items->Add("Вкл");
      ComboBox1->ItemIndex = 0;
      ComboBox1->Enabled = true;
      ComboBox1->Visible = true;

      Label12->Caption = "Ф2";
      Label12->Visible = true;
      ComboBox2->Items->Clear();
      ComboBox2->Items->Add("Выкл");
      ComboBox2->Items->Add("Вкл");
      ComboBox2->ItemIndex = 0;
      ComboBox2->Enabled = true;
      ComboBox2->Visible = true;

      Label15->Caption = "Порог Ф1";
      Label15->Visible = true;
      CSpinEdit4->MaxValue = 65535;
      CSpinEdit4->MinValue = 1;
      CSpinEdit4->Value = 1;
      CSpinEdit4->Increment = 1;
      CSpinEdit4->Visible = true;

      Label16->Caption = "Порог Ф2";
      Label16->Visible = true;
      CSpinEdit5->MaxValue = 65535;
      CSpinEdit5->MinValue = 1;
      CSpinEdit5->Value = 1;
      CSpinEdit5->Increment = 1;
      CSpinEdit5->Visible = true;

      Label93->Caption = "Время возд. Ф1";
      Label93->Visible = true;
      ComboBox21->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox21->Items->Add(str);
      }
      ComboBox21->ItemIndex = 0;
      ComboBox21->Enabled = true;
      ComboBox21->Visible = true;

      Label94->Caption = "Время возд. Ф2";
      Label94->Visible = true;
      ComboBox22->Items->Clear();
      for( int i = 1; i < 41; i++ )
      {
         str.sprintf("%2.1f", double(i)/10.0);
         ComboBox22->Items->Add(str);
      }
      ComboBox22->ItemIndex = 0;
      ComboBox22->Enabled = true;
      ComboBox22->Visible = true;

      Label104->Caption = "Число возд. Ф1";
      Label104->Top = Label94->Top + 48;
      Label104->Visible = true;
      ComboBox23->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox23->Items->Add(str);
      }
      ComboBox23->ItemIndex = 0;
      ComboBox23->Enabled = true;
      ComboBox23->Top = ComboBox22->Top + 48;
      ComboBox23->Visible = true;

      Label105->Caption = "Число возд. Ф2";
      Label105->Top = Label94->Top + 48;
      Label105->Visible = true;
      ComboBox24->Items->Clear();
      for( int i = 1; i < 11; i++ )
      {
         str.sprintf("%d",i);
         ComboBox24->Items->Add(str);
      }
      ComboBox24->ItemIndex = 0;
      ComboBox24->Enabled = true;
      ComboBox24->Top = ComboBox22->Top + 48;
      ComboBox24->Visible = true;

      Label106->Caption = "Длит. преод. Ф1";
      Label106->Top = Label104->Top + 48;
      Label106->Visible = true;
      CSpinEdit6->MaxValue = 100;
      CSpinEdit6->MinValue = 1;
      CSpinEdit6->Value = 1;
      CSpinEdit6->Increment = 1;
      CSpinEdit6->Top = ComboBox23->Top + 48;
      CSpinEdit6->Visible = true;

      Label107->Caption = "Длит. преод. Ф2";
      Label107->Top = Label105->Top + 48;
      Label107->Visible = true;
      CSpinEdit7->MaxValue = 100;
      CSpinEdit7->MinValue = 1;
      CSpinEdit7->Value = 1;
      CSpinEdit7->Increment = 1;
      CSpinEdit7->Top = ComboBox24->Top + 48;
      CSpinEdit7->Visible = true;

      BitBtn1->Top = CSpinEdit7->Top + 32;
      BitBtn1->Visible = true;
      BitBtn2->Top = CSpinEdit7->Top + 32;
      BitBtn2->Visible = true;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ToolButton1Click(TObject *Sender)
{
   SoundResetItemClick(this);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ToolButton2Click(TObject *Sender)
{
   AlarmResetItemClick(this);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DkRifAllItemClick(TObject *Sender)
{
   Dk_Rif(false);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SpoolerClearItemClick(TObject *Sender)
{
   AnsiString str = ExtractFilePath(Application->ExeName);

   HANDLE hWritePipe;

   STARTUPINFO si;
   memset(&si, 0, sizeof(STARTUPINFO));
   si.cb = sizeof(STARTUPINFO);
   si.dwFlags = STARTF_USESHOWWINDOW |STARTF_USESTDHANDLES;
   si.wShowWindow = SW_HIDE;
   si.hStdOutput = hWritePipe;
   si.hStdError = hWritePipe;

   PROCESS_INFORMATION pi;
   assert(hWritePipe);

   CreateProcess(NULL, "spoolercleaner.exe -all", NULL, NULL, true, 0, 0, 0, &si, &pi);
   CloseHandle(pi.hThread);
   WaitForSingleObject(pi.hProcess, 90000);
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DBGrid1KeyPress(TObject *Sender, char &Key)
{
   if( Key == '+' )
   {
      if( DBGrid1->Font->Size < 16 )
      {
         DBGrid1->Font->Size += 2;
         ObjTree->Font->Size += 2;
      }
   }
   else
   {
      if( DBGrid1->Font->Size >= 10 )
      {
         DBGrid1->Font->Size -= 2;
         ObjTree->Font->Size -= 2;
      }
   }
   DBGrid1->Update();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::N18Click(TObject *Sender)
{
   DBGrid1KeyPress(this, '+' );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::N19Click(TObject *Sender)
{
   DBGrid1KeyPress(this, '-' );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AboutItemClick(TObject *Sender)
{
   AboutDlg = new TAboutDlg(this);
   AboutDlg->ShowModal();
   delete AboutDlg;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Server2ClientError(TObject *Sender,
      TCustomWinSocket *Socket, TErrorEvent ErrorEvent, int &ErrorCode)
{
   try
   {
      ErrorCode = 0;
      Server2->Socket->Close();
      Server2->Active = false;
   }
   catch(...)
   {
   ;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkKan1ItemClick(TObject *Sender)
{
   Dk_Ssoi_Kan( false, 0 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkKan2ItemClick(TObject *Sender)
{
   Dk_Ssoi_Kan( false, 1 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkKan3ItemClick(TObject *Sender)
{
   Dk_Ssoi_Kan( false, 2 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkKan4ItemClick(TObject *Sender)
{
   Dk_Ssoi_Kan( false, 3 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Metka_pdiClick(TObject *Sender)
{
   /* Настроить объект */
   GroupBox9->Visible = !GroupBox9->Visible;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Button1Click(TObject *Sender)
{
      int n1 = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int n2 = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int n3 = POprosObj(ObjTree->Selected->Data)->Num3-1;

      if( POprosObj(ObjTree->Selected->Data)->Metka1Time_0 != ComboBox8->ItemIndex ||
          POprosObj(ObjTree->Selected->Data)->Metka1Time_1 != ComboBox9->ItemIndex )
      {
         POprosObj(ObjTree->Selected->Data)->Metka1Time_0 = ComboBox8->ItemIndex;
         POprosObj(ObjTree->Selected->Data)->Metka1Time_1 = ComboBox9->ItemIndex;
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka1Ok = false;
      }

      if( POprosObj(ObjTree->Selected->Data)->Metka2Time_0 != ComboBox10->ItemIndex ||
          POprosObj(ObjTree->Selected->Data)->Metka2Time_1 != ComboBox11->ItemIndex )
      {
         POprosObj(ObjTree->Selected->Data)->Metka2Time_0 = ComboBox10->ItemIndex;
         POprosObj(ObjTree->Selected->Data)->Metka2Time_1 = ComboBox11->ItemIndex;
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka2Ok = false;
      }

      if( POprosObj(ObjTree->Selected->Data)->Metka3Time_0 != ComboBox12->ItemIndex ||
          POprosObj(ObjTree->Selected->Data)->Metka3Time_1 != ComboBox13->ItemIndex )
      {
         POprosObj(ObjTree->Selected->Data)->Metka3Time_0 = ComboBox12->ItemIndex;
         POprosObj(ObjTree->Selected->Data)->Metka3Time_1 = ComboBox13->ItemIndex;
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka3Ok = false;
      }

      if( POprosObj(ObjTree->Selected->Data)->Metka4Time_0 != ComboBox16->ItemIndex ||
          POprosObj(ObjTree->Selected->Data)->Metka4Time_1 != ComboBox17->ItemIndex )
      {
         POprosObj(ObjTree->Selected->Data)->Metka4Time_0 = ComboBox16->ItemIndex;
         POprosObj(ObjTree->Selected->Data)->Metka4Time_1 = ComboBox17->ItemIndex;
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka4Ok = false;
      }


      POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_0 = ComboBox14->ItemIndex;
      POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_1 = ComboBox15->ItemIndex;

      if( POprosObj(ObjTree->Selected->Data)->Metka1Time_0 != 0 )
      {
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka1Time = EncodeTime( (Word)(POprosObj(ObjTree->Selected->Data)->Metka1Time_0-1),
                                                                   (Word)POprosObj(ObjTree->Selected->Data)->Metka1Time_1, 0,0) ;
      }
      else GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka1Time = 0.0;

      if( POprosObj(ObjTree->Selected->Data)->Metka2Time_0 != 0 )
      {
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka2Time = EncodeTime( (Word)(POprosObj(ObjTree->Selected->Data)->Metka2Time_0-1),
                                                                   (Word)POprosObj(ObjTree->Selected->Data)->Metka2Time_1, 0,0) ;
      }
      else GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka2Time = 0.0;

      if( POprosObj(ObjTree->Selected->Data)->Metka3Time_0 != 0 )
      {
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka3Time = EncodeTime( (Word)(POprosObj(ObjTree->Selected->Data)->Metka3Time_0-1),
                                                                   (Word)POprosObj(ObjTree->Selected->Data)->Metka3Time_1, 0,0) ;
      }
      else GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka3Time = 0.0;

      if( POprosObj(ObjTree->Selected->Data)->Metka4Time_0 != 0 )
      {
         GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka4Time = EncodeTime( (Word)(POprosObj(ObjTree->Selected->Data)->Metka4Time_0-1),
                                                                   (Word)POprosObj(ObjTree->Selected->Data)->Metka4Time_1, 0,0) ;
      }
      else GobiSys->Kanal[n1].Bl[n2].Sd[n3].Metka4Time = 0.0;

      GobiSys->Kanal[n1].Bl[n2].Sd[n3].MetkaDopuskTime = EncodeTime( (Word)POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_0,
                                                                   (Word)POprosObj(ObjTree->Selected->Data)->MetkaDopuskTime_1, 0,0) ;
/*
      Word Hour, Min, Sec, MSec;
      DecodeTime(GobiSys->Kanal[n1].Bl[n2].Sd[n3].MetkaDopuskTime, Hour, Min, Sec, MSec);
      int temp1 = 0;
*/
}
//---------------------------------------------------------------------------
bool TMainForm::SaveGlobalConfig( AnsiString fp )
{
      TMemIniFile *ini;
      ini = new TMemIniFile(fp);

      AnsiString str;
      for( int i = 1; i < ObjTree->Items->Count; i++ )
      {
         str.sprintf("Obj_%d", i);
         ini->WriteInteger(str.c_str(), "Metka1Time_0", POprosObj(ObjTree->Items->Item[i]->Data)->Metka1Time_0);
         ini->WriteInteger(str.c_str(), "Metka1Time_1", POprosObj(ObjTree->Items->Item[i]->Data)->Metka1Time_1);
         ini->WriteInteger(str.c_str(), "Metka2Time_0", POprosObj(ObjTree->Items->Item[i]->Data)->Metka2Time_0);
         ini->WriteInteger(str.c_str(), "Metka2Time_1", POprosObj(ObjTree->Items->Item[i]->Data)->Metka2Time_1);
         ini->WriteInteger(str.c_str(), "Metka3Time_0", POprosObj(ObjTree->Items->Item[i]->Data)->Metka3Time_0);
         ini->WriteInteger(str.c_str(), "Metka3Time_1", POprosObj(ObjTree->Items->Item[i]->Data)->Metka3Time_1);
         ini->WriteInteger(str.c_str(), "Metka4Time_0", POprosObj(ObjTree->Items->Item[i]->Data)->Metka4Time_0);
         ini->WriteInteger(str.c_str(), "Metka4Time_1", POprosObj(ObjTree->Items->Item[i]->Data)->Metka4Time_1);
         ini->WriteInteger(str.c_str(), "MetkaDopuskTime_0", POprosObj(ObjTree->Items->Item[i]->Data)->MetkaDopuskTime_0);
         ini->WriteInteger(str.c_str(), "MetkaDopuskTime_1", POprosObj(ObjTree->Items->Item[i]->Data)->MetkaDopuskTime_1);
      }

      ini->UpdateFile();
      delete ini;

      return true;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiCamTimerTimer(TObject *Sender)
{
   if( HandCam.hcmd == -1 )
   {
      for( int i = 0; i < KanCnt; i++ )
      for( int j = 0; j < BlCnt; j++ )
      for( int k = 0; k < IuCnt; k++ )
      {
         if( GobiSys->Kanal[i].Use )
         {
            if( GobiSys->Kanal[i].Bl[j].Use )
            {
               if( GobiSys->Kanal[i].Bl[j].Iu[k].GobiCam )
               {
                  if( GobiSys->Kanal[i].Bl[j].Iu[k].Status != 1 &&
                      GobiSys->Kanal[i].Bl[j].Iu[k].Use )
                  {

                     if( i != HandCam.k ||
                         j != HandCam.bl ||
                         k != HandCam.iu )
                     {
                        SsoiSerial.IuCmd( i+1, j+1, 2, 2, 2 );
                        goto m1;
                     }
                  }
               }
            }
         }
      }
   }
   else
   {
      int i = HandCam.k;
      int j = HandCam.bl;
      int k = HandCam.iu;
      if( k == 0 ) SsoiSerial.IuCmd( i+1, j+1, HandCam.hcmd, 2, 2 );
      else if( k == 1 ) SsoiSerial.IuCmd( i+1, j+1, 2, HandCam.hcmd, 2 );
      else if( k == 2 ) SsoiSerial.IuCmd( i+1, j+1, 1, 1, HandCam.hcmd );
      HandCam.hcmd = -1;

      if( GobiSys->GobiCam[0].k == HandCam.k &&
          GobiSys->GobiCam[0].bl == HandCam.bl &&
          GobiSys->GobiCam[0].iu == HandCam.iu )
      {
         if( HandCamCnt == 1 )
         {
            GobiSys->GobiCam[0].k = (-1);
            GobiSys->GobiCam[0].bl = (-1);
            GobiSys->GobiCam[0].iu = (-1);
         }
      }
      if( GobiSys->GobiCam[1].k == HandCam.k &&
          GobiSys->GobiCam[1].bl == HandCam.bl &&
          GobiSys->GobiCam[1].iu == HandCam.iu )
      {
         if( HandCamCnt == 1 )
         {
            GobiSys->GobiCam[1].k = (-1);
            GobiSys->GobiCam[1].bl = (-1);
            GobiSys->GobiCam[1].iu = (-1);
         }
      }
      if( GobiSys->GobiCam[2].k == HandCam.k &&
          GobiSys->GobiCam[2].bl == HandCam.bl &&
          GobiSys->GobiCam[2].iu == HandCam.iu )
      {
         if( HandCamCnt == 1 )
          {
            GobiSys->GobiCam[2].k = (-1);
            GobiSys->GobiCam[2].bl = (-1);
            GobiSys->GobiCam[2].iu = (-1);
          }
      }
      if( GobiSys->GobiCam[3].k == HandCam.k &&
          GobiSys->GobiCam[3].bl == HandCam.bl &&
          GobiSys->GobiCam[3].iu == HandCam.iu )
      {
         if( HandCamCnt == 1 )
         {
            GobiSys->GobiCam[3].k = (-1);
            GobiSys->GobiCam[3].bl = (-1);
            GobiSys->GobiCam[3].iu = (-1);
/*
            if( Server2->Socket->ActiveConnections != 0 )
            {
               AnsiString str = "start ";
               str = str + handCamstr + " off" + " finish";
               for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
                  Server2->Socket->Connections[i]->SendText(str);
            }
*/
         }
      }
   }

   if( GobiSys->GobiCam[0].k != (-1) && HandCamCnt == 0 )
   {
      HandCam.k = GobiSys->GobiCam[0].k;
      HandCam.bl = GobiSys->GobiCam[0].bl;
      HandCam.iu = GobiSys->GobiCam[0].iu;
      HandCam.hcmd = 1;

      if( Server2->Socket->ActiveConnections != 0 && GobiTv )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " on" +" finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }
   else if( GobiSys->GobiCam[0].k == (-1) && GobiSys->GobiCam[1].k != (-1) && HandCamCnt == 0  )
   {
      HandCam.k = GobiSys->GobiCam[1].k;
      HandCam.bl = GobiSys->GobiCam[1].bl;
      HandCam.iu = GobiSys->GobiCam[1].iu;
      HandCam.hcmd = 1;

      if( Server2->Socket->ActiveConnections != 0 && GobiTv )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " on" + " finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }
   else if( GobiSys->GobiCam[0].k == (-1) &&
            GobiSys->GobiCam[1].k == (-1) &&
            GobiSys->GobiCam[2].k != (-1)  && HandCamCnt == 0  )
   {
      HandCam.k = GobiSys->GobiCam[2].k;
      HandCam.bl = GobiSys->GobiCam[2].bl;
      HandCam.iu = GobiSys->GobiCam[2].iu;
      HandCam.hcmd = 1;
      if( Server2->Socket->ActiveConnections != 0 && GobiTv  )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " on" + " finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }
   else if( GobiSys->GobiCam[0].k == (-1) &&
            GobiSys->GobiCam[1].k == (-1) &&
            GobiSys->GobiCam[2].k == (-1) &&
            GobiSys->GobiCam[3].k != (-1) && HandCamCnt == 0  )
   {
      HandCam.k = GobiSys->GobiCam[3].k;
      HandCam.bl = GobiSys->GobiCam[3].bl;
      HandCam.iu = GobiSys->GobiCam[3].iu;
      HandCam.hcmd = 1;
      if( Server2->Socket->ActiveConnections != 0 && GobiTv  )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " on" + " finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }
   }
   else if( GobiSys->GobiCam[0].k == (-1) &&
            GobiSys->GobiCam[1].k == (-1) &&
            GobiSys->GobiCam[2].k == (-1) &&
            GobiSys->GobiCam[3].k == (-1) && HandCamCnt == 0 )
   {
      if( GobiSys->GobiCam2[0].k != (-1) )
      {
         GobiSys->GobiCam[0].k = GobiSys->GobiCam2[0].k;
         GobiSys->GobiCam[0].bl = GobiSys->GobiCam2[0].bl;
         GobiSys->GobiCam[0].iu = GobiSys->GobiCam2[0].iu;
      }
      if( GobiSys->GobiCam2[1].k != (-1) )
      {
         GobiSys->GobiCam[1].k = GobiSys->GobiCam2[1].k;
         GobiSys->GobiCam[1].bl = GobiSys->GobiCam2[1].bl;
         GobiSys->GobiCam[1].iu = GobiSys->GobiCam2[1].iu;
      }
      if( GobiSys->GobiCam2[2].k != (-1) )
      {
         GobiSys->GobiCam[2].k = GobiSys->GobiCam2[2].k;
         GobiSys->GobiCam[2].bl = GobiSys->GobiCam2[2].bl;
         GobiSys->GobiCam[2].iu = GobiSys->GobiCam2[2].iu;
      }
      if( GobiSys->GobiCam2[3].k != (-1) )
      {
         GobiSys->GobiCam[3].k = GobiSys->GobiCam2[3].k;
         GobiSys->GobiCam[3].bl = GobiSys->GobiCam2[3].bl;
         GobiSys->GobiCam[3].iu = GobiSys->GobiCam2[3].iu;
      }
   }

m1: ;
   if( HandCamCnt == 0 ) HandCamCnt = 1;
   else HandCamCnt = 0;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkKanalsItemClick(TObject *Sender)
{
  Dk_Ssoi( false );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::GobiDkTimerTimer(TObject *Sender)
{
   if( GobiDkCnt == 0 )
   {
      if( GobiSys->Kanal[0].Use )
      {
         GobiDkKan1ItemClick(this);
      }
      GobiDkCnt += 1;
   }
   else if( GobiDkCnt == 1 && GobiSys->Kanal[0].hCmd == 0 )
   {
      if( GobiSys->Kanal[1].Use )
      {
         GobiDkKan2ItemClick(this);
      }
      GobiDkCnt += 1;
   }
   else if( GobiDkCnt == 2 && GobiSys->Kanal[1].hCmd == 0 )
   {
      if( GobiSys->Kanal[1].Use )
      {
         GobiDkKan3ItemClick(this);
      }
      GobiDkCnt += 1;
   }
   else if( GobiDkCnt == 3 && GobiSys->Kanal[2].hCmd == 0 )
   {
      if( GobiSys->Kanal[1].Use )
      {
         GobiDkKan4ItemClick(this);
      }
      GobiDkTimer->Enabled = false;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::RadarDkItemClick(TObject *Sender)
{
   SetSob( 133,
           0,
           0,
           0,
           0,
           "Радар", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   for( int i = 0; i < RifDevCnt; i++ )
   {
      if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[0] == 1 && RifPortNum[kn]!= 0 )
      {
         if( RifSys->Rk[kn][i].Type == 5 && RifSys->Rk[kn][i].Cmd == 0x22 )
         {
            RifSys->Rk[kn][i].Cmd = 0x21;
            RifSys->Rk[kn][i].CmdCnt = 0;
            RifSys->Rk[kn][i].AutoDk = false;
            RifSys->Rk[kn][i].AutoDkCnt = 0;
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Server2ClientRead(TObject *Sender,
      TCustomWinSocket *Socket)
{
   AnsiString str = Socket->ReceiveText();
   if( str == cam485str )
   {
      for( int i = 0; i < 18; i++ ) cam485[i] = 0;
      for( int i = 0; i < 6; i++ ) cam485_sn[i] = "";
      cam485str = "";
   }

   /* KeepAlive */
   for( int j = 0; j < NetClientMaxCnt; j++ )
   {
      if( r485NetSys->iNetClient[j].IsExist(Socket->SocketHandle) )
      {
         r485NetSys->iNetClient[j].KeepAliveCnt = 0;
         break;
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowNewSsoi2Status( int kan, int adr, bool tin[SdCnt], bool vin )
{
   for( int i = 0; i < SdCnt; i++)
   {
      if( GobiSys2->Bl[kan][adr].Sd[i].Use )
      {
         int n = 6;
         switch( GobiSys2->Bl[kan][adr].Sd[i].Status )
         {
            case  1:
                     if( GobiSys2->Bl[kan][adr].Sd[i].Bazalt && !GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock )
                     {
                        if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && tin[i] ) n = 38;
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && !tin[i] ) n = 37;
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && tin[i] ) n = 38;
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && !tin[i] ) n = 37;
                     }
                     else if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt && GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock )
                     {
                        if( GobiSys2->Bl[kan][adr].Iu[i-3].Status == 1 )
                        {
                           n = 44;
                           if( POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] != 20 )
                           {
                              POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = 20;
                              POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                           }
                        }
                        else if( GobiSys2->Bl[kan][adr].Iu[i-3].Status == 2 )
                        {
                           POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = 1;
                           n = 43;
                        }
                     }
                     else
                     {
                         if( tin[i] )
                         {
                            if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 9;
                            else n = 14;
                         }
                         else
                         {
                            if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 7;
                            else n = 12;
                         }

                         if( i == 8 )
                         {
                           if( tin[i] || vin )
                           {
                              if( GobiSys2->Bl[kan][adr].Sd[8].AlarmFix ) n = 9;
                              else n = 14;
                           }
                           else
                           {
                              if( GobiSys2->Bl[kan][adr].Sd[8].AlarmFix ) n = 7;
                              else n = 12;
                           }
                         }
                     }
                     break;
            case  3: if( tin[i] || (vin && i==8) )
                     {
                       if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 9;
                       else n = 14;
                     }
                     else
                     {
                       if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 7;
                       else n = 12;
                     }
                     break;
            case 10: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 8;
                     else n = 13;
                     GobiSys2->Bl[kan][adr].Sd[i].BazaltCmd2 = false;
                     break;
            case 11: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 10;
                     else n = 32;
                     break;
            case 13: if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
                     {
                       if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 10;
                       else n = 32;
                     }
                     else
                     {
                        if( !GobiSys2->Bl[kan][adr].Sd[i].BazaltCmd2 )
                        {
                          if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 10;
                          else n = 32;
                        }
                        else
                        {
                           GobiSys2->Bl[kan][adr].Sd[i].BazaltCmd2 = false;

                           GobiSys2->Bl[kan][adr].Sd[i].Status = GobiSys2->Bl[kan][adr].Sd[i].StatusOld;

                           if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && GobiSys2->Bl[kan][adr].Sd[i].Sin ) GobiSys2->Bl[kan][adr].Iu[i].hCmd = 2;
                           else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && !GobiSys2->Bl[kan][adr].Sd[i].Sin ) GobiSys2->Bl[kan][adr].Iu[i].hCmd = 1;

                           GobiSys2->Bl[kan][adr].Cmd = 0xF2;
                           GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt = BazaltCnt2;

                           CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt;
                           GroupBox5->Visible = true;
                        }
                     }
                     break;
            case 20: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix )
                     {
                       if( GobiSys2->Bl[kan][adr].Sd[i].Bazalt && !GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock ) n = 38;
                       else if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt && GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock ) n = 44;
                       else
                       {
                          n = 9;
                          if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt ) GobiSys2->Bl[kan][adr].Sd[i].Sin = true;
                       }
                     }
                     else n = 14;
                     break;
            case 21: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) n = 9;
                     else n = 14;
                     break;
            default: n = 6;
                     break;
         }

         if( vin )
         {
            GobiSys2->Bl[kan][adr].Sd[8].Status = 21;
         }
         GobiSys2->Bl[kan][adr].Sd[8].Vin = vin;

         if( i < 8 )
         {
            if( GobiSys2->Bl[kan][adr].Sd[i].Status == 1 && tin[i] )
            {
               GobiSys2->Bl[kan][adr].Sd[i].Status = 20;
            }
         }
//         GobiSys2->Bl[kan][adr].Sd[i].Sin = tin[i];

         ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->ImageIndex = n;
         ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->SelectedIndex = n;

         if( GobiSys2->Bl[kan][adr].Sd[i].Status  == 20 && GobiSys2->Bl[kan][adr].Sd[i].Bazalt && GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 21 ) GobiSys2->Bl[kan][adr].Sd[i].Status = 21;

         if( i < 3) POprosOutObj(lpMapOpros)->GobiIu[kan*IuCnt*BlCnt+IuCnt*adr+i] = GobiSys2->Bl[kan][adr].Iu[i].Status;

         if( GobiSys2->Bl[kan][adr].Sd[i].Status == 1 && !GobiSys2->Bl[kan][adr].Sd[i].Bazalt && GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock );
         else
         {
            if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix )
               POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = GobiSys2->Bl[kan][adr].Sd[i].Status;
            else POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = 136;
         }

         if( GobiSys2->Bl[kan][adr].Sd[i].StatusOld != GobiSys2->Bl[kan][adr].Sd[i].Status )
         {
             /* Новое событие */
             switch( GobiSys2->Bl[kan][adr].Sd[i].Status )
             {
                case 10: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) { AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 1) SoundFlag = 3;}
                         break;
                case 11: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix ) { AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; if( SoundFlag != 1) SoundFlag = 3;}
                         break;
                case 20: if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
                         {
                           if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix )
                           {
                              if( !GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock )
                              {
                                 if( !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk && !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleControlOn )
                                 {
                                    AlarmFlag = true;
                                    POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                    SoundFlag = 1;
                                 }
                              }
                              else
                              {
                                 POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                                 if( GobiSys2->Bl[kan][adr].Iu[i-3].Status == 2 ) SoundFlag = 2;
                                 else GobiSys2->Bl[kan][adr].Sd[i].ConnectBlockHand = false;
                              }
                           }
                         }
                         else
                         {
                           if( GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt > 0 )
                           {
                              GobiSys2->Bl[kan][adr].Sd[i].Status = 4;  /* Команда управлния выполнена */
                              GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt = 0;
//                              GroupBox5->Visible = false;
                           }
                           else
                           {
                              GobiSys2->Bl[kan][adr].Sd[i].Status = 21; /* Для замка Сработка=Вскрытие */
                              if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix &&  !GobiSys2->Bl[kan][adr].Sd[i].Bazalt ) { AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1;}
                           }
                         }
                         break;
                case 21: if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix && !GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
                         {
                           if( !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk && !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleControlOn )
                           {
                              AlarmFlag = true; POprosOutObj(lpMapOpros)->AlarmResetFlag = false; SoundFlag = 1;
                           }
                         }
                         break;
             }

//             if( i < 3) POprosOutObj(lpMapOpros)->GobiIu[kan*IuCnt*BlCnt+IuCnt*adr+i] = GobiSys2->Bl[kan][adr].Iu[i].Status;
//             POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = GobiSys2->Bl[kan][adr].Sd[i].Status;

             if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix )
             {

               if( GobiSys2->Bl[kan][adr].Sd[i].Status != 10 && GobiSys2->Bl[kan][adr].Sd[i].Status != 13 && GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
               {
                    int t1 = 111;
                    if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && tin[i] ) t1 = 111;       
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && !tin[i] ) t1 = 112; 
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && tin[i] ) t1 = 113;  
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && !tin[i] ) t1 = 110; 

                    int t2 = 111;
                    if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && GobiSys2->Bl[kan][adr].Sd[i].Sin ) t2 = 111;        
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && !GobiSys2->Bl[kan][adr].Sd[i].Sin ) t2 = 112; 
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && GobiSys2->Bl[kan][adr].Sd[i].Sin ) t2 = 113; 
                    else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && !GobiSys2->Bl[kan][adr].Sd[i].Sin ) t2 = 110; 

                    if( t1 != t2 || GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 0 || GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 13 ||
                        GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 10 )
                    {
                        if( GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 13 && t1 == t2 )
                        {
                           if( t1 == 112 ) t1 = 110;
                           else if( t1 == 113 ) t1 = 111;
                        }

                        GroupBox5->Visible = false;
                        SetSob( t1, 33, (kan+1),(adr+1),(i+1),
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                    }
                    if( GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt > 0 )
                    {
                              GobiSys2->Bl[kan][adr].Sd[i].Status = 4;  
                              GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt = 0;
                    }
               }
               else if( GobiSys2->Bl[kan][adr].Sd[i].Status == 20 && GobiSys2->Bl[kan][adr].Sd[i].ConnectBlock )
               {
                  if( GobiSys2->Bl[kan][adr].Iu[i-3].Status == 2 )
                  {
                     SetSob( 145,
                             33, (kan+1),(adr+1),(i+1),
                             POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn,
                             POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType );
                  }
                  else
                  {
                     if( GobiSys2->Bl[kan][adr].Sd[i].ConnectBlockHand )
                     {
                        SetSob( 143,
                                33, (kan+1),(adr+1),(i+1),
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn,
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType );
                       GobiSys2->Bl[kan][adr].Iu[i-3].hCmd = 1;
                     }
                     else
                     {
                        SetSob( 144,
                                33, (kan+1),(adr+1),(i+1),
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn,
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType );

                        GobiSys2->Bl[kan][adr].Iu[i-3].hCmd = 2;
                     }
                     GobiSys2->Bl[kan][adr].Cmd = 0xF2;

                     GobiSys2->Bl[kan][adr].Sd[i].ConnectBlockHand = false;

                  }
               }
               else if( GobiSys2->Bl[kan][adr].Sd[i].Status == 1 && !GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
               {

                  if( GobiSys2->Bl[kan][adr].Sd[i].Status != GobiSys2->Bl[kan][adr].Sd[i].StatusOld )
                  {
                     if( i < 8 )
                     {
                        if( !tin[i] )
                           SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                                 POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                     }
                     else
                     {
                        if( !vin )
                           SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                                 POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                     }
                  }
/*
                  if( !vin && tin[i] && !GobiSys2->Bl[kan][adr].Sd[i].Vin && !GobiSys2->Bl[kan][adr].Sd[i].Sin )
                     SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                              POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                  else
                  {
                     if( GobiSys2->Bl[kan][adr].Sd[i].Status == 1 &&
                        (GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 10 || GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 20 ||
                         GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 21 || GobiSys2->Bl[kan][adr].Sd[i].StatusOld == -1 || GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 0) && !tin[i] )
                        {
                           SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                                    POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                        }
                  }
*/
                  if( GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 10 )
                     SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                             POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
               }
               else
               {
                  if( GobiSys2->Bl[kan][adr].Sd[i].Status == 3 && GobiSys2->Bl[kan][adr].Sd[i].AutoDk == 1 );
                  else
                  {
                     if( GobiSys2->Bl[kan][adr].Sd[i].Status >= 10 && GobiSys2->Bl[kan][adr].Sd[i].Status < 30 )
                     {
                        if( !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleControlOn && !GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk )
                        {
                           SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                              POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                        }
                        else
                        {
                           SetSob3( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                              POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                        }
                     }
                     else
                     {
                        SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                     }
                  }
               }

               if( GobiSys2->Bl[kan][adr].Sd[i].Bazalt && GobiSys2->Bl[kan][adr].Sd[i].Status == 13 && GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt == 1 )
                  GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt = 0;

               if( GobiSys2->Bl[kan][adr].Sd[i].Status >= 20 && GobiSys2->Bl[kan][adr].Sd[i].Status < 30 &&
                   ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->HasChildren )
               {
                  int idx = 0, bl1 = 0, iu1 = 0;
                  for( int j = 0; j < ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Count; j++ )
                  {
                     idx = ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->AbsoluteIndex+j+1;
                     if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 43 )
                     {
                        bl1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2-1;
                        iu1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3-1;

                        if( GobiSys2->Bl[kan][bl1].Iu[iu1].StatusOld == 2 )
                        {
                           if( GobiSys2->Bl[kan][bl1].Iu[iu1].AutoOff > 0 )
                           {
                              TDateTime adt = Now();
                              int t = GobiSys2->Bl[kan][bl1].Iu[iu1].AutoOff;
                              switch( t )
                              {
                                 case 1: adt = adt + EncodeTime(0,0,5,0);
                                         break;
                                 case 2: adt = adt + EncodeTime(0,0,10,0);
                                         break;
                                 case 3: adt = adt + EncodeTime(0,0,30,0);
                                         break;
                                 case 4: adt = adt + EncodeTime(0,1,0,0);
                                         break;
                                 case 5: adt = adt + EncodeTime(0,5,0,0);
                                         break;
                                 case 6: adt = adt + EncodeTime(0,10,0,0);
                                         break;
                                 case 7: adt = adt + EncodeTime(0,20,0,0);
                                         break;
                                 case 8: adt = adt + EncodeTime(0,30,0,0);
                                         break;
                                 case 9: adt = adt + EncodeTime(1,0,0,0);
                                         break;
                                 default: adt = adt + EncodeTime(0,0,5,0);
                                         break;
                              }
                              GobiSys2->Bl[kan][bl1].Iu[iu1].OffDt = adt;
                           }

                           GobiSys2->Bl[kan][bl1].Iu[iu1].hCmd = 1;
                           GobiSys2->Bl[kan][bl1].Cmd = 0xF2;
                        }
                     }
                     else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == Stn485Type )
                     {
                        int num1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1;
                        int num2 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;
                        int num3 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3;
                        AnsiString sn = POprosObj(ObjTree->Items->Item[idx]->Data)->Icon1Path;

                        if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                        {
                           cam485[0] = num1;
                           cam485[1] = num2;
                           cam485[2] = num3;
                           cam485_sn[0] = sn;
                        }
                        else
                        {
                           if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                           {
                              cam485[3] = num1;
                              cam485[4] = num2;
                              cam485[5] = num3;
                              cam485_sn[1] = sn;
                           }
                           else
                           {
                              if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                              {
                                 cam485[6] = num1;
                                 cam485[7] = num2;
                                 cam485[8] = num3;
                                 cam485_sn[2] = sn;
                              }
                              else
                              {
                                 if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                 {
                                    cam485[9] = num1;
                                    cam485[10] = num2;
                                    cam485[11] = num3;
                                    cam485_sn[3] = sn;
                                 }
                                 else
                                 {
                                    if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                    {
                                       cam485[12] = num1;
                                       cam485[13] = num2;
                                       cam485[14] = num3;
                                       cam485_sn[4] = sn;
                                    }
                                    else
                                    {
                                       if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                       {
                                          cam485[15] = num1;
                                          cam485[16] = num2;
                                          cam485[17] = num3;
                                          cam485_sn[5] = sn;
                                       }
                                    }
                                 }
                              }
                           }
                        }
                     }
                     else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == 51 )
                     {
                        int mon = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                        int tv = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;

                        if( mon == 0 )
                        {
                           if( cam1[0] == -1 ) cam1[0] = tv;
                           else
                           {
                              if( cam1[1] == -1 ) cam1[1] = tv;
                              else
                              {
                                 if( cam1[2] == -1 ) cam1[2] = tv;
                                 else
                                 {
                                    if( cam1[3] == -1 ) cam1[3] = tv;
                                    else
                                    {
                                       cam1[0] = cam1[1];
                                       cam1[1] = cam1[2];
                                       cam1[2] = cam1[3];
                                       cam1[3] = tv;
                                    }
                                 }
                              }
                           }
                        }
                        if( mon == 1 )
                        {
                           if( cam2[0] == -1 ) cam2[0] = tv;
                           else
                           {
                              if( cam2[1] == -1 ) cam2[1] = tv;
                              else
                              {
                                 if( cam2[2] == -1 ) cam2[2] = tv;
                                 else
                                 {
                                    if( cam2[3] == -1 ) cam2[3] = tv;
                                    else
                                    {
                                       cam2[0] = cam2[1];
                                       cam2[1] = cam2[2];
                                       cam2[2] = cam2[3];
                                       cam2[3] = tv;
                                    }
                                 }
                              }
                           }
                        }
                     }
                     else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == TabloType && TabloPortNum != 0 )
                     {
                       int freenum = -1;
                       bool numexist = false;
                       for( int tablonum = 0; tablonum < TabloDevCnt; tablonum++ )
                       {
                          if( TabloSys->Dev[tablonum].Num == 0 && freenum == -1 ) freenum = tablonum;

                          if( TabloSys->Dev[tablonum].Num == POprosObj(ObjTree->Items->Item[idx]->Data)->Num2 ) numexist = true;
                       }

                       if( !numexist && freenum != -1 )
                          TabloSys->Dev[freenum].Num = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;
                     }
                  }
               }
             }
             else POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i] = 136;

             GobiSys2->Bl[kan][adr].Sd[i].AutoDk = 0;

             if( GobiSys2->Bl[kan][adr].Sd[i].AlarmFix && GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleControlOn )
             {
               GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleControlOn = false;
             }

             if( GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk )
             {
                if( GobiSys2->Bl[kan][adr].Sd[i].Status != 11 && GobiSys2->Bl[kan][adr].Sd[i].Status != 3 ) GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk = false;
             }
             else
             {
               if( GobiSys2->Bl[kan][adr].Sd[i].Status == 11 || GobiSys2->Bl[kan][adr].Sd[i].Status == 3 )  GobiSys2->Bl[kan][adr].Sd[i].PervoeSobytiePosleDk = true;
             }
//             GobiSys2->Bl[kan][adr].Sd[i].StatusOld = GobiSys2->Bl[kan][adr].Sd[i].Status;
         }


         if( GobiSys2->Bl[kan][adr].Sd[8].Vin != vin )
         {
            if( GobiSys2->Bl[kan][adr].Sd[8].Vin && !vin && GobiSys2->Bl[kan][adr].Sd[8].AlarmFix && GobiSys2->Bl[kan][adr].Sd[8].Status == 1 && GobiSys2->Bl[kan][adr].Sd[8].StatusOld == 1 )
            {
               if( !tin[8] )
               {
                  SetSob( GobiSys2->Bl[kan][adr].Sd[8].Status, 33, (kan+1),(adr+1),(i+1),
                          POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[8].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[8].AlarmMsgOn, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[8].TreeIdx]->Data)->OutType);

                  GobiSys2->Bl[kan][adr].Sd[8].Vin = vin;
               }
            }
         }

         if( GobiSys2->Bl[kan][adr].Sd[i].Sin != tin[i] )
         {
            if( GobiSys2->Bl[kan][adr].Sd[i].Sin && !tin[i] && GobiSys2->Bl[kan][adr].Sd[i].AlarmFix && GobiSys2->Bl[kan][adr].Sd[i].Status == 1 && GobiSys2->Bl[kan][adr].Sd[i].StatusOld == 1 )
            {
               if( !vin )
               {
                     if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt )
                     {
//                        SetSob( GobiSys2->Bl[kan][adr].Sd[i].Status, 33, (kan+1),(adr+1),(i+1),
//                                 POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                     }
                     else
                     {
                        if( GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt > 0 )
                        {
                           GobiSys2->Bl[kan][adr].Sd[i].Status = 4;  /* Команда управлния выполнена */
                           GobiSys2->Bl[kan][adr].Sd[i].OnOffCnt = 0;
                           GroupBox5->Visible = false;
                        }

                        int t1 = 111;
                        if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && tin[i] ) t1 = 111;       
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 && !tin[i] ) t1 = 112; 
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && tin[i] ) t1 = 113;  
                        else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 2 && !tin[i] ) t1 = 110; 

                        GroupBox5->Visible = false;
                        SetSob( t1, 33, (kan+1),(adr+1),(i+1),
                                POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn, POprosObj(ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i].TreeIdx]->Data)->OutType);
                     }

                     GobiSys2->Bl[kan][adr].Sd[i].Sin = tin[i];
               }
            }

            if( GobiSys2->Bl[kan][adr].Sd[i].Bazalt ) GobiSys2->Bl[kan][adr].Sd[i].Sin = tin[i];
         }

         GobiSys2->Bl[kan][adr].Sd[i].StatusOld = GobiSys2->Bl[kan][adr].Sd[i].Status;
      }
   }

   for( int i = 0; i < IuCnt; i++)
   {
      if( GobiSys2->Bl[kan][adr].Iu[i].Use )
      {
         if( GobiSys2->Bl[kan][adr].Iu[i].StatusOld != GobiSys2->Bl[kan][adr].Iu[i].Status )
         {
            int n = 6;
            switch( GobiSys2->Bl[kan][adr].Iu[i].Status )
            {
                case  1: n = 23;
                         if( GobiSys2->Bl[kan][adr].Sd[i+3].ConnectBlock )
                         {
                           n = 44;

                           ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i+3].TreeIdx]->ImageIndex = n;
                           ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i+3].TreeIdx]->SelectedIndex = n;

                           POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i+3] = 21;
                           POprosOutObj(lpMapOpros)->AlarmResetFlag = false;
                         }
                         break;
                case  2: n = 24;
                         if( GobiSys2->Bl[kan][adr].Sd[i+3].ConnectBlock )
                         {
                           n = 43;

                           ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i+3].TreeIdx]->ImageIndex = n;
                           ObjTree->Items->Item[GobiSys2->Bl[kan][adr].Sd[i+3].TreeIdx]->SelectedIndex = n;

                           POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*adr+i+3] = 1;
                         }
                         break;
                case 10: n = 8;
                         break;
                default: n = 6;
                         break;
            }

            AnsiString iustr;
            for( int j = 1; j < ObjTree->Items->Count; j++ )
            {
               if( (POprosObj(ObjTree->Items->Item[j]->Data)->Type == 43 ) &&
                   kan == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num1-1) &&
                   adr == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num2-1) &&
                   i == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num3-1) )
               {
                  ObjTree->Items->Item[j]->ImageIndex = n;
                  ObjTree->Items->Item[j]->SelectedIndex = n;
                  iustr = POprosObj(ObjTree->Items->Item[j]->Data)->Name;
               }
            }
            if( !GobiSys2->Bl[kan][adr].Sd[i].Bazalt && !GobiSys2->Bl[kan][adr].Sd[i+4].ConnectBlock )
            {
               if( GobiSys2->Bl[kan][adr].Iu[i].Status == 1 ||  GobiSys2->Bl[kan][adr].Iu[i].Status == 2 ) SetSob( 102-GobiSys2->Bl[kan][adr].Iu[i].Status, 43, (kan+1),(adr+1),(i+1), iustr, OpFn, OpN1, OpN2, "", "", "", false, 0 );
               else if( GobiSys2->Bl[kan][adr].Iu[i].Status == 10 ) SetSob( GobiSys2->Bl[kan][adr].Iu[i].Status, 43, (kan+1),(adr+1),(i+1), iustr, OpFn, OpN1, OpN2, "", "", "", GobiSys2->Bl[kan][adr].Sd[i].AlarmMsgOn, 0 );
            }
            GobiSys2->Bl[kan][adr].Iu[i].StatusOld = GobiSys2->Bl[kan][adr].Iu[i].Status;

//            POprosOutObj(lpMapOpros)->GobiIu[kan*IuCnt*BlCnt+IuCnt*adr+i] = GobiSys2->Bl[kan][adr].Iu[i].Status;
         }
      }
      POprosOutObj(lpMapOpros)->GobiIu[kan*IuCnt*BlCnt+IuCnt*adr+i] = GobiSys2->Bl[kan][adr].Iu[i].Status;
   }

   for( int i = 0; i < IuCnt; i++)
   {
      if( GobiSys2->Bl[kan][adr].Vk[i].Use )
      {
         if( GobiSys2->Bl[kan][adr].Vk[i].StatusOld != GobiSys2->Bl[kan][adr].Vk[i].Status )
         {
            int n = 6;
            switch( GobiSys2->Bl[kan][adr].Vk[i].Status )
            {
                case  1: n = 23;
                         break;
                case  2: n = 24;
                         break;
                case 10: n = 8;
                         break;
                default: n = 6;
                         break;
            }

            AnsiString iustr;
            for( int j = 1; j < ObjTree->Items->Count; j++ )
            {
               if( (POprosObj(ObjTree->Items->Item[j]->Data)->Type == 43 ) &&
                   kan == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num1-1) &&
                   adr == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num2-1) &&
                   i == (PCfgObj(ObjTree->Items->Item[j]->Data)->Num3-4) )
               {
                  ObjTree->Items->Item[j]->ImageIndex = n;
                  ObjTree->Items->Item[j]->SelectedIndex = n;
                  iustr = POprosObj(ObjTree->Items->Item[j]->Data)->Name;
               }
            }
            if( GobiSys2->Bl[kan][adr].Vk[i].Status == 1 ||  GobiSys2->Bl[kan][adr].Vk[i].Status == 2 ) SetSob( 102-GobiSys2->Bl[kan][adr].Vk[i].Status, 43, (kan+1),(adr+1),(i+4), iustr, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else if( GobiSys2->Bl[kan][adr].Vk[i].Status == 10 ) SetSob( GobiSys2->Bl[kan][adr].Vk[i].Status, 43, (kan+1),(adr+1),(i+4), iustr, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            GobiSys2->Bl[kan][adr].Vk[i].StatusOld = GobiSys2->Bl[kan][adr].Vk[i].Status;

         }
      }
      POprosOutObj(lpMapOpros)->GobiVk[kan*IuCnt*BlCnt+IuCnt*adr+i] = GobiSys2->Bl[kan][adr].Vk[i].Status;
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagSsoi2InfoNew(int status, bool t, bool tv, bool vin, bool dk, bool dk_in, bool tin[8], bool ts[8], bool iu[3], bool vk[3])
{
   AnsiString str;
   bool bit = false;

   AdvStringGrid1->ClearCols(1,1);
   AdvStringGrid1->ClearCols(3,1);
   AdvStringGrid1->ClearCols(5,1);
   AdvStringGrid1->Cells[1][0]="Значение";
   AdvStringGrid1->Cells[3][0]="Значение";
   AdvStringGrid1->Cells[5][0]="Значение";

   if( status == 10 ) /* Нет связи */
   {
      AdvStringGrid1->Cells[1][1]="Нет связи!";
      AdvStringGrid1->Cells[1][2]="Нет связи!";
      AdvStringGrid1->Cells[3][2]="Нет связи!";
      AdvStringGrid1->Cells[1][3]="Нет связи!";
      AdvStringGrid1->Cells[3][3]="Нет связи!";
      AdvStringGrid1->Cells[1][4]="Нет связи!";
      AdvStringGrid1->Cells[3][4]="Нет связи!";
      AdvStringGrid1->Cells[5][4]="Нет связи!";
      AdvStringGrid1->Cells[1][5]="Нет связи!";
      AdvStringGrid1->Cells[3][5]="Нет связи!";
      AdvStringGrid1->Cells[5][5]="Нет связи!";

      AdvStringGrid1->Cells[1][6]="Нет связи!";
      AdvStringGrid1->Cells[3][6]="Нет связи!";
      AdvStringGrid1->Cells[1][7]="Нет связи!";
      AdvStringGrid1->Cells[3][7]="Нет связи!";
      AdvStringGrid1->Cells[1][8]="Нет связи!";
      AdvStringGrid1->Cells[3][8]="Нет связи!";
      AdvStringGrid1->Cells[1][9]="Нет связи!";
      AdvStringGrid1->Cells[3][9]="Нет связи!";
      AdvStringGrid1->Cells[1][10]="Нет связи!";
      AdvStringGrid1->Cells[3][10]="Нет связи!";
      AdvStringGrid1->Cells[1][11]="Нет связи!";
      AdvStringGrid1->Cells[3][11]="Нет связи!";
      AdvStringGrid1->Cells[1][12]="Нет связи!";
      AdvStringGrid1->Cells[3][12]="Нет связи!";
      AdvStringGrid1->Cells[1][13]="Нет связи!";
      AdvStringGrid1->Cells[3][13]="Нет связи!";
   }
   else if( status != 10 )
   {
      if(t) AdvStringGrid1->Cells[1][1]="Да [1]";
      else AdvStringGrid1->Cells[1][1]="Нет [0]";

      if(tv) AdvStringGrid1->Cells[1][2]="Да [1]";
      else AdvStringGrid1->Cells[1][2]="Нет [0]";

      if(vin) AdvStringGrid1->Cells[3][2]="Да [1]";
      else AdvStringGrid1->Cells[3][2]="Нет [0]";

      if(dk) AdvStringGrid1->Cells[1][3]="Есть [1]";
      else AdvStringGrid1->Cells[1][3]="Нет [0]";

      if(dk_in) AdvStringGrid1->Cells[3][3]="Есть [1]";
      else AdvStringGrid1->Cells[3][3]="Нет [0]";

      if(iu[0]) AdvStringGrid1->Cells[1][4]="Вкл [1]";
      else AdvStringGrid1->Cells[1][4]="Выкл [0]";

      if(iu[1]) AdvStringGrid1->Cells[3][4]="Вкл [1]";
      else AdvStringGrid1->Cells[3][4]="Выкл [0]";

      if(iu[2]) AdvStringGrid1->Cells[5][4]="Вкл [1]";
      else AdvStringGrid1->Cells[5][4]="Выкл [0]";

      if(vk[0]) AdvStringGrid1->Cells[1][5]="Вкл [1]";
      else AdvStringGrid1->Cells[1][5]="Выкл [0]";

      if(vk[1]) AdvStringGrid1->Cells[3][5]="Вкл [1]";
      else AdvStringGrid1->Cells[3][5]="Выкл [0]";

      if(vk[2]) AdvStringGrid1->Cells[5][5]="Вкл [1]";
      else AdvStringGrid1->Cells[5][5]="Выкл [0]";

      if(ts[0]) AdvStringGrid1->Cells[1][6]="Да [1]";
      else AdvStringGrid1->Cells[1][6]="Нет [0]";
      if(tin[0]) AdvStringGrid1->Cells[3][6]="Да [1]";
      else AdvStringGrid1->Cells[3][6]="Нет [0]";

      if(ts[1]) AdvStringGrid1->Cells[1][7]="Да [1]";
      else AdvStringGrid1->Cells[1][7]="Нет [0]";
      if(tin[1]) AdvStringGrid1->Cells[3][7]="Да [1]";
      else AdvStringGrid1->Cells[3][7]="Нет [0]";

      if(ts[2]) AdvStringGrid1->Cells[1][8]="Да [1]";
      else AdvStringGrid1->Cells[1][8]="Нет [0]";
      if(tin[2]) AdvStringGrid1->Cells[3][8]="Да [1]";
      else AdvStringGrid1->Cells[3][8]="Нет [0]";

      if(ts[3]) AdvStringGrid1->Cells[1][9]="Да [1]";
      else AdvStringGrid1->Cells[1][9]="Нет [0]";
      if(tin[3]) AdvStringGrid1->Cells[3][9]="Да [1]";
      else AdvStringGrid1->Cells[3][9]="Нет [0]";

      if(ts[4]) AdvStringGrid1->Cells[1][10]="Да [1]";
      else AdvStringGrid1->Cells[1][10]="Нет [0]";
      if(tin[4]) AdvStringGrid1->Cells[3][10]="Да [1]";
      else AdvStringGrid1->Cells[3][10]="Нет [0]";

      if(ts[5]) AdvStringGrid1->Cells[1][11]="Да [1]";
      else AdvStringGrid1->Cells[1][11]="Нет [0]";
      if(tin[5]) AdvStringGrid1->Cells[3][11]="Да [1]";
      else AdvStringGrid1->Cells[3][11]="Нет [0]";

      if(ts[6]) AdvStringGrid1->Cells[1][12]="Да [1]";
      else AdvStringGrid1->Cells[1][12]="Нет [0]";
      if(tin[6]) AdvStringGrid1->Cells[3][12]="Да [1]";
      else AdvStringGrid1->Cells[3][12]="Нет [0]";

      if(ts[7]) AdvStringGrid1->Cells[1][13]="Да [1]";
      else AdvStringGrid1->Cells[1][13]="Нет [0]";
      if(tin[7]) AdvStringGrid1->Cells[3][13]="Да [1]";
      else AdvStringGrid1->Cells[3][13]="Нет [0]";
   }
   AdvStringGrid1->Refresh();
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagSsoi2Info( int packet[30] )
{
   AnsiString str;
   bool bit = false;

   bit = false;
   if( (packet[4]&0x01) == 0x01 ) bit = true; 
   if( !bit )
   {
      Image71->Picture->Bitmap = I2Img;
      StaticText77->Caption = "НЕТ";
   }
   else
   {
      Image71->Picture->Bitmap = I5Img;
      StaticText77->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x02) == 0x02 ) bit = true; 
   if( !bit )
   {
      Image78->Picture->Bitmap = I2Img;
      StaticText78->Caption = "НЕТ";
   }
   else
   {
      Image78->Picture->Bitmap = I5Img;
      StaticText78->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x04) == 0x04 ) bit = true; 
   if( !bit )
   {
      Image79->Picture->Bitmap = I2Img;
      StaticText79->Caption = "НЕТ";
   }
   else
   {
      Image79->Picture->Bitmap = I5Img;
      StaticText79->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x08) == 0x08 ) bit = true; 
   if( !bit )
   {
      Image72->Picture->Bitmap = I2Img;
      StaticText80->Caption = "НЕТ";
   }
   else
   {
      Image72->Picture->Bitmap = I5Img;
      StaticText80->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x10) == 0x10 ) bit = true; 
   if( !bit )
   {
      Image81->Picture->Bitmap = I2Img;
      StaticText81->Caption = "НЕТ";
   }
   else
   {
      Image81->Picture->Bitmap = I5Img;
      StaticText81->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x20) == 0x20 ) bit = true; 
   if( !bit )
   {
      Image82->Picture->Bitmap = I2Img;
      StaticText82->Caption = "НЕТ";
   }
   else
   {
      Image82->Picture->Bitmap = I5Img;
      StaticText82->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x40) == 0x40 ) bit = true; 
   if( !bit )
   {
      Image75->Picture->Bitmap = I2Img;
      StaticText83->Caption = "НЕТ";
   }
   else
   {
      Image75->Picture->Bitmap = I5Img;
      StaticText83->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[4]&0x80) == 0x80 ) bit = true; 
   if( !bit )
   {
      Image84->Picture->Bitmap = I2Img;
      StaticText84->Caption = "НЕТ";
   }
   else
   {
      Image84->Picture->Bitmap = I5Img;
      StaticText84->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[5]&0x01) == 0x01 ) bit = true; 
   if( !bit )
   {
      Image7->Picture->Bitmap = I2Img;
      StaticText8->Caption = "ВЫКЛ";
   }
   else
   {
      Image7->Picture->Bitmap = I3Img;
      StaticText8->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[5]&0x02) == 0x02 ) bit = true; 
   if( !bit )
   {
      Image8->Picture->Bitmap = I2Img;
      StaticText9->Caption = "ВЫКЛ";
   }
   else
   {
      Image8->Picture->Bitmap = I3Img;
      StaticText9->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[5]&0x04) == 0x04 ) bit = true; 
   if( !bit )
   {
      Image2->Picture->Bitmap = I2Img;
      StaticText3->Caption = "ВЫКЛ";
   }
   else
   {
      Image2->Picture->Bitmap = I3Img;
      StaticText3->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[5]&0x08) == 0x08 ) bit = true;
   if( !bit )
   {
      Image3->Picture->Bitmap = I2Img;
      StaticText4->Caption = "НЕТ";
   }
   else
   {
      Image3->Picture->Bitmap = I4Img;
      StaticText4->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[5]&0x10) == 0x10 ) bit = true; 
   if( !bit )
   {
      Image5->Picture->Bitmap = I2Img;
      StaticText6->Caption = "НЕТ";
   }
   else
   {
      Image5->Picture->Bitmap = I5Img;
      StaticText6->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[5]&0x20) == 0x20 ) bit = true; 
   if( !bit )
   {
      Image1->Picture->Bitmap = I7Img;
      StaticText2->Caption = "НЕТ";
   }
   else
   {
      Image1->Picture->Bitmap = I8Img;
      StaticText2->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[5]&0x40) == 0x40 ) bit = true; 
   if( !bit )
   {
      Image4->Picture->Bitmap = I7Img;
      StaticText5->Caption = "НЕТ";
   }
   else
   {
      Image4->Picture->Bitmap = I8Img;
      StaticText5->Caption = "ЕСТЬ";
   }

   bit = false;
   if( (packet[5]&0x80) == 0x80 ) bit = true; 
   if( !bit )
   {
      Image6->Picture->Bitmap = I7Img;
      StaticText7->Caption = "НЕТ";
   }
   else
   {
      Image6->Picture->Bitmap = I9Img;
      StaticText7->Caption = "ЕСТЬ";
   }


   bit = false;
   if( (packet[6]&0x01) == 0x01 ) bit = true; 
   if( !bit )
   {
      Image51->Picture->Bitmap = I2Img;
      StaticText51->Caption = "ВЫКЛ";
   }
   else
   {
      Image51->Picture->Bitmap = I5Img;
      StaticText51->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x02) == 0x02 ) bit = true; 
   if( !bit )
   {
      Image52->Picture->Bitmap = I2Img;
      StaticText52->Caption = "ВЫКЛ";
   }
   else
   {
      Image52->Picture->Bitmap = I5Img;
      StaticText52->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x04) == 0x04 ) bit = true; 
   if( !bit )
   {
      Image53->Picture->Bitmap = I2Img;
      StaticText53->Caption = "ВЫКЛ";
   }
   else
   {
      Image53->Picture->Bitmap = I5Img;
      StaticText53->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x08) == 0x08 ) bit = true; 
   if( !bit )
   {
      Image54->Picture->Bitmap = I2Img;
      StaticText54->Caption = "ВЫКЛ";
   }
   else
   {
      Image54->Picture->Bitmap = I5Img;
      StaticText54->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x10) == 0x10 ) bit = true; 
   if( !bit )
   {
      Image55->Picture->Bitmap = I2Img;
      StaticText55->Caption = "ВЫКЛ";
   }
   else
   {
      Image55->Picture->Bitmap = I5Img;
      StaticText55->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x20) == 0x20 ) bit = true; 
   if( !bit )
   {
      Image56->Picture->Bitmap = I2Img;
      StaticText56->Caption = "ВЫКЛ";
   }
   else
   {
      Image56->Picture->Bitmap = I5Img;
      StaticText56->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x40) == 0x40 ) bit = true; 
   if( !bit )
   {
      Image57->Picture->Bitmap = I2Img;
      StaticText57->Caption = "ВЫКЛ";
   }
   else
   {
      Image57->Picture->Bitmap = I5Img;
      StaticText57->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[6]&0x80) == 0x80 ) bit = true; 
   if( !bit )
   {
      Image58->Picture->Bitmap = I2Img;
      StaticText58->Caption = "ВЫКЛ";
   }
   else
   {
      Image58->Picture->Bitmap = I5Img;
      StaticText58->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[7]&0x01) == 0x01 ) bit = true; 
   if( !bit )
   {
      Image60->Picture->Bitmap = I2Img;
      StaticText60->Caption = "ВЫКЛ";
   }
   else
   {
      Image60->Picture->Bitmap = I3Img;
      StaticText60->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[7]&0x02) == 0x02 ) bit = true; 
   if( !bit )
   {
      Image61->Picture->Bitmap = I2Img;
      StaticText61->Caption = "ВЫКЛ";
   }
   else
   {
      Image61->Picture->Bitmap = I3Img;
      StaticText61->Caption = "ВКЛ";
   }

   bit = false;
   if( (packet[7]&0x04) == 0x04 ) bit = true; 
   if( !bit )
   {
      Image62->Picture->Bitmap = I2Img;
      StaticText62->Caption = "ВЫКЛ";
   }
   else
   {
      Image62->Picture->Bitmap = I3Img;
      StaticText62->Caption = "ВКЛ";
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ComboBox1Change(TObject *Sender)
{
   if( POprosObj(ObjTree->Selected->Data)->Type == 10 )
      ShowTochkaSettings();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::iServerClientConnect(TObject *Sender,
      TCustomWinSocket *SocketHandle)
{
   for( int i = 0; i < NetClientMaxCnt; i++ )
   {
      if( iNetSys->iNetClient[i].IsEmpty() )
      {
         iNetSys->iNetClient[i].Set(SocketHandle->SocketHandle);
         iNetSys->iNetClient[i].KeepAliveCnt = 0;
         break;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::iServerClientDisconnect(TObject *Sender,
      TCustomWinSocket *Socket)
{
   for( int j = 0; j < NetClientMaxCnt; j++ )
   {
      if( iNetSys->iNetClient[j].IsExist(Socket->SocketHandle) )
      {
         iNetSys->iNetClient[j].Reset();
         iNetSys->iNetClient[j].KeepAliveCnt = 0;
         break;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::iServerClientError(TObject *Sender,
      TCustomWinSocket *Socket, TErrorEvent ErrorEvent, int &ErrorCode)
{
   try
   {
      ErrorCode = 0;
      iServer->Socket->Close();
      iServer->Active = false;
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::KeepAliveTimerTimer(TObject *Sender)
{
   AnsiString str;

   if( iServerUse )
   {
       if( iServer->Active )
       {
          for( int i = 0; i < iServer->Socket->ActiveConnections; i++ )
          for( int j = 0; j < NetClientMaxCnt; j++ )
          {
             if( iNetSys->iNetClient[j].IsExist(iServer->Socket->Connections[i]->SocketHandle) )
             {
                if( iNetSys->iNetClient[j].KeepAliveCnt < (iKeepAlive-1) )
                {
                   iNetSys->iNetClient[j].KeepAliveCnt += 1;

                   if( iNetSys->iNetClient[j].EventsAndStates )
                   {
                      if( EventsAndStates->Count > 0 )
                      {
                         if( EventsAndStates->Strings[0] != "<RIFPlusPacket type=\"EventBook\">" )
                         {
                             if( EventsAndStates->Strings[0] != "<RIFPlusPacket type=\"EventsAndStates\">" )
                             {
                                EventsAndStates->Insert(0, "<RIFPlusPacket type=\"EventsAndStates\">");
                                EventsAndStates->Insert(1, "<devices>");
                             }
                             if( EventsAndStates->Strings[EventsAndStates->Count-2] != "</devices>" )
                             {
                                EventsAndStates->Add("</devices>");
                                EventsAndStates->Add("</RIFPlusPacket>");
                             }
                         }

                         iServer->Socket->Connections[i]->SendBuf(EventsAndStates->Text.c_str(),EventsAndStates->Text.Length());
                      }
                   }
                }
                else
                {
                   iServer->Socket->Connections[i]->Close();
                   iNetSys->iNetClient[j].Reset();
                }

                break;
             }
          }

          EventsAndStates->Clear();


          str = "iServer: " + iServerHost + ":" + IntToStr(iServerPort) +  " Клиентов: " + iServer->Socket->ActiveConnections;
          StatusBar1->Panels->Items[2]->Text = str;
       }
       else
       {
          str = "iServer: -";
          if( StatusBar1->Panels->Items[2]->Text != str ) StatusBar1->Panels->Items[2]->Text = str;

          iNetSys->Reset();

          iServer->Socket->Close();
          iServer->Active = false;
          iServer->Active = true;
       }
   }
   else
   {
      str = "iServer: -";
      if( StatusBar1->Panels->Items[2]->Text != str ) StatusBar1->Panels->Items[2]->Text = str;
   }

   if( Server2Use )
   {
       if( Server2->Active )
       {
           for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
           for( int j = 0; j < NetClientMaxCnt; j++ )
           {
              if( r485NetSys->iNetClient[j].IsExist(Server2->Socket->Connections[i]->SocketHandle) )
              {
                 if( r485NetSys->iNetClient[j].KeepAliveCnt < (r485KeepAlive-1) )
                 {
                    r485NetSys->iNetClient[j].KeepAliveCnt += 1;

                    if( Stn485Tv )
                    {
                       if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0 &&
                           cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 &&
                           cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 &&
                           cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 &&
                           cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 &&
                           cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                       {
                           
/* 
                          TDateTime dt1 = Now();
                          AnsiString tempstr = dt1.FormatString("yyyy mm dd hh nn ss");
                          cam485str = "<RASTRMTV>";
                          cam485str += "<DT>" + tempstr + "</DT>";

                          cam485str += tempstr.sprintf("<CAM1><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM1>", cam485_sn[0], cam485[1], cam485[2]);

                          cam485str += tempstr.sprintf("<CAM2><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM2>", cam485_sn[1], cam485[4], cam485[5]);

                          cam485str +="</RASTRMTV>";

                          Server2->Socket->Connections[i]->SendText(cam485str);
*/
                       }
                       else
                       {
                          TDateTime dt1 = Now();
                          AnsiString tempstr = dt1.FormatString("yyyy mm dd hh nn ss");
                          cam485str = "<RASTRMTV>";
                          cam485str += "<DT>" + tempstr + "</DT>";

                          cam485str += tempstr.sprintf("<CAM1><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM1>", cam485_sn[0], cam485[1], cam485[2]);
                          cam485str += tempstr.sprintf("<CAM2><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM2>", cam485_sn[1], cam485[4], cam485[5]);
                          cam485str += tempstr.sprintf("<CAM3><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM3>", cam485_sn[2], cam485[7], cam485[8]);
                          cam485str += tempstr.sprintf("<CAM4><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM4>", cam485_sn[3], cam485[10], cam485[11]);
                          cam485str += tempstr.sprintf("<CAM5><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM5>", cam485_sn[4], cam485[13], cam485[14]);
                          cam485str += tempstr.sprintf("<CAM6><DEV>%s</DEV><BL>%03d</BL><ADR>%03d</ADR></CAM6>", cam485_sn[5], cam485[16], cam485[17]);

                          cam485str +="</RASTRMTV>";

                          Server2->Socket->Connections[i]->SendText(cam485str);
                       }
                    }
                    else if( STN1 )
                    {
                       str = "start ";
                       str = str + IntToStr(cam1[0]) + " " + IntToStr(cam1[1]) + " " + IntToStr(cam1[2])
                                 + " " + IntToStr(cam1[3]) + " ";
                       str = str + IntToStr(cam2[0]) + " " + IntToStr(cam2[1]) + " " + IntToStr(cam2[2])
                                 + " " + IntToStr(cam2[3]) + " finish";

                       Server2->Socket->Connections[i]->SendText(str);
                    }
                 }
                 else
                 {
                    Server2->Socket->Connections[i]->Close();
                    r485NetSys->iNetClient[j].Reset();
                 }

                 break;
              }
           }

           for( int i = 0; i < 4; i++ )
           {
              cam1[i] = -1;
              cam2[i] = -1;
           }

           str = "RASTR-M-TV(RASTR): " + Server2Name + ":" + IntToStr(Server2Port) +  " Клиентов: " + Server2->Socket->ActiveConnections;
           StatusBar1->Panels->Items[1]->Text = str;
       }
       else
       {
          str = "RASTR-M-TV(RASTR): -";
          if( StatusBar1->Panels->Items[1]->Text != str ) StatusBar1->Panels->Items[1]->Text = str;

          Server2->Socket->Close();
          Server2->Active = false;
          Server2->Active = true;
       }
   }
   else
   {
      str = "RASTR-M-TV(RASTR): -";
      if( StatusBar1->Panels->Items[1]->Text != str ) StatusBar1->Panels->Items[1]->Text = str;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::iServerClientRead(TObject *Sender,
      TCustomWinSocket *Socket)
{
   int length = Socket->ReceiveLength();

   char *Buf;
   Buf = new char [length];
   memset(Buf,0,length);

   length = Socket->ReceiveBuf(Buf,length);

   for( int i = 0; i < length-8; i++ )
   {
      if( toupper(Buf[i]) == toupper('k') &&
          toupper(Buf[i+1]) == toupper('e') &&
          toupper(Buf[i+2]) == toupper('e') &&
          toupper(Buf[i+3]) == toupper('p') &&
          toupper(Buf[i+4]) == toupper('a') &&
          toupper(Buf[i+5]) == toupper('l') &&
          toupper(Buf[i+6]) == toupper('i') &&
          toupper(Buf[i+7]) == toupper('v') &&
          toupper(Buf[i+8]) == toupper('e') )
      {
         for( int j = 0; j < NetClientMaxCnt; j++ )
         {
            if( iNetSys->iNetClient[j].IsExist(Socket->SocketHandle) )
            {
               iNetSys->iNetClient[j].KeepAliveCnt = 0;
               break;
            }
         }
      }
      else if( toupper(Buf[i]) == toupper('c') &&
               toupper(Buf[i+1]) == toupper('o') &&
               toupper(Buf[i+2]) == toupper('m') &&
               toupper(Buf[i+3]) == toupper('m') &&
               toupper(Buf[i+4]) == toupper('a') &&
               toupper(Buf[i+5]) == toupper('n') &&
               toupper(Buf[i+6]) == toupper('d') &&
               toupper(Buf[i+8]) == toupper('i') &&
               toupper(Buf[i+9]) == toupper('d') &&
               toupper(Buf[i+10]) == toupper('=') &&
               toupper(Buf[i+11]) == toupper('\"') )
      {
          int cmd = -1;
         AnsiString cmd_str;
         int k = i+12;
         int KKK = k;
         try
         {
            do
            {
               cmd_str += Buf[k];
               k = k + 1;
            }
            while( toupper(Buf[k]) != toupper('\"') );

            cmd = StrToInt(cmd_str);

            for( int j = 0; j < NetClientMaxCnt; j++ )
            {
               if( iNetSys->iNetClient[j].IsExist(Socket->SocketHandle) )
               {
                  if( cmd == 0 )
                  {
                     AnsiString str;

                     
                     TreeAndStates->Clear();
                     TreeAndStates->Add("<RIFPlusPacket type=\"InitialStatus\">");
                     TreeAndStates->Add("<devices>");

                     ObjTree->Items->BeginUpdate();
                     for( int k = 0; k < ObjTree->Items->Count; k++ )
                     {
                        int dtype = POprosObj(ObjTree->Items->Item[k]->Data)->Type;
                        if( dtype == RifRlmSType ) dtype = 99;

                        if( dtype == StrazhIpType )
                           str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\" login=\"%s\" password=\"%s\" ip2=\"%s\">",
                           k,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                           dtype,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon2Path,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon3Path,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon4Path );
                        else if( dtype == OnvifTvType )
                           str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\" login=\"%s\" password=\"%s\">",
                           k,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                           dtype,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon2Path,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon3Path );
                        else if( dtype == NetDevIdx )
                           str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\">",
                           k,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                           dtype,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path);
                        else
                        {
                           int option = 0;
                           if( POprosObj(ObjTree->Items->Item[k]->Data)->Bazalt ) option = 1;
                           if( POprosObj(ObjTree->Items->Item[k]->Data)->ConnectBlock ) option = 2;

                           str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\" dk=\"%d\" option=\"%d\">",
                           k,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                           dtype,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                           POprosObj(ObjTree->Items->Item[k]->Data)->lan,
                           POprosObj(ObjTree->Items->Item[k]->Data)->lon,
                           POprosObj(ObjTree->Items->Item[k]->Data)->description,
                           POprosObj(ObjTree->Items->Item[k]->Data)->Dk,
                           option );
                        }

                        TreeAndStates->Add(str);
                        TreeAndStates->Add("<states>");
                        int id = 0;
                        AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss", Now());
                        AnsiString name;
                        bool alarmfix = true;
                        switch( POprosObj(ObjTree->Items->Item[k]->Data)->Type )
                        {
                           case GroupType: 
                                   break;
                           case RifType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case RifRlmSType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case SdConcType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   break;
                           case SdType: 
                                   if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Bazalt )
                                   {
                                       if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                           GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 111;
                                       else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                           GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 113;
                                       else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                           GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 112;
                                       else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                           GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 110;
                                   }
                                   else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].ConnectBlock )
                                   {
                                       if(  GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 )
                                       {
                                          if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 143;
                                          else id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                       }
                                       else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 20 )
                                       {
                                          if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 144;
                                          else id = 145;
                                       }
                                       else id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                   }
                                   else
                                   {
                                       id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                       alarmfix = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].AlarmFix;
                                   }
                                   break;
                           case IuType: 
                                   id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                   if( id == 1 ) id = 101;
                                   else id = 100;
                                   break;
                           case RastrOldType: 
                                   break;
                           case SolidType: 
                                   break;
                           case Adam4068Type: 
                                   id = A4068Sys->Dev[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Out[POprosObj(ObjTree->Items->Item[k]->Data)->Num2];
                                   break;
                           case TorosType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case NastType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case TochkaType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   break;
                           case SdIpBlType: 
                                   if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] )
                                   {
                                      if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] )
                                         id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      else id = 20;

                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   }
                                   else
                                   {
                                      if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 1 )
                                      {
                                        if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                            RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 100 ) 
                                        {
                                           id = 111;
                                        }
                                        else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                 RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 101 ) 
                                        {
                                           if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].StatusOld[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 11 )
                                           {
                                              id = 111;
                                           }
                                           else 
                                           {
                                              id = 113;
                                           }
                                        }
                                        else if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                 RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 101 ) 
                                        {
                                           id = 110;
                                        }
                                        else if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                 RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 100 ) 
                                        {
                                           if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].StatusOld[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 11 )
                                           {
                                              id = 110;
                                           }
                                           else
                                           {
                                              id = 112;
                                           }
                                        }
                                      }
                                      else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 10 )
                                        id = 17;
                                      else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 0 )
                                        id = 2;
                                   }
                                   break;
                           case IuIpBlType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt];
                                   break;
                           case RazrivBoType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                   break;
                           case SsoiType: 
                                   break;
                           case Stn485Type: 
                                   break;
                           case RastrType: 
                                   break;
                           case RadarType: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case SsoiMSdType: 
                                   if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Bazalt )
                                   {
                                       if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                           GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 111;
                                       else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                           GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 113;
                                       else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                           GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 112;
                                       else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                           GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 110;
                                   }
                                   else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].ConnectBlock )
                                   {
                                       if(  GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 )
                                       {
                                          if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 143;
                                          else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                       }
                                       else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 20 )
                                       {
                                          if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 144;
                                          else id = 145;
                                       }
                                       else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                   }
                                   else
                                   {
                                      id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                      alarmfix = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].AlarmFix;
                                   }
                                   break;
                           case SsoiMIuType:
                                   if( POprosObj(ObjTree->Items->Item[k]->Data)->Num3 < 4 )
                                       id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                   else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Vk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status;
                                   if( id == 1 ) id = 101;
                                   else id = 100;
                                   break;
                           case TabloType: 
                                   break;
                           case StrazhIpType: 
                                   break;
                           case OnvifTvType: 
                                   break;
                           case TochkaMBoIdx: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case TochkaMUchIdx: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].StatusUch[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].AlarmFix;
                                   break;
                           case TochkaMDdIdx: 
                                   {
                                       int num21 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2%100;
                                       if( POprosObj(ObjTree->Items->Item[k]->Data)->Num2 >= 300 ) num21 += 26;
                                       id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].sob_type;
                                       alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].AlarmFix;
                                   }
                                   break;
                           case SotaMBoIdx: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                   break;
                           case SotaMUchIdx: 
                                   id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].StatusUch[0];
                                   alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].AlarmFix;
                                   break;
                           case SotaMDdIdx:
                                   {
                                      int num21 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2%100;
                                      if( POprosObj(ObjTree->Items->Item[k]->Data)->Num2 >= 300 ) num21 += 100;
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].sob_type;
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].AlarmFix;
                                   }
                                   break;
                           case DevLineIdx: 
                                   break;
                        }
                        switch( id )
                        {
                            case   0: name = Table1Str1; 
                                      break;
                            case   1: name = Table1Str2;
                                      break;
                            case   2: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == SdIpBlType &&
                                          RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] ) name = Table1Str1;
                                      else name = "Конф. изм. (пульт)";
                                      break;
                            case   3: name = Table1Str3; 
                                      break;
                            case   4: name = Table1Str4; 
                                      break;
                            case   5: name = "Отметка пройдена"; 
                                      break;
                            case   6: name = "Определение направления включено";
                                      break;
                            case   7: name = "Определение направления выключено";
                                      break;
                            case  10: name = Table1Str5; 
                                      break;
                            case  11: name = Table1Str6; 
                                      break;
                            case  12: name = "Неисправность";
                                      break;
                            case  13: name = Table1Str7; 
                                      break;
                            case  15: name = "Перевод в режим \"Раб. с пультом\"";
                                      break;
                            case  16: name = "Отсутствует синхронизация";
                                      break;
                            case  17: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == SdIpBlType &&
                                          RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] ) name = Table1Str5;
                                      else name = "Неисправность линии";
                                      break;
                            case  18: name = "Неисправность ЧЭ";
                                      break;
                            case  20: name = Table1Str8; 
                                      break;
                            case  21: name = Table1Str9;
                                      break;
                            case  22: name = Table1Str10; 
                                      break;
                            case  23: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 9 ) name = "Тревога - СРАБОТКА(Луч \"чужой\")";
                                      else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 91 ) name = "Тревога - СРАБОТКА(Зона 1)";
                                      else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 21 ) name = "Тревога - НЕИСПРАВНОСТЬ";
                                      else name = "Тревога - СРАБОТКА(Луч 1)";
                                      break;
                            case  24: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 9 ) name = "Тревога - СРАБОТКА(Луч \"свой\")";
                                      else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 91 ) name = "Тревога - СРАБОТКА(Зона 2)";
                                      else name = "Тревога - СРАБОТКА(Луч 2)";
                                      break;
                            case  25: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type != RifRlmSType ) name = Table1Str9; /*"Тревога - ВСКРЫТИЕ";*/
                                      else name = "Тревога - СИНХР.ИЗМ.";
                                      break;
                            case  26: name = "Тревога - Отсутствие часового"; 
                                      break;
                            case  27: name = "Тревога - СРАБОТКА(Зона 3)";
                                      break;
                            case  30: name = "Раб. с пультом";
                                      break;
                            case  31: name = "Раб. с пультом заверш.";
                                      break;
                            case 100: name = Table1Str11; 
                                      break;
                            case 101: name = Table1Str12; 
                                      break;
                            case 110: name = Table1Str13; 
                                      break;
                            case 111: name = Table1Str14; 
                                      break;
                            case 112: name = Table1Str28; 
                                      break;
                            case 113: name = Table1Str29; 
                                      break;
                            case 130: name = Table1Str15; 
                                      break;
                            case 131: name = Table1Str16; 
                                      break;
                            case 132: name = "Послана ком. \"Раб. с пультом\"";
                                      break;
                            case 138: name = "Послана ком. \"Завершение раб. с пультом\"";
                                      break;
                            case 133: name = Table1Str17; 
                                      break;
                            case 134: name = "Запись настройки";
                                      break;
                            case 135: name = Table1Str18; 
                                      break;
                            case 136: name = Table1Str19; 
                                      break;
                            case 137: name = Table1Str20; 
                                      break;
                            case 140: name = Table1Str21; 
                                      break;
                            case 141: name = Table1Str22; 
                                      break;
                            case 142: name = "Синхронизация восстановлена";
                                      break;
                            case 143: name = Table1Str30; 
                                      break;
                            case 144: name = "Вызов завершен по кан. связи";
                                      break;
                            case 145: name = Table1Str32; 
                                       break;
                            case 150: name = Table1Str23; 
                                      break;
                            case 151: name = Table1Str24; 
                                      break;
                            case 160: name = "ДК не выполнена (все зоны отключены)";
                                      break;
                            case 170: name = "Зона1 отключена";
                                      break;
                            case 171: name = "Зона1 включена";
                                      break;
                            case 172: name = "Зона2 отключена";
                                      break;
                            case 173: name = "Зона2 включена";
                                      break;
                            case 174: name = "Зона3 отключена";
                                      break;
                            case 175: name = "Зона3 включена";
                                      break;
                            case 200: name = Table1Str5; 
                                      break;
                        }

                        if( alarmfix ) str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", id, dt_str, name);
                        else str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"Контроль выкл\"/>", dt_str);
                        TreeAndStates->Add(str);
                        TreeAndStates->Add("</states>");
                        TreeAndStates->Add("</device>");
                     }

                     ObjTree->Items->EndUpdate();

                     TreeAndStates->Add("</devices>");
                     TreeAndStates->Add("</RIFPlusPacket>");

                     Socket->SendBuf(TreeAndStates->Text.c_str(),TreeAndStates->Text.Length());
                  }
                  else if( cmd == 2 ) 
                  {
                     TreeAndStates->Clear();
                     TreeAndStates->Add("<RIFPlusPacket type=\"ProtocolVersionInfo\">");
                     TreeAndStates->Add("<version=\"1.19\"/>");
                     TreeAndStates->Add("</RIFPlusPacket>");
                     Socket->SendBuf(TreeAndStates->Text.c_str(),TreeAndStates->Text.Length());
                  }
                  else if( cmd == 10000 )
                  {
                     iNetSys->iNetClient[j].EventsAndStates = true;
                  }
                  else if( cmd == 10001 )
                  {
                     iNetSys->iNetClient[j].EventsAndStates = false;
                  }
                  else if( cmd == 101 )
                  {
                     AnsiString type_str, num1_str, num2_str, num3_str;
                     int type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     if( type == IuType ) 
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].Use )
                        {
                              if( !GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                                 SetSob( 1001, 4, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Iu[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              else
                                 SetSob( 1005, 4, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );

                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;

                              if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].AutoOff > 0 )
                              {
                                     TDateTime adt = Now();
                                     int t = GobiSys->Kanal[kan].Bl[bl].Iu[iu].AutoOff;
                                     switch( t )
                                     {
                                         case 1: adt = adt + EncodeTime(0,0,5,0);
                                                 break;
                                         case 2: adt = adt + EncodeTime(0,0,10,0);
                                                 break;
                                         case 3: adt = adt + EncodeTime(0,0,30,0);
                                                 break;
                                         case 4: adt = adt + EncodeTime(0,1,0,0);
                                                 break;
                                         case 5: adt = adt + EncodeTime(0,5,0,0);
                                                 break;
                                         case 6: adt = adt + EncodeTime(0,10,0,0);
                                                 break;
                                         case 7: adt = adt + EncodeTime(0,20,0,0);
                                                 break;
                                         case 8: adt = adt + EncodeTime(0,30,0,0);
                                                 break;
                                         case 9: adt = adt + EncodeTime(1,0,0,0);
                                                 break;
                                         default: adt = adt + EncodeTime(0,0,5,0);
                                                  break;
                                     }
                                     GobiSys->Kanal[kan].Bl[bl].Iu[iu].OffDt = adt;
                              }
                        }
                     }
                     else if( type == SsoiMIuType ) 
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        {
                            if( iu < 3 )
                            {
                               SetSob( 1001, 43, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Iu[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                               GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;
                               GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                            }
                            else
                            {
                               iu = iu - 3;
                               SetSob( 1001, 43, (kan+1),(bl+1),(iu+4), GobiSys2->Bl[kan][bl].Vk[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                               GobiSys2->Bl[kan][bl].Vk[iu].hCmd = 1;
                               GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                            }
                        }
                     }
                     else if( type == IuIpBlType )   
                     {
                        if(  RifSys->Rk[num3-1][IpBlIdx].Use )
                        {
                            if( !DemoMode )
                            {
                               SetSob( 1001, IuIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1+MaxIpBlSdCnt], OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                               RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;
                               RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                               RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                            }
                            else
                            {
                               int packet[1000];
                               memset(packet,0,1000);

                               bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                               RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 101;
                               ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                               SetSob( 1001, IuIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1+MaxIpBlSdCnt], OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                            }
                        }
                     }
                     else if( type == SdType  )   
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Use )
                        {
                           SetSob( 1004, 3, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                           if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1 )
                           {
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = true;
                           }
                           else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 1 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 ) 
                           {
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                           }

                           GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = BazaltCnt;

                           CGauge1->Progress = BazaltCnt-GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
                        }
                     }
                     else if( type == SsoiMSdType )
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        {
                           SetSob( 1004, 33, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Sd[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );

                           GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;
                           GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                           GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = BazaltCnt2;

                           CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt;
                        }
                     }
                     else if( type == SdIpBlType )   
                     {
                        if(  RifSys->Rk[num3-1][IpBlIdx].Use )
                        if( RifSys->Rk[num3-1][IpBlIdx].Bazalt[num2-1] )
                        {
                           if( !DemoMode )
                           {
                              SetSob( 1004, SdIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1],  OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 100;

                              RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                              RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;

                              RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = RifBazaltCnt[num3-1];

                              CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
                              CGauge1->Progress = 0;
                           }
                           else
                           {
                              SetSob( 1004, SdIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1],  OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = 10;

                              CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
                              CGauge1->Progress = 0;
                              GroupBox5->Caption = "Выполнение команды УЗ \"Монолит\"";
                              GroupBox5->Visible = true;

                              for( int progr = 0; progr < CGauge1->MaxValue; progr++ )
                              {
                                 MyDelay(50);
                                 CGauge1->Progress = progr;
                              }
                              RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 1;
                              RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 100;
                              RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] = 0;

                              int packet[1000];
                              memset(packet,0,1000);

                              bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                              Tin_IpBl[num2-1] = true;

                              ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                              GroupBox5->Visible = false;
                           }
                        }
                     }
                  }
                  else if( cmd == 100 )
                  {
                     AnsiString type_str, num1_str, num2_str, num3_str;
                     int type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     if( type == IuType ) 
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].Use )
                        {
                           if( !GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].ConnectBlock )
                              SetSob( 1000, 4, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Iu[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                           else
                              SetSob( 1006, 4, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu+3].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                           GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                        }
                     }
                     else if( type == SsoiMIuType )
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        {
                           if( iu < 3 )
                           {
                              SetSob( 1000, 43, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Iu[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
                              GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                           }
                           else
                           {
                              iu = iu - 3;
                              SetSob( 1000, 43, (kan+1),(bl+1),(iu+4), GobiSys2->Bl[kan][bl].Vk[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false,0 );
                              GobiSys2->Bl[kan][bl].Vk[iu].hCmd = 2;
                              GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                           }
                        }
                     }
                     else if( type == IuIpBlType )   
                     {
                        if(  RifSys->Rk[num3-1][IpBlIdx].Use )
                        {
                           if( !DemoMode )
                           {
                              SetSob( 1000, IuIpBlType,  num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1+MaxIpBlSdCnt], OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 100;
                              RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                              RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
                           }
                           else
                           {
                              int packet[1000];
                              memset(packet,0,1000);

                              bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                              RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 100;
                              ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                              SetSob( 1000, IuIpBlType,  num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1+MaxIpBlSdCnt], OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                           }
                        }
                     }
                     else if( type == SdType  )  
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Use )
                        {
                           SetSob( 1003, 3, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

                           if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 21 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 1 ) 
                           {
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = false;
                           }
                           else if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Status == 21 && GobiSys->Kanal[kan].Bl[bl].Iu[iu].Status == 2 ) 
                           {
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd2 = true;
                           }

                           GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt = BazaltCnt;

                           CGauge1->Progress = BazaltCnt-GobiSys->Kanal[kan].Bl[bl].Sd[iu].OnOffCnt;
                        }
                     }
                     else if( type == SsoiMSdType  )   
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        {
                           SetSob( 1003, 33, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Sd[iu].Name, OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                           GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
                           GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                           GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = BazaltCnt2;

                           CGauge1->Progress = BazaltCnt2-GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt;
                        }
                     }
                     else if( type == SdIpBlType )  
                     {
                        if(  RifSys->Rk[num3-1][IpBlIdx].Use )
                        if( RifSys->Rk[num3-1][IpBlIdx].Bazalt[num2-1] )
                        {
                           if( !DemoMode )
                           {
                              SetSob( 1003, SdIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1],  OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1+MaxIpBlSdCnt] = 101;

                              RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x23;
                              RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;

                              RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = RifBazaltCnt[num3-1];

                              CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
                              CGauge1->Progress = 0;
                           }
                           else
                           {
                              SetSob( 1003, SdIpBlType, num1, num2, num3, RifSys->Rk[num3-1][IpBlIdx].Name[num2-1],  OpFn, OpN1, OpN2, ClFn, ClN1, ClN2, false, 0 );
                              RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1] = 10;

                              CGauge1->MaxValue = RifSys->Rk[num3-1][IpBlIdx].OnOffCnt[num2-1];
                              CGauge1->Progress = 0;
                              GroupBox5->Visible = true;

                              for( int progr = 0; progr < CGauge1->MaxValue; progr++ )
                              {
                                 MyDelay(50);
                                 CGauge1->Progress = progr;
                              }
                              RifSys->Rk[num3-1][IpBlIdx].Status[num2-1] = 1;
                              RifSys->Rk[num3-1][IpBlIdx].Status[num2-1+MaxIpBlSdCnt] = 101;
                              RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] = 0;

                              int packet[1000];
                              memset(packet,0,1000);

                              bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                              Tin_IpBl[num2-1] = false;

                              ShowNewRkStatus(1,IpBlIdx, num3-1, 0, Tin_IpBl, packet );
                              GroupBox5->Visible = false;
                           }
                        }
                     }
                  }
                  else if( cmd == 143 )
                  {
                     AnsiString type_str, num1_str, num2_str, num3_str;
                     int type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     if( type == SdType && num3 > 3   )   
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].ConnectBlock )
                        {
                           if( GobiSys->Kanal[kan].Bl[bl].Iu[iu-3].StatusOld != 1 )
                           {
                              SetSob( 1143, 3, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu-3].hCmd = 2;
                           }
                        }
                     }
                     else if( type == SsoiMSdType && num3 > 3 )
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        if( GobiSys2->Bl[kan][bl].Sd[iu].Use )
                        if( GobiSys2->Bl[kan][bl].Sd[iu].ConnectBlock )
                        {
                          if( GobiSys2->Bl[kan][bl].Iu[iu-3].Status == 2 )
                          {
                             SetSob( 1143, 33, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                             GobiSys2->Bl[kan][bl].Iu[iu-3].hCmd = 1;
                             GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                             GobiSys2->Bl[kan][bl].Sd[iu].ConnectBlockHand = true;
                          }
                        }
                     }
                  }
                  else if( cmd == 146 )
                  {
                     AnsiString type_str, num1_str, num2_str, num3_str;
                     int type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     if( type == SdType && num3 > 3   )  
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys->Kanal[kan].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].Use )
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[iu].ConnectBlock )
                        {
                           if( GobiSys->Kanal[kan].Bl[bl].Iu[iu-3].StatusOld == 1 )
                           {
                              SetSob( 1146, 3, (kan+1),(bl+1),(iu+1), GobiSys->Kanal[kan].Bl[bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              GobiSys->Kanal[kan].Bl[bl].Iu[iu-3].hCmd = 1;
                           }
                        }
                     }
                     else if( type == SsoiMSdType && num3 > 3 )
                     {
                        int kan = num1-1;
                        int bl = num2-1;
                        int iu = num3-1;

                        if( GobiSys2->Bl[kan][bl].Use )
                        if( GobiSys2->Bl[kan][bl].Sd[iu].Use )
                        if( GobiSys2->Bl[kan][bl].Sd[iu].ConnectBlock )
                        {
                          if( GobiSys2->Bl[kan][bl].Iu[iu-3].Status != 2 )
                          {
                             SetSob( 1146, 33, (kan+1),(bl+1),(iu+1), GobiSys2->Bl[kan][bl].Sd[iu].Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                             GobiSys2->Bl[kan][bl].Iu[iu-3].hCmd = 2;
                             GobiSys2->Bl[kan][bl].Cmd = 0xF2;
                             GobiSys2->Bl[kan][bl].Sd[iu].ConnectBlockHand = false;
                          }
                        }
                     }
                  }
                  else if( cmd == 1 )
                  {
                     AnsiString idx_str;
                     int idx = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('d') &&
                            toupper(Buf[i+1]) == toupper('e') &&
                            toupper(Buf[i+2]) == toupper('v') &&
                            toupper(Buf[i+3]) == toupper('i') &&
                            toupper(Buf[i+4]) == toupper('c') &&
                            toupper(Buf[i+5]) == toupper('e') &&
                            toupper(Buf[i+6]) == ' ' &&
                            toupper(Buf[i+7]) == toupper('i') &&
                            toupper(Buf[i+8]) == toupper('d') &&
                            Buf[i+9] == '=' &&
                            Buf[i+10] == '\"')
                        {
                           k = i+11;
                           do
                           {
                              idx_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           break;
                        }
                     }
                     idx = StrToIntDef(idx_str, 0);

                     if( idx < ObjTree->Items->Count )
                     {
                        if( idx > 0 )
                        {
                           MainForm->SetFocus();
                           ObjTree->TabStop = true;
                           TShiftState sh;
                           sh << ssLeft;
                           ObjTree->Select( ObjTree->Items->Item[idx], sh );

                           ObjTreeClick(this);
                        }
                     }
                  }
                  else if( cmd == 133 )
                  {
                     AnsiString idx_str, lev_str, type_str, num1_str, num2_str, num3_str;
                     int idx = 0, level = 0, type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('d') &&
                            toupper(Buf[i+1]) == toupper('e') &&
                            toupper(Buf[i+2]) == toupper('v') &&
                            toupper(Buf[i+3]) == toupper('i') &&
                            toupper(Buf[i+4]) == toupper('c') &&
                            toupper(Buf[i+5]) == toupper('e') &&
                            toupper(Buf[i+6]) == ' ' &&
                            toupper(Buf[i+7]) == toupper('i') &&
                            toupper(Buf[i+8]) == toupper('d') &&
                            Buf[i+9] == '=' &&
                            Buf[i+10] == '\"')
                        {
                           k = i+11;
                           do
                           {
                              idx_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     idx = StrToIntDef(idx_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('l') &&
                            toupper(Buf[i+1]) == toupper('e') &&
                            toupper(Buf[i+2]) == toupper('v') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            toupper(Buf[i+4]) == toupper('l') &&
                            Buf[i+5] == '=' &&
                            Buf[i+6] == '\"')
                        {
                           k = i+7;
                           do
                           {
                              lev_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     level = StrToIntDef(lev_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     if( idx == 0 )
                     {
                        if( level == 0 )
                        {
                           if( type == 0 ) Dk_Ssoi(true);
                           else if( type == 1 ) Dk_Rif(true);
                        }
                        else
                        {
                           Dk_Ssoi_Kan(true, num1-1);
                        }
                     }
                     else
                     {
                         if( idx < ObjTree->Items->Count )
                         {
                           if( idx > 0 && idx != ObjTree->Selected->Index )
                           {
                              MainForm->SetFocus();
                              ObjTree->TabStop = true;
                              TShiftState sh;
                              sh << ssLeft;
                              ObjTree->Select( ObjTree->Items->Item[idx], sh );

                              ObjTreeClick(this);
                              Dk_Dev(true);
                           }
                        }
                     }
                  }
                  else if( cmd == 1133 )
                  {
                     AnsiString idx_str, lev_str, type_str, num1_str, num2_str, num3_str;
                     int type = 0, num1 = 0, num2 = 0, num3 = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              type_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     type = StrToIntDef(type_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('1') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num1_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num1 = StrToIntDef(num1_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('2') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num2_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num2 = StrToIntDef(num2_str, 0);

                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('n') &&
                            toupper(Buf[i+1]) == toupper('u') &&
                            toupper(Buf[i+2]) == toupper('m') &&
                            toupper(Buf[i+3]) == toupper('3') &&
                            Buf[i+4] == '=' &&
                            Buf[i+5] == '\"' )
                        {
                           k = i+6;
                           do
                           {
                              num3_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           KKK = k;
                           break;
                        }
                     }
                     num3 = StrToIntDef(num3_str, 0);

                     int dtype = 0, dnum1 = 0, dnum2 = 0, dnum3 = 0;

                     ObjTree->Items->BeginUpdate();
                     for( int k = 0; k < ObjTree->Items->Count; k++ )
                     {
                        dtype = POprosObj(ObjTree->Items->Item[k]->Data)->Type;
                        dnum1 = POprosObj(ObjTree->Items->Item[k]->Data)->Num1;
                        dnum2 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2;
                        dnum3 = POprosObj(ObjTree->Items->Item[k]->Data)->Num3;

                        if( type == dtype && num1 == dnum1 && num2 == dnum2 && num3 == dnum3 )
                        {
                              MainForm->SetFocus();
                              ObjTree->TabStop = true;
                              TShiftState sh;
                              sh << ssLeft;
                              ObjTree->Select( ObjTree->Items->Item[k], sh );

                              ObjTreeClick(this);
                              Dk_Dev(true);
                              break;
                        }
                     }
                     ObjTree->Items->EndUpdate();
                  }
                  else if( cmd == 137 || cmd == 136 )
                  {
                     AnsiString idx_str;
                     int idx = 0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('d') &&
                            toupper(Buf[i+1]) == toupper('e') &&
                            toupper(Buf[i+2]) == toupper('v') &&
                            toupper(Buf[i+3]) == toupper('i') &&
                            toupper(Buf[i+4]) == toupper('c') &&
                            toupper(Buf[i+5]) == toupper('e') &&
                            toupper(Buf[i+6]) == ' ' &&
                            toupper(Buf[i+7]) == toupper('i') &&
                            toupper(Buf[i+8]) == toupper('d') &&
                            Buf[i+9] == '=' &&
                            Buf[i+10] == '\"')
                        {
                           k = i+11;
                           do
                           {
                              idx_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           break;
                        }
                     }
                     idx = StrToIntDef(idx_str, 0);

                     if( idx < ObjTree->Items->Count )
                     {
                        if( idx > 0 /*&& idx != ObjTree->Selected->Index*/ )
                        {
                           MainForm->SetFocus();
                           ObjTree->TabStop = true;
                           TShiftState sh;
                           sh << ssLeft;
                           ObjTree->Select( ObjTree->Items->Item[idx], sh );

                           ObjTreeClick(this);
                           Control_Dev(true);
                        }
                     }
                  }
                  else if( cmd == 1301 )
                  {
                     AnsiString idx_str;
                     int type = 0, num1 = 0, num2 = 0, num3 =0;

                     int k = 0;
                     for( int i = KKK; i < length-8; i++ )
                     {
                        if( toupper(Buf[i]) == toupper('t') &&
                            toupper(Buf[i+1]) == toupper('y') &&
                            toupper(Buf[i+2]) == toupper('p') &&
                            toupper(Buf[i+3]) == toupper('e') &&
                            toupper(Buf[i+4]) == toupper('=') &&
                            Buf[i+5] == '\"')
                        {
                           k = i+6;
                           do
                           {
                              idx_str += Buf[k];
                              k = k + 1;
                           }
                           while( toupper(Buf[k]) != toupper('\"') );
                           break;
                        }
                     }
                     type = StrToIntDef(idx_str, 0);
                     KKK = k;

                     if( type > 0 )
                     {
                       idx_str = "";
                       for( int i = KKK; i < length-8; i++ )
                       {
                          if( toupper(Buf[i]) == toupper('n') &&
                              toupper(Buf[i+1]) == toupper('u') &&
                              toupper(Buf[i+2]) == toupper('m') &&
                              toupper(Buf[i+3]) == toupper('1') &&
                              toupper(Buf[i+4]) == toupper('=') &&
                              Buf[i+5] == '\"')
                          {
                             k = i+6;
                             do
                             {
                                idx_str += Buf[k];
                                k = k + 1;
                             }
                             while( toupper(Buf[k]) != toupper('\"') );
                             break;
                          }
                       }

                       num1 = StrToIntDef(idx_str, 0);
                       KKK = k;

                       idx_str = "";
                       for( int i = KKK; i < length-8; i++ )
                       {
                          if( toupper(Buf[i]) == toupper('n') &&
                              toupper(Buf[i+1]) == toupper('u') &&
                              toupper(Buf[i+2]) == toupper('m') &&
                              toupper(Buf[i+3]) == toupper('2') &&
                              toupper(Buf[i+4]) == toupper('=') &&
                              Buf[i+5] == '\"')
                          {
                             k = i+6;
                             do
                             {
                                idx_str += Buf[k];
                                k = k + 1;
                             }
                             while( toupper(Buf[k]) != toupper('\"') );
                             break;
                          }
                       }

                       num2 = StrToIntDef(idx_str, 0);
                       KKK = k;

                       idx_str = "";
                       for( int i = KKK; i < length-8; i++ )
                       {
                          if( toupper(Buf[i]) == toupper('n') &&
                              toupper(Buf[i+1]) == toupper('u') &&
                              toupper(Buf[i+2]) == toupper('m') &&
                              toupper(Buf[i+3]) == toupper('3') &&
                              toupper(Buf[i+4]) == toupper('=') &&
                              Buf[i+5] == '\"')
                          {
                             k = i+6;
                             do
                             {
                                idx_str += Buf[k];
                                k = k + 1;
                             }
                             while( toupper(Buf[k]) != toupper('\"') );
                             break;
                          }
                       }
                       num3 = StrToIntDef(idx_str, 0);
                     }

                     int dtype = 0, dnum1 = 0, dnum2 = 0, dnum3 = 0;
                     AnsiString str;
                     ObjTree->Items->BeginUpdate();
                     for( int k = 0; k < ObjTree->Items->Count; k++ )
                     {
                        dtype = POprosObj(ObjTree->Items->Item[k]->Data)->Type;
                        dnum1 = POprosObj(ObjTree->Items->Item[k]->Data)->Num1;
                        dnum2 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2;
                        dnum3 = POprosObj(ObjTree->Items->Item[k]->Data)->Num3;

                        if( type == dtype && num1 == dnum1 && num2 == dnum2 && num3 == dnum3 )
                        {
                           TreeAndStates->Clear();
                           TreeAndStates->Add("<RIFPlusPacket type=\"InitialStatus\">");
                           TreeAndStates->Add("<devices>");

                           if( dtype == RifRlmSType ) dtype = 99;

                           if( dtype == StrazhIpType )
                               str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\" login=\"%s\" password=\"%s\" ip2=\"%s\">",
                               k,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                               dtype,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon2Path,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon3Path,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon4Path );
                           else if( dtype == OnvifTvType )
                               str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\" login=\"%s\" password=\"%s\">",
                               k,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                               dtype,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon2Path,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon3Path );
                           else if( dtype == NetDevIdx )
                               str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" ip=\"%s\">",
                               k,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                               dtype,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Icon1Path);
                           else
                               str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                               k,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Level,
                               dtype,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num1,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num2,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Num3,
                               POprosObj(ObjTree->Items->Item[k]->Data)->Name,
                               POprosObj(ObjTree->Items->Item[k]->Data)->lan,
                               POprosObj(ObjTree->Items->Item[k]->Data)->lon,
                               POprosObj(ObjTree->Items->Item[k]->Data)->description );


                           bool alarmfix = true;
                           TreeAndStates->Add(str);
                           TreeAndStates->Add("<states>");
                           int id = 0;
                           AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss", Now());
                           AnsiString name;
                           switch( POprosObj(ObjTree->Items->Item[k]->Data)->Type )
                           {
                              case GroupType: 
                                      break;
                              case RifType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case RifRlmSType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case SdConcType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      break;
                              case SdType:
                                      if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Bazalt )
                                      {
                                         if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                             GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 111;
                                         else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                             GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 113;
                                         else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                             GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 112;
                                         else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                             GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 110;
                                      }
                                      else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].ConnectBlock )
                                      {
                                         if(  GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 )
                                         {
                                            if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 143;
                                            else id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                         }
                                         else if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 20 )
                                         {
                                            if( GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 144;
                                            else id = 145;
                                         }
                                         else id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                      }
                                      else
                                      {
                                         id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                         alarmfix = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].AlarmFix;
                                      }
                                      break;
                              case IuType: 
                                      id = GobiSys->Kanal[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                      break;
                              case RastrOldType: 
                                      break;
                              case SolidType: 
                                      break;
                              case Adam4068Type: 
                                      id = A4068Sys->Dev[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Out[POprosObj(ObjTree->Items->Item[k]->Data)->Num2];
                                      break;
                              case TorosType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case NastType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case TochkaType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      break;
                              case SdIpBlType: 
                                      if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] )
                                      {
                                         if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] )
                                            id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                         else id = 20;
                                         alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      }
                                      else
                                      {
                                         if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 1 )
                                         {
                                           if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                               RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 100 ) 
                                           {
                                              id = 111;
                                           }
                                           else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                    RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 101 ) 
                                           {
                                              if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].StatusOld[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 11 )
                                              {
                                                 id = 111;
                                              }
                                              else
                                              {
                                                 id = 113;
                                              }
                                           }
                                           else if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                    RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 101 ) 
                                           {
                                              id = 110;
                                           }
                                           else if( !RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Tin[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] &&
                                                    RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt] == 100 ) 
                                           {
                                              if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].StatusOld[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 11 )
                                              {
                                                 id = 110;
                                              }
                                              else
                                              {
                                                 id = 112;
                                              }
                                           }
                                         }
                                         else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 10 )
                                           id = 17;
                                         else if( RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] == 0 )
                                           id = 2;
                                      }
                                      break;
                              case IuIpBlType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1+MaxIpBlSdCnt];
                                      break;
                              case RazrivBoType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1];
                                      break;
                              case SsoiType: 
                                      break;
                              case Stn485Type: 
                                      break;
                              case RastrType: 
                                      break;
                              case RadarType: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case SsoiMSdType: 
                                       if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Bazalt )
                                       {
                                           if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                               GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 111;
                                           else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 21 &&
                                               GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 113;
                                           else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                               GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 ) id = 112;
                                           else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 &&
                                               GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 2 ) id = 110;
                                       }
                                       else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].ConnectBlock )
                                       {
                                           if(  GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 1 )
                                           {
                                              if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 143;
                                              else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                           }
                                           else if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status == 20 )
                                           {
                                              if( GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status == 1 ) id = 144;
                                              else id = 145;
                                           }
                                           else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                       }
                                       else
                                       {
                                          id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                          alarmfix = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Sd[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].AlarmFix;
                                       }
                                      break;
                              case SsoiMIuType: 
                                      if( POprosObj(ObjTree->Items->Item[k]->Data)->Num3 < 4 )
                                          id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Iu[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1].Status;
                                      else id = GobiSys2->Bl[POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1].Vk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-4].Status;
                                      if( id == 1 ) id = 101;
                                      else id = 100;
                                      break;
                              case TabloType: 
                                      break;
                              case StrazhIpType: 
                                      break;
                              case OnvifTvType: 
                                      break;
                              case TochkaMBoIdx: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case TochkaMUchIdx: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].StatusUch[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].AlarmFix;
                                      break;
                              case TochkaMDdIdx: 
                                      {
                                          int num21 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2%100;
                                          if( POprosObj(ObjTree->Items->Item[k]->Data)->Num2 >= 300 ) num21 += 26;
                                          id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].sob_type;
                                          alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].AlarmFix;
                                      }
                                      break;
                              case SotaMBoIdx: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Status[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].AlarmFix[0];
                                      break;
                              case SotaMUchIdx: 
                                      id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].StatusUch[0];
                                      alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Uch[(POprosObj(ObjTree->Items->Item[k]->Data)->Num2/100)-1].AlarmFix;
                                      break;
                              case SotaMDdIdx: 
                                      {
                                         int num21 = POprosObj(ObjTree->Items->Item[k]->Data)->Num2%100;
                                         if( POprosObj(ObjTree->Items->Item[k]->Data)->Num2 >= 300 ) num21 += 100;
                                         id = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].sob_type;
                                         alarmfix = RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][POprosObj(ObjTree->Items->Item[k]->Data)->Num1-1].Dd[num21].AlarmFix;
                                      }
                                      break;
                              case DevLineIdx: 
                                      break;
                           }
                           switch( id )
                           {
                               case   0: name = Table1Str1; 
                                         break;
                              case   1: name = Table1Str2; 
                                        break;
                              case   2: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == SdIpBlType &&
                                            RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] ) name = Table1Str1;
                                        else name = "Конф. изм. (пульт)";
                                        break;
                              case   3: name = Table1Str3;
                                        break;
                              case   4: name = Table1Str4; 
                                        break;
                              case   5: name = "Отметка пройдена"; 
                                        break;
                              case   6: name = "Определение направления включено";
                                        break;
                              case   7: name = "Определение направления выключено";
                                        break;
                              case  10: name = Table1Str5; 
                                        break;
                              case  11: name = Table1Str6; 
                                        break;
                              case  12: name = "Неисправность";
                                        break;
                              case  13: name = Table1Str7; 
                                        break;
                              case  15: name = "Перевод в режим \"Раб. с пультом\"";
                                        break;
                              case  16: name = "Отсутствует синхронизация";
                                        break;
                              case  17: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == SdIpBlType &&
                                            RifSys->Rk[POprosObj(ObjTree->Items->Item[k]->Data)->Num3-1][IpBlIdx].Bazalt[POprosObj(ObjTree->Items->Item[k]->Data)->Num2-1] ) name = Table1Str5;
                                        else name = "Неисправность линии";
                                        break;
                              case  18: name = "Неисправность ЧЭ";
                                        break;
                              case  20: name = Table1Str8; 
                                        break;
                              case  21: name = Table1Str9; 
                                        break;
                              case  22: name = Table1Str10; 
                                        break;
                              case  23: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 9 ) name = "Тревога - СРАБОТКА(Луч \"чужой\")";
                                        else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 91 ) name = "Тревога - СРАБОТКА(Зона 1)";
                                        else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 21 ) name = "Тревога - НЕИСПРАВНОСТЬ";
                                        else name = "Тревога - СРАБОТКА(Луч 1)";
                                        break;
                              case  24: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 9 ) name = "Тревога - СРАБОТКА(Луч \"свой\")";
                                        else if( POprosObj(ObjTree->Items->Item[k]->Data)->Type == 91 ) name = "Тревога - СРАБОТКА(Зона 2)";
                                        else name = "Тревога - СРАБОТКА(Луч 2)";
                                        break;
                              case  25: if( POprosObj(ObjTree->Items->Item[k]->Data)->Type != RifRlmSType ) name = Table1Str9; /*"Тревога - ВСКРЫТИЕ";*/
                                        else name = "Тревога - СИНХР.ИЗМ.";
                                        break;
                              case  26: name = "Тревога - Отсутствие часового"; 
                                        break;
                              case  27: name = "Тревога - СРАБОТКА(Зона 3)";
                                        break;
                              case  30: name = "Раб. с пультом";
                                        break;
                              case  31: name = "Раб. с пультом заверш.";
                                        break;
                              case 100: name = Table1Str11;
                                        break;
                              case 101: name = Table1Str12;
                                        break;
                              case 110: name = Table1Str13;
                                        break;
                              case 112: name = Table1Str28;
                                        break;
                              case 113: name = Table1Str29;
                                        break;
                              case 111: name = Table1Str14;
                                        break;
                              case 130: name = Table1Str15;
                                        break;
                              case 131: name = Table1Str16; 
                                        break;
                              case 132: name = "Послана ком. \"Раб. с пультом\"";
                                        break;
                              case 138: name = "Послана ком. \"Завершение раб. с пультом\"";
                                        break;
                              case 133: name = Table1Str17; 
                                        break;
                              case 134: name = "Запись настройки";
                                        break;
                              case 135: name = Table1Str18;
                                        break;
                              case 136: name = Table1Str19;
                                        break;
                              case 137: name = Table1Str20;
                                        break;
                              case 140: name = Table1Str21;
                                        break;
                              case 141: name = Table1Str22;
                                        break;
                              case 142: name = "Синхронизация восстановлена";
                                        break;
                              case 143: name = Table1Str30;
                                        break;
                              case 144: name = "Вызов завершен по кан. связи";
                                        break;
                              case 145: name = Table1Str32;
                                        break;
                              case 150: name = Table1Str23;
                                        break;
                              case 151: name = Table1Str24;
                                        break;
                              case 160: name = "ДК не выполнена (все зоны отключены)";
                                        break;
                              case 170: name = "Зона1 отключена";
                                        break;
                              case 171: name = "Зона1 включена";
                                        break;
                              case 172: name = "Зона2 отключена";
                                        break;
                              case 173: name = "Зона2 включена";
                                        break;
                              case 174: name = "Зона3 отключена";
                                        break;
                              case 175: name = "Зона3 включена";
                                        break;
                              case 200: name = Table1Str5; 
                                        break;
                           }

                           if( alarmfix ) str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>", id, dt_str, name);
                           else str.sprintf("<state id=\"136\" datetime=\"%s\" name=\"%s\"/>", dt_str, "Контроль выкл");
                           TreeAndStates->Add(str);
                           TreeAndStates->Add("</states>");
                           TreeAndStates->Add("</device>");
                           TreeAndStates->Add("</devices>");
                           TreeAndStates->Add("</RIFPlusPacket>");
                           Socket->SendBuf(TreeAndStates->Text.c_str(),TreeAndStates->Text.Length());
                           break;
                        }
                     }

                     ObjTree->Items->EndUpdate();
                  }


m2:               iNetSys->iNetClient[j].KeepAliveCnt = 0;
                  goto m1;
               }
            }
         }
         catch(...)
         {
            ;
         }
m1:   ;
      }
      else if( toupper(Buf[i]) == toupper('a') &&
          toupper(Buf[i+1]) == toupper('l') &&
          toupper(Buf[i+2]) == toupper('a') &&
          toupper(Buf[i+3]) == toupper('r') &&
          toupper(Buf[i+4]) == toupper('m') &&
          toupper(Buf[i+5]) == toupper('s') &&
          toupper(Buf[i+6]) == toupper('r') &&
          toupper(Buf[i+7]) == toupper('e') &&
          toupper(Buf[i+8]) == toupper('s') &&
          toupper(Buf[i+9]) == toupper('e') &&
          toupper(Buf[i+10]) == toupper('t'))
      {
         /* AlarmsReset */
         AlarmsReset(true);
      }
      else if( toupper(Buf[i]) == toupper('d') &&
          toupper(Buf[i+1]) == toupper('b') &&
          toupper(Buf[i+2]) == toupper('s') &&
          toupper(Buf[i+3]) == toupper('t') &&
          toupper(Buf[i+4]) == toupper('a') &&
          toupper(Buf[i+5]) == toupper('r') &&
          toupper(Buf[i+6]) == toupper('t') )
      {
         /* AlarmsReset */
         DbStart(true, false);
      }
   }
   delete Buf;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Server2ClientConnect(TObject *Sender,
      TCustomWinSocket *Socket)
{
   for( int i = 0; i < NetClientMaxCnt; i++ )
   {
      if( r485NetSys->iNetClient[i].IsEmpty() )
      {
         r485NetSys->iNetClient[i].Set(Socket->SocketHandle );
         r485NetSys->iNetClient[i].KeepAliveCnt = 0;
         break;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Server2ClientDisconnect(TObject *Sender,
      TCustomWinSocket *Socket)
{
   for( int j = 0; j < NetClientMaxCnt; j++ )
   {
      if( r485NetSys->iNetClient[j].IsExist(Socket->SocketHandle) )
      {
         r485NetSys->iNetClient[j].Reset();
         r485NetSys->iNetClient[j].KeepAliveCnt = 0;
         break;
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AdvStringGrid1GetAlignment(TObject *Sender,
      int ARow, int ACol, TAlignment &HAlign, TVAlignment &VAlign)
{
   HAlign = taCenter;
   VAlign = vtaCenter;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AdvStringGrid1GetCellColor(TObject *Sender,
      int ARow, int ACol, TGridDrawState AState, TBrush *ABrush,
      TFont *AFont)
{
   ABrush->Color = clBtnFace;

   if( ARow == 0 || ACol == 0 ) ABrush->Color = clBtnFace;
   else
   {
      AnsiString str = AdvStringGrid1->Cells[ACol][ARow];

      if( str == "Нет связи!" )  ABrush->Color = clYellow;
      else if( str == "Да [1]" )  ABrush->Color = clRed;
      else if( str == "Да {1}" )  ABrush->Color = clBlue;
      else if( str == "Да (1)" )  ABrush->Color = clYellow;
      else if( str == "[1]" )  ABrush->Color = clRed;
      else if( str == "(1)" )  ABrush->Color = clYellow;
      else if( str == "{1}" )  ABrush->Color = clBlue;
      else if( str == "?" )  ABrush->Color = clGray;
      else if( str == "<1>" )  ABrush->Color = clGreen;
      else if( str == "Есть [1]" )  ABrush->Color = clYellow;
      else if( str == "Тревога" )  ABrush->Color = clRed;
      else if( str == "Есть" )  ABrush->Color = clRed;
      else if( str == "Было" )  ABrush->Color = clRed;
      else if( str == "Нет" )  ABrush->Color = clGreen;
      else if( str == "Замыкание кабеля" )  ABrush->Color = clYellow;
      else if( str == "Обрыв кабеля" )  ABrush->Color = clYellow;
      else if( str == "Нет [0]" )  ABrush->Color = clGreen;
      else if( str == "[0]" )  ABrush->Color = clGreen;
      else if( str == "<0>" )  ABrush->Color = clYellow;
      else if( str == "Норма" )  ABrush->Color = clGreen;
      else if( str == "Вкл" )  ABrush->Color = clRed;
      else if( str == "Выкл" && ACol == 1 )  ABrush->Color = clGreen;
      else if( str == "Выкл" && ACol != 1 ) ABrush->Color = clDkGray;
      else if( str == "-" )  ABrush->Color = clDkGray;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SsoiMOpros(TObject *Sender)
{
   int kan = ((TTimer*)Sender)->Tag;
   int flag = 0;

   if( SsoiM_PortNum[kan] != 0 && SsoiMScnt[kan] > 0 )
   {
      for( int bl = 0; bl < BlCnt; bl++ )
      {
          for( int iu = 0; iu < IuCnt; iu++ )
          {
             if( GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt <= 0 )
             {
               if( GobiSys2->Bl[kan][bl].Sd[iu].Status == 13 ) GobiSys2->Bl[kan][bl].Sd[iu].Status = 0;
             }
             else if( GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt > 1 )
             {
                GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt -= 1;
//                GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt - 1;

                if( POprosObj(ObjTree->Selected->Data)->Num1-1 == kan &&
                    POprosObj(ObjTree->Selected->Data)->Num2-1 == bl &&
                    POprosObj(ObjTree->Selected->Data)->Num3-1 == iu )
                {
                   CGauge1->Progress = BazaltCnt2 - GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt;
                   GroupBox5->Visible = true;
                }
             }
             else if( GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt == 1 )
             {
                GobiSys2->Bl[kan][bl].Sd[iu].Status = 13; 
                GobiSys2->Bl[kan][bl].Sd[iu].OnOffCnt = 1;

                if( POprosObj(ObjTree->Selected->Data)->Num1-1 == kan &&
                    POprosObj(ObjTree->Selected->Data)->Num2-1 == bl &&
                    POprosObj(ObjTree->Selected->Data)->Num3-1 == iu )
                {
                   CGauge1->Progress = BazaltCnt2;
                   GroupBox5->Visible = false;
                }
             }
          }
      }

      int packet[10000];
      int packet1[10000];
      int flag1;

k1m2: flag = 0;
      flag1 = 0;
      memset(packet, 0, 10000);
      memset(packet1, 0, 10000);

      /* Введено 11.06.2016 для исправления ошибки:
         После выключения БЛ1 (состояние БЛ1 - не связи), а затем включения БЛ1
         связь с БЛ1 не восстанавливалась из-за того, что почему то (так и не выяснено почему)
         на ПК пакет от БЛ1 не успевает прийти)
         Причем ощшибка возникает только на родных COM-портах ПК, на USB-портах такой ошибки нет */
      if( GobiSys2->OprosAdr[kan][SsoiMIdx[kan]] == 1 && GobiSys2->Bl[kan][0].NetSviazi )
      {
         MyDelay(200);
      }
      flag = SsoiMSerial[kan].GetPaketSsoi2_v2(GobiSys2->OprosAdr[kan][SsoiMIdx[kan]], packet);
      if( flag > 0 )
      {
         for( int i = 0; i < flag; i++) Ssoi2Buf[kan][Ssoi2BufCnt[kan]+i] = packet[i];
         Ssoi2BufCnt[kan] = Ssoi2BufCnt[kan]+flag;

         for( int i = 0; i < 9990; i++ )
         {
            if( Ssoi2Buf[kan][i] == 0xB5 )
            {
               if( Ssoi2Buf[kan][i+1] == 0xFE )
               {
                  if( Ssoi2Buf[kan][i+2] == 0xFE )
                  {
                     if( Ssoi2Buf[kan][i+3] == GobiSys2->OprosAdr[kan][SsoiMIdx[kan]] )
                     {
                        flag = 8;

                        int crc = 0;
                        for( int j = i+1; j < i+flag; j++ ) crc = (crc + Ssoi2Buf[kan][j])%256;

                        if( crc == 0 )
                        {
                           MyDelay(150);
                           flag1 = SsoiMSerial[kan].GetPaketSsoi2_v2(GobiSys2->OprosAdr[kan][SsoiMIdx[kan]], packet1);
                           for( int k = i+1+flag-flag1; k < i+1+flag+flag1; k++ ) Ssoi2Buf[kan][k] = packet1[k-i-flag1-1];

                           for( int j = i+1; j < i+flag; j++ ) crc = (crc + Ssoi2Buf[kan][j])%256;
                        }

                        if( crc == Ssoi2Buf[kan][i+flag] )
                        {
                           for( int j = 0; j < flag+1; j++ ) packet[j] = Ssoi2Buf[kan][i+j]&0xFF;
                           flag = 1; 
                           break;
                        }
                        else
                        {
                           flag = -5;
                        }
                     }
                     else flag = -4; 
                  }
                  else if( Ssoi2Buf[kan][i+2] == 0x01 && GobiSys2->Bl[kan][0].NetSviazi ) 
                  {
                     if( Ssoi2Buf[kan][i+3] == GobiSys2->OprosAdr[kan][SsoiMIdx[kan]] )
                     {
                        flag = 8;

                        int crc = 0;
                        for( int j = i+1; j < i+flag; j++ ) crc = (crc + Ssoi2Buf[kan][j])%256;

                        if( crc == 0 )
                        {
                           MyDelay(150);
                           flag1 = SsoiMSerial[kan].GetPaketSsoi2_v2(GobiSys2->OprosAdr[kan][SsoiMIdx[kan]], packet1);
                           for( int k = i+1+flag-flag1; k < i+1+flag+flag1; k++ ) Ssoi2Buf[kan][k] = packet1[k-i-flag1-1];

                           for( int j = i+1; j < i+flag; j++ ) crc = (crc + Ssoi2Buf[kan][j])%256;
                        }

                        if( crc == Ssoi2Buf[kan][i+flag] )
                        {
                           for( int j = 0; j < flag+1; j++ ) packet[j] = Ssoi2Buf[kan][i+j]&0xFF;
                           flag = 1; 
                           break;
                        }
                        else
                        {
                           flag = -5;
                        }
                     }
                     else flag = -4;
                  }
               }
               else flag = -3;
            }
            else flag = -2;
         }
      }

      bool Tin[SdCnt] = {false,false,false,false,false,false,false,false,false};
      bool Ts[SdCnt] = {false,false,false,false,false,false,false,false,false};
      bool Iu[IuCnt] = {false,false,false};
      bool Vk[IuCnt] = {false,false,false};
      bool Dk = false;
      bool Dk_in = false;
      bool Vin = false;
      bool T = false;
      bool Tv = false;

      if( flag == 1 )
      {
         GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].ErrCnt = 0;
         GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].NetSviazi  = false;
         Ssoi2Cnt[kan] = Ssoi2MaxCnt[kan];

         if( (packet[4]&0x01) == 0x01 ) Tin[0] = true;
         if( (packet[4]&0x02) == 0x02 ) Tin[1] = true;
         if( (packet[4]&0x04) == 0x04 ) Tin[2] = true;
         if( (packet[4]&0x08) == 0x08 ) Tin[3] = true;
         if( (packet[4]&0x10) == 0x10 ) Tin[4] = true;
         if( (packet[4]&0x20) == 0x20 ) Tin[5] = true;
         if( (packet[4]&0x40) == 0x40 ) Tin[6] = true;
         if( (packet[4]&0x80) == 0x80 ) Tin[7] = true;

         if( (packet[5]&0x01) == 0x01 ) Iu[0] = true;
         if( (packet[5]&0x02) == 0x02 ) Iu[1] = true;
         if( (packet[5]&0x04) == 0x04 ) Iu[2] = true;
         if( (packet[5]&0x08) == 0x08 ) Dk_in = true;
         if( (packet[5]&0x10) == 0x10 ) Vin = true;
         if( (packet[5]&0x20) == 0x20 ) T = true;
         if( (packet[5]&0x40) == 0x40 ) Tv = true;
         if( (packet[5]&0x80) == 0x80 ) Dk = true;

         if( (packet[6]&0x01) == 0x01 ) Ts[0] = true;
         if( (packet[6]&0x02) == 0x02 ) Ts[1] = true;
         if( (packet[6]&0x04) == 0x04 ) Ts[2] = true;
         if( (packet[6]&0x08) == 0x08 ) Ts[3] = true;
         if( (packet[6]&0x10) == 0x10 ) Ts[4] = true;
         if( (packet[6]&0x20) == 0x20 ) Ts[5] = true;
         if( (packet[6]&0x40) == 0x40 ) Ts[6] = true;
         if( (packet[6]&0x80) == 0x80 ) Ts[7] = true;

         if( (packet[7]&0x01) == 0x01 ) Vk[0] = true;
         if( (packet[7]&0x02) == 0x02 ) Vk[1] = true;
         if( (packet[7]&0x04) == 0x04 ) Vk[2] = true;

         if( T )  
         {
            if( Tv ) 
            {
                  if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[8].Use )
                      GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[8].Status = 21; 

//               for( int i = 0; i < SdCnt; i++ )
//               {
//                  if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Use )
//                      GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 21; 
//               }

               GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF1; 
            }
//            else
            {
               if( !Dk )
               {
                  for( int i = 0; i < SdCnt-1; i++ )
                  {
                     if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Use )
                     {
                        if( Ts[i] )  /* Сработка */
                          GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 20; 
                        else GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 1; 
                     }
                  }

                  GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF1; 
               }
               else  
               {
                  for( int i = 0; i < SdCnt-1; i++ )
                  {
                     if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Dk )
                     {
                        if( Ts[i] && !GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Sin )  
                        {
                           Tin[i] = false;
                           GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].DkOk = true;
                        }
                        else if( !Ts[i] && GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus == 0 )
                        {
                           GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF1; 
                        }
                     }
                  }
               }
            }
         }
         else  
         {
            for( int i = 0; i < SdCnt; i++ )
            {
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Use )
               {
                  if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status != 13)
                  {
                     GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 1;
                  }
               }
            }

            if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd != 0xF2 ) GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF0;
         }

         TTime t = Now();
         if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus == 2 )
         {
            if( t >= (GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkTime + GobiSys2->DkDtTime[kan]) )
            {
               for( int i = 0; i < SdCnt-1; i++ )
               {
                  if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Dk )
                  {
                     if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].DkOk )
                        GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 3; 
                     else
                        GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 11; 
                  }
               }

               GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus = 0;
               GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF1; 
            }
         }

         for( int i = 0; i < IuCnt; i++ )
         {
            if( Iu[i] )
            {
               GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].Status = 1;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].AutoOff > 0 )
               {
                  if( Now() > GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].OffDt )
                  {
                     GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].hCmd = 2;
                     GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF2;
                  }
               }
            }
            else GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].Status = 2;
         }

         for( int i = 0; i < IuCnt; i++ )
         {
            if( Vk[i] ) GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[i].Status = 1;
            else GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[i].Status = 2;
         }
      }
      else
      {
         GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].ErrCnt += 1;
      }

      if( Ssoi2Cnt[kan] >= Ssoi2MaxCnt[kan] )
      {
         if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].ErrCnt >= SsoiM_MaxErrCnt[kan] )
         {
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus = 0;
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].NetSviazi  = true;

            for( int i = 0; i < SdCnt; i++ )
            {
               GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[i].Status = 10; 
            }
            for( int i = 0; i < IuCnt; i++ )
            {
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].Use )
                   GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[i].Status = 10; 
            }
            for( int i = 0; i < IuCnt; i++ )
            {
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[i].Use )
                   GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[i].Status = 10; 
            }

            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF0;
         }
         else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].ErrCnt == 0 )
         {
            int zaglushka1 = 0;
         }
         else
         {
            int zaglushka2 = 0;
            goto k1fucking_err;
         }

         ShowNewSsoi2Status( kan, GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1, Tin, Vin );

         if( GroupBox10->Visible && kan == (POprosObj(ObjTree->Selected->Data)->Num1-1) &&
             GobiSys2->OprosAdr[kan][SsoiMIdx[kan]] == POprosObj(ObjTree->Selected->Data)->Num2 )
         {
            if( POprosObj(ObjTree->Selected->Data)->Type == 33 )
               ShowDiagSsoi2InfoNew(GobiSys2->Bl[kan][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].Status, T, Tv, Vin, Dk, Dk_in, Tin, Ts, Iu, Vk );
            else if( POprosObj(ObjTree->Selected->Data)->Type == 43 )
            {
               if( POprosObj(ObjTree->Selected->Data)->Num3 < 4 )
                  ShowDiagSsoi2InfoNew(GobiSys2->Bl[kan][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].Status, T, Tv, Vin, Dk, Dk_in, Tin, Ts, Iu, Vk );
               else
                  ShowDiagSsoi2InfoNew(GobiSys2->Bl[kan][POprosObj(ObjTree->Selected->Data)->Num2-1].Sd[POprosObj(ObjTree->Selected->Data)->Num3-4].Status, T, Tv, Vin, Dk, Dk_in, Tin, Ts, Iu, Vk );
            }
         }

         if( SsoiMIdx[kan] < BlCnt )
         {
            if( GobiSys2->OprosAdr[kan][SsoiMIdx[kan]+1] != 0 ) SsoiMIdx[kan] += 1;
            else SsoiMIdx[kan] = 0;
         }
         else SsoiMIdx[kan] = 0;

k1fucking_err:


         if( SsoiAutoDkUse )
         {
             TDateTime autoDT = Now();
             if(  autoDT > GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt )
             {
                if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus == 0 )
                {
                   bool tempflag = false;
                   for( int sd = 0; sd < SdCnt; sd++ )
                   {
                      GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[sd].DkOk = false;
                      if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[sd].StatusOld == 1 ) tempflag = true;
                   }

                   if( tempflag )
                   {
                      GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus = 1;
                      for( int sd = 0; sd < SdCnt; sd++ ) GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Sd[sd].AutoDk = 1;
    /*
                      AnsiString str;
                      str.sprintf(" %d", GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]);
                      str = SetSobStr05 + str;
                      SetSob( 133, 0, 0, kan+1, GobiSys2->OprosAdr[kan][SsoiMIdx[kan]], str, OpFn, OpN1, OpN2, "", "", "", false );
                      GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt = IncMinute( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt, 1 );
    */
//                   GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt = IncMinute( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt, 4 );
                     GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt = IncHour( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].AutoDkDt,  4 );
                   }
                }
             }
         }

         int D0 = 0;

         if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus == 1 )
         {
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF3;
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkStatus = 2;
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].DkTime = Now();
         }
         else
         {
            if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd == 0xF2 )
            {
               int IuStatus = 0;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[0].StatusOld == 1 ) IuStatus = 1;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[1].StatusOld == 1 ) IuStatus += 2;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[2].StatusOld == 1 ) IuStatus += 4;

               int VkStatus = 0;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[0].StatusOld == 1 ) VkStatus = 0x10;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[1].StatusOld == 1 ) VkStatus += 0x20;
               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[2].StatusOld == 1 ) VkStatus += 0x40;

               D0 = D0 + IuStatus + VkStatus;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[0].hCmd == 1 ) D0 = D0 | 0x01;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[0].hCmd == 2 ) D0 = D0 & 0xFE;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[1].hCmd == 1 ) D0 = D0 | 0x02;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[1].hCmd == 2 ) D0 = D0 & 0xFD;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[2].hCmd == 1 ) D0 = D0 | 0x04;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Iu[2].hCmd == 2 ) D0 = D0 & 0xFB;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[0].hCmd == 1 ) D0 = D0 | 0x10;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[0].hCmd == 2 ) D0 = D0 & 0xEF;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[1].hCmd == 1 ) D0 = D0 | 0x20;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[1].hCmd == 2 ) D0 = D0 & 0xDF;

               if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[2].hCmd == 1 ) D0 = D0 | 0x40;
               else if( GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Vk[2].hCmd == 2 ) D0 = D0 & 0xBF;
            }
         }

/*
         int ttt = GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd;
         bool ttt1 = GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].NetSviazi;
//         int ttt2 = GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1;
         if( ttt == 0xF0 && ttt1 )
         {
            GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd = 0xF1;
         }
*/

         SsoiMSerial[kan].SetCmdSsoi2(GobiSys2->OprosAdr[kan][SsoiMIdx[kan]], GobiSys2->Bl[kan][GobiSys2->OprosAdr[kan][SsoiMIdx[kan]]-1].Cmd, D0 );

         Ssoi2Cnt[kan] = 0;
         Ssoi2BufCnt[kan] = 0;
         for( int i = 0; i < 10000; i++) Ssoi2Buf[kan][i] = 0;
      }
      else Ssoi2Cnt[kan] += 1;
   }
}
//---------------------------------------------------------------------------
void _fastcall TMainForm::RifOpros(TObject* Sender)
{
   int kn = ((TTimer*)Sender)->Tag;
   int pn = kn;

   if( RifSys->Opros[kn] )
   {
         TDateTime tempDt = Now();

         if( RifPortNum[kn] != 0 )
         {
            int flag = 0;
            int packet[1000];
            bool VS = false;

            bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};

            if( RifSys->AutoDk )
            {
               if( (tempDt > CurrentDtRif[kn] + RifSys->AutoDkPeriod) && RifIdx[kn] == 0 )
               {
                  CurrentDtRif[kn] = tempDt;
                  for( int i = 0; i < RifDevCnt; i++ )
                  {
                     for( int j = 0; j < MaxInCnt; j++ )
                     {
                        if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[j] == 1 && RifSys->Rk[kn][i].DkUse[j] )
                        {
                           if( RifSys->Rk[kn][i].Cmd == 0x22 )
                           {
                              RifSys->Rk[kn][i].Cmd = 0x21;
                              RifSys->Rk[kn][i].CmdCnt = 0;
                              RifSys->Rk[kn][i].AutoDk = true;
                              RifSys->Rk[kn][i].AutoDkCnt = 0;
                              RifSys->Rk[kn][i].KDk[j] = false;
                           }
                        }
                     }
                  }
               }
            }

            if( RifIdx[kn] != -1 )
            {
               if(  RifSerial[kn].SendOk > 0 ) flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
               else flag = 0;
/*
               AnsiString fn;
               fn = ExtractFilePath(Application->ExeName)+ IntToStr(kn) + ".log";
               AutoToFile( fn, flag, packet, 0, true, 0 );
//*/
               if( flag == 1 )
               {
                  if( packet[4] == 0x31 && packet[3] == 3 &&
                     (RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 ||
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 ) )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 30 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 31; 

                        SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }

                     int porogi = packet[5] & 0x0F;
                     int rezhim = (packet[5] & 0x10)>>4;
                     int takt = (packet[5] & 0x40)>>6;
                     int takt2 = (packet[5] & 0x20)>>4;
                     takt = takt | takt2;
                     int porogi1 = porogi;
                     int porogi2 = (packet[5] & 0xF0)>>4;

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 &&
                         rezhim != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     if( porogi != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 &&
                         porogi2 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                       
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 &&
                         takt != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                       
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi = porogi;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 = porogi1;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 = porogi2;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim = rezhim;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt = takt;

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost = packet[6]&0x00FF;
                     double U = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru();

                     bool On = false; 

                     bool Dk = false;  
                     bool T = false;   
                     bool Tv = false;  
                     bool Ts = false;  
                     bool V = false;   
                     bool Ts1 = false; 
                     bool Ts2 = false; 

                     if( (packet[7]&0x01) == 0x01 ) On = true;
                     if( (packet[7]&0x02) == 0x02 ) Ts = true;
                     if( (packet[7]&0x08) == 0x08 ) T = true;
                     if( (packet[7]&0x20) == 0x20 ) Dk = true;
                     if( (packet[7]&0x80) == 0x80 ) Tv = true;
                     if( (packet[7]&0x40) == 0x40 ) Ts1 = true;
                     if( (packet[7]&0x80) == 0x80 ) Ts2 = true;

                     if( GroupBox10->Visible && DiagInfoType == 0 && DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagRif->Port == kn+1 )
                     {
                        ShowDiagRifInfoNew(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, 1, packet[7], U, 0.0, 0, 0);
                     }

                     if( !On && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 100 )
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 100; 
                     else if( On && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 100 )
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 101;  
                     else if( On )
                     {
                        if( T )
                        {
                           if( Ts && Dk )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 && Ts1 && Ts2 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                              }
                              else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                              }
                              MyDelay(1000);
                           }
                           else if( Ts && !Dk )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                              else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 )
                              {
                                 if( Ts1 && Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                 else if( Ts1 && !Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                                 else if( !Ts1 && Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 24; 
                              }
                           }
                           else if( Tv && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 )
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 21; 
                           }
                           else if( !Tv && !Ts )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 12; 
      /*
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                                 SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name );
      */
                              }
                           }

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 )
                           {
                              if( V ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 21; 
                              else
                              {
      //                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;   
                              }
                           }
                           else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 )
                           {
      //                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;   
                           }
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                        }
                     }
                     else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                        else
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                     }
                  }
                  else if( packet[4] == 0x31 && packet[3] == 4 &&
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == RifRlmSType ) 
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 30 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 31;

                        SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }

                     int porogi = packet[7] & 0x0F;

                     int takt = (packet[7] & 0x10)>>4;
                     int takt1 = (packet[7] & 0x20)>>4;
                     int takt2 = (packet[7] & 0x40)>>4;
                     takt = takt | takt1 | takt2;

                     if( porogi != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     if( takt != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi = porogi;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt = takt;

                     int rezhim = packet[8] & 0x03;
                     if( rezhim != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim = rezhim;

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost = packet[5]&0x00FF;
                     double U = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru();

                     bool On = false;  
                     bool Ts = false;  
                     bool St = false;  
                     bool T = false;   
                     bool Sdk = false; 
                     bool Dk = false;  

                     bool Synchro = false;   
                     bool Slow = false;      

                     if( (packet[6]&0x01) == 0x01 ) On = true;
                     if( (packet[6]&0x02) == 0x02 ) Ts = true;
                     if( (packet[6]&0x04) == 0x04 ) St = true;
                     if( (packet[6]&0x08) == 0x08 ) T = true;
                     if( (packet[6]&0x10) == 0x10 ) Sdk = true;
                     if( (packet[6]&0x20) == 0x20 ) Dk = true;
                     if( (packet[6]&0x40) == 0x40 ) Synchro = true;
                     if( (packet[6]&0x80) == 0x80 ) Slow = true;

                     Tin_IpBl[0] = St;

                     if( Synchro != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S != -1 &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 25; 

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                        {
                           POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                           SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                     }
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S = Synchro;


                     if( GroupBox10->Visible && DiagInfoType == 0 && DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagRif->Port == kn+1 )
                     {
                        ShowDiagRifInfoNew(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, 1, packet[6], U, 0.0, packet[7], packet[8]);
                     }

                     if( !On && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 100 )
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 100; 
                     else if( On && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 100 )
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 101; 
                     else if( On )
                     {
                        if( T )
                        {
                           if( Ts && Dk )
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3;

                              MyDelay(1000); 
                           }
                           else if( Ts && !Dk )
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                           }
                           else if( !Ts && Slow )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 12; 
                              }
                           }

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else
                        {
                           if( !Slow ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;   
                           else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 12; 
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                        }
                     }
                     else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                        else
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                     }
                  }
                  else if( packet[4] == 0x41 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 1 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     bool On[MaxInCnt] = {false, false, false, false};
                     if( (packet[6]&0x10) == 0x10 ) On[0] = true;
                     if( (packet[6]&0x20) == 0x20 ) On[1] = true;
                     if( (packet[6]&0x40) == 0x40 ) On[2] = true;
                     if( (packet[6]&0x80) == 0x80 ) On[3] = true;

                     bool TInD1[MaxInCnt] = {false, false, false, false};
                     if( (packet[5]&0x01) == 0x01 ) TInD1[0] = true;
                     if( (packet[5]&0x02) == 0x02 ) TInD1[1] = true;
                     if( (packet[5]&0x04) == 0x04 ) TInD1[2] = true;
                     if( (packet[5]&0x08) == 0x08 ) TInD1[3] = true;

                     bool VInD1[MaxInCnt] = {false, false, false, false};
                     if( (packet[5]&0x20) == 0x20 ) VInD1[0] = true;
                     if( (packet[5]&0x20) == 0x20 ) VInD1[1] = true;
                     if( (packet[5]&0x20) == 0x20 ) VInD1[2] = true;
                     if( (packet[5]&0x20) == 0x20 ) VInD1[3] = true;

                     for( int i = 0; i < MaxInCnt; i++ )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && !On[i] )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 100;
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && On[i] &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] == 101 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 0;
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && On[i] &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] == 100 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 101;
                        }


                        if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && On[i] )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].On[i] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x20;
                        }
                     }

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x20 )
                     {
                        bool Dk = false;  
                        bool T = false;   
                        bool Tv = false; 
                        bool Ts = false;  
                        bool InTs[MaxInCnt] = {false, false, false, false};  

                        if( (packet[7]&0x01) == 0x01 ) InTs[0] = true;
                        if( (packet[7]&0x02) == 0x02 ) InTs[1] = true;
                        if( (packet[7]&0x04) == 0x04 ) InTs[2] = true;
                        if( (packet[7]&0x08) == 0x08 ) InTs[3] = true;
                        if( (packet[7]&0x10) == 0x10 ) Ts = true;
                        if( (packet[7]&0x20) == 0x20 ) T = true;
                        if( (packet[7]&0x40) == 0x40 ) Dk = true;
                        if( (packet[7]&0x80) == 0x80 ) Tv = true;

                        if( T )
                        {
                           if( Ts && Dk )
                           {
                                 bool fdk = true;
                                 for( int i = 0; i < MaxInCnt; i++ )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && On[i] && InTs[i] )
                                    {
                                       if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkUse[i] )
                                          if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AutoDk )
                                             RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 3; 
                                          else
                                             RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 1; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = true;
                                    }

                                    if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkUse[i] )
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = true;

                                    if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] ) fdk = false;
                                 }

                                 if( fdk )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                                    for( int i = 0; i < MaxInCnt; i++ ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                                    RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
      //                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                           }
                           else if( Ts && !Dk )
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                                 if( InTs[i] ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 20; 

      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                           }
                           else if( Tv )
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                              {
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21; 
                              }
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                        }
                        else
                        {
                           for( int i = 0; i < MaxInCnt; i++ )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] &&
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] != 100 &&
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] != 101 )
                              {
                                 if( !TInD1[i] )
                                 {
                                    if( !VInD1[i] ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 1;
                                    else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21;
                                 }
                                 else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 20;
                              }
                           }
                        }

                        if( GroupBox4->Visible && DiagInfoType == 1 && DiagKonc->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagKonc->Port == kn+1 )
                        {
                           ShowDiagKoncInfo(1, packet[5], packet[6], packet[7] );
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                              {
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && On[i] && !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 11; 

                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                              }
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                        }
                        else
                        {
                           if( Dk )
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                              }
      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                           }
                        }
                     }
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                  }
      // Разрыв БО
                  else if( packet[4] == 0x41 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 6 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     bool TIn[MaxInCnt] = {false, false, false, false}; 
                     if( (packet[5]&0x01) == 0x01 ) TIn[0] = true;
                     if( (packet[5]&0x02) == 0x02 ) TIn[1] = true;
                     if( (packet[5]&0x04) == 0x04 ) TIn[2] = true;
                     if( (packet[5]&0x08) == 0x08 ) TIn[3] = true;

                     bool DkIn = false; 
                     if( (packet[5]&0x10) == 0x10 ) DkIn = true;

                     bool VIn = false;  
                     if( (packet[5]&0x20) == 0x20 ) VIn = true;

                     int DK_variant = 1; 
                     if( (packet[5]&0x40) == 0x40 ) DK_variant = 2;

                     int Conf_variant = 0;   
                     if( (packet[5]&0x80) == 0x80 ) Conf_variant = 1;

                     bool DK = false; 
                     if( (packet[7]&0x40) == 0x40 ) DK = true;

                     if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk && DK )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = true;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                        for( int i = 0; i < MaxInCnt; i++ )
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                     }

                     if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk && Conf_variant != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Conf_variant &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Conf_variant != -1 )
                     {
                           for( int i = 0; i < MaxInCnt; i++ )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                              {
                                    if( Conf_variant == 1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 6;
                                    else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 7;
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[i] )

                                    {
                                       SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[i]]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[i]]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[i]]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[i]]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[i]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                                    }
                              }
                           }
                     }
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Conf_variant = Conf_variant;

                     bool TOut[MaxInCnt] = {false, false, false, false}; 
                     if( (packet[6]&0x01) == 0x01 ) TOut[0] = true;
                     if( (packet[6]&0x02) == 0x02 ) TOut[1] = true;
                     if( (packet[6]&0x04) == 0x04 ) TOut[2] = true;
                     if( (packet[6]&0x08) == 0x08 ) TOut[3] = true;

                     bool N[MaxInCnt] = {false, false, false, false}; 
                     if( (packet[6]&0x10) == 0x10 ) N[0] = true;
                     if( (packet[6]&0x20) == 0x20 ) N[1] = true;
                     if( (packet[6]&0x40) == 0x40 ) N[2] = true;
                     if( (packet[6]&0x80) == 0x80 ) N[3] = true;

                     bool TsV[MaxInCnt] = {false, false, false, false}; 
                     if( (packet[7]&0x01) == 0x01 ) TsV[0] = true;
                     if( (packet[7]&0x02) == 0x02 ) TsV[1] = true;
                     if( (packet[7]&0x04) == 0x04 ) TsV[2] = true;
                     if( (packet[7]&0x08) == 0x08 ) TsV[3] = true;

                     bool Ts = false;  
                     if( (packet[7]&0x10) == 0x10 ) Ts = true;

                     bool T = false;  
                     if( (packet[7]&0x20) == 0x20 ) T = true;

                     bool V = false;  
                     if( (packet[7]&0x80) == 0x80 ) V = true;

                     if( GroupBox4->Visible && DiagInfoType == 1 && DiagKonc->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagKonc->Port == kn+1 )
                     {
                        ShowDiagKoncInfo2(1, packet[5], packet[6], packet[7] );
                     }

                     if( T )
                     {
                        if( V ) 
                        {
                           for( int i = 0; i < MaxInCnt; i++ )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21;
                           }
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else
                        {
                           if( Ts && !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )  
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                              {
                                 if( TsV[i] )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 20; 
                              }

      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                           }
                           else if( Ts && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )  
                           {
                              for( int i = 0; i < MaxInCnt; i++ )
                              {
                                 if( TsV[i] )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = true;
                              }

      //                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                           }
                        }
                     }
                     else
                     {
                        for( int i = 0; i < MaxInCnt; i++ )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                           {
                              if( VIn ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21;
                              else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 1;
                           }
                        }
                     }

                     bool fuck_flag = false;
                     for( int i = 0; i < MaxInCnt; i++ )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] && N[i] )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 23; 
                           fuck_flag = true;
                        }
                     }

                     if( fuck_flag ) RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk && !DK )
                     {
                           for( int i = 0; i < MaxInCnt; i++ )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 3; 
                              }
                              else
                              {
                                 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 11; 
                              }
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                           }

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk  = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
      //                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                        }
                  }
                  else if( packet[4] == 0x41 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                      if( (packet[5]&0x01) == 0x01 ) Tin_IpBl[0] = true;
                      if( (packet[5]&0x02) == 0x02 ) Tin_IpBl[1] = true;
                      if( (packet[5]&0x04) == 0x04 ) Tin_IpBl[2] = true;
                      if( (packet[5]&0x08) == 0x08 ) Tin_IpBl[3] = true;
                      if( (packet[5]&0x10) == 0x10 ) Tin_IpBl[4] = true;
                      if( (packet[5]&0x20) == 0x20 ) Tin_IpBl[5] = true;
                      if( (packet[5]&0x40) == 0x40 ) Tin_IpBl[6] = true;
                      if( (packet[5]&0x80) == 0x80 ) Tin_IpBl[7] = true;

                      bool Iu[MaxIpBlIuCnt] = {false, false, false, false};
                      if( (packet[6]&0x01) == 0x01 ) Iu[0] = true;
                      if( (packet[6]&0x02) == 0x02 ) Iu[1] = true;
                      if( (packet[6]&0x04) == 0x04 ) Iu[2] = true;
                      if( (packet[6]&0x08) == 0x08 ) Iu[3] = true;

                      bool Dk = false;
                      if( (packet[6]&0x40) == 0x40 ) Dk = true;

                      bool DkOut = false;
                      if( (packet[6]&0x80) == 0x80 ) DkOut = true;

                      bool Ts[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                      if( (packet[7]&0x01) == 0x01 ) Ts[0] = true;
                      if( (packet[7]&0x02) == 0x02 ) Ts[1] = true;
                      if( (packet[7]&0x04) == 0x04 ) Ts[2] = true;
                      if( (packet[7]&0x08) == 0x08 ) Ts[3] = true;
                      if( (packet[7]&0x10) == 0x10 ) Ts[4] = true;
                      if( (packet[7]&0x20) == 0x20 ) Ts[5] = true;
                      if( (packet[7]&0x40) == 0x40 ) Ts[6] = true;
                      if( (packet[7]&0x80) == 0x80 ) Ts[7] = true;

                      bool On[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                      if( (packet[8]&0x01) == 0x01 ) On[0] = true;
                      if( (packet[8]&0x02) == 0x02 ) On[1] = true;
                      if( (packet[8]&0x04) == 0x04 ) On[2] = true;
                      if( (packet[8]&0x08) == 0x08 ) On[3] = true;
                      if( (packet[8]&0x10) == 0x10 ) On[4] = true;
                      if( (packet[8]&0x20) == 0x20 ) On[5] = true;
                      if( (packet[8]&0x40) == 0x40 ) On[6] = true;
                      if( (packet[8]&0x80) == 0x80 ) On[7] = true;

                      for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                      {
                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[sd] )
                         {
                            if( !On[sd] )  
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 100;
                            }
                            else
                            {
                               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] == 100 ) 
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 101; 
                               else 
                               {
                                  if( Ts[sd] ) 
                                  {
                                     if( Dk ) 
                                     {
                                        if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Bazalt[sd] )
                                        {
                                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 3;
                                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[sd] = true;

                                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt == 0 )
                                           {
                                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 3;
                                           }
                                        }
                                     }
                                     else
                                     {
                                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 20; 

                                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 3;
                                     }
                                  }
                                  else  
                                  {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 1;
                                  }
                               }
                            }
                         }
                      }

                      for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
                      {
                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[iu+MaxIpBlSdCnt] )
                         {
                            if( Iu[iu] ) 
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] = 101;

                               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AutoOff[iu+MaxIpBlSdCnt] > 0 )
                               {
                                  if( Now() > RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OffDt[iu+MaxIpBlSdCnt] )
                                  {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[iu+MaxIpBlSdCnt] = 100;
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x23;
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 3;
                                  }
                               }
                            }
                            else  
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] = 100;
                            }
                         }
                      }

                      if( GroupBox10->Visible &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                         (POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType ||
                          POprosObj(ObjTree->Selected->Data)->Type == IuIpBlType))
                            ShowDiagIpBlInfo(packet);

                       if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                           POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType )
                       {
                          int f = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OnOffCnt[POprosObj(ObjTree->Selected->Data)->Num2-1];
                          if( f > 0 )
                          {
                             GroupBox5->Visible = true;
                             f = RifBazaltCnt[kn] - f;
                             CGauge1->Progress = f;
                          }
                          else
                          {
                             GroupBox5->Visible = false;
                             CGauge1->Progress = 0;
                          }
                       }
                  }
                  else if( packet[4] == 0x33 && packet[3] == 5 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 3 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     int pult = packet[9] & 1;

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Pult == 0 && pult == 1 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 30; 

                        SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Pult == 1 && pult == 0 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 31; 

                        SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Pult = pult;

                     {
                        int porogi1 = packet[5] & 0x0F;
                        int rezhim1 = (packet[5] & 0x30)>>4;

                        if( rezhim1 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 != -1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 

                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                           {
                              POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                              SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                           }
                        }

                        if( porogi1 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 != -1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                           {
                              POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                              SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                           }
                        }

                        int porogi2 = packet[6] & 0x0F;
                        int rezhim2 = (packet[6] & 0x30)>>4;

                        if( rezhim2 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim2 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim2 != -1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 

                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                           {
                              POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                              SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                           }
                        }

                        if( porogi2 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 != -1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 30 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 22; 
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                           {
                              POprosOutObj(lpMapOpros)->RifRk[kn][(RifSys->OprosAdr[kn][RifIdx[kn]]-1)*MaxInCnt] = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0];
                              SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                           }
                        }

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 = porogi1;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 = rezhim1;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 = porogi2;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim2 = rezhim2;

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost1 = packet[7]&0x00FF;
                        double U = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru1( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost1 );
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost2 = packet[8]&0x00FF;
                        double U2 = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru1( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost2 );

                        bool Dk = false;  
                        bool T = false;   
                        bool Ts = false;  
                        bool Ts1 = false; 
                        bool Ts2 = false; 
                        int S = 0;   
                        bool St = false;  

                        if( (packet[9]&0x02) == 0x02 ) Ts = true;
                        if( (packet[9]&0x08) == 0x08 ) T = true;
                        if( (packet[9]&0x20) == 0x20 ) Dk = true;
                        if( (packet[9]&0x80) == 0x80 ) S = 1;
                        if( (packet[9]&0x40) == 0x40 ) Ts1 = true;
                        if( (packet[9]&0x10) == 0x10 ) Ts2 = true;
                        if( (packet[9]&0x04) == 0x04 ) St = true;

                        if( GroupBox4->Visible && DiagInfoType == 0 && DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagRif->Port == kn+1 )
                        {
                           ShowDiagRifInfo(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0], packet[9], U, U2, packet[5], packet[6] );
                        }

                        if( S==0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S==1 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 16; 
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                              SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                        if( S==1 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S==0 )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                              SetSob( 142,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                   POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].S = S;

                        if( T )
                        {
                           if( Ts && Dk && Ts2 )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 == 0 && Ts1 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                              }
                              else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 == 1 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                              }
                           }
                           else if( Ts && !Dk )
                           {
                              if( Ts1 && Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20;                               else if( Ts1 && !Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                              else if( !Ts1 && Ts2 )RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 24; 
                           }
                           else if( !Dk && !Ts )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 12; 

                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                                 SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              }
                           }

                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else
                        {
                           if( !pult && !St  )
                           {
      //                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] != 12 )
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;  
                           }
                           else if( !pult && St  ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20;   
                           else if( pult ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 30;   
                        }

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                        }
                     }
                  }
                  else if( packet[4] == 0x33 && packet[3] == 7 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 5 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                        int porogi3 = packet[5] & 0x0F;
                        int porogi2 = (packet[5] & 0xF0)>>4;
                        int porogi1 = packet[6] & 0x0F;
                        int rezhim = (packet[6] & 0xF0)>>4;

                        if( porogi1 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 != -1 )
                        {
                           if( (porogi1 == 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 != 9) ||
                               (porogi1 != 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 == 9) )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                              {
                                 int temp = 0;
                                 if(porogi1 == 9 ) temp = 170;
                                 else temp = 171;

                                 SetSob( temp,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              }
                           }
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 = porogi1;

                        if( porogi2 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 != -1 )
                        {
                           if( (porogi2 == 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 != 9) ||
                               (porogi2 != 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 == 9) )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                              {
                                 int temp = 0;
                                 if(porogi2 == 9 ) temp = 172;
                                 else temp = 173;

                                 SetSob( temp,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              }
                           }
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 = porogi2;

                        if( porogi3 != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 != -1 )
                        {
                           if( (porogi3 == 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 != 9) ||
                               (porogi3 != 9 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 == 9) )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                              {
                                 int temp = 0;
                                 if(porogi3 == 9 ) temp = 174;
                                 else temp = 175;

                                 SetSob( temp,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                         POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              }
                           }
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 = porogi3;

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim = rezhim;

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost1 = packet[7]&0x00FF;
                        double U3 = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru1( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost1 );

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost2 = packet[8]&0x00FF;
                        double U2 = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru1( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost2 );

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost3 = packet[9]&0x00FF;
                        double U = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uaru1( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Skvazhnost3 );

                        bool Dk = false;  
                        bool T = false;   
                        bool Ts = false;  
                        bool Ts1 = false; 
                        bool Ts2 = false; 
                        bool Ts3 = false; 

                        if( (packet[10]&0x02) == 0x02 ) Ts = true;
                        if( (packet[10]&0x08) == 0x08 ) T = true;
                        if( (packet[10]&0x10) == 0x10 ) Ts2 = true;
                        if( (packet[10]&0x20) == 0x20 ) Dk = true;
                        if( (packet[10]&0x40) == 0x40 ) Ts3 = true;
                        if( (packet[10]&0x80) == 0x80 ) Ts1 = true;


                        if( GroupBox4->Visible && DiagInfoType == 0 && DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagRif->Port == kn+1 )
                        {
                           ShowDiagRifInfo2(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0], packet[10], U, U2, U3, packet[5], packet[6], packet[11] );
                        }

                        if( Dk )
                        {
                           if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = true;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 6400/(RifSys->OprosCnt[kn]*50);
                           }

                           if( porogi1 == 9 && porogi2 == 9 && porogi3 == 9 )
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1; 
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                              SetSob( 160,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                      POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                           }
                           else
                           {
                              if( porogi1 == 9 ) Ts1 = true;
                              if( porogi2 == 9 ) Ts2 = true;
                              if( porogi3 == 9 ) Ts3 = true;

                              if( Ts && Ts2 && Ts3 && Ts1 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 

                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                                 else
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                        }
                        else
                        {
                           if( T )
                           {
                               if( Ts1 && !Ts2 && !Ts3 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                               else if( !Ts1 && Ts2 && !Ts3 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 24;
                               else if( !Ts1 && !Ts2 && Ts3 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 27; 
                               else
                               {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                               }

      //                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                               RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                           }
                           else
                           {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;   
                           }
                        }
      /*
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                              else
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
      //                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
      //                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

      //                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
      //                        }
      //                     }
                  }
                  else if( packet[4] == 0x32 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 7 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     bool St1 = false;    
                     bool Ts1 = false;    
                     bool St2 = false;    
                     bool Ts2 = false;    
                     bool St3 = false;    
                     bool Ts3 = false;    
                     bool St4 = false;    
                     bool Ts4 = false;    
                     bool Sdk = false;    
                     bool Dk = false;     
                     bool Sv = false;     
                     bool Tv = false;     

                     bool Nchae1 = false; 
                     bool Nchae2 = false; 
                     bool Nchae3 = false; 
                     bool Nchae4 = false; 

                     bool T1 = false; 
                     bool T2 = false; 
                     bool T3 = false; 
                     bool T4 = false; 

                     if( (packet[5]&0x01) == 0x01 ) St1 = true;
                     if( (packet[5]&0x02) == 0x02 ) Ts1 = true;
                     if( (packet[5]&0x04) == 0x04 ) St2 = true;
                     if( (packet[5]&0x08) == 0x08 ) Ts2 = true;
                     if( (packet[5]&0x10) == 0x10 ) Sdk = true;
                     if( (packet[5]&0x20) == 0x20 ) Dk = true;
                     if( (packet[5]&0x40) == 0x40 ) { Sv = true; VS = true; }
                     if( (packet[5]&0x80) == 0x80 ) Tv = true;

                     if( (packet[6]&0x01) == 0x01 ) Nchae1 = true;
                     if( (packet[6]&0x02) == 0x02 ) Nchae2 = true;
                     if( (packet[6]&0x04) == 0x04 ) Nchae3 = true;
                     if( (packet[6]&0x08) == 0x08 ) Nchae4 = true;
                     if( (packet[6]&0x10) == 0x10 ) St3 = true;
                     if( (packet[6]&0x20) == 0x20 ) Ts3 = true;
                     if( (packet[6]&0x40) == 0x40 ) St4 = true;
                     if( (packet[6]&0x80) == 0x80 ) Ts4 = true;

                     if( (packet[7]&0x01) == 0x01 ) T1 = true;
                     if( (packet[7]&0x02) == 0x02 ) T2 = true;
                     if( (packet[7]&0x04) == 0x04 ) T3 = true;
                     if( (packet[7]&0x08) == 0x08 ) T4 = true;

//                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tempKoef = packet[32]&0xFF;

                     if( GroupBox10->Visible && DiagInfoType == 1 && DiagKonc->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagKonc->Port == kn+1 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tochka_cmd = 0x2a;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = RifTimerInterval[kn]*TochkaMux;
//                        ((TTimer*)Sender)->Interval = RifTimerInterval[kn]*TochkaMux;
                        ShowDiagTochkaInfoNew(packet, RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tF, POprosObj(ObjTree->Selected->Data)->Num2);
                        ShowTochkaSettings2(POprosObj(ObjTree->Selected->Data)->Num2);
                     }
                     else
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tochka_cmd = 0x2e;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = 0;
//                        ((TTimer*)Sender)->Interval = RifTimerInterval[kn];
                     }

                     if( Tv || Sv ) /* ТРЕВОГА - ВСКРЫТИЕ */
                     {
                        for( int i = 0; i < 4; i++ )
                        {
                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21; 
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                     }
                     else
                     {
                        if( Dk ) /* Если ДК */
                        {
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[0] )
                            {
                                if( Ts1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[1] )
                            {
                                if( Ts2 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 11; 
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[2] )
                            {
                                if( Ts3 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 11;
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[3] )
                            {
                                if( Ts4 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 11; 
                            }

                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else 
                        {
                           if( T1 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[0] )
                           {
                              if( Ts1 && Ts2 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts1 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else if( T2 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[1] )
                           {
                              if( Ts1 && Ts2 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts2 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else
                           {
                              if( Ts1 && Ts2 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts1 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[1] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( Ts2 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[0] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( !Ts1 && !Ts2 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 1; 
                                 }
                              }
                           }

                           if( T3 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[2] ) 
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts3 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else if( T4 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[3] )
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts4 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts3 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[3] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( Ts4 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[2] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( !Ts3 && !Ts4 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 1; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 1; 
                                 }
                              }
                           }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 1 )
                            {
                               if( Nchae1 ) 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 18;
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] == 1 )
                            {
                               if( Nchae2 ) 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 18;
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] == 1 )
                            {
                               if( Nchae3 ) 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 18;
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] == 1 )
                            {
                               if( Nchae4 )
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 18;
                            }
                        }
                     }

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                     {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              for( int i = 0; i < 4; i++ )
                              {
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 11; 
                                 }
                              }
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                           }
                     }
                  }
                  else if( packet[4] == 0x33 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 7 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     bool St1 = false;    
                     bool Ts1 = false;    
                     bool St2 = false;    
                     bool Ts2 = false;    
                     bool St3 = false;    
                     bool Ts3 = false;    
                     bool St4 = false;    
                     bool Ts4 = false;    
                     bool Sdk = false;    
                     bool Dk = false;     
                     bool Sv = false;     
                     bool Tv = false;     

                     bool Nchae1 = false; 
                     bool Nchae2 = false; 
                     bool Nchae3 = false; 
                     bool Nchae4 = false; 

                     bool T1 = false; 
                     bool T2 = false; 
                     bool T3 = false; 
                     bool T4 = false; 

                     if( (packet[5]&0x01) == 0x01 ) St1 = true;
                     if( (packet[5]&0x02) == 0x02 ) Ts1 = true;
                     if( (packet[5]&0x04) == 0x04 ) St2 = true;
                     if( (packet[5]&0x08) == 0x08 ) Ts2 = true;
                     if( (packet[5]&0x10) == 0x10 ) Sdk = true;
                     if( (packet[5]&0x20) == 0x20 ) Dk = true;
                     if( (packet[5]&0x40) == 0x40 ) { Sv = true; VS = true; }
                     if( (packet[5]&0x80) == 0x80 ) Tv = true;

                     if( (packet[6]&0x01) == 0x01 ) Nchae1 = true;
                     if( (packet[6]&0x02) == 0x02 ) Nchae2 = true;
                     if( (packet[6]&0x04) == 0x04 ) Nchae3 = true;
                     if( (packet[6]&0x08) == 0x08 ) Nchae4 = true;
                     if( (packet[6]&0x10) == 0x10 ) St3 = true;
                     if( (packet[6]&0x20) == 0x20 ) Ts3 = true;
                     if( (packet[6]&0x40) == 0x40 ) St4 = true;
                     if( (packet[6]&0x80) == 0x80 ) Ts4 = true;

                     if( (packet[7]&0x01) == 0x01 ) T1 = true;
                     if( (packet[7]&0x02) == 0x02 ) T2 = true;
                     if( (packet[7]&0x04) == 0x04 ) T3 = true;
                     if( (packet[7]&0x08) == 0x08 ) T4 = true;

                     if( GroupBox10->Visible && DiagInfoType == 1 && DiagKonc->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagKonc->Port == kn+1 )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tochka_cmd = 0x2a;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = RifTimerInterval[kn]*TochkaMux;
//                        ((TTimer*)Sender)->Interval = RifTimerInterval[kn]*TochkaMux;
                     }
                     else
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tochka_cmd = 0x2e;
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = 0;
//                        ((TTimer*)Sender)->Interval = RifTimerInterval[kn];
                     }

                     if( Tv || Sv ) /* ТРЕВОГА - ВСКРЫТИЕ */
                     {
                        for( int i = 0; i < 4; i++ )
                        {
                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 21; 

                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] = 0;
                        }
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                     }
                     else
                     {
                        if( Dk )
                        {
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[0] )
                            {
                                if( Ts1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11; 
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[1] )
                            {
                                if( Ts2 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 11; 
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[2] )
                            {
                                if( Ts3 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 11; 
                            }

                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[3] )
                            {
                                if( Ts4 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 3; 
                                else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 11; 
                            }

                            for( int i = 0; i < 4; i++ ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] = 0;

                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        }
                        else
                        {
                           if( T1 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[0] ) 
                           {
                              if( Ts1 && Ts2 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts1 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else if( T2 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[1] )
                           {
                              if( Ts1 && Ts2 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts2 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else
                           {
                              if( Ts1 && Ts2 )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts1 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[1] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( Ts2 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[0] ) 
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[0] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[1] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( !Ts1 && !Ts2 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 1;
                                 }
                              }
                           }

                           if( T3 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[2]) 
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 23;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts3 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else if( T4 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[3] )
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 23; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts4 ) 
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = TochkaDirectionInterval*700/RifTimerInterval[kn];
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                 }
                              }
                           }
                           else
                           {
                              if( Ts3 && Ts4 ) 
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                              }
                              else
                              {
                                 if( Ts3 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[3] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( Ts4 )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] > 0 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Direction[2] )  
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 23; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[2] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                    else
                                    {
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 20; 
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[3] = 0;
                                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                                    }
                                 }

                                 if( !Ts3 && !Ts4 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 1; 
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 1; 
                                 }
                              }
                           }

                             if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 1 )
                             {
                                if( Nchae1 ) 
                                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 18;
                             }

                             if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] == 1 )
                             {
                                if( Nchae2 ) 
                                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[1] = 18;
                             }

                             if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] == 1 )
                             {
                                if( Nchae3 ) 
                                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[2] = 18;
                             }

                             if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] == 1 )
                             {
                                if( Nchae4 ) 
                                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[3] = 18;
                             }
                        }
                     }
                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                     {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                           else
                           {
                              for( int i = 0; i < 4; i++ )
                              {
                                 if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 11; 
                                 }
                              }
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                           }
                     }
                  }
                  else if( packet[1] == 0xFE && (packet[4] == 0x32 ||  packet[4] == 0x31) && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx && (packet[3] == 54 || packet[3] == 61) )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;
                     bool St[MaxTochkaMUchCnt] = {false, false, false, false};    
                     bool T[MaxTochkaMUchCnt] = {false, false, false, false};     
                     bool Sdk = false;    
                     bool Dk = false;     
                     bool Sv = false;     
                     bool Tv = false;     
                     bool Bod_Ok = false; 

                     if( (packet[5]&0x01) == 0x01 ) { St[0] = true; /*VS = true; /*Tin_IpBl[0] = true;*/ }
                     if( (packet[5]&0x02) == 0x02 ) { St[1] = true; /*VS = true; /*Tin_IpBl[1] = true;*/ }
                     if( (packet[5]&0x04) == 0x04 ) { St[2] = true; /*VS = true; /*Tin_IpBl[2] = true;*/ }
                     if( (packet[5]&0x08) == 0x08 ) { St[3] = true; /*VS = true; /*Tin_IpBl[3] = true;*/ }
                     if( (packet[5]&0x10) == 0x10 ) T[0] = true;
                     if( (packet[5]&0x20) == 0x20 ) T[1] = true;
                     if( (packet[5]&0x40) == 0x40 ) T[2] = true;
                     if( (packet[5]&0x80) == 0x80 ) T[3] = true;

                     if( (packet[6]&0x01) == 0x01 ) Bod_Ok = true;
                     if( (packet[6]&0x10) == 0x10 ) Sdk = true;
                     if( (packet[6]&0x20) == 0x20 ) Dk = true;
                     if( (packet[6]&0x40) == 0x40 ) {Sv = true; VS = true; }
                     if( (packet[6]&0x80) == 0x80 ) Tv = true;

                     for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Use )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T1[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T2[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N1[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N2[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Ss[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].S[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Sv[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].V[0] = false;
                        }
                     }

                     if( Bod_Ok )
                     {
                         int uch_flag[MaxTochkaMUchCnt] = { 1, 1, 1, 1 };
                         int sbros_flag[MaxTochkaMUchCnt] = { 0, 0, 0, 0 };

                         for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
                         {
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Use )
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 1;
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE2[0] = 1;

                               if( (packet[7+dd]&0x01) == 0x01 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 20;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 20;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd]&0x02) == 0x02 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T2[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE2[0] = 20;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 20;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd]&0x04) == 0x04 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 12;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 12;
                               }

                               if( (packet[7+dd]&0x08) == 0x08 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N2[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE2[0] = 12;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 12;
                               }

                               if( (packet[7+dd]&0x10) == 0x10 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Ss[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                               }

                               if( (packet[7+dd]&0x20) == 0x20 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].S[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd]&0x40) == 0x40 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Sv[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 21;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 21;
                               }

                               if( (packet[7+dd]&0x80) == 0x80 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].V[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 21;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 21;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }
                            }
                         }

                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].StatusBO[0] = 1;
                         for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uch[uch].StatusUch[0] = uch_flag[uch];
                            if( uch_flag[uch] != 1 )
                            {
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].StatusBO[0] = uch_flag[uch];
                            }
                         }

                         if( Tv || Sv ) 
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 21; /

                            uch_flag[0] = 21;
                            sbros_flag[0] = 1;
                         }
                         else
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;
                         }

                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                         {
                            VS = false; Tin_IpBl[0] = false; Tin_IpBl[1] = false; Tin_IpBl[2] = false; Tin_IpBl[3] = false;

                            if( Dk && T[0] && T[1] && T[2] && T[3]  ) 
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3;

                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                               uch_flag[0] = 20;
                               sbros_flag[0] = 1;
                            }
                            else
                            {
                               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                               else 
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11;

                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                               }
                            }
                         }
                         else
                         {
                            if( T[0] || T[1] || T[2] || T[3] ) { uch_flag[0] = 20; sbros_flag[0] = 1; }
                         }

                         for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
                         {
                            if( sbros_flag[uch] == 1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                         }
                     }

                     if( GroupBox10->Visible &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                         (POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx || POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx) )
                     {
                        ShowDiagTochkaMInfo( kn, POprosObj(ObjTree->Selected->Data)->Num1-1, packet );
                     }

                     if( GroupBox10->Visible &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                         POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx /*&& packet[4] == 0x31 && packet[3] == 61*/ )
                     {
                        int adress = POprosObj(ObjTree->Selected->Data)->Num1;
                        int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100+1;
                        int flang = POprosObj(ObjTree->Selected->Data)->Num2/100-1;
                        if( flang > 1 ) ddnum = ddnum + 0x80;
                        if( ShowDiagTochkaMInfo2(POprosObj(ObjTree->Selected->Data)->Type, POprosObj(ObjTree->Selected->Data)->Num2, POprosObj(ObjTree->Selected->Data)->Num3, packet, adress, ddnum) )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x2F;
                     }
                     else
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x24 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                     }
                  }
                  else if( packet[1] == 0xFE && (packet[4] == 0x32 || packet[4] ==0x31) && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx && (packet[3] == 102 || packet[3] == 106) )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     bool St[MaxTochkaMUchCnt] = {false, false, false, false};   
                     bool T[MaxTochkaMUchCnt] = {false, false, false, false};     
                     bool Sdk = false;   
                     bool Dk = false;    
                     bool Sv = false;    
                     bool Tv = false;    
                     bool Bod_Ok = false;

                     if( (packet[5]&0x01) == 0x01 ) St[0] = true;
                     if( (packet[5]&0x02) == 0x02 ) St[1] = true;
                     if( (packet[5]&0x04) == 0x04 ) St[2] = true;
                     if( (packet[5]&0x08) == 0x08 ) St[3] = true;
                     if( (packet[5]&0x10) == 0x10 ) T[0] = true;
                     if( (packet[5]&0x20) == 0x20 ) T[1] = true;
                     if( (packet[5]&0x40) == 0x40 ) T[2] = true;
                     if( (packet[5]&0x80) == 0x80 ) T[3] = true;

                     if( (packet[6]&0x01) == 0x01 ) Bod_Ok = true;
                     if( (packet[6]&0x10) == 0x10 ) Sdk = true;
                     if( (packet[6]&0x20) == 0x20 ) Dk = true;
                     if( (packet[6]&0x40) == 0x40 ) {Sv = true; VS = true; }
                     if( (packet[6]&0x80) == 0x80 ) Tv = true;

                     for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Use )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T1[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T2[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N1[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N2[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Ss[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].S[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Sv[0] = false;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].V[0] = false;
                        }
                     }

                     if( Bod_Ok )
                     {
                         int uch_flag[MaxTochkaMUchCnt] = { 1, 1, 1, 1 };
                         int sbros_flag[MaxTochkaMUchCnt] = { 0, 0, 0, 0 };

                         int dd_n = 0;
                         for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
                         {
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Use )
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 1;

                               if( (packet[7+dd_n]&0x01) == 0x01 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 20;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 20;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd_n]&0x02) == 0x02 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Ss[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                               }

                               if( (packet[7+dd_n]&0x04) == 0x04 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].S[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd_n]&0x08) == 0x08 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 12;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 12;
                               }
                            }

                            dd += 1;
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Use )
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 1;

                               if( (packet[7+dd_n]&0x10) == 0x10 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].T1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 20;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 20;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }

                               if( (packet[7+dd_n]&0x20) == 0x20 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].Ss[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                               }

                               if( (packet[7+dd_n]&0x40) == 0x40 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].S[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 10;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 10;
                                  sbros_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 1;
                               }
                               if( (packet[7+dd_n]&0x80) == 0x80 )
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].N1[0] = true;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].StatusChE1[0] = 12;
                                  uch_flag[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dd[dd].FlangNum-1] = 12;
                               }
                            }
                            dd_n += 1;
                         }

                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].StatusBO[0] = 1;
                         for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Uch[uch].StatusUch[0] = uch_flag[uch];
                            if( uch_flag[uch] != 1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].StatusBO[0] = uch_flag[uch];
                         }

                         if( Tv || Sv ) 
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 21; 

                            uch_flag[0] = 21;
                            sbros_flag[0] = 1;
                         }
                         else
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1; 
                         }

                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                         {
                            VS = false; Tin_IpBl[0] = false; Tin_IpBl[1] = false; Tin_IpBl[2] = false; Tin_IpBl[3] = false;

                            if( Dk && T[0] && T[1] && T[2] && T[3]  ) 
                            {
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 3;

                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                               uch_flag[0] = 20;
                               sbros_flag[0] = 1;
                            }
                            else
                            {
                               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 0 )
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                               else 
                               {
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 11;

                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                               }
                            }
                         }
                         else
                         {
                            if( T[0] || T[1] || T[2] || T[3] ) { uch_flag[0] = 20; sbros_flag[0] = 1; }
                         }

                         for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
                         {
                            if( sbros_flag[uch] == 1 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                         }
                     }

                     if( GroupBox10->Visible &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                         (POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx || POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx) )
                     {
                        ShowDiagTochkaMInfo( kn, POprosObj(ObjTree->Selected->Data)->Num1-1, packet );
                     }

                     if( GroupBox10->Visible &&
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                         POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx /*&& packet[4] == 0x31 && packet[3] == 106*/ )
                     {
                        int adress = POprosObj(ObjTree->Selected->Data)->Num1;
                        int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100+1;
                        int flang = POprosObj(ObjTree->Selected->Data)->Num2/100-1;
                        if( flang > 1 ) ddnum = ddnum + 0x80;
                        if( ShowDiagTochkaMInfo2(POprosObj(ObjTree->Selected->Data)->Type, POprosObj(ObjTree->Selected->Data)->Num2, POprosObj(ObjTree->Selected->Data)->Num3, packet, adress, ddnum) )
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                        else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x2F;
                     }
                     else
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x24 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                     }
                  }
                  else if( packet[4] == 0x30 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                     
                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                     {
                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x23 )
                          {
                             for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
                                RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[iu+MaxIpBlSdCnt] = 0;
                          }

                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x20 )
                          {
                             for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                                RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[sd] = 0;
                          }

                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x21 )
                          {
                             for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                                RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[sd] = 0;
                          }

                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                     }
                     else
                     {
                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x20 )
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi = Porogi;
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != 5 )
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 = Porogi1;
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != 5 )
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 = Porogi2;
                            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != 5 )
                               RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 = Porogi3;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim = Rezhim;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Takt = Takt;
                         }

                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x2F )
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi1 = Porogi1;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi2 = Porogi2;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Porogi3 = Porogi3;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim1 = Rezhim;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Rezhim2 = 0;
                         }

                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x27 )
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 30;

                         if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd == 0x21 )
                         {
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = true;
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 6400/(RifSys->OprosCnt[kn]*50);
                         }

                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                     }
                  }
                  else
                  {
                     flag = -3;
                     goto err_l1;
                  }
               }
               else
               {
err_l1:           
                  if( (RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 ||
                       RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == RifRlmSType) &&
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 30 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;
                  }
                  else
                  {
                     /* 14.11.2017 ДСв попросил, чтобы если с датчиком нет связи, а к БЛ-IP подключена Сота, то сообщение нет связи не тормозило, а высвечивалась
                     через 20 сек, как кгда Соты нет */
                     int tcnt = RifMaxErrCnt[kn];

                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt <= tcnt/*RifMaxErrCnt[kn]/*MaxErrCnt*/ )
                     {
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt += 1;
//                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
//                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
//                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
//                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                     }
                     else
                     {
                        if( GroupBox4->Visible && DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] && DiagRif->Port == kn+1 )
                           ShowDiagRifInfo(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, 10, 0, 0.0, 0.0, 0, 0);

                        if( GroupBox10->Visible && (DiagRif->Adr == RifSys->OprosAdr[kn][RifIdx[kn]] || DiagKonc->Adr == RifSys->OprosAdr[kn][RifIdx[kn]]) && ( DiagRif->Port == kn+1 || DiagKonc->Port == kn+1) )
                        {
                           if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 7 ) /* Точка */
                              ShowDiagRifInfoNew(10, 10, 0, 0.0, 0.0, 0, 0);
                           else ShowDiagRifInfoNew(RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type, 10, 0, 0.0, 0.0, 0, 0);
                        }

                        if( GroupBox10->Visible &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == POprosObj(ObjTree->Selected->Data)->Type &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                        {
                           ShowDiagIpBlInfo(packet);
                        }

                        if( GroupBox10->Visible &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                            ((POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx) ||
                             (POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMUchIdx)) )
                        {
                           ResetTochkaMDiagInfo( TochkaMBoIdx, 0 );
                        }

                        if( GroupBox10->Visible &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                            ((POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx) ||
                             (POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMUchIdx)) )
                        {
                           ResetTochkaMDiagInfo( SotaMBoIdx, 0 );
                        }

                        if( GroupBox10->Visible &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                             POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMDdIdx )
                        {
                           int flangnum = PCfgObj(ObjTree->Selected->Data)->Num2/100;
                           int dvnum = (PCfgObj(ObjTree->Selected->Data)->Num2 - flangnum*100);
                           ResetTochkaMDiagInfo( TochkaMDdIdx, dvnum );
                        }

                        if( GroupBox10->Visible &&
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Port == POprosObj(ObjTree->Selected->Data)->Num3 &&
                             POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMDdIdx )
                        {
                           int flangnum = PCfgObj(ObjTree->Selected->Data)->Num2/100;
                           int dvnum = (PCfgObj(ObjTree->Selected->Data)->Num2 - flangnum*100);
                           ResetTochkaMDiagInfo( SotaMDdIdx, dvnum );
                        }

                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].ErrCnt = 0;

                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 ||
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == RifRlmSType ||
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 ||
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 3 ||
                            RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 5 )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 10; 
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                        }
                        else 
                        {
                           for( int i = 0; i < MaxInCnt; i++)
                           {
                              if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 10; 
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                                 if( i < 4 )
                                 {
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] = 0;
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].PauseCnt[i] = 0;
                                 }
                              }
                           }
                        }
                     }
                  }
               }

               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
               {
                   if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt > 0 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt -= 1;
                   else
                   {
                      if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x22 &&
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x21   )
                      {
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                         RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                      }
                   }

                   if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt > 1 )
                   {
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt -= 1;
                   }
                   else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt == 1 )
                   {
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 0;

                      for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                      {
                          if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] != 100 )
                             if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[sd] )
                                if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Bazalt[sd] )
                                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkUse[sd] )
                                    RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] = 11; 
                      }

                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x24;
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 3;
                   }

                   if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk )
                   {
                      for( int i = 0; i < MaxInCnt; i++ ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].KDk[i] = false;
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = false;
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x21;
                      RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 20000/(RifTimerInterval[kn]*RifSys->OprosCnt[kn]*ActiveOprosChannels);
                   }
               }

               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 11 &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != 1 &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != 7 &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SdIpBlType &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != TochkaMBoIdx &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SotaMBoIdx &&
                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AutoDkCnt == 0  )
               {
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 1;
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AutoDkCnt = 1;
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x21;
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
               }

               if( flag == 1 )
               {
                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                  {
                     if( packet[4] == 0x41 && packet[3] == 4 ) flag = 1;
                     else flag = -3;
                  }
                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 )
                  {
                     if( packet[4] == 0x31 && packet[3] == 3 ) flag = 1;
                     else flag = -3;
                  }
/*
                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 111 )
                  {
                     if( packet[4] == 0x31 && packet[3] == 4 ) flag = 1;
                     else flag = -3;
                  }
*/
                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 7 )
                  {
                     if( packet[4] == 0x33 && packet[3] == 3 ) flag = 1;
                     else if( packet[4] == 0x32 && packet[3] == 28 ) flag = 1;
                     else flag = -3;
                  }
               }

               if( RifIdx[kn] != -1 && packet[4] != 0x30 &&
                  (flag == 1 || RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] == 10 ) )
                     ShowNewRkStatus(flag, RifSys->OprosAdr[kn][RifIdx[kn]]-1, kn, VS, Tin_IpBl, packet );
               else if( RifIdx[kn] != -1 && packet[4] != 0x30 && flag != 1 && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != TochkaMBoIdx &&
                        RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SotaMBoIdx )
               {
                  for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                  {
                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] == 11 )  
                     {
                        ShowNewRkStatus(flag, RifSys->OprosAdr[kn][RifIdx[kn]]-1, kn, VS, Tin_IpBl, packet );
                        break;
                     }
                     else
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] != RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].StatusOld[sd] )
                        {
                           ShowNewRkStatus(flag, RifSys->OprosAdr[kn][RifIdx[kn]]-1, kn, VS, Tin_IpBl, packet );
                           break;
                        }
                     }
                  }
               }
            }

            if( RifIdx[kn] < (RifDevCnt-1) )
            {
               if( RifSys->OprosAdr[kn][RifIdx[kn]+1] != 0 ) RifIdx[kn] += 1;
               else
               {
                  RifIdx[kn] = 0;
               }
            }
            else RifIdx[kn] = 0;

            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd != 0x22 &&
                RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SdIpBlType )
            {
               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt < 4 ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt += 1;
               else
               {
                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 )
                  {
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0] = 13; 
                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].AlarmFix[0] )
                     {
                        SetSob( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[0],
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Type,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3,
                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                     }

                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                  }
                  else
                  {
                     for( int i = 0; i < MaxInCnt; i++ )
                     {
                        if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].InUse[i] )
                        {
                           RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[i] = 13; 
                        }
                     }
                  }
               }
            }
            else
            {
               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SdIpBlType )
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
            }

            switch( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd )
            {
               case 0x20: if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0) flag = RifSerial[kn].SetCfg( RifSys->OprosAdr[kn][RifIdx[kn]], Porogi, Rezhim, Takt, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2) flag = RifSerial[kn].SetCfg2( RifSys->OprosAdr[kn][RifIdx[kn]], Porogi1, Porogi2, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 5) flag = RifSerial[kn].SetCfg4( RifSys->OprosAdr[kn][RifIdx[kn]], Porogi1, Porogi2, Porogi3, Rezhim, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 1 ) flag = RifSerial[kn].SetCfg1( RifSys->OprosAdr[kn][RifIdx[kn]], RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].On, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                          {
                               flag = 0;
                               for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                               {
                                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[sd] != 100 )
                                  {
                                     flag += 1<<sd;
                                  }
                                  else
                                  {
                                     flag += 0<<sd;
                                  }
                               }

                               for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                               {
                                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[sd] == 101 )
                                  {
                                     flag = flag | 1<<sd;
                                  }
                                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[sd] == 100 )
                                  {
                                     flag = flag & ~(1<<sd);
                                  }
                               }
                               RifSerial[kn].SetSd( 0xFF, flag, false );
                          }
                          break;
               case 0x2F: if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 3) flag = RifSerial[kn].SetCfg3( RifSys->OprosAdr[kn][RifIdx[kn]], Porogi1, Porogi2, Rezhim, 0, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx || RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx )
                          {
                              int adress = POprosObj(ObjTree->Selected->Data)->Num1;
                              int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100+1;
                              int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100-1;
                              if( uchnum == 0 || uchnum == 1 ) uchnum = 0;
                              else if( uchnum == 2 || uchnum == 3 ) uchnum = 1;
                              uchnum = uchnum<<7;
                              ddnum = uchnum + ddnum;
                              flag = RifSerial[kn].SetCmd4( RifSys->OprosAdr[kn][RifIdx[kn]], 0x2F, ddnum, true );
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                          }
                          break;
               case 0x23: if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 3) flag = RifSerial[kn].SetPultOff( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                          {
                               AnsiString tna = "";

                               flag = 0;
                               for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
                               {
                                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 101 )
                                  {
                                     flag += 1<<iu;
                                  }
                                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 100 )
                                  {
                                     flag += 0<<iu;
                                  }
                               }

                               for( int iu = 0; iu < MaxIpBlIuCnt; iu++ )
                               {
                                  if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Key[iu] == 2 )
                                  {
                                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 100 )
                                     {
                                        flag = flag | 1<<iu;
                                     }
                                     else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 101 )
                                     {
                                        flag = flag & ~(1<<iu);
                                     }
                                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Key[iu] = 1;
                                  }
                                  else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Key[iu] == 1 )
                                  {
                                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 100 )
                                     {
                                        flag = flag | 1<<iu;
                                     }
                                     else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Status[iu+MaxIpBlSdCnt] == 101 )
                                     {
                                        flag = flag & ~(1<<iu);
                                     }
                                     RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Key[iu] = 0;
                                  }
                                  else
                                  {
                                     if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[iu+MaxIpBlSdCnt] == 101 )
                                     {
                                        flag = flag | 1<<iu;
                                        tna = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Name[iu+MaxIpBlSdCnt];
                                     }
                                     else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[iu+MaxIpBlSdCnt] == 100 )
                                     {
                                        flag = flag & ~(1<<iu);
                                        tna = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Name[iu+MaxIpBlSdCnt];
                                     }
                                  }
                               }

                               bool flfl = false;
                               int flopr = -1;
                               for( int rsi = 0; rsi < 5; rsi++ )
                               {
                                 if( !flfl )
                                 {
                                    flopr = RifSerial[kn].SetIu( 0xFF, flag, false );
                                    MyDelay(RifTimerInterval[kn]);
                                    flopr = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                    if( flopr == 1 )
                                       if( packet[4] == 0x30 ) flfl = true;
                                 }
                               }
/*
                               int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
                               int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
                               int num3 = POprosObj(ObjTree->Selected->Data)->Num3;
*/
                               int num1 = POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num1;
                               int num2 = POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num2;
                               int num3 = POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Num3;

                               if( !flfl )
                               {
//                                 AnsiString tna = POprosObj(ObjTree->Selected->Data)->Name;
                                 if( tna == "" ) tna = POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[0]]->Data)->Name;
                                 SetSob( 13, IuIpBlType, num1,num2,num3, tna,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
                               }
                               RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x22;
                               RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 0;
                          }
                          break;
               case 0x26: flag = RifSerial[kn].SetOn( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          break;
               case 0x25: flag = RifSerial[kn].SetOff( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          break;
               case 0x24: if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SdIpBlType &&
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != TochkaMBoIdx &&
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SotaMBoIdx )
                          {
                              flag = RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                              for( int rsi = 0; rsi < 5; rsi++ )
                              {
                                 flag = RifSerial[kn].ResetFlags( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                                 MyDelay(RifTimerInterval[kn]);
                                 flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                 if( flag == 1 )
                                    if( packet[4] == 0x30 ) break;
                              }
                          }
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx ||
                                   RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx )
                          {
                             for( int rsi = 0; rsi < 5; rsi++ )
                             {
                                flag = RifSerial[kn].ResetFlags1(RifSys->OprosAdr[kn][RifIdx[kn]], true);
                                MyDelay(300);
                                flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                if( flag == 1 )
                                   if( packet[4] == 0x30 ) break;
                             }
                          }
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                          {
                              for( int rsi = 0; rsi < 5; rsi++ )
                              {
                                 flag = RifSerial[kn].ResetFlags(0xFF, false);
                                 MyDelay(RifTimerInterval[kn]);
                                 flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                 if( flag == 1 )
                                    if( packet[4] == 0x30 ) break;
                              }
                          }

                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                          break;
               case 0x27: flag = RifSerial[kn].SetPultOn( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          break;
               case 0x21: if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SdIpBlType &&
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != TochkaMBoIdx &&
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type != SotaMBoIdx )
                          {
                              bool flfl = false;
                              for( int rsi = 0; rsi < 5; rsi++ )
                              {
                                 if( !flfl )
                                 {
                                    flag = RifSerial[kn].SetDk( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                                    MyDelay(RifTimerInterval[kn]);
                                    flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                    if( flag == 1 )
                                       if( packet[4] == 0x30 ) flfl = true;
                                 }
                              }

                              if( flfl )
                              {
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Dk = true;
                                 RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 6400/(RifSys->OprosCnt[kn]*50);
                              }
                              else
                              {
                                 for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd] > 0 )
                                    {
                                       SetSob( 13,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Type,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num1,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num2,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num3,
                                               POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                                    }
                                 }
                              }
                          }
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType )
                          {
                              bool flfl = false;
                              for( int rsi = 0; rsi < 5; rsi++ )
                              {
                                 if( !flfl )
                                 {
                                    flag = RifSerial[kn].SetDk(0xFF, false);
                                    MyDelay(RifTimerInterval[kn]);
                                    flag = RifSerial[kn].GetPaket( RifSys->OprosAdr[kn][RifIdx[kn]], packet );
                                    if( flag == 1 )
                                       if( packet[4] == 0x30 ) flfl = true;
                                 }
                              }

                              int tint = RifTimerInterval[kn];
                              tint = RifSys->OprosCnt[kn] * tint;
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 15000/tint;
//                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkCnt = 6400/(RifSys->OprosCnt[kn]*50);
                              if( flfl )
                              {
                                 for( int sd = 0; sd < MaxIpBlSdCnt; sd++ ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].hCmd[sd] = 0;
                              }
                              else
                              {
                                 for( int sd = 0; sd < MaxIpBlSdCnt; sd++ )
                                 {
                                    if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd] > 0 )
                                    {
                                       if( !RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Bazalt[sd] && RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DkUse[sd] )
                                          SetSob( 13,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Type,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num1,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num2,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Num3,
                                                POprosObj(ObjTree->Items->Item[RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].TreeIdx[sd]]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                                    }
                                 }
                              }
                          }
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd = 0x22;
                          break;
               default:   if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 0 ||
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 1 ||
                              RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == RifRlmSType ) flag = RifSerial[kn].SetStatus( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 2 ) flag = RifSerial[kn].SetStatus1( RifSys->OprosAdr[kn][RifIdx[kn]] , true);
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 3 ) flag = RifSerial[kn].SetStatus2( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 5 ) flag = RifSerial[kn].SetStatus2( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 6 ) flag = RifSerial[kn].SetStatus( RifSys->OprosAdr[kn][RifIdx[kn]], true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == 7 ) flag = RifSerial[kn].SetStatus3( RifSys->OprosAdr[kn][RifIdx[kn]], RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].tochka_cmd, true );
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SdIpBlType ) flag = RifSerial[kn].SetStatus(0xFF, false);
                          else if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx || RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx )
                          {
                              flag = RifSerial[kn].SetStatus5(RifSys->OprosAdr[kn][RifIdx[kn]], true);
                          }
                          RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].CmdCnt = 0;

                          RifSerial[kn].SendOk = flag;
                          break;
            }
            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == TochkaMBoIdx ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = 200;
            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Type == SotaMBoIdx ) RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval = 300;

/*
           AnsiString fn;
           fn = ExtractFilePath(Application->ExeName)+ IntToStr(kn) + ".log";
           AutoToFile( fn, flag, packet, RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].Cmd, false, RifSys->OprosAdr[kn][RifIdx[kn]]);
//*/
           for( int i = 0; i < 4; i++ )
            {
               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] > 0 )
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] -= 1;
               else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].DirectionCnt[i] = 0;

               if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].PauseCnt[i] > 0 )
                  RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].PauseCnt[i] -= 1;
               else RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].PauseCnt[i] = 0;
            }
         }

         if( RifSerial[kn].SendOk > 0 )
         {
            if( RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval == 0 ) ((TTimer*)Sender)->Interval = RifTimerInterval[kn];
            else ((TTimer*)Sender)->Interval = RifSys->Rk[kn][RifSys->OprosAdr[kn][RifIdx[kn]]-1].OprosInterval;
         }
         else ((TTimer*)Sender)->Interval = 1000;
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagIpBlInfo( int packet[1000] )
{
   if( packet[0] == -1 && packet[1] == -1 && packet[2] == -1 )
   {
          AdvStringGrid1->Cells[1][1]="?";
          AdvStringGrid1->Cells[1][2]="?";
          AdvStringGrid1->Cells[1][3]="?";
          AdvStringGrid1->Cells[1][4]="?";
          AdvStringGrid1->Cells[1][5]="?";
          AdvStringGrid1->Cells[1][6]="?";
          AdvStringGrid1->Cells[1][7]="?";
          AdvStringGrid1->Cells[1][8]="?";
          AdvStringGrid1->Cells[1][10]="?";
          AdvStringGrid1->Cells[1][11]="?";
          AdvStringGrid1->Cells[1][12]="?";
          AdvStringGrid1->Cells[1][13]="?";
          AdvStringGrid1->Cells[1][14]="?";

          AdvStringGrid1->Cells[2][1]="?";
          AdvStringGrid1->Cells[2][2]="?";
          AdvStringGrid1->Cells[2][3]="?";
          AdvStringGrid1->Cells[2][4]="?";
          AdvStringGrid1->Cells[2][5]="?";
          AdvStringGrid1->Cells[2][6]="?";
          AdvStringGrid1->Cells[2][7]="?";
          AdvStringGrid1->Cells[2][8]="?";
          AdvStringGrid1->Cells[2][10]="?";
   }
   else
   {
       if( packet[0] != 0xB5 && packet[1] != 0xFE && packet[2] != 0xFF )
       {
          /* Нет связи */
          AdvStringGrid1->Cells[1][1]="Нет связи!";
          AdvStringGrid1->Cells[1][2]="Нет связи!";
          AdvStringGrid1->Cells[1][3]="Нет связи!";
          AdvStringGrid1->Cells[1][4]="Нет связи!";
          AdvStringGrid1->Cells[1][5]="Нет связи!";
          AdvStringGrid1->Cells[1][6]="Нет связи!";
          AdvStringGrid1->Cells[1][7]="Нет связи!";
          AdvStringGrid1->Cells[1][8]="Нет связи!";
          AdvStringGrid1->Cells[1][10]="Нет связи!";
          AdvStringGrid1->Cells[1][11]="Нет связи!";
          AdvStringGrid1->Cells[1][12]="Нет связи!";
          AdvStringGrid1->Cells[1][13]="Нет связи!";
          AdvStringGrid1->Cells[1][14]="Нет связи!";

          AdvStringGrid1->Cells[2][1]="Нет связи!";
          AdvStringGrid1->Cells[2][2]="Нет связи!";
          AdvStringGrid1->Cells[2][3]="Нет связи!";
          AdvStringGrid1->Cells[2][4]="Нет связи!";
          AdvStringGrid1->Cells[2][5]="Нет связи!";
          AdvStringGrid1->Cells[2][6]="Нет связи!";
          AdvStringGrid1->Cells[2][7]="Нет связи!";
          AdvStringGrid1->Cells[2][8]="Нет связи!";
          AdvStringGrid1->Cells[2][10]="Нет связи!";
       }
       else
       {
          if( packet[3] == 4 && packet[4] == 0x41 )
          {
             if( (packet[5]&0x01) == 0x01 ) AdvStringGrid1->Cells[1][1] = "Тревога";
             else AdvStringGrid1->Cells[1][1] = "Норма";

             if( (packet[5]&0x02) == 0x02 ) AdvStringGrid1->Cells[1][2] = "Тревога";
             else AdvStringGrid1->Cells[1][2] = "Норма";

             if( (packet[5]&0x04) == 0x04 ) AdvStringGrid1->Cells[1][3] = "Тревога";
             else AdvStringGrid1->Cells[1][3] = "Норма";

             if( (packet[5]&0x08) == 0x08 ) AdvStringGrid1->Cells[1][4] = "Тревога";
             else AdvStringGrid1->Cells[1][4] = "Норма";

             if( (packet[5]&0x10) == 0x10 ) AdvStringGrid1->Cells[1][5] = "Тревога";
             else AdvStringGrid1->Cells[1][5] = "Норма";

             if( (packet[5]&0x20) == 0x20 ) AdvStringGrid1->Cells[1][6] = "Тревога";
             else AdvStringGrid1->Cells[1][6] = "Норма";

             if( (packet[5]&0x40) == 0x40 ) AdvStringGrid1->Cells[1][7] = "Тревога";
             else AdvStringGrid1->Cells[1][7] = "Норма";

             if( (packet[5]&0x80) == 0x80 ) AdvStringGrid1->Cells[1][8] = "Тревога";
             else AdvStringGrid1->Cells[1][8] = "Норма";

             if( (packet[6]&0x01) == 0x01 ) AdvStringGrid1->Cells[1][11]="Вкл";
             else AdvStringGrid1->Cells[1][11]="Выкл";

             if( (packet[6]&0x02) == 0x02 ) AdvStringGrid1->Cells[1][12]="Вкл";
             else AdvStringGrid1->Cells[1][12]="Выкл";

             if( (packet[6]&0x04) == 0x04 ) AdvStringGrid1->Cells[1][13]="Вкл";
             else AdvStringGrid1->Cells[1][13]="Выкл";

             if( (packet[6]&0x08) == 0x08 ) AdvStringGrid1->Cells[1][14]="Вкл";
             else AdvStringGrid1->Cells[1][14]="Выкл";

             if( (packet[6]&0x40) == 0x40 ) AdvStringGrid1->Cells[2][10] = "Было";
             else AdvStringGrid1->Cells[2][10] = "Нет";

             if( (packet[6]&0x80) == 0x80 ) AdvStringGrid1->Cells[1][10] = "Есть";
             else AdvStringGrid1->Cells[1][10] = "Нет";

             if( (packet[7]&0x01) == 0x01 ) AdvStringGrid1->Cells[2][1]="Было";
             else AdvStringGrid1->Cells[2][1]="Нет";

             if( (packet[7]&0x02) == 0x02 ) AdvStringGrid1->Cells[2][2]="Было";
             else AdvStringGrid1->Cells[2][2]="Нет";

             if( (packet[7]&0x04) == 0x04 ) AdvStringGrid1->Cells[2][3]="Было";
             else AdvStringGrid1->Cells[2][3]="Нет";

             if( (packet[7]&0x08) == 0x08 ) AdvStringGrid1->Cells[2][4]="Было";
             else AdvStringGrid1->Cells[2][4]="Нет";

             if( (packet[7]&0x10) == 0x10 ) AdvStringGrid1->Cells[2][5]="Было";
             else AdvStringGrid1->Cells[2][5]="Нет";

             if( (packet[7]&0x20) == 0x20 ) AdvStringGrid1->Cells[2][6]="Было";
             else AdvStringGrid1->Cells[2][6]="Нет";

             if( (packet[7]&0x40) == 0x40 ) AdvStringGrid1->Cells[2][7]="Было";
             else AdvStringGrid1->Cells[2][7]="Нет";

             if( (packet[7]&0x80) == 0x80 ) AdvStringGrid1->Cells[2][8]="Было";
             else AdvStringGrid1->Cells[2][8]="Нет";

             if( (packet[8]&0x01) != 0x01 )
             {
                  AdvStringGrid1->Cells[1][1]="-";
                  AdvStringGrid1->Cells[2][1]="Выкл";
             }

             if( (packet[8]&0x02) != 0x02 )
             {
                  AdvStringGrid1->Cells[1][2]="-";
                  AdvStringGrid1->Cells[2][2]="Выкл";
             }


             if( (packet[8]&0x04) != 0x04 )
             {
                  AdvStringGrid1->Cells[1][3]="-";
                  AdvStringGrid1->Cells[2][3]="Выкл";
             }

             if( (packet[8]&0x08) != 0x08 )
             {
                  AdvStringGrid1->Cells[1][4]="-";
                  AdvStringGrid1->Cells[2][4]="Выкл";
             }


             if( (packet[8]&0x10) != 0x10 )
             {
                  AdvStringGrid1->Cells[1][5]="-";
                  AdvStringGrid1->Cells[2][5]="Выкл";
             }


             if( (packet[8]&0x20) != 0x20 )
             {
                  AdvStringGrid1->Cells[1][6]="-";
                  AdvStringGrid1->Cells[2][6]="Выкл";
             }

             if( (packet[8]&0x40) != 0x40 )
             {
                  AdvStringGrid1->Cells[1][7]="-";
                  AdvStringGrid1->Cells[2][7]="Выкл";
             }


             if( (packet[8]&0x80) != 0x80 )
             {
                  AdvStringGrid1->Cells[1][8]="-";
                  AdvStringGrid1->Cells[2][8]="Выкл";
             }
          }
       }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SsoiM1Opros(TObject *Sender)
{
   int ch = ((TTimer*)Sender)->Tag;
   int bl = 0;
   int cmd = 0x95;
   int rez = 0;

   if( GobiSys->Status == 200 )
   {
      DEVICE_ID_PARAMS devID[4];
      PDEVICE_ID_PARAMS pID;
      char sernum[8];
      AnsiString sn = "";
      int flag = -1;
      SsoiM1_devnum = -1;

      for( int dev = 0; dev < ESEU485DevCnt; dev++ )
      {
         pID=&devID[dev];
         for( int i = 0; i < 8; i++ ) sernum[i] = 0;

//         for( int i = 0; i < 3; i++ )
//         {
            Sleep(100);
            flag = GetDeviceID(dev, pID);
            if( flag == AppOK )
            {
               char sernum[8];
               sernum[0] = devID[dev].chDeviceSerial[0];
               sernum[1] = devID[dev].chDeviceSerial[1];
               sernum[2] = devID[dev].chDeviceSerial[2];
               sernum[3] = devID[dev].chDeviceSerial[3];
               sernum[4] = devID[dev].chDeviceSerial[4];
               sernum[5] = devID[dev].chDeviceSerial[5];
               sernum[6] = devID[dev].chDeviceSerial[6];
               sernum[7] = devID[dev].chDeviceSerial[7];

               sn.sprintf("%02X %02X %02X %02X %02X", sernum[3]&0xFF, sernum[4]&0xFF, sernum[5]&0xFF, sernum[6]&0xFF, sernum[7]&0xFF);

               if( sn == SsoiM1_sernum )
               {
                  SsoiM1_devnum = dev;
                  break;
               }
            }
//         }
      }

      if( SsoiM1_devnum >= 0 )
      {
         if( GobiSys->Status != 1 )
         {
            GobiSys->Status = 1;

            AnsiString str;
            str.sprintf("Устройство: %s  Скорость: %d  Таймаут: %d", SsoiM1_sernum, 5000000/(SsoiM1_speed+2), SsoiM1_timeout);
            StatusBar1->Panels->Items[3]->Text = str;
         }
      }
   }
   else
   {
         if( GroupCmdCnt[ch] != 1 )
         {
             if( SsoiM1_adr[ch] >= 0 )
             {
                unsigned char pBuff[64];
                unsigned char tbuf[2];
                bl = GobiSys->OprosAdr[ch][SsoiM1_adr[ch]];

                rez = GetSettings2(SsoiM1_devnum, ch+1, bl+1, 0x9E, tbuf, pBuff);

      /*
                if( GroupBox10->Visible &&
                    ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
                {
                   AnsiString buf_str;

                   if( rez == AppOK )
                      buf_str.sprintf("%02X=%02X%02X%02X%02X%02X%02X%02X%02X",pBuff[63],
                                      pBuff[0], pBuff[1], pBuff[2], pBuff[3], pBuff[4], pBuff[5],
                                      pBuff[6], pBuff[7], pBuff[8]);
                   else buf_str.sprintf("Err=%d", rez);
                   AdvStringGrid1->Cells[2][8]=buf_str;
                }
      */

                cmd = ShowSsoiM1Status( ch, bl, rez, tbuf, ch );

                if( cmd == 0x95 )
                {
                   if( SsoiM1_adr[ch] < KanCnt*BlCnt && GroupCmdCnt[ch] != 0 )
                   {
                      if( GobiSys->OprosAdr[ch][SsoiM1_adr[ch]+1] >=0 ) SsoiM1_adr[ch] += 1;
                      else SsoiM1_adr[ch] = 0;
                   }
                   else SsoiM1_adr[ch] = 0;
                }
             }
             else SsoiM1_adr[ch] = 0;
         }

         if( GroupCmdCnt[ch] == 0 )
         {
            cmd = 0x96;
            rez = SetCmd3(SsoiM1_devnum, ch+1, 255, cmd);
            Sleep(SsoiM1_timeout);

      /*
            if( GroupBox10->Visible &&
                ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
            {
               AnsiString buf_str;

               buf_str.sprintf("K=%d B=%d C=%02X R=%d",ch+1, 255, 0x96, rez);
               buf_str.sprintf("Сh=%d Cmd=0x96 Rez=%d",ch+1, rez);
               AdvStringGrid1->Cells[0][8]=buf_str;
            }
      */
         }
         else
         {
            bl = GobiSys->OprosAdr[ch][SsoiM1_adr[ch]];

            if( GobiSys->Kanal[ch].hCmd == 1 )
            {
               for( int i = 0; i < BlCnt; i++ )
                  for( int j = 0; j < SdCnt; j++ )
                     GobiSys->Kanal[ch].Bl[i].Sd[j].DkOk = false;


               rez = SetCmd3(SsoiM1_devnum, ch+1, 255, 0x92);

      /*
               if( GroupBox10->Visible &&
                   ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
               {
                  AnsiString buf_str;

                  buf_str.sprintf("K=%d B=%d C=%02X R=%d",ch+1, 255, 0x92, rez);
                  AdvStringGrid1->Cells[0][8]=buf_str;
               }
      */

               Sleep(SsoiM1_timeout);

               GobiSys->Kanal[ch].hCmd = 3;
               DkDtOn = Now();
            }
            else if( GobiSys->Kanal[ch].hCmd == 3 )
            {
               TTime DkDtOff1 = Now();
               if( DkDtOff1 - DkDtOn >= GobiSys->DkDtTime1 )
               {
                  rez = SetCmd3(SsoiM1_devnum, ch+1, 255, 0x93);

      /*
                  if( GroupBox10->Visible &&
                      ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
                  {
                     AnsiString buf_str;

                     buf_str.sprintf("K=%d B=%d C=%02X R=%d",ch+1, 255, 0x93, rez);
                     AdvStringGrid1->Cells[0][8]=buf_str;
                  }
      */

                  Sleep(SsoiM1_timeout);

                  GobiSys->Kanal[ch].hCmd = 4;
               }
            }
            else if( GobiSys->Kanal[ch].hCmd == 5 )
            {
               rez = SetCmd3(SsoiM1_devnum, ch+1, 255, 0x94);

      /*
               if( GroupBox10->Visible &&
                   ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
               {
                  AnsiString buf_str;

                  buf_str.sprintf("K=%d B=%d C=%02X R=%d",ch+1, 255, 0x94, rez);
                  AdvStringGrid1->Cells[0][8]=buf_str;
               }
      */

               Sleep(SsoiM1_timeout);

               GobiSys->Kanal[ch].hCmd = 0;
            }

            if( GobiSys->Kanal[ch].Bl[bl].Iu[0].hCmd == 1 )
            {
               Sleep(2*SsoiM1_timeout);
               cmd = 0x91;
               GobiSys->Kanal[ch].Bl[bl].Iu[0].hCmd = 3;
            }
            else if( GobiSys->Kanal[ch].Bl[bl].Iu[0].hCmd == 2 )
            {
               Sleep(2*SsoiM1_timeout);
               cmd = 0x90;
               GobiSys->Kanal[ch].Bl[bl].Iu[0].hCmd = 3;
            }

            rez = SetCmd3(SsoiM1_devnum, ch+1, bl+1, cmd);

      /*
            if( GroupBox10->Visible &&
                ch == POprosObj(ObjTree->Selected->Data)->Num1-1  )
            {
               AnsiString buf_str;

               buf_str.sprintf("K=%d B=%d C=%02X R=%d",ch+1, bl+1, cmd, rez);
               AdvStringGrid1->Cells[0][8]=buf_str;
            }
      */
         }

         if( GroupCmdCnt[ch] < 5 ) GroupCmdCnt[ch] += 1;
         else GroupCmdCnt[ch] = 0;
   }
}
//---------------------------------------------------------------------------
int TMainForm::ShowSsoiM1Status( int kan, int bl, int flag, unsigned char tbuf[2], int tag )
{
   int cmd = 0x95;

   bool iT[5] = {false, false, false, false, false};
   bool oDk = false;
   bool oIu = false;
   bool T[5] = {false, false, false, false, false};
   bool Dk = false;

   AnsiString str;

   if( flag == AppOK )
   {
      if( GobiSys->Status != 1 )
      {
         GobiSys->Status = 1;
         str.sprintf("Устройство: %s  Скорость: %d  Таймаут: %d", SsoiM1_sernum, 5000000/(SsoiM1_speed+2), SsoiM1_timeout);
         StatusBar1->Panels->Items[3]->Text = str;
      }

      GobiSys->Kanal[kan].Bl[bl].ErrCnt = 0;

      int t = tbuf[0]&0xFF;

      if( (t&0x01) == 0x01 ) iT[0] = true;
      if( (t&0x02) == 0x02 ) iT[1] = true;
      if( (t&0x04) == 0x04 ) iT[2] = true;
      if( (t&0x08) == 0x08 ) iT[3] = true;
      if( (t&0x10) == 0x10 ) oDk = true;
      if( (t&0x20) == 0x20 ) iT[4] = true;
      if( (t&0x40) == 0x40 ) oIu = true;

      if( oIu ) GobiSys->Kanal[kan].Bl[bl].Iu[0].Status = 101; /* ИУ - Вкл */
      else GobiSys->Kanal[kan].Bl[bl].Iu[0].Status = 100; /* ИУ - Выкл */

      t = tbuf[1]&0xFF;
      if( (t&0x01) == 0x01 )
      {
         T[0] = true;
      }
      if( (t&0x02) == 0x02 ) T[1] = true;
      if( (t&0x04) == 0x04 ) T[2] = true;
      if( (t&0x08) == 0x08 ) T[3] = true;
      if( (t&0x40) == 0x40 ) Dk = true;
      if( (t&0x80) == 0x80 ) T[4] = true;


      if( GobiSys->Kanal[kan].Bl[bl].Sd[4].Use )
      {
         if( T[4] )
         {
               GobiSys->Kanal[kan].Bl[bl].Sd[4].Status = 21;   
               cmd = 0x94;
         }
         else
         {
               GobiSys->Kanal[kan].Bl[bl].Sd[4].Status = 1;    
         }
      }

      for( int sd = 0; sd < 4; sd++ )
      {
         if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use )
         {
            if( GobiSys->Kanal[kan].hCmd == 0 )
            {
               if( T[sd] )
               {
                  if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt ) GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 20;                   else
                  {
                     if( !oIu )
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 21; 
                     else
                        GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;
                  }
                  cmd = 0x94;
               }
               else
               {
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 1;  
               }
            }
            else 
            {
               if( T[sd] )
               {
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].DkOk = true; 
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 3; 
                  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld ) SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 3;
               }
            }
         }
      }
   }
   else
   {
      if( flag > 0 && flag < 5 ) 
      {
         if( GobiSys->Status != 200 )
         {
            GobiSys->Status = 200;  
            str.sprintf("Нет связи с устройством: %s", SsoiM1_sernum);
            StatusBar1->Panels->Items[3]->Text = str;

            for( int bl1 = 0; bl1 < BlCnt; bl1++ )
            {
               if( GobiSys->Kanal[kan].Bl[bl1].Use )
               {
                   for( int sd = 0; sd < SdCnt; sd++ )
                   {
                      if( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Use )
                      {
                         GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Status = 12; 

                         if( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].StatusOld != GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Status )
                         {
                              int n = 13;
                              if( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].AlarmFix ) n = 8;

                              if( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Bazalt )
                              GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Sin = -1;
                              ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl1].Sd[sd].TreeIdx]->ImageIndex = n;
                              ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl1].Sd[sd].TreeIdx]->SelectedIndex = n;

                              if( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].AlarmFix )
                              {
                                 SetSob( GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Status, SdType, kan+1, bl1+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl1].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                                 AlarmFlag = true;
                                 SoundFlag = 1;
                                 POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                                 POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*bl1+sd] = 10;
                              }

                              GobiSys->Kanal[kan].Bl[bl1].Sd[sd].StatusOld = GobiSys->Kanal[kan].Bl[bl1].Sd[sd].Status;
                         }
                      }
                   }

                   if( GobiSys->Kanal[kan].Bl[bl1].Iu[0].Use )
                   {
                       GobiSys->Kanal[kan].Bl[bl1].Iu[0].Status = 12; 

                       if( GobiSys->Kanal[kan].Bl[bl1].Iu[0].StatusOld != GobiSys->Kanal[kan].Bl[bl1].Iu[0].Status )
                       {
                          AnsiString name;
                          for( int i = 1; i < ObjTree->Items->Count; i++ )
                          {
                             if( POprosObj(ObjTree->Items->Item[i]->Data)->Type == 4  &&
                                 kan == (POprosObj(ObjTree->Items->Item[i]->Data)->Num1-1) &&
                                 bl1 == (POprosObj(ObjTree->Items->Item[i]->Data)->Num2-1) &&
                                 0 == (POprosObj(ObjTree->Items->Item[i]->Data)->Num3-1) )
                             {
                                 name = POprosObj(ObjTree->Items->Item[i]->Data)->Name;

                                 ObjTree->Items->Item[i]->ImageIndex = 8;
                                 ObjTree->Items->Item[i]->SelectedIndex = 8;
                             }
                          }

                          GobiSys->Kanal[kan].Bl[bl1].Iu[0].StatusOld = GobiSys->Kanal[kan].Bl[bl1].Iu[0].Status;
                       }
                   }
               }
            }
         }
      }
      else  
      {
         if( GobiSys->Status != 1 )
         {
            GobiSys->Status = 1;
            str.sprintf("Устройство: %s  Скорость: %d  Таймаут: %d", SsoiM1_sernum, 5000000/(SsoiM1_speed+2), SsoiM1_timeout);
            StatusBar1->Panels->Items[3]->Text = str;
         }

         if( GobiSys->Kanal[kan].Bl[bl].ErrCnt < MaxErrCnt1 ) GobiSys->Kanal[kan].Bl[bl].ErrCnt += 1;
         else
         {
            for( int sd = 0; sd < SdCnt; sd++ )
            {
               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use )
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status = 10; 
            }

            if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Use )
               GobiSys->Kanal[kan].Bl[bl].Iu[0].Status = 10; 
         }
      }
   }


   if( GobiSys->Kanal[kan].hCmd == 4 )
   {
      TTime DkDtOff2 = Now();
      if( DkDtOff2 - DkDtOn >= GobiSys->DkDtTime2 + GobiSys->DkDtTime1 )
      {
         GobiSys->Kanal[kan].hCmd = 5;

         for( int i = 0; i < BlCnt; i++ )
         {
            if( GobiSys->Kanal[kan].Bl[i].Use )
            {
               for( int j = 0; j < 4; j++ )
               {
                  if( GobiSys->Kanal[kan].Bl[i].Sd[j].Use && GobiSys->Kanal[kan].Bl[i].Sd[j].Dk )
                  {
                     if( !GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk )
                     {
                        GobiSys->Kanal[kan].Bl[i].Sd[j].Status = 11;
                        GobiSys->Kanal[kan].Bl[i].Sd[j].StatusOld = 11;
                        SetSob( GobiSys->Kanal[kan].Bl[i].Sd[j].Status, SdType, kan+1, i+1, j+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[i].Sd[j].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }
                  }

                  GobiSys->Kanal[kan].Bl[i].Sd[j].DkOk = false;
               }
            }
         }
      }
   }

   int n = 0;
   for( int sd = 0; sd < 5; sd++ )
   {
      if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Use )
      {
         if( sd == 0 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].OnOffCnt != -1 )
         {
            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].OnOffCnt < SsoiM1_BazaltCnt )
               GobiSys->Kanal[kan].Bl[bl].Sd[sd].OnOffCnt += 1;
            else
            {
               if( GobiSys->Kanal[kan].Bl[bl].Iu[0].status1 == 0 )
               {
                  SetSob( 13, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].OnOffCnt = -1;
               }
               else
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
                  {
                     GobiSys->Kanal[kan].Bl[bl].Iu[0].hCmd = 1;
                  }
                  else if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 )
                  {
                     GobiSys->Kanal[kan].Bl[bl].Iu[0].hCmd = 2;
                  }
                  GobiSys->Kanal[kan].Bl[bl].Iu[0].status1 = 0;
                  GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt = 0;
               }
            }
         }

         if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld != GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status )
         {
                switch( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status )
                {
                   case 1:  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                            {
                               if( iT[sd] && GobiSys->Kanal[kan].hCmd == 0 ) n = 9;
                               else n = 7;
                            }
                            else
                            {
                               if( iT[sd] && GobiSys->Kanal[kan].hCmd == 0 ) n = 14;
                               else n = 12;
                            }
                            break;
                   case 3:  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                            {
                               if( iT[sd] && GobiSys->Kanal[kan].hCmd == 0 ) n = 9;
                               else n = 7;
                            }
                            else
                            {
                               if( iT[sd] && GobiSys->Kanal[kan].hCmd == 0 ) n = 14;
                               else n = 12;
                            }
                            break;
                   case 10: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) n = 8;
                            else n = 13;
                            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].Sin = -1;
                            break;
                   case 11: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) n = 7;
                            else n = 12;
                            break;
                   case 12: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) n = 8;
                            else n = 13;
                            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                              GobiSys->Kanal[kan].Bl[bl].Sd[sd].Sin = -1;
                            break;
                   case 20: if( GobiSys->Kanal[kan].hCmd == 0 )
                            {
                               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) n = 9;
                               else n = 14;
                            }
                            else
                            {
                               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix ) n = 7;
                               else n = 12;
                            }
                            break;
                   case 21: if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
                            {
                               if( iT[sd] ) n = 9;
                               else n = 7;
                            }
                            else
                            {
                               if( iT[sd] ) n = 14;
                               else n = 12;
                            }
                            break;
                   default: n = 6;
                            break;
            }

            ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->ImageIndex = n;
            ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->SelectedIndex = n;

            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
            {
               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 1 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 3 )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 11 )
                     SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status >= 10 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 11 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status < 30 )
                  {
                     AlarmFlag = true;
                     SoundFlag = 1;
                     POprosOutObj(lpMapOpros)->AlarmResetFlag = false;

                     if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 12 )
                        POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*bl+sd] = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
                     else POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*bl+sd] = 10;

                     if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status >= 20 && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status < 30 )
                     if( ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->HasChildren )
                     {
                        int idx = 0;
                        int k1 = 0, b1 = 0, i1 = 0;

                        for( int i = 0; i < ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Count; i++ )
                        {
                           idx = ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->AbsoluteIndex+i+1;

                           if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == IuType )
                           {
                              k1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1-1;
                              b1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2-1;
                              i1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3-1;

                              if( GobiSys->Kanal[k1].Bl[b1].Iu[i1].Status == 100 && GobiSys->Kanal[k1].Bl[b1].Iu[i1].hCmd == 0 )
                              {
                                 GobiSys->Kanal[k1].Bl[b1].Iu[i1].hCmd = 2;
                              }
                           }
                           else if( POprosObj(ObjTree->Items->Item[idx]->Data)->Type == Stn485Type )
                           {
                               int num1 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num1;
                               int num2 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num2;
                               int num3 = POprosObj(ObjTree->Items->Item[idx]->Data)->Num3;
                               AnsiString sn = POprosObj(ObjTree->Items->Item[idx]->Data)->Icon1Path;

                               if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
                               {
                                  cam485[0] = num1;
                                  cam485[1] = num2;
                                  cam485[2] = num3;
                                  cam485_sn[0] = sn;
                               }
                               else
                               {
                                  if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                                  {
                                     cam485[3] = num1;
                                     cam485[4] = num2;
                                     cam485[5] = num3;
                                     cam485_sn[1] = sn;
                                  }
                                  else
                                  {
                                     if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                                     {
                                        cam485[6] = num1;
                                        cam485[7] = num2;
                                        cam485[8] = num3;
                                        cam485_sn[2] = sn;
                                     }
                                     else
                                     {
                                        if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                                        {
                                           cam485[9] = num1;
                                           cam485[10] = num2;
                                           cam485[11] = num3;
                                           cam485_sn[3] = sn;
                                        }
                                        else
                                        {
                                           if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                                           {
                                              cam485[12] = num1;
                                              cam485[13] = num2;
                                              cam485[14] = num3;
                                              cam485_sn[4] = sn;
                                           }
                                           else
                                           {
                                              if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                                              {
                                                 cam485[15] = num1;
                                                 cam485[16] = num2;
                                                 cam485[17] = num3;
                                                 cam485_sn[5] = sn;
                                              }
                                           }
                                        }
                                     }
                                  }
                               }
                           }
                        }
                     }
                  }
               }
            }

            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld == 10 &&
                GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 10 )
            {
               if( !iT[sd] && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 )
                  SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
               else if( iT[sd] && GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 1 )
                  SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            }

            GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status;
         }

         if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status == 1 && GobiSys->Kanal[kan].hCmd == 0 && GobiSys->Kanal[kan].Bl[bl].ErrCnt == 0 )
         {
            if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Sin != iT[sd] )
            {
               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].AlarmFix )
               {
                  if( !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
                  {
                      if( iT[sd] ) n = 9;
                      else
                      {
                         n = 7;
                         SetSob( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                      }
                  }
                  else
                  {
                     if( iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
                     {
                        SetSob( 111, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        n = 36; //34;
                        GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt = -1;
                     }
                     else if( !iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
                     {
                        SetSob( 110, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        n = 39; //23;
                        GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt = -1;
                     }
                     else if( !iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 )
                     {
                        SetSob( 110, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                        n = 37; //24;
                        GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt = -1;
                     }
                     else if( iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 )
                     {
                        n = 38; //35;
                        GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt = -1;
                        if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Sin == -1 )
                           SetSob( 111, SdType, kan+1, bl+1, sd+1,  POprosObj(ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                     }

                     GobiSys->Kanal[kan].Bl[bl].Iu[0].StatusOld = GobiSys->Kanal[kan].Bl[bl].Iu[0].Status;
                  }
               }
               else
               {
                  if( iT[sd] ) n = 14;
                  else n = 12;
               }
               ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->ImageIndex = n;
               ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->SelectedIndex = n;

               GobiSys->Kanal[kan].Bl[bl].Sd[sd].Sin = iT[sd];
            }
            else
            {
               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt )
               {
                  if( GobiSys->Kanal[kan].Bl[bl].Iu[0].StatusOld != GobiSys->Kanal[kan].Bl[bl].Iu[0].Status )
                  {
                     if( iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 ) n = 36; //34;
                     else if( !iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 ) n = 39; //23;
                     else if( !iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 ) n = 37; //24;
                     else if( iT[sd] && GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 ) n = 38; //35;
                     ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->ImageIndex = n;
                     ObjTree->Items->Item[GobiSys->Kanal[kan].Bl[bl].Sd[sd].TreeIdx]->SelectedIndex = n;

                     GobiSys->Kanal[kan].Bl[bl].Iu[0].StatusOld = GobiSys->Kanal[kan].Bl[bl].Iu[0].Status;
                  }
               }
            }
         }
      }
   }

   if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Use )
   {
      if( GobiSys->Kanal[kan].Bl[bl].Iu[0].StatusOld != GobiSys->Kanal[kan].Bl[bl].Iu[0].Status )
      {
          AnsiString name;
          for( int i = 1; i < ObjTree->Items->Count; i++ )
          {
             if( POprosObj(ObjTree->Items->Item[i]->Data)->Type == 4  &&
                 kan == (POprosObj(ObjTree->Items->Item[i]->Data)->Num1-1) &&
                 bl == (POprosObj(ObjTree->Items->Item[i]->Data)->Num2-1) &&
                 0 == (POprosObj(ObjTree->Items->Item[i]->Data)->Num3-1) )
             {
                name = POprosObj(ObjTree->Items->Item[i]->Data)->Name;

                switch( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status )
                {
                   case 100:  n = 24;
                              break;
                   case 101:  n = 23;
                              break;
                   case 10:   n = 8;
                              break;
                   case 12:   n = 8;
                              break;
                   default:   n = 6;
                              break;
                }
                ObjTree->Items->Item[i]->ImageIndex = n;
                ObjTree->Items->Item[i]->SelectedIndex = n;
             }
          }

          if( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 100 ||
              GobiSys->Kanal[kan].Bl[bl].Iu[0].Status == 101 )
             SetSob( GobiSys->Kanal[kan].Bl[bl].Iu[0].Status, IuType, kan+1, bl+1, 1,  name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

          GobiSys->Kanal[kan].Bl[bl].Iu[0].StatusOld = GobiSys->Kanal[kan].Bl[bl].Iu[0].Status;
      }
      else
      {
         if( GobiSys->Kanal[kan].Bl[bl].Iu[0].hCmd == 3 )
         {
             for( int i = 1; i < ObjTree->Items->Count; i++ )
             {
                if( POprosObj(ObjTree->Items->Item[i]->Data)->Type == 4  &&
                    kan == (POprosObj(ObjTree->Items->Item[i]->Data)->Num1-1) &&
                    bl == (POprosObj(ObjTree->Items->Item[i]->Data)->Num2-1) &&
                    0 == (POprosObj(ObjTree->Items->Item[i]->Data)->Num3-1) )
                {
                  SetSob( 13, IuType, kan+1, bl+1, 1,  POprosObj(ObjTree->Items->Item[i]->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                  break;
                }
             }
         }
      }
   }

   if( GobiSys->Kanal[kan].Bl[bl].Iu[0].hCmd == 3 ) GobiSys->Kanal[kan].Bl[bl].Iu[0].hCmd = 0;

   if( kan == POprosObj(ObjTree->Selected->Data)->Num1-1 &&
       bl == POprosObj(ObjTree->Selected->Data)->Num2-1 &&
       POprosObj(ObjTree->Selected->Data)->Num3-1 == 0 )
   {
      if( GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt > -1 )
      {
         GroupBox5->Visible = true;
         CGauge1->Progress = GobiSys->Kanal[kan].Bl[bl].Sd[0].OnOffCnt;
      }
      else
      {
         GroupBox5->Visible = false;
         CGauge1->Progress = 0;
      }
   }

   if( GroupBox10->Visible &&
       kan == POprosObj(ObjTree->Selected->Data)->Num1-1 &&
       bl == POprosObj(ObjTree->Selected->Data)->Num2-1 )
   {
     for( int sd = 0; sd < 5; sd++ )
     {
        if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].Status != 10 )
        {
           if( T[sd] ) AdvStringGrid1->Cells[1][sd+1]="Да [1]";
           else AdvStringGrid1->Cells[1][sd+1]="Нет [0]";

           if( iT[sd] ) AdvStringGrid1->Cells[3][sd+1]="Да [1]";
           else AdvStringGrid1->Cells[3][sd+1]="Нет [0]";
        }
        else
        {
            AdvStringGrid1->Cells[1][sd+1]="Нет связи!";
            AdvStringGrid1->Cells[3][sd+1]="Нет связи!";
        }
     }

     if( GobiSys->Kanal[kan].Bl[bl].Sd[POprosObj(ObjTree->Selected->Data)->Num3-1].Status != 10 )
     {
        if( Dk ) AdvStringGrid1->Cells[1][6]="Есть [1]";
        else AdvStringGrid1->Cells[1][6]="Нет [0]";

        if( oDk ) AdvStringGrid1->Cells[3][6]="Есть [1]";
        else AdvStringGrid1->Cells[3][6]="Нет [0]";

        if( oIu ) AdvStringGrid1->Cells[1][7]="Вкл [1]";
        else AdvStringGrid1->Cells[1][7]="Выкл [0]";
     }
     else
     {
        AdvStringGrid1->Cells[1][6]="Нет связи!";
        AdvStringGrid1->Cells[3][6]="Нет связи!";
        AdvStringGrid1->Cells[1][7]="Нет связи!";
     }
   }

   return cmd;
}
//---------------------------------------------------------------------------
void TMainForm::ResetSsoiM1Info()
{
   GroupBox10->Caption = "Диагностика: РАСТР-М-ССОИ";
   GroupBox10->Height = 368;

   AdvStringGrid1->ColCount = 4;
   AdvStringGrid1->DefaultColWidth = 150;
   AdvStringGrid1->ColWidths[1] = 100;
   AdvStringGrid1->ColWidths[3] = 100;

   AdvStringGrid1->DefaultRowHeight = 21;

   AdvStringGrid1->Cells[0][0]="Параметр";
   AdvStringGrid1->Cells[1][0]="Значение";
   AdvStringGrid1->Cells[2][0]="Параметр";
   AdvStringGrid1->Cells[3][0]="Значение";

   AdvStringGrid1->RowCount = 8;
   AdvStringGrid1->ClearRows(1,7);

   AdvStringGrid1->Cells[0][1]="СД1";
   AdvStringGrid1->Cells[2][1]="Вход \"СД1\"";
   AdvStringGrid1->Cells[0][2]="СД2";
   AdvStringGrid1->Cells[2][2]="Вход \"СД2\"";
   AdvStringGrid1->Cells[0][3]="СД3";
   AdvStringGrid1->Cells[2][3]="Вход \"СД3\"";
   AdvStringGrid1->Cells[0][4]="СД4";
   AdvStringGrid1->Cells[2][4]="Вход \"СД4\"";
   AdvStringGrid1->Cells[0][5]="Вскрытие";
   AdvStringGrid1->Cells[2][5]="Вход \"Вскрытие\"";
   AdvStringGrid1->Cells[0][6]="ДК";
   AdvStringGrid1->Cells[2][6]="Выход \"ДК\"";
   AdvStringGrid1->Cells[0][7]="ИУ1";
}
//---------------------------------------------------------------------------
void TMainForm::BackupAll()
{
   try
   {
      AnsiString fp = ExtractFilePath(Application->ExeName);
      if( FileExists(fp + "backup.bat") ) DeleteFile(fp + "backup.bat");

      AnsiString str;
      TStringList* BackupList = new TStringList();
      str = "@echo off";
      BackupList->Add(str);
      str.sprintf("if not exist \"%s\" md \"%s\"", BackupPath, BackupPath);
      BackupList->Add(str);
      str.sprintf("if not exist \"%s\\config_1.7z\" goto STEP1", BackupPath);
      BackupList->Add(str);
      str.sprintf("if not exist \"%s\\config_2.7z\" goto STEP2", BackupPath);
      BackupList->Add(str);
      str.sprintf("if not exist \"%s\\config_3.7z\" goto STEP3", BackupPath);
      BackupList->Add(str);
      str.sprintf("del \"%s\\config_1.7z\"", BackupPath);
      BackupList->Add(str);
      str.sprintf("ren \"%s\\config_2.7z\" config_1.7z", BackupPath);
      BackupList->Add(str);
      str.sprintf("ren \"%s\\config_3.7z\" config_2.7z", BackupPath);
      BackupList->Add(str);
      str = "goto STEP3";
      BackupList->Add(str);
      str = ":STEP1";
      BackupList->Add(str);
      str.sprintf("7za a \"%s\\config_1.7z\" @backup.lst", BackupPath);
      BackupList->Add(str);
      str = "goto END1";
      BackupList->Add(str);
      str = ":STEP2";
      BackupList->Add(str);
      str.sprintf("7za a \"%s\\config_2.7z\" @backup.lst", BackupPath);
      BackupList->Add(str);
      str = "goto END1";
      BackupList->Add(str);
      str = ":STEP3";
      BackupList->Add(str);
      str.sprintf("7za a \"%s\\config_3.7z\" @backup.lst", BackupPath);
      BackupList->Add(str);
      str = ":END1";
      BackupList->Add(str);

      if( MySQL_use == 1 )
      {
         AnsiString query, err_str;
         query.sprintf("SELECT COUNT(*) FROM %s.events", MySQL_dbname);
         mysql_real_query(Con,query.c_str(),query.Length());
          int err_code = mysql_errno(Con);
          if( err_code != 0 )
          {
             mysql_close(Con);

             Con = mysql_init(NULL);
             mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
             err_code = mysql_errno(Con);
             if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
             {
                MySQL_use = -1;

                err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                ShowMessage(err_str);
             }
             else
             {
                mysql_real_query(Con,query.c_str(),query.Length());
                err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   MySQL_use = -1;

                   err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                   ShowMessage(err_str);
                }
             }
          }


         if( MySQL_use == 1 )
         {
             Result = mysql_store_result(Con);

             unsigned int maxCnt = 0;

             unsigned int num_rows;
             num_rows = mysql_num_rows(Result);
             if( num_rows > 0 )
             {
                for( unsigned int i = 0; i < num_rows; i++)
                {
                   row = mysql_fetch_row(Result);

                   if( row[0] != NULL ) maxCnt = AnsiString(row[0]).ToInt();
                }
             }

             if( maxCnt > MaxBdStringCnt && MaxBdStringCnt < 11000000 )
             {
                maxCnt = maxCnt - MaxBdStringCnt;

                query.sprintf("DELETE FROM %s.events ORDER BY event_num LIMIT %d", MySQL_dbname, maxCnt);
                mysql_real_query(Con,query.c_str(),query.Length());
                Result = mysql_store_result(Con);
             }
         }

         str.sprintf("if not exist \"%s\\mysql_1.sql\" goto STEP4", BackupPath);
         BackupList->Add(str);
         str.sprintf("if not exist \"%s\\mysql_2.sql\" goto STEP5", BackupPath);
         BackupList->Add(str);
         str.sprintf("if not exist \"%s\\mysql_3.sql\" goto STEP6", BackupPath);
         BackupList->Add(str);
         str.sprintf("del \"%s\\mysql_1.sql\"", BackupPath);
         BackupList->Add(str);
         str.sprintf("ren \"%s\\mysql_2.sql\" mysql_1.sql", BackupPath);
         BackupList->Add(str);
         str.sprintf("ren \"%s\\mysql_3.sql\" mysql_2.sql", BackupPath);
         BackupList->Add(str);
         str.sprintf("mysqldump.exe --opt --all-databases --user=%s --password=%s > \"%s\\mysql_3.sql\"", MySQL_login, MySQL_password, BackupPath);
         BackupList->Add(str);
         str = "goto END2";
         BackupList->Add(str);
         str = ":STEP4";
         BackupList->Add(str);
         str.sprintf("mysqldump.exe --opt --all-databases --user=%s --password=%s > \"%s\\mysql_1.sql\"", MySQL_login, MySQL_password, BackupPath);
         BackupList->Add(str);
         str = "goto END2";
         BackupList->Add(str);
         str = ":STEP5";
         BackupList->Add(str);
         str.sprintf("mysqldump.exe --opt --all-databases --user=%s --password=%s > \"%s\\mysql_2.sql\"", MySQL_login, MySQL_password, BackupPath);
         BackupList->Add(str);
         str = "goto END2";
         BackupList->Add(str);
         str = ":STEP6";
         BackupList->Add(str);
         str.sprintf("mysqldump.exe --opt --all-databases --user=%s --password=%s > \"%s\\mysql_3.sql\"", MySQL_login, MySQL_password, BackupPath);
         BackupList->Add(str);
         str = ":END2";
         BackupList->Add(str);
      }

      BackupList->SaveToFile(fp + "\\backup.bat");
      delete BackupList;

      str = fp + "backup.bat";
      WinExec(str.c_str(), SW_HIDE);
   }
   catch(...)
   {
      MessageBox (NULL, "Ошибка выполнения операции создания резервной копии!",ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::FormResize(TObject *Sender)
{
   try
   {
      if( ToolBar1->Width > 721 )
      {
               if( TabloSys->Use )
               {
                  StaticText29->Width = ToolBar1->Width-720;
                  StaticText29->Left = 710;
                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  StaticText30->Left = 172;
                  StaticText30->Width = 86;
                  StaticText16->Left = 258;
                  StaticText16->Width = 60;
                  StaticText31->Left = 318;
                  StaticText31->Width = 10;
                  StaticText32->Left = 328;
                  StaticText32->Width = 60;
                  StaticText33->Left = 388;
                  StaticText33->Width = 10;
                  StaticText34->Left = 398;
                  StaticText34->Width = 60;
                  StaticText35->Left = 458;
                  StaticText35->Width = 10;
                  StaticText36->Left = 468;
                  StaticText36->Width = 60;
                  StaticText37->Left = 528;
                  StaticText37->Width = 10;
                  ToolButton4->Left = 538;
                  ToolButton4->Width = 86;
                  ToolButton3->Left = 624;
                  ToolButton3->Width = 86;
               }
               else
               {
                  StaticText30->Visible = false;
                  StaticText16->Visible = false;
                  StaticText31->Visible = false;
                  StaticText32->Visible = false;
                  StaticText33->Visible = false;
                  StaticText34->Visible = false;
                  StaticText35->Visible = false;
                  StaticText36->Visible = false;
                  StaticText37->Visible = false;
                  ToolButton4->Visible = false;

                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  ToolButton3->Left = 172;
                  ToolButton3->Width = 86;
                  StaticText29->Width = ToolBar1->Width-268;
                  StaticText29->Left = 258;
               }
      }
      else
      {
         if( TabloSys->Use )
         {
         }
         else
         {
                  StaticText30->Visible = false;
                  StaticText16->Visible = false;
                  StaticText31->Visible = false;
                  StaticText32->Visible = false;
                  StaticText33->Visible = false;
                  StaticText34->Visible = false;
                  StaticText35->Visible = false;
                  StaticText36->Visible = false;
                  StaticText37->Visible = false;
                  ToolButton4->Visible = false;
         }
      }
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Table1CalcFields(TDataSet *DataSet)
{
   switch( Table1Type->AsInteger )
   {
      case   0: Table1Type2Str->AsString = Table1Str1; 
                break;
      case   1: Table1Type2Str->AsString = Table1Str2; 
                break;
      case   2: Table1Type2Str->AsString = "Конф. изм. (пульт)";
                break;
      case   3: Table1Type2Str->AsString = Table1Str3; 
                break;
      case   4: Table1Type2Str->AsString = Table1Str4; 
                break;
      case   5: if( Table1Dtype->AsInteger != TochkaMDdIdx ) Table1Type2Str->AsString = "Отметка пройдена"; 
                else Table1Type2Str->AsString = "Норма по ЧЭ1";
                break;
      case   6: if( Table1Dtype->AsInteger != TochkaMDdIdx )Table1Type2Str->AsString = "Определение направления вкл";
                else Table1Type2Str->AsString = "Норма по ЧЭ2";
                break;
      case   7: Table1Type2Str->AsString = "Определение направления выкл";
                break;
      case  10: Table1Type2Str->AsString = Table1Str5; 
                break;
      case  11: Table1Type2Str->AsString = Table1Str6; 
                break;
      case  12: if( Table1Dtype->AsInteger == SdType || Table1Dtype->AsInteger == IuType ) Table1Type2Str->AsString = "Нет связи с ESE-U485";
                else if( Table1Dtype->AsInteger == TochkaMDdIdx ) Table1Type2Str->AsString = "Неисправность по ЧЭ1";
                else if( Table1Dtype->AsInteger == SotaMDdIdx ) Table1Type2Str->AsString = "Неисправность ДД";
                else Table1Type2Str->AsString = "Неисправность";
                break;
      case  13: if( Table1Dtype->AsInteger == TochkaMDdIdx ) Table1Type2Str->AsString = "Неисправность по ЧЭ2";
                else Table1Type2Str->AsString = Table1Str7; 
                break;
      case  15: Table1Type2Str->AsString = "Перев. в реж. Раб.с пульт.";
                break;
      case  16: Table1Type2Str->AsString = "Отсутствует синхронизация";
                break;
      case  17: Table1Type2Str->AsString = "Неисправность линии";
                break;
      case  18: Table1Type2Str->AsString = "Неисправность ЧЭ";
                break;
      case  20: Table1Type2Str->AsString = Table1Str8; 
                break;
      case  21: Table1Type2Str->AsString = Table1Str9; 
                break;
      case  22: if( Table1Dtype->AsInteger == TochkaMDdIdx ) Table1Type2Str->AsString = "Тревога - СРАБОТКА по ЧЭ1";
                else Table1Type2Str->AsString = Table1Str10; 
                break;
      case  23: if( Table1Dtype->AsInteger == 9 ) Table1Type2Str->AsString = "Тревога-СРАБОТКА(Луч чужой)";
                else if( Table1Dtype->AsInteger == 91 ) Table1Type2Str->AsString = "Тревога-СРАБОТКА(Зона 1)";
                else if( Table1Dtype->AsInteger == 21 ) Table1Type2Str->AsString = "Тревога-НЕИСПРАВНОСТЬ";
                else if( Table1Dtype->AsInteger == 10 )
                {
                  AnsiString s;
                  s.sprintf("Тревога - Сработка от ЧЭ%d", Table1Dnum2->AsInteger);
                  Table1Type2Str->AsString = s;
                }
                else if( Table1Dtype->AsInteger == TochkaMDdIdx ) Table1Type2Str->AsString = "Тревога - СРАБОТКА по ЧЭ2";
                else Table1Type2Str->AsString = "Тревога - СРАБОТКА(Луч 1)";
                break;
      case  24: if( Table1Dtype->AsInteger == 9 ) Table1Type2Str->AsString = "Тревога - СРАБОТКА(Луч свой)";
                else if( Table1Dtype->AsInteger == 91 ) Table1Type2Str->AsString = "Тревога - СРАБОТКА(Зона 2)";
                else Table1Type2Str->AsString = "Тревога-СРАБОТКА(Луч 2)";
                break;
      case  25: if( Table1Dtype->AsInteger != RifRlmSType ) Table1Type2Str->AsString = Table1Str9; 
                else Table1Type2Str->AsString = "Тревога - СИНХР.ИЗМ.";
                break;
      case  26: Table1Type2Str->AsString = "Тревога-Отсутствие часового";
                break;
      case  27: Table1Type2Str->AsString = "Тревога-СРАБОТКА(Зона 3)";
                break;
      case  30: Table1Type2Str->AsString = "Раб. с пультом";
                break;
      case  31: Table1Type2Str->AsString = "Раб. с пультом заверш.";
                break;
      case 100: Table1Type2Str->AsString = Table1Str11; 
                break;
      case 101: Table1Type2Str->AsString = Table1Str12; 
                break;
      case 110: Table1Type2Str->AsString = Table1Str13; 
                break;
      case 111: Table1Type2Str->AsString = Table1Str14; 
                break;
      case 112: Table1Type2Str->AsString = Table1Str28; 
                break;
      case 113: Table1Type2Str->AsString = Table1Str29; 
                break;
      case 130: Table1Type2Str->AsString = Table1Str15; 
                break;
      case 131: Table1Type2Str->AsString = Table1Str16; 
                break;
      case 132: Table1Type2Str->AsString = "Послана ком. Раб. с пультом";
                break;
      case 133: Table1Type2Str->AsString = Table1Str17; 
                break;
      case 134: Table1Type2Str->AsString = "Запись настройки";
                break;
      case 135: Table1Type2Str->AsString = Table1Str18; 
                break;
      case 136: Table1Type2Str->AsString = Table1Str19; 
                break;
      case 137: Table1Type2Str->AsString = Table1Str20; 
                break;
      case 138: Table1Type2Str->AsString = "Послана ком. Завершение раб. с пультом";
                break;
      case 140: Table1Type2Str->AsString = Table1Str21;
                break;
      case 141: Table1Type2Str->AsString = Table1Str22; 
                break;
      case 142: Table1Type2Str->AsString = "Синхронизация восстановлена";
                break;
      case 143: Table1Type2Str->AsString = Table1Str30; 
                break;
      case 144: Table1Type2Str->AsString = "Вызов завершен по кан. связи";
                break;
      case 145: Table1Type2Str->AsString = Table1Str32; 
                break;
      case 146: Table1Type2Str->AsString = "Вызов завершен оператором";
                break;
      case 150: Table1Type2Str->AsString = Table1Str23; 
                break;
      case 151: Table1Type2Str->AsString = Table1Str24; 
                break;
      case 160: Table1Type2Str->AsString = "ДК не выполнена (все зоны отключены)";
                break;
      case 170: Table1Type2Str->AsString = "Зона1 отключена";
                break;
      case 171: Table1Type2Str->AsString = "Зона1 включена";
                break;
      case 172: Table1Type2Str->AsString = "Зона2 отключена";
                break;
      case 173: Table1Type2Str->AsString = "Зона2 включена";
                break;
      case 174: Table1Type2Str->AsString = "Зона3 отключена";
                break;
      case 175: Table1Type2Str->AsString = "Зона3 включена";
                break;
      case 200: Table1Type2Str->AsString = Table1Str5; 
                break;
      case 201: Table1Type2Str->AsString = "КЗ шлейфа фланга";
                break;
      case 202: Table1Type2Str->AsString = "КЗ питания фланга";
                break;
      case 203: Table1Type2Str->AsString = "Снижение питания БОС";
                break;
      case 204: Table1Type2Str->AsString = "Подключен ПК-КСУ";
                break;
      case 900: Table1Type2Str->AsString = Table1Str25; 
                break;
      case 901: Table1Type2Str->AsString = Table1Str26; 
                break;
      case 902: Table1Type2Str->AsString = Table1Str27; 
                break;
      case 903: Table1Type2Str->AsString = SetSobStr06; 
                break;
      case 904: Table1Type2Str->AsString = Table1Str33; 
                break;
      case 905: Table1Type2Str->AsString = "Включен режим Тревога";
                break;
      case 906: Table1Type2Str->AsString = "Сброс табло";
                break;
      case 907: Table1Type2Str->AsString = "Модуль запущен в демо-режиме"; 
                break;
      case 1000: Table1Type2Str->AsString = "Удал.ком. Выкл";
                break;
      case 1001: Table1Type2Str->AsString = "Удал.ком. Вкл";
                break;
      case 1002: Table1Type2Str->AsString = "Удал.ком. ДК";
                break;
      case 1003: Table1Type2Str->AsString = "Удал.ком. Закрыть";
                break;
      case 1004: Table1Type2Str->AsString = "Удал.ком. Открыть";
                break;
      case 1005: Table1Type2Str->AsString = "Удал.ком. Посл.исх.выз";
                break;
      case 1006: Table1Type2Str->AsString = "Удал.ком. Заверш.исх.выз";
                break;
      case 1007: Table1Type2Str->AsString = "Удал.ком. Вкл.реж.Тревога";
                break;
      case 1133: Table1Type2Str->AsString = "Удал.ком. Послана ком. ДК";
                break;
      case 1136: Table1Type2Str->AsString = "Удал.ком. Контроль выкл.";
                break;
      case 1137: Table1Type2Str->AsString = "Удал.ком. Контроль вкл.";
                break;
      case 1143: Table1Type2Str->AsString = "Удал.ком. Исходящий вызов";
                break;
      case 1146: Table1Type2Str->AsString = "Удал.ком. Вызов завершен";
                break;
      case 1902: Table1Type2Str->AsString = "Удал.ком. Начата новая смена"; 
                break;
      case 1903: Table1Type2Str->AsString = "Удал.ком. Сброс тревог";
                break;
   }

   AnsiString str;
   str = "";
   if( Table1OpFn->AsString != "(null)" ) str = Table1OpFn->AsString;
   if( Table1OpN1->AsString != "(null)" ) str = str + " " + Table1OpN1->AsString;
   if( Table1OpN2->AsString != "(null)" ) str = str + " " + Table1OpN2->AsString;
   Table1OpFio->AsString = str;

   str = "";
   if( Table1ClFn->AsString != "(null)" ) str = Table1ClFn->AsString;
   if( Table1ClN1->AsString != "(null)" ) str = str + " " + Table1ClN1->AsString;
   if( Table1ClN2->AsString != "(null)" ) str = str + " " + Table1ClN2->AsString;
   Table1ClFio->AsString = str;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ConnectBlock_pdiClick(TObject *Sender)
{
   if( POprosObj(ObjTree->Selected->Data)->Type == 3 && SsoiM_PortNum[0] != 0 && ComplexVersion != Rastr_M_SsoiComplexType )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-4;

      if( GobiSys->Kanal[kan].Bl[bl].Iu[iu].StatusOld == 1 )
      {
         SetSob( 146, 3, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 1;
      }
      else
      {
         SetSob( 143, 3, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys->Kanal[kan].Bl[bl].Iu[iu].hCmd = 2;
      }
   }
   else  if( POprosObj(ObjTree->Selected->Data)->Type == SsoiMSdType && SsoiM_PortNum[0] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int iu = POprosObj(ObjTree->Selected->Data)->Num3-4;

      if( GobiSys2->Bl[kan][bl].Iu[iu].Status == 2 )
      {
         SetSob( 143, 33, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 1;
         GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         GobiSys2->Bl[kan][bl].Sd[iu+3].ConnectBlockHand = true;
      }
      else
      {
         SetSob( 146, 33, (kan+1),(bl+1),(iu+4), POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         GobiSys2->Bl[kan][bl].Iu[iu].hCmd = 2;
         GobiSys2->Bl[kan][bl].Cmd = 0xF2;
         GobiSys2->Bl[kan][bl].Sd[iu+3].ConnectBlockHand = false;
      }
   }
}
//---------------------------------------------------------------------------
int TMainForm::GoodCloseOpen( AnsiString fn, int &year, int &month, int &day, int &hour, int &min, int &sec )
{
   AnsiString tmps, in_str;
   int iFileHandle;
   int iFileLength;
   int iBytesRead;
   char *pszBuffer;

   year = 0;
   month = 0;
   day = 0;
   hour = 0;
   min = 0;
   sec = 0;

   int flag = 0;

   try
   {
      if( FileExists(fn) )
      {
         iFileHandle = FileOpen(fn, fmOpenRead);
         iFileLength = FileSeek(iFileHandle,0,2);
         FileSeek(iFileHandle,0,0);
         pszBuffer = new char[iFileLength+1];
         iBytesRead = FileRead(iFileHandle, pszBuffer, iFileLength);
         FileClose(iFileHandle);

         in_str = AnsiString(pszBuffer);
         int pos1 = in_str.Pos("CLOSE");

         if( pos1 == 1 ) flag = 1;
         else
         {
            AnsiString in_str2;

            flag = -2;

            pos1 = 0;
            pos1 = in_str.Pos("<SAVE>");
            int pos2 = in_str.Pos("</SAVE>");

            if( pos1 == 1 && pos1 < pos2 )
            {
               AnsiString year_str, month_str, day_str, hour_str, min_str, sec_str;

               year_str = in_str.SubString(pos1+StrLen("<SAVE>"), 4);
               month_str = in_str.SubString(pos1+StrLen("<SAVE>")+StrLen(year_str.c_str())+1, 2);
               day_str = in_str.SubString(pos1+StrLen("<SAVE>")+StrLen(year_str.c_str())+StrLen(month_str.c_str())+2, 2);
               hour_str = in_str.SubString(pos1+StrLen("<SAVE>")+StrLen(year_str.c_str())+2*StrLen(month_str.c_str())+3, 2);
               min_str = in_str.SubString(pos1+StrLen("<SAVE>")+StrLen(year_str.c_str())+3*StrLen(month_str.c_str())+4, 2);
               sec_str = in_str.SubString(pos1+StrLen("<SAVE>")+StrLen(year_str.c_str())+4*StrLen(month_str.c_str())+5, 2);
               year = StrToInt(year_str);
               month = StrToInt(month_str);
               day = StrToInt(day_str);
               hour = StrToInt(hour_str);
               min = StrToInt(min_str);
               sec = StrToInt(sec_str);

               flag = -1;
            }
         }

         DeleteFile(fn);
      }

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss", Now() );
      tmps.sprintf("<SAVE>%s</SAVE>", dt_str );

      iFileHandle = FileCreate(fn);
      FileSeek(iFileHandle,0,2);
      FileWrite(iFileHandle, tmps.c_str(), tmps.Length());
      FileClose(iFileHandle);

      delete [] pszBuffer;
   }
   catch(...)
   {
      if( FileExists(fn) ) DeleteFile(fn);

      flag = -2;
   }

   return flag;
}
//---------------------------------------------------------------------------
void TMainForm::GoodCloseSave( AnsiString fn )
{
   AnsiString tmps;
   int iFileHandle;

   try
   {
//      fn = ExtractFileName(Application->ExeName);
//      tmps.sprintf("%s.gs", fn);
//      fn = ExtractFilePath(Application->ExeName) + tmps;

      if( FileExists(fn) ) DeleteFile(fn);

      if( !FileExists(fn) )
      {
         tmps = "CLOSE";

         iFileHandle = FileCreate(fn);
         FileSeek(iFileHandle,0,2);
         FileWrite(iFileHandle, tmps.c_str(), tmps.Length());
         FileClose(iFileHandle);
      }
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::SoundSetItemClick(TObject *Sender)
{
   SoundFlag = 1;

   SetSob( 905, 0, 0, 0, 0, SetSobStr02 , OpFn, OpN1, OpN2, "", "", "", false, 0 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::OnOff2_pdiClick(TObject *Sender)
{
   if( MessageBox (NULL,MsgStr13.c_str(), WarningMsg.c_str() ,MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
   {
      if( Audit() )
      {
         int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
         int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
         int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

         if( RifSys->Rk[num3-1][IpBlIdx].StatusOld[num2-1] == 100 )
         {
            SetSob( 130, SdIpBlType, num3,num1,num2, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1] = 101;
         }
         else
         {
            SetSob( 131, IuIpBlType, num3,num1,num2, POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            RifSys->Rk[num3-1][IpBlIdx].hCmd[num2-1] = 100;
         }
         RifSys->Rk[num3-1][IpBlIdx].Cmd = 0x20;
         RifSys->Rk[num3-1][IpBlIdx].CmdCnt = 3;
      }
      else MessageBox (NULL, MsgStr14.c_str(), ErrorMsg.c_str() ,MB_OK|MB_ICONERROR);
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::TabloResetItemClick(TObject *Sender)
{
   TabloSys->SbrosTablo = 1;
   SetSob( 906, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0 );
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::TabloTimerTimer(TObject *Sender)
{
/* Рабочий вариант для формата У02 заменен 11.07.2019 по просьбе Д.Светлова на вариант 003, но не проверялся
   if( TabloSys->Use )
   {
      int packet[27];
      for( int i = 0; i < 27; i++ ) packet[i] = 0x00;
      AnsiString str;
      TabloTimer->Interval = 1000;

      if( TabloSys->SbrosTablo == 0 )
      {
         if( TabloBlinkingNum == 1 && TabloBlinking )
         {
            str = "";
            StaticText16->Caption = str;
            StaticText32->Caption = str;
            StaticText34->Caption = str;
            StaticText36->Caption = str;

            TabloSys->SbrosTablo = 0;

            Serial6.SetTabloPaket(255, packet);

            for( int i = 0; i < TabloDevCnt; i++ ) TabloSys->Dev[i].NumOld = 0;

            TabloTimer->Interval = 250;
         }
         else
         {
            for( int i = 0; i < TabloDevCnt; i++ )
            {
               for( int j = 0; j < 27; j++ ) packet[j] = 0x00;

               if( TabloSys->Dev[i].NumOld == 0 && TabloSys->Dev[i].Num == 0 )
               {
                  if( i == 0 )
                  {
                     str = "     ";
                     StaticText16->Caption = str;
                  }
                  else if( i == 1 )
                  {
                     str = "     ";
                     StaticText32->Caption = str;
                  }
                  else if( i == 2 )
                  {
                     str = "     ";
                     StaticText34->Caption = str;
                  }
                  else if( i == 3 )
                  {
                     str = "     ";
                     StaticText36->Caption = str;
                  }

                  packet[10] = 0x80;
                  packet[16] = 0x80;

                  Serial6.SetTabloPaket(i+1, packet);
                  Sleep(50);
                  if( Serial6.GetTabloPaket(i+1) )
                  {
                     TabloSys->Dev[i].NumOld = TabloSys->Dev[i].Num;
                  }
               }
               else if( TabloSys->Dev[i].NumOld == 0 && TabloSys->Dev[i].Num != 0 )
               {
                  if( i == 0 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText16->Caption = str;
                  }
                  else if( i == 1 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText32->Caption = str;
                  }
                  else if( i == 2 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText34->Caption = str;
                  }
                  else if( i == 3 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText36->Caption = str;
                  }

                  packet[0] = 0x42;    // У
                  packet[3] = 0x42;
                  packet[6] = 0x42;
                  packet[9] = 0x42;
                  packet[12] = 0x42;
                  packet[15] = 0x3E;
                  packet[18] = 0x02;
                  packet[21] = 0x42;
                  packet[24] = 0x3C;

                  int d1 = TabloSys->Dev[i].Num/10;
                  switch( d1 )
                  {
                         case 0:
                                  packet[1] = 0x1C;    // 0
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x22;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 1:
                                  packet[1] = 0x04;    // 1
                                  packet[4] = 0x1C;
                                  packet[7] = 0x04;
                                  packet[10] = 0x04 | 0x80;
                                  packet[13] = 0x04;
                                  packet[16] = 0x04 | 0x80;
                                  packet[19] = 0x04;
                                  packet[22] = 0x04;
                                  packet[25] = 0x04;
                                  break;
                         case 2:
                                  packet[1] = 0x1C;    // 2
                                  packet[4] = 0x22;
                                  packet[7] = 0x02;
                                  packet[10] = 0x02 | 0x80;
                                  packet[13] = 0x04;
                                  packet[16] = 0x08 | 0x80;
                                  packet[19] = 0x10;
                                  packet[22] = 0x20;
                                  packet[25] = 0x3E;
                                  break;
                         case 3:
                                  packet[1] = 0x1C;    // 3
                                  packet[4] = 0x22;
                                  packet[7] = 0x02;
                                  packet[10] = 0x02 | 0x80;
                                  packet[13] = 0x0C;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 4:
                                  packet[1] = 0x04;    // 4
                                  packet[4] = 0x0C;
                                  packet[7] = 0x0C;
                                  packet[10] = 0x14 | 0x80;
                                  packet[13] = 0x14;
                                  packet[16] = 0x24 | 0x80;
                                  packet[19] = 0x3E;
                                  packet[22] = 0x04;
                                  packet[25] = 0x04;
                                  break;
                         case 5:
                                  packet[1] = 0x3E;    // 5
                                  packet[4] = 0x20;
                                  packet[7] = 0x20;
                                  packet[10] = 0x3C | 0x80;
                                  packet[13] = 0x22;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 6:
                                  packet[1] = 0x1C;    // 6
                                  packet[4] = 0x22;
                                  packet[7] = 0x20;
                                  packet[10] = 0x20 | 0x80;
                                  packet[13] = 0x3C;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 7:
                                  packet[1] = 0x3E;    // 7
                                  packet[4] = 0x02;
                                  packet[7] = 0x04;
                                  packet[10] = 0x04 | 0x80;
                                  packet[13] = 0x08;
                                  packet[16] = 0x08 | 0x80;
                                  packet[19] = 0x10;
                                  packet[22] = 0x10;
                                  packet[25] = 0x10;
                                  break;
                         case 8:
                                  packet[1] = 0x1C;    // 8
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x1C;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 9:
                                  packet[1] = 0x1C;    // 9
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x1E;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                  }

                 int d2 = TabloSys->Dev[i].Num - d1*10;
                  switch( d2 )
                  {
                         case 0:
                                  packet[2] = 0x1C;    // 0
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x22;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 1:
                                  packet[2] = 0x04;    // 1
                                  packet[5] = 0x1C;
                                  packet[8] = 0x04;
                                  packet[11] = 0x04;
                                  packet[14] = 0x04;
                                  packet[17] = 0x04;
                                  packet[20] = 0x04;
                                  packet[23] = 0x04;
                                  packet[26] = 0x04;
                                  break;
                         case 2:
                                  packet[2] = 0x1C;    // 2
                                  packet[5] = 0x22;
                                  packet[8] = 0x02;
                                  packet[11] = 0x02;
                                  packet[14] = 0x04;
                                  packet[17] = 0x08;
                                  packet[20] = 0x10;
                                  packet[23] = 0x20;
                                  packet[26] = 0x3E;
                                  break;
                         case 3:
                                  packet[2] = 0x1C;    // 3
                                  packet[5] = 0x22;
                                  packet[8] = 0x02;
                                  packet[11] = 0x02;
                                  packet[14] = 0x0C;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 4:
                                  packet[2] = 0x04;    // 4
                                  packet[5] = 0x0C;
                                  packet[8] = 0x0C;
                                  packet[11] = 0x14;
                                  packet[14] = 0x14;
                                  packet[17] = 0x24;
                                  packet[20] = 0x3E;
                                  packet[23] = 0x04;
                                  packet[26] = 0x04;
                                  break;
                         case 5:
                                  packet[2] = 0x3E;    // 5
                                  packet[5] = 0x20;
                                  packet[8] = 0x20;
                                  packet[11] = 0x3C;
                                  packet[14] = 0x22;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 6:
                                  packet[2] = 0x1C;    // 6
                                  packet[5] = 0x22;
                                  packet[8] = 0x20;
                                  packet[11] = 0x20;
                                  packet[14] = 0x3C;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 7:
                                  packet[2] = 0x3E;    // 7
                                  packet[5] = 0x02;
                                  packet[8] = 0x04;
                                  packet[11] = 0x04;
                                  packet[14] = 0x08;
                                  packet[17] = 0x08;
                                  packet[20] = 0x10;
                                  packet[23] = 0x10;
                                  packet[26] = 0x10;
                                  break;
                         case 8:
                                  packet[2] = 0x1C;    // 8
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x1C;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 9:
                                  packet[2] = 0x1C;    // 9
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x1E;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                  }


                  Serial6.SetTabloPaket(i+1, packet);
                  Sleep(50);
                  if( Serial6.GetTabloPaket(i+1) )
                  {
                     TabloSys->Dev[i].NumOld = TabloSys->Dev[i].Num;
                  }
               }
            }
         }
         TabloBlinkingNum = (TabloBlinkingNum+1)%2;
      }
      else if( TabloSys->SbrosTablo == 1 )
      {
         str = "===";
         StaticText16->Caption = str;
         StaticText32->Caption = str;
         StaticText34->Caption = str;
         StaticText36->Caption = str;

         TabloSys->SbrosTablo = 2;

         packet[9] = 0x7E;    // == == ==
         packet[10] = 0x7E;
         packet[11] = 0x7E;
         packet[12] = 0x7E;
         packet[13] = 0x7E;
         packet[14] = 0x7E;

         Serial6.SetTabloPaket(255, packet);
      }
      else if( TabloSys->SbrosTablo == 2 )
      {
         str = "";
         StaticText16->Caption = str;
         StaticText32->Caption = str;
         StaticText34->Caption = str;
         StaticText36->Caption = str;

         TabloSys->SbrosTablo = 0;

         Serial6.SetTabloPaket(255, packet);

         for( int i = 0; i < TabloDevCnt; i++ )
         {
            TabloSys->Dev[i].Num = 0;
            TabloSys->Dev[i].NumOld = 0;
         }
      }
   }
*/
   if( TabloSys->Use )
   {
      int packet[27];
      for( int i = 0; i < 27; i++ ) packet[i] = 0x00;
      AnsiString str;
      TabloTimer->Interval = 1000;

      if( TabloSys->SbrosTablo == 0 )
      {
         if( TabloBlinkingNum == 1 && TabloBlinking )
         {
            str = "";
            StaticText16->Caption = str;
            StaticText32->Caption = str;
            StaticText34->Caption = str;
            StaticText36->Caption = str;

            TabloSys->SbrosTablo = 0;

            Serial6.SetTabloPaket(255, packet);

            for( int i = 0; i < TabloDevCnt; i++ ) TabloSys->Dev[i].NumOld = 0;

            TabloTimer->Interval = 250;
         }
         else
         {
            for( int i = 0; i < TabloDevCnt; i++ )
            {
               for( int j = 0; j < 27; j++ ) packet[j] = 0x00;

               if( TabloSys->Dev[i].NumOld == 0 && TabloSys->Dev[i].Num == 0 )
               {
                  if( i == 0 )
                  {
                     str = "     ";
                     StaticText16->Caption = str;
                  }
                  else if( i == 1 )
                  {
                     str = "     ";
                     StaticText32->Caption = str;
                  }
                  else if( i == 2 )
                  {
                     str = "     ";
                     StaticText34->Caption = str;
                  }
                  else if( i == 3 )
                  {
                     str = "     ";
                     StaticText36->Caption = str;
                  }

                  packet[10] = 0x80;
                  packet[16] = 0x80;

                  Serial6.SetTabloPaket(i+1, packet);
                  Sleep(50);
                  if( Serial6.GetTabloPaket(i+1) )
                  {
                     TabloSys->Dev[i].NumOld = TabloSys->Dev[i].Num;
                  }
               }
               else if( TabloSys->Dev[i].NumOld == 0 && TabloSys->Dev[i].Num != 0 )
               {
                  if( i == 0 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText16->Caption = str;
                  }
                  else if( i == 1 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText32->Caption = str;
                  }
                  else if( i == 2 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText34->Caption = str;
                  }
                  else if( i == 3 )
                  {
                     str.sprintf("У%03d", TabloSys->Dev[i].Num);
                     StaticText36->Caption = str;
                  }

//                  packet[0] = 0x42;    // У
//                  packet[3] = 0x42;
//                  packet[6] = 0x42;
//                  packet[9] = 0x42;
//                  packet[12] = 0x42;
//                  packet[15] = 0x3E;
//                  packet[18] = 0x02;
//                  packet[21] = 0x42;
//                  packet[24] = 0x3C;

                  int d1 = TabloSys->Dev[i].Num/100;
                  switch( d1 )
                  {
                         case 0:
                                  packet[0] = 0x1C;    // 0
                                  packet[3] = 0x22;
                                  packet[6] = 0x22;
                                  packet[9] = 0x22 | 0x80;
                                  packet[12] = 0x22;
                                  packet[15] = 0x22 | 0x80;
                                  packet[18] = 0x22;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                         case 1:
                                  packet[0] = 0x04;    // 1
                                  packet[3] = 0x1C;
                                  packet[6] = 0x04;
                                  packet[9] = 0x04 | 0x80;
                                  packet[12] = 0x04;
                                  packet[15] = 0x04 | 0x80;
                                  packet[18] = 0x04;
                                  packet[21] = 0x04;
                                  packet[24] = 0x04;
                                  break;
                         case 2:
                                  packet[0] = 0x1C;    // 2
                                  packet[3] = 0x22;
                                  packet[6] = 0x02;
                                  packet[9] = 0x02 | 0x80;
                                  packet[12] = 0x04;
                                  packet[15] = 0x08 | 0x80;
                                  packet[18] = 0x10;
                                  packet[21] = 0x20;
                                  packet[24] = 0x3E;
                                  break;
                         case 3:
                                  packet[0] = 0x1C;    // 3
                                  packet[3] = 0x22;
                                  packet[6] = 0x02;
                                  packet[9] = 0x02 | 0x80;
                                  packet[12] = 0x0C;
                                  packet[15] = 0x02 | 0x80;
                                  packet[18] = 0x02;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                         case 4:
                                  packet[0] = 0x04;    // 4
                                  packet[3] = 0x0C;
                                  packet[6] = 0x0C;
                                  packet[9] = 0x14 | 0x80;
                                  packet[12] = 0x14;
                                  packet[15] = 0x24 | 0x80;
                                  packet[18] = 0x3E;
                                  packet[21] = 0x04;
                                  packet[24] = 0x04;
                                  break;
                         case 5:
                                  packet[0] = 0x3E;    // 5
                                  packet[3] = 0x20;
                                  packet[6] = 0x20;
                                  packet[9] = 0x3C | 0x80;
                                  packet[12] = 0x22;
                                  packet[15] = 0x02 | 0x80;
                                  packet[18] = 0x02;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                         case 6:
                                  packet[0] = 0x1C;    // 6
                                  packet[3] = 0x22;
                                  packet[6] = 0x20;
                                  packet[9] = 0x20 | 0x80;
                                  packet[12] = 0x3C;
                                  packet[15] = 0x22 | 0x80;
                                  packet[18] = 0x22;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                         case 7:
                                  packet[0] = 0x3E;    // 7
                                  packet[3] = 0x02;
                                  packet[6] = 0x04;
                                  packet[9] = 0x04 | 0x80;
                                  packet[12] = 0x08;
                                  packet[15] = 0x08 | 0x80;
                                  packet[18] = 0x10;
                                  packet[21] = 0x10;
                                  packet[24] = 0x10;
                                  break;
                         case 8:
                                  packet[0] = 0x1C;    // 8
                                  packet[3] = 0x22;
                                  packet[6] = 0x22;
                                  packet[9] = 0x22 | 0x80;
                                  packet[12] = 0x1C;
                                  packet[15] = 0x22 | 0x80;
                                  packet[18] = 0x22;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                         case 9:
                                  packet[0] = 0x1C;    // 9
                                  packet[3] = 0x22;
                                  packet[6] = 0x22;
                                  packet[9] = 0x22 | 0x80;
                                  packet[12] = 0x1E;
                                  packet[15] = 0x02 | 0x80;
                                  packet[18] = 0x02;
                                  packet[21] = 0x22;
                                  packet[24] = 0x1C;
                                  break;
                  }

                  int d2 = (TabloSys->Dev[i].Num - d1*100)/10;
                  switch( d2 )
                  {
                         case 0:
                                  packet[1] = 0x1C;    // 0
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x22;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 1:
                                  packet[1] = 0x04;    // 1
                                  packet[4] = 0x1C;
                                  packet[7] = 0x04;
                                  packet[10] = 0x04 | 0x80;
                                  packet[13] = 0x04;
                                  packet[16] = 0x04 | 0x80;
                                  packet[19] = 0x04;
                                  packet[22] = 0x04;
                                  packet[25] = 0x04;
                                  break;
                         case 2:
                                  packet[1] = 0x1C;    // 2
                                  packet[4] = 0x22;
                                  packet[7] = 0x02;
                                  packet[10] = 0x02 | 0x80;
                                  packet[13] = 0x04;
                                  packet[16] = 0x08 | 0x80;
                                  packet[19] = 0x10;
                                  packet[22] = 0x20;
                                  packet[25] = 0x3E;
                                  break;
                         case 3:
                                  packet[1] = 0x1C;    // 3
                                  packet[4] = 0x22;
                                  packet[7] = 0x02;
                                  packet[10] = 0x02 | 0x80;
                                  packet[13] = 0x0C;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 4:
                                  packet[1] = 0x04;    // 4
                                  packet[4] = 0x0C;
                                  packet[7] = 0x0C;
                                  packet[10] = 0x14 | 0x80;
                                  packet[13] = 0x14;
                                  packet[16] = 0x24 | 0x80;
                                  packet[19] = 0x3E;
                                  packet[22] = 0x04;
                                  packet[25] = 0x04;
                                  break;
                         case 5:
                                  packet[1] = 0x3E;    // 5
                                  packet[4] = 0x20;
                                  packet[7] = 0x20;
                                  packet[10] = 0x3C | 0x80;
                                  packet[13] = 0x22;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 6:
                                  packet[1] = 0x1C;    // 6
                                  packet[4] = 0x22;
                                  packet[7] = 0x20;
                                  packet[10] = 0x20 | 0x80;
                                  packet[13] = 0x3C;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 7:
                                  packet[1] = 0x3E;    // 7
                                  packet[4] = 0x02;
                                  packet[7] = 0x04;
                                  packet[10] = 0x04 | 0x80;
                                  packet[13] = 0x08;
                                  packet[16] = 0x08 | 0x80;
                                  packet[19] = 0x10;
                                  packet[22] = 0x10;
                                  packet[25] = 0x10;
                                  break;
                         case 8:
                                  packet[1] = 0x1C;    // 8
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x1C;
                                  packet[16] = 0x22 | 0x80;
                                  packet[19] = 0x22;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                         case 9:
                                  packet[1] = 0x1C;    // 9
                                  packet[4] = 0x22;
                                  packet[7] = 0x22;
                                  packet[10] = 0x22 | 0x80;
                                  packet[13] = 0x1E;
                                  packet[16] = 0x02 | 0x80;
                                  packet[19] = 0x02;
                                  packet[22] = 0x22;
                                  packet[25] = 0x1C;
                                  break;
                  }
                 int d3 = TabloSys->Dev[i].Num - d1*100 - d2*10;
                  switch( d3 )
                  {
                         case 0:
                                  packet[2] = 0x1C;    // 0
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x22;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 1:
                                  packet[2] = 0x04;    // 1
                                  packet[5] = 0x1C;
                                  packet[8] = 0x04;
                                  packet[11] = 0x04;
                                  packet[14] = 0x04;
                                  packet[17] = 0x04;
                                  packet[20] = 0x04;
                                  packet[23] = 0x04;
                                  packet[26] = 0x04;
                                  break;
                         case 2:
                                  packet[2] = 0x1C;    // 2
                                  packet[5] = 0x22;
                                  packet[8] = 0x02;
                                  packet[11] = 0x02;
                                  packet[14] = 0x04;
                                  packet[17] = 0x08;
                                  packet[20] = 0x10;
                                  packet[23] = 0x20;
                                  packet[26] = 0x3E;
                                  break;
                         case 3:
                                  packet[2] = 0x1C;    // 3
                                  packet[5] = 0x22;
                                  packet[8] = 0x02;
                                  packet[11] = 0x02;
                                  packet[14] = 0x0C;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 4:
                                  packet[2] = 0x04;    // 4
                                  packet[5] = 0x0C;
                                  packet[8] = 0x0C;
                                  packet[11] = 0x14;
                                  packet[14] = 0x14;
                                  packet[17] = 0x24;
                                  packet[20] = 0x3E;
                                  packet[23] = 0x04;
                                  packet[26] = 0x04;
                                  break;
                         case 5:
                                  packet[2] = 0x3E;    // 5
                                  packet[5] = 0x20;
                                  packet[8] = 0x20;
                                  packet[11] = 0x3C;
                                  packet[14] = 0x22;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 6:
                                  packet[2] = 0x1C;    // 6
                                  packet[5] = 0x22;
                                  packet[8] = 0x20;
                                  packet[11] = 0x20;
                                  packet[14] = 0x3C;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 7:
                                  packet[2] = 0x3E;    // 7
                                  packet[5] = 0x02;
                                  packet[8] = 0x04;
                                  packet[11] = 0x04;
                                  packet[14] = 0x08;
                                  packet[17] = 0x08;
                                  packet[20] = 0x10;
                                  packet[23] = 0x10;
                                  packet[26] = 0x10;
                                  break;
                         case 8:
                                  packet[2] = 0x1C;    // 8
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x1C;
                                  packet[17] = 0x22;
                                  packet[20] = 0x22;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                         case 9:
                                  packet[2] = 0x1C;    // 9
                                  packet[5] = 0x22;
                                  packet[8] = 0x22;
                                  packet[11] = 0x22;
                                  packet[14] = 0x1E;
                                  packet[17] = 0x02;
                                  packet[20] = 0x02;
                                  packet[23] = 0x22;
                                  packet[26] = 0x1C;
                                  break;
                  }

                  Serial6.SetTabloPaket(i+1, packet);
                  Sleep(50);
                  if( Serial6.GetTabloPaket(i+1) )
                  {
                     TabloSys->Dev[i].NumOld = TabloSys->Dev[i].Num;
                  }
               }
            }
         }
         TabloBlinkingNum = (TabloBlinkingNum+1)%2;
      }
      else if( TabloSys->SbrosTablo == 1 )
      {
         str = "===";
         StaticText16->Caption = str;
         StaticText32->Caption = str;
         StaticText34->Caption = str;
         StaticText36->Caption = str;

         TabloSys->SbrosTablo = 2;

         packet[9] = 0x7E;    // == == ==
         packet[10] = 0x7E;
         packet[11] = 0x7E;
         packet[12] = 0x7E;
         packet[13] = 0x7E;
         packet[14] = 0x7E;

         Serial6.SetTabloPaket(255, packet);
      }
      else if( TabloSys->SbrosTablo == 2 )
      {
         str = "";
         StaticText16->Caption = str;
         StaticText32->Caption = str;
         StaticText34->Caption = str;
         StaticText36->Caption = str;

         TabloSys->SbrosTablo = 0;

         Serial6.SetTabloPaket(255, packet);

         for( int i = 0; i < TabloDevCnt; i++ )
         {
            TabloSys->Dev[i].Num = 0;
            TabloSys->Dev[i].NumOld = 0;
         }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ToolBar1Resize(TObject *Sender)
{
   try
   {
      if( ToolBar1->Width > 721 )
      {
               if( TabloSys->Use )
               {
                  StaticText29->Width = ToolBar1->Width-720;
                  StaticText29->Left = 710;
                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  StaticText30->Left = 172;
                  StaticText30->Width = 86;
                  StaticText16->Left = 258;
                  StaticText16->Width = 60;
                  StaticText31->Left = 318;
                  StaticText31->Width = 10;
                  StaticText32->Left = 328;
                  StaticText32->Width = 60;
                  StaticText33->Left = 388;
                  StaticText33->Width = 10;
                  StaticText34->Left = 398;
                  StaticText34->Width = 60;
                  StaticText35->Left = 458;
                  StaticText35->Width = 10;
                  StaticText36->Left = 468;
                  StaticText36->Width = 60;
                  StaticText37->Left = 528;
                  StaticText37->Width = 10;
                  ToolButton4->Left = 538;
                  ToolButton4->Width = 86;
                  ToolButton3->Left = 624;
                  ToolButton3->Width = 86;
               }
               else
               {
                  StaticText30->Visible = false;
                  StaticText16->Visible = false;
                  StaticText31->Visible = false;
                  StaticText32->Visible = false;
                  StaticText33->Visible = false;
                  StaticText34->Visible = false;
                  StaticText35->Visible = false;
                  StaticText36->Visible = false;
                  StaticText37->Visible = false;
                  ToolButton4->Visible = false;

                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  ToolButton3->Left = 170;
                  ToolButton3->Width = 86;
                  StaticText29->Width = ToolBar1->Width-268;
                  StaticText29->Left = 258;
               }
      }
      else
      {
               if( TabloSys->Use )
               {
               }
               else
               {
                  StaticText30->Visible = false;
                  StaticText16->Visible = false;
                  StaticText31->Visible = false;
                  StaticText32->Visible = false;
                  StaticText33->Visible = false;
                  StaticText34->Visible = false;
                  StaticText35->Visible = false;
                  StaticText36->Visible = false;
                  StaticText37->Visible = false;
                  ToolButton4->Visible = false;
               }
      }
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowPrCnt()
{
   if( Table1->Active )
   {
       if( !Table1->IsEmpty() )
       {
             int Pr_cnt1 = 0;
             int Pr_cnt2 = 0;

             Table1->DisableControls();

             TBookmark mark = Table1->GetBookmark();

             Table1->First();
             while( !Table1->Eof )
             {
                if( !Table1Flag->AsBoolean )
                {
                   if( Table1Type->AsInteger == 2 ||
                       Table1Type->AsInteger == 6 ||
                       Table1Type->AsInteger == 7 ||
                       Table1Type->AsInteger == 10 ||
                       Table1Type->AsInteger == 11 ||
                       Table1Type->AsInteger == 12 ||
                       Table1Type->AsInteger == 13 ||
                       Table1Type->AsInteger == 15 ||
                       Table1Type->AsInteger == 16 ||
                       Table1Type->AsInteger == 17 ||
                       Table1Type->AsInteger == 18 ||
                       Table1Type->AsInteger == 20 ||
                       Table1Type->AsInteger == 21 ||
                       Table1Type->AsInteger == 22 ||
                       Table1Type->AsInteger == 23 ||
                       Table1Type->AsInteger == 24 ||
                       Table1Type->AsInteger == 25 ||
                       Table1Type->AsInteger == 26 ||
                       Table1Type->AsInteger == 27 ||
                       Table1Type->AsInteger == 30 ||
                       Table1Type->AsInteger == 31 ||
                       Table1Type->AsInteger == 112 ||
                       Table1Type->AsInteger == 113 ||
                       Table1Type->AsInteger == 130 ||
                       Table1Type->AsInteger == 131 ||
                       Table1Type->AsInteger == 132 ||
                       Table1Type->AsInteger == 134 ||
                       Table1Type->AsInteger == 135 ||
                       Table1Type->AsInteger == 136 ||
                       Table1Type->AsInteger == 137 ||
                       Table1Type->AsInteger == 138 ||
                       Table1Type->AsInteger == 141 ||
                       Table1Type->AsInteger == 142 ||
                       Table1Type->AsInteger == 150 ||
                       Table1Type->AsInteger == 151 ||
                       Table1Type->AsInteger == 160 ||
                       Table1Type->AsInteger == 170 ||
                       Table1Type->AsInteger == 171 ||
                       Table1Type->AsInteger == 172 ||
                       Table1Type->AsInteger == 173 ||
                       Table1Type->AsInteger == 174 ||
                       Table1Type->AsInteger == 175 ||
                       Table1Type->AsInteger == 200 ||
                       Table1Type->AsInteger == 201 ||
                       Table1Type->AsInteger == 202 ||
                       Table1Type->AsInteger == 203 ||
                       Table1Type->AsInteger == 204 ||
                       Table1Type->AsInteger == 901 ||
                       Table1Type->AsInteger == 1000 ||
                       Table1Type->AsInteger == 1001 ||
                       Table1Type->AsInteger == 1002 ||
                       Table1Type->AsInteger == 1003 ||
                       Table1Type->AsInteger == 1004 )
                   {
                      if( P1 && Table1Comment->IsNull ) Pr_cnt1 += 1;

                      if( P2 && Table1Comment2->IsNull ) Pr_cnt2 += 1;

                   }
                }
                Table1->Next();
             }
//             Table1->Last();


             Table1->GotoBookmark(mark);
             Table1->FreeBookmark(mark);

             Table1->EnableControls();

             if( Pr_cnt1 > 0 && P1 ) StaticText38->Caption = IntToStr(Pr_cnt1);
             else StaticText38->Caption = "";

             Label75->Visible = P1;
             StaticText38->Visible = P1;

             if( Pr_cnt2 > 0 && P2 ) StaticText39->Caption = IntToStr(Pr_cnt2);
             else StaticText39->Caption = "";

             Label76->Visible = P2;
             StaticText39->Visible = P2;
      }
   }
}
//---------------------------------------------------------------------------
/*
void TMainForm::AutoToFile( AnsiString fn, int flag, int packet[100], int cmd, bool in, int adr )
{
   int iFileHandle;
   AnsiString str, str2;
   unsigned short hour, min, sec, msec;

   TDateTime dt = Now();

   try
   {
      dt.DecodeTime(&hour, &min, &sec, &msec);
      str.sprintf("[%02d:%02d:%02d:%03d] Flag=%d", hour, min, sec, msec, flag );

      if( in )
      {
         str2.sprintf("%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X",
                  packet[0], packet[1], packet[2], packet[3], packet[4], packet[5], packet[6], packet[7], packet[8], packet[9],
                  packet[10], packet[11], packet[12], packet[13], packet[14], packet[15], packet[16], packet[17], packet[18], packet[19],
                  packet[20], packet[21], packet[22], packet[23], packet[24], packet[25], packet[26], packet[27], packet[28], packet[29] );

         str = str + " R__Packet: " + str2 + "\n";
      }
      else
      {
         if( adr == 101 ) adr = 0xFF;
         str2.sprintf("%02X", cmd);
         str = str + " S_Command: " + str2 + " Adr= " + IntToStr(adr) + "\n";
      }

      if( !FileExists(fn) ) iFileHandle = FileCreate(fn);
      else iFileHandle = FileOpen(fn, fmOpenWrite);

      int iFileLength;
      iFileLength = FileSeek(iFileHandle,0,2);

      if( iFileLength > 100000 )
      {
         FileClose(iFileHandle);
         DeleteFile(fn);
         if( !FileExists(fn) ) iFileHandle = FileCreate(fn);
         else iFileHandle = FileOpen(fn, fmOpenWrite);
         iFileLength = FileSeek(iFileHandle,0,2);
      }

      FileWrite(iFileHandle, str.c_str(), str.Length());
      FileClose(iFileHandle);
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
//*/
void __fastcall TMainForm::AsoosdClientSocketConnect(TObject *Sender,
      TCustomWinSocket *Socket)
{
   for( int i = 0; i < 100; i++ )
   {
      if( Asoosd_str[i].Length() > 0 )
      {
         Socket->SendText(Asoosd_str[i]);
         Asoosd_str[i] = "";
      }
   }

   AsoosdClientSocket->Active = false;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::AsoosdClientSocketError(TObject *Sender,
      TCustomWinSocket *Socket, TErrorEvent ErrorEvent, int &ErrorCode)
{
   try
   {
      ErrorCode = 0;
   }
   catch(...)
   {
      ;
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::ILivedTimerTimer(TObject *Sender)
{
   AnsiString fn = ExtractFileName(Application->ExeName);
   AnsiString tmps;
   int gyear1, gmonth1, gday1, ghour1, gmin1, gec1;

   if( ILivedCnt == 0 )
   {
      tmps.sprintf("%s.gs1", fn);
      ILivedCnt = 1;
   }
   else
   {
      tmps.sprintf("%s.gs2", fn);
      ILivedCnt = 0;
   }

   fn = ExtractFilePath(Application->ExeName) + tmps;
   GoodCloseOpen(fn, gyear1, gmonth1, gday1, ghour1, gmin1, gec1);
}
//---------------------------------------------------------------------------
void TMainForm::ResetTochkaMDiagInfo( int type, int num2 )
{
   if( type == TochkaMBoIdx || type == TochkaMUchIdx )
      GroupBox10->Caption = "Диагностика: Точка-М/Гарда-М";
   else if( type == SotaMBoIdx || type == SotaMUchIdx )
      GroupBox10->Caption = "Диагностика: Сота/Сота-М";

   GroupBox10->Height = 368;

   AdvStringGrid1->DefaultRowHeight = 21;

   if( type == TochkaMBoIdx )
   {
      AdvStringGrid1->ColCount = 29;
      AdvStringGrid1->RowCount = 22;
      AdvStringGrid1->ClearRows(0,22);

      AdvStringGrid1->ColWidths[0] = 150;
      AdvStringGrid1->Cells[0][0] = "Параметр";
      AdvStringGrid1->ColWidths[1] = 40;
      AdvStringGrid1->Cells[1][0] = "Зн-е";
      AdvStringGrid1->ColWidths[2] = 150;

      for( int cnt = 3; cnt < 29; cnt++ )
      {
         AdvStringGrid1->ColWidths[cnt] = 25;
      }

      GroupBox10->Height =  AdvStringGrid1->RowCount*AdvStringGrid1->DefaultRowHeight + 25;

      AdvStringGrid1->Cells[0][1]="Готовность БОД";
      AdvStringGrid1->Cells[0][2]="Выход \"Тревога Уч.1\"";
      AdvStringGrid1->Cells[0][3]="Выход \"Тревога Уч.2\"";
      AdvStringGrid1->Cells[0][4]="Выход \"Тревога Уч.3\"";
      AdvStringGrid1->Cells[0][5]="Выход \"Тревога Уч.4\"";
      AdvStringGrid1->Cells[0][6]="Тревога Уч.1 была";
      AdvStringGrid1->Cells[0][7]="Тревога Уч.2 была";
      AdvStringGrid1->Cells[0][8]="Тревога Уч.3 была";
      AdvStringGrid1->Cells[0][9]="Тревога Уч.4 была";

      AdvStringGrid1->Cells[0][10]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][11]="Состояние \"ДК\" было";
      AdvStringGrid1->Cells[0][12]="Вход \"Вскрытие БО\"";
      AdvStringGrid1->Cells[0][13]="Вскрытие БО было";

      AdvStringGrid1->Cells[2][0] = "Параметр";
      AdvStringGrid1->Cells[2][1] = "Участки 1-2";
      AdvStringGrid1->Cells[2][2] = "ДДискретный";
      AdvStringGrid1->Cells[2][3] = "Сработка по ЧЭ1 было";
      AdvStringGrid1->Cells[2][4] = "Сработка по ЧЭ2 было";
      AdvStringGrid1->Cells[2][5] = "Неисправн. по ЧЭ1 есть";
      AdvStringGrid1->Cells[2][6] = "Неисправн. по ЧЭ2 есть";
      AdvStringGrid1->Cells[2][7] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][8] = "Обрыв связи с ДД был";
      AdvStringGrid1->Cells[2][9] = "Вскрытие ДД есть";
      AdvStringGrid1->Cells[2][10] = "Вскрытие ДД было";

      AdvStringGrid1->Cells[2][12] = "Участки 3-4";
      AdvStringGrid1->Cells[2][13] = "ДДискретный";
      AdvStringGrid1->Cells[2][14] = "Сработка по ЧЭ1 было";
      AdvStringGrid1->Cells[2][15] = "Сработка по ЧЭ2 было";
      AdvStringGrid1->Cells[2][16] = "Неисправн. по ЧЭ1 есть";
      AdvStringGrid1->Cells[2][17] = "Неисправн. по ЧЭ2 есть";
      AdvStringGrid1->Cells[2][18] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][19] = "Обрыв связи с ДД был";
      AdvStringGrid1->Cells[2][20] = "Вскрытие ДД есть";
      AdvStringGrid1->Cells[2][21] = "Вскрытие ДД было";

      AnsiString str;
      for( int i = 0; i < 26; i++ )
      {
         str.sprintf("%02d ", i+1 );
         AdvStringGrid1->Cells[i+3][2] = str;

         str.sprintf("%02d ", i+1 );
         AdvStringGrid1->Cells[i+3][13] = str;
      }
   }
   else if( type == TochkaMDdIdx  )
   {
      AdvStringGrid1->ColCount = 4;
      AdvStringGrid1->RowCount = 14;

      AdvStringGrid1->ClearRows(0,14);

      AdvStringGrid1->ColWidths[0] = 150;
      AdvStringGrid1->ColWidths[1] = 100;
      AdvStringGrid1->ColWidths[2] = 150;
      AdvStringGrid1->ColWidths[3] = 100;

      AdvStringGrid1->Cells[0][0]="Параметр";
      AdvStringGrid1->Cells[1][0]="Значение";
      AdvStringGrid1->Cells[2][0]="Параметр";
      AdvStringGrid1->Cells[3][0]="Значение";

      AdvStringGrid1->Cells[0][1]="Готовность БОД";
      AdvStringGrid1->Cells[0][2]="Выход \"Тревога Уч.1\"";
      AdvStringGrid1->Cells[0][3]="Выход \"Тревога Уч.2\"";
      AdvStringGrid1->Cells[0][4]="Выход \"Тревога Уч.3\"";
      AdvStringGrid1->Cells[0][5]="Выход \"Тревога Уч.4\"";
      AdvStringGrid1->Cells[0][6]="Тревога Уч.1 была";
      AdvStringGrid1->Cells[0][7]="Тревога Уч.2 была";
      AdvStringGrid1->Cells[0][8]="Тревога Уч.3 была";
      AdvStringGrid1->Cells[0][9]="Тревога Уч.4 была";

      AdvStringGrid1->Cells[0][10]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][11]="Состояние \"ДК\" было";
      AdvStringGrid1->Cells[0][12]="Вход \"Вскрытие БО\"";
      AdvStringGrid1->Cells[0][13]="Вскрытие БО было";

      AdvStringGrid1->Cells[2][1]="Сработка по ЧЭ1 была";
      AdvStringGrid1->Cells[2][2]="Сработка по ЧЭ2 была";
      AdvStringGrid1->Cells[2][3]="Обрыв по ЧЭ1 есть";
      AdvStringGrid1->Cells[2][4]="Замыкание по ЧЭ1 есть";
      AdvStringGrid1->Cells[2][5]="Обрыв по ЧЭ2 есть";
      AdvStringGrid1->Cells[2][6]="Замыкание по ЧЭ2 есть";
      AdvStringGrid1->Cells[2][7]="Неисправность ДД";

      AdvStringGrid1->Cells[2][8]="Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][9]="Обрыв связи с ДД был";
      AdvStringGrid1->Cells[2][10]="Вскрытие ДД есть";
      AdvStringGrid1->Cells[2][11]="Вскрытие ДД был";
      AdvStringGrid1->Cells[2][12]="Уровень сигнала ЧЭ1";
      AdvStringGrid1->Cells[2][13]="Уровень сигнала ЧЭ2";
   }
   else if( type == SotaMBoIdx )
   {
      AdvStringGrid1->ColCount = 53;
      AdvStringGrid1->RowCount = 20;
      AdvStringGrid1->ClearRows(0,20);

      AdvStringGrid1->ColWidths[0] = 150;
      AdvStringGrid1->Cells[0][0] = "Параметр";
      AdvStringGrid1->ColWidths[1] = 40;
      AdvStringGrid1->Cells[1][0] = "Зн-е";
      AdvStringGrid1->ColWidths[2] = 150;

      for( int cnt = 3; cnt < 53; cnt++ )
      {
         AdvStringGrid1->ColWidths[cnt] = 25;
      }

      GroupBox10->Height =  AdvStringGrid1->RowCount*AdvStringGrid1->DefaultRowHeight + 40;

      AdvStringGrid1->Cells[0][1]="Готовность БОД";
      AdvStringGrid1->Cells[0][2]="Выход \"Тревога Уч.1\"";
      AdvStringGrid1->Cells[0][3]="Выход \"Тревога Уч.2\"";
      AdvStringGrid1->Cells[0][4]="Выход \"Тревога Уч.3\"";
      AdvStringGrid1->Cells[0][5]="Выход \"Тревога Уч.4\"";
      AdvStringGrid1->Cells[0][6]="Тревога Уч.1 была";
      AdvStringGrid1->Cells[0][7]="Тревога Уч.2 была";
      AdvStringGrid1->Cells[0][8]="Тревога Уч.3 была";
      AdvStringGrid1->Cells[0][9]="Тревога Уч.4 была";

      AdvStringGrid1->Cells[0][10]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][11]="Состояние \"ДК\" было";
      AdvStringGrid1->Cells[0][12]="Вход \"Вскрытие БО\"";
      AdvStringGrid1->Cells[0][13]="Вскрытие БО было";

      AdvStringGrid1->Cells[2][0] = "Параметр";
      AdvStringGrid1->Cells[2][1] = "Участки 1-2";
      AdvStringGrid1->Cells[2][2] = "ДД";
      AdvStringGrid1->Cells[2][3] = "Сработка ДД была";
      AdvStringGrid1->Cells[2][4] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][5] = "Обрыв связи с ДД был";

      AdvStringGrid1->Cells[2][6] = "ДД";
      AdvStringGrid1->Cells[2][7] = "Сработка ДД была";
      AdvStringGrid1->Cells[2][8] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][9] = "Обрыв связи с ДД был";

      AdvStringGrid1->Cells[2][11] = "Участки 3-4";
      AdvStringGrid1->Cells[2][12] = "ДД";
      AdvStringGrid1->Cells[2][13] = "Сработка ДД была";
      AdvStringGrid1->Cells[2][14] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][15] = "Обрыв связи с ДД был";

      AdvStringGrid1->Cells[2][16] = "ДД";
      AdvStringGrid1->Cells[2][17] = "Сработка ДД была";
      AdvStringGrid1->Cells[2][18] = "Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][19] = "Обрыв связи с ДД был";

      AnsiString str;
      for( int i = 0; i < 50; i++ )
      {
         str.sprintf("%02d", i+1 );
         AdvStringGrid1->Cells[i+3][2] = str;
         str.sprintf("%02d", i+51 );
         AdvStringGrid1->Cells[i+3][6] = str;
         str.sprintf("%02d", i+1 );
         AdvStringGrid1->Cells[i+3][12] = str;
         str.sprintf("%02d", i+51 );
         AdvStringGrid1->Cells[i+3][16] = str;
      }
   }
   else if( type == SotaMDdIdx  )
   {
      AdvStringGrid1->ColCount = 4;
      AdvStringGrid1->RowCount = 14;

      AdvStringGrid1->ClearRows(0,14);

      AdvStringGrid1->ColWidths[0] = 150;
      AdvStringGrid1->ColWidths[1] = 100;
      AdvStringGrid1->ColWidths[2] = 150;
      AdvStringGrid1->ColWidths[3] = 100;

      AdvStringGrid1->Cells[0][0]="Параметр";
      AdvStringGrid1->Cells[1][0]="Значение";
      AdvStringGrid1->Cells[2][0]="Параметр";
      AdvStringGrid1->Cells[3][0]="Значение";

      AdvStringGrid1->Cells[0][1]="Готовность БОД";
      AdvStringGrid1->Cells[0][2]="Выход \"Тревога Уч.1\"";
      AdvStringGrid1->Cells[0][3]="Выход \"Тревога Уч.2\"";
      AdvStringGrid1->Cells[0][4]="Выход \"Тревога Уч.3\"";
      AdvStringGrid1->Cells[0][5]="Выход \"Тревога Уч.4\"";
      AdvStringGrid1->Cells[0][6]="Тревога Уч.1 была";
      AdvStringGrid1->Cells[0][7]="Тревога Уч.2 была";
      AdvStringGrid1->Cells[0][8]="Тревога Уч.3 была";
      AdvStringGrid1->Cells[0][9]="Тревога Уч.4 была";

      AdvStringGrid1->Cells[0][10]="Вход \"ДК\"";
      AdvStringGrid1->Cells[0][11]="Состояние \"ДК\" было";
      AdvStringGrid1->Cells[0][12]="Вход \"Вскрытие БО\"";
      AdvStringGrid1->Cells[0][13]="Вскрытие БО было";

      AdvStringGrid1->Cells[2][1]="Сработка была";
      AdvStringGrid1->Cells[2][2]="Обрыв связи с ДД есть";
      AdvStringGrid1->Cells[2][3]="Обрыв связи с ДД был";
      AdvStringGrid1->Cells[2][4]="Вскрытие ДД есть";
      AdvStringGrid1->Cells[2][5]="Неисправность ДД есть";
      AdvStringGrid1->Cells[2][6]="Тревога по Ф1 есть";
      AdvStringGrid1->Cells[2][7]="Тревога по Ф2 есть";
      AdvStringGrid1->Cells[2][8]="Опрос ДД";
      AdvStringGrid1->Cells[2][9]="Уровень сигнала";
   }
}
//---------------------------------------------------------------------------
void TMainForm::ShowDiagTochkaMInfo( int kn, int adr, int packet[1000] )
{
   if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ||
       POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx  ||
       POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ||
       POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
   {
         bool Bod_Ok = false;

         int p = 0;
         p = packet[6] & 0x01;
         if( p == 0x01 ) { AdvStringGrid1->Cells[1][1]="<1>"; Bod_Ok = true; }
         else AdvStringGrid1->Cells[1][1]="<0>";

         if( Bod_Ok )
         {
            p = packet[5] & 0x01;
            if( p == 0x01 ) AdvStringGrid1->Cells[1][2]="[1]";
            else AdvStringGrid1->Cells[1][2]="[0]";
         }
         else AdvStringGrid1->Cells[1][2]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x02;
            if( p == 0x02 ) AdvStringGrid1->Cells[1][3]="[1]";
            else AdvStringGrid1->Cells[1][3]="[0]";
         }
         else AdvStringGrid1->Cells[1][3]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x04;
            if( p == 0x04 ) AdvStringGrid1->Cells[1][4]="[1]";
            else AdvStringGrid1->Cells[1][4]="[0]";
         }
         else AdvStringGrid1->Cells[1][4]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x08;
            if( p == 0x08 ) AdvStringGrid1->Cells[1][5]="[1]";
            else AdvStringGrid1->Cells[1][5]="[0]";
         }
         else AdvStringGrid1->Cells[1][5]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x10;
            if( p == 0x10 ) AdvStringGrid1->Cells[1][6]="[1]";
            else AdvStringGrid1->Cells[1][6]="[0]";
         }
         else AdvStringGrid1->Cells[1][6]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x20;
            if( p == 0x20 ) AdvStringGrid1->Cells[1][7]="[1]";
            else AdvStringGrid1->Cells[1][7]="[0]";
         }
         else AdvStringGrid1->Cells[1][7]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x40;
            if( p == 0x40 ) AdvStringGrid1->Cells[1][8]="[1]";
            else AdvStringGrid1->Cells[1][8]="[0]";
         }
         else AdvStringGrid1->Cells[1][8]="";

         if( Bod_Ok )
         {
            p = packet[5] & 0x80;
            if( p == 0x80 ) AdvStringGrid1->Cells[1][9]="[1]";
            else AdvStringGrid1->Cells[1][9]="[0]";
         }
         else AdvStringGrid1->Cells[1][9]="";

         if( Bod_Ok )
         {
            p = packet[6] & 0x10;
            if( p == 0x10 ) AdvStringGrid1->Cells[1][10]="[1]";
            else AdvStringGrid1->Cells[1][10]="[0]";
         }
         else AdvStringGrid1->Cells[1][10]="";

         if( Bod_Ok )
         {
            p = packet[6] & 0x20;
            if( p == 0x20 ) AdvStringGrid1->Cells[1][11]="[1]";
            else AdvStringGrid1->Cells[1][11]="[0]";
         }
         else AdvStringGrid1->Cells[1][11]="";

         if( Bod_Ok )
         {
            p = packet[6] & 0x40;
            if( p == 0x40 ) AdvStringGrid1->Cells[1][12]="[1]";
            else AdvStringGrid1->Cells[1][12]="[0]";
         }
         else AdvStringGrid1->Cells[1][12]="";

         if( Bod_Ok )
         {
            p = packet[6] & 0x80;
            if( p == 0x80 ) AdvStringGrid1->Cells[1][13]="[1]";
            else AdvStringGrid1->Cells[1][13]="[0]";
         }
         else AdvStringGrid1->Cells[1][13]="";

         int cnt = 3;
         if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx || POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx  )
         {
            for( int i = 0; i < 26; i++ )
            {
               cnt = 3;
               if( RifSys->Rk[kn][adr].Status[0] != 10 && Bod_Ok )
               {
                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].T1[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].T2[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].N1[0] ) AdvStringGrid1->Cells[i+3][cnt] = "{1}";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].N2[0] ) AdvStringGrid1->Cells[i+3][cnt] = "{1}";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].Ss[0] )  AdvStringGrid1->Cells[i+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].S[0] )  AdvStringGrid1->Cells[i+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].Sv[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i].V[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 4;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].T1[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].T2[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].N1[0] ) AdvStringGrid1->Cells[i+3][cnt] = "{1}";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].N2[0] ) AdvStringGrid1->Cells[i+3][cnt] = "{1}";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].Ss[0] )  AdvStringGrid1->Cells[i+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].S[0] )  AdvStringGrid1->Cells[i+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].Sv[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[i+26].Use ) AdvStringGrid1->Cells[i+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[i+26].V[0] ) AdvStringGrid1->Cells[i+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[i+3][cnt] = "[0]";
                  }
               }
               else
               {
                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 4;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
                   cnt += 1;

                   AdvStringGrid1->Cells[i+3][cnt] = "";
               }
            }
         }
         else
         {
            for( int dd = 0; dd < 50; dd++ )
            {
               cnt = 3;
               if( RifSys->Rk[kn][adr].Status[0] != 10 && Bod_Ok )
               {
                  if( !RifSys->Rk[kn][adr].Dd[dd].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd].T1[0] ) AdvStringGrid1->Cells[dd+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd].Ss[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd].S[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 2;

                  if( !RifSys->Rk[kn][adr].Dd[dd+50].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+50].T1[0] ) AdvStringGrid1->Cells[dd+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+50].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+50].Ss[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+50].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+50].S[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 4;

                  if( !RifSys->Rk[kn][adr].Dd[dd+100].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+100].T1[0] ) AdvStringGrid1->Cells[dd+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+100].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+100].Ss[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+100].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+100].S[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 2;

                  if( !RifSys->Rk[kn][adr].Dd[dd+150].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+150].T1[0] ) AdvStringGrid1->Cells[dd+3][cnt] = "[1]";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+150].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+150].Ss[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
                  cnt += 1;

                  if( !RifSys->Rk[kn][adr].Dd[dd+150].Use ) AdvStringGrid1->Cells[dd+3][cnt] = "";
                  else
                  {
                     if( RifSys->Rk[kn][adr].Dd[dd+150].S[0] )  AdvStringGrid1->Cells[dd+3][cnt] = "(1)";
                     else AdvStringGrid1->Cells[dd+3][cnt] = "[0]";
                  }
               }
               else
               {
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 2;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 4;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 2;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
                  cnt += 1;
                  AdvStringGrid1->Cells[dd+3][cnt] = "";
               }
            }
         }
   }
}
//---------------------------------------------------------------------------
bool TMainForm::ShowDiagTochkaMInfo2( int type, int num2, int num3, int packet[1000], int adress, int ddnum )
{
   bool ResetCmd = false;

   if( packet[1] == 0xFE && packet[2] == adress && (packet[3] == 61 || packet[3] == 106) && packet[4] == 0x31 && (packet[59] == ddnum || packet[107] == ddnum) )
   {
      bool Bod_Ok = false;

      int p = 0;
      p = packet[6] & 0x01;
      if( p == 0x01 ) { AdvStringGrid1->Cells[1][1]="<1>"; Bod_Ok = true; }
      else AdvStringGrid1->Cells[1][1]="<0>";

      if( Bod_Ok )
      {
       p = packet[5] & 0x01;
       if( p == 0x01 ) AdvStringGrid1->Cells[1][2]="[1]";
       else AdvStringGrid1->Cells[1][2]="[0]";
      }
      else AdvStringGrid1->Cells[1][2]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x02;
       if( p == 0x02 ) AdvStringGrid1->Cells[1][3]="[1]";
       else AdvStringGrid1->Cells[1][3]="[0]";
      }
      else AdvStringGrid1->Cells[1][3]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x04;
       if( p == 0x04 ) AdvStringGrid1->Cells[1][4]="[1]";
       else AdvStringGrid1->Cells[1][4]="[0]";
      }
      else AdvStringGrid1->Cells[1][4]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x08;
       if( p == 0x08 ) AdvStringGrid1->Cells[1][5]="[1]";
       else AdvStringGrid1->Cells[1][5]="[0]";
      }
      else AdvStringGrid1->Cells[1][5]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x10;
       if( p == 0x10 ) { AdvStringGrid1->Cells[1][6]="[1]"; ResetCmd = true; }
       else AdvStringGrid1->Cells[1][6]="[0]";
      }
      else AdvStringGrid1->Cells[1][6]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x20;
       if( p == 0x20 ) { AdvStringGrid1->Cells[1][7]="[1]"; ResetCmd = true; }
       else AdvStringGrid1->Cells[1][7]="[0]";
      }
      else AdvStringGrid1->Cells[1][7]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x40;
       if( p == 0x40 ) { AdvStringGrid1->Cells[1][8]="[1]"; ResetCmd = true; }
       else AdvStringGrid1->Cells[1][8]="[0]";
      }
      else AdvStringGrid1->Cells[1][8]="";

      if( Bod_Ok )
      {
       p = packet[5] & 0x80;
       if( p == 0x80 ) { AdvStringGrid1->Cells[1][9]="[1]"; ResetCmd = true; }
       else AdvStringGrid1->Cells[1][9]="[0]";
      }
      else AdvStringGrid1->Cells[1][9]="";

      if( Bod_Ok )
      {
       p = packet[6] & 0x10;
       if( p == 0x10 ) AdvStringGrid1->Cells[1][10]="[1]";
       else AdvStringGrid1->Cells[1][10]="[0]";
      }
      else AdvStringGrid1->Cells[1][10]="";

      if( Bod_Ok )
      {
       p = packet[6] & 0x20;
       if( p == 0x20 ) AdvStringGrid1->Cells[1][11]="[1]";
       else AdvStringGrid1->Cells[1][11]="[0]";
      }
      else AdvStringGrid1->Cells[1][11]="";

      if( Bod_Ok )
      {
       p = packet[6] & 0x40;
       if( p == 0x40 ) AdvStringGrid1->Cells[1][12]="[1]";
       else AdvStringGrid1->Cells[1][12]="[0]";
      }
      else AdvStringGrid1->Cells[1][12]="";

      if( Bod_Ok )
      {
       p = packet[6] & 0x80;
       if( p == 0x80 ) { AdvStringGrid1->Cells[1][13]="[1]"; ResetCmd = true; }
       else AdvStringGrid1->Cells[1][13]="[0]";
      }
      else AdvStringGrid1->Cells[1][13]="";

      int p2 = 0;
      if( type == TochkaMDdIdx )
      {
         if( ddnum > 0x80)  ddnum = ddnum - 0x80 + 26;

         p = packet[60]&0xFF;
         p = p<<8;
         p2 = packet[61]&0xFF;
         p = p | p2;
         if( Bod_Ok ) AdvStringGrid1->Cells[3][12] = p;
         else AdvStringGrid1->Cells[3][12] = "";

         p = packet[62]&0xFF;
         p = p<<8;
         p2 = packet[63]&0xFF;
         p = p | p2;
         if( Bod_Ok ) AdvStringGrid1->Cells[3][13] = p;
         else AdvStringGrid1->Cells[3][13] = "";

         if( Bod_Ok )
         {
           p = packet[64] & 0x01;
           if( p == 0x01 )
           {
               AdvStringGrid1->Cells[3][1]="Да [1]";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][1]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][1]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x02;
           if( p == 0x02 )
           {
               AdvStringGrid1->Cells[3][2]="Да [1]";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][2]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][2]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x04;
           if( p == 0x04 )
           {
               AdvStringGrid1->Cells[3][3]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][3]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][3]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x10;
           if( p == 0x10 )
           {
               AdvStringGrid1->Cells[3][5]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][5]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][5]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x08;
           if( p == 0x08 )
           {
               AdvStringGrid1->Cells[3][4]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][4]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][4]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x20;
           if( p == 0x20 )
           {
               AdvStringGrid1->Cells[3][6]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][6]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][6]="";
         }

         if( Bod_Ok )
         {
           p = packet[64] & 0x40;
           if( p == 0x40 )
           {
               AdvStringGrid1->Cells[3][7]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][7]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][7]="";
         }

         if( Bod_Ok )
         {
           p = packet[65] & 0x10;
           if( p == 0x10 )
           {
               AdvStringGrid1->Cells[3][8]="Да (1)";
           }
           else
           {
               AdvStringGrid1->Cells[3][8]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][8]="";
         }

         if( Bod_Ok )
         {
           p = packet[65] & 0x20;
           if( p == 0x20 )
           {
               AdvStringGrid1->Cells[3][9]="Да (1)";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][9]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][9]="";
         }

         if( Bod_Ok )
         {
           p = packet[65] & 0x40;
           if( p == 0x40 )
           {
               AdvStringGrid1->Cells[3][10]="Да [1]";
           }
           else
           {
               AdvStringGrid1->Cells[3][10]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][10]="";
         }

         if( Bod_Ok )
         {
           p = packet[65] & 0x80;
           if( p == 0x80 )
           {
               AdvStringGrid1->Cells[3][11]="Да [1]";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][11]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][11]="";
         }
      }
      else
      {
         if( ddnum > 0x80)  ddnum = ddnum - 0x80 + 100;

         p = packet[108]&0xFF;
         p = p<<8;
         p2 = packet[109]&0xFF;
         p = p | p2;
         if( Bod_Ok ) AdvStringGrid1->Cells[3][9] = p;
         else AdvStringGrid1->Cells[3][9] = "";

         if( Bod_Ok )
         {
           p = packet[110] & 0x01;
           if( p == 0x01 )
           {
               AdvStringGrid1->Cells[3][1]="Да [1]";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][1]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][1]="";
         }

         if( Bod_Ok )
         {
           p = packet[110] & 0x02;
           if( p == 0x02 )
           {
               AdvStringGrid1->Cells[3][2]="Да (1)";
           }
           else
           {
               AdvStringGrid1->Cells[3][2]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][2]="";
         }

         if( Bod_Ok )
         {
           p = packet[110] & 0x04;
           if( p == 0x04 )
           {
               AdvStringGrid1->Cells[3][3]="Да (1)";
               ResetCmd = true;
           }
           else
           {
               AdvStringGrid1->Cells[3][3]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][3]="";
         }

         if( Bod_Ok )
         {
           p = packet[110] & 0x08;
           if( p == 0x08 )
           {
               AdvStringGrid1->Cells[3][4]="Да [1]";
           }
           else
           {
               AdvStringGrid1->Cells[3][4]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][4]="";
         }

         if( Bod_Ok )
         {
           p = packet[110] & 0x10;
           if( p == 0x10 )
           {
               AdvStringGrid1->Cells[3][5]="Да {1}";
           }
           else
           {
               AdvStringGrid1->Cells[3][5]="Нет [0]";
           }
         }
         else
         {
            AdvStringGrid1->Cells[3][5]="";
         }

         if( Bod_Ok )
         {
           p = packet[110] & 0x20;
           if( p == 0x20 ) AdvStringGrid1->Cells[3][6]="Да [1]";
           else AdvStringGrid1->Cells[3][6]="Нет [0]";
         }
         else AdvStringGrid1->Cells[3][6]="";

         if( Bod_Ok )
         {
           p = packet[110] & 0x40;
           if( p == 0x40 ) AdvStringGrid1->Cells[3][7]="Да [1]";
           else AdvStringGrid1->Cells[3][7]="Нет [0]";
         }
         else AdvStringGrid1->Cells[3][7]="";

         if( Bod_Ok )
         {
           p = packet[110] & 0x80;
           if( p == 0x80 ) AdvStringGrid1->Cells[3][8]="Вкл [1]";
           else AdvStringGrid1->Cells[3][8]="Выкл [0]";
         }
         else AdvStringGrid1->Cells[3][8]="";
      }
   }

   return ResetCmd;
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::N6Click(TObject *Sender)
{
   ObjTree->FullExpand();
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::CfgTimerTimer(TObject *Sender)
{
   if( POutObj(lpMapPlan)->ImgOperationId == POutObj(lpMapCfg)->ImgOperationId )
      POutObj(lpMapCfg)->ImgOperationId = 0;
   else
   {
      if( POutObj(lpMapPlan)->ImgOperationId == 4  &&
          POutObj(lpMapPlan)->ImgOperationId != POutObj(lpMapCfg)->ImgOperationId ) 
      {
         int type = 0, num1 = 0, num2 = 0, num3 = 0;
         AnsiString str, str1, str2;
         str = POutObj(lpMapPlan)->ImgName;
         sscanf(str.c_str(),"img_%d_%d_%d_%d", &type, &num1, &num2, &num3);
         if( type == 44 ) { type = 43, num3 +=3; }

         DiagRif->Adr = 0;
         DiagRif->Port = 1;
         DiagRif->Reset();
         DiagKonc->Adr = 0;
         DiagKonc->Port = 1;
         DiagKonc->Reset();

         if( type > 0 )
         {
             ObjTree->Items->BeginUpdate();
             for( int i = 0; i < ObjTree->Items->Count; i++ )
             {
                if( type == PCfgObj(ObjTree->Items->Item[i]->Data)->Type &&
                    num1 == PCfgObj(ObjTree->Items->Item[i]->Data)->Num1 &&
                    num2 == PCfgObj(ObjTree->Items->Item[i]->Data)->Num2 &&
                    num3 == PCfgObj(ObjTree->Items->Item[i]->Data)->Num3 )
                {
//                   MainForm->SetFocus();
//                   ObjTree->TabStop = true;
//                   TShiftState sh;
//                   sh << ssLeft;
//                   ObjTree->Select( ObjTree->Items->Item[i], sh );

                   ObjTree->Items->EndUpdate();
                   MainForm->SetFocus();
                   ObjTree->SetFocus();

                   ObjTree->Items->Item[i]->Selected = true;

                   ObjTreeClick(this);
                   break;
                }
            }
            ObjTree->Items->EndUpdate();
         }
         ObjTree->Items->EndUpdate();

         POutObj(lpMapCfg)->ImgOperationId = 6;
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::AlarmsReset( bool netuser )
{
   ToolButton2->Down = true;
   Table1->DisableControls();

   if( !netuser ) SetSob( 903, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0 );
   else SetSob( 1903, 0, 0, 0, 0, SetSobStr02, OpFn, OpN1, OpN2, "", "", "", false, 0 );

   P123 = false;

   Table1->First();
   while( !Table1->Eof )
   {
      P12 = false;

      if( !Table1Flag->AsBoolean )
      {
         if( Table1Type->AsInteger == 2 ||
             Table1Type->AsInteger == 6 ||
             Table1Type->AsInteger == 7 ||
             Table1Type->AsInteger == 10 ||
             Table1Type->AsInteger == 11 ||
             Table1Type->AsInteger == 12 ||
             Table1Type->AsInteger == 13 ||
             Table1Type->AsInteger == 15 ||
             Table1Type->AsInteger == 16 ||
             Table1Type->AsInteger == 17 ||
             Table1Type->AsInteger == 18 ||
             Table1Type->AsInteger == 20 ||
             Table1Type->AsInteger == 21 ||
             Table1Type->AsInteger == 22 ||
             Table1Type->AsInteger == 23 ||
             Table1Type->AsInteger == 24 ||
             Table1Type->AsInteger == 25 ||
             Table1Type->AsInteger == 26 ||
             Table1Type->AsInteger == 27 ||
             Table1Type->AsInteger == 30 ||
             Table1Type->AsInteger == 31 ||
             Table1Type->AsInteger == 112 ||
             Table1Type->AsInteger == 113 ||
             Table1Type->AsInteger == 130 ||
             Table1Type->AsInteger == 131 ||
             Table1Type->AsInteger == 132 ||
             Table1Type->AsInteger == 134 ||
             Table1Type->AsInteger == 135 ||
             Table1Type->AsInteger == 136 ||
             Table1Type->AsInteger == 137 ||
             Table1Type->AsInteger == 138 ||
             Table1Type->AsInteger == 141 ||
             Table1Type->AsInteger == 142 ||
             Table1Type->AsInteger == 150 ||
             Table1Type->AsInteger == 151 ||
             Table1Type->AsInteger == 160 ||
             Table1Type->AsInteger == 170 ||
             Table1Type->AsInteger == 171 ||
             Table1Type->AsInteger == 172 ||
             Table1Type->AsInteger == 173 ||
             Table1Type->AsInteger == 174 ||
             Table1Type->AsInteger == 175 ||
             Table1Type->AsInteger == 200 ||
             Table1Type->AsInteger == 201 ||
             Table1Type->AsInteger == 202 ||
             Table1Type->AsInteger == 203 ||
             Table1Type->AsInteger == 204 ||
             Table1Type->AsInteger == 901 ||
             Table1Type->AsInteger == 906 ||
             Table1Type->AsInteger == 1000 ||
             Table1Type->AsInteger == 1001 ||
             Table1Type->AsInteger == 1002 ||
             Table1Type->AsInteger == 1003 ||
             Table1Type->AsInteger == 1004 ||
             Table1Type->AsInteger == 1005 ||
             Table1Type->AsInteger == 1006 )
         {
            if( P1 && Table1Comment->IsNull ) { P12 = true; P123 = true; }

            if( P2 && Table1Comment2->IsNull ) { P12 = true; P123 = true; }

            if( !P12 )
            {
               Table1->Edit();
               Table1Flag->AsBoolean = true;
            }
         }
         else
         {
            Table1->Edit();
            Table1Flag->AsBoolean = true;
         }
      }

      Table1->Next();
   }
   Table1->Last();

   Table1->EnableControls();

   ShowPrCnt();

   POprosOutObj(lpMapOpros)->AlarmResetFlag = true;
   MyDelay(300);

   for( int kn = 0; kn < RifKanCnt; kn++ )
      for( int adr = 0; adr < RifDevCnt; adr++ )
      {
         if( RifSys->Rk[kn][adr].Type == TochkaMBoIdx || RifSys->Rk[kn][adr].Type == SotaMBoIdx )
         {
            RifSys->Rk[kn][adr].StatusBO[1] = -1;
            RifSys->Rk[kn][adr].StatusOld[0] = -2;
            RifSys->Rk[kn][adr].Uch[0].StatusUch[1] = -1;
            RifSys->Rk[kn][adr].Uch[1].StatusUch[1] = -1;
            RifSys->Rk[kn][adr].Uch[2].StatusUch[1] = -1;
            RifSys->Rk[kn][adr].Uch[3].StatusUch[1] = -1;
         }
         
         for( int i = 0; i < MaxInCnt; i++ )
            POprosOutObj(lpMapOpros)->RifRk[kn][adr*MaxInCnt+i] = 0;

         for( int i = 0; i < MaxTochkaMUchCnt+MaxTochkaMDdCnt; i++ )
            POprosOutObj(lpMapOpros)->TochkaM[kn][i] = 0;
      }

      for( int kan = 0; kan < KanCnt; kan++ )
      for( int bl = 0; bl < BlCnt; bl++ )
      {
         for( int sd = 0; sd < SdCnt; sd++ )
         {
            POprosOutObj(lpMapOpros)->GobiSd[kan*SdCnt*BlCnt+SdCnt*bl+sd] = 0;

            if( GobiFixNewWarning == 1 )
            {
               if( GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix != 1 /*&& !GobiSys->Kanal[kan].Bl[bl].Sd[sd].Bazalt */)
               {
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusFix = -1;
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].status1 = 1;
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld = 1;
                  GobiSys->Kanal[kan].Bl[bl].Sd[sd].StatusOld2 = -1;
               }
            }
         }

         for( int iu = 0; iu < IuCnt; iu++ )
         {
            POprosOutObj(lpMapOpros)->GobiIu[kan*IuCnt*BlCnt+IuCnt*bl+iu] = 0;
            POprosOutObj(lpMapOpros)->GobiVk[kan*IuCnt*BlCnt+IuCnt*bl+iu] = 0;
         }
      }

      SolidSys->ResetTv();

      for( int i = 0; i < MaxGobiCamCnt; i++ )
      {
         GobiSys->GobiCam[i].k = -1;
         GobiSys->GobiCam[i].bl = -1;
         GobiSys->GobiCam[i].iu = -1;
         GobiSys->GobiCam2[i].k = -1;
         GobiSys->GobiCam2[i].bl = -1;
         GobiSys->GobiCam2[i].iu = -1;
      }

      if( Server2->Socket->ActiveConnections != 0 )
      {
         AnsiString str = "start ";
         str = str + handCamstr + " off" + " finish";
         for( int i = 0; i < Server2->Socket->ActiveConnections; i++ )
            Server2->Socket->Connections[i]->SendText(str);
      }

      for( int i = 0; i < 18; i++ ) cam485[i] = 0;
      for( int i = 0; i < 6; i++ ) cam485_sn[i] = "";
      cam485str = "";

      ObjTree->Items->BeginUpdate();
      for( int i = 0; i < ObjTree->Items->Count; i++ )
      {
        if( PCfgObj(ObjTree->Items->Item[i]->Data)->Type == DevLineIdx )
           PCfgObj(ObjTree->Items->Item[i]->Data)->IconVisible = false;
      }
      ObjTree->Items->EndUpdate();

      for( int cam = 0; cam < 200; cam++ )
      {
         if( se1[cam].hProcess != NULL || ShowDevLineCam[cam]  )
         {
            HANDLE m_hProcessHandle = se1[cam].hProcess;
            if( TerminateProcess(m_hProcessHandle, 0) )
            {
               ShowDevLineCam[cam] = false;
               ZeroMemory ( &se1[cam], sizeof (se1[cam]) );
            }
         }
      }
/*
    HANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    HANDLE hProcess;
    bool Result = true;

    PROCESSENTRY32 *ProcEntry = new PROCESSENTRY32();
    AnsiString FileName;

    if( ProcEntry != INVALID_HANDLE_VALUE )
    {
       Process32First(hSnapshot, ProcEntry);
       FileName = ExtractFileName(StrPas(ProcEntry->szExeFile));
       if( FileName == "OBSERVER.EXE" )
       {
         hProcess = OpenProcess(PROCESS_TERMINATE, false, ProcEntry->th32ProcessID);
         if(TerminateProcess(hProcess, 0)); //Ok
       }
       while(Result)
       {
         Result = Process32Next(hSnapshot, ProcEntry);
         if(Result)
         {
            FileName = ExtractFileName(StrPas(ProcEntry->szExeFile));
            if(FileName == "observer.exe")
            {
               hProcess = OpenProcess(PROCESS_TERMINATE, false, ProcEntry->th32ProcessID);
               if(TerminateProcess(hProcess, 0)); //Ok
            }
         }
       }
    }
    delete ProcEntry;
    CloseHandle(hSnapshot);
*/
   AlarmFlag = false;
}
//---------------------------------------------------------------------------
void TMainForm::DbStart( bool netuser, bool autostart )
{
   bool dbs = false;

   if( !netuser && !autostart )
   {
      if( MessageBox (NULL,MsgStr17.c_str(), WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK ) dbs = true;
   }
   else dbs = true;


   if( dbs )
   {
      AlarmResetItemClick(this);

      if( P123 && !netuser && !autostart )
      {
         MessageBox (NULL, MsgStr24.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
      }
      else
      {
         AnsiString of, on1, on2;

         if( OpList->Use && !netuser && !autostart )
         {
            of = OpFn;
            on1 = OpN1;
            on2 = OpN2;

            OperatorsDlg = new TOperatorsDlg(this);
            OperatorsDlg->ShowModal();
            delete OperatorsDlg;
         }

         if( OpList->Use && OpFn.Length() == 0 && !netuser && !autostart )
         {
            OpFn = of;
            OpN1 = on1;
            OpN2 = on2;

            MessageBox (NULL, MsgStr10.c_str(), ErrorMsg.c_str(),MB_OK|MB_ICONERROR);
         }
         else
         {
            AnsiString str;

            if( OpList->Use && !netuser && !autostart )
            {
               if( TabloSys->Use )
               {
                  StaticText29->Width = ToolBar1->Width-720;
                  StaticText29->Left = 710;
                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  StaticText30->Left = 172;
                  StaticText30->Width = 86;
                  StaticText16->Left = 258;
                  StaticText16->Width = 60;
                  StaticText31->Left = 318;
                  StaticText31->Width = 10;
                  StaticText32->Left = 328;
                  StaticText32->Width = 60;
                  StaticText33->Left = 388;
                  StaticText33->Width = 10;
                  StaticText34->Left = 398;
                  StaticText34->Width = 60;
                  StaticText35->Left = 458;
                  StaticText35->Width = 10;
                  StaticText36->Left = 468;
                  StaticText36->Width = 60;
                  StaticText37->Left = 528;
                  StaticText37->Width = 10;
                  ToolButton4->Left = 538;
                  ToolButton4->Width = 86;
                  ToolButton3->Left = 624;
                  ToolButton3->Width = 86;
               }
               else
               {
                  StaticText30->Visible = false;
                  StaticText16->Visible = false;
                  StaticText31->Visible = false;
                  StaticText32->Visible = false;
                  StaticText33->Visible = false;
                  StaticText34->Visible = false;
                  StaticText35->Visible = false;
                  StaticText36->Visible = false;
                  StaticText37->Visible = false;
                  ToolButton4->Visible = false;

                  ToolButton1->Left = 0;
                  ToolButton1->Width = 86;
                  ToolButton2->Left = 86;
                  ToolButton2->Width = 86;
                  ToolButton3->Left = 170;
                  ToolButton3->Width = 86;
                  StaticText29->Width = ToolBar1->Width-268;
                  StaticText29->Left = 258;
               }

               str.sprintf("%s: %s", MsgStr23, OpFn);
               if( OpN1 != "(null)") str = str + " " + OpN1;
               if( OpN2 != "(null)" ) str = str + " " + OpN2;

               StaticText29->Caption = str;
               if( ToolBar1->Width > 721 )
               {
                  if( TabloSys->Use )
                  {
                     StaticText29->Width = ToolBar1->Width-720;
                     StaticText29->Left = 710;
                  }
                  else
                  {
                     StaticText29->Width = ToolBar1->Width-268;
                     StaticText29->Left = 258;
                  }
               }
            }

            Table1->DisableControls();
            Table1->Active = false;
            Table1->DeleteTable();
            SetTbl1();
            Table1->Active = true;
            if( !netuser ) SetSob( 902, 0, 0, 0, 0, SetSobStr02 , OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else SetSob( 1902, 0, 0, 0, 0, SetSobStr02 , OpFn, OpN1, OpN2, "", "", "", false, 0 );

            Table1->EnableControls();

            BackupAll();
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::Dk_Rif( bool netuser )
{
   if( !netuser ) SetSob( 133, 0, 0, 0, 0, "РИФ Общий", OpFn, OpN1, OpN2, "", "", "", false, 0 );
   else SetSob( 1133, 0, 0, 0, 0, "РИФ Общий", OpFn, OpN1, OpN2, "", "", "", false, 0 );

   for( int kn = 0; kn < RifKanCnt; kn++ )
   {
      if( RifPortNum[kn] != 0 && RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].DkUse[0] )
      {
         for( int i = 0; i < RifDevCnt; i++ )
         {
            for( int j = 0; j < MaxInCnt; j++ )
            {
               if( RifSys->Rk[kn][i].Use && RifSys->Rk[kn][i].Status[j] == 1 &&
                   RifSys->Rk[kn][i].DkUse[j] )
               {
                  if( RifSys->Rk[kn][i].Type != SdIpBlType && RifSys->Rk[kn][i].Type != TochkaMBoIdx && RifSys->Rk[kn][i].Type != SotaMBoIdx )
                  {
                     if( RifSys->Rk[kn][i].Cmd == 0x22 )
                     {
                        RifSys->Rk[kn][i].Cmd = 0x21;
                        RifSys->Rk[kn][i].CmdCnt = 0;
                        RifSys->Rk[kn][i].AutoDk = false;
                        RifSys->Rk[kn][i].AutoDkCnt = 0;
                     }
                  }
                  else if( RifSys->Rk[kn][i].Type == SdIpBlType )
                  {
                     RifSys->Rk[kn][i].Dk = true;
                     break;
                  }
                  else if( RifSys->Rk[kn][i].Type == TochkaMBoIdx || RifSys->Rk[kn][i].Type == SotaMBoIdx )
                  {
                     RifTimer[kn]->Enabled = false;

                     MyDelay(300);

                     int flag = 0;
                     int packet[1000];
                     int temp = 0, t1 = 0;
                     int adress = i+1;

                      bool flfl = false;
                      for( int rsi = 0; rsi < 5; rsi++ )
                      {
                         if( !flfl )
                         {
                            flag = RifSerial[kn].SetCmd3( adress, 0x21, true);
                            if( RifSys->Rk[kn][i].Type == TochkaMBoIdx ) MyDelay(200);
                            else MyDelay(300);
                            flag = RifSerial[kn].GetPaket( adress, packet );
                            if( flag > 0 && packet[4] == 0x30 )
                            {
                              flfl = true;
                              break;
                            }
                         }
                      }

//                      int tint = RifTimerInterval[kn];
//                      tint = RifSys->OprosCnt[kn] * tint;
//                      RifSys->Rk[kn][i].DkCnt = 15000/tint;
                      RifSys->Rk[kn][i].DkCnt = 5;

                      RifTimer[kn]->Enabled = true;

                      if( flfl )
                      {
                         RifSys->Rk[kn][adress-1].Dk = true;
                      }
                      else
                      {
                        SetSob( 13,
                                POprosObj(ObjTree->Selected->Data)->Type,
                                POprosObj(ObjTree->Selected->Data)->Num1,
                                POprosObj(ObjTree->Selected->Data)->Num2,
                                POprosObj(ObjTree->Selected->Data)->Num3,
                                POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                      }
                  }
               }
            }
         }
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::Dk_Ssoi( bool netuser )
{
   if( SsoiVersion != 2 )
   {
       if( ComplexVersion != Rastr_M_SsoiComplexType )
       {
          if( !GobiDkTimer->Enabled )
          {
             GobiDkCnt = 0;
             GobiDkTimer->Enabled = true;
          }
       }
       else
       {
          if( GobiSys->Kanal[0].Use ) Dk_Ssoi_Kan( netuser, 0 );
          if( GobiSys->Kanal[1].Use ) Dk_Ssoi_Kan( netuser, 1 );
          if( GobiSys->Kanal[2].Use ) Dk_Ssoi_Kan( netuser, 2 );
          if( GobiSys->Kanal[3].Use ) Dk_Ssoi_Kan( netuser, 3 );
       }
   }
   else
   {
      if( SsoiM_PortNum[0] != 0 ) Dk_Ssoi_Kan( netuser, 0 );
      if( SsoiM_PortNum[1] != 0 ) Dk_Ssoi_Kan( netuser, 1 );
      if( SsoiM_PortNum[2] != 0 ) Dk_Ssoi_Kan( netuser, 2 );
      if( SsoiM_PortNum[3] != 0 ) Dk_Ssoi_Kan( netuser, 3 );
   }
}
//---------------------------------------------------------------------------
void TMainForm::Dk_Ssoi_Kan( bool netuser, int kan )
{
   AnsiString str;
   if( SsoiVersion != 2 )
   {
       if( GobiSys->Status != 200 && GobiSys->Kanal[kan].hCmd == 0)
       {
         GobiSys->Kanal[kan].hCmd = 1;
         str.sprintf(" %d", kan+1);
         str = SetSobStr04 + str;
         if( !netuser ) SetSob( 133, 0, 0, 0, kan, str, OpFn, OpN1, OpN2, "", "", "", false, 0 );
         else SetSob( 1133, 0, 0, 0, kan, str, OpFn, OpN1, OpN2, "", "", "", false, 0 );
       }
   }
   else
   {
       if( SsoiM_PortNum[kan] != 0 )
       {
          for( int bl = 0; bl < BlCnt; bl++ )
          {
             if( GobiSys2->Bl[kan][bl].Use && GobiSys2->Bl[kan][bl].DkStatus == 0 )
             {
                bool tempflag = false;
                for( int sd = 0; sd < SdCnt; sd++ )
                {
                   GobiSys2->Bl[kan][bl].Sd[sd].DkOk = false;
                   if( GobiSys2->Bl[kan][bl].Sd[sd].StatusOld == 1 ) tempflag = true;
                }

                if( tempflag )
                {
                   GobiSys2->Bl[kan][bl].DkStatus = 1;
                   str.sprintf(" %d", bl+1);
                   str = SetSobStr05 + str;
                   if( !netuser ) SetSob( 133, 0, 0, kan+1, bl+1, str, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   else SetSob( 1133, 0, 0, kan+1, bl+1, str, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                }
             }
          }
       }
   }
}
//---------------------------------------------------------------------------
void TMainForm::Dk_Dev( bool netuser )
{
   int kn = POprosObj(ObjTree->Selected->Data)->Num3-1;

   if( POprosObj(ObjTree->Selected->Data)->Type == 1 || POprosObj(ObjTree->Selected->Data)->Type == 8 ||
       POprosObj(ObjTree->Selected->Data)->Type == 9 || POprosObj(ObjTree->Selected->Data)->Type == 91 ||
       POprosObj(ObjTree->Selected->Data)->Type == 10 || POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType )
   {
      if( RifPortNum[kn] != 0 && RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].DkUse[0] )
      {
         if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 1 ||
             POprosObj(ObjTree->Selected->Data)->Type == 10  )
         {
            if(!netuser) SetSob( 133,
                                 POprosObj(ObjTree->Selected->Data)->Type,
                                 POprosObj(ObjTree->Selected->Data)->Num1,
                                 POprosObj(ObjTree->Selected->Data)->Num2,
                                 POprosObj(ObjTree->Selected->Data)->Num3,
                                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else  SetSob( 1133,
                                 POprosObj(ObjTree->Selected->Data)->Type,
                                 POprosObj(ObjTree->Selected->Data)->Num1,
                                 POprosObj(ObjTree->Selected->Data)->Num2,
                                 POprosObj(ObjTree->Selected->Data)->Num3,
                                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );

            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x21;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AutoDkCnt = 0;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AutoDk = false;
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 2 )
   {
      if( RifPortNum[kn] != 0 && RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].DkUse[POprosObj(ObjTree->Selected->Data)->Num2-1] )
      {
         if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] == 1 &&
             RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].DkUse[POprosObj(ObjTree->Selected->Data)->Num2-1] )
         {
            if(!netuser) SetSob( 133,
                                 POprosObj(ObjTree->Selected->Data)->Type,
                                 POprosObj(ObjTree->Selected->Data)->Num1,
                                 POprosObj(ObjTree->Selected->Data)->Num2,
                                 POprosObj(ObjTree->Selected->Data)->Num3,
                                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else  SetSob( 1133,
                                 POprosObj(ObjTree->Selected->Data)->Type,
                                 POprosObj(ObjTree->Selected->Data)->Num1,
                                 POprosObj(ObjTree->Selected->Data)->Num2,
                                 POprosObj(ObjTree->Selected->Data)->Num3,
                                 POprosObj(ObjTree->Selected->Data)->Name,  OpFn, OpN1, OpN2, "", "", "", false, 0 );


            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Cmd = 0x21;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].CmdCnt = 0;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AutoDkCnt = 0;
            RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].AutoDk = false;
         }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 3 && SsoiM_PortNum[0] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;

      if( GobiSys->Kanal[kan].hCmd == 0)
      {
         GobiSys->Kanal[kan].hCmd = 1;
         AnsiString str;
         str.sprintf(" %d", kan+1);
         str = SetSobStr04 + str;
         SetSob( 133, 3, 0, 0, kan, str,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 33 && SsoiM_PortNum[POprosObj(ObjTree->Selected->Data)->Num1-1] != 0 )
   {
      int kan = POprosObj(ObjTree->Selected->Data)->Num1-1;
      int bl = POprosObj(ObjTree->Selected->Data)->Num2-1;
      int sd = POprosObj(ObjTree->Selected->Data)->Num3-1;

      if( GobiSys2->Bl[kan][bl].DkStatus == 0 &&
          GobiSys2->Bl[kan][bl].Sd[sd].StatusOld == 1 )
      {
         for( int i = 0; i < SdCnt; i++ ) GobiSys2->Bl[kan][bl].Sd[i].DkOk = false;
         GobiSys2->Bl[kan][bl].DkStatus = 1;

         AnsiString str;
         str.sprintf(" %d", bl+1);
         str = SetSobStr05 + str;
         if(!netuser) SetSob( 133, 33, kan+1, bl+1, sd+1, str,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
         else SetSob( 1133, 33, kan+1, bl+1, sd+1, str,  OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == SdIpBlType )
   {
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      if( !POprosObj(ObjTree->Selected->Data)->UdpUse )
      {
          if( !DemoMode )
          {
             RifSys->Rk[num3-1][IpBlIdx].Dk = true;
             RifSys->Rk[num3-1][IpBlIdx].AutoDk = false;
          }

          if(!netuser) SetSob( 133,
                               POprosObj(ObjTree->Selected->Data)->Type,
                               POprosObj(ObjTree->Selected->Data)->Num1,
                               POprosObj(ObjTree->Selected->Data)->Num2,
                               POprosObj(ObjTree->Selected->Data)->Num3,
                               POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          else  SetSob( 1133,
                               POprosObj(ObjTree->Selected->Data)->Type,
                               POprosObj(ObjTree->Selected->Data)->Num1,
                               POprosObj(ObjTree->Selected->Data)->Num2,
                               POprosObj(ObjTree->Selected->Data)->Num3,
                               POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          if( DemoMode )
          {
                RifSys->Rk[num3-1][IpBlIdx].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] = 3;
                SetSob( 3,
                               POprosObj(ObjTree->Selected->Data)->Type,
                               POprosObj(ObjTree->Selected->Data)->Num1,
                               POprosObj(ObjTree->Selected->Data)->Num2,
                               POprosObj(ObjTree->Selected->Data)->Num3,
                               POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                RifSys->Rk[num3-1][IpBlIdx].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] = 1;
          }
      }
      else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
      {
          int pos = UdpAdress->IndexOf(POprosObj(ObjTree->Selected->Data)->UdpAdress);
          if( pos >= 0  )
          {
              if(!netuser) SetSob( 133,
                                   POprosObj(ObjTree->Selected->Data)->Type,
                                   POprosObj(ObjTree->Selected->Data)->Num1,
                                   POprosObj(ObjTree->Selected->Data)->Num2,
                                   pos+1,
                                   POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
              else  SetSob( 1133,
                                   POprosObj(ObjTree->Selected->Data)->Type,
                                   POprosObj(ObjTree->Selected->Data)->Num1,
                                   POprosObj(ObjTree->Selected->Data)->Num2,
                                   pos+1,
                                   POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
             Rif2Sys->Ch[pos].Dev[IpBlIdx].Cmd = 3;
             Rif2Sys->Ch[pos].Dev[IpBlIdx].CmdCnt = 0;
             Rif2Sys->Ch[pos].Dev[IpBlIdx].DkGoing = true;

             double t = 10.0*1.157407E-05;
             t = t * 100000.0;
             CGauge1->MaxValue = t;
             CGauge1->Progress = 0;
             GroupBox5->Caption = "Выполнение команды ДК";
             GroupBox5->Visible = true;
          }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx )
   {
      if( RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].Status[0] == 1 &&
          RifSys->Rk[kn][POprosObj(ObjTree->Selected->Data)->Num1-1].StatusBO[0] == 1 )
      {
          RifTimer[kn]->Enabled = false;
          if(!netuser)SetSob( 133,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          else SetSob( 1133,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

          MyDelay(300);

          int flag = 0;
          int packet[1000];
          int temp = 0, t1 = 0;
          int adress = POprosObj(ObjTree->Selected->Data)->Num1;

          RifSerial[kn].GetPaket( adress, packet );

           bool flfl = false;
           for( int rsi = 0; rsi < 5; rsi++ )
           {
              if( !flfl )
              {
                 flag = RifSerial[kn].SetCmd3( adress, 0x21, true);
                 if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ) MyDelay(200);
                 else MyDelay(300);
                 flag = RifSerial[kn].GetPaket( adress, packet );
                 if( flag > 0 && packet[4] == 0x30 )
                 {
                   flfl = true;
                   break;
                 }
              }
          }

          RifSys->Rk[kn][adress-1].DkCnt = 5;
          RifSys->Rk[kn][adress-1].AutoDk = false;

          RifTimer[kn]->Enabled = true;

          if( flfl )
          {
             RifSys->Rk[kn][adress-1].Dk = true;
          }
          else
          {
             SetSob( 13,
                  POprosObj(ObjTree->Selected->Data)->Type,
                  POprosObj(ObjTree->Selected->Data)->Num1,
                  POprosObj(ObjTree->Selected->Data)->Num2,
                  POprosObj(ObjTree->Selected->Data)->Num3,
                  POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::DBGrid1DblClick(TObject *Sender)
{
   if( iServerUse )
   {
      int otype = Table1Dtype->AsInteger;
      int onum1 = Table1Dnum1->AsInteger;
      int onum2 = Table1Dnum2->AsInteger;
      int onum3 = Table1Dnum3->AsInteger;

      int id = 0;
      int level = 0;

      double lan = 0.0;
      double lon = 0.0;
      AnsiString description;

      int flangnum = 0;
      int uchnum = 0;
      int dvnum = 0;
      int num21 = 0;

      switch( otype )
      {
         case 0:
                 break;
         case 1:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case RifRlmSType: 
                 otype = 99;
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case 2: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 break;
         case 3: 
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].lon;
                 description = GobiSys->Kanal[onum1-1].Bl[onum2-1].Sd[onum3-1].description;
                 break;
         case 33: 
                 id = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].TreeIdx;
                 lan = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lan;
                 lon = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].lon;
                 description = GobiSys2->Bl[onum1-1][onum2-1].Sd[onum3-1].description;
                 break;
         case 4:
                 id = GobiSys->Kanal[onum1-1].Bl[onum2-1].Iu[onum3-1].TreeIdx;
                 break;
         case 5: 
                 break;
         case 6: 
                 break;
         case 7: 
                 id = A4068Sys->Dev[onum1-1].TreeIdx[onum2];
                 break;
         case 8: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case 9: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case 10: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2-1];
                 break;
         case 11:
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1];
                 lan = RifSys->Rk[onum3-1][IpBlIdx].lan[onum2-1];
                 lon = RifSys->Rk[onum3-1][IpBlIdx].lon[onum2-1];
                 description = RifSys->Rk[onum3-1][IpBlIdx].description[onum2-1];
                 break;
         case 12: 
                 id = RifSys->Rk[onum3-1][IpBlIdx].TreeIdx[onum2-1+MaxIpBlSdCnt];
                 break;
         case 26:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case 27:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 break;
         case 28:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 break;
         case 29:
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
         case 30:
                 num21 = onum2/100-1;
                 id = RifSys->Rk[onum3-1][onum1-1].Uch[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Uch[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Uch[num21].description;
                 break;
         case 31:
                 num21 = onum2%100;
                 if( onum2 >= 300 ) num21 += 26;
                 id = RifSys->Rk[onum3-1][onum1-1].Dd[num21].TreeIdx;
                 lan = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lan;
                 lon = RifSys->Rk[onum3-1][onum1-1].Dd[num21].lon;
                 description = RifSys->Rk[onum3-1][onum1-1].Dd[num21].description;
                 break;
         case 21: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[onum2];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[onum2];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[onum2];
                 description = RifSys->Rk[onum3-1][onum1-1].description[onum2];
                 break;
         case 41:
                 break;
         case 42: 
                 break;
         case 51: 
                 break;
         case 91: 
                 id = RifSys->Rk[onum3-1][onum1-1].TreeIdx[0];
                 lan = RifSys->Rk[onum3-1][onum1-1].lan[0];
                 lon = RifSys->Rk[onum3-1][onum1-1].lon[0];
                 description = RifSys->Rk[onum3-1][onum1-1].description[0];
                 break;
      }

      ObjTree->Items->BeginUpdate();
      if( id >=0 && id < ObjTree->Items->Count ) level = ObjTree->Items->Item[id]->Level;
      else level = 0;
      ObjTree->Items->EndUpdate();

      AnsiString str;
      str = "<RIFPlusPacket type=\"EventBook\">";
      EventsAndStates->Add(str);
      str = "<devices>";
      EventsAndStates->Add(str);

      str.sprintf("<device id=\"%d\" level=\"%d\" type=\"%d\" num1=\"%d\" num2=\"%d\" num3=\"%d\" name=\"%s\" lat=\"%10.8f\" lon=\"%10.8f\" description=\"%s\">",
                  id, level, otype, onum1, onum2, onum3, Table1Name->AsString, lan, lon, description );
      EventsAndStates->Add(str);
      str.sprintf("<states>");
      EventsAndStates->Add(str);

      AnsiString dt_str = FormatDateTime("yyyy-mm-dd hh:nn:ss",Table1Dt->AsDateTime);
      str.sprintf("<state id=\"%d\" datetime=\"%s\" name=\"%s\"/>",
                  Table1Type->AsInteger, dt_str, Table1Type2Str->AsString );
      EventsAndStates->Add(str);

      str.sprintf("</states>");
      EventsAndStates->Add(str);

      str.sprintf("</device>");
      EventsAndStates->Add(str);

      str = "</devices>";
      EventsAndStates->Add(str);

      str = "</RIFPlusPacket>";
      EventsAndStates->Add(str);
   }
}
//---------------------------------------------------------------------------
void TMainForm::Control_Dev( bool netuser )
{
   int num1 = POprosObj(ObjTree->Selected->Data)->Num1-1;
   int num2 = POprosObj(ObjTree->Selected->Data)->Num2-1;
   int num3 = POprosObj(ObjTree->Selected->Data)->Num3-1;
   int kn = num3;

   AnsiString str;
   int n = 0;
   if( POprosObj(ObjTree->Selected->Data)->Type == 1 || POprosObj(ObjTree->Selected->Data)->Type == 8 ||
       POprosObj(ObjTree->Selected->Data)->Type == 9 || POprosObj(ObjTree->Selected->Data)->Type == 91 ||
       POprosObj(ObjTree->Selected->Data)->Type == RifRlmSType  )
   {
         if( !netuser )
         {
            if( RifSys->Rk[kn][num1].AlarmFix[0] ) str = MsgStr15;
            else str = MsgStr16;

            if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
            {
               RifSys->Rk[kn][num1].AlarmFix[0] = !RifSys->Rk[kn][num1].AlarmFix[0];

               if( !RifSys->Rk[kn][num1].AlarmFix[0] )
                  SetSob( 136,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
               else
                  SetSob( 137,
                          POprosObj(ObjTree->Selected->Data)->Type,
                          POprosObj(ObjTree->Selected->Data)->Num1,
                          POprosObj(ObjTree->Selected->Data)->Num2,
                          POprosObj(ObjTree->Selected->Data)->Num3,
                          POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

               RifSys->Rk[kn][num1].StatusOld[0] = -1;
            }
         }
         else
         {
            RifSys->Rk[kn][num1].AlarmFix[0] = !RifSys->Rk[kn][num1].AlarmFix[0];

            if( !RifSys->Rk[kn][num1].AlarmFix[0] )
              SetSob( 1136,
                      POprosObj(ObjTree->Selected->Data)->Type,
                      POprosObj(ObjTree->Selected->Data)->Num1,
                      POprosObj(ObjTree->Selected->Data)->Num2,
                      POprosObj(ObjTree->Selected->Data)->Num3,
                      POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else
              SetSob( 1137,
                      POprosObj(ObjTree->Selected->Data)->Type,
                      POprosObj(ObjTree->Selected->Data)->Num1,
                      POprosObj(ObjTree->Selected->Data)->Num2,
                      POprosObj(ObjTree->Selected->Data)->Num3,
                      POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            RifSys->Rk[kn][num1].StatusOld[0] = -1;
         }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 11 )
   {
      if( !POprosObj(ObjTree->Selected->Data)->UdpUse ) 
      {
          if( !RifSys->Rk[kn][IpBlIdx].Bazalt[num2] )
          {
              if( !netuser )
              {
                 if( RifSys->Rk[kn][IpBlIdx].AlarmFix[num2] ) str = MsgStr15;
                 else str = MsgStr16;

                 if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
                 {
                    RifSys->Rk[kn][IpBlIdx].AlarmFix[num2] = !RifSys->Rk[kn][IpBlIdx].AlarmFix[num2];

                    if( !RifSys->Rk[kn][IpBlIdx].AlarmFix[num2] )
                       SetSob( 136,
                               POprosObj(ObjTree->Selected->Data)->Type,
                               POprosObj(ObjTree->Selected->Data)->Num1,
                               POprosObj(ObjTree->Selected->Data)->Num2,
                               POprosObj(ObjTree->Selected->Data)->Num3,
                               POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                    else
                       SetSob( 137,
                               POprosObj(ObjTree->Selected->Data)->Type,
                               POprosObj(ObjTree->Selected->Data)->Num1,
                               POprosObj(ObjTree->Selected->Data)->Num2,
                               POprosObj(ObjTree->Selected->Data)->Num3,
                               POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                    RifSys->Rk[kn][IpBlIdx].StatusOld[num2] = -1;

                    if( DemoMode )
                    {
                       int packet[1000];
                       memset(packet,0,1000);

                       bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                       ShowNewRkStatus(RifSys->Rk[kn][IpBlIdx].Status[num2],IpBlIdx, kn, 0, Tin_IpBl, packet );
                    }
                 }
              }
              else
              {
                  RifSys->Rk[kn][IpBlIdx].AlarmFix[num2] = !RifSys->Rk[kn][IpBlIdx].AlarmFix[num2];

                  if( !RifSys->Rk[kn][IpBlIdx].AlarmFix[num2] )
                     SetSob( 1136,
                             POprosObj(ObjTree->Selected->Data)->Type,
                             POprosObj(ObjTree->Selected->Data)->Num1,
                             POprosObj(ObjTree->Selected->Data)->Num2,
                             POprosObj(ObjTree->Selected->Data)->Num3,
                             POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                  else
                     SetSob( 1137,
                             POprosObj(ObjTree->Selected->Data)->Type,
                             POprosObj(ObjTree->Selected->Data)->Num1,
                             POprosObj(ObjTree->Selected->Data)->Num2,
                             POprosObj(ObjTree->Selected->Data)->Num3,
                             POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                  RifSys->Rk[kn][IpBlIdx].StatusOld[num2] = -1;
                  if( DemoMode )
                  {
                       int packet[1000];
                       memset(packet,0,1000);

                       bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
                       ShowNewRkStatus(RifSys->Rk[kn][IpBlIdx].Status[num2],IpBlIdx, kn, 0, Tin_IpBl, packet );
                  }
              }
          }
      }
      else if( POprosObj(ObjTree->Selected->Data)->UdpAdress != "" && POprosObj(ObjTree->Selected->Data)->UpdPort > 0 )
      {
        if( Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].AlarmFix ) str = MsgStr15;
        else str = MsgStr16;

        if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
        {
           Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].AlarmFix = !Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].AlarmFix;

           if( !Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].AlarmFix )
           {
              if( !netuser ) SetSob( 136,
                                     POprosObj(ObjTree->Selected->Data)->Type,
                                     POprosObj(ObjTree->Selected->Data)->Num1,
                                     POprosObj(ObjTree->Selected->Data)->Num2,
                                     POprosObj(ObjTree->Selected->Data)->Num3,
                                     POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
              else SetSob( 1136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
           }
           else
           {
               if( !netuser )SetSob( 137,
                                     POprosObj(ObjTree->Selected->Data)->Type,
                                     POprosObj(ObjTree->Selected->Data)->Num1,
                                     POprosObj(ObjTree->Selected->Data)->Num2,
                                     POprosObj(ObjTree->Selected->Data)->Num3,
                                     POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
              else SetSob( 1137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
           }

           Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].T[1] = -1;
           Rif2Sys->Ch[num3].Dev[IpBlIdx].Sd[num2].St[1] = -1;
        }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 2 || POprosObj(ObjTree->Selected->Data)->Type == 21
            || POprosObj(ObjTree->Selected->Data)->Type == 10)
   {
      if( !netuser )
      {
         if( RifSys->Rk[kn][num1].AlarmFix[num2] ) str = MsgStr15 ;
         else str = MsgStr16;

         if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
         {
            RifSys->Rk[kn][num1].AlarmFix[num2] = !RifSys->Rk[kn][num1].AlarmFix[num2];
            if( !RifSys->Rk[kn][num1].AlarmFix[num2] )
               SetSob( 136,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else
               SetSob( 137,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            RifSys->Rk[kn][num1].StatusOld[num2] = -1;
            RifSys->Rk[kn][num1].Sv[num2] = false;
         }
      }
      else
      {
            RifSys->Rk[kn][num1].AlarmFix[num2] = !RifSys->Rk[kn][num1].AlarmFix[num2];
            if( !RifSys->Rk[kn][num1].AlarmFix[num2] )
               SetSob( 1136,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
            else
               SetSob( 1137,
                       POprosObj(ObjTree->Selected->Data)->Type,
                       POprosObj(ObjTree->Selected->Data)->Num1,
                       POprosObj(ObjTree->Selected->Data)->Num2,
                       POprosObj(ObjTree->Selected->Data)->Num3,
                       POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            RifSys->Rk[kn][num1].StatusOld[num2] = -1;
            RifSys->Rk[kn][num1].Sv[num2] = false;
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 3 )
   {
        if( !GobiSys->Kanal[num1].Bl[num2].Sd[num3].Bazalt && !GobiSys->Kanal[num1].Bl[num2].Sd[num3].ConnectBlock )
        {
          if( !netuser )
          {
                if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) str = MsgStr15;
                else str = MsgStr16;

                if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
                {
                   GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix = !GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix;
                   GobiSys->Kanal[num1].Bl[num2].Sd[num3].PervoeSobytiePosleControlOn = true;

                   if( !GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix )
                      SetSob( 136,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                              POprosObj(ObjTree->Selected->Data)->OutType );
                   else
                      SetSob( 137,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                              POprosObj(ObjTree->Selected->Data)->OutType );

                   if( ComplexVersion != Rastr_M_SsoiComplexType )
                   {
                       switch( GobiSys->Kanal[num1].Bl[num2].Sd[num3].Status )
                       {
                          case   1: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   2: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   3: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   4: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case  10: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  11: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  12: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  13: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  14: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  20: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  21: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  22: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  25: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  30: n = 10;
                                    break;
                          case  31: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case 100: n = 11;
                                    break;
                          case 101: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          default:  n = 6;
                                    break;
                       }
                       ObjTree->Selected->ImageIndex = n;
                       ObjTree->Selected->SelectedIndex = n;

                       GobiSys->Kanal[num1].Bl[num2].Sd[num3].StatusOld2 = -1;
                       GobiSys->Kanal[num1].Bl[num2].Sd[num3].status1 = -1;
                   }
                   else GobiSys->Kanal[num1].Bl[num2].Sd[num3].StatusOld = -1;
                }
          }
          else
          {
                   GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix = !GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix;
                   GobiSys->Kanal[num1].Bl[num2].Sd[num3].PervoeSobytiePosleControlOn = true;

                   if( !GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix )
                      SetSob( 1136,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                              POprosObj(ObjTree->Selected->Data)->OutType );
                   else
                      SetSob( 1137,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false,
                              POprosObj(ObjTree->Selected->Data)->OutType );

                   if( ComplexVersion != Rastr_M_SsoiComplexType )
                   {
                       switch( GobiSys->Kanal[num1].Bl[num2].Sd[num3].StatusOld )
                       {
                          case   1: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   2: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   3: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case   4: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case  10: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  11: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  12: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  13: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  14: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 8;
                                    else n = 13;
                                    break;
                          case  20: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  21: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  22: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  25: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 9;
                                    else n = 14;
                                    break;
                          case  30: n = 10;
                                    break;
                          case  31: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          case 100: n = 11;
                                    break;
                          case 101: if( GobiSys->Kanal[num1].Bl[num2].Sd[num3].AlarmFix ) n = 7;
                                    else n = 12;
                                    break;
                          default:  n = 6;
                                    break;
                       }
                       ObjTree->Selected->ImageIndex = n;
                       ObjTree->Selected->SelectedIndex = n;

                       GobiSys->Kanal[num1].Bl[num2].Sd[num3].StatusOld2 = -1;
                       GobiSys->Kanal[num1].Bl[num2].Sd[num3].status1 = -1;
                   }
                   else GobiSys->Kanal[num1].Bl[num2].Sd[num3].StatusOld = -1;
          }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == 33 )
   {
      if( !GobiSys2->Bl[num1][num2].Sd[num3].Bazalt )
      {
          if( !netuser )
          {
                if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) str = MsgStr15;
                else str = MsgStr16;

                if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
                {
                   GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix = !GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix;
                   GobiSys2->Bl[num1][num2].Sd[num3].PervoeSobytiePosleControlOn = true;

                   if( !GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                      SetSob( 136,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   else
                      SetSob( 137,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                   switch( GobiSys2->Bl[num1][num2].Sd[num3].Status )
                   {
                      case   1: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;

                                    if( num3 == 7 )
                                    {
                                       if( GobiSys2->Bl[num1][num2].Sd[num3].Vin) n = 7;
                                       else n = 9;
                                    }
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;

                                    if( num3 == 7 )
                                    {
                                       if( GobiSys2->Bl[num1][num2].Sd[num3].Vin) n = 12;
                                       else n = 14;
                                    }
                                }
                                break;
                      case   2: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }
                                break;
                      case   3: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }
                                break;
                      case   4: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }

                                break;
                      case  10: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  11: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  12: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  13: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  14: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  20: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  21: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  22: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  30: n = 10;
                                break;
                      case  31: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 7;
                                else n = 12;
                                break;
                      case 100: n = 11;
                                break;
                      case 101: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 7;
                                else n = 12;
                                break;
                      default:  n = 6;
                                break;
                   }
                   ObjTree->Selected->ImageIndex = n;
                   ObjTree->Selected->SelectedIndex = n;

                   GobiSys2->Bl[num1][num2].Sd[num3].StatusOld = -1;
                }
          }
          else
          {
                   GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix = !GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix;
                   GobiSys2->Bl[num1][num2].Sd[num3].PervoeSobytiePosleControlOn = true;

                   if( !GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                      SetSob( 1136,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                   else
                      SetSob( 1137,
                              POprosObj(ObjTree->Selected->Data)->Type,
                              POprosObj(ObjTree->Selected->Data)->Num1,
                              POprosObj(ObjTree->Selected->Data)->Num2,
                              POprosObj(ObjTree->Selected->Data)->Num3,
                              POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

                   switch( GobiSys2->Bl[num1][num2].Sd[num3].Status )
                   {
                      case   1: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }
                                break;
                      case   2: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }
                                break;
                      case   3: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }
                                break;
                      case   4: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix )
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 7;
                                    else n = 9;
                                }
                                else
                                {
                                    if( !GobiSys2->Bl[num1][num2].Sd[num3].Vin && !GobiSys2->Bl[num1][num2].Sd[num3].Sin ) n = 12;
                                    else n = 14;
                                }

                                break;
                      case  10: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  11: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  12: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  13: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  14: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 8;
                                else n = 13;
                                break;
                      case  20: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  21: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  22: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 9;
                                else n = 14;
                                break;
                      case  30: n = 10;
                                break;
                      case  31: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 7;
                                else n = 12;
                                break;
                      case 100: n = 11;
                                break;
                      case 101: if( GobiSys2->Bl[num1][num2].Sd[num3].AlarmFix ) n = 7;
                                else n = 12;
                                break;
                      default:  n = 6;
                                break;
                   }
                   ObjTree->Selected->ImageIndex = n;
                   ObjTree->Selected->SelectedIndex = n;          

                   GobiSys2->Bl[num1][num2].Sd[num3].StatusOld = -1;
          }
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMBoIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMBoIdx )
   {
      if( !netuser )
      {
          int adress = POprosObj(ObjTree->Selected->Data)->Num1;

          if( RifSys->Rk[kn][num1].AlarmFix[0] ) str = MsgStr15;
          else str = MsgStr16 ;

          if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
          {
             RifSys->Rk[kn][num1].AlarmFix[0] = !RifSys->Rk[kn][num1].AlarmFix[0];
             if( !RifSys->Rk[kn][num1].AlarmFix[0] ) RifSys->Rk[kn][num1].StatusOld[0] = -2;
             else RifSys->Rk[kn][num1].StatusOld[0] = -1;
             RifSys->Rk[kn][num1].StatusBO[1] = -1;

             for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
             {
                RifSys->Rk[kn][num1].Uch[uch].AlarmFix = RifSys->Rk[kn][num1].AlarmFix[0];
                RifSys->Rk[kn][num1].Uch[uch].StatusUch[1] = -1;
             }

             for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
             {
                if( RifSys->Rk[kn][num1].Dd[dd].Use )
                {
                   RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].AlarmFix[0];
                   RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                }
             }

             if( !RifSys->Rk[kn][num1].AlarmFix[0] )
                   SetSob( 136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                else
                   SetSob( 137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          }
      }
      else
      {
          int adress = POprosObj(ObjTree->Selected->Data)->Num1;

             RifSys->Rk[kn][num1].AlarmFix[0] = !RifSys->Rk[kn][num1].AlarmFix[0];
             if( !RifSys->Rk[kn][num1].AlarmFix[0] ) RifSys->Rk[kn][num1].StatusOld[0] = -2;
             else RifSys->Rk[kn][num1].StatusOld[0] = -1;
             RifSys->Rk[kn][num1].StatusBO[1] = -1;

             for( int uch = 0; uch < MaxTochkaMUchCnt; uch++ )
             {
                RifSys->Rk[kn][num1].Uch[uch].AlarmFix = RifSys->Rk[kn][num1].AlarmFix[0];
                RifSys->Rk[kn][num1].Uch[uch].StatusUch[1] = -1;
             }

             for( int dd = 0; dd < MaxTochkaMDdCnt; dd++ )
             {
                if( RifSys->Rk[kn][num1].Dd[dd].Use )
                {
                   RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].AlarmFix[0];
                   RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                }
             }

             if( !RifSys->Rk[kn][num1].AlarmFix[0] )
                   SetSob( 1136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                else
                   SetSob( 1137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
   {
      int adress = POprosObj(ObjTree->Selected->Data)->Num1;
      int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
      int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100-1;

      if( !netuser )
      {
          if( RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix ) str = MsgStr15;
          else str = MsgStr16 ;

          if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
          {
             RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix = !RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
             RifSys->Rk[kn][num1].Uch[uchnum].StatusUch[1] = -1;

             int ddcnt2 = RifSys->Rk[kn][num1].Uch2StartAdr;
             if( ddcnt2 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ) ddcnt2 = 26;
               else ddcnt2 = 100;
             }

             int ddcnt4 = RifSys->Rk[kn][num1].Uch4StartAdr;
             if( ddcnt4 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ) ddcnt4 = 26;
               else ddcnt4 = 100;
             }

             int ddmax = 26;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx ) ddmax = 100;

             if( uchnum == 0 )
             {
                for( int dd = 0; dd < ddcnt2-1; dd++ )
                {
                   if( RifSys->Rk[kn][num1].Dd[dd].Use )
                   {
                      RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                      RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                   }
                }
             }
             else if( uchnum == 1 )
             {
                for( int dd = ddcnt2-1; dd < ddmax; dd++ )
                {
                   if( RifSys->Rk[kn][num1].Dd[dd].Use )
                   {
                      RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                      RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                   }
                }
             }
             else if( uchnum == 2 )
             {
                for( int dd = 0; dd < ddcnt4-1; dd++ )
                {
                   if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[100+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[100+dd].StatusChE1[1] = -1;
                      }
                   }
                   else
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[26+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[26+dd].StatusChE1[1] = -1;
                      }
                   }
                }
             }
             else if( uchnum == 3 )
             {
                for( int dd = ddcnt4-1; dd < ddmax; dd++ )
                {
                   if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[100+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[100+dd].StatusChE1[1] = -1;
                      }
                   }
                   else
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[26+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[26+dd].StatusChE1[1] = -1;
                      }
                   }
                }
             }

             if( !RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix )
                   SetSob( 136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                else
                   SetSob( 137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          }
      }
      else
      {
             RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix = !RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
             RifSys->Rk[kn][num1].Uch[uchnum].StatusUch[1] = -1;

             int ddcnt2 = RifSys->Rk[kn][num1].Uch2StartAdr;
             if( ddcnt2 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ) ddcnt2 = 26;
               else ddcnt2 = 100;
             }

             int ddcnt4 = RifSys->Rk[kn][num1].Uch4StartAdr;
             if( ddcnt4 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMUchIdx ) ddcnt4 = 26;
               else ddcnt4 = 100;
             }

             int ddmax = 26;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx ) ddmax = 100;

             if( uchnum == 0 )
             {
                for( int dd = 0; dd < ddcnt2-1; dd++ )
                {
                   if( RifSys->Rk[kn][num1].Dd[dd].Use )
                   {
                      RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                      RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                   }
                }
             }
             else if( uchnum == 1 )
             {
                for( int dd = ddcnt2-1; dd < ddmax; dd++ )
                {
                   if( RifSys->Rk[kn][num1].Dd[dd].Use )
                   {
                      RifSys->Rk[kn][num1].Dd[dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                      RifSys->Rk[kn][num1].Dd[dd].StatusChE1[1] = -1;
                   }
                }
             }
             else if( uchnum == 2 )
             {
                for( int dd = 0; dd < ddcnt4-1; dd++ )
                {
                   if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[100+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[100+dd].StatusChE1[1] = -1;
                      }
                   }
                   else
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[26+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[26+dd].StatusChE1[1] = -1;
                      }
                   }
                }
             }
             else if( uchnum == 3 )
             {
                for( int dd = ddcnt4-1; dd < ddmax; dd++ )
                {
                   if( POprosObj(ObjTree->Selected->Data)->Type == SotaMUchIdx )
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[100+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[100+dd].StatusChE1[1] = -1;
                      }
                   }
                   else
                   {
                      if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                      {
                         RifSys->Rk[kn][num1].Dd[26+dd].AlarmFix = RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix;
                         RifSys->Rk[kn][num1].Dd[26+dd].StatusChE1[1] = -1;
                      }
                   }
                }
             }

             if( !RifSys->Rk[kn][num1].Uch[uchnum].AlarmFix )
                   SetSob( 1136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                else
                   SetSob( 1137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
   else if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ||
            POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
   {
      int adress = POprosObj(ObjTree->Selected->Data)->Num1;
      int ddnum = POprosObj(ObjTree->Selected->Data)->Num2%100;
      int uchnum = POprosObj(ObjTree->Selected->Data)->Num2/100;
      if( uchnum == 3 || uchnum == 4)
      {
         if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ddnum += 26;
         else ddnum += 100;
      }

      if( !netuser )
      {
          if( RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix ) str = MsgStr15;
          else str = MsgStr16;

          if( MessageBox (NULL,str.c_str(),WarningMsg.c_str(),MB_OKCANCEL|MB_ICONQUESTION) == IDOK )
          {
             RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix = !RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix;

             RifSys->Rk[kn][num1].Dd[ddnum].StatusChE1[1] = -1;

             if( !RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix )
                   SetSob( 136,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
                else
                   SetSob( 137,
                           POprosObj(ObjTree->Selected->Data)->Type,
                           POprosObj(ObjTree->Selected->Data)->Num1,
                           POprosObj(ObjTree->Selected->Data)->Num2,
                           POprosObj(ObjTree->Selected->Data)->Num3,
                           POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );


            int ddcnt2 = RifSys->Rk[kn][num1].Uch2StartAdr;
            if( ddcnt2 == 0 )
            {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ddcnt2 = 26;
               else ddcnt2 = 100;
            }

             int ddcnt4 = RifSys->Rk[kn][num1].Uch4StartAdr;
             if( ddcnt4 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ddcnt4 = 26;
               else ddcnt4 = 100;
             }

             int ddmax = 26;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx ) ddmax = 100;

             int controlcnt = 0;
             if( uchnum == 1 )
             {
               for( int dd = 0; dd < ddcnt2-1; dd++ )
               {
                  if( RifSys->Rk[kn][num1].Dd[dd].Use )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd].AlarmFix ) controlcnt += 1;
                  }
               }
             }
             else if( uchnum == 2 )
             {
               for( int dd = ddcnt2-1; dd < ddmax; dd++ )
               {
                  if( RifSys->Rk[kn][num1].Dd[dd].Use )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd].AlarmFix ) controlcnt += 1;
                  }
               }
             }
             else if( uchnum == 3 )
             {
               for( int dd = 0; dd < ddcnt4-1; dd++ )
               {
                  if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+100].AlarmFix ) controlcnt += 1;
                     }
                  }
                  else
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+26].AlarmFix ) controlcnt += 1;
                     }
                  }
               }
             }
             else if( uchnum == 4 )
             {
               for( int dd = ddcnt4-1; dd < ddmax; dd++ )
               {
                  if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+100].AlarmFix ) controlcnt += 1;
                     }
                  }
                  else
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+26].AlarmFix ) controlcnt += 1;
                     }
                  }
               }
             }

             if( controlcnt > 0 && !RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
             {
                RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix = true;
                RifSys->Rk[kn][num1].Uch[uchnum-1].StatusUch[1] = -1;
             }
             else if( controlcnt == 0 && RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
             {
                RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix = false;
                RifSys->Rk[kn][num1].Uch[uchnum-1].StatusUch[1] = -1;
             }

             int type = 27;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx ) type = 30;
             if( !RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
               SetSob( 136,
                       type,
                       num1+1,
                       num2+1,
                       num3+1,
                       RifSys->Rk[kn][num1].Uch[uchnum-1].Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
             else
               SetSob( 137,
                       type,
                       num1+1,
                       num2+1,
                       num3+1,
                       RifSys->Rk[kn][num1].Uch[uchnum-1].Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
          }
      }
      else
      {
         RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix = !RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix;
         RifSys->Rk[kn][num1].Dd[ddnum].StatusChE1[1] = -1;

         if( !RifSys->Rk[kn][num1].Dd[ddnum].AlarmFix )
            SetSob( 1136,
                    POprosObj(ObjTree->Selected->Data)->Type,
                    POprosObj(ObjTree->Selected->Data)->Num1,
                    POprosObj(ObjTree->Selected->Data)->Num2,
                    POprosObj(ObjTree->Selected->Data)->Num3,
                    POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
         else
            SetSob( 1137,
                    POprosObj(ObjTree->Selected->Data)->Type,
                    POprosObj(ObjTree->Selected->Data)->Num1,
                    POprosObj(ObjTree->Selected->Data)->Num2,
                    POprosObj(ObjTree->Selected->Data)->Num3,
                    POprosObj(ObjTree->Selected->Data)->Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );

            int ddcnt2 = RifSys->Rk[kn][num1].Uch2StartAdr;
            if( ddcnt2 == 0 )
            {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ddcnt2 = 26;
               else ddcnt2 = 100;
            }

             int ddcnt4 = RifSys->Rk[kn][num1].Uch4StartAdr;
             if( ddcnt4 == 0 )
             {
               if( POprosObj(ObjTree->Selected->Data)->Type == TochkaMDdIdx ) ddcnt4 = 26;
               else ddcnt4 = 100;
             }

             int ddmax = 26;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx ) ddmax = 100;

             int controlcnt = 0;
             if( uchnum == 1 )
             {
               for( int dd = 0; dd < ddcnt2-1; dd++ )
               {
                  if( RifSys->Rk[kn][num1].Dd[dd].Use )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd].AlarmFix ) controlcnt += 1;
                  }
               }
             }
             else if( uchnum == 2 )
             {
               for( int dd = ddcnt2-1; dd < ddmax; dd++ )
               {
                  if( RifSys->Rk[kn][num1].Dd[dd].Use )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd].AlarmFix ) controlcnt += 1;
                  }
               }
             }
             else if( uchnum == 3 )
             {
               for( int dd = 0; dd < ddcnt4-1; dd++ )
               {
                  if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+100].AlarmFix ) controlcnt += 1;
                     }
                  }
                  else
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+26].AlarmFix ) controlcnt += 1;
                     }
                  }
               }
             }
             else if( uchnum == 4 )
             {
               for( int dd = ddcnt4-1; dd < ddmax; dd++ )
               {
                  if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx )
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+100].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+100].AlarmFix ) controlcnt += 1;
                     }
                  }
                  else
                  {
                     if( RifSys->Rk[kn][num1].Dd[dd+26].Use )
                     {
                        if( RifSys->Rk[kn][num1].Dd[dd+26].AlarmFix ) controlcnt += 1;
                     }
                  }
               }
             }

             if( controlcnt > 0 && !RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
             {
                RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix = true;
                RifSys->Rk[kn][num1].Uch[uchnum-1].StatusUch[1] = -1;
             }
             else if( controlcnt == 0 && RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
             {
                RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix = false;
                RifSys->Rk[kn][num1].Uch[uchnum-1].StatusUch[1] = -1;
             }

             int type = 27;
             if( POprosObj(ObjTree->Selected->Data)->Type == SotaMDdIdx ) type = 30;
             if( !RifSys->Rk[kn][num1].Uch[uchnum-1].AlarmFix )
               SetSob( 136,
                       type,
                       num1+1,
                       num2+1,
                       num3+1,
                       RifSys->Rk[kn][num1].Uch[uchnum-1].Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
             else
               SetSob( 137,
                       type,
                       num1+1,
                       num2+1,
                       num3+1,
                       RifSys->Rk[kn][num1].Uch[uchnum-1].Name, OpFn, OpN1, OpN2, "", "", "", false, 0 );
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::N21Click(TObject *Sender)
{
   ObjTree->FullCollapse();
}
//---------------------------------------------------------------------------
void TMainForm::SaveStringToMySQL(AnsiString sob_str)
{
   AnsiString query, err_str;
   int err_code;

   if( sob_str.Length() > 0 )
   {
      Table1->FlushBuffers();
      ShowPrCnt();
   }

   if( MySQL_use > 0 )
   {
      query = "";
      err_str = "";
      err_code = 0;

      if( sob_str.Length() > 0 )
      {
         sob_str.Delete(sob_str.Length(),1);
         sob_str.Insert(";", sob_str.Length()+1);

         query = "";
         query.sprintf("INSERT INTO %s.events VALUES%s", MySQL_dbname, sob_str);
         mysql_real_query(Con,query.c_str(),query.Length());

          int err_code = mysql_errno(Con);
          if( err_code != 0 )
          {
             mysql_close(Con);

             Con = mysql_init(NULL);
             mysql_real_connect(Con,MySQL_host.c_str(),MySQL_login.c_str(),MySQL_password.c_str(),MySQL_dbname.c_str(),MySQL_port,NULL,0);
             err_code = mysql_errno(Con);
             if( err_code != 0 && err_code != CR_ALREADY_CONNECTED )
             {
                MySQL_use = -1;

                err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                ShowMessage(err_str);
             }
             else
             {
                mysql_real_query(Con,query.c_str(),query.Length());
                err_code = mysql_errno(Con);
                if( err_code != 0 )
                {
                   MySQL_use = -1;

                   err_str.sprintf("%s EVENTS!\n %s:%d\n %s:%s", InfoStr6, InfoStr3, err_code, InfoStr4, mysql_error(Con));
                   ShowMessage(err_str);
                }
             }
          }
      }
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::As_pdiClick(TObject *Sender)
{
   if( DemoMode )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      RifSys->Rk[POprosObj(ObjTree->Selected->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] = 20;
      int packet[1000];
      memset(packet,0,1000);

      bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
      for(int sd = 0; sd < MaxIpBlSdCnt; sd++ ) Tin_IpBl[sd] = RifSys->Rk[num3-1][IpBlIdx].Tin[sd];
      ShowNewRkStatus(20, 100, POprosObj(ObjTree->Selected->Data)->Num3-1, 0, Tin_IpBl, packet );
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::Norm_pdiClick(TObject *Sender)
{
   if( DemoMode )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      RifSys->Rk[POprosObj(ObjTree->Selected->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] = 1;
      int packet[1000];
      memset(packet,0,1000);

      bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
      for(int sd = 0; sd < MaxIpBlSdCnt; sd++ ) Tin_IpBl[sd] = RifSys->Rk[num3-1][IpBlIdx].Tin[sd];
      ShowNewRkStatus(1, 100, POprosObj(ObjTree->Selected->Data)->Num3-1, 0, Tin_IpBl, packet );
   }
}
//---------------------------------------------------------------------------
void __fastcall TMainForm::N_pdiClick(TObject *Sender)
{
   if( DemoMode )
   {
      int num1 = POprosObj(ObjTree->Selected->Data)->Num1;
      int num2 = POprosObj(ObjTree->Selected->Data)->Num2;
      int num3 = POprosObj(ObjTree->Selected->Data)->Num3;

      RifSys->Rk[POprosObj(ObjTree->Selected->Data)->Num3-1][IpBlIdx].Status[POprosObj(ObjTree->Selected->Data)->Num2-1] = 10;
      int packet[1000];
      memset(packet,0,1000);

      bool Tin_IpBl[MaxIpBlSdCnt] = {false, false, false, false, false, false, false, false};
      for(int sd = 0; sd < MaxIpBlSdCnt; sd++ ) Tin_IpBl[sd] = RifSys->Rk[num3-1][IpBlIdx].Tin[sd];
      ShowNewRkStatus(10, 100, POprosObj(ObjTree->Selected->Data)->Num3-1, 0, Tin_IpBl, packet );
   }
}
//---------------------------------------------------------------------------
void TMainForm::AutoChildsOn( int ch, int adr, int sd )
{
   if( ObjTree->Items->Item[Rif2Sys->Ch[ch].Dev[adr].Sd[sd].TreeIdx]->HasChildren )
   {
      int num1 = 0, num2 = 0, num3 = 0;
      int k[MonCnt] = {0,0,0,0};

      TTreeNode *Node1 = ObjTree->Items->Item[Rif2Sys->Ch[ch].Dev[adr].Sd[sd].TreeIdx];
      TTreeNode *Node2 = Node1->getFirstChild();

      while( Node2 )
      {
         num1 = POprosObj(Node2->Data)->Num1;
         num2 = POprosObj(Node2->Data)->Num2;
         num3 = POprosObj(Node2->Data)->Num3;
         AnsiString sn = POprosObj(Node2->Data)->Icon1Path;

         if( POprosObj(Node2->Data)->Type == IuIpBlType )
         {
            if( Rif2Sys->Ch[num3-1].Dev[IpBlIdx].Iu[num2-1].Siu[0] != 1 )
            {
               /* Послать команду "Включить " */
               Rif2Sys->Ch[num3-1].Dev[IpBlIdx].Iu[num2-1].Cmd = 2;
               Rif2Sys->Ch[num3-1].Dev[IpBlIdx].Cmd = 4;
               Rif2Sys->Ch[num3-1].Dev[IpBlIdx].CmdCnt = 0;
            }
         }
         else if( POprosObj(Node2->Data)->Type == DevLineIdx )
         {
            int n1 = POprosObj(Node2->Data)->Num1 - 1;

            if( !ShowDevLineCam[n1] )
            {
               ShowDevLineCam[n1] = true;

               int n2 = POprosObj(Node2->Data)->Num2;
               int n3 = POprosObj(Node2->Data)->Num3;
               int n4 = POprosObj(Node2->Data)->X;
               int n5 = POprosObj(Node2->Data)->Y;
               int n6 = POprosObj(Node2->Data)->OutType;

               if( n4 < n2 ) n4 = n2 + 640;
               if( n5 < n3 ) n5 = n3 + 480;
               if( n6 != 0 ) n6 = 1;

               DWORD rc, exitcode;
               AnsiString tmp_str1, tmp_str2;
               tmp_str1  = DevLineFilePath;
               tmp_str2.sprintf( "--simple -c %d --window-pos %d %d %d %d --cam-stream %d -m", n1, n2, n3, n4, n5, n6 );

               ZeroMemory ( &se1[n1], sizeof (se1[n1]) );
               se1[n1].cbSize = sizeof (se1[n1]);
               se1[n1].fMask = SEE_MASK_NOCLOSEPROCESS;
               se1[n1].lpFile = tmp_str1.c_str();
               se1[n1].lpParameters =  tmp_str2.c_str();
               se1[n1].nShow = SW_NORMAL;
               ShellExecuteEx (&se1[n1]);
            }
         }
         else if( POprosObj(Node2->Data)->Type == Stn485Type )
         {
             if( cam485[0] == 0 && cam485[1] == 0 && cam485[2] == 0  )
             {
                cam485[0] = num1;
                cam485[1] = num2;
                cam485[2] = num3;
                cam485_sn[0] = sn;
             }
             else
             {
                if( cam485[3] == 0 && cam485[4] == 0 && cam485[5] == 0 )
                {
                   cam485[3] = num1;
                   cam485[4] = num2;
                   cam485[5] = num3;
                   cam485_sn[1] = sn;
                }
                else
                {
                   if( cam485[6] == 0 && cam485[7] == 0 && cam485[8] == 0 )
                   {
                      cam485[6] = num1;
                      cam485[7] = num2;
                      cam485[8] = num3;
                      cam485_sn[2] = sn;
                   }
                   else
                   {
                      if( cam485[9] == 0 && cam485[10] == 0 && cam485[11] == 0 )
                      {
                         cam485[9] = num1;
                         cam485[10] = num2;
                         cam485[11] = num3;
                         cam485_sn[3] = sn;
                      }
                      else
                      {
                         if( cam485[12] == 0 && cam485[13] == 0 && cam485[14] == 0 )
                         {
                            cam485[12] = num1;
                            cam485[13] = num2;
                            cam485[14] = num3;
                            cam485_sn[4] = sn;
                         }
                         else
                         {
                            if( cam485[15] == 0 && cam485[16] == 0 && cam485[17] == 0 )
                            {
                               cam485[15] = num1;
                               cam485[16] = num2;
                               cam485[17] = num3;
                               cam485_sn[5] = sn;
                            }
                         }
                      }
                   }
                }
             }
         }
         else if( POprosObj(Node2->Data)->Type == 7 && Adam4068PortNum != 0 )
         {
             if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Out[POprosObj(Node2->Data)->Num2] != 101 )
             {
                A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].Cmd[POprosObj(Node2->Data)->Num2] = 101;

                if( A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2] > 0 )
                {
                   TDateTime adt = Now();
                   int t = A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].AdamOff[POprosObj(Node2->Data)->Num2];
                   switch( t )
                   {
                      case 1: adt = adt + EncodeTime(0,0,5,0);
                              break;
                      case 2: adt = adt + EncodeTime(0,0,10,0);
                              break;
                      case 3: adt = adt + EncodeTime(0,0,30,0);
                              break;
                      case 4: adt = adt + EncodeTime(0,1,0,0);
                              break;
                      case 5: adt = adt + EncodeTime(0,5,0,0);
                              break;
                      case 6: adt = adt + EncodeTime(0,10,0,0);
                              break;
                      case 7: adt = adt + EncodeTime(0,20,0,0);
                              break;
                      case 8: adt = adt + EncodeTime(0,30,0,0);
                              break;
                      case 9: adt = adt + EncodeTime(1,0,0,0);
                              break;
                      default: adt = adt + EncodeTime(0,0,5,0);
                              break;
                   }
                   A4068Sys->Dev[POprosObj(Node2->Data)->Num1-1].OffDt[POprosObj(Node2->Data)->Num2] = adt;
                }
             }
         }

         Node2 = Node1->GetNextChild(Node2);
      }
   }
}
//---------------------------------------------------------------------------
void TMainForm::Diagnostics_show( int type, int ch, int adr, int sd )
{
   AnsiString str;
   
   if( type == BlIp_Type )
   {
      for( int sd1 = 0; sd1 < MaxBlIpSdSize; sd1++ )
      {
         if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].ErrFlag[0] == 1  )  /* Нет связи */
         {
            AdvStringGrid1->Cells[1][1+sd1]="Нет связи!";
            AdvStringGrid1->Cells[2][1+sd1]="Нет связи!";
         }
         else
         {
            if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].St[0] < 0 ) str = "?";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].St[0] == 0 ) str = "Норма";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].St[0] == 1 ) str = "Тревога";
            AdvStringGrid1->Cells[1][1+sd1] = str;

            if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].T[0] < 0 ) str = "?";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].T[0] == 0 ) str = "Нет";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].T[0] == 1 ) str = "Было";
            AdvStringGrid1->Cells[2][1+sd1] = str;

            if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sd[sd1].Active[0] == 0 )
            {
               AdvStringGrid1->Cells[1][1+sd1] = "-";
               AdvStringGrid1->Cells[2][1+sd1] = "Выкл";
            }
         }
      }
      for( int iu = 0; iu < MaxBlIpIuSize; iu++ )
      {
         if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Iu[iu].ErrFlag[0] == 1  )  /* Нет связи */
         {
            AdvStringGrid1->Cells[1][11+iu]="Нет связи!";
            AdvStringGrid1->Cells[2][11+iu]="Нет связи!";
         }
         else
         {
            if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Iu[iu].Siu[0] < 0 ) str = "?";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Iu[iu].Siu[0] == 0 ) str = "Выкл";
            else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Iu[iu].Siu[0] == 1 ) str = "Вкл";
            AdvStringGrid1->Cells[1][11+iu] = str;
         }
      }

      if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Dk == -1 ) str = "?";
      else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Dk == 0 ) str = "Нет";
      else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Dk == 1 ) str = "Было";
      AdvStringGrid1->Cells[2][10] = str;

      if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sdk == -1 ) str = "?";
      else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sdk == 0 ) str = "Нет";
      else if( MainForm->Rif2Sys->Ch[ch].Dev[adr].Sdk == 1 ) str = "Есть";
      AdvStringGrid1->Cells[1][10] = str;
   }
}
//---------------------------------------------------------------------------
int TMainForm::ReadStn485Channel( AnsiString fp, AnsiString dev_num )
{
   TMemIniFile *ini;
   ini = new TMemIniFile( fp );

   int num = 0;

   AnsiString str1, str2, str3;
   for( int i = 0; i < 2; i++ )
   {
      str1.sprintf("DEVICE_%d",i);
      str3 = ini->ReadString( str1.c_str(), "SerNum", "" );

      if( str3 == dev_num )
      {
          bool ch_on = false;
          for( int j = 0; j < 4; j++ )
          {
             str2.sprintf("On%d",j+1);
             ch_on = ini->ReadBool( str1.c_str(), str2.c_str(), false );
             if( ch_on )
             {
                num = j+1;
                return num;
             }
          }
      }
   }

   delete ini;

   return num;
}
//---------------------------------------------------------------------------






